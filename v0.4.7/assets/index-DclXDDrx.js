import{r as h,j as r,_ as ma,c as Mn,p as Qo,V,Q as ut,E as pn,M as go,T as hu,S as mu,C as $n,u as In,a as pa,b as En,B as Ho,d as js,e as ga,I as Mh,F as br,f as zi,g as To,W as Eh,h as pu,U as us,i as gu,k as ds,l as Ar,m as Nr,L as Ph,n as Lh,o as _h,N as Ah,q as Nh,s as Oi,t as Rh,D as so,H as gn,v as Fh,w as Th,x as $i,P as Dh,O as ul,y as dl,z as xu,A as yr,G as fl,R as zh,J as hl,K as Oh,X as $h,Y as Bh,Z as Uh,$ as Wh,a0 as Hh}from"./three-vendor-CUQB8cPR.js";import{g as Zh}from"./react-vendor-Cgg2GOmP.js";import{r as xa,u as ml}from"./ui-vendor-BChcp2l5.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))o(s);new MutationObserver(s=>{for(const a of s)if(a.type==="childList")for(const i of a.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&o(i)}).observe(document,{childList:!0,subtree:!0});function n(s){const a={};return s.integrity&&(a.integrity=s.integrity),s.referrerPolicy&&(a.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?a.credentials="include":s.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function o(s){if(s.ep)return;s.ep=!0;const a=n(s);fetch(s.href,a)}})();const yu=["shift","alt","meta","mod","ctrl","control"],Vh={esc:"escape",return:"enter",left:"arrowleft",right:"arrowright",up:"arrowup",down:"arrowdown",ShiftLeft:"shift",ShiftRight:"shift",AltLeft:"alt",AltRight:"alt",MetaLeft:"meta",MetaRight:"meta",OSLeft:"meta",OSRight:"meta",ControlLeft:"ctrl",ControlRight:"ctrl"};function oo(e){return(Vh[e.trim()]||e.trim()).toLowerCase().replace(/key|digit|numpad/,"")}function vu(e){return yu.includes(e)}function li(e,t=","){return e.toLowerCase().split(t)}function ci(e,t="+",n=">",o=!1,s,a){let i=[],l=!1;e=e.trim(),e.includes(n)?(l=!0,i=e.toLocaleLowerCase().split(n).map(u=>oo(u))):i=e.toLocaleLowerCase().split(t).map(u=>oo(u));const c={alt:i.includes("alt"),ctrl:i.includes("ctrl")||i.includes("control"),shift:i.includes("shift"),meta:i.includes("meta"),mod:i.includes("mod"),useKey:o},d=i.filter(u=>!yu.includes(u));return{...c,keys:d,description:s,isSequence:l,hotkey:e,metadata:a}}typeof document<"u"&&(document.addEventListener("keydown",e=>{e.code!==void 0&&wu([oo(e.code)])}),document.addEventListener("keyup",e=>{e.code!==void 0&&bu([oo(e.code)])})),typeof window<"u"&&(window.addEventListener("blur",()=>{qn.clear()}),window.addEventListener("contextmenu",()=>{setTimeout(()=>{qn.clear()},0)}));const qn=new Set;function ya(e){return Array.isArray(e)}function Gh(e,t=","){return(ya(e)?e:e.split(t)).every(n=>qn.has(n.trim().toLowerCase()))}function wu(e){const t=Array.isArray(e)?e:[e];qn.has("meta")&&qn.forEach(n=>{vu(n)||qn.delete(n.toLowerCase())}),t.forEach(n=>{qn.add(n.toLowerCase())})}function bu(e){const t=Array.isArray(e)?e:[e];e==="meta"?qn.clear():t.forEach(n=>{qn.delete(n.toLowerCase())})}function Yh(e,t,n){(typeof n=="function"&&n(e,t)||n===!0)&&e.preventDefault()}function qh(e,t,n){return typeof n=="function"?n(e,t):n===!0||n===void 0}const Xh=["input","textarea","select","searchbox","slider","spinbutton","menuitem","menuitemcheckbox","menuitemradio","option","radio","textbox"];function Kh(e){return Cu(e,Xh)}function Cu(e,t=!1){const{target:n,composed:o}=e;let s,a;return Qh(n)&&o?(s=e.composedPath()[0]&&e.composedPath()[0].tagName,a=e.composedPath()[0]&&e.composedPath()[0].role):(s=n&&n.tagName,a=n&&n.role),ya(t)?!!(s&&t&&t.some(i=>i.toLowerCase()===s.toLowerCase()||i===a)):!!(s&&t&&t)}function Qh(e){return!!e.tagName&&!e.tagName.startsWith("-")&&e.tagName.includes("-")}function Jh(e,t){return e.length===0&&t?!1:t?e.some(n=>t.includes(n))||e.includes("*"):!0}const em=(e,t,n=!1)=>{const{alt:o,meta:s,mod:a,shift:i,ctrl:l,keys:c,useKey:d}=t,{code:u,key:f,ctrlKey:p,metaKey:g,shiftKey:y,altKey:v}=e,w=oo(u);if(d){if(c?.length===1&&c.includes(f.toLowerCase())){if(!n){if(o!==v||i!==y)return!1;if(a){if(!g&&!p)return!1}else if(s!==g||l!==p)return!1}return!0}return!1}if(!c?.includes(w)&&!["ctrl","control","unknown","meta","alt","shift","os"].includes(w))return!1;if(!n){if(o!==v&&w!=="alt"||i!==y&&w!=="shift")return!1;if(a){if(!g&&!p)return!1}else if(s!==g&&w!=="meta"&&w!=="os"||l!==p&&w!=="ctrl"&&w!=="control")return!1}return c&&c.length===1&&c.includes(w)?!0:c&&c.length>0?c.includes(w)?Gh(c):!1:!c||c.length===0},ku=h.createContext(void 0),tm=()=>h.useContext(ku);function nm({addHotkey:e,removeHotkey:t,children:n}){return r.jsx(ku.Provider,{value:{addHotkey:e,removeHotkey:t},children:n})}function va(e,t){return e&&t&&typeof e=="object"&&typeof t=="object"?Object.keys(e).length===Object.keys(t).length&&Object.keys(e).reduce((n,o)=>n&&va(e[o],t[o]),!0):e===t}const Su=h.createContext({hotkeys:[],activeScopes:[],toggleScope:()=>{},enableScope:()=>{},disableScope:()=>{}}),ju=()=>h.useContext(Su),om=({initiallyActiveScopes:e=["*"],children:t})=>{const[n,o]=h.useState(e),[s,a]=h.useState([]),i=h.useCallback(f=>{o(p=>p.includes("*")?[f]:Array.from(new Set([...p,f])))},[]),l=h.useCallback(f=>{o(p=>p.filter(g=>g!==f))},[]),c=h.useCallback(f=>{o(p=>p.includes(f)?p.filter(g=>g!==f):p.includes("*")?[f]:Array.from(new Set([...p,f])))},[]),d=h.useCallback(f=>{a(p=>[...p,f])},[]),u=h.useCallback(f=>{a(p=>p.filter(g=>!va(g,f)))},[]);return r.jsx(Su.Provider,{value:{activeScopes:n,hotkeys:s,enableScope:i,disableScope:l,toggleScope:c},children:r.jsx(nm,{addHotkey:d,removeHotkey:u,children:t})})};function rm(e){const t=h.useRef(void 0);return va(t.current,e)||(t.current=e),t.current}const pl=e=>{e.stopPropagation(),e.preventDefault(),e.stopImmediatePropagation()},sm=typeof window<"u"?h.useLayoutEffect:h.useEffect;function lt(e,t,n,o){const s=h.useRef(null),a=h.useRef(!1),i=Array.isArray(n)?Array.isArray(o)?void 0:o:n,l=ya(e)?e.join(i?.delimiter):e,c=Array.isArray(n)?n:Array.isArray(o)?o:void 0,d=h.useCallback(t,c??[]),u=h.useRef(d);c?u.current=d:u.current=t;const f=rm(i),{activeScopes:p}=ju(),g=tm();return sm(()=>{if(f?.enabled===!1||!Jh(p,f?.scopes))return;let y=[],v;const w=(k,j=!1)=>{if(!(Kh(k)&&!Cu(k,f?.enableOnFormTags))){if(s.current!==null){const b=s.current.getRootNode();if((b instanceof Document||b instanceof ShadowRoot)&&b.activeElement!==s.current&&!s.current.contains(b.activeElement)){pl(k);return}}k.target?.isContentEditable&&!f?.enableOnContentEditable||li(l,f?.delimiter).forEach(b=>{if(b.includes(f?.splitKey??"+")&&b.includes(f?.sequenceSplitKey??">")){console.warn(`Hotkey ${b} contains both ${f?.splitKey??"+"} and ${f?.sequenceSplitKey??">"} which is not supported.`);return}const M=ci(b,f?.splitKey,f?.sequenceSplitKey,f?.useKey,f?.description,f?.metadata);if(M.isSequence){v=setTimeout(()=>{y=[]},f?.sequenceTimeoutMs??1e3);const E=M.useKey?k.key:oo(k.code);if(vu(E.toLowerCase()))return;y.push(E);const P=M.keys?.[y.length-1];if(E!==P){y=[],v&&clearTimeout(v);return}y.length===M.keys?.length&&(u.current(k,M),v&&clearTimeout(v),y=[])}else if(em(k,M,f?.ignoreModifiers)||M.keys?.includes("*")){if(f?.ignoreEventWhen?.(k)||j&&a.current)return;if(Yh(k,M,f?.preventDefault),!qh(k,M,f?.enabled)){pl(k);return}u.current(k,M),j||(a.current=!0)}})}},x=k=>{k.code!==void 0&&(wu(oo(k.code)),(f?.keydown===void 0&&f?.keyup!==!0||f?.keydown)&&w(k))},m=k=>{k.code!==void 0&&(bu(oo(k.code)),a.current=!1,f?.keyup&&w(k,!0))},S=s.current||i?.document||document;return S.addEventListener("keyup",m,i?.eventListenerOptions),S.addEventListener("keydown",x,i?.eventListenerOptions),g&&li(l,f?.delimiter).forEach(k=>{g.addHotkey(ci(k,f?.splitKey,f?.sequenceSplitKey,f?.useKey,f?.description,f?.metadata))}),()=>{S.removeEventListener("keyup",m,i?.eventListenerOptions),S.removeEventListener("keydown",x,i?.eventListenerOptions),g&&li(l,f?.delimiter).forEach(k=>{g.removeHotkey(ci(k,f?.splitKey,f?.sequenceSplitKey,f?.useKey,f?.description,f?.metadata))}),y=[],v&&clearTimeout(v)}},[l,f,p]),s}class Rr{view;offset=0;constructor(t){this.view=new DataView(t)}get position(){return this.offset}get remaining(){return this.view.byteLength-this.offset}get length(){return this.view.byteLength}readUint8(){const t=this.view.getUint8(this.offset);return this.offset+=1,t}readUint32(){const t=this.view.getUint32(this.offset,!0);return this.offset+=4,t}readInt32(){const t=this.view.getInt32(this.offset,!0);return this.offset+=4,t}readUint64(){const t=this.view.getBigUint64(this.offset,!0);return this.offset+=8,t}readUint64AsNumber(){return Number(this.readUint64())}readInt64(){const t=this.view.getBigInt64(this.offset,!0);return this.offset+=8,t}readFloat64(){const t=this.view.getFloat64(this.offset,!0);return this.offset+=8,t}readString(){const t=[];let n;for(;(n=this.readUint8())!==0;)t.push(String.fromCharCode(n));return t.join("")}skip(t){this.offset+=t}seek(t){this.offset=t}hasMore(){return this.offset<this.view.byteLength}}class Fr{chunks=[];currentBuffer;currentView;offset=0;chunkSize=65536;constructor(){this.currentBuffer=new ArrayBuffer(this.chunkSize),this.currentView=new DataView(this.currentBuffer)}ensureCapacity(t){this.offset+t>this.chunkSize&&(this.chunks.push(this.currentBuffer.slice(0,this.offset)),this.currentBuffer=new ArrayBuffer(this.chunkSize),this.currentView=new DataView(this.currentBuffer),this.offset=0)}writeUint8(t){this.ensureCapacity(1),this.currentView.setUint8(this.offset,t),this.offset+=1}writeUint32(t){this.ensureCapacity(4),this.currentView.setUint32(this.offset,t,!0),this.offset+=4}writeInt32(t){this.ensureCapacity(4),this.currentView.setInt32(this.offset,t,!0),this.offset+=4}writeUint64(t){this.ensureCapacity(8),this.currentView.setBigUint64(this.offset,t,!0),this.offset+=8}writeUint64FromNumber(t){this.writeUint64(BigInt(t))}writeInt64(t){this.ensureCapacity(8),this.currentView.setBigInt64(this.offset,t,!0),this.offset+=8}writeFloat64(t){this.ensureCapacity(8),this.currentView.setFloat64(this.offset,t,!0),this.offset+=8}writeString(t){for(let n=0;n<t.length;n++)this.writeUint8(t.charCodeAt(n));this.writeUint8(0)}toArrayBuffer(){this.offset>0&&this.chunks.push(this.currentBuffer.slice(0,this.offset));const t=this.chunks.reduce((a,i)=>a+i.byteLength,0),n=new ArrayBuffer(t),o=new Uint8Array(n);let s=0;for(const a of this.chunks)o.set(new Uint8Array(a),s),s+=a.byteLength;return n}toBlob(){return new Blob([this.toArrayBuffer()],{type:"application/octet-stream"})}get bytesWritten(){return this.chunks.reduce((n,o)=>n+o.byteLength,0)+this.offset}}const im=["rgb","error","trackLength"],fs=["orbit","fly"],hs=["perspective","orthographic"],ms=["off","cw","ccw"],ps=["off","on","flip"],gs=["frustum","arrow","imageplane"],am=["single","byCamera","byRigFrame"],lm=["0.1","1","10"],cm=["cropped","fullFrame"],um=["on","blink"],xs=["static","blink","rainbow"],dm=["colmap","opencv","threejs","opengl","vulkan","blender","houdini","unity","unreal"],fm=["off","xyz","extra"],hm=["current","1920x1080","1280x720","3840x2160","1024x1024","512x512","2048x2048"],mm=["jpeg","png","webp"];function Iu(e){const t=e.params,n=e.modelId,o={fx:1,fy:1,cx:0,cy:0,k1:0,k2:0,k3:0,k4:0,k5:0,k6:0,p1:0,p2:0,omega:0,sx1:0,sy1:0};switch(n){case $e.SIMPLE_PINHOLE:o.fx=o.fy=t[0],o.cx=t[1],o.cy=t[2];break;case $e.PINHOLE:o.fx=t[0],o.fy=t[1],o.cx=t[2],o.cy=t[3];break;case $e.SIMPLE_RADIAL:o.fx=o.fy=t[0],o.cx=t[1],o.cy=t[2],o.k1=t[3];break;case $e.RADIAL:o.fx=o.fy=t[0],o.cx=t[1],o.cy=t[2],o.k1=t[3],o.k2=t[4];break;case $e.OPENCV:o.fx=t[0],o.fy=t[1],o.cx=t[2],o.cy=t[3],o.k1=t[4],o.k2=t[5],o.p1=t[6],o.p2=t[7];break;case $e.OPENCV_FISHEYE:o.fx=t[0],o.fy=t[1],o.cx=t[2],o.cy=t[3],o.k1=t[4],o.k2=t[5],o.k3=t[6],o.k4=t[7];break;case $e.FULL_OPENCV:o.fx=t[0],o.fy=t[1],o.cx=t[2],o.cy=t[3],o.k1=t[4],o.k2=t[5],o.p1=t[6],o.p2=t[7],o.k3=t[8],o.k4=t[9],o.k5=t[10],o.k6=t[11];break;case $e.FOV:o.fx=t[0],o.fy=t[1],o.cx=t[2],o.cy=t[3],o.omega=t[4];break;case $e.SIMPLE_RADIAL_FISHEYE:o.fx=o.fy=t[0],o.cx=t[1],o.cy=t[2],o.k1=t[3];break;case $e.RADIAL_FISHEYE:o.fx=o.fy=t[0],o.cx=t[1],o.cy=t[2],o.k1=t[3],o.k2=t[4];break;case $e.THIN_PRISM_FISHEYE:o.fx=t[0],o.fy=t[1],o.cx=t[2],o.cy=t[3],o.k1=t[4],o.k2=t[5],o.p1=t[6],o.p2=t[7],o.k3=t[8],o.k4=t[9],o.sx1=t[10],o.sy1=t[11];break}return o}const wa=BigInt(-1),$e={SIMPLE_PINHOLE:0,PINHOLE:1,SIMPLE_RADIAL:2,RADIAL:3,OPENCV:4,OPENCV_FISHEYE:5,FULL_OPENCV:6,FOV:7,SIMPLE_RADIAL_FISHEYE:8,RADIAL_FISHEYE:9,THIN_PRISM_FISHEYE:10},pm={[$e.SIMPLE_PINHOLE]:3,[$e.PINHOLE]:4,[$e.SIMPLE_RADIAL]:4,[$e.RADIAL]:5,[$e.OPENCV]:8,[$e.OPENCV_FISHEYE]:8,[$e.FULL_OPENCV]:12,[$e.FOV]:5,[$e.SIMPLE_RADIAL_FISHEYE]:4,[$e.RADIAL_FISHEYE]:5,[$e.THIN_PRISM_FISHEYE]:12};function gm(e){const t=new Rr(e),n=new Map,o=t.readUint64AsNumber();for(let s=0;s<o;s++){const a=t.readUint32(),i=t.readInt32(),l=t.readUint64AsNumber(),c=t.readUint64AsNumber(),d=pm[i]??0,u=[];for(let f=0;f<d;f++)u.push(t.readFloat64());n.set(a,{cameraId:a,modelId:i,width:l,height:c,params:u})}return n}function xm(e){const t=new Map,n=e.split(`
`),o={SIMPLE_PINHOLE:$e.SIMPLE_PINHOLE,PINHOLE:$e.PINHOLE,SIMPLE_RADIAL:$e.SIMPLE_RADIAL,RADIAL:$e.RADIAL,OPENCV:$e.OPENCV,OPENCV_FISHEYE:$e.OPENCV_FISHEYE,FULL_OPENCV:$e.FULL_OPENCV,FOV:$e.FOV,SIMPLE_RADIAL_FISHEYE:$e.SIMPLE_RADIAL_FISHEYE,RADIAL_FISHEYE:$e.RADIAL_FISHEYE,THIN_PRISM_FISHEYE:$e.THIN_PRISM_FISHEYE};for(const s of n){if(s.startsWith("#")||s.trim()==="")continue;const a=s.trim().split(/\s+/);if(a.length<4)continue;const i=parseInt(a[0]),l=a[1],c=o[l];if(c===void 0){console.warn(`Unknown camera model: ${l}`);continue}const d=parseInt(a[2]),u=parseInt(a[3]),f=[];for(let p=4;p<a.length;p++)f.push(parseFloat(a[p]));t.set(i,{cameraId:i,modelId:c,width:d,height:u,params:f})}return t}function ym(e,t=!1){const n=new Rr(e),o=new Map,s=n.readUint64AsNumber();for(let a=0;a<s;a++){const i=n.readUint32(),l=[n.readFloat64(),n.readFloat64(),n.readFloat64(),n.readFloat64()],c=[n.readFloat64(),n.readFloat64(),n.readFloat64()],d=n.readUint32(),u=n.readString(),f=n.readUint64AsNumber(),p=[];if(t)n.skip(f*24);else for(let g=0;g<f;g++){const y=n.readFloat64(),v=n.readFloat64(),w=n.readInt64();p.push({xy:[y,v],point3DId:w})}o.set(i,{imageId:i,qvec:l,tvec:c,cameraId:d,name:u,points2D:p,numPoints2D:f})}return o}function vm(e){const t=new Map,n=e.split(`
`);let o=0;for(;o<n.length;){const s=n[o].trim();if(s.startsWith("#")||s===""){o++;continue}const a=s.split(/\s+/);if(a.length<10){o++;continue}const i=parseInt(a[0]),l=[parseFloat(a[1]),parseFloat(a[2]),parseFloat(a[3]),parseFloat(a[4])],c=[parseFloat(a[5]),parseFloat(a[6]),parseFloat(a[7])],d=parseInt(a[8]),u=a[9];o++;const f=[];if(o<n.length&&!n[o].startsWith("#")){const p=n[o].trim();if(p!==""){const g=p.split(/\s+/);for(let y=0;y+2<g.length;y+=3){const v=parseFloat(g[y]),w=parseFloat(g[y+1]),x=BigInt(g[y+2]);f.push({xy:[v,w],point3DId:x})}}}t.set(i,{imageId:i,qvec:l,tvec:c,cameraId:d,name:u,points2D:f}),o++}return t}function wm(e){const t=new Rr(e),n=new Map,o=t.readUint64AsNumber();for(let s=0;s<o;s++){const a=t.readUint64(),i=[t.readFloat64(),t.readFloat64(),t.readFloat64()],l=[t.readUint8(),t.readUint8(),t.readUint8()],c=t.readFloat64(),d=t.readUint64AsNumber(),u=[];for(let f=0;f<d;f++)u.push({imageId:t.readUint32(),point2DIdx:t.readUint32()});n.set(a,{point3DId:a,xyz:i,rgb:l,error:c,track:u})}return n}function bm(e){const t=new Map,n=e.split(`
`);for(const o of n){if(o.startsWith("#")||o.trim()==="")continue;const s=o.trim().split(/\s+/);if(s.length<8)continue;const a=BigInt(s[0]),i=[parseFloat(s[1]),parseFloat(s[2]),parseFloat(s[3])],l=[parseInt(s[4]),parseInt(s[5]),parseInt(s[6])],c=parseFloat(s[7]),d=[];for(let u=8;u+1<s.length;u+=2)d.push({imageId:parseInt(s[u]),point2DIdx:parseInt(s[u+1])});t.set(a,{point3DId:a,xyz:i,rgb:l,error:c,track:d})}return t}function Cm(e){const t=new Rr(e),n=new Map,o=t.readUint64AsNumber();for(let s=0;s<o;s++){const a=t.readUint32(),i=t.readUint32(),l=[];let c=null;if(i>0){const d=t.readInt32(),u=t.readUint32();c={type:d,id:u},l.push({sensorId:c,hasPose:!1});for(let f=1;f<i;f++){const p=t.readInt32(),g=t.readUint32(),y=t.readUint8()!==0,v={sensorId:{type:p,id:g},hasPose:y};if(y){const w=t.readFloat64(),x=t.readFloat64(),m=t.readFloat64(),S=t.readFloat64(),k=t.readFloat64(),j=t.readFloat64(),b=t.readFloat64();v.pose={qvec:[w,x,m,S],tvec:[k,j,b]}}l.push(v)}}n.set(a,{rigId:a,refSensorId:c,sensors:l})}return n}function km(e){const t=new Map,n=e.split(`
`);let o=0;for(;o<n.length;){const s=n[o].trim();if(o++,s.startsWith("#")||s==="")continue;const a=s.split(/\s+/);if(a.length<4)continue;const i=parseInt(a[0]),l=parseInt(a[1]),d={type:parseInt(a[2]),id:parseInt(a[3])},u=[];u.push({sensorId:d,hasPose:!1});for(let f=1;f<l&&o<n.length;f++){const p=n[o].trim();if(o++,p.startsWith("#")||p===""){f--;continue}const g=p.split(/\s+/);if(g.length<3)continue;const y=parseInt(g[0]),v=parseInt(g[1]),w=parseInt(g[2])!==0,x={sensorId:{type:y,id:v},hasPose:w};w&&g.length>=10&&(x.pose={qvec:[parseFloat(g[3]),parseFloat(g[4]),parseFloat(g[5]),parseFloat(g[6])],tvec:[parseFloat(g[7]),parseFloat(g[8]),parseFloat(g[9])]}),u.push(x)}t.set(i,{rigId:i,refSensorId:d,sensors:u})}return t}function Sm(e){const t=new Rr(e),n=new Map,o=t.readUint64AsNumber();for(let s=0;s<o;s++){const a=t.readUint32(),i=t.readUint32(),l=t.readFloat64(),c=t.readFloat64(),d=t.readFloat64(),u=t.readFloat64(),f=t.readFloat64(),p=t.readFloat64(),g=t.readFloat64(),y={qvec:[l,c,d,u],tvec:[f,p,g]},v=t.readUint32(),w=[];for(let x=0;x<v;x++){const m=t.readInt32(),S=t.readUint32(),k=t.readUint64AsNumber();w.push({sensorId:{type:m,id:S},dataId:k})}n.set(a,{frameId:a,rigId:i,rigFromWorld:y,dataIds:w})}return n}function jm(e){const t=new Map,n=e.split(`
`);let o=0;for(;o<n.length;){const s=n[o].trim();if(o++,s.startsWith("#")||s==="")continue;const a=s.split(/\s+/);if(a.length<10)continue;const i=parseInt(a[0]),l=parseInt(a[1]),c={qvec:[parseFloat(a[2]),parseFloat(a[3]),parseFloat(a[4]),parseFloat(a[5])],tvec:[parseFloat(a[6]),parseFloat(a[7]),parseFloat(a[8])]},d=parseInt(a[9]),u=[];for(let f=0;f<d&&o<n.length;f++){const p=n[o].trim();if(o++,p.startsWith("#")||p===""){f--;continue}const g=p.split(/\s+/);g.length<3||u.push({sensorId:{type:parseInt(g[0]),id:parseInt(g[1])},dataId:parseInt(g[2])})}t.set(i,{frameId:i,rigId:l,rigFromWorld:c,dataIds:u})}return t}function Im(e,t){const n=new Map;for(const v of e.keys())n.set(v,{numPoints3D:0,totalError:0,errorCount:0,covisibleSet:new Set});const o=new Map;for(const v of e.keys())o.set(v,new Map);const s=new Map;for(const v of e.keys())s.set(v,new Set);let a=0,i=0,l=0,c=1/0,d=-1/0,u=1/0,f=-1/0;for(const v of t.values()){const w=v.track.map(k=>k.imageId),x=v.error,m=x>=0,S=v.track.length;l+=S,S<u&&(u=S),S>f&&(f=S),m&&(a+=x,i++,x<c&&(c=x),x>d&&(d=x));for(const k of v.track){const j=n.get(k.imageId);if(j){j.numPoints3D++,m&&(j.totalError+=x,j.errorCount++);for(const M of w)M!==k.imageId&&j.covisibleSet.add(M)}const b=s.get(k.imageId);b&&b.add(v.point3DId)}for(let k=0;k<w.length;k++)for(let j=k+1;j<w.length;j++){const b=w[k],M=w[j],E=o.get(b),P=o.get(M);E&&E.set(M,(E.get(M)||0)+1),P&&P.set(b,(P.get(b)||0)+1)}}const p=new Map;for(const[v,w]of n)p.set(v,{numPoints3D:w.numPoints3D,avgError:w.errorCount>0?w.totalError/w.errorCount:0,covisibleCount:w.covisibleSet.size});const g=t.size,y={minError:i>0?c:0,maxError:i>0?d:0,avgError:i>0?a/i:0,minTrackLength:g>0?u:0,maxTrackLength:g>0?f:0,avgTrackLength:g>0?l/g:0,totalObservations:l,totalPoints:g};return{imageStats:p,connectedImagesIndex:o,globalStats:y,imageToPoint3DIds:s}}function Mm(e,t){const n=t.pointCount,o=t.getErrors(),s=t.getTrackOffsets(),a=t.getTrackImageIds(),i=t.getPoint3DIds(),l=new Map;for(const k of e.keys())l.set(k,{numPoints3D:0,totalError:0,errorCount:0,covisibleSet:new Set});const c=new Map;for(const k of e.keys())c.set(k,new Map);const d=new Map;for(const k of e.keys())d.set(k,new Set);let u=0,f=0,p=0,g=1/0,y=-1/0,v=1/0,w=-1/0;if(s&&a&&o)for(let k=0;k<n;k++){const j=s[k],b=s[k+1],M=b-j,E=o[k],P=E>=0,I=i?i[k]:BigInt(k+1),R=[];for(let A=j;A<b;A++)R.push(a[A]);p+=M,M<v&&(v=M),M>w&&(w=M),P&&(u+=E,f++,E<g&&(g=E),E>y&&(y=E));for(const A of R){const G=l.get(A);if(G){G.numPoints3D++,P&&(G.totalError+=E,G.errorCount++);for(const z of R)z!==A&&G.covisibleSet.add(z)}const F=d.get(A);F&&F.add(I)}for(let A=0;A<R.length;A++)for(let G=A+1;G<R.length;G++){const F=R[A],z=R[G],Z=c.get(F),U=c.get(z);Z&&Z.set(z,(Z.get(z)||0)+1),U&&U.set(F,(U.get(F)||0)+1)}}const x=new Map;for(const[k,j]of l)x.set(k,{numPoints3D:j.numPoints3D,avgError:j.errorCount>0?j.totalError/j.errorCount:0,covisibleCount:j.covisibleSet.size});const m=n,S={minError:f>0?g:0,maxError:f>0?y:0,avgError:f>0?u/f:0,minTrackLength:m>0?v:0,maxTrackLength:m>0?w:0,avgTrackLength:m>0?p/m:0,totalObservations:p,totalPoints:m};return{imageStats:x,connectedImagesIndex:c,globalStats:S,imageToPoint3DIds:d}}function Hs(e,t){if(e.points3D&&e.points3D.size>0)return e.points3D;if(t?.hasPoints()){console.log("[Export] Building points3D Map on-demand from WASM...");const n=performance.now(),o=t.buildPoints3DMap(),s=performance.now()-n;return console.log(`[Export] Built ${o.size.toLocaleString()} points in ${s.toFixed(0)}ms`),o}return console.warn("[Export] No points3D data available for export"),new Map}const Em=BigInt("18446744073709551615"),Pm={[$e.SIMPLE_PINHOLE]:"SIMPLE_PINHOLE",[$e.PINHOLE]:"PINHOLE",[$e.SIMPLE_RADIAL]:"SIMPLE_RADIAL",[$e.RADIAL]:"RADIAL",[$e.OPENCV]:"OPENCV",[$e.OPENCV_FISHEYE]:"OPENCV_FISHEYE",[$e.FULL_OPENCV]:"FULL_OPENCV",[$e.FOV]:"FOV",[$e.SIMPLE_RADIAL_FISHEYE]:"SIMPLE_RADIAL_FISHEYE",[$e.RADIAL_FISHEYE]:"RADIAL_FISHEYE",[$e.THIN_PRISM_FISHEYE]:"THIN_PRISM_FISHEYE"};function it(e){return e.toPrecision(17).replace(/\.?0+$/,"")}function Un(e){return Array.from(e.keys()).sort((t,n)=>typeof t=="bigint"&&typeof n=="bigint"?t<n?-1:t>n?1:0:Number(t)-Number(n))}function Lm(e){return e===wa?Em:e}function _m(e){return e===wa?"-1":e.toString()}function Am(e){const t=[];t.push("# Camera list with one line of data per camera:"),t.push("#   CAMERA_ID, MODEL, WIDTH, HEIGHT, PARAMS[]"),t.push(`# Number of cameras: ${e.size}`);for(const n of Un(e)){const o=e.get(n),s=Pm[o.modelId]??"UNKNOWN",a=o.params.map(it).join(" ");t.push(`${n} ${s} ${o.width} ${o.height} ${a}`)}return t.join(`
`)+`
`}function Nm(e,t){const n=[],o=i=>i.points2D.length>0?i.points2D:t?t.getImagePoints2DArray(i.imageId):[];let s=0;for(const i of e.values()){const l=o(i);s+=l.filter(c=>c.point3DId!==wa).length}const a=e.size>0?(s/e.size).toFixed(6):"0";n.push("# Image list with two lines of data per image:"),n.push("#   IMAGE_ID, QW, QX, QY, QZ, TX, TY, TZ, CAMERA_ID, NAME"),n.push("#   POINTS2D[] as (X, Y, POINT3D_ID)"),n.push(`# Number of images: ${e.size}, mean observations per image: ${a}`);for(const i of Un(e)){const l=e.get(i),[c,d,u,f]=l.qvec,[p,g,y]=l.tvec;n.push([i,it(c),it(d),it(u),it(f),it(p),it(g),it(y),l.cameraId,l.name].join(" "));const w=o(l).map(x=>`${it(x.xy[0])} ${it(x.xy[1])} ${_m(x.point3DId)}`).join(" ");n.push(w)}return n.join(`
`)+`
`}function Rm(e){const t=[];let n=0;for(const s of e.values())n+=s.track.length;const o=e.size>0?(n/e.size).toFixed(6):"0";t.push("# 3D point list with one line of data per point:"),t.push("#   POINT3D_ID, X, Y, Z, R, G, B, ERROR, TRACK[] as (IMAGE_ID, POINT2D_IDX)"),t.push(`# Number of points: ${e.size}, mean track length: ${o}`);for(const s of Un(e)){const a=e.get(s),[i,l,c]=a.xyz,[d,u,f]=a.rgb,p=a.track.map(g=>`${g.imageId} ${g.point2DIdx}`).join(" ");t.push([s.toString(),it(i),it(l),it(c),d,u,f,it(a.error),p].join(" "))}return t.join(`
`)+`
`}function Mu(e){const t=new Fr;t.writeUint64FromNumber(e.size);for(const n of Un(e)){const o=e.get(n);t.writeUint32(n),t.writeInt32(o.modelId),t.writeUint64FromNumber(o.width),t.writeUint64FromNumber(o.height);for(const s of o.params)t.writeFloat64(s)}return t.toArrayBuffer()}function Eu(e,t){const n=new Fr;n.writeUint64FromNumber(e.size);for(const o of Un(e)){const s=e.get(o);n.writeUint32(o),n.writeFloat64(s.qvec[0]),n.writeFloat64(s.qvec[1]),n.writeFloat64(s.qvec[2]),n.writeFloat64(s.qvec[3]),n.writeFloat64(s.tvec[0]),n.writeFloat64(s.tvec[1]),n.writeFloat64(s.tvec[2]),n.writeUint32(s.cameraId),n.writeString(s.name);let a=s.points2D;a.length===0&&t&&(a=t.getImagePoints2DArray(o)),n.writeUint64FromNumber(a.length);for(const i of a)n.writeFloat64(i.xy[0]),n.writeFloat64(i.xy[1]),n.writeUint64(Lm(i.point3DId))}return n.toArrayBuffer()}function Pu(e){const t=new Fr;t.writeUint64FromNumber(e.size);for(const n of Un(e)){const o=e.get(n);t.writeUint64(n),t.writeFloat64(o.xyz[0]),t.writeFloat64(o.xyz[1]),t.writeFloat64(o.xyz[2]),t.writeUint8(o.rgb[0]),t.writeUint8(o.rgb[1]),t.writeUint8(o.rgb[2]),t.writeFloat64(o.error),t.writeUint64FromNumber(o.track.length);for(const s of o.track)t.writeUint32(s.imageId),t.writeUint32(s.point2DIdx)}return t.toArrayBuffer()}function Fm(e){const t=["ply","format ascii 1.0",`element vertex ${e.size}`,"property float x","property float y","property float z","property uchar red","property uchar green","property uchar blue","end_header"].join(`
`)+`
`,n=[];for(const o of e.values())n.push(`${o.xyz[0]} ${o.xyz[1]} ${o.xyz[2]} ${o.rgb[0]} ${o.rgb[1]} ${o.rgb[2]}`);return t+n.join(`
`)+`
`}function Tm(e){const t=[];t.push("# Rig list with one line per sensor"),t.push("# RIG_ID, NUM_SENSORS, REF_SENSOR_TYPE, REF_SENSOR_ID"),t.push("# SENSOR_TYPE, SENSOR_ID, HAS_POSE[, QW, QX, QY, QZ, TX, TY, TZ]"),t.push(`# Number of rigs: ${e.size}`);for(const n of Un(e)){const o=e.get(n),s=o.refSensorId?.type??0,a=o.refSensorId?.id??0;t.push(`${n} ${o.sensors.length} ${s} ${a}`);for(let i=1;i<o.sensors.length;i++){const l=o.sensors[i],c=l.hasPose?1:0;if(l.hasPose&&l.pose){const[d,u,f,p]=l.pose.qvec,[g,y,v]=l.pose.tvec;t.push(`${l.sensorId.type} ${l.sensorId.id} ${c} ${it(d)} ${it(u)} ${it(f)} ${it(p)} ${it(g)} ${it(y)} ${it(v)}`)}else t.push(`${l.sensorId.type} ${l.sensorId.id} ${c}`)}}return t.join(`
`)+`
`}function Lu(e){const t=new Fr;t.writeUint64FromNumber(e.size);for(const n of Un(e)){const o=e.get(n);if(t.writeUint32(n),t.writeUint32(o.sensors.length),o.sensors.length>0){const s=o.refSensorId?.type??0,a=o.refSensorId?.id??0;t.writeInt32(s),t.writeUint32(a);for(let i=1;i<o.sensors.length;i++){const l=o.sensors[i];t.writeInt32(l.sensorId.type),t.writeUint32(l.sensorId.id),t.writeUint8(l.hasPose?1:0),l.hasPose&&l.pose&&(t.writeFloat64(l.pose.qvec[0]),t.writeFloat64(l.pose.qvec[1]),t.writeFloat64(l.pose.qvec[2]),t.writeFloat64(l.pose.qvec[3]),t.writeFloat64(l.pose.tvec[0]),t.writeFloat64(l.pose.tvec[1]),t.writeFloat64(l.pose.tvec[2]))}}}return t.toArrayBuffer()}function Dm(e){const t=[];t.push("# Frame list with one line of data per frame"),t.push("# FRAME_ID, RIG_ID, QW, QX, QY, QZ, TX, TY, TZ, NUM_DATA_IDS"),t.push("# SENSOR_TYPE, SENSOR_ID, DATA_ID"),t.push(`# Number of frames: ${e.size}`);for(const n of Un(e)){const o=e.get(n),[s,a,i,l]=o.rigFromWorld.qvec,[c,d,u]=o.rigFromWorld.tvec;t.push([n,o.rigId,it(s),it(a),it(i),it(l),it(c),it(d),it(u),o.dataIds.length].join(" "));for(const f of o.dataIds)t.push(`${f.sensorId.type} ${f.sensorId.id} ${f.dataId}`)}return t.join(`
`)+`
`}function _u(e){const t=new Fr;t.writeUint64FromNumber(e.size);for(const n of Un(e)){const o=e.get(n);t.writeUint32(n),t.writeUint32(o.rigId),t.writeFloat64(o.rigFromWorld.qvec[0]),t.writeFloat64(o.rigFromWorld.qvec[1]),t.writeFloat64(o.rigFromWorld.qvec[2]),t.writeFloat64(o.rigFromWorld.qvec[3]),t.writeFloat64(o.rigFromWorld.tvec[0]),t.writeFloat64(o.rigFromWorld.tvec[1]),t.writeFloat64(o.rigFromWorld.tvec[2]),t.writeUint32(o.dataIds.length);for(const s of o.dataIds)t.writeInt32(s.sensorId.type),t.writeUint32(s.sensorId.id),t.writeUint64FromNumber(s.dataId)}return t.toArrayBuffer()}function kn(e,t){const n=typeof e=="string"?new Blob([e],{type:"text/plain;charset=utf-8"}):new Blob([e],{type:"application/octet-stream"}),o=URL.createObjectURL(n),s=document.createElement("a");s.href=o,s.download=t,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(o)}function gl(e,t){const n=Hs(e,t);if(kn(Am(e.cameras),"cameras.txt"),kn(Nm(e.images,t),"images.txt"),kn(Rm(n),"points3D.txt"),e.rigData){const{rigs:o,frames:s}=e.rigData;o.size>0&&kn(Tm(o),"rigs.txt"),s.size>0&&kn(Dm(s),"frames.txt")}}function xl(e,t){const n=Hs(e,t);if(kn(Mu(e.cameras),"cameras.bin"),kn(Eu(e.images,t),"images.bin"),kn(Pu(n),"points3D.bin"),e.rigData){const{rigs:o,frames:s}=e.rigData;o.size>0&&kn(Lu(o),"rigs.bin"),s.size>0&&kn(_u(s),"frames.bin")}}function yl(e,t){const n=Hs(e,t);kn(Fm(n),"points.ply")}async function zm(e,t,n,o,s){const{zipSync:a}=await ma(async()=>{const{zipSync:u}=await import("./browser-CXh1ITwj.js");return{zipSync:u}},[]),i={},l=t.compressionLevel??6,c=Hs(e,o);if(i["sparse/0/cameras.bin"]=new Uint8Array(Mu(e.cameras)),i["sparse/0/images.bin"]=new Uint8Array(Eu(e.images,o)),i["sparse/0/points3D.bin"]=new Uint8Array(Pu(c)),e.rigData){const{rigs:u,frames:f}=e.rigData;u.size>0&&(i["sparse/0/rigs.bin"]=new Uint8Array(Lu(u))),f.size>0&&(i["sparse/0/frames.bin"]=new Uint8Array(_u(f)))}if(t.includeImages&&n&&n.size>0){let u=0;const f=n.size,p=new Map;for(const[g,y]of n)p.has(y)||p.set(y,g);for(const[g,y]of p){if(!y.includes("/")&&y!==g.name)continue;let v=y.replace(/\\/g,"/");v.startsWith("images/")||(v=`images/${v}`);try{const w=await g.arrayBuffer();if(i[v]=new Uint8Array(w),u++,u%10===0){const x=25+Math.round(u/f*50);s?.(x,`Adding images (${u}/${f})...`)}}catch(w){console.warn(`[ZIP Export] Failed to add image: ${y}`,w)}}}const d=a(i,{level:l});return new Blob([d],{type:"application/zip"})}async function Om(e,t,n,o,s,a="reconstruction.zip"){const i=await zm(e,t,n,o,s),l=URL.createObjectURL(i),c=document.createElement("a");c.href=l,c.download=a,document.body.appendChild(c),c.click(),document.body.removeChild(c),URL.revokeObjectURL(l)}function Au(){if(typeof window>"u")return!1;const e=window.location.hash;if(e){const n=e.startsWith("#")?e.slice(1):e;if(new URLSearchParams(n).get("d"))return!0}return!!new URLSearchParams(window.location.search).get("url")}const vl=Au(),ye=Mn((e,t)=>({reconstruction:null,wasmReconstruction:null,loadedFiles:null,droppedFiles:null,loading:!1,error:null,progress:0,sourceType:null,sourceUrl:null,imageUrlBase:null,maskUrlBase:null,sourceManifest:null,urlLoading:vl,urlProgress:vl?{percent:0,message:"Initializing..."}:null,urlError:null,setReconstruction:n=>{e({reconstruction:n,loading:!1,progress:100,error:null})},setWasmReconstruction:n=>{const o=t().wasmReconstruction;o&&o!==n&&o.dispose(),e({wasmReconstruction:n})},setLoadedFiles:n=>e({loadedFiles:n}),setDroppedFiles:n=>e({droppedFiles:n}),setLoading:n=>e({loading:n}),setError:n=>e({error:n,loading:!1}),setProgress:n=>e({progress:n}),setSourceInfo:(n,o=null,s=null,a=null,i=null)=>e({sourceType:n,sourceUrl:o,imageUrlBase:s,maskUrlBase:a,sourceManifest:i}),setUrlLoading:n=>e({urlLoading:n}),setUrlProgress:n=>e({urlProgress:n}),setUrlError:n=>e(n?{urlError:n,urlLoading:!1}:{urlError:n}),clear:()=>{const n=t().wasmReconstruction;n&&n.dispose(),e({reconstruction:null,wasmReconstruction:null,loadedFiles:null,droppedFiles:null,error:null,progress:0,loading:!1,sourceType:null,sourceUrl:null,imageUrlBase:null,maskUrlBase:null,sourceManifest:null,urlLoading:!1,urlProgress:null,urlError:null})}})),ct={legacy:"colmap-viewer-settings",pointCloud:"colmap-viewer-pointcloud",camera:"colmap-viewer-camera",ui:"colmap-viewer-ui",export:"colmap-viewer-export",rig:"colmap-viewer-rig",guide:"colmap-viewer-guide",settingsResetWarningShown:"colmap-viewer-settings-reset-warning-shown"},Nu=1,$m=["pointSize","colorMode","minTrackLength"],Bm=["cameraDisplayMode","cameraScale","cameraMode","flySpeed","frustumColorMode","unselectedCameraOpacity","selectionColorMode","selectionAnimationSpeed","showImagePlanes","selectionPlaneOpacity"],Um=["showPoints2D","showPoints3D","matchesDisplayMode","matchesOpacity","showMaskOverlay","maskOpacity","showAxes","showGrid","axesOpacity","backgroundColor","autoRotate"],Wm=["screenshotSize","screenshotFormat","screenshotHideLogo","exportFormat"];let wl=!1;function Hm(e){const t={...e};return"showCameras"in t&&typeof t.showCameras=="boolean"&&(t.cameraDisplayMode=t.showCameras?"frustum":"off",delete t.showCameras),"showMatches"in t&&typeof t.showMatches=="boolean"&&(t.matchesDisplayMode=t.showMatches?"on":"off",delete t.showMatches),"rainbowMode"in t&&typeof t.rainbowMode=="boolean"&&(t.selectionColorMode=t.rainbowMode?"rainbow":"static",delete t.rainbowMode),"rainbowSpeed"in t&&(t.selectionAnimationSpeed=t.rainbowSpeed,delete t.rainbowSpeed),t}function Zr(e,t){const n={};for(const o of t)o in e&&(n[o]=e[o]);return n}function Vr(e,t){Object.keys(t).length>0&&localStorage.setItem(e,JSON.stringify({state:t,version:0}))}function Zm(){return typeof window>"u"||!localStorage.getItem(ct.legacy)?!1:![ct.pointCloud,ct.camera,ct.ui,ct.export].some(n=>localStorage.getItem(n)!==null)}function Vm(){if(wl||(wl=!0,!Zm()))return!1;try{const e=localStorage.getItem(ct.legacy);if(!e)return!1;const t=JSON.parse(e),n=t.state||t,o=Hm(n);return Vr(ct.pointCloud,Zr(o,$m)),Vr(ct.camera,Zr(o,Bm)),Vr(ct.ui,Zr(o,Um)),Vr(ct.export,Zr(o,Wm)),localStorage.removeItem(ct.legacy),console.log("[Store Migration] Successfully migrated from legacy store to domain stores"),!0}catch(e){return console.error("[Store Migration] Failed to migrate legacy store:",e),!1}}function Gm(){if(typeof window>"u")return;const e=localStorage.getItem(ct.settingsResetWarningShown),t=String(Nu);if(e===t)return;if(![ct.pointCloud,ct.camera,ct.ui,ct.export,ct.rig].some(o=>localStorage.getItem(o)!==null)){localStorage.setItem(ct.settingsResetWarningShown,t);return}ma(async()=>{const{useNotificationStore:o}=await Promise.resolve().then(()=>ip);return{useNotificationStore:o}},void 0).then(({useNotificationStore:o})=>{o.getState().addNotification("warning","New features available! Consider resetting settings via the âŸ³ button in the startup panel to enable them."),localStorage.setItem(ct.settingsResetWarningShown,t)})}function Ym(){Vm(),Gm()}function qm(){typeof window>"u"||localStorage.setItem(ct.settingsResetWarningShown,String(Nu))}const Qe=Mn()(Qo(e=>({showPointCloud:!0,pointSize:2,pointOpacity:1,colorMode:"rgb",minTrackLength:0,maxReprojectionError:1/0,selectedPointId:null,setShowPointCloud:t=>e({showPointCloud:t}),togglePointCloud:()=>e(t=>({showPointCloud:!t.showPointCloud})),setPointSize:t=>e({pointSize:t}),setPointOpacity:t=>e({pointOpacity:t}),setColorMode:t=>e({colorMode:t}),setMinTrackLength:t=>e({minTrackLength:t}),setMaxReprojectionError:t=>e({maxReprojectionError:t}),setSelectedPointId:t=>e({selectedPointId:t})}),{name:ct.pointCloud,version:0,partialize:e=>({showPointCloud:e.showPointCloud,pointSize:e.pointSize,pointOpacity:e.pointOpacity,colorMode:e.colorMode,minTrackLength:e.minTrackLength,maxReprojectionError:e.maxReprojectionError}),merge:(e,t)=>({...t,...e,maxReprojectionError:e?.maxReprojectionError??1/0})})),B=Mn()(Qo((e,t)=>({showCameras:!0,cameraDisplayMode:"frustum",cameraScaleFactor:"1",cameraScale:.25,frustumColorMode:"byCamera",unselectedCameraOpacity:.5,cameraMode:"orbit",cameraProjection:"perspective",cameraFov:60,horizonLock:"off",autoRotateMode:"off",autoRotateSpeed:.5,flySpeed:2.5,flyTransitionDuration:600,flyToImageId:null,pointerLock:!0,selectedImageId:null,showSelectionHighlight:!0,selectionColorMode:"rainbow",selectionColor:"#00ff00",selectionAnimationSpeed:2,selectionPlaneOpacity:1,undistortionEnabled:!1,undistortionMode:"fullFrame",navigationHistory:[],flyToViewState:null,currentViewState:null,setShowCameras:n=>e({showCameras:n}),toggleCameras:()=>e(n=>({showCameras:!n.showCameras})),setCameraDisplayMode:n=>e({cameraDisplayMode:n}),setCameraScaleFactor:n=>e({cameraScaleFactor:n}),setCameraScale:n=>e({cameraScale:n}),setFrustumColorMode:n=>e({frustumColorMode:n}),setUnselectedCameraOpacity:n=>e({unselectedCameraOpacity:n}),setCameraMode:n=>e({cameraMode:n}),setCameraProjection:n=>e({cameraProjection:n}),setCameraFov:n=>e({cameraFov:n}),setHorizonLock:n=>e({horizonLock:n}),setAutoRotateMode:n=>e({autoRotateMode:n}),setAutoRotateSpeed:n=>e({autoRotateSpeed:n}),setFlySpeed:n=>e({flySpeed:n}),setFlyTransitionDuration:n=>e({flyTransitionDuration:n}),setPointerLock:n=>e({pointerLock:n}),flyToImage:n=>e({flyToImageId:n}),clearFlyTo:()=>e({flyToImageId:null}),setSelectedImageId:n=>e({selectedImageId:n}),toggleSelectedImageId:n=>e(o=>({selectedImageId:o.selectedImageId===n?null:n})),setShowSelectionHighlight:n=>e({showSelectionHighlight:n}),toggleSelectionHighlight:()=>e(n=>({showSelectionHighlight:!n.showSelectionHighlight})),setSelectionColorMode:n=>e({selectionColorMode:n}),setSelectionColor:n=>e({selectionColor:n}),setSelectionAnimationSpeed:n=>e({selectionAnimationSpeed:n}),setSelectionPlaneOpacity:n=>e({selectionPlaneOpacity:n}),setUndistortionEnabled:n=>e({undistortionEnabled:n}),setUndistortionMode:n=>e({undistortionMode:n}),pushNavigationHistory:n=>e(o=>({navigationHistory:[...o.navigationHistory,n].slice(-50)})),popNavigationHistory:()=>{const n=t();if(n.navigationHistory.length===0)return;const o=n.navigationHistory[n.navigationHistory.length-1];return e({navigationHistory:n.navigationHistory.slice(0,-1)}),o},peekNavigationHistory:()=>{const n=t();return n.navigationHistory.length>0?n.navigationHistory[n.navigationHistory.length-1]:void 0},clearNavigationHistory:()=>e({navigationHistory:[]}),flyToState:n=>e({flyToViewState:n}),clearFlyToViewState:()=>e({flyToViewState:null}),setCurrentViewState:n=>e({currentViewState:n})}),{name:ct.camera,version:2,migrate:(e,t)=>{const n=e;return t<1&&(n.cameraDisplayMode==="off"?(n.showCameras=!1,n.cameraDisplayMode="frustum"):n.showCameras=!0),t<2&&(n.selectionColorMode==="off"?(n.showSelectionHighlight=!1,n.selectionColorMode="rainbow"):n.showSelectionHighlight=!0),n},partialize:e=>({showCameras:e.showCameras,cameraDisplayMode:e.cameraDisplayMode,cameraScaleFactor:e.cameraScaleFactor,cameraScale:e.cameraScale,frustumColorMode:e.frustumColorMode,unselectedCameraOpacity:e.unselectedCameraOpacity,cameraMode:e.cameraMode,cameraProjection:e.cameraProjection,cameraFov:e.cameraFov,horizonLock:e.horizonLock,autoRotateMode:e.autoRotateMode,autoRotateSpeed:e.autoRotateSpeed,flySpeed:e.flySpeed,flyTransitionDuration:e.flyTransitionDuration,pointerLock:e.pointerLock,showSelectionHighlight:e.showSelectionHighlight,selectionColorMode:e.selectionColorMode,selectionColor:e.selectionColor,selectionAnimationSpeed:e.selectionAnimationSpeed,selectionPlaneOpacity:e.selectionPlaneOpacity,undistortionEnabled:e.undistortionEnabled,undistortionMode:e.undistortionMode})})),bl=["resetView","cycleAutoRotate","toggleBackground","toggleAxes","toggleGizmo","onePointOrigin","twoPointScale","threePointAlign","takeScreenshot"],q=Mn()(Qo(e=>({imageDetailId:null,showPoints2D:!1,showPoints3D:!1,showMatchesInModal:!1,matchedImageId:null,showMatches:!1,matchesDisplayMode:"on",matchesOpacity:.75,matchesColor:"#ff00ff",showMaskOverlay:!1,maskOpacity:.7,showAxes:!0,showGrid:!0,axesCoordinateSystem:"colmap",axesScale:1,gridScale:1,axisLabelMode:"extra",backgroundColor:"#ffffff",showGizmo:!1,galleryCollapsed:!1,embedMode:!1,contextMenuActions:bl,contextMenuPosition:null,showContextMenuEditor:!1,viewResetTrigger:0,viewDirection:null,viewTrigger:0,fps:0,openImageDetail:t=>e({imageDetailId:t,matchedImageId:null}),closeImageDetail:()=>e({imageDetailId:null,matchedImageId:null}),setShowPoints2D:t=>e({showPoints2D:t}),setShowPoints3D:t=>e({showPoints3D:t}),setShowMatchesInModal:t=>e({showMatchesInModal:t,matchedImageId:null}),setMatchedImageId:t=>e({matchedImageId:t}),setShowMatches:t=>e({showMatches:t}),toggleMatches:()=>e(t=>({showMatches:!t.showMatches})),setMatchesDisplayMode:t=>e({matchesDisplayMode:t}),setMatchesOpacity:t=>e({matchesOpacity:t}),setMatchesColor:t=>e({matchesColor:t}),setShowMaskOverlay:t=>e({showMaskOverlay:t}),setMaskOpacity:t=>e({maskOpacity:t}),setShowAxes:t=>e({showAxes:t}),setShowGrid:t=>e({showGrid:t}),toggleAxes:()=>e(t=>({showAxes:!t.showAxes})),toggleGrid:()=>e(t=>({showGrid:!t.showGrid})),setAxesCoordinateSystem:t=>e({axesCoordinateSystem:t}),setAxesScale:t=>e({axesScale:t}),setGridScale:t=>e({gridScale:t}),setAxisLabelMode:t=>e({axisLabelMode:t}),setBackgroundColor:t=>e({backgroundColor:t}),setShowGizmo:t=>e({showGizmo:t}),toggleGizmo:()=>e(t=>({showGizmo:!t.showGizmo})),resetView:()=>e(t=>({viewResetTrigger:t.viewResetTrigger+1})),setView:t=>e(n=>({viewDirection:t,viewTrigger:n.viewTrigger+1})),setGalleryCollapsed:t=>e({galleryCollapsed:t}),toggleGalleryCollapsed:()=>e(t=>({galleryCollapsed:!t.galleryCollapsed})),setEmbedMode:t=>e({embedMode:t}),openContextMenu:(t,n)=>e({contextMenuPosition:{x:t,y:n}}),closeContextMenu:()=>e({contextMenuPosition:null}),setContextMenuActions:t=>e({contextMenuActions:t}),addContextMenuAction:t=>e(n=>({contextMenuActions:n.contextMenuActions.includes(t)?n.contextMenuActions:[...n.contextMenuActions,t]})),removeContextMenuAction:t=>e(n=>({contextMenuActions:n.contextMenuActions.filter(o=>o!==t)})),openContextMenuEditor:()=>e({showContextMenuEditor:!0}),closeContextMenuEditor:()=>e({showContextMenuEditor:!1}),setFps:t=>e({fps:t})}),{name:ct.ui,version:9,migrate:(e,t)=>{const n=e;if(t<3&&(n.contextMenuActions=bl),t<6&&(delete n.useWasmParser,delete n.liteParserThresholdMB,delete n.memoryStrategy,delete n.imageLoadMode),t<7){const o=n.axesDisplayMode;n.showAxes=o==="axes"||o==="both"||o===void 0,n.showGrid=o==="grid"||o==="both"||o===void 0,delete n.axesDisplayMode}if(t<8){const o=n.gizmoMode;n.showGizmo=o==="local"||o==="global",delete n.gizmoMode}if(t<9){const o=n.matchesDisplayMode;o==="off"?(n.showMatches=!1,n.matchesDisplayMode="on"):n.showMatches=o!==void 0}return n},partialize:e=>({showPoints2D:e.showPoints2D,showPoints3D:e.showPoints3D,showMatches:e.showMatches,matchesDisplayMode:e.matchesDisplayMode,matchesOpacity:e.matchesOpacity,matchesColor:e.matchesColor,showMaskOverlay:e.showMaskOverlay,maskOpacity:e.maskOpacity,showAxes:e.showAxes,showGrid:e.showGrid,axesCoordinateSystem:e.axesCoordinateSystem,axesScale:e.axesScale,gridScale:e.gridScale,axisLabelMode:e.axisLabelMode,backgroundColor:e.backgroundColor,showGizmo:e.showGizmo,galleryCollapsed:e.galleryCollapsed,contextMenuActions:e.contextMenuActions})})),He=Mn()(Qo((e,t)=>({screenshotSize:"current",screenshotFormat:"jpeg",screenshotHideLogo:!1,screenshotTrigger:0,exportFormat:"binary",exportTrigger:0,isRecordingGif:!1,gifBlobUrl:null,gifDuration:5,gifDownsample:2,gifSpeed:1,recordingQuality:"high",recordingFormat:"webm",getScreenshotBlob:null,recordGif:null,setScreenshotSize:n=>e({screenshotSize:n}),setScreenshotFormat:n=>e({screenshotFormat:n}),setScreenshotHideLogo:n=>e({screenshotHideLogo:n}),takeScreenshot:()=>e(n=>({screenshotTrigger:n.screenshotTrigger+1})),setExportFormat:n=>e({exportFormat:n}),triggerExport:()=>e(n=>({exportTrigger:n.exportTrigger+1})),setGetScreenshotBlob:n=>e({getScreenshotBlob:n}),setRecordGif:n=>e({recordGif:n}),setIsRecordingGif:n=>e({isRecordingGif:n}),setGifBlobUrl:n=>{const o=t().gifBlobUrl;o&&URL.revokeObjectURL(o),e({gifBlobUrl:n})},setGifDuration:n=>e({gifDuration:n}),setGifDownsample:n=>e({gifDownsample:n}),setGifSpeed:n=>e({gifSpeed:n}),setRecordingQuality:n=>e({recordingQuality:n}),setRecordingFormat:n=>e({recordingFormat:n}),downloadGif:()=>{const n=t().gifBlobUrl,o=t().recordingFormat;if(!n)return;const s=o==="webm"?"webm":o==="mp4"?"mp4":"gif",a=document.createElement("a");a.download=`colmap-view-${new Date().toISOString().slice(0,19).replace(/[:-]/g,"")}.${s}`,a.href=n,a.click()}}),{name:ct.export,version:0,partialize:e=>({screenshotSize:e.screenshotSize,screenshotFormat:e.screenshotFormat,screenshotHideLogo:e.screenshotHideLogo,exportFormat:e.exportFormat,gifDuration:e.gifDuration,gifDownsample:e.gifDownsample,gifSpeed:e.gifSpeed,recordingQuality:e.recordingQuality,recordingFormat:e.recordingFormat})}));function ba(e){return new ut(e.qvec[1],e.qvec[2],e.qvec[3],e.qvec[0]).invert()}function Zo(e){const t=ba(e);return new V(e.tvec[0],e.tvec[1],e.tvec[2]).negate().applyQuaternion(t)}function Xm(e){const t=ba(e);return{position:new V(e.tvec[0],e.tvec[1],e.tvec[2]).negate().applyQuaternion(t),quaternion:t}}function fo(e,t){if(e.length===0)return 0;const n=t/100*(e.length-1),o=Math.floor(n),s=Math.ceil(n);return o===s?e[o]:e[o]*(s-n)+e[s]*(n-o)}function $o(e){if(e.length===0)return 0;const t=[...e].sort((n,o)=>n-o);return fo(t,50)}function Is(){return{scale:1,rotation:new ut,translation:new V}}function zn(e){const t=new ut,n=new pn(e.rotationX,e.rotationY,e.rotationZ,"XYZ");return t.setFromEuler(n),{scale:e.scale,rotation:t,translation:new V(e.translationX,e.translationY,e.translationZ)}}function Bo(e){const t=new pn().setFromQuaternion(e.rotation,"XYZ");return{scale:e.scale,rotationX:t.x,rotationY:t.y,rotationZ:t.z,translationX:e.translation.x,translationY:e.translation.y,translationZ:e.translation.z}}function Cl(){return{scale:1,rotationX:0,rotationY:0,rotationZ:0,translationX:0,translationY:0,translationZ:0}}function Ru(e,t){const n=new V(t[0],t[1],t[2]);return n.applyQuaternion(e.rotation),n.multiplyScalar(e.scale),n.add(e.translation),[n.x,n.y,n.z]}function Km(e){const t=1/e.scale,n=e.rotation.clone().invert(),o=e.translation.clone().applyQuaternion(n).multiplyScalar(-t);return{scale:t,rotation:n,translation:o}}function Uo(e,t){const n=e.scale*t.scale,o=e.rotation.clone().multiply(t.rotation).normalize(),s=t.translation.clone().applyQuaternion(e.rotation).multiplyScalar(e.scale).add(e.translation);return{scale:n,rotation:o,translation:s}}function Qm(e,t,n){const o={scale:1,rotation:new ut(t[1],t[2],t[3],t[0]),translation:new V(n[0],n[1],n[2])},s=Km(e),a=Uo(o,s),i=a.translation.clone().multiplyScalar(e.scale);return{qvec:[a.rotation.w,a.rotation.x,a.rotation.y,a.rotation.z],tvec:[i.x,i.y,i.z]}}function Fu(e,t,n){const o=new Map;for(const[i,l]of t.images){const{qvec:c,tvec:d}=Qm(e,l.qvec,l.tvec);o.set(i,{...l,qvec:c,tvec:d})}let s=t.points3D;if(!s||s.size===0)if(n?.hasPoints()){console.log("[Transform] Building points3D Map on-demand from WASM...");const i=performance.now();s=n.buildPoints3DMap();const l=performance.now()-i;console.log(`[Transform] Built ${s.size.toLocaleString()} points in ${l.toFixed(0)}ms`)}else s=new Map;const a=new Map;for(const[i,l]of s){const c=Ru(e,l.xyz);a.set(i,{...l,xyz:c})}return{...t,images:o,points3D:a}}function kl(e){const t=[];for(const a of e.images.values())t.push(Zo(a));if(t.length===0)return Is();const n=$o(t.map(a=>a.x)),o=$o(t.map(a=>a.y)),s=$o(t.map(a=>a.z));return{scale:1,rotation:new ut,translation:new V(-n,-o,-s)}}function Jm(e){const t=new go;return t.compose(e.translation,e.rotation,new V(e.scale,e.scale,e.scale)),t}function jo(e){return Math.abs(e.scale-1)<1e-9&&Math.abs(e.rotationX)<1e-9&&Math.abs(e.rotationY)<1e-9&&Math.abs(e.rotationZ)<1e-9&&Math.abs(e.translationX)<1e-9&&Math.abs(e.translationY)<1e-9&&Math.abs(e.translationZ)<1e-9}function ep(e,t,n){const o=e.distanceTo(t);if(o<1e-10)return Is();const s=n/o,i=new V().addVectors(e,t).multiplyScalar(.5).clone().multiplyScalar(1-s);return{scale:s,rotation:new ut,translation:i}}function tp(e){return{scale:1,rotation:new ut,translation:new V(-e.x,-e.y,-e.z)}}function np(e,t,n,o=!1,s=new V(0,1,0)){const a=new V().subVectors(t,e),i=new V().subVectors(n,e),l=new V().crossVectors(a,i);if(l.lengthSq()<1e-10)return Is();l.normalize(),o&&l.negate();const c=s.clone().normalize(),d=l.dot(c);if(Math.abs(d-1)<1e-6)return Is();let u;if(Math.abs(d+1)<1e-6){const y=new V(1,0,0);Math.abs(c.dot(y))>.9&&y.set(0,0,1),u=new ut().setFromAxisAngle(y,Math.PI)}else u=new ut().setFromUnitVectors(l,c);const f=new V().add(e).add(t).add(n).divideScalar(3),p=f.clone().applyQuaternion(u),g=new V().subVectors(f,p);return{scale:1,rotation:u,translation:g}}const Lt=Mn()(e=>({transform:Cl(),setTransform:t=>e(n=>({transform:{...n.transform,...t}})),resetTransform:()=>e({transform:Cl()})}));function Tu(e){return e==="blender"||e==="unreal"?["Z","Y","X"]:["Y","X","Z"]}function op(e){return Tu(e)[0]}const Ve=Mn()((e,t)=>({pickingMode:"off",selectedPoints:[],hoveredPoint:null,targetDistance:null,showDistanceModal:!1,modalPosition:null,normalFlipped:!1,targetAxis:"Y",markerRightClickHandled:!1,setPickingMode:n=>e({pickingMode:n,selectedPoints:[],hoveredPoint:null,targetDistance:null,showDistanceModal:!1,modalPosition:null,normalFlipped:!1,targetAxis:"Y",markerRightClickHandled:!1}),addSelectedPoint:(n,o)=>{const{pickingMode:s,selectedPoints:a}=t(),i=s==="origin-1pt"?1:s==="distance-2pt"?2:s==="normal-3pt"?3:0;if(a.length>=i)return;const l=[...a,n],c=l.length>=i;e({selectedPoints:l,...c&&{showDistanceModal:!0,modalPosition:o||null}})},removePointAt:n=>e(o=>({selectedPoints:o.selectedPoints.filter((s,a)=>a!==n),showDistanceModal:!1,modalPosition:null,markerRightClickHandled:!0})),removeLastPoint:()=>e(n=>({selectedPoints:n.selectedPoints.slice(0,-1),showDistanceModal:!1,modalPosition:null})),clearSelectedPoints:()=>e({selectedPoints:[],hoveredPoint:null,targetDistance:null,showDistanceModal:!1,modalPosition:null,normalFlipped:!1,targetAxis:"Y"}),setHoveredPoint:n=>e({hoveredPoint:n}),setTargetDistance:n=>e({targetDistance:n}),setShowDistanceModal:n=>e({showDistanceModal:n}),toggleNormalFlipped:()=>e(n=>({normalFlipped:!n.normalFlipped})),cycleTargetAxis:n=>e(o=>{const s=Tu(n),a=s.indexOf(o.targetAxis),i=a===-1?0:(a+1)%3;return{targetAxis:s[i],markerRightClickHandled:!0}}),setTargetAxis:n=>e({targetAxis:n}),reset:()=>e({pickingMode:"off",selectedPoints:[],hoveredPoint:null,targetDistance:null,showDistanceModal:!1,modalPosition:null,normalFlipped:!1,targetAxis:"Y",markerRightClickHandled:!1})})),zt=Mn()(Qo(e=>({showRig:!0,rigDisplayMode:"lines",rigColorMode:"single",rigLineColor:"#00ffff",rigLineOpacity:.7,setShowRig:t=>e({showRig:t}),toggleRig:()=>e(t=>({showRig:!t.showRig})),setRigDisplayMode:t=>e({rigDisplayMode:t}),setRigColorMode:t=>e({rigColorMode:t}),setRigLineColor:t=>e({rigLineColor:t}),setRigLineOpacity:t=>e({rigLineOpacity:t})}),{name:ct.rig,version:1,migrate:(e,t)=>{const n=e;return t<1&&(n.rigDisplayMode==="off"?(n.showRig=!1,n.rigDisplayMode="lines"):n.showRig=!0),n},partialize:e=>({showRig:e.showRig,rigDisplayMode:e.rigDisplayMode,rigColorMode:e.rigColorMode,rigLineColor:e.rigLineColor,rigLineOpacity:e.rigLineOpacity})}));let rp=0;function sp(){return`notification-${Date.now()}-${++rp}`}const Nt=Mn(e=>({notifications:[],addNotification:(t,n,o)=>{const s=sp(),a={id:s,type:t,message:n,duration:t==="info"?o??3e3:void 0};return e(i=>({notifications:[...i.notifications,a]})),s},removeNotification:t=>{e(n=>({notifications:n.notifications.filter(o=>o.id!==t)}))},clearAll:()=>{e({notifications:[]})}})),ip=Object.freeze(Object.defineProperty({__proto__:null,useNotificationStore:Nt},Symbol.toStringTag,{value:"Module"})),Ca=Mn()(Qo((e,t)=>({tipShownCounts:{},showTip:(n,o,s=1)=>{const a=t().tipShownCounts[n]||0;return a>=s?!1:(Nt.getState().addNotification("info",o,5e3),e(i=>({tipShownCounts:{...i.tipShownCounts,[n]:a+1}})),!0)},getTipShownCount:n=>t().tipShownCounts[n]||0,resetGuide:()=>e({tipShownCounts:{}})}),{name:ct.guide,version:0})),Sl={detectedPlane:null,distanceThreshold:.05,maxIterations:1e3,sampleCount:5e4,pointDistances:null,normalFlipped:!1,targetAxis:"Y",floorColorMode:"off",showFloorModal:!1,modalPosition:null,isDetecting:!1},Ge=Mn()(e=>({...Sl,setDetectedPlane:t=>e({detectedPlane:t}),setDistanceThreshold:t=>e({distanceThreshold:t}),setMaxIterations:t=>e({maxIterations:t}),setSampleCount:t=>e({sampleCount:t}),setPointDistances:t=>e({pointDistances:t}),toggleNormalFlipped:()=>e(t=>({normalFlipped:!t.normalFlipped})),setNormalFlipped:t=>e({normalFlipped:t}),cycleTargetAxis:()=>e(t=>{const n=["X","Y","Z"],s=(n.indexOf(t.targetAxis)+1)%n.length;return{targetAxis:n[s]}}),setTargetAxis:t=>e({targetAxis:t}),setFloorColorMode:t=>e({floorColorMode:t}),setShowFloorModal:t=>e({showFloorModal:t}),setModalPosition:t=>e({modalPosition:t}),setIsDetecting:t=>e({isDetecting:t}),reset:()=>e(Sl)})),dn={TEXTURE:0,BITMAP:10,BLOB_URL:20,FILE_CACHE:30,STORE_STATE:40,ARCHIVE:50};class ap{entries=new Map;isClearing=!1;register(t){this.entries.has(t.name)&&console.warn(`[CacheManager] Cache "${t.name}" already registered, overwriting`),this.entries.set(t.name,t)}unregister(t){this.entries.delete(t)}clearAll(t={}){if(this.isClearing){console.warn("[CacheManager] clearAll already in progress, skipping");return}this.isClearing=!0;const n=performance.now();try{const o=this.topologicalSort(t);for(const a of o)try{a.clear()}catch(i){console.error(`[CacheManager] Error clearing "${a.name}":`,i)}const s=performance.now()-n;console.log(`[CacheManager] Cleared ${o.length} caches in ${s.toFixed(1)}ms`)}finally{this.isClearing=!1}}clearByNames(t){if(this.isClearing){console.warn("[CacheManager] clearAll already in progress, skipping clearByNames");return}this.isClearing=!0;try{const n=t.map(o=>this.entries.get(o)).filter(o=>o!==void 0).sort((o,s)=>o.priority-s.priority);for(const o of n)try{o.clear()}catch(s){console.error(`[CacheManager] Error clearing "${o.name}":`,s)}}finally{this.isClearing=!1}}getRegisteredNames(){return Array.from(this.entries.keys())}getStatsEntries(){const t=[];for(const n of this.entries.values())if(n.showInStats&&n.getStats)try{const o=n.getStats();t.push({name:n.name,label:n.label,strategy:n.strategy??"memory",memoryType:n.memoryType??"js",stats:o})}catch(o){console.error(`[CacheManager] Error getting stats for "${n.name}":`,o)}return t}getEntry(t){return this.entries.get(t)}topologicalSort(t){let n=Array.from(this.entries.values());t.preserveZip&&(n=n.filter(i=>i.name!=="zipCache"));const o=new Map;for(const i of n){const l=o.get(i.priority)||[];l.push(i),o.set(i.priority,l)}const s=Array.from(o.keys()).sort((i,l)=>i-l),a=[];for(const i of s){const l=o.get(i),c=this.sortGroupByDependencies(l);a.push(...c)}return a}sortGroupByDependencies(t){const n=new Map,o=new Map;for(const l of t)n.set(l.name,0),o.set(l.name,[]);for(const l of t)if(l.dependsOn)for(const c of l.dependsOn)n.has(c)&&(n.set(l.name,(n.get(l.name)||0)+1),o.get(c)?.push(l.name));const s=[];for(const[l,c]of n)c===0&&s.push(l);const a=[],i=new Map(t.map(l=>[l.name,l]));for(;s.length>0;){const l=s.shift();a.push(i.get(l));for(const c of o.get(l)||[]){const d=(n.get(c)||1)-1;n.set(c,d),d===0&&s.push(c)}}for(const l of t)a.includes(l)||(console.warn(`[CacheManager] Circular dependency detected for "${l.name}"`),a.push(l));return a}reset(){this.entries.clear(),this.isClearing=!1}}const Kt=new ap,jl={md:8,xl:16},mr={gallery:jl.md,matchView:jl.xl},io={listRowHeight:72,defaultCellHeight:100,modalMinWidth:400,modalMinHeight:300,frustumMaxSize:128,maxConcurrentLoads:12,logoHeight:"5vh"},tt={hoverCard:"w-3.5 h-3.5",social:"w-8 h-8",socialSm:"w-7 h-7"},ui={min:1,max:10,default:2},lp={mobile:1080},Eo={maxWidthPercent:.85,maxHeightPercent:.85,headerHeight:40,footerHeight:50,padding:32},cp={gallery:{defaultSize:30}},di={logoHeightPercent:.05,paddingPercent:.02,logoAlpha:.7},hn={wheelDebounce:100,resizeDebounce:16,transitionBase:150,galleryOverscan:3,listOverscan:5,textureUploadTimeout:150,textureUploadFallback:16,idleDeadlineBuffer:5,errorToastDuration:5e3},ln={fov:60,nearPlane:.001,farPlane:1e4,initialDistanceMultiplier:2.5,zoomTransitionFactor:.2,velocitySmoothingFactor:.5,frameTimeMs:16},nn={rotateSpeed:.003,panSpeed:.002,zoomSpeed:5e-4,damping:.92,flyDamping:.85,minVelocity:1e-4,moveSpeedMultiplier:.02,wheelMoveMultiplier:.001,shiftSpeedBoost:3,minDistance:.1},_t={frustum:{default:"#ff0000",selected:"#ff00ff",hover:"#6699aa"},point:{triangulated:"#00ff00",untriangulated:"#ff0000"},axis:{x:15073280,y:58880,z:230},wireframe:"#333333"},ar={threshold:.04045,linearScale:12.92,gammaOffset:.055,gammaScale:1.055,gamma:2.4},Xn={chroma:.8,lightness:.4,saturation:1,speedMultiplier:.5,hueSegments:{redToYellow:1/6,yellowToGreen:2/6,greenToCyan:3/6,cyanToBlue:4/6,blueToMagenta:5/6}},Zs={jet:{threshold1:.25,threshold2:.5,threshold3:.75,multiplier:4},trackLength:{baseR:.1,rangeR:.1,baseG:.1,rangeG:.9,baseB:.5,rangeB:.2}},fi={max:255},Il=["#e6194b","#3cb44b","#ffe119","#4363d8","#f58231","#911eb4","#42d4f4","#f032e6","#bfef45","#fabed4","#469990","#dcbeff","#9a6324","#fffac8","#800000","#aaffc3","#808000","#ffd8b1","#000075","#a9a9a9"];function Bi(e){return Il[e%Il.length]}const Du={tooltip:2e3},Ms={matchLines:.7,frustum:{hoveredNoTexture:.6},light:{ambient:.5,directional:.5}},ue={base:"inline-flex items-center justify-center rounded transition-colors cursor-pointer select-none",sizes:{xs:"px-2 py-1 text-xs gap-1",sm:"px-2.5 py-1.5 text-sm gap-1.5",md:"px-3 py-1.5 text-base gap-2",lg:"px-4 py-2 text-base gap-2",xl:"px-6 py-3 text-lg gap-3",toggle:"px-4 py-1 text-sm gap-1.5",toggleResponsive:"px-4 py-1 text-xs gap-1",action:"px-4 py-1.5 text-sm gap-2 min-w-[120px]",icon:"p-1",iconMd:"p-1.5",iconLg:"p-2",iconXl:"w-10 h-10"},variants:{primary:"bg-ds-accent text-ds-void hover-bg-ds-accent-90",secondary:"bg-ds-hover text-ds-primary hover-ds-elevated",tertiary:"bg-ds-tertiary text-ds-primary hover-ds-hover border border-ds",ghost:"bg-transparent text-ds-secondary hover-ds-text-primary hover-ds-hover",outline:"bg-transparent text-ds-primary border border-ds hover-ds-hover",danger:"bg-ds-error text-white hover-opacity-90",tab:"bg-transparent text-ds-secondary hover-ds-text-primary hover-ds-tertiary-50",tabActive:"bg-ds-tertiary text-ds-accent border-b-2 border-ds-accent",toggle:"bg-ds-hover text-ds-secondary hover-ds-text-primary hover-ds-elevated",toggleActive:"bg-ds-accent text-ds-void",toggleError:"bg-ds-error/20 text-ds-error border border-ds-error",toggleSuccess:"bg-ds-success/20 text-ds-success border border-ds-success",control:"bg-ds-tertiary text-ds-secondary hover-ds-hover hover-ds-text-primary rounded-lg border border-ds",controlActive:"bg-ds-accent text-ds-void rounded-lg border border-ds-accent",controlHover:"bg-ds-hover text-ds-primary rounded-lg border border-ds"},disabled:"opacity-50 cursor-not-allowed pointer-events-none",close:"text-ds-muted hover-ds-text-primary text-xl leading-none cursor-pointer",closeLg:"text-ds-muted hover-ds-text-primary text-2xl leading-none px-2 cursor-pointer"};function Ml(e="secondary",t="md",n=!1){const o=[ue.base,ue.sizes[t],ue.variants[e]];return n&&o.push(ue.disabled),o.join(" ")}const Yn={group:"flex gap-2 mt-3",button:`${ue.base} px-1 py-1 text-sm ${ue.variants.toggle} flex-1`,buttonDisabled:`${ue.base} px-1 py-1 text-sm ${ue.disabled} bg-ds-secondary text-ds-muted flex-1`,buttonPrimary:`${ue.base} px-1 py-1 text-sm ${ue.variants.toggleActive} flex-1`,buttonPrimaryDisabled:`${ue.base} px-1 py-1 text-sm ${ue.disabled} bg-ds-secondary text-ds-muted flex-1`,buttonFullWidth:"w-full px-3 py-1.5 bg-ds-accent text-ds-void rounded text-sm hover:opacity-90 transition-opacity",iconButtonConfirm:"p-0.5 text-green-400 hover:text-green-300 transition-colors flex items-center",iconButtonRetry:"p-0.5 text-yellow-400 hover:text-yellow-300 transition-colors flex items-center",iconButtonCancel:"p-0.5 text-red-400 hover:text-red-300 transition-colors flex items-center"},Sn={base:"bg-ds-input text-ds-primary border border-ds rounded focus-ds transition-colors",sizes:{sm:"px-2 py-1 text-sm",lg:"px-3 py-2 text-base"},select:"bg-ds-input text-ds-primary border border-ds-subtle rounded focus-ds cursor-pointer",selectPanel:"bg-ds-input text-ds-primary rounded focus-ds cursor-pointer",range:{base:"accent-ds-accent cursor-pointer"}},Wn={item:"bg-ds-tertiary rounded cursor-pointer relative border-2 transition-all",itemSelected:"border-ds-accent bg-ds-hover",itemHover:"border-transparent hover-border-ds-light hover-brightness-110",itemAspect:"aspect-square",itemInner:"absolute inset-0 overflow-hidden rounded-sm",itemImage:"absolute inset-0 w-full h-full object-cover",overlay:"absolute bottom-0 left-0 right-0 px-1.5 py-1.5",overlayText:"text-white text-sm truncate",placeholder:"absolute inset-0 flex items-center justify-center text-ds-muted text-xs p-1 text-center"},Hn={item:"flex items-center gap-3 px-2 h-full rounded cursor-pointer border-2 transition-all",itemSelected:"border-ds-accent bg-ds-hover",itemHover:"border-transparent hover-ds-hover hover-border-ds-light",thumbnail:"flex-shrink-0 bg-ds-hover rounded overflow-hidden",thumbnailSize:"w-14 h-14",thumbnailPlaceholder:"w-full h-full flex items-center justify-center text-ds-muted text-xs",content:"flex-1 min-w-0 overflow-hidden",title:"text-ds-primary text-sm truncate font-medium whitespace-nowrap",subtitle:"text-ds-muted text-xs truncate whitespace-nowrap"},jn={backdrop:"absolute inset-0 bg-ds-void/50 pointer-events-auto",panel:"absolute bg-ds-tertiary rounded-lg shadow-ds-lg flex flex-col pointer-events-auto",closeButton:ue.closeLg,iconButtonConfirm:Yn.iconButtonConfirm,iconButtonRetry:Yn.iconButtonRetry,iconButtonCancel:Yn.iconButtonCancel},up={row:"hover-ds-tertiary-50"},Gr={attr:"data-tooltip",posAttr:"data-tooltip-pos",positions:{top:void 0,bottom:"bottom",left:"left",right:"right"}};function zu(e,t){const n={[Gr.attr]:e};return t&&Gr.positions[t]&&(n[Gr.posAttr]=Gr.positions[t]),n}const se={container:"bg-ds-tertiary rounded-lg px-3 py-2 shadow-ds-lg whitespace-nowrap text-sm",title:"text-ds-primary",subtitle:"text-ds-secondary",hint:"text-ds-secondary text-sm mt-2",hintRow:"flex items-center gap-1"},lr={containerWithLayout:"absolute top-4 left-1/2 -translate-x-1/2 z-[500] bg-ds-tertiary rounded-lg shadow-ds-lg max-w-md flex items-start gap-3",error:"border border-ds-error",content:"px-6 py-3 text-ds-primary",titleError:"font-semibold mb-1 text-ds-error",message:"text-base text-ds-secondary"},bn={container:"fixed top-4 left-1/2 -translate-x-1/2 z-toast flex flex-col gap-3 pointer-events-none items-center",toast:"pointer-events-auto bg-ds-tertiary/90 rounded-lg shadow-ds-lg min-w-[300px] max-w-[400px] flex items-stretch",iconContainer:"flex-shrink-0 px-3 flex items-center rounded-l-lg",iconContainerInfo:"text-ds-info",iconContainerWarning:"text-ds-warning",icon:"w-5 h-5",content:"flex items-center py-4 px-4 flex-1",message:"text-sm text-ds-primary break-words",closeButton:"flex-shrink-0 px-3 flex items-center text-ds-muted hover-ds-text-primary hover-ds-hover cursor-pointer transition-colors rounded-r-lg",entering:"animate-slide-in-right",exiting:"animate-fade-out"},Po={overlay:"absolute inset-0 bg-black/50 backdrop-blur-sm z-[500] flex items-center justify-center",container:"text-center",progressBar:"w-64 h-2 bg-ds-tertiary rounded-full overflow-hidden",progressFill:"h-full bg-white transition-all duration-300",text:"text-xl mb-4 text-white",percentage:"text-base text-white mt-2"},Vn={container:"absolute top-3 right-3 flex flex-col gap-2 z-[1000] control-panel-responsive",button:"w-10 h-10 rounded-lg flex items-center justify-center transition-colors relative border border-ds control-button-responsive",buttonActive:"bg-ds-accent text-ds-void border-ds-accent",buttonHover:"bg-ds-hover text-ds-primary",buttonInactive:"bg-ds-tertiary text-ds-secondary hover-ds-hover hover-ds-text-primary",panelWrapper:"absolute right-full top-0 pr-2 z-[1100]",panel:"bg-ds-tertiary border border-ds rounded-lg p-4 w-[240px] shadow-ds-lg",panelTitle:"text-ds-primary text-sm font-medium mb-3",panelContent:"space-y-2",row:"flex items-center gap-2",label:"text-ds-secondary text-sm whitespace-nowrap w-24 flex-shrink-0",value:"text-ds-primary text-sm w-8 text-right flex-shrink-0 cursor-pointer hover-ds-accent box-border",valueInput:"bg-transparent text-ds-primary text-sm w-8 text-right flex-shrink-0 border-none p-0 m-0 focus:outline-none box-border",slider:`${Sn.range.base} flex-1 min-w-0`,select:`${Sn.selectPanel} py-0.5 pl-2 ml-1.5 text-sm flex-1`,selectRight:`${Sn.selectPanel} py-0.5 pl-2 pr-6 text-sm flex-1 min-w-0 w-full`,hint:"text-ds-secondary text-sm mt-3",hintTitle:"mb-1 font-medium",presetGroup:"flex flex-col gap-2 mt-3",presetButton:`${ue.base} ${ue.sizes.toggle} ${ue.variants.toggle} w-full justify-start`,actionGroup:Yn.group,actionButton:Yn.button,actionButtonDisabled:Yn.buttonDisabled,actionButtonPrimary:Yn.buttonPrimary,actionButtonPrimaryDisabled:Yn.buttonPrimaryDisabled};function dp(e,t){return e?`${Vn.button} ${Vn.buttonActive}`:t?`${Vn.button} ${Vn.buttonHover}`:`${Vn.button} ${Vn.buttonInactive}`}const on={track:"relative inline-flex items-center cursor-pointer transition-colors duration-200 rounded-full",trackSm:"w-7 h-4",trackMd:"w-9 h-5",trackLg:"w-11 h-6",trackOff:"bg-ds-secondary border border-ds-light",trackOn:"bg-ds-accent border border-ds-accent",thumb:"absolute bg-white rounded-full shadow-sm transition-all duration-200 ease-in-out",thumbSm:"w-2.5 h-2.5",thumbMd:"w-3.5 h-3.5",thumbLg:"w-4.5 h-4.5",disabled:"opacity-50 cursor-not-allowed",container:"flex items-center gap-2",label:"text-ds-secondary text-sm whitespace-nowrap cursor-pointer"},fp={sm:{off:3,on:14},md:{off:3,on:18},lg:{off:3,on:22}};function hp(e,t="md",n=!1){const s={sm:{track:on.trackSm,thumb:on.thumbSm},md:{track:on.trackMd,thumb:on.thumbMd},lg:{track:on.trackLg,thumb:on.thumbLg}}[t],a=fp[t],i=e?on.trackOn:on.trackOff;return{track:`${on.track} ${s.track} ${i}${n?` ${on.disabled}`:""}`,thumb:`${on.thumb} ${s.thumb}`,thumbStyle:{left:e?a.on:a.off,top:"50%",transform:"translateY(-50%)"}}}const cr={container:"absolute inset-0 bg-ds-accent/10 border-4 border-dashed border-ds-accent z-overlay flex items-center justify-center backdrop-blur-sm",content:"text-center",icon:"text-4xl mb-4",title:"text-xl font-semibold text-ds-primary",subtitle:"text-base text-ds-secondary mt-2"},Lo={logo:"absolute bottom-6 left-6 footer-logo-responsive",logoImage:"opacity-70 hover-opacity-100 transition-opacity",socialContainer:"absolute bottom-6 right-6 flex items-center gap-4 footer-social-responsive",socialLink:"text-ds-secondary opacity-70 hover-opacity-100 transition-opacity"},at={container:"bg-ds-tertiary rounded-lg shadow-ds-lg overflow-hidden border border-ds py-1",button:"flex items-center gap-2 px-3 py-1.5 text-sm text-ds-primary hover-ds-hover cursor-pointer transition-colors w-full text-left",icon:"w-4 h-4 flex-shrink-0",hotkey:"text-xs font-mono text-gray-500 ml-auto uppercase tracking-wide"},hi={group:"flex items-center gap-2"},El={container:"h-10 border-t border-ds bg-ds-tertiary text-ds-secondary text-base px-4 flex items-center justify-between status-bar-responsive overflow-visible",group:"flex items-center gap-6 status-bar-group overflow-visible"},cn={container:"h-full flex items-center justify-center text-ds-muted bg-ds-secondary",containerFull:"flex flex-col items-center justify-center h-full p-8 text-center bg-ds-secondary",icon:"text-ds-error text-6xl mb-4",title:"text-xl font-semibold text-ds-primary mb-2",message:"text-ds-secondary mb-4 max-w-md",button:"px-4 py-2 bg-ds-accent text-ds-void rounded hover-bg-ds-accent-90 transition-colors"},Pl={title:"text-2xl font-semibold text-ds-primary mb-3",message:"text-ds-secondary mb-4"},Wt={corner:"absolute w-3 h-3",edge:"absolute",nw:"top-0 left-0 cursor-nw-resize",ne:"top-0 right-0 cursor-ne-resize",sw:"bottom-0 left-0 cursor-sw-resize",se:"bottom-0 right-0 cursor-se-resize",n:"top-0 left-3 right-3 h-2 cursor-n-resize",s:"bottom-0 left-3 right-3 h-2 cursor-s-resize",w:"left-0 top-3 bottom-3 w-2 cursor-w-resize",e:"right-0 top-3 bottom-3 w-2 cursor-e-resize"},mi={container:`absolute left-1/2 z-[${Du.tooltip}]`,card:"bg-ds-tertiary rounded-lg px-4 py-3 shadow-ds-lg text-sm border border-ds",title:"text-ds-primary text-sm font-medium mb-1"},Ce={wrapper:"relative cursor-help overflow-visible",indicator:"inline-flex items-center gap-1",indicatorLabel:"text-ds-secondary",indicatorValue:"text-ds-primary",tooltipContainer:`absolute z-[${Du.tooltip}]`,card:"bg-ds-tertiary rounded-lg px-4 py-3 shadow-ds-lg text-sm border border-ds whitespace-nowrap",header:"flex items-center justify-between gap-8 mb-2",headerTitle:"flex items-center gap-1.5 text-ds-primary text-sm font-medium whitespace-nowrap",headerLegend:"flex items-center gap-4 text-[10px]",legendItem:"flex items-center gap-1",legendText:"text-ds-muted",dotMemoryJs:"inline-block w-1.5 h-1.5 rounded-full bg-green-400 flex-shrink-0",dotMemoryWasm:"inline-block w-1.5 h-1.5 rounded-full bg-amber-400 flex-shrink-0",dotLazy:"inline-block w-1.5 h-1.5 rounded-full bg-blue-400 flex-shrink-0",dotUnavailable:"inline-block w-1.5 h-1.5 rounded-full bg-neutral-600 flex-shrink-0",table:"w-full text-xs",tableHeader:"text-[10px] text-ds-muted border-b border-ds",tableHeaderCell:"py-1 font-normal whitespace-nowrap",tableHeaderLeft:"text-left",tableHeaderRight:"text-right",tableRowDimmed:"opacity-40",tableCellLabel:"pr-6 whitespace-nowrap",tableCellLabelInner:"flex items-center gap-2",tableCellLabelText:"text-ds-secondary whitespace-nowrap",tableCellCount:"px-4 text-right tabular-nums text-ds-primary whitespace-nowrap",tableCellSize:"pl-4 text-right tabular-nums text-ds-muted whitespace-nowrap w-20",tableFooter:"border-t border-ds font-medium",tableFooterCell:"pt-1.5",tableFooterLabel:"text-ds-secondary"},mp=.99;function Ui(e){const t=e>=mp;return{transparent:!t,depthWrite:t}}const pp=.001;function Ll(e,t=!0){return t&&e>pp}const Se={showHelp:{keys:"shift+/",description:"Show keyboard shortcuts",category:"general",scopes:["global"],preventDefault:!0},showJoke:{keys:"shift+z",description:"Show random COLMAP joke",category:"general",scopes:["viewer"],preventDefault:!0},showJokePersistent:{keys:"ctrl+shift+z",description:"Show random COLMAP joke (persistent)",category:"general",scopes:["viewer"],preventDefault:!0},resetGuide:{keys:"shift+0",description:"Reset guide tips",category:"general",scopes:["viewer"],preventDefault:!0},closeModal:{keys:"escape",description:"Close modal",category:"modal",scopes:["modal"]},prevImage:{keys:"left",description:"Previous image",category:"modal",scopes:["modal"]},nextImage:{keys:"right",description:"Next image",category:"modal",scopes:["modal"]},resetView:{keys:"r",description:"Reset view",category:"camera",scopes:["viewer"]},viewX:{keys:"1",description:"X-axis view",category:"camera",scopes:["viewer"]},viewY:{keys:"2",description:"Y-axis view",category:"camera",scopes:["viewer"]},viewZ:{keys:"3",description:"Z-axis view",category:"camera",scopes:["viewer"]},viewNegX:{keys:"4",description:"-X axis view",category:"camera",scopes:["viewer"]},viewNegY:{keys:"5",description:"-Y axis view",category:"camera",scopes:["viewer"]},viewNegZ:{keys:"6",description:"-Z axis view",category:"camera",scopes:["viewer"]},toggleGrid:{keys:"g",description:"Toggle grid",category:"camera",scopes:["viewer"]},toggleCameraMode:{keys:"c",description:"Toggle orbit/fly mode",category:"camera",scopes:["viewer"]},toggleBackground:{keys:"b",description:"Toggle background",category:"camera",scopes:["viewer"]},cycleImageLoad:{keys:"i",description:"Cycle image load mode",category:"camera",scopes:["viewer"]},cyclePointSize:{keys:"p",description:"Cycle point cloud color mode",category:"camera",scopes:["viewer"]},cycleCameraDisplay:{keys:"f",description:"Cycle frustum display",category:"camera",scopes:["viewer"]},cycleMatchesDisplay:{keys:"m",description:"Cycle matches display",category:"camera",scopes:["viewer"]},toggleGizmo:{keys:"t",description:"Toggle transform gizmo",category:"camera",scopes:["viewer"]},toggleUndistortion:{keys:"u",description:"Toggle image undistortion",category:"camera",scopes:["viewer"]},moveForward:{keys:"w",description:"Move forward",category:"camera",scopes:["viewer"]},moveBackward:{keys:"s",description:"Move backward",category:"camera",scopes:["viewer"]},moveLeft:{keys:"a",description:"Strafe left",category:"camera",scopes:["viewer"]},moveRight:{keys:"d",description:"Strafe right",category:"camera",scopes:["viewer"]},moveUp:{keys:"e, space",description:"Move up",category:"camera",scopes:["viewer"]},moveDown:{keys:"q",description:"Move down",category:"camera",scopes:["viewer"]},speedBoost:{keys:"shift",description:"Speed boost (hold)",category:"camera",scopes:["viewer"]},adjustFrustumSize:{keys:"alt+scroll",description:"Adjust camera frustum size",category:"camera",scopes:["viewer"]},adjustPointSize:{keys:"ctrl+scroll",description:"Adjust point cloud size",category:"camera",scopes:["viewer"]}},_l={general:"General",modal:"Image Modal",camera:"Camera Controls",navigation:"Navigation"};function gp(e){return Object.values(Se).filter(t=>t.category===e)}function Wi(e){return e.split(", ")[0].replace(/ctrl/gi,"Ctrl").replace(/cmd/gi,"âŒ˜").replace(/shift/gi,"Shift").replace(/alt/gi,"Alt").replace(/\+/g," + ").replace(/^left$/gi,"â†").replace(/^right$/gi,"â†’").replace(/^up$/gi,"â†‘").replace(/^down$/gi,"â†“").replace(/^escape$/gi,"Esc").replace(/^enter$/gi,"Enter").replace(/^space$/gi,"Space")}const pi=io.maxConcurrentLoads,ho=new Set,xp=3e3,yp=50;function vp(){}async function wp(e,t){return new Promise((n,o)=>{let s=!1;const a=setTimeout(()=>{s||(s=!0,o(new Error(`Image decode timed out after ${t}ms`)))},t);createImageBitmap(e).then(i=>{s?i.close():(s=!0,clearTimeout(a),n(i))}).catch(i=>{s||(s=!0,clearTimeout(a),o(i))})})}function bp(){return ho.size}function Ou(e){const{maxSize:t,processCanvas:n,dispose:o,idleTimeout:s=hn.textureUploadTimeout,idleFallback:a=hn.textureUploadFallback}=e,i={cache:new Map,loadingPromises:new Map,pendingQueue:[],pendingItems:[],activeLoads:0,cacheGeneration:0,idleCallbackScheduled:!1,paused:!1,bulkMode:!1};function l(y,v){if(i.paused){i.idleCallbackScheduled=!1;return}const w=1;let x=0;for(;i.pendingItems.length>0&&!(v!==void 0&&x>=v||x>=w&&y&&y.timeRemaining()<hn.idleDeadlineBuffer);){x++;const m=i.pendingItems.shift(),S=i.cache.get(m.cacheKey);if(S){m.bitmap.close(),m.resolve(S);continue}const k=Math.min(t/m.bitmap.width,t/m.bitmap.height,1),j=Math.round(m.bitmap.width*k),b=Math.round(m.bitmap.height*k);let M,E;typeof OffscreenCanvas<"u"?(M=new OffscreenCanvas(j,b),E=M.getContext("2d")):(M=document.createElement("canvas"),M.width=j,M.height=b,E=M.getContext("2d")),E&&E.drawImage(m.bitmap,0,0,j,b),m.bitmap.close();const P=n(M);P instanceof Promise?P.then(I=>{I!==null&&i.cache.set(m.cacheKey,I),m.resolve(I)}).catch(()=>{m.resolve(null)}):(i.cache.set(m.cacheKey,P),m.resolve(P))}i.idleCallbackScheduled=!1,i.pendingItems.length>0&&u()}let c=0,d=0;function u(){if(!(i.idleCallbackScheduled||i.paused)){if(i.idleCallbackScheduled=!0,i.bulkMode){queueMicrotask(()=>{l()});return}"requestIdleCallback"in window?requestIdleCallback(y=>{c++;const v=Date.now();(c%100===0||i.pendingItems.length>0&&v-d>1e4)&&(d=v,console.log(`Idle callback #${c}: ${i.pendingItems.length} items to process, ${y?.timeRemaining()?.toFixed(0)}ms remaining`)),l(y)},{timeout:s}):setTimeout(()=>{c++,l()},a)}}function f(){if(!i.paused)for(;i.activeLoads<pi&&i.pendingQueue.length>0;){const y=i.pendingQueue.shift();y&&(i.activeLoads++,y())}}async function p(y,v,w){const x=()=>{w===i.cacheGeneration&&(i.activeLoads--,i.loadingPromises.delete(v),f())};try{if(ho.has(v))return x(),null;if(w!==i.cacheGeneration)return null;const m=i.cache.get(v);if(m)return x(),m;let S;try{S=await wp(y,xp)}catch(k){return ho.add(v),ho.size<=20?console.warn(`[decode] Failed: "${v}" (${(y.size/1024).toFixed(0)} KB) -`,k):ho.size===21&&console.warn(`... suppressing further decode errors (${ho.size} images failed)`),x(),null}return w!==i.cacheGeneration?(S.close(),null):new Promise(k=>{i.pendingItems.length>=yp&&l(void 0,10),i.pendingItems.push({bitmap:S,cacheKey:v,resolve:j=>{x(),k(j)}}),u()})}catch(m){return console.warn(`Failed to load image "${v}":`,m),x(),null}}function g(y,v){const w=i.cacheGeneration;return new Promise(x=>{const m=()=>{if(w!==i.cacheGeneration){x(null);return}p(y,v,w).then(x)};i.activeLoads<pi?(i.activeLoads++,m()):i.pendingQueue.push(()=>m())})}return{getCached(y){return i.cache.get(y)??null},load(y,v){const w=i.cache.get(v);if(w)return Promise.resolve(w);let x=i.loadingPromises.get(v);return x||(x=g(y,v),i.loadingPromises.set(v,x)),x},prioritize(y,v){const w=i.cache.get(v);if(w)return Promise.resolve(w);const x=i.loadingPromises.get(v),m=i.pendingItems.findIndex(S=>S.cacheKey===v);if(m>0){const[S]=i.pendingItems.splice(m,1);return i.pendingItems.unshift(S),u(),x??Promise.resolve(null)}return x||this.load(y,v)},clear(){i.cacheGeneration++;for(const y of i.pendingItems)y.bitmap.close(),y.resolve(null);i.pendingItems.length=0;for(const y of i.cache.values())o(y);i.cache.clear(),i.loadingPromises.clear(),i.pendingQueue.length=0,i.activeLoads=0,i.idleCallbackScheduled=!1,ho.clear()},pause(){i.paused=!0},resume(){i.paused&&(i.paused=!1,i.pendingItems.length>0&&u(),i.pendingQueue.length>0&&f())},async prefetch(y,v){if(y.length===0){v?.(1);return}i.bulkMode=!0;let w=0;const x=y.length;let m=0;const S=()=>{const k=w/x;(k-m>=.05||w===x)&&(m=k,v?.(k))};try{const k=pi*4;for(let j=0;j<y.length;j+=k){const M=y.slice(j,j+k).map(async({file:E,name:P})=>{if(i.cache.has(P)){w++,S();return}let I=i.loadingPromises.get(P);I||(I=g(E,P),i.loadingPromises.set(P,I)),await I,w++,S()});await Promise.all(M)}}finally{i.bulkMode=!1}},getCacheGeneration(){return i.cacheGeneration},getStats(){return{count:i.cache.size,loading:i.loadingPromises.size,pending:i.pendingItems.length}},useCache(y,v,w){const[x,m]=h.useState(()=>w&&v?i.cache.get(v)??null:null),[S,k]=h.useState(i.cacheGeneration),j=S!==i.cacheGeneration;return h.useEffect(()=>{if(j&&(k(i.cacheGeneration),m(null)),!w||!y||!v){m(null);return}const b=i.cache.get(v);if(b){m(b);return}m(null);let M=i.loadingPromises.get(v);M||(M=g(y,v),i.loadingPromises.set(v,M));let E=!1;return M.then(P=>{E||m(P)}),()=>{E=!0}},[y,v,w,j]),j?null:x}}}async function Cp(e){try{const t=e instanceof OffscreenCanvas?await e.convertToBlob({type:"image/jpeg",quality:.75}):await new Promise(n=>e.toBlob(n,"image/jpeg",.75));return t?URL.createObjectURL(t):null}catch{return null}}const Jo=Ou({maxSize:io.frustumMaxSize,processCanvas:Cp,dispose:e=>URL.revokeObjectURL(e),idleTimeout:hn.textureUploadTimeout,idleFallback:hn.textureUploadFallback}),Vo=new Map,kp=50,Bn=new Map;async function ka(e,t){const n=Vo.get(t);if(n)return n.lastUsed=Date.now(),n.bitmap;try{const s=await(await fetch(e)).blob(),a=await createImageBitmap(s);return Vo.set(t,{bitmap:a,lastUsed:Date.now()}),a}catch{return null}}function Sa(e,t){if(!e||e.width<=0||e.height<=0)return console.warn(`[useFrustumTexture] Invalid bitmap dimensions for ${t}: ${e?.width}x${e?.height}`),null;const n=new hu(e);return n.colorSpace=mu,n.flipY=!1,n.needsUpdate=!0,Bn.set(t,{texture:n,lastUsed:Date.now()}),Bn.size>kp&&jp(),n}function Sp(e,t){const n=Bn.get(t);if(n)return n.lastUsed=Date.now(),n.texture;const o=Vo.get(t);return o?(o.lastUsed=Date.now(),Sa(o.bitmap,t)):(ka(e,t),null)}function jp(){const e=Array.from(Bn.entries());e.sort((n,o)=>n[1].lastUsed-o[1].lastUsed);const t=Math.floor(e.length/2);for(let n=0;n<t;n++){const[o,{texture:s}]=e[n];s.dispose(),Bn.delete(o)}}function Ip(){Jo.clear();for(const{texture:e}of Bn.values())e.image=null,e.needsUpdate=!1,e.dispose();if(Bn.clear(),Gn){const e=Gn.texture;e.image=null,e.needsUpdate=!1,e._bitmap&&(e._bitmap.close(),e._bitmap=void 0),e.dispose(),Gn=null}for(const{bitmap:e}of Vo.values())e.close();Vo.clear()}function Mp(){Jo.pause()}function Ep(){Jo.resume()}function Hi(){return{urlCache:Jo.getStats(),bitmaps:Vo.size,textures:Bn.size}}async function Zi(e,t){const n=await Jo.prioritize(e,t);if(!n)return null;const o=Bn.get(t);if(o)return o.lastUsed=Date.now(),o.texture;const s=await ka(n,t);return s?Sa(s,t):null}function Pp(e,t,n){const[o,s]=h.useState(null),a=h.useRef(null),i=Jo.useCache(e,t,n);return h.useEffect(()=>{if(!n||!i){s(null);return}const l=Sp(i,t);if(l){a.current=i,s(l);return}let c=!1;return ka(i,t).then(d=>{if(c||!d)return;const u=Sa(d,t);u&&(a.current=i,s(u))}),()=>{c=!0}},[i,t,n]),h.useEffect(()=>{if(o&&t){const l=Bn.get(t);l&&(l.lastUsed=Date.now())}},[o,t]),o}let Gn=null;function Lp(e,t,n){const[o,s]=h.useState(null);return h.useEffect(()=>{if(!n||!e){s(null);return}if(Gn?.name===t){s(Gn.texture);return}if(Gn){const i=Gn.texture;i._bitmap&&i._bitmap.close(),i.dispose(),Gn=null}let a=!1;return createImageBitmap(e).then(i=>{if(a){i.close();return}const l=new hu(i);l.colorSpace=mu,l.flipY=!1,l.needsUpdate=!0,l._bitmap=i,Gn={name:t,texture:l},s(l)}).catch(()=>{s(null)}),()=>{a=!0}},[e,t,n]),o}const _p=256;async function Ap(e){return new Promise(t=>{e instanceof OffscreenCanvas?e.convertToBlob({type:"image/jpeg",quality:.75}).then(n=>{t(URL.createObjectURL(n))}).catch(()=>{t(null)}):e.toBlob(n=>{t(n?URL.createObjectURL(n):null)},"image/jpeg",.75)})}const Tr=Ou({maxSize:_p,processCanvas:Ap,dispose:e=>URL.revokeObjectURL(e),idleTimeout:500,idleFallback:16});function Np(){Tr.clear()}function Al(){Tr.pause()}function Nl(){Tr.resume()}function $u(){return Tr.getStats()}function Bu(e,t,n){return Tr.useCache(e,t,n)}const Uu=Symbol("Comlink.proxy"),Rp=Symbol("Comlink.endpoint"),Fp=Symbol("Comlink.releaseProxy"),gi=Symbol("Comlink.finalizer"),ys=Symbol("Comlink.thrown"),Rl=e=>typeof e=="object"&&e!==null||typeof e=="function",Wu=new Map([["proxy",{canHandle:e=>Rl(e)&&e[Uu],serialize(e){const{port1:t,port2:n}=new MessageChannel;return Hu(e,t),[n,[n]]},deserialize:e=>(e.start(),Vu(e))}],["throw",{canHandle:e=>Rl(e)&&ys in e,serialize({value:e}){let t;return t=e instanceof Error?{isError:!0,value:{message:e.message,name:e.name,stack:e.stack}}:{isError:!1,value:e},[t,[]]},deserialize(e){throw e.isError?Object.assign(new Error(e.value.message),e.value):e.value}}]]);function Hu(e,t=globalThis,n=["*"]){t.addEventListener("message",(function o(s){if(!s||!s.data)return;if(!(function(u,f){for(const p of u)if(f===p||p==="*"||p instanceof RegExp&&p.test(f))return!0;return!1})(n,s.origin))return void console.warn(`Invalid origin '${s.origin}' for comlink proxy`);const{id:a,type:i,path:l}=Object.assign({path:[]},s.data),c=(s.data.argumentList||[]).map(po);let d;try{const u=l.slice(0,-1).reduce(((p,g)=>p[g]),e),f=l.reduce(((p,g)=>p[g]),e);switch(i){case"GET":d=f;break;case"SET":u[l.slice(-1)[0]]=po(s.data.value),d=!0;break;case"APPLY":d=f.apply(u,c);break;case"CONSTRUCT":d=ja(new f(...c));break;case"ENDPOINT":{const{port1:p,port2:g}=new MessageChannel;Hu(e,g),d=(function(y,v){return Yu.set(y,v),y})(p,[p])}break;case"RELEASE":d=void 0;break;default:return}}catch(u){d={value:u,[ys]:0}}Promise.resolve(d).catch((u=>({value:u,[ys]:0}))).then((u=>{const[f,p]=Ps(u);t.postMessage(Object.assign(Object.assign({},f),{id:a}),p),i==="RELEASE"&&(t.removeEventListener("message",o),Zu(t),gi in e&&typeof e[gi]=="function"&&e[gi]())})).catch((u=>{const[f,p]=Ps({value:new TypeError("Unserializable return value"),[ys]:0});t.postMessage(Object.assign(Object.assign({},f),{id:a}),p)}))})),t.start&&t.start()}function Zu(e){(function(t){return t.constructor.name==="MessagePort"})(e)&&e.close()}function Vu(e,t){return Vi(e,[],t)}function Yr(e){if(e)throw new Error("Proxy has been released and is not useable")}function Gu(e){return Ro(e,{type:"RELEASE"}).then((()=>{Zu(e)}))}const Es=new WeakMap,qr="FinalizationRegistry"in globalThis&&new FinalizationRegistry((e=>{const t=(Es.get(e)||0)-1;Es.set(e,t),t===0&&Gu(e)}));function Vi(e,t=[],n=function(){}){let o=!1;const s=new Proxy(n,{get(a,i){if(Yr(o),i===Fp)return()=>{(function(l){qr&&qr.unregister(l)})(s),Gu(e),o=!0};if(i==="then"){if(t.length===0)return{then:()=>s};const l=Ro(e,{type:"GET",path:t.map((c=>c.toString()))}).then(po);return l.then.bind(l)}return Vi(e,[...t,i])},set(a,i,l){Yr(o);const[c,d]=Ps(l);return Ro(e,{type:"SET",path:[...t,i].map((u=>u.toString())),value:c},d).then(po)},apply(a,i,l){Yr(o);const c=t[t.length-1];if(c===Rp)return Ro(e,{type:"ENDPOINT"}).then(po);if(c==="bind")return Vi(e,t.slice(0,-1));const[d,u]=Fl(l);return Ro(e,{type:"APPLY",path:t.map((f=>f.toString())),argumentList:d},u).then(po)},construct(a,i){Yr(o);const[l,c]=Fl(i);return Ro(e,{type:"CONSTRUCT",path:t.map((d=>d.toString())),argumentList:l},c).then(po)}});return(function(a,i){const l=(Es.get(i)||0)+1;Es.set(i,l),qr&&qr.register(a,i,a)})(s,e),s}function Fl(e){const t=e.map(Ps);return[t.map((o=>o[0])),(n=t.map((o=>o[1])),Array.prototype.concat.apply([],n))];var n}const Yu=new WeakMap;function ja(e){return Object.assign(e,{[Uu]:!0})}function Ps(e){for(const[t,n]of Wu)if(n.canHandle(e)){const[o,s]=n.serialize(e);return[{type:"HANDLER",name:t,value:o},s]}return[{type:"RAW",value:e},Yu.get(e)||[]]}function po(e){switch(e.type){case"HANDLER":return Wu.get(e.name).deserialize(e.value);case"RAW":return e.value}}function Ro(e,t,n){return new Promise((o=>{const s=new Array(4).fill(0).map((()=>Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16))).join("-");e.addEventListener("message",(function a(i){i.data&&i.data.id&&i.data.id===s&&(e.removeEventListener("message",a),o(i.data))})),e.start&&e.start(),e.postMessage(Object.assign({id:s},t),n)}))}class Ia{constructor(t,n,o,s,a){this._name=t,this._size=n,this._path=o,this._lastModified=s,this._archiveRef=a}get name(){return this._name}get size(){return this._size}get lastModified(){return this._lastModified}extract(){return this._archiveRef.extractSingleFile(this._path)}}function Gi(e){if(e instanceof File||e instanceof Ia||e===null)return e;const t={};for(const n of Object.keys(e))t[n]=Gi(e[n]);return t}function qu(e,t=""){const n=[];for(const o of Object.keys(e))e[o]instanceof File||e[o]instanceof Ia||e[o]===null?n.push({file:e[o]||o,path:t}):n.push(...qu(e[o],`${t}${o}/`));return n}function Tl(e,t){const n=t.split("/");n[n.length-1]===""&&n.pop();let o=e,s=null;for(const a of n)o[a]=o[a]||{},s=o,o=o[a];return[s,n[n.length-1]]}class Tp{constructor(t,n,o){this._content={},this._processed=0,this.file=t,this.client=n,this.worker=o}open(){return this._content={},this._processed=0,new Promise(((t,n)=>{this.client.open(this.file,ja((()=>{t(this)})))}))}async close(){var t;(t=this.worker)===null||t===void 0||t.terminate(),this.worker=null,this.client=null,this.file=null}async hasEncryptedData(){return await this.client.hasEncryptedData()}async usePassword(t){await this.client.usePassword(t)}async setLocale(t){await this.client.setLocale(t)}async getFilesObject(){return this._processed>0?Promise.resolve().then((()=>this._content)):((await this.client.listFiles()).forEach((t=>{const[n,o]=Tl(this._content,t.path);t.type==="FILE"&&(n[o]=new Ia(t.fileName,t.size,t.path,t.lastModified,this))})),this._processed=1,Gi(this._content))}getFilesArray(){return this.getFilesObject().then((t=>qu(t)))}async extractSingleFile(t){if(this.worker===null)throw new Error("Archive already closed");const n=await this.client.extractSingleFile(t);return new File([n.fileData],n.fileName,{type:"application/octet-stream",lastModified:n.lastModified/1e6})}async extractFiles(t=void 0){var n;return this._processed>1?Promise.resolve().then((()=>this._content)):((await this.client.extractFiles()).forEach((o=>{const[s,a]=Tl(this._content,o.path);o.type==="FILE"&&(s[a]=new File([o.fileData],o.fileName,{type:"application/octet-stream"}),t!==void 0&&setTimeout(t.bind(null,{file:s[a],path:o.path})))})),this._processed=2,(n=this.worker)===null||n===void 0||n.terminate(),Gi(this._content))}}var Dl,zl;(function(e){e.SEVEN_ZIP="7zip",e.AR="ar",e.ARBSD="arbsd",e.ARGNU="argnu",e.ARSVR4="arsvr4",e.BIN="bin",e.BSDTAR="bsdtar",e.CD9660="cd9660",e.CPIO="cpio",e.GNUTAR="gnutar",e.ISO="iso",e.ISO9660="iso9660",e.MTREE="mtree",e.MTREE_CLASSIC="mtree-classic",e.NEWC="newc",e.ODC="odc",e.OLDTAR="oldtar",e.PAX="pax",e.PAXR="paxr",e.POSIX="posix",e.PWB="pwb",e.RAW="raw",e.RPAX="rpax",e.SHAR="shar",e.SHARDUMP="shardump",e.USTAR="ustar",e.V7TAR="v7tar",e.V7="v7",e.WARC="warc",e.XAR="xar",e.ZIP="zip"})(Dl||(Dl={})),(function(e){e.B64ENCODE="b64encode",e.BZIP2="bzip2",e.COMPRESS="compress",e.GRZIP="grzip",e.GZIP="gzip",e.LRZIP="lrzip",e.LZ4="lz4",e.LZIP="lzip",e.LZMA="lzma",e.LZOP="lzop",e.UUENCODE="uuencode",e.XZ="xz",e.ZSTD="zstd",e.NONE="none"})(zl||(zl={}));class Qt{static init(t=null){return Qt._options=t||{},Qt._options}static async open(t){const n=Qt.getWorker(Qt._options),o=await Qt.getClient(n,Qt._options);return await new Tp(t,o,n).open()}static async write({files:t,outputFileName:n,compression:o,format:s,passphrase:a=null}){const i=Qt.getWorker(Qt._options),l=await Qt.getClient(i,Qt._options),c=await l.writeArchive(t,o,s,a);return i.terminate(),new File([c],n,{type:"application/octet-stream"})}static getWorker(t){return t.getWorker?t.getWorker():new Worker(t.workerUrl||new URL("/v0.4.7/assets/worker-bundle-Dx5mKZOL.js",import.meta.url),{type:"module"})}static async getClient(t,n){var o;const s=((o=n.createClient)===null||o===void 0?void 0:o.call(n,t))||Vu(t);let{promise:a,resolve:i}=Promise.withResolvers();const l=await new s(ja((()=>{i()})));return await a,l}}Qt._options={},Promise.withResolvers||(Promise.withResolvers=function(){var e,t,n=new this((function(o,s){e=o,t=s}));return{resolve:e,reject:t,promise:n}});const bo=e=>`/v0.4.7/${e.replace(/^\//,"")}`,Dp=3e4;async function Yi(e,t=Dp){const n=new AbortController,o=setTimeout(()=>n.abort(),t);try{const s=await fetch(e,{signal:n.signal});return clearTimeout(o),s}catch(s){throw clearTimeout(o),s}}function Xu(e,t){return e instanceof Error?e.name==="AbortError"?{type:"timeout",message:"Request timed out",details:`The request to ${t||"the server"} took too long to respond.`,failedFile:t}:e.name==="TypeError"&&(e.message.includes("Failed to fetch")||e.message.includes("NetworkError")||e.message.includes("CORS"))?{type:"cors",message:"Cross-origin request blocked",details:"This URL does not allow cross-origin requests. The server needs to include CORS headers.",failedFile:t}:e.name==="TypeError"?{type:"network",message:"Network error",details:e.message,failedFile:t}:{type:"unknown",message:e.message,failedFile:t}:{type:"unknown",message:String(e),failedFile:t}}function zp(e,t){return new File([e],t,{type:e.type})}function Op(e){return new URL(e).pathname.split("/").pop()||"unknown"}function $p(e){if(e.includes("huggingface.co"))return e.replace("/tree/main/","/resolve/main/").replace("/blob/main/","/resolve/main/");const t=e.match(/^https?:\/\/github\.com\/([^/]+)\/([^/]+)\/(blob|tree)\/([^/]+)\/(.*)$/);if(t){const[,n,o,,s,a]=t;return`https://raw.githubusercontent.com/${n}/${o}/${s}/${a}`}return e.includes("gitlab.com")||e.includes("gitlab.")?e.replace("/-/tree/","/-/raw/").replace("/-/blob/","/-/raw/"):e.includes("bitbucket.org")?e.replace("/src/","/raw/"):e.includes("codeberg.org")||e.includes("gitea.")?e.replace("/src/branch/","/raw/branch/"):e}function Bp(e){try{return new URL(e).pathname.toLowerCase().endsWith(".json")}catch{return!1}}function Up(e){if(e.startsWith("s3://"))return"s3";if(e.startsWith("gs://"))return"gcs";try{const n=new URL(e).hostname.toLowerCase();return n.endsWith(".s3.amazonaws.com")||n.includes(".s3.")&&n.endsWith(".amazonaws.com")||n==="s3.amazonaws.com"?"s3":n==="storage.googleapis.com"||n==="storage.cloud.google.com"||n.endsWith(".storage.googleapis.com")?"gcs":n.endsWith(".r2.cloudflarestorage.com")||n.endsWith(".r2.dev")?"r2":n==="www.dropbox.com"||n==="dropbox.com"||n==="dl.dropboxusercontent.com"?"dropbox":null}catch{return null}}function Wp(e){try{const n=new URL(e).searchParams;return!!(n.has("X-Amz-Signature")||n.has("Signature")||n.has("X-Goog-Signature")||n.has("Signature")||n.has("token")||n.has("sig")||n.has("signature"))}catch{return!1}}function Hp(e){if(Wp(e))return e;if(e.startsWith("s3://")){const t=e.match(/^s3:\/\/([^/]+)\/?(.*)?$/);if(t){const[,n,o]=t;return`https://${n}.s3.amazonaws.com/${o||""}`}}if(e.startsWith("gs://")){const t=e.match(/^gs:\/\/([^/]+)\/?(.*)?$/);if(t){const[,n,o]=t;return`https://storage.googleapis.com/${n}/${o||""}`}}try{const t=new URL(e);if(t.hostname==="console.cloud.google.com"&&t.pathname.startsWith("/storage/browser/"))return`https://storage.googleapis.com/${t.pathname.replace("/storage/browser/","")}`;if(t.hostname==="storage.cloud.google.com")return`https://storage.googleapis.com${t.pathname}`;if(t.hostname==="www.dropbox.com"||t.hostname==="dropbox.com"){const n=new URLSearchParams(t.search);n.delete("dl");const o=n.toString();return`https://dl.dropboxusercontent.com${t.pathname+(o?`?${o}`:"")}`}}catch{}return e}function Zp(e){switch(e){case"s3":return`AWS S3 CORS Configuration:
1. Go to your S3 bucket in the AWS Console
2. Navigate to Permissions â†’ CORS configuration
3. Add a CORS rule allowing your origin:
   [
     {
       "AllowedOrigins": ["*"],
       "AllowedMethods": ["GET", "HEAD"],
       "AllowedHeaders": ["*"],
       "ExposeHeaders": ["Content-Length", "Content-Type"],
       "MaxAgeSeconds": 3600
     }
   ]
4. Save the configuration`;case"gcs":return`Google Cloud Storage CORS Configuration:
1. Create a cors.json file:
   [
     {
       "origin": ["*"],
       "method": ["GET", "HEAD"],
       "responseHeader": ["Content-Type", "Content-Length"],
       "maxAgeSeconds": 3600
     }
   ]
2. Apply using gsutil:
   gsutil cors set cors.json gs://YOUR_BUCKET_NAME`;case"r2":return`Cloudflare R2 CORS Configuration:
1. Go to your R2 bucket in Cloudflare Dashboard
2. Navigate to Settings â†’ CORS Policy
3. Add a CORS rule:
   - Allowed Origins: * (or your specific domain)
   - Allowed Methods: GET, HEAD
   - Allowed Headers: *
   - Max Age: 3600
4. Save the configuration`;case"dropbox":return`Dropbox Sharing Setup:
1. Right-click the file/folder in Dropbox
2. Select "Share" â†’ "Copy link"
3. Ensure link access is set to "Anyone with the link"

Note: Dropbox automatically handles CORS for shared links.
If you're getting errors, ensure:
- The file is shared publicly (not restricted)
- The link hasn't expired
- You're using a file link, not a folder link`}}function Ol(e,t){const n=Xu(e,t);if(n.type==="cors"&&t){const o=Up(t);if(o){const s=Zp(o);n.details=`This ${o.toUpperCase()} bucket does not allow cross-origin requests.

${s}`}}return n}const Cr=2*1024*1024*1024,Vp=5e3;let $l=!1;function Gp(e){try{return new URL(e).pathname.toLowerCase().endsWith(".zip")}catch{return e.toLowerCase().endsWith(".zip")}}function Yp(e){return e.name.toLowerCase().endsWith(".zip")||e.type==="application/zip"}async function Ku(){$l||(Qt.init({workerUrl:bo("workers/worker-bundle.js")}),$l=!0)}async function qp(e){try{const t=new AbortController,n=setTimeout(()=>t.abort(),Vp),o=await fetch(e,{method:"HEAD",signal:t.signal});if(clearTimeout(n),!o.ok)return{valid:!1,error:`Failed to access ZIP file (${o.status})`};const s=o.headers.get("content-length");if(!s)return{valid:!0};const a=parseInt(s,10);if(a>Cr){const i=(a/1048576).toFixed(1),l=(Cr/(1024*1024)).toFixed(0);return{valid:!1,size:a,error:`ZIP file exceeds ${l}MB limit (actual: ${i}MB)`}}return{valid:!0,size:a}}catch(t){return t instanceof Error&&t.name==="AbortError"?{valid:!1,error:"Size check timed out"}:{valid:!0}}}function Xp(e){if(e.size>Cr){const t=(e.size/1048576).toFixed(1),n=(Cr/(1024*1024)).toFixed(0);return{valid:!1,size:e.size,error:`ZIP file exceeds ${n}MB limit (actual: ${t}MB)`}}return{valid:!0,size:e.size}}const Kp=[".jpg",".jpeg",".png",".gif",".bmp",".webp",".tiff",".tif"];function Qp(e){const t=e.toLowerCase();return Kp.some(n=>t.endsWith(n))}function Jp(e){const t=e.split("/").pop()?.toLowerCase()??"";return t==="cameras.bin"||t==="cameras.txt"||t==="images.bin"||t==="images.txt"||t==="points3d.bin"||t==="points3d.txt"||t==="rigs.bin"||t==="rigs.txt"||t==="frames.bin"||t==="frames.txt"}async function eg(e,t){t({percent:2,message:"Starting download..."});const n=await Yi(e,12e4);if(!n.ok)throw new Error(`Failed to download ZIP (${n.status})`);const o=n.headers.get("content-length"),s=o?parseInt(o,10):0;if(!n.body)return await n.blob();const a=n.body.getReader(),i=[];let l=0;for(;;){const{done:f,value:p}=await a.read();if(f)break;if(i.push(new Uint8Array(p)),l+=p.length,s>0){const g=2+Math.round(l/s*38),y=(l/(1024*1024)).toFixed(1),v=(s/(1024*1024)).toFixed(1);t({percent:g,message:`Downloading ZIP (${y} / ${v} MB)...`,bytesLoaded:l,bytesTotal:s})}else{const g=(l/1048576).toFixed(1);t({percent:20,message:`Downloading ZIP (${g} MB)...`,bytesLoaded:l})}}const c=i.reduce((f,p)=>f+p.length,0),d=new Uint8Array(c);let u=0;for(const f of i)d.set(f,u),u+=f.length;return new Blob([d])}async function Qu(e,t){t({percent:50,message:"Reading archive contents..."});const n=await e.getFilesArray();t({percent:55,message:"Identifying COLMAP files..."});const o=[],s=new Map;let a=0;for(const l of n){let c;if(l.path?c=`${l.path.endsWith("/")?l.path:`${l.path}/`}${l.file.name}`:c=l.file.name,Jp(c))o.push({file:l.file,path:c});else if(Qp(c)){s.set(c,l.file),a++;const d=c.split("/").pop()??c;s.has(d)||s.set(d,l.file)}}t({percent:60,message:`Extracting ${o.length} COLMAP files...`});const i=new Map;for(let l=0;l<o.length;l++){const c=o[l],d=await c.file.extract();let u=c.path;const f=c.path.split("/").pop()??c.path;if(c.path.includes("sparse/")){const g=c.path.match(/(sparse\/\d+\/[^/]+)$/);g?u=g[1]:u=`sparse/0/${f}`}else u=`sparse/0/${f}`;i.set(u,d);const p=60+Math.round((l+1)/o.length*10);t({percent:p,message:`Extracting ${f}...`})}return t({percent:70,message:`Indexed ${a} images for lazy loading`}),{colmapFiles:i,imageIndex:s,imageCount:a}}async function tg(e,t){await Ku(),t({percent:0,message:"Checking ZIP file..."});const n=await qp(e);if(!n.valid)throw new Error(n.error??"Invalid ZIP file");const o=await eg(e,t);if(o.size>Cr){const u=(o.size/1048576).toFixed(1);throw new Error(`Downloaded ZIP exceeds size limit (${u}MB)`)}t({percent:40,message:"Opening archive..."});const s=new File([o],"archive.zip",{type:"application/zip"}),a=await Qt.open(s),{colmapFiles:i,imageIndex:l,imageCount:c}=await Qu(a,t);if(!((i.has("sparse/0/cameras.bin")||i.has("sparse/0/cameras.txt"))&&(i.has("sparse/0/images.bin")||i.has("sparse/0/images.txt"))&&(i.has("sparse/0/points3d.bin")||i.has("sparse/0/points3D.txt")))){let u=!1,f=!1,p=!1;for(const g of i.keys()){const y=g.toLowerCase();y.includes("cameras.")&&(u=!0),y.includes("images.")&&(f=!0),y.includes("points3d.")&&(p=!0)}if(!u||!f||!p)throw new Error("ZIP does not contain valid COLMAP files (cameras.bin, images.bin, points3D.bin)")}return{colmapFiles:i,imageIndex:l,archive:a,fileSize:o.size,imageCount:c}}async function ng(e,t){await Ku(),t({percent:0,message:"Checking ZIP file..."});const n=Xp(e);if(!n.valid)throw new Error(n.error??"Invalid ZIP file");t({percent:40,message:"Opening archive..."});const o=await Qt.open(e),{colmapFiles:s,imageIndex:a,imageCount:i}=await Qu(o,t);let l=!1,c=!1,d=!1;for(const u of s.keys()){const f=u.toLowerCase();f.includes("cameras.")&&(l=!0),f.includes("images.")&&(c=!0),f.includes("points3d.")&&(d=!0)}if(!l||!c||!d)throw new Error("ZIP does not contain valid COLMAP files (cameras.bin, images.bin, points3D.bin)");return{colmapFiles:s,imageIndex:a,archive:o,fileSize:e.size,imageCount:i}}let Vs=null,Go=null,Ma=0,Ea=0;function Ju(e,t,n=0,o=0){ed(),Vs=e,Go=t,Ma=n,Ea=o}function og(){return Go}function Pa(){return Vs!==null&&Go!==null}function ed(){Vs=null,Go=null,Ma=0,Ea=0}function td(){return{fileSize:Ma,imageCount:Ea}}function nd(e,t){const n=e.replace(/\\/g,"/");if(t.has(n))return t.get(n);const o=n.toLowerCase();for(const[i,l]of t.entries())if(i.toLowerCase()===o)return l;const s=n.split("/").pop()??n;if(t.has(s))return t.get(s);const a=["images/","sparse/0/",""];for(const i of a){const l=`${i}${n}`;if(t.has(l))return t.get(l)}return null}async function rg(e){if(!Vs||!Go)return null;const t=nd(e,Go);if(!t)return null;try{return await t.extract()}catch(n){return console.warn(`[ZIP] Failed to extract ${e}:`,n),null}}const sg=[".jpg",".jpeg",".png",".gif",".bmp",".webp",".tiff",".tif"];function ig(e){const t=e.toLowerCase();return sg.some(n=>t.endsWith(n))}function ag(e){const t=e.split("/"),n=[];for(let o=0;o<t.length;o++)n.push(t.slice(o).join("/"));return n}function lg(e){for(const t of e.keys()){const n=t.replace(/\\/g,"/").toLowerCase();if(n.includes("/masks/")||n.startsWith("masks/"))return!0}return!1}function cg(e){const t=new Map;for(const[n,o]of e){if(!ig(n))continue;const s=n.replace(/\\/g,"/"),a=ag(s);for(const i of a){t.has(i)||t.set(i,o);const l=i.toLowerCase();t.has(l)||t.set(l,o)}}return t}function ao(e,t){if(!e||!t)return;const n=t.replace(/\\/g,"/"),o=e.get(n);return o||e.get(n.toLowerCase())}const Bl=.75,Ul=2048,Co=new Map,vs=new Set,mo=new Map;function ug(){const e=typeof window<"u"?Math.min(window.devicePixelRatio||1,2):1,t=typeof screen<"u"?screen.width:1920,n=typeof screen<"u"?screen.height:1080;return{maxWidth:Math.min(Math.round(t*e),Ul),maxHeight:Math.min(Math.round(n*e),Ul)}}async function od(e,t){try{const n=await createImageBitmap(e),{maxWidth:o,maxHeight:s}=ug();let a=n.width,i=n.height;if(n.width>o||n.height>s){const f=Math.min(o/n.width,s/n.height);a=Math.round(n.width*f),i=Math.round(n.height*f)}let l,c;if(typeof OffscreenCanvas<"u"?(l=new OffscreenCanvas(a,i),c=l.getContext("2d")):(l=document.createElement("canvas"),l.width=a,l.height=i,c=l.getContext("2d")),!c)return n.close(),new File([e],t,{type:e.type||"image/png"});c.drawImage(n,0,0,a,i),n.close();let d;l instanceof OffscreenCanvas?d=await l.convertToBlob({type:"image/jpeg",quality:Bl}):d=await new Promise((f,p)=>{l.toBlob(g=>g?f(g):p(new Error("Failed to create blob")),"image/jpeg",Bl)});const u=t.replace(/\.[^.]+$/,".jpg");return new File([d],u,{type:"image/jpeg"})}catch(n){return console.warn("[URL Image] Compression failed, using original:",n),new File([e],t,{type:e.type||"application/octet-stream"})}}function dg(){Co.clear(),vs.clear(),mo.clear()}function mn(e){return Co.get(e)}async function er(e,t){const n=Co.get(t);if(n)return n;let o=t.replace(/\\/g,"/");const s=e.toLowerCase(),a=o.toLowerCase();s.endsWith("/images/")&&a.startsWith("images/")&&(o=o.slice(7));const i=e.endsWith("/")?`${e}${o}`:`${e}/${o}`;if(console.log(`[URL Image] Fetching: ${i}`),vs.has(i))return new Promise(l=>{const c=mo.get(i)||[];c.push(l),mo.set(i,c)});vs.add(i);try{const l=await fetch(i);if(!l.ok)return console.warn(`[URL Image] Failed to fetch ${t}: ${l.status}`),null;const c=await l.blob(),d=o.split("/").pop()||o,u=await od(c,d);Co.set(t,u);const f=mo.get(i)||[];for(const p of f)p(u);return mo.delete(i),u}catch(l){console.warn(`[URL Image] Error fetching ${t}:`,l);const c=mo.get(i)||[];for(const d of c)d(null);return mo.delete(i),null}finally{vs.delete(i)}}async function rd(e,t){let n=t.replace(/\\/g,"/");const o=e.toLowerCase(),s=n.toLowerCase();o.endsWith("/masks/")&&s.startsWith("masks/")&&(n=n.slice(6)),n.toLowerCase().startsWith("images/")&&(n=n.slice(7));const a=e.endsWith("/")?e:`${e}/`,i=[n,`${n}.png`];for(const l of i){const c=`${a}${l}`;console.log(`[URL Mask] Trying: ${c}`);try{const d=await fetch(c);if(d.ok){const u=await d.blob(),f=l.split("/").pop()||l;return console.log(`[URL Mask] Found mask for ${t}`),new File([u],f,{type:u.type||"image/png"})}}catch(d){console.debug(`[URL Mask] Error trying ${c}:`,d)}}return console.debug(`[URL Mask] No mask found for ${t}`),null}async function fg(e,t,n=5){const o=t.filter(s=>!Co.has(s));if(o.length!==0)for(let s=0;s<o.length;s+=n){const a=o.slice(s,s+n);await Promise.all(a.map(i=>er(e,i)))}}function hg(e,t){const n=[];for(const o of e.values())ao(t,o.name)||n.push({imageId:o.imageId,name:o.name});return{missingImages:n,totalImages:e.size,totalFiles:t.size}}function qi(e,t){if(!e||!t)return;const n=t.replace(/\\/g,"/"),o=n.replace(/\/images\//i,"/masks/").replace(/^images\//i,"masks/"),s=o!==n,i=`masks/${n.replace(/^images\//i,"")}`,c=`masks/${n.split("/").pop()||""}`,d=[];s&&d.push(o,`${o}.png`),d.push(i,`${i}.png`),c!==i&&d.push(c,`${c}.png`);for(const u of d){const f=e.get(u)||e.get(u.toLowerCase());if(f)return f}}const Yo=new Map,kr=new Map,ws=new Set,Zn=new Map;function un(e){return Yo.get(e)}function Zt(){return Pa()}async function qo(e){const t=Yo.get(e);if(t)return t;if(!Pa())return null;if(ws.has(e))return new Promise(n=>{const o=Zn.get(e)||[];o.push(n),Zn.set(e,o)});ws.add(e);try{const n=await rg(e);if(!n){const i=Zn.get(e)||[];for(const l of i)l(null);return Zn.delete(e),null}const o=e.split("/").pop()||e,s=await od(new Blob([await n.arrayBuffer()]),o);Yo.set(e,s);const a=Zn.get(e)||[];for(const i of a)i(s);return Zn.delete(e),s}catch(n){console.warn(`[ZIP Image] Error extracting ${e}:`,n);const o=Zn.get(e)||[];for(const s of o)s(null);return Zn.delete(e),null}finally{ws.delete(e)}}function mg(e){const t=e.replace(/\\/g,"/");let n=t;return t.toLowerCase().startsWith("images/")&&(n=t.slice(7)),[`masks/${n}`,`masks/${n}.png`,`masks/${n.split("/").pop()||n}`,`masks/${n.split("/").pop()||n}.png`]}async function sd(e){const t=kr.get(e);if(t)return t;if(!Pa())return null;const n=og();if(!n)return null;const o=mg(e);for(const s of o){const a=nd(s,n);if(a)try{const i=await a.extract();return kr.set(e,i),console.log(`[ZIP Mask] Found mask for ${e}`),i}catch(i){console.debug(`[ZIP Mask] Error extracting ${s}:`,i)}}return console.debug(`[ZIP Mask] No mask found for ${e}`),null}function pg(){Yo.clear(),kr.clear(),ws.clear(),Zn.clear(),ed()}function La(e){let t=0;for(const n of e.values())t+=n.size;return t}function id(){return{count:Co.size,sizeBytes:La(Co)}}function ad(){return{count:Yo.size,sizeBytes:La(Yo)}}function ld(){return{count:kr.size,sizeBytes:La(kr)}}function gg(e){if(!e)return{count:0,sizeBytes:0};const t=new Set;for(const o of e.values())t.add(o);let n=0;for(const o of t)n+=o.size;return{count:t.size,sizeBytes:n}}let Wl=!1;function xg(){Wl||(Wl=!0,Kt.register({name:"frustumTextures",label:"Frustum Textures",priority:dn.TEXTURE,clear:Ip,getStats:()=>{const e=Hi();return{count:e.textures,sizeBytes:e.textures*65e3}},strategy:"lazy",memoryType:"js",showInStats:!0}),Kt.register({name:"frustumBitmaps",label:"Decoded Bitmaps",priority:dn.BITMAP,clear:()=>{},getStats:()=>{const e=Hi();return{count:e.bitmaps,sizeBytes:e.bitmaps*65e3}},strategy:"lazy",memoryType:"js",showInStats:!0}),Kt.register({name:"thumbnails",label:"Thumbnails",priority:dn.BLOB_URL,clear:Np,getStats:()=>{const e=$u();return{count:e.count,sizeBytes:e.count*75e3}},strategy:"lazy",memoryType:"js",showInStats:!0}),Kt.register({name:"sharedDecode",label:"Shared Decode",priority:dn.FILE_CACHE,clear:vp}),Kt.register({name:"urlImages",label:"URL Images",priority:dn.FILE_CACHE,clear:dg,getStats:id,strategy:"lazy",memoryType:"js",showInStats:!0}),Kt.register({name:"zipImages",label:"ZIP Images",priority:dn.FILE_CACHE,clear:()=>{},getStats:ad,strategy:"lazy",memoryType:"js",showInStats:!0}),Kt.register({name:"zipMasks",label:"ZIP Masks",priority:dn.FILE_CACHE,clear:()=>{},getStats:ld,strategy:"lazy",memoryType:"js",showInStats:!0}),Kt.register({name:"floorPlaneStore",label:"Floor Plane Store",priority:dn.STORE_STATE,clear:()=>{Ge.getState().reset()}}),Kt.register({name:"pointPickingStore",label:"Point Picking Store",priority:dn.STORE_STATE,clear:()=>{Ve.getState().reset()}}),Kt.register({name:"cameraStoreNavigation",label:"Camera Navigation",priority:dn.STORE_STATE,clear:()=>{const e=B.getState();e.setSelectedImageId(null),e.clearNavigationHistory()}}),Kt.register({name:"uiStoreImageDetail",label:"UI Image Detail",priority:dn.STORE_STATE,clear:()=>{q.getState().closeImageDetail()}}),Kt.register({name:"zipCache",label:"ZIP Archive",priority:dn.ARCHIVE,clear:pg,getStats:()=>{const e=td();return{count:e.imageCount,sizeBytes:e.fileSize}},strategy:"memory",memoryType:"js",showInStats:!0}),console.log(`[CacheManager] Registered ${Kt.getRegisteredNames().length} caches`))}function yg(){return Kt.getStatsEntries()}function Tn(e){Kt.clearAll(e??{})}function cd(e){const{reconstruction:t,wasmReconstruction:n}=ye.getState();if(!t)return!1;const o=Lt.getState(),s=o.transform;if(!jo(s)){const i=zn(s),l=Fu(i,t,n),c=kl(l),d=Uo(c,i);o.setTransform(Bo(d))}else{const i=kl(t);o.setTransform(Bo(i))}return!0}function Sr(){const e=ye.getState(),{reconstruction:t,wasmReconstruction:n}=e;if(!t)return!1;const o=Lt.getState(),{transform:s}=o,a=zn(s),i=Fu(a,t,n);return n&&e.setWasmReconstruction(null),e.setReconstruction(i),o.resetTransform(),!0}const ud=1;const vg={key:"pointCloud",storeHook:"usePointCloudStore",properties:[{key:"showPointCloud",type:"boolean",default:!0,persist:!0,description:"Show point cloud"},{key:"pointSize",type:"number",min:.1,max:50,default:2,persist:!0,description:"Point size (0.1 - 50)"},{key:"pointOpacity",type:"number",min:0,max:1,default:1,persist:!0,description:"Point opacity (0 - 1)"},{key:"colorMode",type:"enum",enumValues:im,default:"rgb",persist:!0,description:"rgb | error | trackLength"},{key:"minTrackLength",type:"number",min:1,isInt:!0,default:2,persist:!0,description:"Minimum observations for a point"},{key:"maxReprojectionError",type:"number",min:0,nullable:!0,default:null,persist:!0,description:"null = show all points"}]},wg={key:"camera",storeHook:"useCameraStore",properties:[{key:"show",storeKey:"showCameras",type:"boolean",default:!0,persist:!0,description:"Show/hide camera frustums"},{key:"displayMode",storeKey:"cameraDisplayMode",type:"enum",enumValues:gs,default:"frustum",persist:!0,description:"frustum | arrow | imageplane"},{key:"scaleFactor",storeKey:"cameraScaleFactor",type:"enum",enumValues:lm,default:"1",persist:!0,description:"0.1 | 1 | 10"},{key:"scale",storeKey:"cameraScale",type:"number",min:.01,max:10,default:.25,persist:!0,description:"Frustum size multiplier (0.01 - 10)"},{key:"frustumColorMode",type:"enum",enumValues:am,default:"byCamera",persist:!0,description:"single | byCamera | byRigFrame"},{key:"unselectedOpacity",storeKey:"unselectedCameraOpacity",type:"number",min:.1,max:.6,default:.5,persist:!0,description:"Opacity of non-selected cameras (0.1 - 0.6)"},{key:"mode",storeKey:"cameraMode",type:"enum",enumValues:fs,default:"orbit",persist:!0,description:"orbit | fly"},{key:"projection",storeKey:"cameraProjection",type:"enum",enumValues:hs,default:"perspective",persist:!0,description:"perspective | orthographic"},{key:"fov",storeKey:"cameraFov",type:"number",min:10,max:120,default:60,persist:!0,description:"Field of view (10 - 120)"},{key:"horizonLock",type:"enum",enumValues:ps,default:"off",persist:!0,description:"off | on | flip"},{key:"autoRotateMode",type:"enum",enumValues:ms,default:"off",persist:!0,description:"off | cw | ccw"},{key:"autoRotateSpeed",type:"number",min:.1,max:2,default:.5,persist:!0,description:"Auto-rotate speed in radians per second (0.1 - 2)"},{key:"flySpeed",type:"number",min:.1,max:50,default:2.5,persist:!0,description:"Flying speed (0.1 - 50)"},{key:"flyTransitionDuration",type:"number",min:0,max:2e3,default:600,persist:!0,description:"Fly-to animation duration in ms (0 = instant)"},{key:"pointerLock",type:"boolean",default:!0,persist:!0},{key:"showSelectionHighlight",type:"boolean",default:!0,persist:!0,description:"Show/hide selection point highlighting"},{key:"selectionColorMode",type:"enum",enumValues:xs,default:"rainbow",persist:!0,description:"static | blink | rainbow"},{key:"selectionColor",type:"string",pattern:/^#[0-9A-Fa-f]{6}$/,patternDesc:"hex color (#RRGGBB)",default:"#00ff00",persist:!0,description:"Hex color for static selection mode"},{key:"selectionAnimationSpeed",type:"number",min:.1,max:10,default:2,persist:!0},{key:"selectionPlaneOpacity",type:"number",min:0,max:1,default:1,persist:!0},{key:"undistortionEnabled",type:"boolean",default:!1,persist:!0,description:"Apply lens undistortion to frustum images"},{key:"undistortionMode",type:"enum",enumValues:cm,default:"fullFrame",persist:!0,description:"cropped | fullFrame"},{key:"flyToImageId",type:"number",default:0,persist:!1,transient:!0},{key:"selectedImageId",type:"number",default:0,persist:!1,transient:!0}]},bg={key:"ui",storeHook:"useUIStore",properties:[{key:"showPoints2D",type:"boolean",default:!1,persist:!0},{key:"showPoints3D",type:"boolean",default:!1,persist:!0},{key:"backgroundColor",type:"string",pattern:/^#[0-9A-Fa-f]{6}$/,patternDesc:"hex color (#RRGGBB)",default:"#ffffff",persist:!0},{key:"showMatches",type:"boolean",default:!1,persist:!0,description:"Show/hide match lines"},{key:"matchesDisplayMode",type:"enum",enumValues:um,default:"on",persist:!0,description:"on | blink"},{key:"matchesOpacity",type:"number",min:0,max:1,default:.75,persist:!0},{key:"matchesColor",type:"string",pattern:/^#[0-9A-Fa-f]{6}$/,patternDesc:"hex color (#RRGGBB)",default:"#ff00ff",persist:!0,description:"Hex color for matches visualization"},{key:"maskOverlay",storeKey:"showMaskOverlay",type:"boolean",default:!1,persist:!0},{key:"maskOpacity",type:"number",min:0,max:1,default:.7,persist:!0},{key:"showAxes",type:"boolean",default:!0,persist:!0,description:"Show origin axes"},{key:"showGrid",type:"boolean",default:!0,persist:!0,description:"Show grid plane"},{key:"axesCoordinateSystem",type:"enum",enumValues:dm,default:"colmap",persist:!0,description:"colmap | opencv | threejs | opengl | vulkan | blender | houdini | unity | unreal"},{key:"axesScale",type:"number",min:.1,max:100,default:1,persist:!0},{key:"gridScale",type:"number",min:.1,max:100,default:1,persist:!0,description:"Grid size multiplier (0.1 - 100)"},{key:"axisLabelMode",type:"enum",enumValues:fm,default:"extra",persist:!0,description:"off | xyz | extra"},{key:"showGizmo",type:"boolean",default:!1,persist:!0,description:"Show transform gizmo"},{key:"galleryCollapsed",type:"boolean",default:!1,persist:!0,description:"Start with gallery panel collapsed"},{key:"imageDetailId",type:"number",default:0,persist:!1,transient:!0},{key:"showMatchesInModal",type:"boolean",default:!1,persist:!1,transient:!0},{key:"matchedImageId",type:"number",default:0,persist:!1,transient:!0},{key:"viewResetTrigger",type:"number",default:0,persist:!1,transient:!0},{key:"viewDirection",type:"string",default:"",persist:!1,transient:!0},{key:"viewTrigger",type:"number",default:0,persist:!1,transient:!0}]},Cg=["text","binary","ply"],kg={key:"export",storeHook:"useExportStore",properties:[{key:"screenshotSize",type:"enum",enumValues:hm,default:"current",persist:!0,description:"current | 1920x1080 | 1280x720 | 3840x2160 | 1024x1024 | 512x512 | 2048x2048"},{key:"screenshotFormat",type:"enum",enumValues:mm,default:"jpeg",persist:!0,description:"jpeg | png | webp"},{key:"screenshotHideLogo",type:"boolean",default:!1,persist:!0},{key:"modelFormat",storeKey:"exportFormat",type:"enum",enumValues:Cg,default:"binary",persist:!0,description:"text | binary | ply"},{key:"screenshotTrigger",type:"number",default:0,persist:!1,transient:!0},{key:"exportTrigger",type:"number",default:0,persist:!1,transient:!0}]},_a=[vg,wg,bg,kg];function Aa(e){return e.properties.filter(t=>t.persist&&!t.transient)}function dd(e){return e.storeKey??e.key}function X(e,t,n){function o(l,c){if(l._zod||Object.defineProperty(l,"_zod",{value:{def:c,constr:i,traits:new Set},enumerable:!1}),l._zod.traits.has(e))return;l._zod.traits.add(e),t(l,c);const d=i.prototype,u=Object.keys(d);for(let f=0;f<u.length;f++){const p=u[f];p in l||(l[p]=d[p].bind(l))}}const s=n?.Parent??Object;class a extends s{}Object.defineProperty(a,"name",{value:e});function i(l){var c;const d=n?.Parent?new a:this;o(d,l),(c=d._zod).deferred??(c.deferred=[]);for(const u of d._zod.deferred)u();return d}return Object.defineProperty(i,"init",{value:o}),Object.defineProperty(i,Symbol.hasInstance,{value:l=>n?.Parent&&l instanceof n.Parent?!0:l?._zod?.traits?.has(e)}),Object.defineProperty(i,"name",{value:e}),i}class Wo extends Error{constructor(){super("Encountered Promise during synchronous parse. Use .parseAsync() instead.")}}class fd extends Error{constructor(t){super(`Encountered unidirectional transform during encode: ${t}`),this.name="ZodEncodeError"}}const hd={};function ko(e){return hd}function md(e){const t=Object.values(e).filter(o=>typeof o=="number");return Object.entries(e).filter(([o,s])=>t.indexOf(+o)===-1).map(([o,s])=>s)}function Xi(e,t){return typeof t=="bigint"?t.toString():t}function Na(e){return{get value(){{const t=e();return Object.defineProperty(this,"value",{value:t}),t}}}}function Ra(e){return e==null}function Fa(e){const t=e.startsWith("^")?1:0,n=e.endsWith("$")?e.length-1:e.length;return e.slice(t,n)}function Sg(e,t){const n=(e.toString().split(".")[1]||"").length,o=t.toString();let s=(o.split(".")[1]||"").length;if(s===0&&/\d?e-\d?/.test(o)){const c=o.match(/\d?e-(\d?)/);c?.[1]&&(s=Number.parseInt(c[1]))}const a=n>s?n:s,i=Number.parseInt(e.toFixed(a).replace(".","")),l=Number.parseInt(t.toFixed(a).replace(".",""));return i%l/10**a}const Hl=Symbol("evaluating");function ot(e,t,n){let o;Object.defineProperty(e,t,{get(){if(o!==Hl)return o===void 0&&(o=Hl,o=n()),o},set(s){Object.defineProperty(e,t,{value:s})},configurable:!0})}function Io(e,t,n){Object.defineProperty(e,t,{value:n,writable:!0,enumerable:!0,configurable:!0})}function co(...e){const t={};for(const n of e){const o=Object.getOwnPropertyDescriptors(n);Object.assign(t,o)}return Object.defineProperties({},t)}function Zl(e){return JSON.stringify(e)}function jg(e){return e.toLowerCase().trim().replace(/[^\w\s-]/g,"").replace(/[\s_-]+/g,"-").replace(/^-+|-+$/g,"")}const pd="captureStackTrace"in Error?Error.captureStackTrace:(...e)=>{};function Ls(e){return typeof e=="object"&&e!==null&&!Array.isArray(e)}const Ig=Na(()=>{if(typeof navigator<"u"&&navigator?.userAgent?.includes("Cloudflare"))return!1;try{const e=Function;return new e(""),!0}catch{return!1}});function jr(e){if(Ls(e)===!1)return!1;const t=e.constructor;if(t===void 0||typeof t!="function")return!0;const n=t.prototype;return!(Ls(n)===!1||Object.prototype.hasOwnProperty.call(n,"isPrototypeOf")===!1)}function gd(e){return jr(e)?{...e}:Array.isArray(e)?[...e]:e}const Mg=new Set(["string","number","symbol"]);function Gs(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function uo(e,t,n){const o=new e._zod.constr(t??e._zod.def);return(!t||n?.parent)&&(o._zod.parent=e),o}function Me(e){const t=e;if(!t)return{};if(typeof t=="string")return{error:()=>t};if(t?.message!==void 0){if(t?.error!==void 0)throw new Error("Cannot specify both `message` and `error` params");t.error=t.message}return delete t.message,typeof t.error=="string"?{...t,error:()=>t.error}:t}function Eg(e){return Object.keys(e).filter(t=>e[t]._zod.optin==="optional"&&e[t]._zod.optout==="optional")}const Pg={safeint:[Number.MIN_SAFE_INTEGER,Number.MAX_SAFE_INTEGER],int32:[-2147483648,2147483647],uint32:[0,4294967295],float32:[-34028234663852886e22,34028234663852886e22],float64:[-Number.MAX_VALUE,Number.MAX_VALUE]};function Lg(e,t){const n=e._zod.def,o=n.checks;if(o&&o.length>0)throw new Error(".pick() cannot be used on object schemas containing refinements");const a=co(e._zod.def,{get shape(){const i={};for(const l in t){if(!(l in n.shape))throw new Error(`Unrecognized key: "${l}"`);t[l]&&(i[l]=n.shape[l])}return Io(this,"shape",i),i},checks:[]});return uo(e,a)}function _g(e,t){const n=e._zod.def,o=n.checks;if(o&&o.length>0)throw new Error(".omit() cannot be used on object schemas containing refinements");const a=co(e._zod.def,{get shape(){const i={...e._zod.def.shape};for(const l in t){if(!(l in n.shape))throw new Error(`Unrecognized key: "${l}"`);t[l]&&delete i[l]}return Io(this,"shape",i),i},checks:[]});return uo(e,a)}function Ag(e,t){if(!jr(t))throw new Error("Invalid input to extend: expected a plain object");const n=e._zod.def.checks;if(n&&n.length>0){const a=e._zod.def.shape;for(const i in t)if(Object.getOwnPropertyDescriptor(a,i)!==void 0)throw new Error("Cannot overwrite keys on object schemas containing refinements. Use `.safeExtend()` instead.")}const s=co(e._zod.def,{get shape(){const a={...e._zod.def.shape,...t};return Io(this,"shape",a),a}});return uo(e,s)}function Ng(e,t){if(!jr(t))throw new Error("Invalid input to safeExtend: expected a plain object");const n=co(e._zod.def,{get shape(){const o={...e._zod.def.shape,...t};return Io(this,"shape",o),o}});return uo(e,n)}function Rg(e,t){const n=co(e._zod.def,{get shape(){const o={...e._zod.def.shape,...t._zod.def.shape};return Io(this,"shape",o),o},get catchall(){return t._zod.def.catchall},checks:[]});return uo(e,n)}function Fg(e,t,n){const s=t._zod.def.checks;if(s&&s.length>0)throw new Error(".partial() cannot be used on object schemas containing refinements");const i=co(t._zod.def,{get shape(){const l=t._zod.def.shape,c={...l};if(n)for(const d in n){if(!(d in l))throw new Error(`Unrecognized key: "${d}"`);n[d]&&(c[d]=e?new e({type:"optional",innerType:l[d]}):l[d])}else for(const d in l)c[d]=e?new e({type:"optional",innerType:l[d]}):l[d];return Io(this,"shape",c),c},checks:[]});return uo(t,i)}function Tg(e,t,n){const o=co(t._zod.def,{get shape(){const s=t._zod.def.shape,a={...s};if(n)for(const i in n){if(!(i in a))throw new Error(`Unrecognized key: "${i}"`);n[i]&&(a[i]=new e({type:"nonoptional",innerType:s[i]}))}else for(const i in s)a[i]=new e({type:"nonoptional",innerType:s[i]});return Io(this,"shape",a),a}});return uo(t,o)}function Do(e,t=0){if(e.aborted===!0)return!0;for(let n=t;n<e.issues.length;n++)if(e.issues[n]?.continue!==!0)return!0;return!1}function xd(e,t){return t.map(n=>{var o;return(o=n).path??(o.path=[]),n.path.unshift(e),n})}function Xr(e){return typeof e=="string"?e:e?.message}function So(e,t,n){const o={...e,path:e.path??[]};if(!e.message){const s=Xr(e.inst?._zod.def?.error?.(e))??Xr(t?.error?.(e))??Xr(n.customError?.(e))??Xr(n.localeError?.(e))??"Invalid input";o.message=s}return delete o.inst,delete o.continue,t?.reportInput||delete o.input,o}function Ta(e){return Array.isArray(e)?"array":typeof e=="string"?"string":"unknown"}function Ir(...e){const[t,n,o]=e;return typeof t=="string"?{message:t,code:"custom",input:n,inst:o}:{...t}}const yd=(e,t)=>{e.name="$ZodError",Object.defineProperty(e,"_zod",{value:e._zod,enumerable:!1}),Object.defineProperty(e,"issues",{value:t,enumerable:!1}),e.message=JSON.stringify(t,Xi,2),Object.defineProperty(e,"toString",{value:()=>e.message,enumerable:!1})},vd=X("$ZodError",yd),wd=X("$ZodError",yd,{Parent:Error});function Dg(e,t=n=>n.message){const n={},o=[];for(const s of e.issues)s.path.length>0?(n[s.path[0]]=n[s.path[0]]||[],n[s.path[0]].push(t(s))):o.push(t(s));return{formErrors:o,fieldErrors:n}}function zg(e,t=n=>n.message){const n={_errors:[]},o=s=>{for(const a of s.issues)if(a.code==="invalid_union"&&a.errors.length)a.errors.map(i=>o({issues:i}));else if(a.code==="invalid_key")o({issues:a.issues});else if(a.code==="invalid_element")o({issues:a.issues});else if(a.path.length===0)n._errors.push(t(a));else{let i=n,l=0;for(;l<a.path.length;){const c=a.path[l];l===a.path.length-1?(i[c]=i[c]||{_errors:[]},i[c]._errors.push(t(a))):i[c]=i[c]||{_errors:[]},i=i[c],l++}}};return o(e),n}const Da=e=>(t,n,o,s)=>{const a=o?Object.assign(o,{async:!1}):{async:!1},i=t._zod.run({value:n,issues:[]},a);if(i instanceof Promise)throw new Wo;if(i.issues.length){const l=new(s?.Err??e)(i.issues.map(c=>So(c,a,ko())));throw pd(l,s?.callee),l}return i.value},za=e=>async(t,n,o,s)=>{const a=o?Object.assign(o,{async:!0}):{async:!0};let i=t._zod.run({value:n,issues:[]},a);if(i instanceof Promise&&(i=await i),i.issues.length){const l=new(s?.Err??e)(i.issues.map(c=>So(c,a,ko())));throw pd(l,s?.callee),l}return i.value},Ys=e=>(t,n,o)=>{const s=o?{...o,async:!1}:{async:!1},a=t._zod.run({value:n,issues:[]},s);if(a instanceof Promise)throw new Wo;return a.issues.length?{success:!1,error:new(e??vd)(a.issues.map(i=>So(i,s,ko())))}:{success:!0,data:a.value}},Og=Ys(wd),qs=e=>async(t,n,o)=>{const s=o?Object.assign(o,{async:!0}):{async:!0};let a=t._zod.run({value:n,issues:[]},s);return a instanceof Promise&&(a=await a),a.issues.length?{success:!1,error:new e(a.issues.map(i=>So(i,s,ko())))}:{success:!0,data:a.value}},$g=qs(wd),Bg=e=>(t,n,o)=>{const s=o?Object.assign(o,{direction:"backward"}):{direction:"backward"};return Da(e)(t,n,s)},Ug=e=>(t,n,o)=>Da(e)(t,n,o),Wg=e=>async(t,n,o)=>{const s=o?Object.assign(o,{direction:"backward"}):{direction:"backward"};return za(e)(t,n,s)},Hg=e=>async(t,n,o)=>za(e)(t,n,o),Zg=e=>(t,n,o)=>{const s=o?Object.assign(o,{direction:"backward"}):{direction:"backward"};return Ys(e)(t,n,s)},Vg=e=>(t,n,o)=>Ys(e)(t,n,o),Gg=e=>async(t,n,o)=>{const s=o?Object.assign(o,{direction:"backward"}):{direction:"backward"};return qs(e)(t,n,s)},Yg=e=>async(t,n,o)=>qs(e)(t,n,o),qg=/^[cC][^\s-]{8,}$/,Xg=/^[0-9a-z]+$/,Kg=/^[0-9A-HJKMNP-TV-Za-hjkmnp-tv-z]{26}$/,Qg=/^[0-9a-vA-V]{20}$/,Jg=/^[A-Za-z0-9]{27}$/,ex=/^[a-zA-Z0-9_-]{21}$/,tx=/^P(?:(\d+W)|(?!.*W)(?=\d|T\d)(\d+Y)?(\d+M)?(\d+D)?(T(?=\d)(\d+H)?(\d+M)?(\d+([.,]\d+)?S)?)?)$/,nx=/^([0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12})$/,Vl=e=>e?new RegExp(`^([0-9a-fA-F]{8}-[0-9a-fA-F]{4}-${e}[0-9a-fA-F]{3}-[89abAB][0-9a-fA-F]{3}-[0-9a-fA-F]{12})$`):/^([0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[1-8][0-9a-fA-F]{3}-[89abAB][0-9a-fA-F]{3}-[0-9a-fA-F]{12}|00000000-0000-0000-0000-000000000000|ffffffff-ffff-ffff-ffff-ffffffffffff)$/,ox=/^(?!\.)(?!.*\.\.)([A-Za-z0-9_'+\-\.]*)[A-Za-z0-9_+-]@([A-Za-z0-9][A-Za-z0-9\-]*\.)+[A-Za-z]{2,}$/,rx="^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$";function sx(){return new RegExp(rx,"u")}const ix=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,ax=/^(([0-9a-fA-F]{1,4}:){7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:))$/,lx=/^((25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/([0-9]|[1-2][0-9]|3[0-2])$/,cx=/^(([0-9a-fA-F]{1,4}:){7}[0-9a-fA-F]{1,4}|::|([0-9a-fA-F]{1,4})?::([0-9a-fA-F]{1,4}:?){0,6})\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,ux=/^$|^(?:[0-9a-zA-Z+/]{4})*(?:(?:[0-9a-zA-Z+/]{2}==)|(?:[0-9a-zA-Z+/]{3}=))?$/,bd=/^[A-Za-z0-9_-]*$/,dx=/^\+[1-9]\d{6,14}$/,Cd="(?:(?:\\d\\d[2468][048]|\\d\\d[13579][26]|\\d\\d0[48]|[02468][048]00|[13579][26]00)-02-29|\\d{4}-(?:(?:0[13578]|1[02])-(?:0[1-9]|[12]\\d|3[01])|(?:0[469]|11)-(?:0[1-9]|[12]\\d|30)|(?:02)-(?:0[1-9]|1\\d|2[0-8])))",fx=new RegExp(`^${Cd}$`);function kd(e){const t="(?:[01]\\d|2[0-3]):[0-5]\\d";return typeof e.precision=="number"?e.precision===-1?`${t}`:e.precision===0?`${t}:[0-5]\\d`:`${t}:[0-5]\\d\\.\\d{${e.precision}}`:`${t}(?::[0-5]\\d(?:\\.\\d+)?)?`}function hx(e){return new RegExp(`^${kd(e)}$`)}function mx(e){const t=kd({precision:e.precision}),n=["Z"];e.local&&n.push(""),e.offset&&n.push("([+-](?:[01]\\d|2[0-3]):[0-5]\\d)");const o=`${t}(?:${n.join("|")})`;return new RegExp(`^${Cd}T(?:${o})$`)}const px=e=>{const t=e?`[\\s\\S]{${e?.minimum??0},${e?.maximum??""}}`:"[\\s\\S]*";return new RegExp(`^${t}$`)},gx=/^-?\d+$/,xx=/^-?\d+(?:\.\d+)?$/,yx=/^(?:true|false)$/i,vx=/^[^A-Z]*$/,wx=/^[^a-z]*$/,an=X("$ZodCheck",(e,t)=>{var n;e._zod??(e._zod={}),e._zod.def=t,(n=e._zod).onattach??(n.onattach=[])}),Sd={number:"number",bigint:"bigint",object:"date"},jd=X("$ZodCheckLessThan",(e,t)=>{an.init(e,t);const n=Sd[typeof t.value];e._zod.onattach.push(o=>{const s=o._zod.bag,a=(t.inclusive?s.maximum:s.exclusiveMaximum)??Number.POSITIVE_INFINITY;t.value<a&&(t.inclusive?s.maximum=t.value:s.exclusiveMaximum=t.value)}),e._zod.check=o=>{(t.inclusive?o.value<=t.value:o.value<t.value)||o.issues.push({origin:n,code:"too_big",maximum:typeof t.value=="object"?t.value.getTime():t.value,input:o.value,inclusive:t.inclusive,inst:e,continue:!t.abort})}}),Id=X("$ZodCheckGreaterThan",(e,t)=>{an.init(e,t);const n=Sd[typeof t.value];e._zod.onattach.push(o=>{const s=o._zod.bag,a=(t.inclusive?s.minimum:s.exclusiveMinimum)??Number.NEGATIVE_INFINITY;t.value>a&&(t.inclusive?s.minimum=t.value:s.exclusiveMinimum=t.value)}),e._zod.check=o=>{(t.inclusive?o.value>=t.value:o.value>t.value)||o.issues.push({origin:n,code:"too_small",minimum:typeof t.value=="object"?t.value.getTime():t.value,input:o.value,inclusive:t.inclusive,inst:e,continue:!t.abort})}}),bx=X("$ZodCheckMultipleOf",(e,t)=>{an.init(e,t),e._zod.onattach.push(n=>{var o;(o=n._zod.bag).multipleOf??(o.multipleOf=t.value)}),e._zod.check=n=>{if(typeof n.value!=typeof t.value)throw new Error("Cannot mix number and bigint in multiple_of check.");(typeof n.value=="bigint"?n.value%t.value===BigInt(0):Sg(n.value,t.value)===0)||n.issues.push({origin:typeof n.value,code:"not_multiple_of",divisor:t.value,input:n.value,inst:e,continue:!t.abort})}}),Cx=X("$ZodCheckNumberFormat",(e,t)=>{an.init(e,t),t.format=t.format||"float64";const n=t.format?.includes("int"),o=n?"int":"number",[s,a]=Pg[t.format];e._zod.onattach.push(i=>{const l=i._zod.bag;l.format=t.format,l.minimum=s,l.maximum=a,n&&(l.pattern=gx)}),e._zod.check=i=>{const l=i.value;if(n){if(!Number.isInteger(l)){i.issues.push({expected:o,format:t.format,code:"invalid_type",continue:!1,input:l,inst:e});return}if(!Number.isSafeInteger(l)){l>0?i.issues.push({input:l,code:"too_big",maximum:Number.MAX_SAFE_INTEGER,note:"Integers must be within the safe integer range.",inst:e,origin:o,inclusive:!0,continue:!t.abort}):i.issues.push({input:l,code:"too_small",minimum:Number.MIN_SAFE_INTEGER,note:"Integers must be within the safe integer range.",inst:e,origin:o,inclusive:!0,continue:!t.abort});return}}l<s&&i.issues.push({origin:"number",input:l,code:"too_small",minimum:s,inclusive:!0,inst:e,continue:!t.abort}),l>a&&i.issues.push({origin:"number",input:l,code:"too_big",maximum:a,inclusive:!0,inst:e,continue:!t.abort})}}),kx=X("$ZodCheckMaxLength",(e,t)=>{var n;an.init(e,t),(n=e._zod.def).when??(n.when=o=>{const s=o.value;return!Ra(s)&&s.length!==void 0}),e._zod.onattach.push(o=>{const s=o._zod.bag.maximum??Number.POSITIVE_INFINITY;t.maximum<s&&(o._zod.bag.maximum=t.maximum)}),e._zod.check=o=>{const s=o.value;if(s.length<=t.maximum)return;const i=Ta(s);o.issues.push({origin:i,code:"too_big",maximum:t.maximum,inclusive:!0,input:s,inst:e,continue:!t.abort})}}),Sx=X("$ZodCheckMinLength",(e,t)=>{var n;an.init(e,t),(n=e._zod.def).when??(n.when=o=>{const s=o.value;return!Ra(s)&&s.length!==void 0}),e._zod.onattach.push(o=>{const s=o._zod.bag.minimum??Number.NEGATIVE_INFINITY;t.minimum>s&&(o._zod.bag.minimum=t.minimum)}),e._zod.check=o=>{const s=o.value;if(s.length>=t.minimum)return;const i=Ta(s);o.issues.push({origin:i,code:"too_small",minimum:t.minimum,inclusive:!0,input:s,inst:e,continue:!t.abort})}}),jx=X("$ZodCheckLengthEquals",(e,t)=>{var n;an.init(e,t),(n=e._zod.def).when??(n.when=o=>{const s=o.value;return!Ra(s)&&s.length!==void 0}),e._zod.onattach.push(o=>{const s=o._zod.bag;s.minimum=t.length,s.maximum=t.length,s.length=t.length}),e._zod.check=o=>{const s=o.value,a=s.length;if(a===t.length)return;const i=Ta(s),l=a>t.length;o.issues.push({origin:i,...l?{code:"too_big",maximum:t.length}:{code:"too_small",minimum:t.length},inclusive:!0,exact:!0,input:o.value,inst:e,continue:!t.abort})}}),Xs=X("$ZodCheckStringFormat",(e,t)=>{var n,o;an.init(e,t),e._zod.onattach.push(s=>{const a=s._zod.bag;a.format=t.format,t.pattern&&(a.patterns??(a.patterns=new Set),a.patterns.add(t.pattern))}),t.pattern?(n=e._zod).check??(n.check=s=>{t.pattern.lastIndex=0,!t.pattern.test(s.value)&&s.issues.push({origin:"string",code:"invalid_format",format:t.format,input:s.value,...t.pattern?{pattern:t.pattern.toString()}:{},inst:e,continue:!t.abort})}):(o=e._zod).check??(o.check=()=>{})}),Ix=X("$ZodCheckRegex",(e,t)=>{Xs.init(e,t),e._zod.check=n=>{t.pattern.lastIndex=0,!t.pattern.test(n.value)&&n.issues.push({origin:"string",code:"invalid_format",format:"regex",input:n.value,pattern:t.pattern.toString(),inst:e,continue:!t.abort})}}),Mx=X("$ZodCheckLowerCase",(e,t)=>{t.pattern??(t.pattern=vx),Xs.init(e,t)}),Ex=X("$ZodCheckUpperCase",(e,t)=>{t.pattern??(t.pattern=wx),Xs.init(e,t)}),Px=X("$ZodCheckIncludes",(e,t)=>{an.init(e,t);const n=Gs(t.includes),o=new RegExp(typeof t.position=="number"?`^.{${t.position}}${n}`:n);t.pattern=o,e._zod.onattach.push(s=>{const a=s._zod.bag;a.patterns??(a.patterns=new Set),a.patterns.add(o)}),e._zod.check=s=>{s.value.includes(t.includes,t.position)||s.issues.push({origin:"string",code:"invalid_format",format:"includes",includes:t.includes,input:s.value,inst:e,continue:!t.abort})}}),Lx=X("$ZodCheckStartsWith",(e,t)=>{an.init(e,t);const n=new RegExp(`^${Gs(t.prefix)}.*`);t.pattern??(t.pattern=n),e._zod.onattach.push(o=>{const s=o._zod.bag;s.patterns??(s.patterns=new Set),s.patterns.add(n)}),e._zod.check=o=>{o.value.startsWith(t.prefix)||o.issues.push({origin:"string",code:"invalid_format",format:"starts_with",prefix:t.prefix,input:o.value,inst:e,continue:!t.abort})}}),_x=X("$ZodCheckEndsWith",(e,t)=>{an.init(e,t);const n=new RegExp(`.*${Gs(t.suffix)}$`);t.pattern??(t.pattern=n),e._zod.onattach.push(o=>{const s=o._zod.bag;s.patterns??(s.patterns=new Set),s.patterns.add(n)}),e._zod.check=o=>{o.value.endsWith(t.suffix)||o.issues.push({origin:"string",code:"invalid_format",format:"ends_with",suffix:t.suffix,input:o.value,inst:e,continue:!t.abort})}}),Ax=X("$ZodCheckOverwrite",(e,t)=>{an.init(e,t),e._zod.check=n=>{n.value=t.tx(n.value)}});class Nx{constructor(t=[]){this.content=[],this.indent=0,this&&(this.args=t)}indented(t){this.indent+=1,t(this),this.indent-=1}write(t){if(typeof t=="function"){t(this,{execution:"sync"}),t(this,{execution:"async"});return}const o=t.split(`
`).filter(i=>i),s=Math.min(...o.map(i=>i.length-i.trimStart().length)),a=o.map(i=>i.slice(s)).map(i=>" ".repeat(this.indent*2)+i);for(const i of a)this.content.push(i)}compile(){const t=Function,n=this?.args,s=[...(this?.content??[""]).map(a=>`  ${a}`)];return new t(...n,s.join(`
`))}}const Rx={major:4,minor:3,patch:5},bt=X("$ZodType",(e,t)=>{var n;e??(e={}),e._zod.def=t,e._zod.bag=e._zod.bag||{},e._zod.version=Rx;const o=[...e._zod.def.checks??[]];e._zod.traits.has("$ZodCheck")&&o.unshift(e);for(const s of o)for(const a of s._zod.onattach)a(e);if(o.length===0)(n=e._zod).deferred??(n.deferred=[]),e._zod.deferred?.push(()=>{e._zod.run=e._zod.parse});else{const s=(i,l,c)=>{let d=Do(i),u;for(const f of l){if(f._zod.def.when){if(!f._zod.def.when(i))continue}else if(d)continue;const p=i.issues.length,g=f._zod.check(i);if(g instanceof Promise&&c?.async===!1)throw new Wo;if(u||g instanceof Promise)u=(u??Promise.resolve()).then(async()=>{await g,i.issues.length!==p&&(d||(d=Do(i,p)))});else{if(i.issues.length===p)continue;d||(d=Do(i,p))}}return u?u.then(()=>i):i},a=(i,l,c)=>{if(Do(i))return i.aborted=!0,i;const d=s(l,o,c);if(d instanceof Promise){if(c.async===!1)throw new Wo;return d.then(u=>e._zod.parse(u,c))}return e._zod.parse(d,c)};e._zod.run=(i,l)=>{if(l.skipChecks)return e._zod.parse(i,l);if(l.direction==="backward"){const d=e._zod.parse({value:i.value,issues:[]},{...l,skipChecks:!0});return d instanceof Promise?d.then(u=>a(u,i,l)):a(d,i,l)}const c=e._zod.parse(i,l);if(c instanceof Promise){if(l.async===!1)throw new Wo;return c.then(d=>s(d,o,l))}return s(c,o,l)}}ot(e,"~standard",()=>({validate:s=>{try{const a=Og(e,s);return a.success?{value:a.data}:{issues:a.error?.issues}}catch{return $g(e,s).then(i=>i.success?{value:i.data}:{issues:i.error?.issues})}},vendor:"zod",version:1}))}),Oa=X("$ZodString",(e,t)=>{bt.init(e,t),e._zod.pattern=[...e?._zod.bag?.patterns??[]].pop()??px(e._zod.bag),e._zod.parse=(n,o)=>{if(t.coerce)try{n.value=String(n.value)}catch{}return typeof n.value=="string"||n.issues.push({expected:"string",code:"invalid_type",input:n.value,inst:e}),n}}),mt=X("$ZodStringFormat",(e,t)=>{Xs.init(e,t),Oa.init(e,t)}),Fx=X("$ZodGUID",(e,t)=>{t.pattern??(t.pattern=nx),mt.init(e,t)}),Tx=X("$ZodUUID",(e,t)=>{if(t.version){const o={v1:1,v2:2,v3:3,v4:4,v5:5,v6:6,v7:7,v8:8}[t.version];if(o===void 0)throw new Error(`Invalid UUID version: "${t.version}"`);t.pattern??(t.pattern=Vl(o))}else t.pattern??(t.pattern=Vl());mt.init(e,t)}),Dx=X("$ZodEmail",(e,t)=>{t.pattern??(t.pattern=ox),mt.init(e,t)}),zx=X("$ZodURL",(e,t)=>{mt.init(e,t),e._zod.check=n=>{try{const o=n.value.trim(),s=new URL(o);t.hostname&&(t.hostname.lastIndex=0,t.hostname.test(s.hostname)||n.issues.push({code:"invalid_format",format:"url",note:"Invalid hostname",pattern:t.hostname.source,input:n.value,inst:e,continue:!t.abort})),t.protocol&&(t.protocol.lastIndex=0,t.protocol.test(s.protocol.endsWith(":")?s.protocol.slice(0,-1):s.protocol)||n.issues.push({code:"invalid_format",format:"url",note:"Invalid protocol",pattern:t.protocol.source,input:n.value,inst:e,continue:!t.abort})),t.normalize?n.value=s.href:n.value=o;return}catch{n.issues.push({code:"invalid_format",format:"url",input:n.value,inst:e,continue:!t.abort})}}}),Ox=X("$ZodEmoji",(e,t)=>{t.pattern??(t.pattern=sx()),mt.init(e,t)}),$x=X("$ZodNanoID",(e,t)=>{t.pattern??(t.pattern=ex),mt.init(e,t)}),Bx=X("$ZodCUID",(e,t)=>{t.pattern??(t.pattern=qg),mt.init(e,t)}),Ux=X("$ZodCUID2",(e,t)=>{t.pattern??(t.pattern=Xg),mt.init(e,t)}),Wx=X("$ZodULID",(e,t)=>{t.pattern??(t.pattern=Kg),mt.init(e,t)}),Hx=X("$ZodXID",(e,t)=>{t.pattern??(t.pattern=Qg),mt.init(e,t)}),Zx=X("$ZodKSUID",(e,t)=>{t.pattern??(t.pattern=Jg),mt.init(e,t)}),Vx=X("$ZodISODateTime",(e,t)=>{t.pattern??(t.pattern=mx(t)),mt.init(e,t)}),Gx=X("$ZodISODate",(e,t)=>{t.pattern??(t.pattern=fx),mt.init(e,t)}),Yx=X("$ZodISOTime",(e,t)=>{t.pattern??(t.pattern=hx(t)),mt.init(e,t)}),qx=X("$ZodISODuration",(e,t)=>{t.pattern??(t.pattern=tx),mt.init(e,t)}),Xx=X("$ZodIPv4",(e,t)=>{t.pattern??(t.pattern=ix),mt.init(e,t),e._zod.bag.format="ipv4"}),Kx=X("$ZodIPv6",(e,t)=>{t.pattern??(t.pattern=ax),mt.init(e,t),e._zod.bag.format="ipv6",e._zod.check=n=>{try{new URL(`http://[${n.value}]`)}catch{n.issues.push({code:"invalid_format",format:"ipv6",input:n.value,inst:e,continue:!t.abort})}}}),Qx=X("$ZodCIDRv4",(e,t)=>{t.pattern??(t.pattern=lx),mt.init(e,t)}),Jx=X("$ZodCIDRv6",(e,t)=>{t.pattern??(t.pattern=cx),mt.init(e,t),e._zod.check=n=>{const o=n.value.split("/");try{if(o.length!==2)throw new Error;const[s,a]=o;if(!a)throw new Error;const i=Number(a);if(`${i}`!==a)throw new Error;if(i<0||i>128)throw new Error;new URL(`http://[${s}]`)}catch{n.issues.push({code:"invalid_format",format:"cidrv6",input:n.value,inst:e,continue:!t.abort})}}});function Md(e){if(e==="")return!0;if(e.length%4!==0)return!1;try{return atob(e),!0}catch{return!1}}const e0=X("$ZodBase64",(e,t)=>{t.pattern??(t.pattern=ux),mt.init(e,t),e._zod.bag.contentEncoding="base64",e._zod.check=n=>{Md(n.value)||n.issues.push({code:"invalid_format",format:"base64",input:n.value,inst:e,continue:!t.abort})}});function t0(e){if(!bd.test(e))return!1;const t=e.replace(/[-_]/g,o=>o==="-"?"+":"/"),n=t.padEnd(Math.ceil(t.length/4)*4,"=");return Md(n)}const n0=X("$ZodBase64URL",(e,t)=>{t.pattern??(t.pattern=bd),mt.init(e,t),e._zod.bag.contentEncoding="base64url",e._zod.check=n=>{t0(n.value)||n.issues.push({code:"invalid_format",format:"base64url",input:n.value,inst:e,continue:!t.abort})}}),o0=X("$ZodE164",(e,t)=>{t.pattern??(t.pattern=dx),mt.init(e,t)});function r0(e,t=null){try{const n=e.split(".");if(n.length!==3)return!1;const[o]=n;if(!o)return!1;const s=JSON.parse(atob(o));return!("typ"in s&&s?.typ!=="JWT"||!s.alg||t&&(!("alg"in s)||s.alg!==t))}catch{return!1}}const s0=X("$ZodJWT",(e,t)=>{mt.init(e,t),e._zod.check=n=>{r0(n.value,t.alg)||n.issues.push({code:"invalid_format",format:"jwt",input:n.value,inst:e,continue:!t.abort})}}),Ed=X("$ZodNumber",(e,t)=>{bt.init(e,t),e._zod.pattern=e._zod.bag.pattern??xx,e._zod.parse=(n,o)=>{if(t.coerce)try{n.value=Number(n.value)}catch{}const s=n.value;if(typeof s=="number"&&!Number.isNaN(s)&&Number.isFinite(s))return n;const a=typeof s=="number"?Number.isNaN(s)?"NaN":Number.isFinite(s)?void 0:"Infinity":void 0;return n.issues.push({expected:"number",code:"invalid_type",input:s,inst:e,...a?{received:a}:{}}),n}}),i0=X("$ZodNumberFormat",(e,t)=>{Cx.init(e,t),Ed.init(e,t)}),a0=X("$ZodBoolean",(e,t)=>{bt.init(e,t),e._zod.pattern=yx,e._zod.parse=(n,o)=>{if(t.coerce)try{n.value=!!n.value}catch{}const s=n.value;return typeof s=="boolean"||n.issues.push({expected:"boolean",code:"invalid_type",input:s,inst:e}),n}}),l0=X("$ZodUnknown",(e,t)=>{bt.init(e,t),e._zod.parse=n=>n}),c0=X("$ZodNever",(e,t)=>{bt.init(e,t),e._zod.parse=(n,o)=>(n.issues.push({expected:"never",code:"invalid_type",input:n.value,inst:e}),n)});function Gl(e,t,n){e.issues.length&&t.issues.push(...xd(n,e.issues)),t.value[n]=e.value}const u0=X("$ZodArray",(e,t)=>{bt.init(e,t),e._zod.parse=(n,o)=>{const s=n.value;if(!Array.isArray(s))return n.issues.push({expected:"array",code:"invalid_type",input:s,inst:e}),n;n.value=Array(s.length);const a=[];for(let i=0;i<s.length;i++){const l=s[i],c=t.element._zod.run({value:l,issues:[]},o);c instanceof Promise?a.push(c.then(d=>Gl(d,n,i))):Gl(c,n,i)}return a.length?Promise.all(a).then(()=>n):n}});function _s(e,t,n,o,s){if(e.issues.length){if(s&&!(n in o))return;t.issues.push(...xd(n,e.issues))}e.value===void 0?n in o&&(t.value[n]=void 0):t.value[n]=e.value}function Pd(e){const t=Object.keys(e.shape);for(const o of t)if(!e.shape?.[o]?._zod?.traits?.has("$ZodType"))throw new Error(`Invalid element at key "${o}": expected a Zod schema`);const n=Eg(e.shape);return{...e,keys:t,keySet:new Set(t),numKeys:t.length,optionalKeys:new Set(n)}}function Ld(e,t,n,o,s,a){const i=[],l=s.keySet,c=s.catchall._zod,d=c.def.type,u=c.optout==="optional";for(const f in t){if(l.has(f))continue;if(d==="never"){i.push(f);continue}const p=c.run({value:t[f],issues:[]},o);p instanceof Promise?e.push(p.then(g=>_s(g,n,f,t,u))):_s(p,n,f,t,u)}return i.length&&n.issues.push({code:"unrecognized_keys",keys:i,input:t,inst:a}),e.length?Promise.all(e).then(()=>n):n}const d0=X("$ZodObject",(e,t)=>{if(bt.init(e,t),!Object.getOwnPropertyDescriptor(t,"shape")?.get){const l=t.shape;Object.defineProperty(t,"shape",{get:()=>{const c={...l};return Object.defineProperty(t,"shape",{value:c}),c}})}const o=Na(()=>Pd(t));ot(e._zod,"propValues",()=>{const l=t.shape,c={};for(const d in l){const u=l[d]._zod;if(u.values){c[d]??(c[d]=new Set);for(const f of u.values)c[d].add(f)}}return c});const s=Ls,a=t.catchall;let i;e._zod.parse=(l,c)=>{i??(i=o.value);const d=l.value;if(!s(d))return l.issues.push({expected:"object",code:"invalid_type",input:d,inst:e}),l;l.value={};const u=[],f=i.shape;for(const p of i.keys){const g=f[p],y=g._zod.optout==="optional",v=g._zod.run({value:d[p],issues:[]},c);v instanceof Promise?u.push(v.then(w=>_s(w,l,p,d,y))):_s(v,l,p,d,y)}return a?Ld(u,d,l,c,o.value,e):u.length?Promise.all(u).then(()=>l):l}}),f0=X("$ZodObjectJIT",(e,t)=>{d0.init(e,t);const n=e._zod.parse,o=Na(()=>Pd(t)),s=p=>{const g=new Nx(["shape","payload","ctx"]),y=o.value,v=S=>{const k=Zl(S);return`shape[${k}]._zod.run({ value: input[${k}], issues: [] }, ctx)`};g.write("const input = payload.value;");const w=Object.create(null);let x=0;for(const S of y.keys)w[S]=`key_${x++}`;g.write("const newResult = {};");for(const S of y.keys){const k=w[S],j=Zl(S),M=p[S]?._zod?.optout==="optional";g.write(`const ${k} = ${v(S)};`),M?g.write(`
        if (${k}.issues.length) {
          if (${j} in input) {
            payload.issues = payload.issues.concat(${k}.issues.map(iss => ({
              ...iss,
              path: iss.path ? [${j}, ...iss.path] : [${j}]
            })));
          }
        }
        
        if (${k}.value === undefined) {
          if (${j} in input) {
            newResult[${j}] = undefined;
          }
        } else {
          newResult[${j}] = ${k}.value;
        }
        
      `):g.write(`
        if (${k}.issues.length) {
          payload.issues = payload.issues.concat(${k}.issues.map(iss => ({
            ...iss,
            path: iss.path ? [${j}, ...iss.path] : [${j}]
          })));
        }
        
        if (${k}.value === undefined) {
          if (${j} in input) {
            newResult[${j}] = undefined;
          }
        } else {
          newResult[${j}] = ${k}.value;
        }
        
      `)}g.write("payload.value = newResult;"),g.write("return payload;");const m=g.compile();return(S,k)=>m(p,S,k)};let a;const i=Ls,l=!hd.jitless,d=l&&Ig.value,u=t.catchall;let f;e._zod.parse=(p,g)=>{f??(f=o.value);const y=p.value;return i(y)?l&&d&&g?.async===!1&&g.jitless!==!0?(a||(a=s(t.shape)),p=a(p,g),u?Ld([],y,p,g,f,e):p):n(p,g):(p.issues.push({expected:"object",code:"invalid_type",input:y,inst:e}),p)}});function Yl(e,t,n,o){for(const a of e)if(a.issues.length===0)return t.value=a.value,t;const s=e.filter(a=>!Do(a));return s.length===1?(t.value=s[0].value,s[0]):(t.issues.push({code:"invalid_union",input:t.value,inst:n,errors:e.map(a=>a.issues.map(i=>So(i,o,ko())))}),t)}const h0=X("$ZodUnion",(e,t)=>{bt.init(e,t),ot(e._zod,"optin",()=>t.options.some(s=>s._zod.optin==="optional")?"optional":void 0),ot(e._zod,"optout",()=>t.options.some(s=>s._zod.optout==="optional")?"optional":void 0),ot(e._zod,"values",()=>{if(t.options.every(s=>s._zod.values))return new Set(t.options.flatMap(s=>Array.from(s._zod.values)))}),ot(e._zod,"pattern",()=>{if(t.options.every(s=>s._zod.pattern)){const s=t.options.map(a=>a._zod.pattern);return new RegExp(`^(${s.map(a=>Fa(a.source)).join("|")})$`)}});const n=t.options.length===1,o=t.options[0]._zod.run;e._zod.parse=(s,a)=>{if(n)return o(s,a);let i=!1;const l=[];for(const c of t.options){const d=c._zod.run({value:s.value,issues:[]},a);if(d instanceof Promise)l.push(d),i=!0;else{if(d.issues.length===0)return d;l.push(d)}}return i?Promise.all(l).then(c=>Yl(c,s,e,a)):Yl(l,s,e,a)}}),m0=X("$ZodIntersection",(e,t)=>{bt.init(e,t),e._zod.parse=(n,o)=>{const s=n.value,a=t.left._zod.run({value:s,issues:[]},o),i=t.right._zod.run({value:s,issues:[]},o);return a instanceof Promise||i instanceof Promise?Promise.all([a,i]).then(([c,d])=>ql(n,c,d)):ql(n,a,i)}});function Ki(e,t){if(e===t)return{valid:!0,data:e};if(e instanceof Date&&t instanceof Date&&+e==+t)return{valid:!0,data:e};if(jr(e)&&jr(t)){const n=Object.keys(t),o=Object.keys(e).filter(a=>n.indexOf(a)!==-1),s={...e,...t};for(const a of o){const i=Ki(e[a],t[a]);if(!i.valid)return{valid:!1,mergeErrorPath:[a,...i.mergeErrorPath]};s[a]=i.data}return{valid:!0,data:s}}if(Array.isArray(e)&&Array.isArray(t)){if(e.length!==t.length)return{valid:!1,mergeErrorPath:[]};const n=[];for(let o=0;o<e.length;o++){const s=e[o],a=t[o],i=Ki(s,a);if(!i.valid)return{valid:!1,mergeErrorPath:[o,...i.mergeErrorPath]};n.push(i.data)}return{valid:!0,data:n}}return{valid:!1,mergeErrorPath:[]}}function ql(e,t,n){const o=new Map;let s;for(const l of t.issues)if(l.code==="unrecognized_keys"){s??(s=l);for(const c of l.keys)o.has(c)||o.set(c,{}),o.get(c).l=!0}else e.issues.push(l);for(const l of n.issues)if(l.code==="unrecognized_keys")for(const c of l.keys)o.has(c)||o.set(c,{}),o.get(c).r=!0;else e.issues.push(l);const a=[...o].filter(([,l])=>l.l&&l.r).map(([l])=>l);if(a.length&&s&&e.issues.push({...s,keys:a}),Do(e))return e;const i=Ki(t.value,n.value);if(!i.valid)throw new Error(`Unmergable intersection. Error path: ${JSON.stringify(i.mergeErrorPath)}`);return e.value=i.data,e}const p0=X("$ZodEnum",(e,t)=>{bt.init(e,t);const n=md(t.entries),o=new Set(n);e._zod.values=o,e._zod.pattern=new RegExp(`^(${n.filter(s=>Mg.has(typeof s)).map(s=>typeof s=="string"?Gs(s):s.toString()).join("|")})$`),e._zod.parse=(s,a)=>{const i=s.value;return o.has(i)||s.issues.push({code:"invalid_value",values:n,input:i,inst:e}),s}}),g0=X("$ZodTransform",(e,t)=>{bt.init(e,t),e._zod.parse=(n,o)=>{if(o.direction==="backward")throw new fd(e.constructor.name);const s=t.transform(n.value,n);if(o.async)return(s instanceof Promise?s:Promise.resolve(s)).then(i=>(n.value=i,n));if(s instanceof Promise)throw new Wo;return n.value=s,n}});function Xl(e,t){return e.issues.length&&t===void 0?{issues:[],value:void 0}:e}const _d=X("$ZodOptional",(e,t)=>{bt.init(e,t),e._zod.optin="optional",e._zod.optout="optional",ot(e._zod,"values",()=>t.innerType._zod.values?new Set([...t.innerType._zod.values,void 0]):void 0),ot(e._zod,"pattern",()=>{const n=t.innerType._zod.pattern;return n?new RegExp(`^(${Fa(n.source)})?$`):void 0}),e._zod.parse=(n,o)=>{if(t.innerType._zod.optin==="optional"){const s=t.innerType._zod.run(n,o);return s instanceof Promise?s.then(a=>Xl(a,n.value)):Xl(s,n.value)}return n.value===void 0?n:t.innerType._zod.run(n,o)}}),x0=X("$ZodExactOptional",(e,t)=>{_d.init(e,t),ot(e._zod,"values",()=>t.innerType._zod.values),ot(e._zod,"pattern",()=>t.innerType._zod.pattern),e._zod.parse=(n,o)=>t.innerType._zod.run(n,o)}),y0=X("$ZodNullable",(e,t)=>{bt.init(e,t),ot(e._zod,"optin",()=>t.innerType._zod.optin),ot(e._zod,"optout",()=>t.innerType._zod.optout),ot(e._zod,"pattern",()=>{const n=t.innerType._zod.pattern;return n?new RegExp(`^(${Fa(n.source)}|null)$`):void 0}),ot(e._zod,"values",()=>t.innerType._zod.values?new Set([...t.innerType._zod.values,null]):void 0),e._zod.parse=(n,o)=>n.value===null?n:t.innerType._zod.run(n,o)}),v0=X("$ZodDefault",(e,t)=>{bt.init(e,t),e._zod.optin="optional",ot(e._zod,"values",()=>t.innerType._zod.values),e._zod.parse=(n,o)=>{if(o.direction==="backward")return t.innerType._zod.run(n,o);if(n.value===void 0)return n.value=t.defaultValue,n;const s=t.innerType._zod.run(n,o);return s instanceof Promise?s.then(a=>Kl(a,t)):Kl(s,t)}});function Kl(e,t){return e.value===void 0&&(e.value=t.defaultValue),e}const w0=X("$ZodPrefault",(e,t)=>{bt.init(e,t),e._zod.optin="optional",ot(e._zod,"values",()=>t.innerType._zod.values),e._zod.parse=(n,o)=>(o.direction==="backward"||n.value===void 0&&(n.value=t.defaultValue),t.innerType._zod.run(n,o))}),b0=X("$ZodNonOptional",(e,t)=>{bt.init(e,t),ot(e._zod,"values",()=>{const n=t.innerType._zod.values;return n?new Set([...n].filter(o=>o!==void 0)):void 0}),e._zod.parse=(n,o)=>{const s=t.innerType._zod.run(n,o);return s instanceof Promise?s.then(a=>Ql(a,e)):Ql(s,e)}});function Ql(e,t){return!e.issues.length&&e.value===void 0&&e.issues.push({code:"invalid_type",expected:"nonoptional",input:e.value,inst:t}),e}const C0=X("$ZodCatch",(e,t)=>{bt.init(e,t),ot(e._zod,"optin",()=>t.innerType._zod.optin),ot(e._zod,"optout",()=>t.innerType._zod.optout),ot(e._zod,"values",()=>t.innerType._zod.values),e._zod.parse=(n,o)=>{if(o.direction==="backward")return t.innerType._zod.run(n,o);const s=t.innerType._zod.run(n,o);return s instanceof Promise?s.then(a=>(n.value=a.value,a.issues.length&&(n.value=t.catchValue({...n,error:{issues:a.issues.map(i=>So(i,o,ko()))},input:n.value}),n.issues=[]),n)):(n.value=s.value,s.issues.length&&(n.value=t.catchValue({...n,error:{issues:s.issues.map(a=>So(a,o,ko()))},input:n.value}),n.issues=[]),n)}}),k0=X("$ZodPipe",(e,t)=>{bt.init(e,t),ot(e._zod,"values",()=>t.in._zod.values),ot(e._zod,"optin",()=>t.in._zod.optin),ot(e._zod,"optout",()=>t.out._zod.optout),ot(e._zod,"propValues",()=>t.in._zod.propValues),e._zod.parse=(n,o)=>{if(o.direction==="backward"){const a=t.out._zod.run(n,o);return a instanceof Promise?a.then(i=>Kr(i,t.in,o)):Kr(a,t.in,o)}const s=t.in._zod.run(n,o);return s instanceof Promise?s.then(a=>Kr(a,t.out,o)):Kr(s,t.out,o)}});function Kr(e,t,n){return e.issues.length?(e.aborted=!0,e):t._zod.run({value:e.value,issues:e.issues},n)}const S0=X("$ZodReadonly",(e,t)=>{bt.init(e,t),ot(e._zod,"propValues",()=>t.innerType._zod.propValues),ot(e._zod,"values",()=>t.innerType._zod.values),ot(e._zod,"optin",()=>t.innerType?._zod?.optin),ot(e._zod,"optout",()=>t.innerType?._zod?.optout),e._zod.parse=(n,o)=>{if(o.direction==="backward")return t.innerType._zod.run(n,o);const s=t.innerType._zod.run(n,o);return s instanceof Promise?s.then(Jl):Jl(s)}});function Jl(e){return e.value=Object.freeze(e.value),e}const j0=X("$ZodCustom",(e,t)=>{an.init(e,t),bt.init(e,t),e._zod.parse=(n,o)=>n,e._zod.check=n=>{const o=n.value,s=t.fn(o);if(s instanceof Promise)return s.then(a=>ec(a,n,o,e));ec(s,n,o,e)}});function ec(e,t,n,o){if(!e){const s={code:"custom",input:n,inst:o,path:[...o._zod.def.path??[]],continue:!o._zod.def.abort};o._zod.def.params&&(s.params=o._zod.def.params),t.issues.push(Ir(s))}}var tc;class I0{constructor(){this._map=new WeakMap,this._idmap=new Map}add(t,...n){const o=n[0];return this._map.set(t,o),o&&typeof o=="object"&&"id"in o&&this._idmap.set(o.id,t),this}clear(){return this._map=new WeakMap,this._idmap=new Map,this}remove(t){const n=this._map.get(t);return n&&typeof n=="object"&&"id"in n&&this._idmap.delete(n.id),this._map.delete(t),this}get(t){const n=t._zod.parent;if(n){const o={...this.get(n)??{}};delete o.id;const s={...o,...this._map.get(t)};return Object.keys(s).length?s:void 0}return this._map.get(t)}has(t){return this._map.has(t)}}function M0(){return new I0}(tc=globalThis).__zod_globalRegistry??(tc.__zod_globalRegistry=M0());const pr=globalThis.__zod_globalRegistry;function E0(e,t){return new e({type:"string",...Me(t)})}function P0(e,t){return new e({type:"string",format:"email",check:"string_format",abort:!1,...Me(t)})}function nc(e,t){return new e({type:"string",format:"guid",check:"string_format",abort:!1,...Me(t)})}function L0(e,t){return new e({type:"string",format:"uuid",check:"string_format",abort:!1,...Me(t)})}function _0(e,t){return new e({type:"string",format:"uuid",check:"string_format",abort:!1,version:"v4",...Me(t)})}function A0(e,t){return new e({type:"string",format:"uuid",check:"string_format",abort:!1,version:"v6",...Me(t)})}function N0(e,t){return new e({type:"string",format:"uuid",check:"string_format",abort:!1,version:"v7",...Me(t)})}function R0(e,t){return new e({type:"string",format:"url",check:"string_format",abort:!1,...Me(t)})}function F0(e,t){return new e({type:"string",format:"emoji",check:"string_format",abort:!1,...Me(t)})}function T0(e,t){return new e({type:"string",format:"nanoid",check:"string_format",abort:!1,...Me(t)})}function D0(e,t){return new e({type:"string",format:"cuid",check:"string_format",abort:!1,...Me(t)})}function z0(e,t){return new e({type:"string",format:"cuid2",check:"string_format",abort:!1,...Me(t)})}function O0(e,t){return new e({type:"string",format:"ulid",check:"string_format",abort:!1,...Me(t)})}function $0(e,t){return new e({type:"string",format:"xid",check:"string_format",abort:!1,...Me(t)})}function B0(e,t){return new e({type:"string",format:"ksuid",check:"string_format",abort:!1,...Me(t)})}function U0(e,t){return new e({type:"string",format:"ipv4",check:"string_format",abort:!1,...Me(t)})}function W0(e,t){return new e({type:"string",format:"ipv6",check:"string_format",abort:!1,...Me(t)})}function H0(e,t){return new e({type:"string",format:"cidrv4",check:"string_format",abort:!1,...Me(t)})}function Z0(e,t){return new e({type:"string",format:"cidrv6",check:"string_format",abort:!1,...Me(t)})}function V0(e,t){return new e({type:"string",format:"base64",check:"string_format",abort:!1,...Me(t)})}function G0(e,t){return new e({type:"string",format:"base64url",check:"string_format",abort:!1,...Me(t)})}function Y0(e,t){return new e({type:"string",format:"e164",check:"string_format",abort:!1,...Me(t)})}function q0(e,t){return new e({type:"string",format:"jwt",check:"string_format",abort:!1,...Me(t)})}function X0(e,t){return new e({type:"string",format:"datetime",check:"string_format",offset:!1,local:!1,precision:null,...Me(t)})}function K0(e,t){return new e({type:"string",format:"date",check:"string_format",...Me(t)})}function Q0(e,t){return new e({type:"string",format:"time",check:"string_format",precision:null,...Me(t)})}function J0(e,t){return new e({type:"string",format:"duration",check:"string_format",...Me(t)})}function ey(e,t){return new e({type:"number",checks:[],...Me(t)})}function ty(e,t){return new e({type:"number",check:"number_format",abort:!1,format:"safeint",...Me(t)})}function ny(e,t){return new e({type:"boolean",...Me(t)})}function oy(e){return new e({type:"unknown"})}function ry(e,t){return new e({type:"never",...Me(t)})}function oc(e,t){return new jd({check:"less_than",...Me(t),value:e,inclusive:!1})}function xi(e,t){return new jd({check:"less_than",...Me(t),value:e,inclusive:!0})}function rc(e,t){return new Id({check:"greater_than",...Me(t),value:e,inclusive:!1})}function yi(e,t){return new Id({check:"greater_than",...Me(t),value:e,inclusive:!0})}function sc(e,t){return new bx({check:"multiple_of",...Me(t),value:e})}function Ad(e,t){return new kx({check:"max_length",...Me(t),maximum:e})}function As(e,t){return new Sx({check:"min_length",...Me(t),minimum:e})}function Nd(e,t){return new jx({check:"length_equals",...Me(t),length:e})}function sy(e,t){return new Ix({check:"string_format",format:"regex",...Me(t),pattern:e})}function iy(e){return new Mx({check:"string_format",format:"lowercase",...Me(e)})}function ay(e){return new Ex({check:"string_format",format:"uppercase",...Me(e)})}function ly(e,t){return new Px({check:"string_format",format:"includes",...Me(t),includes:e})}function cy(e,t){return new Lx({check:"string_format",format:"starts_with",...Me(t),prefix:e})}function uy(e,t){return new _x({check:"string_format",format:"ends_with",...Me(t),suffix:e})}function tr(e){return new Ax({check:"overwrite",tx:e})}function dy(e){return tr(t=>t.normalize(e))}function fy(){return tr(e=>e.trim())}function hy(){return tr(e=>e.toLowerCase())}function my(){return tr(e=>e.toUpperCase())}function py(){return tr(e=>jg(e))}function gy(e,t,n){return new e({type:"array",element:t,...Me(n)})}function xy(e,t,n){return new e({type:"custom",check:"custom",fn:t,...Me(n)})}function yy(e){const t=vy(n=>(n.addIssue=o=>{if(typeof o=="string")n.issues.push(Ir(o,n.value,t._zod.def));else{const s=o;s.fatal&&(s.continue=!1),s.code??(s.code="custom"),s.input??(s.input=n.value),s.inst??(s.inst=t),s.continue??(s.continue=!t._zod.def.abort),n.issues.push(Ir(s))}},e(n.value,n)));return t}function vy(e,t){const n=new an({check:"custom",...Me(t)});return n._zod.check=e,n}function Rd(e){let t=e?.target??"draft-2020-12";return t==="draft-4"&&(t="draft-04"),t==="draft-7"&&(t="draft-07"),{processors:e.processors??{},metadataRegistry:e?.metadata??pr,target:t,unrepresentable:e?.unrepresentable??"throw",override:e?.override??(()=>{}),io:e?.io??"output",counter:0,seen:new Map,cycles:e?.cycles??"ref",reused:e?.reused??"inline",external:e?.external??void 0}}function Ot(e,t,n={path:[],schemaPath:[]}){var o;const s=e._zod.def,a=t.seen.get(e);if(a)return a.count++,n.schemaPath.includes(e)&&(a.cycle=n.path),a.schema;const i={schema:{},count:1,cycle:void 0,path:n.path};t.seen.set(e,i);const l=e._zod.toJSONSchema?.();if(l)i.schema=l;else{const u={...n,schemaPath:[...n.schemaPath,e],path:n.path};if(e._zod.processJSONSchema)e._zod.processJSONSchema(t,i.schema,u);else{const p=i.schema,g=t.processors[s.type];if(!g)throw new Error(`[toJSONSchema]: Non-representable type encountered: ${s.type}`);g(e,t,p,u)}const f=e._zod.parent;f&&(i.ref||(i.ref=f),Ot(f,t,u),t.seen.get(f).isParent=!0)}const c=t.metadataRegistry.get(e);return c&&Object.assign(i.schema,c),t.io==="input"&&Xt(e)&&(delete i.schema.examples,delete i.schema.default),t.io==="input"&&i.schema._prefault&&((o=i.schema).default??(o.default=i.schema._prefault)),delete i.schema._prefault,t.seen.get(e).schema}function Fd(e,t){const n=e.seen.get(t);if(!n)throw new Error("Unprocessed schema. This is a bug in Zod.");const o=new Map;for(const i of e.seen.entries()){const l=e.metadataRegistry.get(i[0])?.id;if(l){const c=o.get(l);if(c&&c!==i[0])throw new Error(`Duplicate schema id "${l}" detected during JSON Schema conversion. Two different schemas cannot share the same id when converted together.`);o.set(l,i[0])}}const s=i=>{const l=e.target==="draft-2020-12"?"$defs":"definitions";if(e.external){const f=e.external.registry.get(i[0])?.id,p=e.external.uri??(y=>y);if(f)return{ref:p(f)};const g=i[1].defId??i[1].schema.id??`schema${e.counter++}`;return i[1].defId=g,{defId:g,ref:`${p("__shared")}#/${l}/${g}`}}if(i[1]===n)return{ref:"#"};const d=`#/${l}/`,u=i[1].schema.id??`__schema${e.counter++}`;return{defId:u,ref:d+u}},a=i=>{if(i[1].schema.$ref)return;const l=i[1],{ref:c,defId:d}=s(i);l.def={...l.schema},d&&(l.defId=d);const u=l.schema;for(const f in u)delete u[f];u.$ref=c};if(e.cycles==="throw")for(const i of e.seen.entries()){const l=i[1];if(l.cycle)throw new Error(`Cycle detected: #/${l.cycle?.join("/")}/<root>

Set the \`cycles\` parameter to \`"ref"\` to resolve cyclical schemas with defs.`)}for(const i of e.seen.entries()){const l=i[1];if(t===i[0]){a(i);continue}if(e.external){const d=e.external.registry.get(i[0])?.id;if(t!==i[0]&&d){a(i);continue}}if(e.metadataRegistry.get(i[0])?.id){a(i);continue}if(l.cycle){a(i);continue}if(l.count>1&&e.reused==="ref"){a(i);continue}}}function Td(e,t){const n=e.seen.get(t);if(!n)throw new Error("Unprocessed schema. This is a bug in Zod.");const o=i=>{const l=e.seen.get(i);if(l.ref===null)return;const c=l.def??l.schema,d={...c},u=l.ref;if(l.ref=null,u){o(u);const p=e.seen.get(u),g=p.schema;if(g.$ref&&(e.target==="draft-07"||e.target==="draft-04"||e.target==="openapi-3.0")?(c.allOf=c.allOf??[],c.allOf.push(g)):Object.assign(c,g),Object.assign(c,d),i._zod.parent===u)for(const v in c)v==="$ref"||v==="allOf"||v in d||delete c[v];if(g.$ref)for(const v in c)v==="$ref"||v==="allOf"||v in p.def&&JSON.stringify(c[v])===JSON.stringify(p.def[v])&&delete c[v]}const f=i._zod.parent;if(f&&f!==u){o(f);const p=e.seen.get(f);if(p?.schema.$ref&&(c.$ref=p.schema.$ref,p.def))for(const g in c)g==="$ref"||g==="allOf"||g in p.def&&JSON.stringify(c[g])===JSON.stringify(p.def[g])&&delete c[g]}e.override({zodSchema:i,jsonSchema:c,path:l.path??[]})};for(const i of[...e.seen.entries()].reverse())o(i[0]);const s={};if(e.target==="draft-2020-12"?s.$schema="https://json-schema.org/draft/2020-12/schema":e.target==="draft-07"?s.$schema="http://json-schema.org/draft-07/schema#":e.target==="draft-04"?s.$schema="http://json-schema.org/draft-04/schema#":e.target,e.external?.uri){const i=e.external.registry.get(t)?.id;if(!i)throw new Error("Schema is missing an `id` property");s.$id=e.external.uri(i)}Object.assign(s,n.def??n.schema);const a=e.external?.defs??{};for(const i of e.seen.entries()){const l=i[1];l.def&&l.defId&&(a[l.defId]=l.def)}e.external||Object.keys(a).length>0&&(e.target==="draft-2020-12"?s.$defs=a:s.definitions=a);try{const i=JSON.parse(JSON.stringify(s));return Object.defineProperty(i,"~standard",{value:{...t["~standard"],jsonSchema:{input:Ns(t,"input",e.processors),output:Ns(t,"output",e.processors)}},enumerable:!1,writable:!1}),i}catch{throw new Error("Error converting schema to JSON.")}}function Xt(e,t){const n=t??{seen:new Set};if(n.seen.has(e))return!1;n.seen.add(e);const o=e._zod.def;if(o.type==="transform")return!0;if(o.type==="array")return Xt(o.element,n);if(o.type==="set")return Xt(o.valueType,n);if(o.type==="lazy")return Xt(o.getter(),n);if(o.type==="promise"||o.type==="optional"||o.type==="nonoptional"||o.type==="nullable"||o.type==="readonly"||o.type==="default"||o.type==="prefault")return Xt(o.innerType,n);if(o.type==="intersection")return Xt(o.left,n)||Xt(o.right,n);if(o.type==="record"||o.type==="map")return Xt(o.keyType,n)||Xt(o.valueType,n);if(o.type==="pipe")return Xt(o.in,n)||Xt(o.out,n);if(o.type==="object"){for(const s in o.shape)if(Xt(o.shape[s],n))return!0;return!1}if(o.type==="union"){for(const s of o.options)if(Xt(s,n))return!0;return!1}if(o.type==="tuple"){for(const s of o.items)if(Xt(s,n))return!0;return!!(o.rest&&Xt(o.rest,n))}return!1}const wy=(e,t={})=>n=>{const o=Rd({...n,processors:t});return Ot(e,o),Fd(o,e),Td(o,e)},Ns=(e,t,n={})=>o=>{const{libraryOptions:s,target:a}=o??{},i=Rd({...s??{},target:a,io:t,processors:n});return Ot(e,i),Fd(i,e),Td(i,e)},by={guid:"uuid",url:"uri",datetime:"date-time",json_string:"json-string",regex:""},Cy=(e,t,n,o)=>{const s=n;s.type="string";const{minimum:a,maximum:i,format:l,patterns:c,contentEncoding:d}=e._zod.bag;if(typeof a=="number"&&(s.minLength=a),typeof i=="number"&&(s.maxLength=i),l&&(s.format=by[l]??l,s.format===""&&delete s.format,l==="time"&&delete s.format),d&&(s.contentEncoding=d),c&&c.size>0){const u=[...c];u.length===1?s.pattern=u[0].source:u.length>1&&(s.allOf=[...u.map(f=>({...t.target==="draft-07"||t.target==="draft-04"||t.target==="openapi-3.0"?{type:"string"}:{},pattern:f.source}))])}},ky=(e,t,n,o)=>{const s=n,{minimum:a,maximum:i,format:l,multipleOf:c,exclusiveMaximum:d,exclusiveMinimum:u}=e._zod.bag;typeof l=="string"&&l.includes("int")?s.type="integer":s.type="number",typeof u=="number"&&(t.target==="draft-04"||t.target==="openapi-3.0"?(s.minimum=u,s.exclusiveMinimum=!0):s.exclusiveMinimum=u),typeof a=="number"&&(s.minimum=a,typeof u=="number"&&t.target!=="draft-04"&&(u>=a?delete s.minimum:delete s.exclusiveMinimum)),typeof d=="number"&&(t.target==="draft-04"||t.target==="openapi-3.0"?(s.maximum=d,s.exclusiveMaximum=!0):s.exclusiveMaximum=d),typeof i=="number"&&(s.maximum=i,typeof d=="number"&&t.target!=="draft-04"&&(d<=i?delete s.maximum:delete s.exclusiveMaximum)),typeof c=="number"&&(s.multipleOf=c)},Sy=(e,t,n,o)=>{n.type="boolean"},jy=(e,t,n,o)=>{n.not={}},Iy=(e,t,n,o)=>{},My=(e,t,n,o)=>{const s=e._zod.def,a=md(s.entries);a.every(i=>typeof i=="number")&&(n.type="number"),a.every(i=>typeof i=="string")&&(n.type="string"),n.enum=a},Ey=(e,t,n,o)=>{if(t.unrepresentable==="throw")throw new Error("Custom types cannot be represented in JSON Schema")},Py=(e,t,n,o)=>{if(t.unrepresentable==="throw")throw new Error("Transforms cannot be represented in JSON Schema")},Ly=(e,t,n,o)=>{const s=n,a=e._zod.def,{minimum:i,maximum:l}=e._zod.bag;typeof i=="number"&&(s.minItems=i),typeof l=="number"&&(s.maxItems=l),s.type="array",s.items=Ot(a.element,t,{...o,path:[...o.path,"items"]})},_y=(e,t,n,o)=>{const s=n,a=e._zod.def;s.type="object",s.properties={};const i=a.shape;for(const d in i)s.properties[d]=Ot(i[d],t,{...o,path:[...o.path,"properties",d]});const l=new Set(Object.keys(i)),c=new Set([...l].filter(d=>{const u=a.shape[d]._zod;return t.io==="input"?u.optin===void 0:u.optout===void 0}));c.size>0&&(s.required=Array.from(c)),a.catchall?._zod.def.type==="never"?s.additionalProperties=!1:a.catchall?a.catchall&&(s.additionalProperties=Ot(a.catchall,t,{...o,path:[...o.path,"additionalProperties"]})):t.io==="output"&&(s.additionalProperties=!1)},Ay=(e,t,n,o)=>{const s=e._zod.def,a=s.inclusive===!1,i=s.options.map((l,c)=>Ot(l,t,{...o,path:[...o.path,a?"oneOf":"anyOf",c]}));a?n.oneOf=i:n.anyOf=i},Ny=(e,t,n,o)=>{const s=e._zod.def,a=Ot(s.left,t,{...o,path:[...o.path,"allOf",0]}),i=Ot(s.right,t,{...o,path:[...o.path,"allOf",1]}),l=d=>"allOf"in d&&Object.keys(d).length===1,c=[...l(a)?a.allOf:[a],...l(i)?i.allOf:[i]];n.allOf=c},Ry=(e,t,n,o)=>{const s=e._zod.def,a=Ot(s.innerType,t,o),i=t.seen.get(e);t.target==="openapi-3.0"?(i.ref=s.innerType,n.nullable=!0):n.anyOf=[a,{type:"null"}]},Fy=(e,t,n,o)=>{const s=e._zod.def;Ot(s.innerType,t,o);const a=t.seen.get(e);a.ref=s.innerType},Ty=(e,t,n,o)=>{const s=e._zod.def;Ot(s.innerType,t,o);const a=t.seen.get(e);a.ref=s.innerType,n.default=JSON.parse(JSON.stringify(s.defaultValue))},Dy=(e,t,n,o)=>{const s=e._zod.def;Ot(s.innerType,t,o);const a=t.seen.get(e);a.ref=s.innerType,t.io==="input"&&(n._prefault=JSON.parse(JSON.stringify(s.defaultValue)))},zy=(e,t,n,o)=>{const s=e._zod.def;Ot(s.innerType,t,o);const a=t.seen.get(e);a.ref=s.innerType;let i;try{i=s.catchValue(void 0)}catch{throw new Error("Dynamic catch values are not supported in JSON Schema")}n.default=i},Oy=(e,t,n,o)=>{const s=e._zod.def,a=t.io==="input"?s.in._zod.def.type==="transform"?s.out:s.in:s.out;Ot(a,t,o);const i=t.seen.get(e);i.ref=a},$y=(e,t,n,o)=>{const s=e._zod.def;Ot(s.innerType,t,o);const a=t.seen.get(e);a.ref=s.innerType,n.readOnly=!0},Dd=(e,t,n,o)=>{const s=e._zod.def;Ot(s.innerType,t,o);const a=t.seen.get(e);a.ref=s.innerType},By=X("ZodISODateTime",(e,t)=>{Vx.init(e,t),xt.init(e,t)});function Uy(e){return X0(By,e)}const Wy=X("ZodISODate",(e,t)=>{Gx.init(e,t),xt.init(e,t)});function Hy(e){return K0(Wy,e)}const Zy=X("ZodISOTime",(e,t)=>{Yx.init(e,t),xt.init(e,t)});function Vy(e){return Q0(Zy,e)}const Gy=X("ZodISODuration",(e,t)=>{qx.init(e,t),xt.init(e,t)});function Yy(e){return J0(Gy,e)}const qy=(e,t)=>{vd.init(e,t),e.name="ZodError",Object.defineProperties(e,{format:{value:n=>zg(e,n)},flatten:{value:n=>Dg(e,n)},addIssue:{value:n=>{e.issues.push(n),e.message=JSON.stringify(e.issues,Xi,2)}},addIssues:{value:n=>{e.issues.push(...n),e.message=JSON.stringify(e.issues,Xi,2)}},isEmpty:{get(){return e.issues.length===0}}})},xn=X("ZodError",qy,{Parent:Error}),Xy=Da(xn),Ky=za(xn),Qy=Ys(xn),Jy=qs(xn),ev=Bg(xn),tv=Ug(xn),nv=Wg(xn),ov=Hg(xn),rv=Zg(xn),sv=Vg(xn),iv=Gg(xn),av=Yg(xn),Ct=X("ZodType",(e,t)=>(bt.init(e,t),Object.assign(e["~standard"],{jsonSchema:{input:Ns(e,"input"),output:Ns(e,"output")}}),e.toJSONSchema=wy(e,{}),e.def=t,e.type=t.type,Object.defineProperty(e,"_def",{value:t}),e.check=(...n)=>e.clone(co(t,{checks:[...t.checks??[],...n.map(o=>typeof o=="function"?{_zod:{check:o,def:{check:"custom"},onattach:[]}}:o)]}),{parent:!0}),e.with=e.check,e.clone=(n,o)=>uo(e,n,o),e.brand=()=>e,e.register=((n,o)=>(n.add(e,o),e)),e.parse=(n,o)=>Xy(e,n,o,{callee:e.parse}),e.safeParse=(n,o)=>Qy(e,n,o),e.parseAsync=async(n,o)=>Ky(e,n,o,{callee:e.parseAsync}),e.safeParseAsync=async(n,o)=>Jy(e,n,o),e.spa=e.safeParseAsync,e.encode=(n,o)=>ev(e,n,o),e.decode=(n,o)=>tv(e,n,o),e.encodeAsync=async(n,o)=>nv(e,n,o),e.decodeAsync=async(n,o)=>ov(e,n,o),e.safeEncode=(n,o)=>rv(e,n,o),e.safeDecode=(n,o)=>sv(e,n,o),e.safeEncodeAsync=async(n,o)=>iv(e,n,o),e.safeDecodeAsync=async(n,o)=>av(e,n,o),e.refine=(n,o)=>e.check(Jv(n,o)),e.superRefine=n=>e.check(ew(n)),e.overwrite=n=>e.check(tr(n)),e.optional=()=>lc(e),e.exactOptional=()=>$v(e),e.nullable=()=>cc(e),e.nullish=()=>lc(cc(e)),e.nonoptional=n=>Vv(e,n),e.array=()=>Ji(e),e.or=n=>Rv([e,n]),e.and=n=>Tv(e,n),e.transform=n=>uc(e,zv(n)),e.default=n=>Wv(e,n),e.prefault=n=>Zv(e,n),e.catch=n=>Yv(e,n),e.pipe=n=>uc(e,n),e.readonly=()=>Kv(e),e.describe=n=>{const o=e.clone();return pr.add(o,{description:n}),o},Object.defineProperty(e,"description",{get(){return pr.get(e)?.description},configurable:!0}),e.meta=(...n)=>{if(n.length===0)return pr.get(e);const o=e.clone();return pr.add(o,n[0]),o},e.isOptional=()=>e.safeParse(void 0).success,e.isNullable=()=>e.safeParse(null).success,e.apply=n=>n(e),e)),zd=X("_ZodString",(e,t)=>{Oa.init(e,t),Ct.init(e,t),e._zod.processJSONSchema=(o,s,a)=>Cy(e,o,s);const n=e._zod.bag;e.format=n.format??null,e.minLength=n.minimum??null,e.maxLength=n.maximum??null,e.regex=(...o)=>e.check(sy(...o)),e.includes=(...o)=>e.check(ly(...o)),e.startsWith=(...o)=>e.check(cy(...o)),e.endsWith=(...o)=>e.check(uy(...o)),e.min=(...o)=>e.check(As(...o)),e.max=(...o)=>e.check(Ad(...o)),e.length=(...o)=>e.check(Nd(...o)),e.nonempty=(...o)=>e.check(As(1,...o)),e.lowercase=o=>e.check(iy(o)),e.uppercase=o=>e.check(ay(o)),e.trim=()=>e.check(fy()),e.normalize=(...o)=>e.check(dy(...o)),e.toLowerCase=()=>e.check(hy()),e.toUpperCase=()=>e.check(my()),e.slugify=()=>e.check(py())}),lv=X("ZodString",(e,t)=>{Oa.init(e,t),zd.init(e,t),e.email=n=>e.check(P0(cv,n)),e.url=n=>e.check(R0(uv,n)),e.jwt=n=>e.check(q0(jv,n)),e.emoji=n=>e.check(F0(dv,n)),e.guid=n=>e.check(nc(ic,n)),e.uuid=n=>e.check(L0(Qr,n)),e.uuidv4=n=>e.check(_0(Qr,n)),e.uuidv6=n=>e.check(A0(Qr,n)),e.uuidv7=n=>e.check(N0(Qr,n)),e.nanoid=n=>e.check(T0(fv,n)),e.guid=n=>e.check(nc(ic,n)),e.cuid=n=>e.check(D0(hv,n)),e.cuid2=n=>e.check(z0(mv,n)),e.ulid=n=>e.check(O0(pv,n)),e.base64=n=>e.check(V0(Cv,n)),e.base64url=n=>e.check(G0(kv,n)),e.xid=n=>e.check($0(gv,n)),e.ksuid=n=>e.check(B0(xv,n)),e.ipv4=n=>e.check(U0(yv,n)),e.ipv6=n=>e.check(W0(vv,n)),e.cidrv4=n=>e.check(H0(wv,n)),e.cidrv6=n=>e.check(Z0(bv,n)),e.e164=n=>e.check(Y0(Sv,n)),e.datetime=n=>e.check(Uy(n)),e.date=n=>e.check(Hy(n)),e.time=n=>e.check(Vy(n)),e.duration=n=>e.check(Yy(n))});function fn(e){return E0(lv,e)}const xt=X("ZodStringFormat",(e,t)=>{mt.init(e,t),zd.init(e,t)}),cv=X("ZodEmail",(e,t)=>{Dx.init(e,t),xt.init(e,t)}),ic=X("ZodGUID",(e,t)=>{Fx.init(e,t),xt.init(e,t)}),Qr=X("ZodUUID",(e,t)=>{Tx.init(e,t),xt.init(e,t)}),uv=X("ZodURL",(e,t)=>{zx.init(e,t),xt.init(e,t)}),dv=X("ZodEmoji",(e,t)=>{Ox.init(e,t),xt.init(e,t)}),fv=X("ZodNanoID",(e,t)=>{$x.init(e,t),xt.init(e,t)}),hv=X("ZodCUID",(e,t)=>{Bx.init(e,t),xt.init(e,t)}),mv=X("ZodCUID2",(e,t)=>{Ux.init(e,t),xt.init(e,t)}),pv=X("ZodULID",(e,t)=>{Wx.init(e,t),xt.init(e,t)}),gv=X("ZodXID",(e,t)=>{Hx.init(e,t),xt.init(e,t)}),xv=X("ZodKSUID",(e,t)=>{Zx.init(e,t),xt.init(e,t)}),yv=X("ZodIPv4",(e,t)=>{Xx.init(e,t),xt.init(e,t)}),vv=X("ZodIPv6",(e,t)=>{Kx.init(e,t),xt.init(e,t)}),wv=X("ZodCIDRv4",(e,t)=>{Qx.init(e,t),xt.init(e,t)}),bv=X("ZodCIDRv6",(e,t)=>{Jx.init(e,t),xt.init(e,t)}),Cv=X("ZodBase64",(e,t)=>{e0.init(e,t),xt.init(e,t)}),kv=X("ZodBase64URL",(e,t)=>{n0.init(e,t),xt.init(e,t)}),Sv=X("ZodE164",(e,t)=>{o0.init(e,t),xt.init(e,t)}),jv=X("ZodJWT",(e,t)=>{s0.init(e,t),xt.init(e,t)}),Od=X("ZodNumber",(e,t)=>{Ed.init(e,t),Ct.init(e,t),e._zod.processJSONSchema=(o,s,a)=>ky(e,o,s),e.gt=(o,s)=>e.check(rc(o,s)),e.gte=(o,s)=>e.check(yi(o,s)),e.min=(o,s)=>e.check(yi(o,s)),e.lt=(o,s)=>e.check(oc(o,s)),e.lte=(o,s)=>e.check(xi(o,s)),e.max=(o,s)=>e.check(xi(o,s)),e.int=o=>e.check(ac(o)),e.safe=o=>e.check(ac(o)),e.positive=o=>e.check(rc(0,o)),e.nonnegative=o=>e.check(yi(0,o)),e.negative=o=>e.check(oc(0,o)),e.nonpositive=o=>e.check(xi(0,o)),e.multipleOf=(o,s)=>e.check(sc(o,s)),e.step=(o,s)=>e.check(sc(o,s)),e.finite=()=>e;const n=e._zod.bag;e.minValue=Math.max(n.minimum??Number.NEGATIVE_INFINITY,n.exclusiveMinimum??Number.NEGATIVE_INFINITY)??null,e.maxValue=Math.min(n.maximum??Number.POSITIVE_INFINITY,n.exclusiveMaximum??Number.POSITIVE_INFINITY)??null,e.isInt=(n.format??"").includes("int")||Number.isSafeInteger(n.multipleOf??.5),e.isFinite=!0,e.format=n.format??null});function $a(e){return ey(Od,e)}const Iv=X("ZodNumberFormat",(e,t)=>{i0.init(e,t),Od.init(e,t)});function ac(e){return ty(Iv,e)}const Mv=X("ZodBoolean",(e,t)=>{a0.init(e,t),Ct.init(e,t),e._zod.processJSONSchema=(n,o,s)=>Sy(e,n,o)});function $d(e){return ny(Mv,e)}const Ev=X("ZodUnknown",(e,t)=>{l0.init(e,t),Ct.init(e,t),e._zod.processJSONSchema=(n,o,s)=>Iy()});function Qi(){return oy(Ev)}const Pv=X("ZodNever",(e,t)=>{c0.init(e,t),Ct.init(e,t),e._zod.processJSONSchema=(n,o,s)=>jy(e,n,o)});function Lv(e){return ry(Pv,e)}const _v=X("ZodArray",(e,t)=>{u0.init(e,t),Ct.init(e,t),e._zod.processJSONSchema=(n,o,s)=>Ly(e,n,o,s),e.element=t.element,e.min=(n,o)=>e.check(As(n,o)),e.nonempty=n=>e.check(As(1,n)),e.max=(n,o)=>e.check(Ad(n,o)),e.length=(n,o)=>e.check(Nd(n,o)),e.unwrap=()=>e.element});function Ji(e,t){return gy(_v,e,t)}const Av=X("ZodObject",(e,t)=>{f0.init(e,t),Ct.init(e,t),e._zod.processJSONSchema=(n,o,s)=>_y(e,n,o,s),ot(e,"shape",()=>t.shape),e.keyof=()=>Bd(Object.keys(e._zod.def.shape)),e.catchall=n=>e.clone({...e._zod.def,catchall:n}),e.passthrough=()=>e.clone({...e._zod.def,catchall:Qi()}),e.loose=()=>e.clone({...e._zod.def,catchall:Qi()}),e.strict=()=>e.clone({...e._zod.def,catchall:Lv()}),e.strip=()=>e.clone({...e._zod.def,catchall:void 0}),e.extend=n=>Ag(e,n),e.safeExtend=n=>Ng(e,n),e.merge=n=>Rg(e,n),e.pick=n=>Lg(e,n),e.omit=n=>_g(e,n),e.partial=(...n)=>Fg(Ud,e,n[0]),e.required=(...n)=>Tg(Wd,e,n[0])});function Rs(e,t){const n={type:"object",shape:e??{},...Me(t)};return new Av(n)}const Nv=X("ZodUnion",(e,t)=>{h0.init(e,t),Ct.init(e,t),e._zod.processJSONSchema=(n,o,s)=>Ay(e,n,o,s),e.options=t.options});function Rv(e,t){return new Nv({type:"union",options:e,...Me(t)})}const Fv=X("ZodIntersection",(e,t)=>{m0.init(e,t),Ct.init(e,t),e._zod.processJSONSchema=(n,o,s)=>Ny(e,n,o,s)});function Tv(e,t){return new Fv({type:"intersection",left:e,right:t})}const ea=X("ZodEnum",(e,t)=>{p0.init(e,t),Ct.init(e,t),e._zod.processJSONSchema=(o,s,a)=>My(e,o,s),e.enum=t.entries,e.options=Object.values(t.entries);const n=new Set(Object.keys(t.entries));e.extract=(o,s)=>{const a={};for(const i of o)if(n.has(i))a[i]=t.entries[i];else throw new Error(`Key ${i} not found in enum`);return new ea({...t,checks:[],...Me(s),entries:a})},e.exclude=(o,s)=>{const a={...t.entries};for(const i of o)if(n.has(i))delete a[i];else throw new Error(`Key ${i} not found in enum`);return new ea({...t,checks:[],...Me(s),entries:a})}});function Bd(e,t){const n=Array.isArray(e)?Object.fromEntries(e.map(o=>[o,o])):e;return new ea({type:"enum",entries:n,...Me(t)})}const Dv=X("ZodTransform",(e,t)=>{g0.init(e,t),Ct.init(e,t),e._zod.processJSONSchema=(n,o,s)=>Py(e,n),e._zod.parse=(n,o)=>{if(o.direction==="backward")throw new fd(e.constructor.name);n.addIssue=a=>{if(typeof a=="string")n.issues.push(Ir(a,n.value,t));else{const i=a;i.fatal&&(i.continue=!1),i.code??(i.code="custom"),i.input??(i.input=n.value),i.inst??(i.inst=e),n.issues.push(Ir(i))}};const s=t.transform(n.value,n);return s instanceof Promise?s.then(a=>(n.value=a,n)):(n.value=s,n)}});function zv(e){return new Dv({type:"transform",transform:e})}const Ud=X("ZodOptional",(e,t)=>{_d.init(e,t),Ct.init(e,t),e._zod.processJSONSchema=(n,o,s)=>Dd(e,n,o,s),e.unwrap=()=>e._zod.def.innerType});function lc(e){return new Ud({type:"optional",innerType:e})}const Ov=X("ZodExactOptional",(e,t)=>{x0.init(e,t),Ct.init(e,t),e._zod.processJSONSchema=(n,o,s)=>Dd(e,n,o,s),e.unwrap=()=>e._zod.def.innerType});function $v(e){return new Ov({type:"optional",innerType:e})}const Bv=X("ZodNullable",(e,t)=>{y0.init(e,t),Ct.init(e,t),e._zod.processJSONSchema=(n,o,s)=>Ry(e,n,o,s),e.unwrap=()=>e._zod.def.innerType});function cc(e){return new Bv({type:"nullable",innerType:e})}const Uv=X("ZodDefault",(e,t)=>{v0.init(e,t),Ct.init(e,t),e._zod.processJSONSchema=(n,o,s)=>Ty(e,n,o,s),e.unwrap=()=>e._zod.def.innerType,e.removeDefault=e.unwrap});function Wv(e,t){return new Uv({type:"default",innerType:e,get defaultValue(){return typeof t=="function"?t():gd(t)}})}const Hv=X("ZodPrefault",(e,t)=>{w0.init(e,t),Ct.init(e,t),e._zod.processJSONSchema=(n,o,s)=>Dy(e,n,o,s),e.unwrap=()=>e._zod.def.innerType});function Zv(e,t){return new Hv({type:"prefault",innerType:e,get defaultValue(){return typeof t=="function"?t():gd(t)}})}const Wd=X("ZodNonOptional",(e,t)=>{b0.init(e,t),Ct.init(e,t),e._zod.processJSONSchema=(n,o,s)=>Fy(e,n,o,s),e.unwrap=()=>e._zod.def.innerType});function Vv(e,t){return new Wd({type:"nonoptional",innerType:e,...Me(t)})}const Gv=X("ZodCatch",(e,t)=>{C0.init(e,t),Ct.init(e,t),e._zod.processJSONSchema=(n,o,s)=>zy(e,n,o,s),e.unwrap=()=>e._zod.def.innerType,e.removeCatch=e.unwrap});function Yv(e,t){return new Gv({type:"catch",innerType:e,catchValue:typeof t=="function"?t:()=>t})}const qv=X("ZodPipe",(e,t)=>{k0.init(e,t),Ct.init(e,t),e._zod.processJSONSchema=(n,o,s)=>Oy(e,n,o,s),e.in=t.in,e.out=t.out});function uc(e,t){return new qv({type:"pipe",in:e,out:t})}const Xv=X("ZodReadonly",(e,t)=>{S0.init(e,t),Ct.init(e,t),e._zod.processJSONSchema=(n,o,s)=>$y(e,n,o,s),e.unwrap=()=>e._zod.def.innerType});function Kv(e){return new Xv({type:"readonly",innerType:e})}const Qv=X("ZodCustom",(e,t)=>{j0.init(e,t),Ct.init(e,t),e._zod.processJSONSchema=(n,o,s)=>Ey(e,n)});function Jv(e,t={}){return xy(Qv,e,t)}function ew(e){return yy(e)}function tw(e){let t;switch(e.type){case"number":{const n=e;let o=$a();n.min!==void 0&&(o=o.min(n.min)),n.max!==void 0&&(o=o.max(n.max)),n.isInt&&(o=o.int()),t=o,n.nullable===!0&&(t=o.nullable());break}case"boolean":{t=$d();break}case"string":{const n=e;let o=fn();if(n.pattern){const s=n.patternDesc?`Invalid format: expected ${n.patternDesc}`:"Invalid format";o=o.regex(n.pattern,s)}t=o;break}case"enum":{t=Bd(e.enumValues);break}default:t=Qi()}return t.optional()}function nw(e){const t={};for(const n of Aa(e))t[n.key]=tw(n);return Rs(t).optional()}function ow(){const e={version:$a().int().min(1).max(ud).optional()};for(const t of _a)e[t.key]=nw(t);return Rs(e)}const rw=ow(),sw=rw;function iw(e){const t=sw.safeParse(e);return t.success?{valid:!0,errors:[],config:t.data}:{valid:!1,errors:t.error.issues.map(o=>({path:o.path.join("."),message:o.message,value:void 0})),config:null}}function Hd(e){return typeof e>"u"||e===null}function aw(e){return typeof e=="object"&&e!==null}function lw(e){return Array.isArray(e)?e:Hd(e)?[]:[e]}function cw(e,t){var n,o,s,a;if(t)for(a=Object.keys(t),n=0,o=a.length;n<o;n+=1)s=a[n],e[s]=t[s];return e}function uw(e,t){var n="",o;for(o=0;o<t;o+=1)n+=e;return n}function dw(e){return e===0&&Number.NEGATIVE_INFINITY===1/e}var fw=Hd,hw=aw,mw=lw,pw=uw,gw=dw,xw=cw,Pt={isNothing:fw,isObject:hw,toArray:mw,repeat:pw,isNegativeZero:gw,extend:xw};function Zd(e,t){var n="",o=e.reason||"(unknown reason)";return e.mark?(e.mark.name&&(n+='in "'+e.mark.name+'" '),n+="("+(e.mark.line+1)+":"+(e.mark.column+1)+")",!t&&e.mark.snippet&&(n+=`

`+e.mark.snippet),o+" "+n):o}function Mr(e,t){Error.call(this),this.name="YAMLException",this.reason=e,this.mark=t,this.message=Zd(this,!1),Error.captureStackTrace?Error.captureStackTrace(this,this.constructor):this.stack=new Error().stack||""}Mr.prototype=Object.create(Error.prototype);Mr.prototype.constructor=Mr;Mr.prototype.toString=function(t){return this.name+": "+Zd(this,t)};var rn=Mr;function vi(e,t,n,o,s){var a="",i="",l=Math.floor(s/2)-1;return o-t>l&&(a=" ... ",t=o-l+a.length),n-o>l&&(i=" ...",n=o+l-i.length),{str:a+e.slice(t,n).replace(/\t/g,"â†’")+i,pos:o-t+a.length}}function wi(e,t){return Pt.repeat(" ",t-e.length)+e}function yw(e,t){if(t=Object.create(t||null),!e.buffer)return null;t.maxLength||(t.maxLength=79),typeof t.indent!="number"&&(t.indent=1),typeof t.linesBefore!="number"&&(t.linesBefore=3),typeof t.linesAfter!="number"&&(t.linesAfter=2);for(var n=/\r?\n|\r|\0/g,o=[0],s=[],a,i=-1;a=n.exec(e.buffer);)s.push(a.index),o.push(a.index+a[0].length),e.position<=a.index&&i<0&&(i=o.length-2);i<0&&(i=o.length-1);var l="",c,d,u=Math.min(e.line+t.linesAfter,s.length).toString().length,f=t.maxLength-(t.indent+u+3);for(c=1;c<=t.linesBefore&&!(i-c<0);c++)d=vi(e.buffer,o[i-c],s[i-c],e.position-(o[i]-o[i-c]),f),l=Pt.repeat(" ",t.indent)+wi((e.line-c+1).toString(),u)+" | "+d.str+`
`+l;for(d=vi(e.buffer,o[i],s[i],e.position,f),l+=Pt.repeat(" ",t.indent)+wi((e.line+1).toString(),u)+" | "+d.str+`
`,l+=Pt.repeat("-",t.indent+u+3+d.pos)+`^
`,c=1;c<=t.linesAfter&&!(i+c>=s.length);c++)d=vi(e.buffer,o[i+c],s[i+c],e.position-(o[i]-o[i+c]),f),l+=Pt.repeat(" ",t.indent)+wi((e.line+c+1).toString(),u)+" | "+d.str+`
`;return l.replace(/\n$/,"")}var vw=yw,ww=["kind","multi","resolve","construct","instanceOf","predicate","represent","representName","defaultStyle","styleAliases"],bw=["scalar","sequence","mapping"];function Cw(e){var t={};return e!==null&&Object.keys(e).forEach(function(n){e[n].forEach(function(o){t[String(o)]=n})}),t}function kw(e,t){if(t=t||{},Object.keys(t).forEach(function(n){if(ww.indexOf(n)===-1)throw new rn('Unknown option "'+n+'" is met in definition of "'+e+'" YAML type.')}),this.options=t,this.tag=e,this.kind=t.kind||null,this.resolve=t.resolve||function(){return!0},this.construct=t.construct||function(n){return n},this.instanceOf=t.instanceOf||null,this.predicate=t.predicate||null,this.represent=t.represent||null,this.representName=t.representName||null,this.defaultStyle=t.defaultStyle||null,this.multi=t.multi||!1,this.styleAliases=Cw(t.styleAliases||null),bw.indexOf(this.kind)===-1)throw new rn('Unknown kind "'+this.kind+'" is specified for "'+e+'" YAML type.')}var Vt=kw;function dc(e,t){var n=[];return e[t].forEach(function(o){var s=n.length;n.forEach(function(a,i){a.tag===o.tag&&a.kind===o.kind&&a.multi===o.multi&&(s=i)}),n[s]=o}),n}function Sw(){var e={scalar:{},sequence:{},mapping:{},fallback:{},multi:{scalar:[],sequence:[],mapping:[],fallback:[]}},t,n;function o(s){s.multi?(e.multi[s.kind].push(s),e.multi.fallback.push(s)):e[s.kind][s.tag]=e.fallback[s.tag]=s}for(t=0,n=arguments.length;t<n;t+=1)arguments[t].forEach(o);return e}function ta(e){return this.extend(e)}ta.prototype.extend=function(t){var n=[],o=[];if(t instanceof Vt)o.push(t);else if(Array.isArray(t))o=o.concat(t);else if(t&&(Array.isArray(t.implicit)||Array.isArray(t.explicit)))t.implicit&&(n=n.concat(t.implicit)),t.explicit&&(o=o.concat(t.explicit));else throw new rn("Schema.extend argument should be a Type, [ Type ], or a schema definition ({ implicit: [...], explicit: [...] })");n.forEach(function(a){if(!(a instanceof Vt))throw new rn("Specified list of YAML types (or a single Type object) contains a non-Type object.");if(a.loadKind&&a.loadKind!=="scalar")throw new rn("There is a non-scalar type in the implicit list of a schema. Implicit resolving of such types is not supported.");if(a.multi)throw new rn("There is a multi type in the implicit list of a schema. Multi tags can only be listed as explicit.")}),o.forEach(function(a){if(!(a instanceof Vt))throw new rn("Specified list of YAML types (or a single Type object) contains a non-Type object.")});var s=Object.create(ta.prototype);return s.implicit=(this.implicit||[]).concat(n),s.explicit=(this.explicit||[]).concat(o),s.compiledImplicit=dc(s,"implicit"),s.compiledExplicit=dc(s,"explicit"),s.compiledTypeMap=Sw(s.compiledImplicit,s.compiledExplicit),s};var jw=ta,Iw=new Vt("tag:yaml.org,2002:str",{kind:"scalar",construct:function(e){return e!==null?e:""}}),Mw=new Vt("tag:yaml.org,2002:seq",{kind:"sequence",construct:function(e){return e!==null?e:[]}}),Ew=new Vt("tag:yaml.org,2002:map",{kind:"mapping",construct:function(e){return e!==null?e:{}}}),Pw=new jw({explicit:[Iw,Mw,Ew]});function Lw(e){if(e===null)return!0;var t=e.length;return t===1&&e==="~"||t===4&&(e==="null"||e==="Null"||e==="NULL")}function _w(){return null}function Aw(e){return e===null}var Nw=new Vt("tag:yaml.org,2002:null",{kind:"scalar",resolve:Lw,construct:_w,predicate:Aw,represent:{canonical:function(){return"~"},lowercase:function(){return"null"},uppercase:function(){return"NULL"},camelcase:function(){return"Null"},empty:function(){return""}},defaultStyle:"lowercase"});function Rw(e){if(e===null)return!1;var t=e.length;return t===4&&(e==="true"||e==="True"||e==="TRUE")||t===5&&(e==="false"||e==="False"||e==="FALSE")}function Fw(e){return e==="true"||e==="True"||e==="TRUE"}function Tw(e){return Object.prototype.toString.call(e)==="[object Boolean]"}var Dw=new Vt("tag:yaml.org,2002:bool",{kind:"scalar",resolve:Rw,construct:Fw,predicate:Tw,represent:{lowercase:function(e){return e?"true":"false"},uppercase:function(e){return e?"TRUE":"FALSE"},camelcase:function(e){return e?"True":"False"}},defaultStyle:"lowercase"});function zw(e){return 48<=e&&e<=57||65<=e&&e<=70||97<=e&&e<=102}function Ow(e){return 48<=e&&e<=55}function $w(e){return 48<=e&&e<=57}function Bw(e){if(e===null)return!1;var t=e.length,n=0,o=!1,s;if(!t)return!1;if(s=e[n],(s==="-"||s==="+")&&(s=e[++n]),s==="0"){if(n+1===t)return!0;if(s=e[++n],s==="b"){for(n++;n<t;n++)if(s=e[n],s!=="_"){if(s!=="0"&&s!=="1")return!1;o=!0}return o&&s!=="_"}if(s==="x"){for(n++;n<t;n++)if(s=e[n],s!=="_"){if(!zw(e.charCodeAt(n)))return!1;o=!0}return o&&s!=="_"}if(s==="o"){for(n++;n<t;n++)if(s=e[n],s!=="_"){if(!Ow(e.charCodeAt(n)))return!1;o=!0}return o&&s!=="_"}}if(s==="_")return!1;for(;n<t;n++)if(s=e[n],s!=="_"){if(!$w(e.charCodeAt(n)))return!1;o=!0}return!(!o||s==="_")}function Uw(e){var t=e,n=1,o;if(t.indexOf("_")!==-1&&(t=t.replace(/_/g,"")),o=t[0],(o==="-"||o==="+")&&(o==="-"&&(n=-1),t=t.slice(1),o=t[0]),t==="0")return 0;if(o==="0"){if(t[1]==="b")return n*parseInt(t.slice(2),2);if(t[1]==="x")return n*parseInt(t.slice(2),16);if(t[1]==="o")return n*parseInt(t.slice(2),8)}return n*parseInt(t,10)}function Ww(e){return Object.prototype.toString.call(e)==="[object Number]"&&e%1===0&&!Pt.isNegativeZero(e)}var Hw=new Vt("tag:yaml.org,2002:int",{kind:"scalar",resolve:Bw,construct:Uw,predicate:Ww,represent:{binary:function(e){return e>=0?"0b"+e.toString(2):"-0b"+e.toString(2).slice(1)},octal:function(e){return e>=0?"0o"+e.toString(8):"-0o"+e.toString(8).slice(1)},decimal:function(e){return e.toString(10)},hexadecimal:function(e){return e>=0?"0x"+e.toString(16).toUpperCase():"-0x"+e.toString(16).toUpperCase().slice(1)}},defaultStyle:"decimal",styleAliases:{binary:[2,"bin"],octal:[8,"oct"],decimal:[10,"dec"],hexadecimal:[16,"hex"]}}),Zw=new RegExp("^(?:[-+]?(?:[0-9][0-9_]*)(?:\\.[0-9_]*)?(?:[eE][-+]?[0-9]+)?|\\.[0-9_]+(?:[eE][-+]?[0-9]+)?|[-+]?\\.(?:inf|Inf|INF)|\\.(?:nan|NaN|NAN))$");function Vw(e){return!(e===null||!Zw.test(e)||e[e.length-1]==="_")}function Gw(e){var t,n;return t=e.replace(/_/g,"").toLowerCase(),n=t[0]==="-"?-1:1,"+-".indexOf(t[0])>=0&&(t=t.slice(1)),t===".inf"?n===1?Number.POSITIVE_INFINITY:Number.NEGATIVE_INFINITY:t===".nan"?NaN:n*parseFloat(t,10)}var Yw=/^[-+]?[0-9]+e/;function qw(e,t){var n;if(isNaN(e))switch(t){case"lowercase":return".nan";case"uppercase":return".NAN";case"camelcase":return".NaN"}else if(Number.POSITIVE_INFINITY===e)switch(t){case"lowercase":return".inf";case"uppercase":return".INF";case"camelcase":return".Inf"}else if(Number.NEGATIVE_INFINITY===e)switch(t){case"lowercase":return"-.inf";case"uppercase":return"-.INF";case"camelcase":return"-.Inf"}else if(Pt.isNegativeZero(e))return"-0.0";return n=e.toString(10),Yw.test(n)?n.replace("e",".e"):n}function Xw(e){return Object.prototype.toString.call(e)==="[object Number]"&&(e%1!==0||Pt.isNegativeZero(e))}var Kw=new Vt("tag:yaml.org,2002:float",{kind:"scalar",resolve:Vw,construct:Gw,predicate:Xw,represent:qw,defaultStyle:"lowercase"}),Qw=Pw.extend({implicit:[Nw,Dw,Hw,Kw]}),Jw=Qw,Vd=new RegExp("^([0-9][0-9][0-9][0-9])-([0-9][0-9])-([0-9][0-9])$"),Gd=new RegExp("^([0-9][0-9][0-9][0-9])-([0-9][0-9]?)-([0-9][0-9]?)(?:[Tt]|[ \\t]+)([0-9][0-9]?):([0-9][0-9]):([0-9][0-9])(?:\\.([0-9]*))?(?:[ \\t]*(Z|([-+])([0-9][0-9]?)(?::([0-9][0-9]))?))?$");function eb(e){return e===null?!1:Vd.exec(e)!==null||Gd.exec(e)!==null}function tb(e){var t,n,o,s,a,i,l,c=0,d=null,u,f,p;if(t=Vd.exec(e),t===null&&(t=Gd.exec(e)),t===null)throw new Error("Date resolve error");if(n=+t[1],o=+t[2]-1,s=+t[3],!t[4])return new Date(Date.UTC(n,o,s));if(a=+t[4],i=+t[5],l=+t[6],t[7]){for(c=t[7].slice(0,3);c.length<3;)c+="0";c=+c}return t[9]&&(u=+t[10],f=+(t[11]||0),d=(u*60+f)*6e4,t[9]==="-"&&(d=-d)),p=new Date(Date.UTC(n,o,s,a,i,l,c)),d&&p.setTime(p.getTime()-d),p}function nb(e){return e.toISOString()}var ob=new Vt("tag:yaml.org,2002:timestamp",{kind:"scalar",resolve:eb,construct:tb,instanceOf:Date,represent:nb});function rb(e){return e==="<<"||e===null}var sb=new Vt("tag:yaml.org,2002:merge",{kind:"scalar",resolve:rb}),Ba=`ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=
\r`;function ib(e){if(e===null)return!1;var t,n,o=0,s=e.length,a=Ba;for(n=0;n<s;n++)if(t=a.indexOf(e.charAt(n)),!(t>64)){if(t<0)return!1;o+=6}return o%8===0}function ab(e){var t,n,o=e.replace(/[\r\n=]/g,""),s=o.length,a=Ba,i=0,l=[];for(t=0;t<s;t++)t%4===0&&t&&(l.push(i>>16&255),l.push(i>>8&255),l.push(i&255)),i=i<<6|a.indexOf(o.charAt(t));return n=s%4*6,n===0?(l.push(i>>16&255),l.push(i>>8&255),l.push(i&255)):n===18?(l.push(i>>10&255),l.push(i>>2&255)):n===12&&l.push(i>>4&255),new Uint8Array(l)}function lb(e){var t="",n=0,o,s,a=e.length,i=Ba;for(o=0;o<a;o++)o%3===0&&o&&(t+=i[n>>18&63],t+=i[n>>12&63],t+=i[n>>6&63],t+=i[n&63]),n=(n<<8)+e[o];return s=a%3,s===0?(t+=i[n>>18&63],t+=i[n>>12&63],t+=i[n>>6&63],t+=i[n&63]):s===2?(t+=i[n>>10&63],t+=i[n>>4&63],t+=i[n<<2&63],t+=i[64]):s===1&&(t+=i[n>>2&63],t+=i[n<<4&63],t+=i[64],t+=i[64]),t}function cb(e){return Object.prototype.toString.call(e)==="[object Uint8Array]"}var ub=new Vt("tag:yaml.org,2002:binary",{kind:"scalar",resolve:ib,construct:ab,predicate:cb,represent:lb}),db=Object.prototype.hasOwnProperty,fb=Object.prototype.toString;function hb(e){if(e===null)return!0;var t=[],n,o,s,a,i,l=e;for(n=0,o=l.length;n<o;n+=1){if(s=l[n],i=!1,fb.call(s)!=="[object Object]")return!1;for(a in s)if(db.call(s,a))if(!i)i=!0;else return!1;if(!i)return!1;if(t.indexOf(a)===-1)t.push(a);else return!1}return!0}function mb(e){return e!==null?e:[]}var pb=new Vt("tag:yaml.org,2002:omap",{kind:"sequence",resolve:hb,construct:mb}),gb=Object.prototype.toString;function xb(e){if(e===null)return!0;var t,n,o,s,a,i=e;for(a=new Array(i.length),t=0,n=i.length;t<n;t+=1){if(o=i[t],gb.call(o)!=="[object Object]"||(s=Object.keys(o),s.length!==1))return!1;a[t]=[s[0],o[s[0]]]}return!0}function yb(e){if(e===null)return[];var t,n,o,s,a,i=e;for(a=new Array(i.length),t=0,n=i.length;t<n;t+=1)o=i[t],s=Object.keys(o),a[t]=[s[0],o[s[0]]];return a}var vb=new Vt("tag:yaml.org,2002:pairs",{kind:"sequence",resolve:xb,construct:yb}),wb=Object.prototype.hasOwnProperty;function bb(e){if(e===null)return!0;var t,n=e;for(t in n)if(wb.call(n,t)&&n[t]!==null)return!1;return!0}function Cb(e){return e!==null?e:{}}var kb=new Vt("tag:yaml.org,2002:set",{kind:"mapping",resolve:bb,construct:Cb}),Yd=Jw.extend({implicit:[ob,sb],explicit:[ub,pb,vb,kb]}),lo=Object.prototype.hasOwnProperty,Fs=1,qd=2,Xd=3,Ts=4,bi=1,Sb=2,fc=3,jb=/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F-\x84\x86-\x9F\uFFFE\uFFFF]|[\uD800-\uDBFF](?![\uDC00-\uDFFF])|(?:[^\uD800-\uDBFF]|^)[\uDC00-\uDFFF]/,Ib=/[\x85\u2028\u2029]/,Mb=/[,\[\]\{\}]/,Kd=/^(?:!|!!|![a-z\-]+!)$/i,Qd=/^(?:!|[^,\[\]\{\}])(?:%[0-9a-f]{2}|[0-9a-z\-#;\/\?:@&=\+\$,_\.!~\*'\(\)\[\]])*$/i;function hc(e){return Object.prototype.toString.call(e)}function On(e){return e===10||e===13}function xo(e){return e===9||e===32}function sn(e){return e===9||e===32||e===10||e===13}function zo(e){return e===44||e===91||e===93||e===123||e===125}function Eb(e){var t;return 48<=e&&e<=57?e-48:(t=e|32,97<=t&&t<=102?t-97+10:-1)}function Pb(e){return e===120?2:e===117?4:e===85?8:0}function Lb(e){return 48<=e&&e<=57?e-48:-1}function mc(e){return e===48?"\0":e===97?"\x07":e===98?"\b":e===116||e===9?"	":e===110?`
`:e===118?"\v":e===102?"\f":e===114?"\r":e===101?"\x1B":e===32?" ":e===34?'"':e===47?"/":e===92?"\\":e===78?"Â…":e===95?"Â ":e===76?"\u2028":e===80?"\u2029":""}function _b(e){return e<=65535?String.fromCharCode(e):String.fromCharCode((e-65536>>10)+55296,(e-65536&1023)+56320)}function Jd(e,t,n){t==="__proto__"?Object.defineProperty(e,t,{configurable:!0,enumerable:!0,writable:!0,value:n}):e[t]=n}var ef=new Array(256),tf=new Array(256);for(var _o=0;_o<256;_o++)ef[_o]=mc(_o)?1:0,tf[_o]=mc(_o);function Ab(e,t){this.input=e,this.filename=t.filename||null,this.schema=t.schema||Yd,this.onWarning=t.onWarning||null,this.legacy=t.legacy||!1,this.json=t.json||!1,this.listener=t.listener||null,this.implicitTypes=this.schema.compiledImplicit,this.typeMap=this.schema.compiledTypeMap,this.length=e.length,this.position=0,this.line=0,this.lineStart=0,this.lineIndent=0,this.firstTabInLine=-1,this.documents=[]}function nf(e,t){var n={name:e.filename,buffer:e.input.slice(0,-1),position:e.position,line:e.line,column:e.position-e.lineStart};return n.snippet=vw(n),new rn(t,n)}function je(e,t){throw nf(e,t)}function Ds(e,t){e.onWarning&&e.onWarning.call(null,nf(e,t))}var pc={YAML:function(t,n,o){var s,a,i;t.version!==null&&je(t,"duplication of %YAML directive"),o.length!==1&&je(t,"YAML directive accepts exactly one argument"),s=/^([0-9]+)\.([0-9]+)$/.exec(o[0]),s===null&&je(t,"ill-formed argument of the YAML directive"),a=parseInt(s[1],10),i=parseInt(s[2],10),a!==1&&je(t,"unacceptable YAML version of the document"),t.version=o[0],t.checkLineBreaks=i<2,i!==1&&i!==2&&Ds(t,"unsupported YAML version of the document")},TAG:function(t,n,o){var s,a;o.length!==2&&je(t,"TAG directive accepts exactly two arguments"),s=o[0],a=o[1],Kd.test(s)||je(t,"ill-formed tag handle (first argument) of the TAG directive"),lo.call(t.tagMap,s)&&je(t,'there is a previously declared suffix for "'+s+'" tag handle'),Qd.test(a)||je(t,"ill-formed tag prefix (second argument) of the TAG directive");try{a=decodeURIComponent(a)}catch{je(t,"tag prefix is malformed: "+a)}t.tagMap[s]=a}};function ro(e,t,n,o){var s,a,i,l;if(t<n){if(l=e.input.slice(t,n),o)for(s=0,a=l.length;s<a;s+=1)i=l.charCodeAt(s),i===9||32<=i&&i<=1114111||je(e,"expected valid JSON character");else jb.test(l)&&je(e,"the stream contains non-printable characters");e.result+=l}}function gc(e,t,n,o){var s,a,i,l;for(Pt.isObject(n)||je(e,"cannot merge mappings; the provided source object is unacceptable"),s=Object.keys(n),i=0,l=s.length;i<l;i+=1)a=s[i],lo.call(t,a)||(Jd(t,a,n[a]),o[a]=!0)}function Oo(e,t,n,o,s,a,i,l,c){var d,u;if(Array.isArray(s))for(s=Array.prototype.slice.call(s),d=0,u=s.length;d<u;d+=1)Array.isArray(s[d])&&je(e,"nested arrays are not supported inside keys"),typeof s=="object"&&hc(s[d])==="[object Object]"&&(s[d]="[object Object]");if(typeof s=="object"&&hc(s)==="[object Object]"&&(s="[object Object]"),s=String(s),t===null&&(t={}),o==="tag:yaml.org,2002:merge")if(Array.isArray(a))for(d=0,u=a.length;d<u;d+=1)gc(e,t,a[d],n);else gc(e,t,a,n);else!e.json&&!lo.call(n,s)&&lo.call(t,s)&&(e.line=i||e.line,e.lineStart=l||e.lineStart,e.position=c||e.position,je(e,"duplicated mapping key")),Jd(t,s,a),delete n[s];return t}function Ua(e){var t;t=e.input.charCodeAt(e.position),t===10?e.position++:t===13?(e.position++,e.input.charCodeAt(e.position)===10&&e.position++):je(e,"a line break is expected"),e.line+=1,e.lineStart=e.position,e.firstTabInLine=-1}function It(e,t,n){for(var o=0,s=e.input.charCodeAt(e.position);s!==0;){for(;xo(s);)s===9&&e.firstTabInLine===-1&&(e.firstTabInLine=e.position),s=e.input.charCodeAt(++e.position);if(t&&s===35)do s=e.input.charCodeAt(++e.position);while(s!==10&&s!==13&&s!==0);if(On(s))for(Ua(e),s=e.input.charCodeAt(e.position),o++,e.lineIndent=0;s===32;)e.lineIndent++,s=e.input.charCodeAt(++e.position);else break}return n!==-1&&o!==0&&e.lineIndent<n&&Ds(e,"deficient indentation"),o}function Ks(e){var t=e.position,n;return n=e.input.charCodeAt(t),!!((n===45||n===46)&&n===e.input.charCodeAt(t+1)&&n===e.input.charCodeAt(t+2)&&(t+=3,n=e.input.charCodeAt(t),n===0||sn(n)))}function Wa(e,t){t===1?e.result+=" ":t>1&&(e.result+=Pt.repeat(`
`,t-1))}function Nb(e,t,n){var o,s,a,i,l,c,d,u,f=e.kind,p=e.result,g;if(g=e.input.charCodeAt(e.position),sn(g)||zo(g)||g===35||g===38||g===42||g===33||g===124||g===62||g===39||g===34||g===37||g===64||g===96||(g===63||g===45)&&(s=e.input.charCodeAt(e.position+1),sn(s)||n&&zo(s)))return!1;for(e.kind="scalar",e.result="",a=i=e.position,l=!1;g!==0;){if(g===58){if(s=e.input.charCodeAt(e.position+1),sn(s)||n&&zo(s))break}else if(g===35){if(o=e.input.charCodeAt(e.position-1),sn(o))break}else{if(e.position===e.lineStart&&Ks(e)||n&&zo(g))break;if(On(g))if(c=e.line,d=e.lineStart,u=e.lineIndent,It(e,!1,-1),e.lineIndent>=t){l=!0,g=e.input.charCodeAt(e.position);continue}else{e.position=i,e.line=c,e.lineStart=d,e.lineIndent=u;break}}l&&(ro(e,a,i,!1),Wa(e,e.line-c),a=i=e.position,l=!1),xo(g)||(i=e.position+1),g=e.input.charCodeAt(++e.position)}return ro(e,a,i,!1),e.result?!0:(e.kind=f,e.result=p,!1)}function Rb(e,t){var n,o,s;if(n=e.input.charCodeAt(e.position),n!==39)return!1;for(e.kind="scalar",e.result="",e.position++,o=s=e.position;(n=e.input.charCodeAt(e.position))!==0;)if(n===39)if(ro(e,o,e.position,!0),n=e.input.charCodeAt(++e.position),n===39)o=e.position,e.position++,s=e.position;else return!0;else On(n)?(ro(e,o,s,!0),Wa(e,It(e,!1,t)),o=s=e.position):e.position===e.lineStart&&Ks(e)?je(e,"unexpected end of the document within a single quoted scalar"):(e.position++,s=e.position);je(e,"unexpected end of the stream within a single quoted scalar")}function Fb(e,t){var n,o,s,a,i,l;if(l=e.input.charCodeAt(e.position),l!==34)return!1;for(e.kind="scalar",e.result="",e.position++,n=o=e.position;(l=e.input.charCodeAt(e.position))!==0;){if(l===34)return ro(e,n,e.position,!0),e.position++,!0;if(l===92){if(ro(e,n,e.position,!0),l=e.input.charCodeAt(++e.position),On(l))It(e,!1,t);else if(l<256&&ef[l])e.result+=tf[l],e.position++;else if((i=Pb(l))>0){for(s=i,a=0;s>0;s--)l=e.input.charCodeAt(++e.position),(i=Eb(l))>=0?a=(a<<4)+i:je(e,"expected hexadecimal character");e.result+=_b(a),e.position++}else je(e,"unknown escape sequence");n=o=e.position}else On(l)?(ro(e,n,o,!0),Wa(e,It(e,!1,t)),n=o=e.position):e.position===e.lineStart&&Ks(e)?je(e,"unexpected end of the document within a double quoted scalar"):(e.position++,o=e.position)}je(e,"unexpected end of the stream within a double quoted scalar")}function Tb(e,t){var n=!0,o,s,a,i=e.tag,l,c=e.anchor,d,u,f,p,g,y=Object.create(null),v,w,x,m;if(m=e.input.charCodeAt(e.position),m===91)u=93,g=!1,l=[];else if(m===123)u=125,g=!0,l={};else return!1;for(e.anchor!==null&&(e.anchorMap[e.anchor]=l),m=e.input.charCodeAt(++e.position);m!==0;){if(It(e,!0,t),m=e.input.charCodeAt(e.position),m===u)return e.position++,e.tag=i,e.anchor=c,e.kind=g?"mapping":"sequence",e.result=l,!0;n?m===44&&je(e,"expected the node content, but found ','"):je(e,"missed comma between flow collection entries"),w=v=x=null,f=p=!1,m===63&&(d=e.input.charCodeAt(e.position+1),sn(d)&&(f=p=!0,e.position++,It(e,!0,t))),o=e.line,s=e.lineStart,a=e.position,Xo(e,t,Fs,!1,!0),w=e.tag,v=e.result,It(e,!0,t),m=e.input.charCodeAt(e.position),(p||e.line===o)&&m===58&&(f=!0,m=e.input.charCodeAt(++e.position),It(e,!0,t),Xo(e,t,Fs,!1,!0),x=e.result),g?Oo(e,l,y,w,v,x,o,s,a):f?l.push(Oo(e,null,y,w,v,x,o,s,a)):l.push(v),It(e,!0,t),m=e.input.charCodeAt(e.position),m===44?(n=!0,m=e.input.charCodeAt(++e.position)):n=!1}je(e,"unexpected end of the stream within a flow collection")}function Db(e,t){var n,o,s=bi,a=!1,i=!1,l=t,c=0,d=!1,u,f;if(f=e.input.charCodeAt(e.position),f===124)o=!1;else if(f===62)o=!0;else return!1;for(e.kind="scalar",e.result="";f!==0;)if(f=e.input.charCodeAt(++e.position),f===43||f===45)bi===s?s=f===43?fc:Sb:je(e,"repeat of a chomping mode identifier");else if((u=Lb(f))>=0)u===0?je(e,"bad explicit indentation width of a block scalar; it cannot be less than one"):i?je(e,"repeat of an indentation width identifier"):(l=t+u-1,i=!0);else break;if(xo(f)){do f=e.input.charCodeAt(++e.position);while(xo(f));if(f===35)do f=e.input.charCodeAt(++e.position);while(!On(f)&&f!==0)}for(;f!==0;){for(Ua(e),e.lineIndent=0,f=e.input.charCodeAt(e.position);(!i||e.lineIndent<l)&&f===32;)e.lineIndent++,f=e.input.charCodeAt(++e.position);if(!i&&e.lineIndent>l&&(l=e.lineIndent),On(f)){c++;continue}if(e.lineIndent<l){s===fc?e.result+=Pt.repeat(`
`,a?1+c:c):s===bi&&a&&(e.result+=`
`);break}for(o?xo(f)?(d=!0,e.result+=Pt.repeat(`
`,a?1+c:c)):d?(d=!1,e.result+=Pt.repeat(`
`,c+1)):c===0?a&&(e.result+=" "):e.result+=Pt.repeat(`
`,c):e.result+=Pt.repeat(`
`,a?1+c:c),a=!0,i=!0,c=0,n=e.position;!On(f)&&f!==0;)f=e.input.charCodeAt(++e.position);ro(e,n,e.position,!1)}return!0}function xc(e,t){var n,o=e.tag,s=e.anchor,a=[],i,l=!1,c;if(e.firstTabInLine!==-1)return!1;for(e.anchor!==null&&(e.anchorMap[e.anchor]=a),c=e.input.charCodeAt(e.position);c!==0&&(e.firstTabInLine!==-1&&(e.position=e.firstTabInLine,je(e,"tab characters must not be used in indentation")),!(c!==45||(i=e.input.charCodeAt(e.position+1),!sn(i))));){if(l=!0,e.position++,It(e,!0,-1)&&e.lineIndent<=t){a.push(null),c=e.input.charCodeAt(e.position);continue}if(n=e.line,Xo(e,t,Xd,!1,!0),a.push(e.result),It(e,!0,-1),c=e.input.charCodeAt(e.position),(e.line===n||e.lineIndent>t)&&c!==0)je(e,"bad indentation of a sequence entry");else if(e.lineIndent<t)break}return l?(e.tag=o,e.anchor=s,e.kind="sequence",e.result=a,!0):!1}function zb(e,t,n){var o,s,a,i,l,c,d=e.tag,u=e.anchor,f={},p=Object.create(null),g=null,y=null,v=null,w=!1,x=!1,m;if(e.firstTabInLine!==-1)return!1;for(e.anchor!==null&&(e.anchorMap[e.anchor]=f),m=e.input.charCodeAt(e.position);m!==0;){if(!w&&e.firstTabInLine!==-1&&(e.position=e.firstTabInLine,je(e,"tab characters must not be used in indentation")),o=e.input.charCodeAt(e.position+1),a=e.line,(m===63||m===58)&&sn(o))m===63?(w&&(Oo(e,f,p,g,y,null,i,l,c),g=y=v=null),x=!0,w=!0,s=!0):w?(w=!1,s=!0):je(e,"incomplete explicit mapping pair; a key node is missed; or followed by a non-tabulated empty line"),e.position+=1,m=o;else{if(i=e.line,l=e.lineStart,c=e.position,!Xo(e,n,qd,!1,!0))break;if(e.line===a){for(m=e.input.charCodeAt(e.position);xo(m);)m=e.input.charCodeAt(++e.position);if(m===58)m=e.input.charCodeAt(++e.position),sn(m)||je(e,"a whitespace character is expected after the key-value separator within a block mapping"),w&&(Oo(e,f,p,g,y,null,i,l,c),g=y=v=null),x=!0,w=!1,s=!1,g=e.tag,y=e.result;else if(x)je(e,"can not read an implicit mapping pair; a colon is missed");else return e.tag=d,e.anchor=u,!0}else if(x)je(e,"can not read a block mapping entry; a multiline key may not be an implicit key");else return e.tag=d,e.anchor=u,!0}if((e.line===a||e.lineIndent>t)&&(w&&(i=e.line,l=e.lineStart,c=e.position),Xo(e,t,Ts,!0,s)&&(w?y=e.result:v=e.result),w||(Oo(e,f,p,g,y,v,i,l,c),g=y=v=null),It(e,!0,-1),m=e.input.charCodeAt(e.position)),(e.line===a||e.lineIndent>t)&&m!==0)je(e,"bad indentation of a mapping entry");else if(e.lineIndent<t)break}return w&&Oo(e,f,p,g,y,null,i,l,c),x&&(e.tag=d,e.anchor=u,e.kind="mapping",e.result=f),x}function Ob(e){var t,n=!1,o=!1,s,a,i;if(i=e.input.charCodeAt(e.position),i!==33)return!1;if(e.tag!==null&&je(e,"duplication of a tag property"),i=e.input.charCodeAt(++e.position),i===60?(n=!0,i=e.input.charCodeAt(++e.position)):i===33?(o=!0,s="!!",i=e.input.charCodeAt(++e.position)):s="!",t=e.position,n){do i=e.input.charCodeAt(++e.position);while(i!==0&&i!==62);e.position<e.length?(a=e.input.slice(t,e.position),i=e.input.charCodeAt(++e.position)):je(e,"unexpected end of the stream within a verbatim tag")}else{for(;i!==0&&!sn(i);)i===33&&(o?je(e,"tag suffix cannot contain exclamation marks"):(s=e.input.slice(t-1,e.position+1),Kd.test(s)||je(e,"named tag handle cannot contain such characters"),o=!0,t=e.position+1)),i=e.input.charCodeAt(++e.position);a=e.input.slice(t,e.position),Mb.test(a)&&je(e,"tag suffix cannot contain flow indicator characters")}a&&!Qd.test(a)&&je(e,"tag name cannot contain such characters: "+a);try{a=decodeURIComponent(a)}catch{je(e,"tag name is malformed: "+a)}return n?e.tag=a:lo.call(e.tagMap,s)?e.tag=e.tagMap[s]+a:s==="!"?e.tag="!"+a:s==="!!"?e.tag="tag:yaml.org,2002:"+a:je(e,'undeclared tag handle "'+s+'"'),!0}function $b(e){var t,n;if(n=e.input.charCodeAt(e.position),n!==38)return!1;for(e.anchor!==null&&je(e,"duplication of an anchor property"),n=e.input.charCodeAt(++e.position),t=e.position;n!==0&&!sn(n)&&!zo(n);)n=e.input.charCodeAt(++e.position);return e.position===t&&je(e,"name of an anchor node must contain at least one character"),e.anchor=e.input.slice(t,e.position),!0}function Bb(e){var t,n,o;if(o=e.input.charCodeAt(e.position),o!==42)return!1;for(o=e.input.charCodeAt(++e.position),t=e.position;o!==0&&!sn(o)&&!zo(o);)o=e.input.charCodeAt(++e.position);return e.position===t&&je(e,"name of an alias node must contain at least one character"),n=e.input.slice(t,e.position),lo.call(e.anchorMap,n)||je(e,'unidentified alias "'+n+'"'),e.result=e.anchorMap[n],It(e,!0,-1),!0}function Xo(e,t,n,o,s){var a,i,l,c=1,d=!1,u=!1,f,p,g,y,v,w;if(e.listener!==null&&e.listener("open",e),e.tag=null,e.anchor=null,e.kind=null,e.result=null,a=i=l=Ts===n||Xd===n,o&&It(e,!0,-1)&&(d=!0,e.lineIndent>t?c=1:e.lineIndent===t?c=0:e.lineIndent<t&&(c=-1)),c===1)for(;Ob(e)||$b(e);)It(e,!0,-1)?(d=!0,l=a,e.lineIndent>t?c=1:e.lineIndent===t?c=0:e.lineIndent<t&&(c=-1)):l=!1;if(l&&(l=d||s),(c===1||Ts===n)&&(Fs===n||qd===n?v=t:v=t+1,w=e.position-e.lineStart,c===1?l&&(xc(e,w)||zb(e,w,v))||Tb(e,v)?u=!0:(i&&Db(e,v)||Rb(e,v)||Fb(e,v)?u=!0:Bb(e)?(u=!0,(e.tag!==null||e.anchor!==null)&&je(e,"alias node should not have any properties")):Nb(e,v,Fs===n)&&(u=!0,e.tag===null&&(e.tag="?")),e.anchor!==null&&(e.anchorMap[e.anchor]=e.result)):c===0&&(u=l&&xc(e,w))),e.tag===null)e.anchor!==null&&(e.anchorMap[e.anchor]=e.result);else if(e.tag==="?"){for(e.result!==null&&e.kind!=="scalar"&&je(e,'unacceptable node kind for !<?> tag; it should be "scalar", not "'+e.kind+'"'),f=0,p=e.implicitTypes.length;f<p;f+=1)if(y=e.implicitTypes[f],y.resolve(e.result)){e.result=y.construct(e.result),e.tag=y.tag,e.anchor!==null&&(e.anchorMap[e.anchor]=e.result);break}}else if(e.tag!=="!"){if(lo.call(e.typeMap[e.kind||"fallback"],e.tag))y=e.typeMap[e.kind||"fallback"][e.tag];else for(y=null,g=e.typeMap.multi[e.kind||"fallback"],f=0,p=g.length;f<p;f+=1)if(e.tag.slice(0,g[f].tag.length)===g[f].tag){y=g[f];break}y||je(e,"unknown tag !<"+e.tag+">"),e.result!==null&&y.kind!==e.kind&&je(e,"unacceptable node kind for !<"+e.tag+'> tag; it should be "'+y.kind+'", not "'+e.kind+'"'),y.resolve(e.result,e.tag)?(e.result=y.construct(e.result,e.tag),e.anchor!==null&&(e.anchorMap[e.anchor]=e.result)):je(e,"cannot resolve a node with !<"+e.tag+"> explicit tag")}return e.listener!==null&&e.listener("close",e),e.tag!==null||e.anchor!==null||u}function Ub(e){var t=e.position,n,o,s,a=!1,i;for(e.version=null,e.checkLineBreaks=e.legacy,e.tagMap=Object.create(null),e.anchorMap=Object.create(null);(i=e.input.charCodeAt(e.position))!==0&&(It(e,!0,-1),i=e.input.charCodeAt(e.position),!(e.lineIndent>0||i!==37));){for(a=!0,i=e.input.charCodeAt(++e.position),n=e.position;i!==0&&!sn(i);)i=e.input.charCodeAt(++e.position);for(o=e.input.slice(n,e.position),s=[],o.length<1&&je(e,"directive name must not be less than one character in length");i!==0;){for(;xo(i);)i=e.input.charCodeAt(++e.position);if(i===35){do i=e.input.charCodeAt(++e.position);while(i!==0&&!On(i));break}if(On(i))break;for(n=e.position;i!==0&&!sn(i);)i=e.input.charCodeAt(++e.position);s.push(e.input.slice(n,e.position))}i!==0&&Ua(e),lo.call(pc,o)?pc[o](e,o,s):Ds(e,'unknown document directive "'+o+'"')}if(It(e,!0,-1),e.lineIndent===0&&e.input.charCodeAt(e.position)===45&&e.input.charCodeAt(e.position+1)===45&&e.input.charCodeAt(e.position+2)===45?(e.position+=3,It(e,!0,-1)):a&&je(e,"directives end mark is expected"),Xo(e,e.lineIndent-1,Ts,!1,!0),It(e,!0,-1),e.checkLineBreaks&&Ib.test(e.input.slice(t,e.position))&&Ds(e,"non-ASCII line breaks are interpreted as content"),e.documents.push(e.result),e.position===e.lineStart&&Ks(e)){e.input.charCodeAt(e.position)===46&&(e.position+=3,It(e,!0,-1));return}if(e.position<e.length-1)je(e,"end of the stream or a document separator is expected");else return}function Wb(e,t){e=String(e),t=t||{},e.length!==0&&(e.charCodeAt(e.length-1)!==10&&e.charCodeAt(e.length-1)!==13&&(e+=`
`),e.charCodeAt(0)===65279&&(e=e.slice(1)));var n=new Ab(e,t),o=e.indexOf("\0");for(o!==-1&&(n.position=o,je(n,"null byte is not allowed in input")),n.input+="\0";n.input.charCodeAt(n.position)===32;)n.lineIndent+=1,n.position+=1;for(;n.position<n.length-1;)Ub(n);return n.documents}function Hb(e,t){var n=Wb(e,t);if(n.length!==0){if(n.length===1)return n[0];throw new rn("expected a single document in the stream, but found more")}}var Zb=Hb,Vb={load:Zb},of=Object.prototype.toString,rf=Object.prototype.hasOwnProperty,Ha=65279,Gb=9,Er=10,Yb=13,qb=32,Xb=33,Kb=34,na=35,Qb=37,Jb=38,e1=39,t1=42,sf=44,n1=45,zs=58,o1=61,r1=62,s1=63,i1=64,af=91,lf=93,a1=96,cf=123,l1=124,uf=125,Gt={};Gt[0]="\\0";Gt[7]="\\a";Gt[8]="\\b";Gt[9]="\\t";Gt[10]="\\n";Gt[11]="\\v";Gt[12]="\\f";Gt[13]="\\r";Gt[27]="\\e";Gt[34]='\\"';Gt[92]="\\\\";Gt[133]="\\N";Gt[160]="\\_";Gt[8232]="\\L";Gt[8233]="\\P";var c1=["y","Y","yes","Yes","YES","on","On","ON","n","N","no","No","NO","off","Off","OFF"],u1=/^[-+]?[0-9_]+(?::[0-9_]+)+(?:\.[0-9_]*)?$/;function d1(e,t){var n,o,s,a,i,l,c;if(t===null)return{};for(n={},o=Object.keys(t),s=0,a=o.length;s<a;s+=1)i=o[s],l=String(t[i]),i.slice(0,2)==="!!"&&(i="tag:yaml.org,2002:"+i.slice(2)),c=e.compiledTypeMap.fallback[i],c&&rf.call(c.styleAliases,l)&&(l=c.styleAliases[l]),n[i]=l;return n}function f1(e){var t,n,o;if(t=e.toString(16).toUpperCase(),e<=255)n="x",o=2;else if(e<=65535)n="u",o=4;else if(e<=4294967295)n="U",o=8;else throw new rn("code point within a string may not be greater than 0xFFFFFFFF");return"\\"+n+Pt.repeat("0",o-t.length)+t}var h1=1,Pr=2;function m1(e){this.schema=e.schema||Yd,this.indent=Math.max(1,e.indent||2),this.noArrayIndent=e.noArrayIndent||!1,this.skipInvalid=e.skipInvalid||!1,this.flowLevel=Pt.isNothing(e.flowLevel)?-1:e.flowLevel,this.styleMap=d1(this.schema,e.styles||null),this.sortKeys=e.sortKeys||!1,this.lineWidth=e.lineWidth||80,this.noRefs=e.noRefs||!1,this.noCompatMode=e.noCompatMode||!1,this.condenseFlow=e.condenseFlow||!1,this.quotingType=e.quotingType==='"'?Pr:h1,this.forceQuotes=e.forceQuotes||!1,this.replacer=typeof e.replacer=="function"?e.replacer:null,this.implicitTypes=this.schema.compiledImplicit,this.explicitTypes=this.schema.compiledExplicit,this.tag=null,this.result="",this.duplicates=[],this.usedDuplicates=null}function yc(e,t){for(var n=Pt.repeat(" ",t),o=0,s=-1,a="",i,l=e.length;o<l;)s=e.indexOf(`
`,o),s===-1?(i=e.slice(o),o=l):(i=e.slice(o,s+1),o=s+1),i.length&&i!==`
`&&(a+=n),a+=i;return a}function oa(e,t){return`
`+Pt.repeat(" ",e.indent*t)}function p1(e,t){var n,o,s;for(n=0,o=e.implicitTypes.length;n<o;n+=1)if(s=e.implicitTypes[n],s.resolve(t))return!0;return!1}function Os(e){return e===qb||e===Gb}function Lr(e){return 32<=e&&e<=126||161<=e&&e<=55295&&e!==8232&&e!==8233||57344<=e&&e<=65533&&e!==Ha||65536<=e&&e<=1114111}function vc(e){return Lr(e)&&e!==Ha&&e!==Yb&&e!==Er}function wc(e,t,n){var o=vc(e),s=o&&!Os(e);return(n?o:o&&e!==sf&&e!==af&&e!==lf&&e!==cf&&e!==uf)&&e!==na&&!(t===zs&&!s)||vc(t)&&!Os(t)&&e===na||t===zs&&s}function g1(e){return Lr(e)&&e!==Ha&&!Os(e)&&e!==n1&&e!==s1&&e!==zs&&e!==sf&&e!==af&&e!==lf&&e!==cf&&e!==uf&&e!==na&&e!==Jb&&e!==t1&&e!==Xb&&e!==l1&&e!==o1&&e!==r1&&e!==e1&&e!==Kb&&e!==Qb&&e!==i1&&e!==a1}function x1(e){return!Os(e)&&e!==zs}function gr(e,t){var n=e.charCodeAt(t),o;return n>=55296&&n<=56319&&t+1<e.length&&(o=e.charCodeAt(t+1),o>=56320&&o<=57343)?(n-55296)*1024+o-56320+65536:n}function df(e){var t=/^\n* /;return t.test(e)}var ff=1,ra=2,hf=3,mf=4,Fo=5;function y1(e,t,n,o,s,a,i,l){var c,d=0,u=null,f=!1,p=!1,g=o!==-1,y=-1,v=g1(gr(e,0))&&x1(gr(e,e.length-1));if(t||i)for(c=0;c<e.length;d>=65536?c+=2:c++){if(d=gr(e,c),!Lr(d))return Fo;v=v&&wc(d,u,l),u=d}else{for(c=0;c<e.length;d>=65536?c+=2:c++){if(d=gr(e,c),d===Er)f=!0,g&&(p=p||c-y-1>o&&e[y+1]!==" ",y=c);else if(!Lr(d))return Fo;v=v&&wc(d,u,l),u=d}p=p||g&&c-y-1>o&&e[y+1]!==" "}return!f&&!p?v&&!i&&!s(e)?ff:a===Pr?Fo:ra:n>9&&df(e)?Fo:i?a===Pr?Fo:ra:p?mf:hf}function v1(e,t,n,o,s){e.dump=(function(){if(t.length===0)return e.quotingType===Pr?'""':"''";if(!e.noCompatMode&&(c1.indexOf(t)!==-1||u1.test(t)))return e.quotingType===Pr?'"'+t+'"':"'"+t+"'";var a=e.indent*Math.max(1,n),i=e.lineWidth===-1?-1:Math.max(Math.min(e.lineWidth,40),e.lineWidth-a),l=o||e.flowLevel>-1&&n>=e.flowLevel;function c(d){return p1(e,d)}switch(y1(t,l,e.indent,i,c,e.quotingType,e.forceQuotes&&!o,s)){case ff:return t;case ra:return"'"+t.replace(/'/g,"''")+"'";case hf:return"|"+bc(t,e.indent)+Cc(yc(t,a));case mf:return">"+bc(t,e.indent)+Cc(yc(w1(t,i),a));case Fo:return'"'+b1(t)+'"';default:throw new rn("impossible error: invalid scalar style")}})()}function bc(e,t){var n=df(e)?String(t):"",o=e[e.length-1]===`
`,s=o&&(e[e.length-2]===`
`||e===`
`),a=s?"+":o?"":"-";return n+a+`
`}function Cc(e){return e[e.length-1]===`
`?e.slice(0,-1):e}function w1(e,t){for(var n=/(\n+)([^\n]*)/g,o=(function(){var d=e.indexOf(`
`);return d=d!==-1?d:e.length,n.lastIndex=d,kc(e.slice(0,d),t)})(),s=e[0]===`
`||e[0]===" ",a,i;i=n.exec(e);){var l=i[1],c=i[2];a=c[0]===" ",o+=l+(!s&&!a&&c!==""?`
`:"")+kc(c,t),s=a}return o}function kc(e,t){if(e===""||e[0]===" ")return e;for(var n=/ [^ ]/g,o,s=0,a,i=0,l=0,c="";o=n.exec(e);)l=o.index,l-s>t&&(a=i>s?i:l,c+=`
`+e.slice(s,a),s=a+1),i=l;return c+=`
`,e.length-s>t&&i>s?c+=e.slice(s,i)+`
`+e.slice(i+1):c+=e.slice(s),c.slice(1)}function b1(e){for(var t="",n=0,o,s=0;s<e.length;n>=65536?s+=2:s++)n=gr(e,s),o=Gt[n],!o&&Lr(n)?(t+=e[s],n>=65536&&(t+=e[s+1])):t+=o||f1(n);return t}function C1(e,t,n){var o="",s=e.tag,a,i,l;for(a=0,i=n.length;a<i;a+=1)l=n[a],e.replacer&&(l=e.replacer.call(n,String(a),l)),(Kn(e,t,l,!1,!1)||typeof l>"u"&&Kn(e,t,null,!1,!1))&&(o!==""&&(o+=","+(e.condenseFlow?"":" ")),o+=e.dump);e.tag=s,e.dump="["+o+"]"}function Sc(e,t,n,o){var s="",a=e.tag,i,l,c;for(i=0,l=n.length;i<l;i+=1)c=n[i],e.replacer&&(c=e.replacer.call(n,String(i),c)),(Kn(e,t+1,c,!0,!0,!1,!0)||typeof c>"u"&&Kn(e,t+1,null,!0,!0,!1,!0))&&((!o||s!=="")&&(s+=oa(e,t)),e.dump&&Er===e.dump.charCodeAt(0)?s+="-":s+="- ",s+=e.dump);e.tag=a,e.dump=s||"[]"}function k1(e,t,n){var o="",s=e.tag,a=Object.keys(n),i,l,c,d,u;for(i=0,l=a.length;i<l;i+=1)u="",o!==""&&(u+=", "),e.condenseFlow&&(u+='"'),c=a[i],d=n[c],e.replacer&&(d=e.replacer.call(n,c,d)),Kn(e,t,c,!1,!1)&&(e.dump.length>1024&&(u+="? "),u+=e.dump+(e.condenseFlow?'"':"")+":"+(e.condenseFlow?"":" "),Kn(e,t,d,!1,!1)&&(u+=e.dump,o+=u));e.tag=s,e.dump="{"+o+"}"}function S1(e,t,n,o){var s="",a=e.tag,i=Object.keys(n),l,c,d,u,f,p;if(e.sortKeys===!0)i.sort();else if(typeof e.sortKeys=="function")i.sort(e.sortKeys);else if(e.sortKeys)throw new rn("sortKeys must be a boolean or a function");for(l=0,c=i.length;l<c;l+=1)p="",(!o||s!=="")&&(p+=oa(e,t)),d=i[l],u=n[d],e.replacer&&(u=e.replacer.call(n,d,u)),Kn(e,t+1,d,!0,!0,!0)&&(f=e.tag!==null&&e.tag!=="?"||e.dump&&e.dump.length>1024,f&&(e.dump&&Er===e.dump.charCodeAt(0)?p+="?":p+="? "),p+=e.dump,f&&(p+=oa(e,t)),Kn(e,t+1,u,!0,f)&&(e.dump&&Er===e.dump.charCodeAt(0)?p+=":":p+=": ",p+=e.dump,s+=p));e.tag=a,e.dump=s||"{}"}function jc(e,t,n){var o,s,a,i,l,c;for(s=n?e.explicitTypes:e.implicitTypes,a=0,i=s.length;a<i;a+=1)if(l=s[a],(l.instanceOf||l.predicate)&&(!l.instanceOf||typeof t=="object"&&t instanceof l.instanceOf)&&(!l.predicate||l.predicate(t))){if(n?l.multi&&l.representName?e.tag=l.representName(t):e.tag=l.tag:e.tag="?",l.represent){if(c=e.styleMap[l.tag]||l.defaultStyle,of.call(l.represent)==="[object Function]")o=l.represent(t,c);else if(rf.call(l.represent,c))o=l.represent[c](t,c);else throw new rn("!<"+l.tag+'> tag resolver accepts not "'+c+'" style');e.dump=o}return!0}return!1}function Kn(e,t,n,o,s,a,i){e.tag=null,e.dump=n,jc(e,n,!1)||jc(e,n,!0);var l=of.call(e.dump),c=o,d;o&&(o=e.flowLevel<0||e.flowLevel>t);var u=l==="[object Object]"||l==="[object Array]",f,p;if(u&&(f=e.duplicates.indexOf(n),p=f!==-1),(e.tag!==null&&e.tag!=="?"||p||e.indent!==2&&t>0)&&(s=!1),p&&e.usedDuplicates[f])e.dump="*ref_"+f;else{if(u&&p&&!e.usedDuplicates[f]&&(e.usedDuplicates[f]=!0),l==="[object Object]")o&&Object.keys(e.dump).length!==0?(S1(e,t,e.dump,s),p&&(e.dump="&ref_"+f+e.dump)):(k1(e,t,e.dump),p&&(e.dump="&ref_"+f+" "+e.dump));else if(l==="[object Array]")o&&e.dump.length!==0?(e.noArrayIndent&&!i&&t>0?Sc(e,t-1,e.dump,s):Sc(e,t,e.dump,s),p&&(e.dump="&ref_"+f+e.dump)):(C1(e,t,e.dump),p&&(e.dump="&ref_"+f+" "+e.dump));else if(l==="[object String]")e.tag!=="?"&&v1(e,e.dump,t,a,c);else{if(l==="[object Undefined]")return!1;if(e.skipInvalid)return!1;throw new rn("unacceptable kind of an object to dump "+l)}e.tag!==null&&e.tag!=="?"&&(d=encodeURI(e.tag[0]==="!"?e.tag.slice(1):e.tag).replace(/!/g,"%21"),e.tag[0]==="!"?d="!"+d:d.slice(0,18)==="tag:yaml.org,2002:"?d="!!"+d.slice(18):d="!<"+d+">",e.dump=d+" "+e.dump)}return!0}function j1(e,t){var n=[],o=[],s,a;for(sa(e,n,o),s=0,a=o.length;s<a;s+=1)t.duplicates.push(n[o[s]]);t.usedDuplicates=new Array(a)}function sa(e,t,n){var o,s,a;if(e!==null&&typeof e=="object")if(s=t.indexOf(e),s!==-1)n.indexOf(s)===-1&&n.push(s);else if(t.push(e),Array.isArray(e))for(s=0,a=e.length;s<a;s+=1)sa(e[s],t,n);else for(o=Object.keys(e),s=0,a=o.length;s<a;s+=1)sa(e[o[s]],t,n)}function I1(e,t){t=t||{};var n=new m1(t);n.noRefs||j1(e,n);var o=e;return n.replacer&&(o=n.replacer.call({"":o},"",o)),Kn(n,0,o,!0,!0)?n.dump+`
`:""}var M1=I1,E1={dump:M1},P1=Vb.load,L1=E1.dump;function _1(e){return e.replace(/[A-Z]/g,t=>`_${t.toLowerCase()}`)}function A1(e){return e.replace(/_([a-z])/g,(t,n)=>n.toUpperCase())}function ia(e){if(e==null)return null;if(Array.isArray(e))return e.map(ia);if(typeof e=="object"){const t={};for(const[n,o]of Object.entries(e))t[_1(n)]=ia(o);return t}return typeof e=="string"||typeof e=="number"||typeof e=="boolean"?e:null}function aa(e){if(e==null)return null;if(Array.isArray(e))return e.map(aa);if(typeof e=="object"){const t={};for(const[n,o]of Object.entries(e))t[A1(n)]=aa(o);return t}return e}function pf(e){try{const t=P1(e);if(t==null)return{valid:!1,errors:[{path:"",message:"Empty configuration file"}],config:null};if(typeof t!="object")return{valid:!1,errors:[{path:"",message:"Configuration must be an object"}],config:null};const n=aa(t);return iw(n)}catch(t){return{valid:!1,errors:[{path:"",message:`YAML parse error: ${t instanceof Error?t.message:"Unknown YAML parse error"}`}],config:null}}}function Ic(e){const t=ia(e);return L1(t,{indent:2,lineWidth:120,noRefs:!0,sortKeys:!1,quotingType:'"'})}const N1={usePointCloudStore:Qe,useCameraStore:B,useUIStore:q,useExportStore:He};function gf(e){return N1[e].getState()}function R1(e,t){return e.type==="number"&&e.nullable&&t===1/0?null:t}function F1(e,t){return e.type==="number"&&e.nullable&&t===null?1/0:t}function T1(e){return`set${e.charAt(0).toUpperCase()}${e.slice(1)}`}function Mc(){const e={version:ud};for(const t of _a){const n=gf(t.storeHook),o={};for(const s of Aa(t)){const a=dd(s);o[s.key]=R1(s,n[a])}e[t.key]=o}return e}function xf(e){for(const t of _a){const n=e[t.key];if(!n)continue;const o=gf(t.storeHook);for(const s of Aa(t)){const a=n[s.key];if(a===void 0)continue;const i=dd(s),l=o[T1(i)];l&&l(F1(s,a))}}}let ur=null,Ci=null;function D1(){try{if(typeof WebAssembly=="object"&&typeof WebAssembly.instantiate=="function")return new WebAssembly.Module(new Uint8Array([0,97,115,109,1,0,0,0]))instanceof WebAssembly.Module}catch{}return!1}async function z1(){return Ci||ur||(D1()?(ur=(async()=>{try{const e="/v0.4.7/",t=`${e}wasm/colmap_wasm.js`,n=await fetch(t);if(!n.ok)throw new Error(`Failed to fetch WASM loader: ${n.status}`);const o=await n.text(),s=new Blob([o],{type:"application/javascript"}),a=URL.createObjectURL(s),i=await import(a);URL.revokeObjectURL(a);const l=i.default,c=await l({locateFile:d=>`${e}wasm/${d}`});return Ci=c,console.log("colmap-wasm module loaded successfully"),c}catch(e){return console.warn("Failed to load colmap-wasm module:",e),ur=null,null}})(),ur):(console.warn("WebAssembly is not supported in this browser"),null))}class O1{module=null;reconstruction=null;memoryVersion=0;cachedPositions=null;cachedColors=null;cachedErrors=null;cachedTrackLengths=null;imagesBuffer=null;async initialize(){return this.reconstruction?!0:(this.module=await z1(),this.module?(this.reconstruction=new this.module.Reconstruction,!0):!1)}get isReady(){return this.reconstruction!==null}get raw(){return this.reconstruction}invalidateCaches(){this.memoryVersion++,this.cachedPositions=null,this.cachedColors=null,this.cachedErrors=null,this.cachedTrackLengths=null}parsePoints3D(t){if(!this.reconstruction)throw new Error("WASM module not initialized");return this.invalidateCaches(),this.reconstruction.parsePoints3D(t)}parseImages(t){if(!this.reconstruction)throw new Error("WASM module not initialized");return this.invalidateCaches(),this.reconstruction.parseImages(t)}parseImagesLite(t){if(!this.reconstruction)throw new Error("WASM module not initialized");return this.invalidateCaches(),this.imagesBuffer=null,this.reconstruction.parseImagesLite(t)}parseImagesLazy(t){if(!this.reconstruction)throw new Error("WASM module not initialized");return this.invalidateCaches(),this.imagesBuffer=t,typeof this.reconstruction.parseImagesLazy=="function"?this.reconstruction.parseImagesLazy(t):(console.warn("[WASM] parseImagesLazy not available, falling back to parseImages"),this.reconstruction.parseImages(t))}isLazyMode(){return!this.reconstruction||typeof this.reconstruction.isLazyMode!="function"?!1:this.reconstruction.isLazyMode()}loadImagePoints2D(t){return!this.reconstruction||!this.imagesBuffer?null:this.reconstruction.isLazyMode()?this.reconstruction.loadImagePoints2DFromBuffer(t,this.imagesBuffer):this.getImagePoints2D(t)}parseCameras(t){if(!this.reconstruction)throw new Error("WASM module not initialized");return this.reconstruction.parseCameras(t)}parseRigs(t){if(!this.reconstruction)throw new Error("WASM module not initialized");return this.reconstruction.parseRigs(t)}parseFrames(t){if(!this.reconstruction)throw new Error("WASM module not initialized");return this.reconstruction.parseFrames(t)}clear(){this.reconstruction&&(this.reconstruction.clear(),this.invalidateCaches()),this.imagesBuffer=null}get pointCount(){return this.reconstruction?.getPointCount()??0}get imageCount(){return this.reconstruction?.getImageCount()??0}get cameraCount(){return this.reconstruction?.getCameraCount()??0}get rigCount(){return this.reconstruction?.getRigCount()??0}get frameCount(){return this.reconstruction?.getFrameCount()??0}hasPoints(){return this.pointCount>0}getPositions(){return this.reconstruction?(this.cachedPositions||(this.cachedPositions=this.reconstruction.getPositions()),this.cachedPositions):null}getPositionsCopy(){const t=this.getPositions();return t?new Float32Array(t):null}getColors(){return this.reconstruction?(this.cachedColors||(this.cachedColors=this.reconstruction.getColors()),this.cachedColors):null}getColorsCopy(){const t=this.getColors();return t?new Float32Array(t):null}getErrors(){return this.reconstruction?(this.cachedErrors||(this.cachedErrors=this.reconstruction.getErrors()),this.cachedErrors):null}getTrackLengths(){return this.reconstruction?(this.cachedTrackLengths||(this.cachedTrackLengths=this.reconstruction.getTrackLengths()),this.cachedTrackLengths):null}getImageQuaternions(){return this.reconstruction?.getImageQuaternions()??null}getImageTranslations(){return this.reconstruction?.getImageTranslations()??null}getTrackOffsets(){return this.reconstruction?.getTrackOffsets()??null}getTrackImageIds(){return this.reconstruction?.getTrackImageIds()??null}getTrackPoint2DIdxs(){return this.reconstruction?.getTrackPoint2DIdxs()??null}getPoint3DIds(){return this.reconstruction?.getPoint3DIds()??null}getPoints2DXY(){return this.reconstruction?.getPoints2DXY()??null}getPoints2DPoint3DIds(){return this.reconstruction?.getPoints2DPoint3DIds()??null}getPoints2DOffsets(){return this.reconstruction?.getPoints2DOffsets()??null}getNumPoints2DPerImage(){return this.reconstruction?.getNumPoints2DPerImage()??null}getBoundingBox(){return this.reconstruction?.getBoundingBox()??null}getStats(){return this.reconstruction?.getStats()??null}getCameraInfo(t){return this.reconstruction?.getCameraInfo(t)??null}getImageInfo(t){return this.reconstruction?.getImageInfo(t)??null}getAllCameras(){return this.reconstruction?.getAllCameras()??{}}getAllImageInfos(){return this.reconstruction?.getAllImageInfos()??[]}getRig(t){return this.reconstruction?.getRig(t)??null}getFrame(t){return this.reconstruction?.getFrame(t)??null}getAllRigs(){return this.reconstruction?.getAllRigs()??{}}getAllFrames(){return this.reconstruction?.getAllFrames()??{}}hasRigData(){return this.reconstruction?.hasRigData()??!1}getImagePoints2D(t){if(!this.reconstruction)return null;const n=this.reconstruction.getImagePoints2D(t);return n?{xy:n.xy,point3dIds:n.point3dIds,count:n.count}:null}getImagePoints2DArray(t){let n=null;if(this.isLazyMode()?n=this.loadImagePoints2D(t):n=this.getImagePoints2D(t),!n||n.count===0)return[];const o=[];for(let s=0;s<n.count;s++)o.push({xy:[n.xy[s*2],n.xy[s*2+1]],point3DId:n.point3dIds[s]});return o}buildPoints3DMap(){const t=new Map;if(!this.reconstruction)return t;const n=this.pointCount,o=this.getPositions(),s=this.getColors(),a=this.getErrors(),i=this.getTrackOffsets(),l=this.getTrackImageIds(),c=this.getTrackPoint2DIdxs(),d=this.getPoint3DIds();if(!o||!s||!a)return t;for(let u=0;u<n;u++){const f=d?d[u]:BigInt(u+1),p=[];if(i&&l&&c&&u<i.length-1){const g=i[u],y=i[u+1];for(let v=g;v<y;v++)p.push({imageId:l[v],point2DIdx:c[v]})}t.set(f,{point3DId:f,xyz:[o[u*3],o[u*3+1],o[u*3+2]],rgb:[Math.round(s[u*3]*255),Math.round(s[u*3+1]*255),Math.round(s[u*3+2]*255)],error:a[u],track:p})}return t}dispose(){this.reconstruction&&(this.reconstruction.delete(),this.reconstruction=null),this.invalidateCaches(),this.module=null,this.imagesBuffer=null}}async function $1(){const e=new O1;return await e.initialize()?e:null}async function B1(e,t,n,o,s){try{const a=await $1();if(!a)return console.warn("[WASM] Module not available, falling back to JS parser"),null;if(!e.name.endsWith(".bin")||!t.name.endsWith(".bin")||!n.name.endsWith(".bin"))return console.log("[WASM] Text files detected, using JS parser"),a.dispose(),null;const i=o&&s&&o.name.endsWith(".bin")&&s.name.endsWith(".bin"),l=performance.now(),[c,d,u]=await Promise.all([e.arrayBuffer(),t.arrayBuffer(),n.arrayBuffer()]),f=a.parseCameras(c),p=a.parseImagesLazy(d),g=a.parsePoints3D(u);if(!f||!p||!g)return console.warn("[WASM] Failed to parse some files, falling back to JS parser"),a.dispose(),null;const y=performance.now()-l;console.log(`[WASM] Parsed in ${y.toFixed(0)}ms: ${a.cameraCount} cameras, ${a.imageCount} images, ${a.pointCount} points`);const v=new Map,w=a.getAllCameras();for(const b of Object.values(w))v.set(b.cameraId,{cameraId:b.cameraId,modelId:b.modelId,width:b.width,height:b.height,params:b.params});const x=a.getNumPoints2DPerImage(),m=new Map,S=a.getAllImageInfos();for(let b=0;b<S.length;b++){const M=S[b],E=M.quaternion||[1,0,0,0],P=M.translation||[0,0,0],I=x&&b<x.length?x[b]:0;m.set(M.imageId,{imageId:M.imageId,cameraId:M.cameraId,name:M.name,qvec:[E[0],E[1],E[2],E[3]],tvec:[P[0],P[1],P[2]],points2D:[],numPoints2D:I})}let k;if(i&&o&&s)try{const[b,M]=await Promise.all([o.arrayBuffer(),s.arrayBuffer()]),E=a.parseRigs(b),P=a.parseFrames(M);if(E&&P&&a.hasRigData()){const I=new Map,R=a.getAllRigs();for(const F of Object.values(R)){const z=F.sensors.map(U=>{const D={sensorId:{type:U.sensorId.type,id:U.sensorId.id},hasPose:U.hasPose};return U.hasPose&&U.pose&&(D.pose={qvec:U.pose.qvec,tvec:U.pose.tvec}),D}),Z=F.refSensorId?{type:F.refSensorId.type,id:F.refSensorId.id}:null;I.set(F.rigId,{rigId:F.rigId,refSensorId:Z,sensors:z})}const A=new Map,G=a.getAllFrames();for(const F of Object.values(G)){const z=F.dataIds.map(Z=>({sensorId:{type:Z.sensorId.type,id:Z.sensorId.id},dataId:Z.dataId}));A.set(F.frameId,{frameId:F.frameId,rigId:F.rigId,rigFromWorld:{qvec:F.rigFromWorld.qvec,tvec:F.rigFromWorld.tvec},dataIds:z})}k={rigs:I,frames:A},console.log(`[WASM] Parsed rig data: ${I.size} rigs, ${A.size} frames`)}}catch(b){console.warn("[WASM] Failed to parse rig/frame files:",b)}const j=performance.now()-l-y;return console.log(`[WASM] Converted to JS Maps in ${j.toFixed(0)}ms`),{cameras:v,images:m,rigData:k,wasmWrapper:a}}catch(a){return console.warn("[WASM] Error during parsing, falling back to JS:",a),null}}function U1(e){for(const[,t]of e){const n=t.name.toLowerCase();if(n.endsWith(".yaml")||n.endsWith(".yml"))return t}return null}function W1(e){for(const[,t]of e){const n=t.name.toLowerCase();if(n==="cameras.bin"||n==="cameras.txt"||n==="images.bin"||n==="images.txt"||n==="points3d.bin"||n==="points3d.txt")return!0}return!1}function Ec(e){const t=[".jpg",".jpeg",".png",".gif",".bmp",".webp",".tiff",".tif"];for(const[,n]of e){const o=n.name.toLowerCase();if(t.some(s=>o.endsWith(s)))return!0}return!1}function H1(e){const s={cameraId:1,modelId:$e.PINHOLE,width:1920,height:1080,params:[1920,1920,960,540]},a=new Map;a.set(1,s);const i=new Map,l=new Map,c=new Set;for(const[,f]of e)c.add(f.name);let d=1;for(const f of c){const p={imageId:d,cameraId:1,name:f,qvec:[1,0,0,0],tvec:[0,0,0],points2D:[],numPoints2D:0};i.set(d,p),l.set(d,{numPoints3D:0,avgError:0,covisibleCount:0}),d++}return{cameras:a,images:i,imageStats:l,connectedImagesIndex:new Map,globalStats:{minError:0,maxError:0,avgError:0,minTrackLength:0,maxTrackLength:0,avgTrackLength:0,totalObservations:0,totalPoints:0},imageToPoint3DIds:new Map}}function Dr(){const{setReconstruction:e,setWasmReconstruction:t,setLoadedFiles:n,setDroppedFiles:o,setError:s,setSourceInfo:a,setUrlLoading:i,setUrlProgress:l}=ye(),c=q(x=>x.resetView),d=h.useCallback(async(x,m,S)=>{const k=m?`${m}/${x.name}`:x.name;try{if(x.isFile){const j=await new Promise((b,M)=>{x.file(b,M)});S.set(k,j)}else if(x.isDirectory){const j=x.createReader();let b=[],M;do M=await new Promise((P,I)=>{j.readEntries(P,I)}),b=b.concat(M);while(M.length>0);const E=50;for(let P=0;P<b.length;P+=E){const I=b.slice(P,P+E);await Promise.all(I.map(R=>d(R,k,S)))}}}catch(j){console.warn(`Failed to scan entry: ${k}`,j)}},[]),u=h.useCallback(x=>{const m=b=>{const M=b.lastIndexOf("/");return M>=0?b.substring(0,M):""},S=new Map;for(const[b,M]of x){const E=M.name.toLowerCase(),P=m(b);S.has(P)||S.set(P,{});const I=S.get(P);E==="cameras.bin"||E==="cameras.txt"&&!I.cameras?.name.endsWith(".bin")?I.cameras=M:E==="images.bin"||E==="images.txt"&&!I.images?.name.endsWith(".bin")?I.images=M:E==="points3d.bin"||E==="points3d.txt"&&!I.points3D?.name.endsWith(".bin")?I.points3D=M:E==="database.db"||E==="colmap.db"?I.database=M:E==="rigs.bin"||E==="rigs.txt"&&!I.rigs?.name.endsWith(".bin")?I.rigs=M:(E==="frames.bin"||E==="frames.txt"&&!I.frames?.name.endsWith(".bin"))&&(I.frames=M)}const k=[];for(const[b,M]of S)M.cameras&&M.images&&M.points3D&&k.push({dir:b,files:M});if(k.length===0)return{};k.sort((b,M)=>{const E=P=>{const I=P.toLowerCase();return I.endsWith("/sparse/0")||I==="sparse/0"?0:I.endsWith("/sparse")||I==="sparse"?1:I.includes("/sparse/")?2:I.includes("/sparse")?3:4+P.length};return E(b.dir)-E(M.dir)});const j=k[0].files;return{camerasFile:j.cameras,imagesFile:j.images,points3DFile:j.points3D,databaseFile:j.database,rigsFile:j.rigs,framesFile:j.frames}},[]),f=h.useCallback(async(x,m)=>{const S=m?.start??0,k=m?.end??100,j=E=>Math.round(S+E/100*(k-S));ye.getState().urlLoading||(i(!0),l({percent:j(0),message:"Starting..."}));const M=U1(x);if(M){try{const E=await M.text(),P=pf(E);if(P.valid&&P.config)xf(P.config),console.log(`[Config] Applied settings from ${M.name}`);else{const I=P.errors.map(R=>R.path?`${R.path}: ${R.message}`:R.message).join(", ");console.error(`[Config] Invalid configuration: ${I}`),s(`Config error: ${I}`)}}catch(E){const P=E instanceof Error?E.message:"Unknown error";console.error("[Config] Failed to load config file:",E),s(`Config error: ${P}`)}if(!W1(x)&&!Ec(x)){i(!1);return}}try{o(x);const{camerasFile:E,imagesFile:P,points3DFile:I,databaseFile:R,rigsFile:A,framesFile:G}=u(x);l({percent:j(5),message:"Scanning image files..."});const F=cg(x),z=lg(x);if(!E||!P||!I){if(Ec(x)){console.log(`[Images-only] Creating gallery from ${F.size} image lookup keys`),l({percent:j(50),message:"Creating image gallery..."});const xe=H1(F);n({camerasFile:void 0,imagesFile:void 0,points3DFile:void 0,databaseFile:void 0,rigsFile:void 0,framesFile:void 0,imageFiles:F,hasMasks:z}),Tn({preserveZip:!0}),l({percent:j(95),message:"Finalizing..."}),ye.getState().sourceType||a("local",null),e(xe),c(),Nt.getState().addNotification("info",`Loaded ${xe.images.size} images (gallery only, no 3D data)`,5e3),console.log(`[Images-only] Loaded ${xe.images.size} images for gallery viewing`);return}throw new Error("Missing required COLMAP files. Expected cameras.bin/txt, images.bin/txt, and points3D.bin/txt")}console.log(`Scanned ${x.size} total files, ${F.size} image lookup keys`),n({camerasFile:E,imagesFile:P,points3DFile:I,databaseFile:R,rigsFile:A,framesFile:G,imageFiles:F,hasMasks:z}),l({percent:j(10),message:"Parsing COLMAP files..."});let Z,U,D,T,$=null,Q=!1;console.log("[Parser] Attempting WASM parser (memory-optimized)...");const K=await B1(E,P,I,A,G);if(K)Z=K.cameras,U=K.images,T=K.rigData,$=K.wasmWrapper,Q=!0,Nt.getState().addNotification("info",`Loaded ${$.pointCount.toLocaleString()} points`,5e3);else{console.log("[Parser] WASM failed, falling back to JS parser (without 2D points)");const xe=P.name.endsWith(".bin");[Z,U,D]=await Promise.all([E.name.endsWith(".bin")?E.arrayBuffer().then(gm):E.text().then(xm),P.name.endsWith(".bin")?P.arrayBuffer().then(Ee=>ym(Ee,!0)):P.text().then(vm),I.name.endsWith(".bin")?I.arrayBuffer().then(wm):I.text().then(bm)]),xe&&Nt.getState().addNotification("info","2D point data not loaded. Keypoint overlay may be limited.",5e3)}l({percent:j(35),message:"Computing statistics..."});const{imageStats:re,connectedImagesIndex:J,globalStats:L,imageToPoint3DIds:ee}=Q&&$?Mm(U,$):Im(U,D);l({percent:j(40),message:"Processing rig data..."});let ie=T;if(!ie&&A&&G)try{const[xe,Ee]=await Promise.all([A.name.endsWith(".bin")?A.arrayBuffer().then(Cm):A.text().then(km),G.name.endsWith(".bin")?G.arrayBuffer().then(Sm):G.text().then(jm)]);ie={rigs:xe,frames:Ee},console.log(`Loaded rig data: ${xe.size} rigs, ${Ee.size} frames`)}catch(xe){console.warn("Failed to parse rig/frame files:",xe)}const te={cameras:Z,images:U,...D&&{points3D:D},imageStats:re,connectedImagesIndex:J,globalStats:L,imageToPoint3DIds:ee,rigData:ie};Tn({preserveZip:!0}),await new Promise(xe=>setTimeout(xe,200)),l({percent:j(95),message:"Finalizing..."}),$&&t($),ye.getState().sourceType||a("local",null),e(te),c();const fe=$?.pointCount??D?.size??0;console.log(`Loaded: ${Z.size} cameras, ${U.size} images, ${fe.toLocaleString()} points`);const we=Qe.getState().minTrackLength;if(we>=2&&fe>0){let xe=0;if($){const Ee=$.getTrackLengths();if(Ee)for(let ke=0;ke<Ee.length;ke++)Ee[ke]<we&&xe++}else if(D)for(const Ee of D.values())Ee.track.length<we&&xe++;if(xe>0){const Ee=(xe/fe*100).toFixed(1);Nt.getState().addNotification("warning",`${xe.toLocaleString()} points (${Ee}%) hidden due to min track length filter (${we}). Adjust in Point Cloud settings.`)}}const{missingImages:pe,totalImages:ge,totalFiles:Re}=hg(U,F);if(pe.length>0){console.warn(`âš ï¸ ${pe.length}/${ge} images could not find their files (${Re} image files in lookup map)`);const xe=Math.min(10,pe.length);console.warn("First missing images:",pe.slice(0,xe).map(Ee=>`ID ${Ee.imageId}: "${Ee.name}"`)),pe.length>xe&&console.warn(`... and ${pe.length-xe} more`)}const Le=bp();Le>0&&(console.warn(`âš ï¸ ${Le} images failed to decode (createImageBitmap error). These images may be corrupted or use unsupported encoding.`),console.warn("To fix: Re-export these images from your image editing software, or convert them using a tool like ImageMagick."))}catch(E){console.error("Error processing files:",E),s(E instanceof Error?E.message:"Unknown error")}finally{i(!1)}},[e,t,n,o,s,a,i,l,u,c]),p=h.useCallback(async x=>{if(ye.getState().urlLoading){console.log("[ZIP Loader] Already loading, ignoring duplicate request");return}i(!0),l({percent:0,message:"Opening ZIP archive..."}),await new Promise(S=>setTimeout(S,0));try{Tn(),console.log(`[ZIP Loader] Processing local ZIP file: ${x.name}`);const{colmapFiles:S,imageIndex:k,archive:j,fileSize:b,imageCount:M}=await ng(x,E=>{l({percent:Math.round(E.percent*.1),message:"Extracting ZIP archive..."})});Ju(j,k,b,M),a("zip",null),console.log(`[ZIP Loader] ZIP contains ${S.size} COLMAP files, ${M} indexed images`),await f(S),console.log("[ZIP Loader] Successfully loaded reconstruction from local ZIP")}catch(S){console.error("[ZIP Loader] Error processing ZIP file:",S),Tn(),s(S instanceof Error?S.message:"Failed to process ZIP file"),i(!1)}},[f,i,l,s,a]),g=h.useCallback(async x=>{if(x.preventDefault(),x.stopPropagation(),ye.getState().urlLoading){console.log("[File Dropzone] Ignoring drop during active loading");return}if(!x.dataTransfer?.types.includes("Files"))return;const S=x.dataTransfer?.items;if(!S)return;if(x.dataTransfer.files.length===1){const b=x.dataTransfer.files[0];if(Yp(b)){console.log(`[Drop] Detected ZIP file: ${b.name}`),await p(b);return}}const k=[];for(let b=0;b<S.length;b++){const M=S[b];if(M.kind!=="file")continue;const E=M.webkitGetAsEntry();E&&k.push(E)}const j=[];for(let b=0;b<x.dataTransfer.files.length;b++)j.push(x.dataTransfer.files[b]);i(!0),l({percent:0,message:"Scanning files..."}),await new Promise(b=>setTimeout(b,0));try{const b=new Map;console.log(`[Drop] Scanning ${k.length} entries...`);for(const M of k)await d(M,"",b);if(b.size===0&&j.length>0){console.log(`[Drop] Fallback: using ${j.length} files from dataTransfer.files`);for(const M of j)b.set(M.name,M)}console.log(`[Drop] Found ${b.size} files`),Tn(),await f(b)}catch(b){console.error("[File Dropzone] Error processing drop:",b),s(b instanceof Error?b.message:"Failed to process dropped files"),i(!1)}},[d,f,p,i,l,s]),y=h.useCallback(x=>{x.preventDefault(),x.stopPropagation()},[]),v=h.useCallback(async(x,m,S)=>{try{for await(const k of x.values()){const j=m?`${m}/${k.name}`:k.name;if(k.kind==="file"){const b=await k.getFile();S.set(j,b)}else k.kind==="directory"&&await v(k,j,S)}}catch(k){console.warn(`Failed to scan directory: ${m}`,k)}},[]),w=h.useCallback(async()=>{if(ye.getState().urlLoading){console.log("[File Dropzone] Ignoring browse during active loading");return}if(!("showDirectoryPicker"in window)){s("Your browser does not support folder selection. Please use drag and drop, or try Chrome/Edge.");return}try{const m=await window.showDirectoryPicker();i(!0),l({percent:0,message:"Scanning folder..."}),await new Promise(k=>setTimeout(k,0));const S=new Map;await v(m,"",S),Tn(),await f(S)}catch(m){if(m instanceof Error&&m.name==="AbortError")return;console.error("Error browsing for folder:",m),s(m instanceof Error?m.message:"Failed to open folder"),i(!1)}},[v,f,s,i,l]);return{handleDrop:g,handleDragOver:y,processFiles:f,processZipFile:p,handleBrowse:w}}const yf=Rs({version:$a().int().min(1).max(1),name:fn().optional(),baseUrl:fn().url(),files:Rs({cameras:fn().min(1),images:fn().min(1),points3D:fn().min(1),rigs:fn().optional(),frames:fn().optional()}),imagesPath:fn().optional(),masksPath:fn().optional(),skipImages:$d().optional(),images:Ji(fn()).optional(),masks:Ji(fn()).optional()});let Ao=!1;function Z1(e){return{version:1,baseUrl:e.endsWith("/")?e.slice(0,-1):e,files:{cameras:"sparse/0/cameras.bin",images:"sparse/0/images.bin",points3D:"sparse/0/points3D.bin",rigs:"sparse/0/rigs.bin",frames:"sparse/0/frames.bin"},imagesPath:"images/",masksPath:"masks/"}}function vf(){const{processFiles:e}=Dr(),t=ye(x=>x.setError),n=ye(x=>x.setSourceInfo),o=ye(x=>x.urlLoading),s=ye(x=>x.urlProgress),a=ye(x=>x.urlError),i=ye(x=>x.setUrlLoading),l=ye(x=>x.setUrlProgress),c=ye(x=>x.setUrlError),d=h.useCallback(async x=>{l({percent:2,message:"Fetching manifest..."});const m=await Yi(x);if(!m.ok)throw{type:m.status===404?"not_found":"network",message:`Failed to fetch manifest (${m.status})`,details:m.statusText,failedFile:x};const S=await m.json(),k=yf.safeParse(S);if(!k.success)throw{type:"invalid_manifest",message:"Invalid manifest format",details:k.error.issues.map(b=>`${b.path.join(".")}: ${b.message}`).join("; "),failedFile:x};return l({percent:5,message:"Manifest loaded"}),k.data},[l]),u=h.useCallback(async(x,m)=>{const S=x.endsWith("/")?`${x}${m}`:`${x}/${m}`,k=await Yi(S);if(!k.ok)throw{type:k.status===404?"not_found":"network",message:`Failed to fetch file (${k.status})`,details:`${m}: ${k.statusText}`,failedFile:S};const j=await k.blob(),b=Op(S);return zp(j,b)},[]),f=h.useCallback(async x=>{const m=new Map,{baseUrl:S,files:k}=x,j=[{key:"sparse/0/cameras.bin",path:k.cameras},{key:"sparse/0/images.bin",path:k.images},{key:"sparse/0/points3D.bin",path:k.points3D}],b=[];k.rigs&&b.push({key:"sparse/0/rigs.bin",path:k.rigs}),k.frames&&b.push({key:"sparse/0/frames.bin",path:k.frames});const M=j.length;let E=0;l({percent:5,message:"Downloading COLMAP files...",filesDownloaded:0,totalFiles:M});const P=await Promise.all(j.map(async({key:I,path:R})=>{try{const A=await u(S,R);E++;const G=5+Math.round(E/M*25);return l({percent:G,message:"Downloading COLMAP files...",currentFile:R,filesDownloaded:E,totalFiles:M}),{key:I,file:A}}catch(A){throw A.type?A:Xu(A,`${S}/${R}`)}}));for(const{key:I,file:R}of P)m.set(I,R);if(b.length>0){const I=await Promise.all(b.map(async({key:R,path:A})=>{try{const G=await u(S,A);return console.log(`[URL Loader] Optional file loaded: ${A}`),{key:R,file:G}}catch{return console.log(`[URL Loader] Optional file not found: ${A}`),null}}));for(const R of I)R&&m.set(R.key,R.file)}return m},[u,l]),p=h.useCallback(async(x,m)=>{const S=await f(x);console.log(`[URL Loader] Downloaded ${S.size} COLMAP files:`,Array.from(S.keys())),console.log("[URL Loader] Skipping image download (images will be loaded lazily)"),l({percent:80,message:"Parsing reconstruction..."});const k=x.imagesPath??"images/",j=x.baseUrl.endsWith("/")?`${x.baseUrl}${k}`:`${x.baseUrl}/${k}`,b=x.masksPath??"masks/",M=x.baseUrl.endsWith("/")?`${x.baseUrl}${b}`:`${x.baseUrl}/${b}`;return n&&n("url",m||x.baseUrl,j,M),console.log(`[URL Loader] Image URL base for lazy loading: ${j}`),console.log(`[URL Loader] Mask URL base for lazy loading: ${M}`),console.log("[URL Loader] Calling processFiles..."),await e(S,{start:80,end:100}),l({percent:100,message:"Complete"}),console.log(`[URL Loader] Successfully loaded ${S.size} files from URL`),!0},[f,e,n,l]),g=h.useCallback(async x=>{console.log(`[URL Loader] Loading ZIP from URL: ${x}`);const m=E=>{l({percent:E.percent,message:E.message,filesDownloaded:E.bytesLoaded,totalFiles:E.bytesTotal})},{colmapFiles:S,imageIndex:k,archive:j,fileSize:b,imageCount:M}=await tg(x,m);return Ju(j,k,b,M),l({percent:80,message:"Parsing reconstruction..."}),n("zip",x),console.log(`[URL Loader] ZIP contains ${S.size} COLMAP files, ${M} indexed images`),console.log("[URL Loader] Calling processFiles..."),await e(S,{start:80,end:100}),l({percent:100,message:"Complete"}),console.log("[URL Loader] Successfully loaded reconstruction from ZIP"),!0},[e,n,l]),y=h.useCallback(async x=>{if(Ao)return console.log("[URL Loader] Already loading (sync guard), ignoring duplicate request"),!1;Ao=!0,i(!0),c(null),l({percent:0,message:"Starting..."});let m=Hp(x);m!==x&&console.log(`[URL Loader] Normalized cloud URL: ${x} -> ${m}`);const S=$p(m);S!==m&&(console.log(`[URL Loader] Normalized Git URL: ${m} -> ${S}`),m=S);try{if(Tn(),Gp(m))return console.log(`[URL Loader] Detected ZIP URL: ${m}`),await g(m);let k;return Bp(m)?(k=await d(m),console.log(`[URL Loader] Loaded manifest: ${k.name||"unnamed"}`)):(k=Z1(m),console.log(`[URL Loader] Using direct URL with default paths: ${m}`)),await p(k,m)}catch(k){console.error("[URL Loader] Error:",k),Tn();const j=k.type?k:Ol(k,m);return c(j),t(j.message+(j.details?`: ${j.details}`:"")),!1}finally{Ao=!1,i(!1)}},[d,g,p,t,i,l,c]),v=h.useCallback(async x=>{if(Ao)return console.log("[URL Loader] Already loading (sync guard), ignoring duplicate request"),!1;Ao=!0,i(!0),c(null),l({percent:0,message:"Starting..."});try{Tn(),console.log(`[URL Loader] Loading from manifest: ${x.name||"unnamed"}`);const m=await f(x);console.log(`[URL Loader] Downloaded ${m.size} COLMAP files:`,Array.from(m.keys())),console.log("[URL Loader] Skipping image download (images will be loaded lazily)"),l({percent:80,message:"Parsing reconstruction..."});const S=x.imagesPath??"images/",k=x.baseUrl.endsWith("/")?`${x.baseUrl}${S}`:`${x.baseUrl}/${S}`,j=x.masksPath??"masks/",b=x.baseUrl.endsWith("/")?`${x.baseUrl}${j}`:`${x.baseUrl}/${j}`;return n("manifest",null,k,b,x),console.log(`[URL Loader] Image URL base for lazy loading: ${k}`),console.log(`[URL Loader] Mask URL base for lazy loading: ${b}`),console.log("[URL Loader] Calling processFiles..."),await e(m,{start:80,end:100}),l({percent:100,message:"Complete"}),console.log(`[URL Loader] Successfully loaded ${m.size} files from manifest`),!0}catch(m){console.error("[URL Loader] Error:",m),Tn();const S=m.type?m:Ol(m,x.baseUrl);return c(S),t(S.message+(S.details?`: ${S.details}`:"")),!1}finally{Ao=!1,i(!1)}},[f,e,t,n,i,l,c]),w=h.useCallback(()=>{c(null)},[c]);return{loadFromUrl:y,loadFromManifest:v,urlLoading:o,urlProgress:s,urlError:a,clearUrlError:w,setUrlLoading:i,setUrlProgress:l}}function wf(e=lp.mobile){const[t,n]=h.useState(()=>typeof window<"u"&&window.innerWidth<e);return h.useEffect(()=>{function o(){n(window.innerWidth<e)}return window.addEventListener("resize",o),()=>window.removeEventListener("resize",o)},[e]),t}const V1="https://huggingface.co/datasets/OpsiClear/NGS/resolve/main/objects",Pc=[{name:"Lady Bug Toy",scanId:"scan_20250714_170841_lady_bug_toy"},{name:"Red Car Toy",scanId:"scan_20250714_172700_red_car_toy"},{name:"USB Microscope",scanId:"scan_20250711_112222_usb_microscope"},{name:"Mouse on USB Cable",scanId:"scan_20250711_110733_mouse_on_top_of_usb_cable"},{name:"Abrasive on Torch",scanId:"scan_20250711_102546_abbrasive_on_torch"},{name:"Stamp (New Lighting)",scanId:"scan_20250711_113305_stamp_new_lighting"},{name:"Gold Cup with Mandarins",scanId:"scan_20250714_174136_goldcup_with_scar_mandarins"},{name:"Strawberry Hydro",scanId:"scan_20250713_155826_ilovehydros_strawberry"},{name:"Beef",scanId:"scan_20250713_042803_beef"},{name:"Potato Blend",scanId:"scan_20250713_142608_tasteful_selections_bite_size_creamers_sunburst_blend_potato"},{name:"Object Scan 1",scanId:"scan_20250403_094132"},{name:"Object Scan 2",scanId:"scan_20250408_172911"},{name:"Object Scan 3",scanId:"scan_20250521_153106"}];function G1(e){return`${V1}/${e}/`}function Y1(){return Pc[Math.floor(Math.random()*Pc.length)]}function dr({icon:e,label:t}){return r.jsxs("span",{className:"relative w-6 h-6 flex items-center justify-center",children:[r.jsx("span",{className:"absolute inset-0 flex items-center justify-center opacity-100 group-hover:opacity-0",children:e}),r.jsx("span",{className:"absolute inset-0 flex items-center justify-center text-2xs font-bold tracking-tight opacity-0 group-hover:opacity-100",children:t})]})}function bf({className:e}){return r.jsx("svg",{className:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:r.jsx("path",{d:"M18 6L6 18M6 6l12 12"})})}function yo({className:e}){return r.jsx("svg",{className:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:r.jsx("path",{d:"M20 6L9 17l-5-5"})})}function $s({className:e}){return r.jsxs("svg",{className:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[r.jsx("path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"}),r.jsx("path",{d:"M3 3v5h5"})]})}function Cf({className:e}){return r.jsxs("svg",{className:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[r.jsx("path",{d:"M20 12a8 8 0 0 0-8-8"}),r.jsx("path",{d:"M12 1l-3 3 3 3"}),r.jsx("path",{d:"M4 12a8 8 0 0 0 8 8"}),r.jsx("path",{d:"M12 23l3-3-3-3"})]})}function q1({className:e}){return r.jsxs("svg",{className:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[r.jsx("path",{d:"M12 15V3M12 3l-4 4M12 3l4 4"}),r.jsx("path",{d:"M4 17v2a2 2 0 002 2h12a2 2 0 002-2v-2"})]})}function X1({className:e}){return r.jsxs("svg",{className:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[r.jsx("circle",{cx:"12",cy:"12",r:"10"}),r.jsx("path",{d:"M4 4l16 16"})]})}function K1({className:e}){return r.jsx("svg",{className:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:r.jsx("path",{d:"M3 3l18 18M10.5 10.5a3 3 0 004.5 4.5M6.5 6.5C4 8.5 2 12 2 12s4 6 10 6c1.5 0 3-.5 4.5-1.5M17 17c2-1.5 3.5-3.5 5-5-1-1.5-4-6-10-6-.5 0-1 0-1.5.1"})})}function kf({className:e}){return r.jsxs("svg",{className:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[r.jsx("circle",{cx:"12",cy:"12",r:"3"}),r.jsx("path",{d:"M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"})]})}function Q1({className:e}){return r.jsx("svg",{className:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:r.jsx("path",{d:"M8 3H5a2 2 0 00-2 2v3M21 8V5a2 2 0 00-2-2h-3M3 16v3a2 2 0 002 2h3M16 21h3a2 2 0 002-2v-3"})})}function J1({className:e}){return r.jsx("svg",{className:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:r.jsx("path",{d:"M22 3H2l8 9.46V19l4 2v-8.54L22 3z"})})}function e2({className:e}){return r.jsx("svg",{className:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:r.jsx("path",{d:"M13 2L3 14h9l-1 8 10-12h-9l1-8z"})})}function t2({className:e}){return r.jsx("svg",{className:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:r.jsx("path",{d:"M13 2L3 14h9l-1 8 10-12h-9l1-8z",opacity:"0.4"})})}function n2({className:e}){return r.jsxs("svg",{className:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[r.jsx("circle",{cx:"12",cy:"12",r:"6",fill:"currentColor",opacity:"0.3"}),r.jsx("path",{d:"M12 8v8M8 12h8"})]})}function o2({className:e}){return r.jsxs("svg",{className:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[r.jsx("circle",{cx:"12",cy:"12",r:"4",fill:"currentColor",opacity:"0.3"}),r.jsx("path",{d:"M8 12h8"})]})}function r2({className:e}){return r.jsxs("svg",{className:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[r.jsx("circle",{cx:"12",cy:"12",r:"3"}),r.jsx("path",{d:"M12 2v4M12 18v4M2 12h4M18 12h4"})]})}function s2({className:e}){return r.jsxs("svg",{className:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[r.jsx("path",{d:"M22 2L11 13"}),r.jsx("path",{d:"M22 2l-7 20-4-9-9-4 20-7z"})]})}function i2({className:e}){return r.jsxs("svg",{className:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[r.jsx("circle",{cx:"12",cy:"12",r:"10"}),r.jsx("path",{d:"M12 16v-4"}),r.jsx("circle",{cx:"12",cy:"8",r:"1",fill:"currentColor",stroke:"none"})]})}function a2({className:e}){return r.jsxs("svg",{className:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[r.jsx("path",{d:"M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"}),r.jsx("path",{d:"M12 9v4"}),r.jsx("circle",{cx:"12",cy:"17",r:"1",fill:"currentColor",stroke:"none"})]})}function l2({className:e}){return r.jsxs("svg",{className:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[r.jsx("path",{d:"M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"}),r.jsx("path",{d:"M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"})]})}function c2({className:e}){return r.jsxs("svg",{className:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[r.jsx("circle",{cx:"18",cy:"5",r:"3"}),r.jsx("circle",{cx:"6",cy:"12",r:"3"}),r.jsx("circle",{cx:"18",cy:"19",r:"3"}),r.jsx("path",{d:"M8.59 13.51l6.83 3.98M15.41 6.51l-6.82 3.98"})]})}function u2({className:e}){return r.jsxs("svg",{className:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[r.jsx("path",{d:"M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"}),r.jsx("path",{d:"M14 2v6h6"}),r.jsx("path",{d:"M8 13h1.5a1 1 0 011 1v1.5a1 1 0 01-1 1h0a1 1 0 01-1-1V14"}),r.jsx("path",{d:"M14.5 13H16a1 1 0 011 1v1.5a1 1 0 01-1 1h0a1 1 0 01-1-1V14"})]})}function d2({className:e}){return r.jsx("svg",{className:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:r.jsx("path",{d:"M6 9l6 6 6-6"})})}function f2({className:e}){return r.jsx("svg",{className:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:r.jsx("path",{d:"M9 18l6-6-6-6"})})}function Sf({className:e}){return r.jsxs("svg",{className:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[r.jsx("path",{d:"M23 19a2 2 0 01-2 2H3a2 2 0 01-2-2V8a2 2 0 012-2h4l2-3h6l2 3h4a2 2 0 012 2z"}),r.jsx("circle",{cx:"12",cy:"13",r:"4"})]})}function h2({className:e}){return r.jsxs("svg",{className:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[r.jsx("path",{d:"M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"}),r.jsx("polyline",{points:"7 10 12 15 17 10"}),r.jsx("line",{x1:"12",y1:"15",x2:"12",y2:"3"})]})}function jf({className:e}){return r.jsxs("svg",{className:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[r.jsx("line",{x1:"12",y1:"3",x2:"12",y2:"21"}),r.jsx("line",{x1:"3",y1:"12",x2:"21",y2:"12"}),r.jsx("polyline",{points:"9 5 12 3 15 5"}),r.jsx("polyline",{points:"9 19 12 21 15 19"}),r.jsx("polyline",{points:"5 9 3 12 5 15"}),r.jsx("polyline",{points:"19 9 21 12 19 15"})]})}function If({className:e}){return r.jsxs("svg",{className:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[r.jsx("rect",{x:"2",y:"6",width:"13",height:"12",rx:"2"}),r.jsx("path",{d:"M15 10l7-4v12l-7-4z"})]})}function m2({className:e}){return r.jsx("svg",{className:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:r.jsx("path",{d:"M5 12h14M19 12l-6-6M19 12l-6 6"})})}function p2({className:e}){return r.jsxs("svg",{className:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[r.jsx("rect",{x:"2",y:"6",width:"13",height:"12",rx:"2"}),r.jsx("path",{d:"M15 10l7-4v12l-7-4z"}),r.jsx("path",{d:"M3 21L21 3",strokeWidth:"2.5"})]})}function g2({className:e}){return r.jsxs("svg",{className:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[r.jsx("rect",{x:"1",y:"1",width:"7",height:"5",rx:"1",strokeWidth:"1.5"}),r.jsx("path",{d:"M8 2.5l3-1.5v6l-3-1.5z",strokeWidth:"1.5"}),r.jsx("rect",{x:"8",y:"8",width:"14",height:"14",rx:"1"}),r.jsx("circle",{cx:"12",cy:"12",r:"1.5"}),r.jsx("path",{d:"M22 18l-4-4-6 8"})]})}function x2({className:e}){return r.jsxs("svg",{className:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"1.5",children:[r.jsx("rect",{x:"1",y:"1",width:"7",height:"5",rx:"1"}),r.jsx("path",{d:"M8 2.5l3-1.5v6l-3-1.5z"}),r.jsx("rect",{x:"13",y:"17",width:"7",height:"5",rx:"1"}),r.jsx("path",{d:"M20 18.5l3-1.5v6l-3-1.5z"})]})}function y2({className:e}){return r.jsxs("svg",{className:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"1.5",children:[r.jsx("rect",{x:"1",y:"1",width:"7",height:"5",rx:"1"}),r.jsx("path",{d:"M8 2.5l3-1.5v6l-3-1.5z"}),r.jsx("rect",{x:"13",y:"17",width:"7",height:"5",rx:"1"}),r.jsx("path",{d:"M20 18.5l3-1.5v6l-3-1.5z"}),r.jsx("path",{d:"M9 6l6 12",strokeWidth:"2"})]})}function v2({className:e}){return r.jsxs("svg",{className:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"1.5",children:[r.jsx("rect",{x:"1",y:"1",width:"7",height:"5",rx:"1"}),r.jsx("path",{d:"M8 2.5l3-1.5v6l-3-1.5z"}),r.jsx("rect",{x:"13",y:"17",width:"7",height:"5",rx:"1"}),r.jsx("path",{d:"M20 18.5l3-1.5v6l-3-1.5z"}),r.jsx("path",{d:"M9 6l6 12",strokeWidth:"2",strokeDasharray:"2 2"})]})}function w2({className:e}){return r.jsxs("svg",{className:e,viewBox:"0 0 24 24",fill:"none",strokeLinecap:"round",children:[r.jsx("rect",{x:"1",y:"1",width:"7",height:"5",rx:"1",stroke:"currentColor",strokeWidth:"1.5"}),r.jsx("path",{d:"M8 2.5l3-1.5v6l-3-1.5z",stroke:"currentColor",strokeWidth:"1.5"}),r.jsx("path",{d:"M10 19a7 7 0 0 1 14 0",stroke:"#FF00FF",strokeWidth:"2.5"}),r.jsx("path",{d:"M12 19a5 5 0 0 1 10 0",stroke:"#FFFF00",strokeWidth:"2.5"}),r.jsx("path",{d:"M14 19a3 3 0 0 1 6 0",stroke:"#00FFFF",strokeWidth:"2.5"})]})}function b2({className:e}){return r.jsxs("svg",{className:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[r.jsx("rect",{x:"1",y:"1",width:"7",height:"5",rx:"1",strokeWidth:"1.5"}),r.jsx("path",{d:"M8 2.5l3-1.5v6l-3-1.5z",strokeWidth:"1.5"}),r.jsx("circle",{cx:"17",cy:"17",r:"6",fill:"none"})]})}function C2({className:e}){return r.jsxs("svg",{className:e,viewBox:"0 0 24 24",fill:"none",strokeWidth:"1.5",children:[r.jsx("rect",{x:"1",y:"1",width:"7",height:"5",rx:"1",stroke:"currentColor"}),r.jsx("path",{d:"M8 2.5l3-1.5v6l-3-1.5z",stroke:"currentColor"}),r.jsx("circle",{cx:"17",cy:"17",r:"6",fill:"#FF00FF"})]})}function k2({className:e}){return r.jsxs("svg",{className:e,viewBox:"0 0 24 24",fill:"none",strokeWidth:"1.5",children:[r.jsx("rect",{x:"1",y:"1",width:"7",height:"5",rx:"1",stroke:"currentColor"}),r.jsx("path",{d:"M8 2.5l3-1.5v6l-3-1.5z",stroke:"currentColor"}),r.jsx("circle",{cx:"17",cy:"17",r:"2.5",fill:"#FF00FF"}),r.jsx("circle",{cx:"17",cy:"17",r:"4.5",stroke:"#FF00FF",strokeWidth:"1.5",opacity:"0.6",fill:"none"}),r.jsx("circle",{cx:"17",cy:"17",r:"6",stroke:"#FF00FF",strokeWidth:"1",opacity:"0.3",fill:"none"})]})}function Mf({className:e}){return r.jsxs("svg",{className:e,viewBox:"0 0 24 24",fill:"none",strokeWidth:"2",strokeLinecap:"round",children:[r.jsx("path",{d:"M12 12h9",stroke:"#e74c3c"}),r.jsx("path",{d:"M12 12v-9",stroke:"#2ecc71"}),r.jsx("path",{d:"M12 12l-6 6",stroke:"#3498db"})]})}function S2({className:e}){return r.jsxs("svg",{className:e,viewBox:"0 0 24 24",fill:"none",strokeLinecap:"round",children:[r.jsx("path",{d:"M12 12h4",stroke:"currentColor",strokeWidth:"2",opacity:"0.35"}),r.jsx("path",{d:"M12 12v-4",stroke:"currentColor",strokeWidth:"2",opacity:"0.35"}),r.jsx("path",{d:"M12 12l-2.5 2.5",stroke:"currentColor",strokeWidth:"2",opacity:"0.35"}),r.jsx("circle",{cx:"12",cy:"12",r:"1.5",fill:"currentColor",opacity:"0.4"})]})}function j2({className:e}){return r.jsx("svg",{className:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:r.jsx("path",{d:"M3 8h18M3 16h18M8 3v18M16 3v18"})})}function I2({className:e}){return r.jsxs("svg",{className:e,viewBox:"0 0 24 24",fill:"none",strokeLinecap:"round",children:[r.jsx("path",{d:"M4 8h16M4 16h16M8 4v16M16 4v16",stroke:"currentColor",strokeWidth:"1",opacity:"0.4"}),r.jsx("path",{d:"M12 12h9",stroke:"#e74c3c",strokeWidth:"2.5"}),r.jsx("path",{d:"M12 12v-9",stroke:"#2ecc71",strokeWidth:"2.5"}),r.jsx("path",{d:"M12 12l-6 6",stroke:"#3498db",strokeWidth:"2.5"})]})}function M2({className:e}){return r.jsxs("svg",{className:e,viewBox:"0 0 24 24",fill:"none",children:[r.jsx("circle",{cx:"12",cy:"7",r:"2.5",fill:"currentColor",opacity:"0.3"}),r.jsx("circle",{cx:"7",cy:"12",r:"2.2",fill:"currentColor",opacity:"0.3"}),r.jsx("circle",{cx:"17",cy:"11",r:"2.3",fill:"currentColor",opacity:"0.3"}),r.jsx("circle",{cx:"9",cy:"17",r:"2",fill:"currentColor",opacity:"0.3"}),r.jsx("circle",{cx:"15",cy:"16",r:"1.8",fill:"currentColor",opacity:"0.3"}),r.jsx("circle",{cx:"5",cy:"7",r:"1.5",fill:"currentColor",opacity:"0.3"}),r.jsx("circle",{cx:"19",cy:"6",r:"1.3",fill:"currentColor",opacity:"0.3"}),r.jsx("path",{d:"M3 21L21 3",stroke:"currentColor",strokeWidth:"2.5"})]})}function E2({className:e}){return r.jsxs("svg",{className:e,viewBox:"0 0 24 24",fill:"none",children:[r.jsx("circle",{cx:"12",cy:"7",r:"2.5",fill:"#e74c3c"}),r.jsx("circle",{cx:"7",cy:"12",r:"2.2",fill:"#3498db"}),r.jsx("circle",{cx:"17",cy:"11",r:"2.3",fill:"#2ecc71"}),r.jsx("circle",{cx:"9",cy:"17",r:"2",fill:"#f39c12"}),r.jsx("circle",{cx:"15",cy:"16",r:"1.8",fill:"#9b59b6"}),r.jsx("circle",{cx:"5",cy:"7",r:"1.5",fill:"#1abc9c"}),r.jsx("circle",{cx:"19",cy:"6",r:"1.3",fill:"#e91e63"})]})}function P2({className:e}){return r.jsxs("svg",{className:e,viewBox:"0 0 24 24",fill:"none",children:[r.jsx("circle",{cx:"12",cy:"7",r:"2.5",fill:"#e74c3c"}),r.jsx("circle",{cx:"7",cy:"12",r:"2.2",fill:"#3498db"}),r.jsx("circle",{cx:"17",cy:"11",r:"2.3",fill:"#f39c12"}),r.jsx("circle",{cx:"9",cy:"17",r:"2",fill:"#2980b9"}),r.jsx("circle",{cx:"15",cy:"16",r:"1.8",fill:"#c0392b"}),r.jsx("circle",{cx:"5",cy:"7",r:"1.5",fill:"#1e90ff"}),r.jsx("circle",{cx:"19",cy:"6",r:"1.3",fill:"#ff6347"})]})}function L2({className:e}){return r.jsxs("svg",{className:e,viewBox:"0 0 24 24",fill:"none",children:[r.jsx("circle",{cx:"12",cy:"7",r:"2.5",fill:"#2ecc71"}),r.jsx("circle",{cx:"7",cy:"12",r:"2.2",fill:"#145a32"}),r.jsx("circle",{cx:"17",cy:"11",r:"2.3",fill:"#27ae60"}),r.jsx("circle",{cx:"9",cy:"17",r:"2",fill:"#1e8449"}),r.jsx("circle",{cx:"15",cy:"16",r:"1.8",fill:"#0b5345"}),r.jsx("circle",{cx:"5",cy:"7",r:"1.5",fill:"#58d68d"}),r.jsx("circle",{cx:"19",cy:"6",r:"1.3",fill:"#196f3d"})]})}function Ef({className:e}){return r.jsxs("svg",{className:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[r.jsx("circle",{cx:"12",cy:"12",r:"9"}),r.jsx("path",{d:"M12 3v18"}),r.jsx("path",{d:"M12 3a9 9 0 0 0 0 18",fill:"currentColor",opacity:"0.3"})]})}function _2({className:e}){return r.jsxs("svg",{className:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[r.jsx("path",{d:"M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"}),r.jsx("circle",{cx:"12",cy:"12",r:"3"})]})}function A2({className:e}){return r.jsxs("svg",{className:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"1.5",children:[r.jsx("circle",{cx:"12",cy:"12",r:"9"}),r.jsx("circle",{cx:"12",cy:"12",r:"3",fill:"currentColor",stroke:"none"}),r.jsx("circle",{cx:"21",cy:"12",r:"3",fill:"currentColor",stroke:"none"})]})}function N2({className:e}){return r.jsxs("svg",{className:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"1.5",children:[r.jsx("path",{d:"M2.5 12 Q12 2 21.5 12 Q12 22 2.5 12"}),r.jsx("circle",{cx:"12",cy:"12",r:"4",fill:"currentColor",stroke:"none"})]})}function R2({className:e}){return r.jsxs("svg",{className:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[r.jsx("rect",{x:"3",y:"3",width:"18",height:"18",rx:"2"}),r.jsx("line",{x1:"15",y1:"3",x2:"15",y2:"21"}),r.jsx("polyline",{points:"11 9 7 12 11 15",strokeLinecap:"round",strokeLinejoin:"round"})]})}function F2({className:e}){return r.jsxs("svg",{className:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[r.jsx("rect",{x:"3",y:"3",width:"18",height:"18",rx:"2"}),r.jsx("line",{x1:"15",y1:"3",x2:"15",y2:"21"}),r.jsx("polyline",{points:"7 9 11 12 7 15",strokeLinecap:"round",strokeLinejoin:"round"})]})}function T2({className:e}){return r.jsxs("svg",{className:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"1.5",children:[r.jsx("rect",{x:"8",y:"1",width:"5",height:"4",rx:"0.5"}),r.jsx("path",{d:"M13 2.5l2.5-1v4l-2.5-1z"}),r.jsx("rect",{x:"1",y:"16",width:"5",height:"4",rx:"0.5"}),r.jsx("path",{d:"M6 17.5l2.5-1v4l-2.5-1z"}),r.jsx("rect",{x:"15",y:"16",width:"5",height:"4",rx:"0.5"}),r.jsx("path",{d:"M20 17.5l2.5-1v4l-2.5-1z"}),r.jsx("line",{x1:"10",y1:"5",x2:"4",y2:"16",strokeWidth:"1.5"}),r.jsx("line",{x1:"11",y1:"5",x2:"17",y2:"16",strokeWidth:"1.5"}),r.jsx("line",{x1:"6",y1:"18",x2:"15",y2:"18",strokeWidth:"1.5"})]})}function D2({className:e}){return r.jsxs("svg",{className:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"1.5",children:[r.jsx("rect",{x:"8",y:"1",width:"5",height:"4",rx:"0.5"}),r.jsx("path",{d:"M13 2.5l2.5-1v4l-2.5-1z"}),r.jsx("rect",{x:"1",y:"16",width:"5",height:"4",rx:"0.5"}),r.jsx("path",{d:"M6 17.5l2.5-1v4l-2.5-1z"}),r.jsx("rect",{x:"15",y:"16",width:"5",height:"4",rx:"0.5"}),r.jsx("path",{d:"M20 17.5l2.5-1v4l-2.5-1z"}),r.jsx("path",{d:"M2 22L22 2",strokeWidth:"2.5"})]})}function z2({className:e}){return r.jsxs("svg",{className:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"1.5",children:[r.jsx("rect",{x:"8",y:"1",width:"5",height:"4",rx:"0.5"}),r.jsx("path",{d:"M13 2.5l2.5-1v4l-2.5-1z"}),r.jsx("rect",{x:"1",y:"16",width:"5",height:"4",rx:"0.5"}),r.jsx("path",{d:"M6 17.5l2.5-1v4l-2.5-1z"}),r.jsx("rect",{x:"15",y:"16",width:"5",height:"4",rx:"0.5"}),r.jsx("path",{d:"M20 17.5l2.5-1v4l-2.5-1z"}),r.jsx("line",{x1:"10",y1:"5",x2:"4",y2:"16",strokeWidth:"1.5",strokeDasharray:"2 2"}),r.jsx("line",{x1:"11",y1:"5",x2:"17",y2:"16",strokeWidth:"1.5",strokeDasharray:"2 2"}),r.jsx("line",{x1:"6",y1:"18",x2:"15",y2:"18",strokeWidth:"1.5",strokeDasharray:"2 2"})]})}function O2({className:e}){return r.jsxs("svg",{className:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"1.5",children:[r.jsx("path",{d:"M3 16 L12 20 L21 16 L12 12 Z",strokeLinejoin:"round"}),r.jsx("line",{x1:"12",y1:"16",x2:"12",y2:"4",strokeWidth:"2"}),r.jsx("polyline",{points:"8 8 12 4 16 8",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"})]})}const $2=r.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[r.jsx("circle",{cx:"12",cy:"12",r:"9"}),r.jsx("path",{d:"M12 12h6",stroke:"#e74c3c",strokeWidth:"3"}),r.jsx("path",{d:"M15 9l3 3-3 3",stroke:"#e74c3c"})]}),B2=r.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[r.jsx("circle",{cx:"12",cy:"12",r:"9"}),r.jsx("path",{d:"M12 12v-6",stroke:"#2ecc71",strokeWidth:"3"}),r.jsx("path",{d:"M9 9l3-3 3 3",stroke:"#2ecc71"})]}),U2=r.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[r.jsx("circle",{cx:"12",cy:"12",r:"9"}),r.jsx("circle",{cx:"12",cy:"12",r:"3",fill:"#3498db"}),r.jsx("path",{d:"M12 12l4 4",stroke:"#3498db",strokeWidth:"2"})]}),W2=r.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[r.jsx("path",{d:"M2 12h4M18 12h4"}),r.jsx("rect",{x:"6",y:"4",width:"12",height:"16",rx:"1"}),r.jsx("circle",{cx:"12",cy:"12",r:"3"})]}),H2=r.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[r.jsx("circle",{cx:"12",cy:"12",r:"9"}),r.jsx("path",{d:"M12 8v8M8 12h8"})]}),Z2=r.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[r.jsx("path",{d:"M3 12h18"}),r.jsx("path",{d:"M12 3v6M12 15v6"}),r.jsx("circle",{cx:"12",cy:"12",r:"2",fill:"currentColor",stroke:"none"})]}),V2=r.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[r.jsx("line",{x1:"12",y1:"2",x2:"12",y2:"22",strokeDasharray:"2 2"}),r.jsx("ellipse",{cx:"12",cy:"12",rx:"10",ry:"4",fill:"none",strokeDasharray:"42 21"}),r.jsx("path",{d:"M2 12l0 3.5 3.5 -0.5"})]}),G2=r.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[r.jsx("rect",{x:"3",y:"3",width:"18",height:"18",rx:"2"}),r.jsx("line",{x1:"15",y1:"3",x2:"15",y2:"21"})]}),Y2=r.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[r.jsx("path",{d:"M12 3v18M3 12h18"}),r.jsx("path",{d:"M12 12l6-6",strokeDasharray:"2 2"})]}),q2=r.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[r.jsx("rect",{x:"2",y:"6",width:"13",height:"12",rx:"2"}),r.jsx("path",{d:"M15 10l7-4v12l-7-4z"}),r.jsx("circle",{cx:"7",cy:"12",r:"1.5",fill:"#e74c3c",stroke:"none"}),r.jsx("circle",{cx:"11",cy:"12",r:"1.5",fill:"#2ecc71",stroke:"none"})]}),X2=r.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[r.jsx("circle",{cx:"7",cy:"12",r:"3",fill:"#e74c3c",stroke:"none"}),r.jsx("circle",{cx:"12",cy:"12",r:"3",fill:"#2ecc71",stroke:"none"}),r.jsx("circle",{cx:"17",cy:"12",r:"3",fill:"#3498db",stroke:"none"})]}),K2=r.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[r.jsx("circle",{cx:"6",cy:"6",r:"3"}),r.jsx("circle",{cx:"18",cy:"18",r:"3"}),r.jsx("path",{d:"M8.5 8.5l7 7",strokeDasharray:"2 2"})]}),Q2=r.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[r.jsx("rect",{x:"3",y:"3",width:"18",height:"18",rx:"2",strokeDasharray:"4 2"}),r.jsx("circle",{cx:"12",cy:"12",r:"4",fill:"currentColor",opacity:"0.3"})]}),J2=r.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[r.jsx("rect",{x:"3",y:"3",width:"18",height:"18",rx:"2"}),r.jsx("path",{d:"M9 9l6 6M15 9l-6 6"})]}),eC=r.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[r.jsx("rect",{x:"3",y:"3",width:"18",height:"14",rx:"2"}),r.jsx("circle",{cx:"8",cy:"8",r:"2"}),r.jsx("path",{d:"M21 15l-5-5L5 17"})]}),tC=r.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[r.jsx("path",{d:"M4 6q8 3 16 0",strokeDasharray:"2 2",opacity:"0.5"}),r.jsx("path",{d:"M4 12h16"}),r.jsx("path",{d:"M4 18q8 -3 16 0",strokeDasharray:"2 2",opacity:"0.5"}),r.jsx("path",{d:"M12 8v-4M10 6l2-2 2 2",strokeWidth:"1.5"})]}),nC=r.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[r.jsx("circle",{cx:"12",cy:"12",r:"8",strokeDasharray:"4 2"}),r.jsx("path",{d:"M12 4v4M12 16v4M4 12h4M16 12h4"}),r.jsx("circle",{cx:"12",cy:"12",r:"2",fill:"currentColor"})]}),oC=r.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[r.jsx("circle",{cx:"12",cy:"12",r:"4",fill:"currentColor"}),r.jsx("path",{d:"M12 2v6M12 16v6M2 12h6M16 12h6",strokeDasharray:"2 2"})]}),rC=r.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[r.jsx("circle",{cx:"5",cy:"12",r:"3"}),r.jsx("circle",{cx:"19",cy:"12",r:"3"}),r.jsx("path",{d:"M8 12h8",strokeDasharray:"2 2"})]}),sC=r.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[r.jsx("path",{d:"M12 5L5 19L19 19Z",fill:"currentColor",opacity:"0.15"}),r.jsx("path",{d:"M12 5L5 19L19 19Z"}),r.jsx("circle",{cx:"12",cy:"5",r:"2",fill:"currentColor"}),r.jsx("circle",{cx:"5",cy:"19",r:"2",fill:"currentColor"}),r.jsx("circle",{cx:"19",cy:"19",r:"2",fill:"currentColor"})]}),iC=r.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[r.jsx("path",{d:"M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"}),r.jsx("path",{d:"M7 10l5 5 5-5"}),r.jsx("path",{d:"M12 15V3"})]}),aC=r.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[r.jsx("path",{d:"M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"}),r.jsx("path",{d:"M14 2v6h6"}),r.jsx("path",{d:"M12 18v-6"}),r.jsx("path",{d:"M9 15l3 3 3-3"})]});function bs({className:e}){return r.jsxs("svg",{className:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[r.jsx("rect",{x:"6",y:"2",width:"12",height:"20",rx:"6"}),r.jsx("path",{d:"M12 2v8"}),r.jsx("rect",{x:"6",y:"2",width:"6",height:"8",rx:"3",fill:"currentColor",opacity:"0.5"})]})}function la({className:e}){return r.jsxs("svg",{className:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[r.jsx("rect",{x:"6",y:"2",width:"12",height:"20",rx:"6"}),r.jsx("path",{d:"M12 2v8"}),r.jsx("rect",{x:"12",y:"2",width:"6",height:"8",rx:"3",fill:"currentColor",opacity:"0.5"})]})}function lC({className:e}){return r.jsxs("svg",{className:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[r.jsx("rect",{x:"6",y:"2",width:"12",height:"20",rx:"6"}),r.jsx("path",{d:"M12 6v4M12 14v4M9 8l3-3 3 3M9 16l3 3 3-3"})]})}function cC({isOpen:e,onClose:t,onLoad:n,loading:o=!1}){const[s,a]=h.useState(""),[i,l]=h.useState(!1),c=h.useRef(null);h.useEffect(()=>{e&&c.current&&setTimeout(()=>{c.current?.focus()},50)},[e]),h.useEffect(()=>{e||a("")},[e]);const d=h.useCallback(()=>{const f=s.trim();!f||o||n(f)},[s,o,n]),u=h.useCallback(f=>{f.key==="Enter"&&!o&&d()},[d,o]);return lt("escape",()=>t(),{enabled:e&&!o},[e,o,t]),e?r.jsx("div",{className:"fixed inset-0 z-[1100] flex items-center justify-center bg-ds-void/50",onClick:f=>{f.target===f.currentTarget&&!o&&t()},children:r.jsxs("div",{className:"bg-ds-tertiary border border-ds rounded-lg shadow-ds-lg p-5 min-w-[400px] max-w-[520px]",onClick:f=>f.stopPropagation(),children:[r.jsx("h3",{className:"text-ds-primary font-medium mb-3",children:"Load from URL"}),r.jsx("p",{className:"text-ds-muted text-sm mb-4",children:"Enter a manifest URL (.json), a ZIP file URL (.zip), or a direct path to a COLMAP folder"}),r.jsx("input",{ref:c,type:"url",value:s,onChange:f=>a(f.target.value),onKeyDown:u,placeholder:"https://huggingface.co/.../resolve/main/reconstruction",className:`${Sn.base} ${Sn.sizes.lg} w-full mb-4 text-sm placeholder-ds-muted`,disabled:o}),r.jsxs("div",{className:"mb-4",children:[r.jsxs("button",{type:"button",onClick:()=>l(!i),className:"flex items-center gap-1 text-ds-muted text-xs hover:text-ds-primary transition-colors",children:[i?r.jsx(d2,{className:"w-3 h-3"}):r.jsx(f2,{className:"w-3 h-3"}),"Supported URL formats"]}),i&&r.jsxs("div",{className:"mt-2 p-3 bg-ds-secondary rounded border border-ds text-xs text-ds-muted",children:[r.jsx("div",{className:"font-medium text-ds-primary mb-2",children:"ZIP Files"}),r.jsxs("ul",{className:"space-y-1 mb-3",children:[r.jsx("li",{children:r.jsx("code",{className:"text-ds-accent",children:"https://example.com/reconstruction.zip"})}),r.jsx("li",{className:"text-ds-muted/70",children:"ZIP should contain cameras.bin, images.bin, points3D.bin"}),r.jsx("li",{className:"text-ds-muted/70",children:"Images in ZIP are loaded lazily on-demand"}),r.jsx("li",{className:"text-ds-muted/70",children:"Maximum ZIP size: 2GB"})]}),r.jsx("div",{className:"font-medium text-ds-primary mb-2",children:"Cloud Storage URLs"}),r.jsxs("ul",{className:"space-y-1 mb-3",children:[r.jsxs("li",{children:[r.jsx("code",{className:"text-ds-accent",children:"s3://bucket/path"})," â€” AWS S3"]}),r.jsxs("li",{children:[r.jsx("code",{className:"text-ds-accent",children:"gs://bucket/path"})," â€” Google Cloud Storage"]}),r.jsx("li",{children:r.jsx("code",{className:"text-ds-accent",children:"https://bucket.s3.amazonaws.com/path"})}),r.jsx("li",{children:r.jsx("code",{className:"text-ds-accent",children:"https://storage.googleapis.com/bucket/path"})}),r.jsx("li",{children:r.jsx("code",{className:"text-ds-accent",children:"https://account.r2.cloudflarestorage.com/bucket/path"})})]}),r.jsx("div",{className:"font-medium text-ds-primary mb-2",children:"Dropbox"}),r.jsxs("ul",{className:"space-y-1 mb-3",children:[r.jsx("li",{children:r.jsx("code",{className:"text-ds-accent",children:"https://www.dropbox.com/s/.../file.txt?dl=0"})}),r.jsx("li",{children:r.jsx("code",{className:"text-ds-accent",children:"https://www.dropbox.com/scl/fi/.../file.txt?rlkey=..."})}),r.jsx("li",{className:"text-ds-muted/70",children:"Share links auto-converted to direct downloads"})]}),r.jsx("div",{className:"font-medium text-ds-primary mb-2",children:"Git Hosting URLs"}),r.jsxs("ul",{className:"space-y-1 mb-3",children:[r.jsx("li",{children:r.jsx("code",{className:"text-ds-accent",children:"https://huggingface.co/.../resolve/main/..."})}),r.jsx("li",{children:r.jsx("code",{className:"text-ds-accent",children:"https://github.com/.../blob/main/..."})}),r.jsx("li",{children:r.jsx("code",{className:"text-ds-accent",children:"https://gitlab.com/.../-/blob/main/..."})})]}),r.jsx("div",{className:"font-medium text-ds-primary mb-2",children:"Local / Self-hosted Server"}),r.jsxs("ul",{className:"space-y-1 mb-3",children:[r.jsx("li",{children:r.jsx("code",{className:"text-ds-accent",children:"http://localhost:8080/"})}),r.jsxs("li",{className:"text-ds-muted/70",children:["Start with: ",r.jsx("code",{className:"text-ds-accent",children:"npx http-server --cors -p 8080"})]})]}),r.jsx("div",{className:"font-medium text-amber-400 mb-1",children:"CORS Requirements"}),r.jsx("p",{className:"text-ds-muted/80",children:"Cloud buckets must have CORS configured. Dropbox, pre-signed URLs, and same-origin servers work automatically."})]})]}),r.jsxs("div",{className:"flex justify-end gap-2",children:[r.jsx("button",{type:"button",onClick:t,disabled:o,className:Ml("ghost","lg",o),children:"Cancel"}),r.jsx("button",{type:"button",onClick:d,disabled:o||!s.trim(),className:Ml("primary","lg",o||!s.trim()),children:o?"Loading...":"Load"})]})]})}):null}function uC({children:e}){const[t,n]=h.useState(!1),[o,s]=h.useState(!1),[a,i]=h.useState(!1),[l,c]=h.useState(null),{handleDrop:d,handleDragOver:u,handleBrowse:f}=Dr(),{loadFromUrl:p,loadFromManifest:g,urlLoading:y,urlProgress:v,setUrlLoading:w,setUrlProgress:x}=vf(),{error:m,setError:S,reconstruction:k}=ye(),j=h.useRef(null),b=h.useRef(null),M=wf(),E=h.useCallback(async D=>{w(!0),x({percent:0,message:"Starting..."}),i(!1),await new Promise(T=>setTimeout(T,0)),await p(D)},[p,w,x]),P=h.useCallback(async D=>{const T=D.target.files?.[0];if(T){w(!0),x({percent:0,message:"Loading manifest..."}),await new Promise($=>setTimeout($,0));try{const $=await T.text(),Q=JSON.parse($),K=yf.safeParse(Q);if(!K.success){const re=K.error.issues.map(J=>`${J.path.join(".")}: ${J.message}`).join("; ");S(`Invalid manifest: ${re}`),w(!1);return}await g(K.data)}catch($){const Q=$ instanceof Error?$.message:"Unknown error";S(`Failed to load manifest: ${Q}`),w(!1)}D.target.value=""}},[g,S,w,x]),I=h.useCallback(async()=>{if(y)return;w(!0),x({percent:0,message:"Starting..."}),await new Promise(T=>setTimeout(T,0));const D=Y1();console.log(`[Try a Toy] Loading random dataset: ${D.name}`),await p(G1(D.scanId))},[p,y,w,x]),R=h.useCallback(()=>{const D={version:1,name:"Example Dataset",baseUrl:"https://example.com/colmap-data",files:{cameras:"sparse/0/cameras.bin",images:"sparse/0/images.bin",points3D:"sparse/0/points3D.bin"},imagesPath:"images/",masksPath:"masks/"},T=new Blob([JSON.stringify(D,null,2)],{type:"application/json"}),$=URL.createObjectURL(T),Q=document.createElement("a");Q.href=$,Q.download="manifest.json",document.body.appendChild(Q),Q.click(),document.body.removeChild(Q),URL.revokeObjectURL($)},[]),A=h.useCallback(()=>{confirm("Reset all settings to defaults? This will clear your saved preferences.")&&(Object.values(ct).forEach(D=>localStorage.removeItem(D)),window.location.reload())},[]),G=h.useCallback(()=>{j.current?.click()},[]),F=h.useCallback(async D=>{const T=D.target.files?.[0];if(T){try{const $=await T.text(),Q=pf($);if(Q.valid&&Q.config)xf(Q.config),console.log(`[Config] Applied settings from ${T.name}`);else{const K=Q.errors.map(re=>re.path?`${re.path}: ${re.message}`:re.message).join(", ");S(`Config error: ${K}`)}}catch($){const Q=$ instanceof Error?$.message:"Unknown error";S(`Config error: ${Q}`)}D.target.value=""}},[S]);h.useEffect(()=>{if(m){const D=setTimeout(()=>{S(null)},hn.errorToastDuration);return()=>clearTimeout(D)}},[m,S]);const z=h.useCallback(D=>{D.preventDefault(),D.stopPropagation(),D.dataTransfer.types.includes("Files")&&n(!0)},[]),Z=h.useCallback(D=>{D.preventDefault(),D.stopPropagation(),D.currentTarget.contains(D.relatedTarget)||n(!1)},[]),U=h.useCallback(async D=>{n(!1),await d(D)},[d]);return r.jsxs("div",{className:"relative w-full h-full",onDragEnter:z,onDragLeave:Z,onDragOver:u,onDrop:U,children:[e,t&&r.jsx("div",{className:cr.container,children:r.jsxs("div",{className:cr.content,children:[r.jsx("div",{className:cr.icon,children:"+"}),r.jsx("div",{className:cr.title,children:"Drop COLMAP folder or ZIP here"}),r.jsx("div",{className:cr.subtitle,children:"Expected: cameras.bin, images.bin, points3D.bin (or .zip containing them)"})]})}),!k&&!y&&!Au()&&!t&&!o&&!M&&r.jsx("div",{className:"absolute inset-0 flex items-center justify-center z-10",children:r.jsxs("div",{className:"flex flex-col bg-ds-secondary rounded-lg border border-ds p-6 min-w-[420px]",children:[r.jsxs("div",{className:"flex justify-between -mt-4 -mx-4 mb-2",children:[r.jsxs("div",{className:"flex gap-1",children:[r.jsx("button",{type:"button",className:`${ue.base} w-8 h-8 ${ue.variants.ghost}`,onClick:A,"data-tooltip":"Reset all settings to defaults",children:r.jsx($s,{className:"w-4 h-4"})}),r.jsx("button",{type:"button",className:`${ue.base} w-8 h-8 ${ue.variants.ghost}`,onClick:G,"data-tooltip":"Upload configuration file (.yaml)",children:r.jsx(q1,{className:"w-4 h-4"})})]}),r.jsx("button",{type:"button",className:`${ue.base} w-8 h-8 ${ue.variants.ghost}`,onClick:()=>s(!0),"data-tooltip":"Dismiss this panel",children:"Ã—"})]}),r.jsx("input",{ref:j,type:"file",accept:".yaml,.yml",className:"hidden",onChange:F}),r.jsx("input",{ref:b,type:"file",accept:".json",className:"hidden",onChange:P}),r.jsxs("div",{className:"flex flex-col items-center",children:[r.jsx("div",{className:"w-32 h-32 mb-6 flex items-center justify-center border-2 border-dashed border-ds-muted rounded-lg cursor-pointer hover-border-ds-primary transition-colors",onClick:f,children:r.jsx("span",{className:"text-ds-muted font-light leading-none",style:{fontSize:"72px"},children:"+"})}),r.jsx("h2",{className:cn.title,children:"Load COLMAP Data"}),r.jsxs("p",{className:cn.message,children:["Drag and drop a COLMAP dataset folder here.",r.jsx("br",{}),"Or click the box above to browse."]}),r.jsx("style",{children:".info-line:hover { color: rgba(255,255,255,0.9); }"}),r.jsxs("div",{className:"text-ds-muted text-sm text-left max-w-md mt-6 mb-4",children:[r.jsxs("div",{className:"info-line px-2 rounded",children:[r.jsx("strong",{children:"Drop folder or ZIP file"})," â€” subfolders are scanned automatically"]}),r.jsxs("div",{className:"info-line px-2 rounded",children:[r.jsx("strong",{children:"Required:"})," cameras, images, points3D (.bin or .txt preferred)"]}),r.jsxs("div",{className:"info-line px-2 rounded",children:[r.jsx("strong",{children:"Auto-detected:"})," sparse/0/, sparse/, or any subfolder"]}),r.jsxs("div",{className:"info-line px-2 rounded",children:[r.jsx("strong",{children:"Optional:"})," source images (jpg, png, webp, tiff), config (.yaml), masks/"]}),r.jsx("div",{className:"info-line px-2 rounded text-ds-muted/70",children:"ZIP: max 2GB, images loaded lazily on-demand"})]}),r.jsxs("div",{className:"flex gap-2 mt-2",children:[r.jsxs("div",{className:"relative",children:[r.jsxs("button",{type:"button",onClick:()=>i(!0),onContextMenu:D=>{D.preventDefault(),window.open("https://huggingface.co/datasets/OpsiClear/NGS","_blank")},onMouseEnter:()=>c("url"),onMouseLeave:()=>c(null),disabled:y,className:`${ue.base} ${ue.sizes.action} ${ue.variants.secondary} ${y?ue.disabled:""}`,children:[r.jsx(l2,{className:"w-3.5 h-3.5"}),"Load URL"]}),l==="url"&&r.jsxs("div",{className:`absolute left-1/2 -translate-x-1/2 bottom-full mb-2 z-50 ${se.container}`,children:[r.jsx("div",{className:se.title,children:"Load from URL"}),r.jsx("div",{className:`${se.subtitle} whitespace-pre mt-1`,children:`Direct URL expects:
  <baseUrl>/sparse/0/cameras.bin
  <baseUrl>/sparse/0/images.bin
  <baseUrl>/sparse/0/points3D.bin
  <baseUrl>/images/  (optional)
  <baseUrl>/masks/   (optional)`}),r.jsx("div",{className:`${se.subtitle} mt-2`,children:"Or provide a .zip or manifest.json URL"}),r.jsx("div",{className:`${se.subtitle} mt-1 text-ds-muted/70`,children:"Supports: S3, GCS, R2, Dropbox, HuggingFace, GitHub"}),r.jsx("div",{className:`${se.subtitle} mt-1 text-ds-muted/70`,children:"Local server: npx http-server --cors -p 8080"}),r.jsxs("div",{className:se.hint,children:[r.jsxs("div",{className:se.hintRow,children:[r.jsx(bs,{className:tt.hoverCard}),"Left: open URL dialog"]}),r.jsxs("div",{className:se.hintRow,children:[r.jsx(la,{className:tt.hoverCard}),"Right: open NGS dataset"]})]})]})]}),r.jsxs("div",{className:"relative",children:[r.jsxs("button",{type:"button",onClick:()=>b.current?.click(),onContextMenu:D=>{D.preventDefault(),R()},onMouseEnter:()=>c("json"),onMouseLeave:()=>c(null),disabled:y,className:`${ue.base} ${ue.sizes.action} ${ue.variants.secondary} ${y?ue.disabled:""}`,children:[r.jsx(u2,{className:"w-3.5 h-3.5"}),"Load JSON"]}),l==="json"&&r.jsxs("div",{className:`absolute left-1/2 -translate-x-1/2 bottom-full mb-2 z-50 ${se.container}`,children:[r.jsx("div",{className:se.title,children:"Load manifest.json"}),r.jsx("div",{className:`${se.subtitle} whitespace-pre mt-1 font-mono text-xs`,children:`{
  "version": 1,
  "baseUrl": "https://...",
  "files": {
    "cameras": "sparse/0/cameras.bin",
    "images": "sparse/0/images.bin",
    "points3D": "sparse/0/points3D.bin"
  },
  "imagesPath": "images/",
  "masksPath": "masks/"
}`}),r.jsxs("div",{className:se.hint,children:[r.jsxs("div",{className:se.hintRow,children:[r.jsx(bs,{className:tt.hoverCard}),"Left: browse manifest file"]}),r.jsxs("div",{className:se.hintRow,children:[r.jsx(la,{className:tt.hoverCard}),"Right: download example"]})]})]})]}),r.jsxs("div",{className:"relative",children:[r.jsxs("button",{type:"button",onClick:I,onMouseEnter:()=>c("toy"),onMouseLeave:()=>c(null),disabled:y,className:`${ue.base} ${ue.sizes.action} ${ue.variants.secondary} ${y?ue.disabled:""}`,children:[r.jsx("img",{src:bo("LOGO.png"),alt:"",className:"w-3.5 h-3.5"}),"Try a Toy!"]}),l==="toy"&&r.jsxs("div",{className:`absolute left-1/2 -translate-x-1/2 bottom-full mb-2 z-50 ${se.container}`,children:[r.jsx("div",{className:se.title,children:"Load random 3D scan"}),r.jsx("div",{className:se.subtitle,children:"Multiview data from OpsiClear NGS dataset"}),r.jsx("div",{className:`${se.subtitle} text-ds-muted/70`,children:"huggingface.co/datasets/OpsiClear/NGS"}),r.jsx("div",{className:`${se.subtitle} mt-1`,children:"Includes: images, masks, sparse reconstruction"}),r.jsx("div",{className:se.hint,children:r.jsxs("div",{className:se.hintRow,children:[r.jsx(bs,{className:tt.hoverCard}),"Left: load random scan"]})})]})]})]})]})]})}),y&&v&&r.jsx("div",{className:Po.overlay,children:r.jsxs("div",{className:Po.container,children:[r.jsx("div",{className:"flex justify-center mb-4",children:r.jsx("img",{src:bo("LOGO.png"),alt:"Loading",className:"w-12 h-12 animate-bounce"})}),r.jsx("div",{className:Po.text,children:v.message}),r.jsx("div",{className:Po.progressBar,children:r.jsx("div",{className:Po.progressFill,style:{width:`${Math.round(v.percent)}%`}})}),r.jsxs("div",{className:Po.percentage,children:[Math.round(v.percent),"%"]}),v.currentFile&&r.jsx("div",{className:"text-white/70 text-xs mt-2 max-w-xs truncate",children:v.currentFile}),v.filesDownloaded!==void 0&&v.totalFiles!==void 0&&r.jsxs("div",{className:"text-white/70 text-xs mt-1",children:[v.filesDownloaded," / ",v.totalFiles," files"]})]})}),m&&r.jsxs("div",{className:`${lr.containerWithLayout} ${lr.error}`,children:[r.jsxs("div",{className:lr.content,children:[r.jsx("div",{className:lr.titleError,children:"Error loading data"}),r.jsx("div",{className:lr.message,children:m})]}),r.jsx("button",{onClick:()=>S(null),className:ue.close,children:"Ã—"})]}),r.jsx(cC,{isOpen:a,onClose:()=>i(!1),onLoad:E,loading:y})]})}const Lc=320,fr=100,_c=2,dC=18,Jr=16,es=8;function fC({title:e,bins:t}){const n=h.useRef(null),[o,s]=h.useState(null);h.useLayoutEffect(()=>{if(!n.current)return;const c=n.current.getBoundingClientRect(),d=window.innerWidth;if(c.left<es){const u=es-c.left;s(u)}else if(c.right>d-es){const u=c.right-(d-es);s(-u)}else s(null)},[]);const a=Math.max(...t.map(c=>c.percentage),1),i=(Lc-(t.length-1)*_c)/t.length,l=o!==null?`translateX(calc(-50% + ${o}px))`:"translateX(-50%)";return r.jsx("div",{ref:n,className:mi.container,style:{bottom:"100%",marginBottom:"8px",transform:l},children:r.jsxs("div",{className:mi.card,children:[r.jsx("div",{className:mi.title,children:e}),r.jsx("svg",{width:Lc,height:fr+dC+Jr,className:"mt-2",children:t.map((c,d)=>{const u=c.percentage/a*fr,f=d*(i+_c),p=Jr+fr-u;return r.jsxs("g",{children:[r.jsx("rect",{x:f,y:Jr,width:i,height:fr,fill:"rgba(255,255,255,0.05)",rx:3}),r.jsx("rect",{x:f,y:p,width:i,height:u||1,fill:"#f59e0b",rx:3}),r.jsx("text",{x:f+i/2,y:Jr+fr+12,textAnchor:"middle",fontSize:8,fontWeight:500,fill:"#e5e7eb",children:c.label}),c.percentage>=5&&r.jsxs("text",{x:f+i/2,y:p-3,textAnchor:"middle",fontSize:8,fontWeight:600,fill:"#fbbf24",children:[c.percentage.toFixed(0),"%"]})]},c.label)})})]})})}const Pf=[{label:"2",min:2,max:3},{label:"3",min:3,max:4},{label:"4",min:4,max:5},{label:"5",min:5,max:6},{label:"6",min:6,max:7},{label:"7",min:7,max:8},{label:"8",min:8,max:9},{label:"9",min:9,max:10},{label:"10",min:10,max:11},{label:"11-15",min:11,max:16},{label:"16-20",min:16,max:21},{label:"21+",min:21,max:1/0}],Lf=[{label:"0-.25",min:0,max:.25},{label:".25-.5",min:.25,max:.5},{label:".5-.75",min:.5,max:.75},{label:".75-1",min:.75,max:1},{label:"1-1.25",min:1,max:1.25},{label:"1.25-1.5",min:1.25,max:1.5},{label:"1.5-2",min:1.5,max:2},{label:"2-2.5",min:2,max:2.5},{label:"2.5-3",min:2.5,max:3},{label:"3-4",min:3,max:4},{label:"4-5",min:4,max:5},{label:"5+",min:5,max:1/0}];function _f(e,t){for(let n=0;n<t.length;n++)if(e>=t[n].min&&e<t[n].max)return n;return-1}function ca(e,t,n){return t.map((o,s)=>({label:o.label,count:e[s],percentage:n>0?e[s]/n*100:0}))}function hC(e,t){const n=t==="trackLength"?Pf:Lf,o=t==="trackLength"?e.getTrackLengths():e.getErrors();if(!o)return{bins:ca(new Array(n.length).fill(0),n,0),mean:0,total:0};const s=new Array(n.length).fill(0);let a=0;for(let l=0;l<o.length;l++){a+=o[l];const c=_f(o[l],n);c>=0&&s[c]++}const i=o.length;return{bins:ca(s,n,i),mean:i>0?a/i:0,total:i}}function mC(e,t){const n=t==="trackLength"?Pf:Lf,o=new Array(n.length).fill(0);let s=0,a=0;for(const i of e.values()){const l=t==="trackLength"?i.track.length:i.error;s+=l,a++;const c=_f(l,n);c>=0&&o[c]++}return{bins:ca(o,n,a),mean:a>0?s/a:0,total:a}}function Ac({label:e,value:t,type:n,points3D:o,wasmReconstruction:s}){const[a,i]=h.useState(!1),l=h.useMemo(()=>a?s?.hasPoints()?hC(s,n):o&&o.size>0?mC(o,n):null:null,[a,o,s,n]),c=n==="trackLength"?"Track Length Distribution":"Reprojection Error Distribution";return r.jsxs("span",{className:"relative cursor-help overflow-visible",onMouseEnter:()=>i(!0),onMouseLeave:()=>i(!1),children:[e,": ",r.jsx("span",{className:"text-ds-primary",children:t}),a&&l&&r.jsx(fC,{title:c,bins:l.bins})]})}class pC{getState;constructor(t){this.getState=t}getSourceType(){return this.getState().sourceType}isLoaded(){return this.getState().sourceType!==null}async getImage(t){const{sourceType:n,loadedFiles:o,imageUrlBase:s}=this.getState();switch(n){case"local":return ao(o?.imageFiles,t)??null;case"url":case"manifest":return s?mn(t)??await er(s,t):null;case"zip":return Zt()?un(t)??await qo(t):null;default:return null}}getImageSync(t){const{sourceType:n,loadedFiles:o}=this.getState();switch(n){case"local":return ao(o?.imageFiles,t);case"url":case"manifest":return mn(t);case"zip":return un(t);default:return}}async getMask(t){const{sourceType:n,loadedFiles:o,maskUrlBase:s}=this.getState();switch(n){case"local":return qi(o?.imageFiles,t)??null;case"url":case"manifest":return s?await rd(s,t):null;case"zip":return Zt()?await sd(t):null;default:return null}}getMaskSync(t){const{sourceType:n,loadedFiles:o}=this.getState();switch(n){case"local":return qi(o?.imageFiles,t);case"url":case"manifest":case"zip":return;default:return}}async prefetchImages(t,n=5){const{sourceType:o,imageUrlBase:s}=this.getState();switch(o){case"local":return;case"url":case"manifest":if(!s)return;await fg(s,t,n);return;case"zip":if(!Zt())return;const a=t.filter(i=>!un(i));for(let i=0;i<a.length;i+=n){const l=a.slice(i,i+n);await Promise.all(l.map(c=>qo(c)))}return;default:return}}hasImages(){const{sourceType:t,loadedFiles:n}=this.getState();switch(t){case"local":return(n?.imageFiles?.size??0)>0;case"url":case"manifest":return this.getState().imageUrlBase!==null;case"zip":return Zt();default:return!1}}hasMasks(){const{sourceType:t,loadedFiles:n,maskUrlBase:o}=this.getState();switch(t){case"local":return n?.hasMasks??!1;case"url":case"manifest":return o!==null;case"zip":return Zt();default:return!1}}getCacheStats(){const{sourceType:t,loadedFiles:n}=this.getState(),o=id(),s=ad(),a=ld(),i=gg(n?.imageFiles),l=o.count+s.count+a.count+i.count,c=o.sizeBytes+s.sizeBytes+a.sizeBytes+i.sizeBytes;return{urlImages:this.formatCacheEntry(o),zipImages:this.formatCacheEntry(s),zipMasks:this.formatCacheEntry(a),localImages:this.formatCacheEntry(i),total:this.formatCacheEntry({count:l,sizeBytes:c}),sourceType:t}}formatCacheEntry(t){return{count:t.count,sizeBytes:t.sizeBytes,sizeFormatted:this.formatBytes(t.sizeBytes)}}formatBytes(t){if(t===0)return"0 B";const n=["B","KB","MB","GB"],o=1024,s=Math.floor(Math.log(t)/Math.log(o)),a=t/Math.pow(o,s),i=a<10?2:a<100?1:0;return`${a.toFixed(i)} ${n[s]}`}getMemoryStats(){const{sourceType:t,loadedFiles:n}=this.getState(),o=ye.getState().reconstruction,s=ye.getState().wasmReconstruction,a=(L,ee)=>({count:L,sizeBytes:ee,sizeFormatted:this.formatBytes(ee)}),i=(L,ee,ie,te,de)=>({available:L,strategy:ee,memoryType:ie,memory:a(te,de)}),l=s?.hasPoints()??!1,c=l?s.pointCount:o?.points3D?.size??0,d=c*80;let u=0;if(o?.images)for(const L of o.images.values())u+=L.numPoints2D??L.points2D.length;const f=u*16,p=o?.cameras.size??0,g=p*200,y=o?.images.size??0,v=y*200,w=!!n?.databaseFile,x=o?.globalStats?.totalObservations??0,m=x*12,S=this.getCacheStats(),k=t==="local",j=k?"memory":"lazy",b=k?S.localImages.count:S.urlImages.count+S.zipImages.count,M=k?S.localImages.sizeBytes:S.urlImages.sizeBytes+S.zipImages.sizeBytes,E=S.zipMasks.count,P=S.zipMasks.sizeBytes,I=$u(),R=Hi(),A=I.count+R.bitmaps,G=I.count*75e3+R.bitmaps*65e3,F=w?n.databaseFile.size:0,z=!!n?.rigsFile,Z=z?n.rigsFile.size:0,U=td(),D=t==="zip",T=U.fileSize,$=l?d:0,K=(l?0:d)+f+g+v+m+F+Z;return{points3D:i(c>0,"memory",l?"wasm":"js",c,d),points2D:i(u>0,"memory","js",u,f),matches:i(x>0,"memory","js",x,m),cameras:i(p>0,"memory","js",p,g),imagePoses:i(y>0,"memory","js",y,v),imageFiles:i(this.hasImages(),j,"js",b,M),maskFiles:i(this.hasMasks(),k?"memory":"lazy","js",E,P),imagesDecoded:i(A>0,"memory","js",A,G),database:i(w,"memory","js",w?1:0,F),rigs:i(z,"memory","js",z?1:0,Z),zipArchive:i(D&&T>0,"memory","js",1,T),totalWasm:a(0,$),totalJs:a(0,K),totalCached:a(0,0),sourceType:t}}}let ki=null;function gC(){return ki||(ki=new pC(()=>{const e=ye.getState();return{sourceType:e.sourceType,imageUrlBase:e.imageUrlBase,maskUrlBase:e.maskUrlBase,loadedFiles:e.loadedFiles}})),ki}function xC(){return ye(e=>e.sourceType),ye(e=>e.imageUrlBase),ye(e=>e.loadedFiles),gC()}const yC={local:{label:"Local",color:"text-green-400"},url:{label:"URL",color:"text-blue-400"},manifest:{label:"Manifest",color:"text-purple-400"},zip:{label:"ZIP",color:"text-amber-400"}};function Nc({className:e=""}){return r.jsx("svg",{className:`w-3.5 h-3.5 ${e}`,fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",strokeWidth:2,children:r.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"})})}function vC({className:e=""}){return r.jsx("svg",{className:`w-3.5 h-3.5 ${e}`,fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",strokeWidth:2,children:r.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"})})}function wC({className:e=""}){return r.jsx("svg",{className:`w-3.5 h-3.5 ${e}`,fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",strokeWidth:2,children:r.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})})}function bC({className:e=""}){return r.jsx("svg",{className:`w-3.5 h-3.5 ${e}`,fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",strokeWidth:2,children:r.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"})})}function Rc(e,t=""){switch(e){case"local":return r.jsx(Nc,{className:t});case"url":return r.jsx(vC,{className:t});case"manifest":return r.jsx(wC,{className:t});case"zip":return r.jsx(bC,{className:t});default:return r.jsx(Nc,{className:t})}}function vr({strategy:e,memoryType:t="js"}){return e==="lazy"?r.jsx("span",{className:Ce.dotLazy}):e==="unavailable"?r.jsx("span",{className:Ce.dotUnavailable}):r.jsx("span",{className:t==="wasm"?Ce.dotMemoryWasm:Ce.dotMemoryJs})}function xr(e){if(e===0)return"0 B";const t=["B","KB","MB","GB"],n=1024,o=Math.floor(Math.log(e)/Math.log(n)),s=e/Math.pow(n,o),a=s<10?2:s<100?1:0;return`${s.toFixed(a)} ${t[o]}`}function No({label:e,strategy:t,memoryType:n="js",count:o,size:s,available:a}){const i=a?t:"unavailable",l=a?"":Ce.tableRowDimmed;return r.jsxs("tr",{className:l,children:[r.jsx("td",{className:Ce.tableCellLabel,children:r.jsxs("div",{className:Ce.tableCellLabelInner,children:[r.jsx(vr,{strategy:i,memoryType:n}),r.jsx("span",{className:Ce.tableCellLabelText,children:e})]})}),r.jsx("td",{className:Ce.tableCellCount,children:a?o.toLocaleString():"-"}),r.jsx("td",{className:Ce.tableCellSize,children:a?s:"-"})]})}function CC({entry:e}){return e.stats.count>0||e.stats.sizeBytes>0?r.jsxs("tr",{children:[r.jsx("td",{className:Ce.tableCellLabel,children:r.jsxs("div",{className:Ce.tableCellLabelInner,children:[r.jsx(vr,{strategy:e.strategy,memoryType:e.memoryType}),r.jsx("span",{className:Ce.tableCellLabelText,children:e.label})]})}),r.jsx("td",{className:Ce.tableCellCount,children:e.stats.count.toLocaleString()}),r.jsx("td",{className:Ce.tableCellSize,children:xr(e.stats.sizeBytes)})]}):null}const ts=8;function kC(){const e=xC(),t=ye(y=>y.reconstruction),[n,o]=h.useState(!1),[s,a]=h.useState(null),[i,l]=h.useState([]),c=h.useRef(null),[d,u]=h.useState(null),f=e.getSourceType(),p=f?yC[f]:null;h.useEffect(()=>{n&&(a(e.getMemoryStats()),l(yg()))},[n,e]),h.useLayoutEffect(()=>{if(!n||!c.current){u(null);return}const y=c.current.getBoundingClientRect(),v=window.innerWidth;y.left<ts?u(ts-y.left):y.right>v-ts?u(-(y.right-(v-ts))):u(null)},[n,s]);const g=h.useMemo(()=>{let y=0,v=0,w=0,x=0;for(const m of i)m.strategy==="lazy"?(w+=m.stats.sizeBytes,x+=m.stats.count):m.memoryType==="wasm"?v+=m.stats.sizeBytes:y+=m.stats.sizeBytes;return{jsBytes:y,wasmBytes:v,lazyBytes:w,lazyCount:x}},[i]);return t?r.jsxs("span",{className:Ce.wrapper,onMouseEnter:()=>o(!0),onMouseLeave:()=>o(!1),children:[r.jsxs("span",{className:Ce.indicator,children:[r.jsx("span",{className:`flex items-center ${p?.color}`,children:Rc(f)}),r.jsx("span",{className:Ce.indicatorLabel,children:"Source:"}),r.jsx("span",{className:Ce.indicatorValue,children:p?.label??"None"})]}),n&&s&&r.jsx("div",{ref:c,className:Ce.tooltipContainer,style:{bottom:"100%",marginBottom:"8px",left:d!==null?d:0},children:r.jsxs("div",{className:Ce.card,children:[r.jsxs("div",{className:Ce.header,children:[r.jsxs("div",{className:Ce.headerTitle,children:[r.jsx("span",{className:p?.color,children:Rc(f)}),p?.label," Dataset"]}),r.jsxs("div",{className:Ce.headerLegend,children:[r.jsxs("span",{className:Ce.legendItem,children:[r.jsx(vr,{strategy:"memory",memoryType:"js"}),r.jsx("span",{className:Ce.legendText,children:"Loaded"})]}),r.jsxs("span",{className:Ce.legendItem,children:[r.jsx(vr,{strategy:"memory",memoryType:"wasm"}),r.jsx("span",{className:Ce.legendText,children:"WASM"})]}),r.jsxs("span",{className:Ce.legendItem,children:[r.jsx(vr,{strategy:"lazy"}),r.jsx("span",{className:Ce.legendText,children:"Lazy"})]})]})]}),r.jsxs("table",{className:Ce.table,children:[r.jsx("thead",{children:r.jsxs("tr",{className:Ce.tableHeader,children:[r.jsx("th",{className:`${Ce.tableHeaderCell} ${Ce.tableHeaderLeft}`,children:"Resource"}),r.jsx("th",{className:`${Ce.tableHeaderCell} ${Ce.tableHeaderRight} px-2`,children:"Count"}),r.jsx("th",{className:`${Ce.tableHeaderCell} ${Ce.tableHeaderRight} pl-2`,children:"Size"})]})}),r.jsxs("tbody",{children:[r.jsx(No,{label:"3D Points",strategy:s.points3D.strategy,memoryType:s.points3D.memoryType,count:s.points3D.memory.count,size:s.points3D.memory.sizeFormatted,available:s.points3D.available}),r.jsx(No,{label:"2D Keypoints",strategy:s.points2D.strategy,memoryType:s.points2D.memoryType,count:s.points2D.memory.count,size:s.points2D.memory.sizeFormatted,available:s.points2D.available}),r.jsx(No,{label:"Matches",strategy:s.matches.strategy,memoryType:s.matches.memoryType,count:s.matches.memory.count,size:s.matches.memory.sizeFormatted,available:s.matches.available}),r.jsx(No,{label:s.rigs.available?"Cameras/Rigs":"Cameras",strategy:s.cameras.strategy,memoryType:s.cameras.memoryType,count:s.cameras.memory.count+(s.rigs.available?s.rigs.memory.count:0),size:xr(s.cameras.memory.sizeBytes+(s.rigs.available?s.rigs.memory.sizeBytes:0)),available:s.cameras.available}),r.jsx(No,{label:"Camera Poses",strategy:s.imagePoses.strategy,memoryType:s.imagePoses.memoryType,count:s.imagePoses.memory.count,size:s.imagePoses.memory.sizeFormatted,available:s.imagePoses.available}),s.database.available&&r.jsx(No,{label:"Database",strategy:s.database.strategy,memoryType:s.database.memoryType,count:s.database.memory.count,size:s.database.memory.sizeFormatted,available:s.database.available}),i.map(y=>r.jsx(CC,{entry:y},y.name))]}),r.jsxs("tfoot",{children:[(s.totalWasm.sizeBytes>0||g.wasmBytes>0)&&r.jsxs("tr",{className:Ce.tableFooter,children:[r.jsx("td",{className:Ce.tableFooterCell,children:r.jsx("span",{className:Ce.tableFooterLabel,children:"WASM Loaded"})}),r.jsx("td",{className:`${Ce.tableFooterCell} ${Ce.tableCellCount}`}),r.jsx("td",{className:`${Ce.tableFooterCell} ${Ce.tableCellSize} text-amber-400`,children:xr(s.totalWasm.sizeBytes+g.wasmBytes)})]}),r.jsxs("tr",{className:Ce.tableFooter,style:{borderTop:s.totalWasm.sizeBytes>0||g.wasmBytes>0?"none":void 0},children:[r.jsx("td",{className:Ce.tableFooterCell,children:r.jsx("span",{className:Ce.tableFooterLabel,children:"JS Loaded"})}),r.jsx("td",{className:`${Ce.tableFooterCell} ${Ce.tableCellCount}`}),r.jsx("td",{className:`${Ce.tableFooterCell} ${Ce.tableCellSize} text-green-400`,children:xr(s.totalJs.sizeBytes+g.jsBytes)})]}),(s.totalCached.sizeBytes>0||g.lazyBytes>0)&&r.jsxs("tr",{className:Ce.tableFooter,style:{borderTop:"none"},children:[r.jsx("td",{className:Ce.tableFooterCell,children:r.jsx("span",{className:Ce.tableFooterLabel,children:"JS Lazy"})}),r.jsx("td",{className:`${Ce.tableFooterCell} ${Ce.tableCellCount} text-blue-400`,children:(s.totalCached.count+g.lazyCount).toLocaleString()}),r.jsx("td",{className:`${Ce.tableFooterCell} ${Ce.tableCellSize} text-blue-400`,children:xr(s.totalCached.sizeBytes+g.lazyBytes)})]})]})]})]})})]}):null}function SC(){const e=ye(a=>a.urlLoading),t=ye(a=>a.reconstruction),n=ye(a=>a.wasmReconstruction),o=q(a=>a.fps),s=t?.globalStats;return r.jsxs("footer",{className:El.container,children:[r.jsxs("div",{className:El.group,children:[r.jsxs("span",{className:"text-ds-tertiary",children:[o," FPS"]}),r.jsx(kC,{}),t&&s&&r.jsxs(r.Fragment,{children:[r.jsx(Ac,{label:"Avg Track",value:s.avgTrackLength.toFixed(2),type:"trackLength",points3D:t.points3D,wasmReconstruction:n}),r.jsx(Ac,{label:"Avg Reproj Error",value:`${s.avgError.toFixed(3)}px`,type:"error",points3D:t.points3D,wasmReconstruction:n})]}),!t&&r.jsx("span",{children:e?"Loading...":"Drop COLMAP folder to load"})]}),r.jsxs("div",{className:"flex items-center gap-2 text-ds-secondary",children:[r.jsx("span",{children:"ColmapView by OpsiClear"}),r.jsx("span",{children:"|"}),r.jsx("a",{href:"https://github.com/ColmapView/colmapview.github.io",target:"_blank",rel:"noopener noreferrer",className:"no-underline transition-colors",style:{color:"inherit"},title:"Star on GitHub",onMouseEnter:a=>a.currentTarget.style.color="#facc15",onMouseLeave:a=>a.currentTarget.style.color="inherit",children:"â˜… Star on GitHub"}),r.jsx("span",{children:"|"}),r.jsx("a",{href:"https://github.com/ColmapView/colmapview.github.io/issues",target:"_blank",rel:"noopener noreferrer",className:"no-underline transition-colors",style:{color:"inherit"},title:"Report Bugs",onMouseEnter:a=>a.currentTarget.style.color="#ef4444",onMouseLeave:a=>a.currentTarget.style.color="inherit",children:"Report Bugs"}),r.jsx("span",{children:"|"}),r.jsx("span",{children:"AGPL 3.0"}),r.jsx("span",{children:"|"}),r.jsxs("span",{children:["Based on"," ",r.jsx("a",{href:"https://github.com/colmap/colmap",target:"_blank",rel:"noopener noreferrer",className:"no-underline transition-colors",style:{color:"inherit"},title:"COLMAP - Structure-from-Motion and Multi-View Stereo",onMouseEnter:a=>a.currentTarget.style.color="#60a5fa",onMouseLeave:a=>a.currentTarget.style.color="inherit",children:"COLMAP"})]}),r.jsx("span",{children:"|"}),r.jsxs("span",{children:["v","0.4.7"]})]})]})}const jC=new $n;function vo(e){return e<=ar.threshold?e/ar.linearScale:Math.pow((e+ar.gammaOffset)/ar.gammaScale,ar.gamma)}function ua(e){const t=e%1;return jC.setHSL(t,Xn.saturation,Xn.lightness)}function _r(e){const{threshold1:t,threshold2:n,threshold3:o,multiplier:s}=Zs.jet;return e=Math.max(0,Math.min(1,e)),e<t?[0,e*s,1]:e<n?[0,1,1-(e-t)*s]:e<o?[(e-n)*s,1,0]:[1,1-(e-o)*s,0]}function Bs(e,t,n){t/=100,n/=100;const o=t*Math.min(n,1-n),s=a=>{const i=(a+e/30)%12,l=n-o*Math.max(Math.min(i-3,9-i,1),-1);return Math.round(255*l).toString(16).padStart(2,"0")};return`#${s(0)}${s(8)}${s(4)}`}function da(e){const t=parseInt(e.slice(1,3),16)/255,n=parseInt(e.slice(3,5),16)/255,o=parseInt(e.slice(5,7),16)/255,s=Math.max(t,n,o),a=Math.min(t,n,o);let i=0,l=0;const c=(s+a)/2;if(s!==a){const d=s-a;switch(l=c>.5?d/(2-s-a):d/(s+a),s){case t:i=((n-o)/d+(n<o?6:0))/6;break;case n:i=((o-t)/d+2)/6;break;case o:i=((t-n)/d+4)/6;break}}return{h:Math.round(i*360),s:Math.round(l*100),l:Math.round(c*100)}}function IC(e,t,n){const{wasmColors:o,wasmErrors:s,wasmTrackLengths:a,minError:i,maxError:l,minTrack:c,maxTrack:d,floorColorMode:u,pointDistances:f,distanceThreshold:p,maxFloorDist:g}=n;if(u!=="off"&&f){if(u==="binary")return Math.abs(f[e])<=p?[.2,.9,.2]:[.9,.2,.2];const y=Math.abs(f[e])/g;return _r(y)}if(t==="error"){const y=s[e]>=0?(s[e]-i)/(l-i):0;return _r(y)}if(t==="trackLength"){const{baseR:y,rangeR:v,baseG:w,rangeG:x,baseB:m,rangeB:S}=Zs.trackLength,k=(a[e]-c)/(d-c);return[y+k*v,w+k*x,m-k*S]}return o?[vo(o[e*3]),vo(o[e*3+1]),vo(o[e*3+2])]:[1,1,1]}function MC(e,t,n){const{minError:o,maxError:s,minTrack:a,maxTrack:i}=n;if(t==="error"){const l=e.error>=0?(e.error-o)/(s-o):0;return _r(l)}if(t==="trackLength"){const{baseR:l,rangeR:c,baseG:d,rangeG:u,baseB:f,rangeB:p}=Zs.trackLength,g=(e.track.length-a)/(i-a);return[l+g*c,d+g*u,f-g*p]}return[vo(e.rgb[0]/fi.max),vo(e.rgb[1]/fi.max),vo(e.rgb[2]/fi.max)]}function EC(e,t,n,o,s){const a=new Float32Array(e*3);if(t==="rgb")if(n)for(let i=0;i<n.length;i++)a[i]=vo(n[i]);else a.fill(1);else if(t==="error")if(o){let i=1/0,l=-1/0;for(let c=0;c<e;c++)o[c]>=0&&(i=Math.min(i,o[c]),l=Math.max(l,o[c]));i===l&&(l=i+1);for(let c=0;c<e;c++){const d=o[c]>=0?(o[c]-i)/(l-i):0,[u,f,p]=_r(d);a[c*3]=u,a[c*3+1]=f,a[c*3+2]=p}}else a.fill(1);else if(s){let i=1/0,l=-1/0;for(let y=0;y<e;y++)i=Math.min(i,s[y]),l=Math.max(l,s[y]);i===l&&(l=i+1);const{baseR:c,rangeR:d,baseG:u,rangeG:f,baseB:p,rangeB:g}=Zs.trackLength;for(let y=0;y<e;y++){const v=(s[y]-i)/(l-i);a[y*3]=c+v*d,a[y*3+1]=u+v*f,a[y*3+2]=p-v*g}}else a.fill(1);return a}function PC(e,t,n,o,s){if(n==="binary")for(let a=0;a<t;a++){const i=Math.abs(o[a])<=s;e[a*3]=i?.2:.9,e[a*3+1]=i?.9:.2,e[a*3+2]=.2}else{let a=0;for(let i=0;i<t;i++)a=Math.max(a,Math.abs(o[i]));a===0&&(a=1);for(let i=0;i<t;i++){const l=Math.abs(o[i])/a,[c,d,u]=_r(l);e[i*3]=c,e[i*3+1]=d,e[i*3+2]=u}}}function LC(e){const{reconstruction:t,wasmReconstruction:n,colorMode:o,minTrackLength:s,maxReprojectionError:a,selectedImageId:i,showSelectionHighlight:l,selectionColor:c,floorColorMode:d,pointDistances:u,distanceThreshold:f}=e,p=h.useRef(new Map),g=h.useMemo(()=>{const m=new $n(c);return[m.r,m.g,m.b]},[c]),{positions:y,colors:v,selectedPositions:w,selectedColors:x}=h.useMemo(()=>{if(!t)return p.current=new Map,{positions:null,colors:null,selectedPositions:null,selectedColors:null};const m=performance.now(),S=s<=1&&a>=1e3;if(n?.hasPoints()&&S){const k=_C(n,t,o,i,l,g,d,u,f,p,m);if(k)return k}return NC(t,n,o,s,a,i,l,g,d,u,f,p)},[t,n,o,s,a,i,l,g,u,f,d]);return{positions:y,colors:v,selectedPositions:w,selectedColors:x,indexToPoint3DId:p.current,indexToPoint3DIdRef:p}}function _C(e,t,n,o,s,a,i,l,c,d,u){const f=e.pointCount,p=new Map;for(let b=0;b<f;b++)p.set(b,BigInt(b+1));d.current&&(d.current=p);const g=e.getPositions();if(!g)return console.warn("[PointCloud] WASM positions not available, falling back to slow path"),null;const y=e.getColors(),v=e.getErrors(),w=e.getTrackLengths(),x=EC(f,n,y,v,w);i!=="off"&&l&&l.length===f&&PC(x,f,i,l,c);let m=null,S=null;if(s&&o!==null){const b=AC(e,t,o,g,a);m=b.selectedPositions,S=b.selectedColors}const k=performance.now()-u,j=m?`, ${m.length/3} highlighted`:"";return console.log(`[PointCloud] Fast path: ${f.toLocaleString()} points in ${k.toFixed(1)}ms${j}`),{positions:g,colors:x,selectedPositions:m,selectedColors:S}}function AC(e,t,n,o,s){const a=t.imageToPoint3DIds.get(n)??new Set;if(a.size===0)return{selectedPositions:null,selectedColors:null};const i=e.pointCount,l=e.getPoint3DIds();let c=0;for(let p=0;p<i;p++){const g=l?l[p]:BigInt(p+1);a.has(g)&&c++}if(c===0)return{selectedPositions:null,selectedColors:null};const d=new Float32Array(c*3),u=new Float32Array(c*3);let f=0;for(let p=0;p<i;p++){const g=l?l[p]:BigInt(p+1);if(a.has(g)){const y=f*3;d[y]=o[p*3],d[y+1]=o[p*3+1],d[y+2]=o[p*3+2],u[y]=s[0],u[y+1]=s[1],u[y+2]=s[2],f++}}return{selectedPositions:d,selectedColors:u}}function NC(e,t,n,o,s,a,i,l,c,d,u,f){const p=performance.now(),g=a!==null?e.imageToPoint3DIds.get(a)??new Set:new Set;if(t?.hasPoints()){const y=RC(t,n,o,s,g,i,l,c,d,u,f,p);if(y)return y}return FC(e,n,o,s,g,i,l,f,p)}function RC(e,t,n,o,s,a,i,l,c,d,u,f){const p=e.pointCount,g=e.getPositions(),y=e.getColors(),v=e.getErrors(),w=e.getTrackLengths(),x=e.getPoint3DIds();if(!g||!v||!w)return null;let m=1/0,S=-1/0,k=1/0,j=-1/0,b=0,M=0;const E=new Uint8Array(p);for(let $=0;$<p;$++){if(w[$]<n||v[$]>o)continue;v[$]>=0&&(m=Math.min(m,v[$]),S=Math.max(S,v[$])),k=Math.min(k,w[$]),j=Math.max(j,w[$]);const Q=x?x[$]:BigInt($+1),K=a&&s.has(Q);E[$]=K?2:1,b++,K&&M++}if(b===0){const $=performance.now()-f;return console.log(`[PointCloud] WASM slow path: 0 points after filtering in ${$.toFixed(1)}ms`),u.current&&(u.current=new Map),{positions:null,colors:null,selectedPositions:null,selectedColors:null}}m===S&&(S=m+1),k===j&&(j=k+1);let P=0;if(l==="distance"&&c){for(let $=0;$<p;$++)E[$]>0&&(P=Math.max(P,Math.abs(c[$])));P===0&&(P=1)}const I={wasmColors:y,wasmErrors:v,wasmTrackLengths:w,minError:m,maxError:S,minTrack:k,maxTrack:j,floorColorMode:l,pointDistances:c,distanceThreshold:d,maxFloorDist:P},R=new Float32Array(b*3),A=new Float32Array(b*3),G=M>0?new Float32Array(M*3):null,F=M>0?new Float32Array(M*3):null,z=new Map;let Z=0,U=0;for(let $=0;$<p;$++){const Q=E[$];if(Q===0)continue;const K=Z*3;R[K]=g[$*3],R[K+1]=g[$*3+1],R[K+2]=g[$*3+2];const re=IC($,t,I);A[K]=re[0],A[K+1]=re[1],A[K+2]=re[2];const J=x?x[$]:BigInt($+1);if(z.set(Z,J),Z++,Q===2&&G&&F){const L=U*3;G[L]=g[$*3],G[L+1]=g[$*3+1],G[L+2]=g[$*3+2],F[L]=i[0],F[L+1]=i[1],F[L+2]=i[2],U++}}u.current&&(u.current=z);const D=performance.now()-f,T=M>0?`, ${M.toLocaleString()} highlighted`:"";return console.log(`[PointCloud] WASM slow path: ${b.toLocaleString()} points in ${D.toFixed(1)}ms${T}`),{positions:R,colors:A,selectedPositions:G,selectedColors:F}}function FC(e,t,n,o,s,a,i,l,c){if(!e.points3D||e.points3D.size===0)return console.warn("[PointCloud] No points3D Map and WASM not available"),l.current&&(l.current=new Map),{positions:null,colors:null,selectedPositions:null,selectedColors:null};let d=1/0,u=-1/0,f=1/0,p=-1/0;const g=[],y=[];for(const M of e.points3D.values()){if(M.track.length<n||M.error>o)continue;M.error>=0&&(d=Math.min(d,M.error),u=Math.max(u,M.error)),f=Math.min(f,M.track.length),p=Math.max(p,M.track.length),g.push(M);const E=s.has(M.point3DId);a&&E&&y.push(M)}if(g.length===0){const M=performance.now()-c;return console.log(`[PointCloud] Map slow path: 0 points after filtering in ${M.toFixed(1)}ms`),l.current&&(l.current=new Map),{positions:null,colors:null,selectedPositions:null,selectedColors:null}}d===u&&(u=d+1),f===p&&(p=f+1);const v={minError:d,maxError:u,minTrack:f,maxTrack:p},w=new Map,x=new Float32Array(g.length*3),m=new Float32Array(g.length*3);for(let M=0;M<g.length;M++){const E=g[M],P=M*3;x[P]=E.xyz[0],x[P+1]=E.xyz[1],x[P+2]=E.xyz[2];const I=MC(E,t,v);m[P]=I[0],m[P+1]=I[1],m[P+2]=I[2],w.set(M,E.point3DId)}l.current&&(l.current=w);let S=null,k=null;if(y.length>0){S=new Float32Array(y.length*3),k=new Float32Array(y.length*3);for(let M=0;M<y.length;M++){const E=y[M],P=M*3;S[P]=E.xyz[0],S[P+1]=E.xyz[1],S[P+2]=E.xyz[2],k[P]=i[0],k[P+1]=i[1],k[P+2]=i[2]}}const j=performance.now()-c,b=y.length>0?`, ${y.length.toLocaleString()} highlighted`:"";return console.log(`[PointCloud] Map slow path: ${g.length.toLocaleString()} points in ${j.toFixed(1)}ms${b}`),{positions:x,colors:m,selectedPositions:S,selectedColors:k}}function TC(e){const{pickingMode:t,selectedPointsLength:n,pointSize:o,indexToPoint3DIdRef:s,addSelectedPoint:a,setHoveredPoint:i}=e,{camera:l,gl:c,raycaster:d}=In(),u=h.useRef(null),f=h.useRef(new pa),p=h.useRef(0),g=h.useRef(!1),y=h.useRef(new V),v=h.useRef(null),w=DC(t),x=t!=="off"&&n<w,m=h.useCallback(k=>{const j=u.current;if(!j||k.length===0)return null;let b=-1,M=1/0,E=null;for(let P=0;P<k.length;P++){const I=k[P];if(I.object!==j||I.index===void 0)continue;const R=I.distanceToRay??1/0;R<M&&(M=R,b=I.index,E=I.point)}return b===-1||!E?null:(y.current.copy(E),{index:b,worldPos:y.current})},[]);h.useEffect(()=>{if(t==="off")return;const k=c.domElement,j=k.getBoundingClientRect();function b(E){f.current.x=(E.clientX-j.left)/j.width*2-1,f.current.y=-((E.clientY-j.top)/j.height)*2+1,g.current=!0}function M(){g.current=!1,v.current!==null&&(v.current=null,i(null))}return k.addEventListener("mousemove",b,{passive:!0}),k.addEventListener("mouseleave",M),()=>{k.removeEventListener("mousemove",b),k.removeEventListener("mouseleave",M)}},[t,c,i]),En(()=>{if(t==="off"||!g.current||!u.current||n>=w)return;const k=performance.now();if(k-p.current<80)return;p.current=k,g.current=!1,d.setFromCamera(f.current,l);const j=d.intersectObject(u.current),b=m(j);if(b){const M=v.current;if(M&&M.distanceToSquared(b.worldPos)<1e-8)return;v.current=b.worldPos.clone(),i(v.current)}else v.current!==null&&(v.current=null,i(null))});const S=h.useCallback(k=>{if(t==="off"||!u.current||n>=w)return;k.stopPropagation();const j=m(k.intersections);if(!j)return;const b=s.current?.get(j.index);if(b===void 0)return;const M=k.nativeEvent;a({position:j.worldPos.clone(),point3DId:b},{x:M.clientX,y:M.clientY})},[t,n,w,a,m,s]);return h.useEffect(()=>{t!=="off"&&(d.params.Points.threshold=o*.3)},[t,o,d]),h.useEffect(()=>{t==="off"&&i(null)},[t,i]),{pointsRef:u,handlePointClick:S,needsMorePoints:x}}function DC(e){switch(e){case"origin-1pt":return 1;case"distance-2pt":return 2;case"normal-3pt":return 3;default:return 0}}function zC(e){const{selectedImageId:t,selectionColorMode:n,selectionAnimationSpeed:o,selectionColor:s}=e,a=h.useRef(null),i=h.useRef(0),l=h.useRef(new $n);return En((c,d)=>{if(t!==null&&a.current)if(n==="rainbow")i.current=(i.current+d*o*Xn.speedMultiplier)%1,a.current.color.copy(ua(i.current)),a.current.opacity=1;else if(n==="blink"){const f=.1+.9*((Math.sin(c.clock.elapsedTime*o*2)+1)/2);l.current.set(s),a.current.color.setRGB(l.current.r*f,l.current.g*f,l.current.b*f)}else n==="static"&&(l.current.set(s),a.current.color.copy(l.current),a.current.opacity=1)}),h.useEffect(()=>{a.current&&(n==="rainbow"?(a.current.vertexColors=!1,a.current.color.copy(ua(i.current)),a.current.opacity=1,a.current.needsUpdate=!0):n==="blink"?(a.current.vertexColors=!1,a.current.color.set(s),a.current.transparent=!0,a.current.needsUpdate=!0):(a.current.vertexColors=!1,a.current.color.set(s),a.current.opacity=1,a.current.needsUpdate=!0))},[n,s]),{selectedMaterialRef:a}}function OC(e){const{selectedPositions:t,selectedColors:n,pointSize:o,selectedImageId:s,selectionColorMode:a,selectionAnimationSpeed:i,selectionColor:l}=e,{selectedMaterialRef:c}=zC({selectedImageId:s,selectionColorMode:a,selectionAnimationSpeed:i,selectionColor:l}),d=h.useMemo(()=>{if(!t||!n||t.length===0)return null;const u=new Ho;return u.setAttribute("position",new js(t,3)),u.setAttribute("color",new js(n,3)),u.computeBoundingSphere(),u},[t,n]);return h.useEffect(()=>()=>{d?.dispose()},[d]),d?r.jsx("points",{matrixAutoUpdate:!1,geometry:d,renderOrder:2,raycast:()=>{},children:r.jsx("pointsMaterial",{ref:c,size:o+1,vertexColors:!1,color:l,transparent:!0,sizeAttenuation:!1,depthTest:!1})}):r.jsx(r.Fragment,{})}function Fc(){const e=ye(z=>z.reconstruction),t=ye(z=>z.wasmReconstruction),n=Qe(z=>z.showPointCloud),o=Qe(z=>z.colorMode),s=Qe(z=>z.pointSize),a=Qe(z=>z.pointOpacity),i=Qe(z=>z.minTrackLength),l=Qe(z=>z.maxReprojectionError),c=B(z=>z.selectedImageId),d=B(z=>z.showSelectionHighlight),u=B(z=>z.selectionColorMode),f=B(z=>z.selectionAnimationSpeed),p=B(z=>z.selectionColor),g=Ve(z=>z.pickingMode),y=Ve(z=>z.selectedPoints.length),v=Ve(z=>z.addSelectedPoint),w=Ve(z=>z.setHoveredPoint),x=Ge(z=>z.pointDistances),m=Ge(z=>z.distanceThreshold),S=Ge(z=>z.floorColorMode),{positions:k,colors:j,selectedPositions:b,selectedColors:M,indexToPoint3DIdRef:E}=LC({reconstruction:e,wasmReconstruction:t,colorMode:o,minTrackLength:i,maxReprojectionError:l,selectedImageId:c,showSelectionHighlight:d,selectionColor:p,floorColorMode:S,pointDistances:x,distanceThreshold:m}),{pointsRef:P,handlePointClick:I,needsMorePoints:R}=TC({pickingMode:g,selectedPointsLength:y,pointSize:s,indexToPoint3DIdRef:E,addSelectedPoint:v,setHoveredPoint:w}),A=h.useMemo(()=>{if(!k||!j)return null;const z=new Ho;return z.setAttribute("position",new js(k,3)),z.setAttribute("color",new js(j,3)),z.computeBoundingSphere(),z},[k,j]);h.useEffect(()=>()=>{A?.dispose()},[A]);const G=A!==null,F=b!==null&&M!==null&&b.length>0;return!G&&!F?null:r.jsxs(r.Fragment,{children:[n&&A&&r.jsx("points",{ref:P,matrixAutoUpdate:!1,geometry:A,renderOrder:1,onClick:R?I:void 0,children:r.jsx("pointsMaterial",{size:s,vertexColors:!0,sizeAttenuation:!1,transparent:!0,opacity:a})}),F&&b&&M&&r.jsx(OC,{selectedPositions:b,selectedColors:M,pointSize:s,selectedImageId:c,selectionColorMode:u,selectionAnimationSpeed:f,selectionColor:p})]})}const Tc=new ga,ns=new V;class Af extends Mh{constructor(){super(),this.isLineSegmentsGeometry=!0,this.type="LineSegmentsGeometry";const t=[-1,2,0,1,2,0,-1,1,0,1,1,0,-1,0,0,1,0,0,-1,-1,0,1,-1,0],n=[-1,2,1,2,-1,1,1,1,-1,-1,1,-1,-1,-2,1,-2],o=[0,2,1,2,3,1,2,4,3,4,5,3,4,6,5,6,7,5];this.setIndex(o),this.setAttribute("position",new br(t,3)),this.setAttribute("uv",new br(n,2))}applyMatrix4(t){const n=this.attributes.instanceStart,o=this.attributes.instanceEnd;return n!==void 0&&(n.applyMatrix4(t),o.applyMatrix4(t),n.needsUpdate=!0),this.boundingBox!==null&&this.computeBoundingBox(),this.boundingSphere!==null&&this.computeBoundingSphere(),this}setPositions(t){let n;t instanceof Float32Array?n=t:Array.isArray(t)&&(n=new Float32Array(t));const o=new zi(n,6,1);return this.setAttribute("instanceStart",new To(o,3,0)),this.setAttribute("instanceEnd",new To(o,3,3)),this.instanceCount=this.attributes.instanceStart.count,this.computeBoundingBox(),this.computeBoundingSphere(),this}setColors(t){let n;t instanceof Float32Array?n=t:Array.isArray(t)&&(n=new Float32Array(t));const o=new zi(n,6,1);return this.setAttribute("instanceColorStart",new To(o,3,0)),this.setAttribute("instanceColorEnd",new To(o,3,3)),this}fromWireframeGeometry(t){return this.setPositions(t.attributes.position.array),this}fromEdgesGeometry(t){return this.setPositions(t.attributes.position.array),this}fromMesh(t){return this.fromWireframeGeometry(new Eh(t.geometry)),this}fromLineSegments(t){const n=t.geometry;return this.setPositions(n.attributes.position.array),this}computeBoundingBox(){this.boundingBox===null&&(this.boundingBox=new ga);const t=this.attributes.instanceStart,n=this.attributes.instanceEnd;t!==void 0&&n!==void 0&&(this.boundingBox.setFromBufferAttribute(t),Tc.setFromBufferAttribute(n),this.boundingBox.union(Tc))}computeBoundingSphere(){this.boundingSphere===null&&(this.boundingSphere=new pu),this.boundingBox===null&&this.computeBoundingBox();const t=this.attributes.instanceStart,n=this.attributes.instanceEnd;if(t!==void 0&&n!==void 0){const o=this.boundingSphere.center;this.boundingBox.getCenter(o);let s=0;for(let a=0,i=t.count;a<i;a++)ns.fromBufferAttribute(t,a),s=Math.max(s,o.distanceToSquared(ns)),ns.fromBufferAttribute(n,a),s=Math.max(s,o.distanceToSquared(ns));this.boundingSphere.radius=Math.sqrt(s),isNaN(this.boundingSphere.radius)&&console.error("THREE.LineSegmentsGeometry.computeBoundingSphere(): Computed radius is NaN. The instanced position data is likely to have NaN values.",this)}}toJSON(){}}us.line={worldUnits:{value:1},linewidth:{value:1},resolution:{value:new pa(1,1)},dashOffset:{value:0},dashScale:{value:1},dashSize:{value:1},gapSize:{value:1}};ds.line={uniforms:gu.merge([us.common,us.fog,us.line]),vertexShader:`
		#include <common>
		#include <color_pars_vertex>
		#include <fog_pars_vertex>
		#include <logdepthbuf_pars_vertex>
		#include <clipping_planes_pars_vertex>

		uniform float linewidth;
		uniform vec2 resolution;

		attribute vec3 instanceStart;
		attribute vec3 instanceEnd;

		attribute vec3 instanceColorStart;
		attribute vec3 instanceColorEnd;

		#ifdef WORLD_UNITS

			varying vec4 worldPos;
			varying vec3 worldStart;
			varying vec3 worldEnd;

			#ifdef USE_DASH

				varying vec2 vUv;

			#endif

		#else

			varying vec2 vUv;

		#endif

		#ifdef USE_DASH

			uniform float dashScale;
			attribute float instanceDistanceStart;
			attribute float instanceDistanceEnd;
			varying float vLineDistance;

		#endif

		void trimSegment( const in vec4 start, inout vec4 end ) {

			// trim end segment so it terminates between the camera plane and the near plane

			// conservative estimate of the near plane
			float a = projectionMatrix[ 2 ][ 2 ]; // 3nd entry in 3th column
			float b = projectionMatrix[ 3 ][ 2 ]; // 3nd entry in 4th column
			float nearEstimate = - 0.5 * b / a;

			float alpha = ( nearEstimate - start.z ) / ( end.z - start.z );

			end.xyz = mix( start.xyz, end.xyz, alpha );

		}

		void main() {

			#ifdef USE_COLOR

				vColor.xyz = ( position.y < 0.5 ) ? instanceColorStart : instanceColorEnd;

			#endif

			#ifdef USE_DASH

				vLineDistance = ( position.y < 0.5 ) ? dashScale * instanceDistanceStart : dashScale * instanceDistanceEnd;
				vUv = uv;

			#endif

			float aspect = resolution.x / resolution.y;

			// camera space
			vec4 start = modelViewMatrix * vec4( instanceStart, 1.0 );
			vec4 end = modelViewMatrix * vec4( instanceEnd, 1.0 );

			#ifdef WORLD_UNITS

				worldStart = start.xyz;
				worldEnd = end.xyz;

			#else

				vUv = uv;

			#endif

			// special case for perspective projection, and segments that terminate either in, or behind, the camera plane
			// clearly the gpu firmware has a way of addressing this issue when projecting into ndc space
			// but we need to perform ndc-space calculations in the shader, so we must address this issue directly
			// perhaps there is a more elegant solution -- WestLangley

			bool perspective = ( projectionMatrix[ 2 ][ 3 ] == - 1.0 ); // 4th entry in the 3rd column

			if ( perspective ) {

				if ( start.z < 0.0 && end.z >= 0.0 ) {

					trimSegment( start, end );

				} else if ( end.z < 0.0 && start.z >= 0.0 ) {

					trimSegment( end, start );

				}

			}

			// clip space
			vec4 clipStart = projectionMatrix * start;
			vec4 clipEnd = projectionMatrix * end;

			// ndc space
			vec3 ndcStart = clipStart.xyz / clipStart.w;
			vec3 ndcEnd = clipEnd.xyz / clipEnd.w;

			// direction
			vec2 dir = ndcEnd.xy - ndcStart.xy;

			// account for clip-space aspect ratio
			dir.x *= aspect;
			dir = normalize( dir );

			#ifdef WORLD_UNITS

				vec3 worldDir = normalize( end.xyz - start.xyz );
				vec3 tmpFwd = normalize( mix( start.xyz, end.xyz, 0.5 ) );
				vec3 worldUp = normalize( cross( worldDir, tmpFwd ) );
				vec3 worldFwd = cross( worldDir, worldUp );
				worldPos = position.y < 0.5 ? start: end;

				// height offset
				float hw = linewidth * 0.5;
				worldPos.xyz += position.x < 0.0 ? hw * worldUp : - hw * worldUp;

				// don't extend the line if we're rendering dashes because we
				// won't be rendering the endcaps
				#ifndef USE_DASH

					// cap extension
					worldPos.xyz += position.y < 0.5 ? - hw * worldDir : hw * worldDir;

					// add width to the box
					worldPos.xyz += worldFwd * hw;

					// endcaps
					if ( position.y > 1.0 || position.y < 0.0 ) {

						worldPos.xyz -= worldFwd * 2.0 * hw;

					}

				#endif

				// project the worldpos
				vec4 clip = projectionMatrix * worldPos;

				// shift the depth of the projected points so the line
				// segments overlap neatly
				vec3 clipPose = ( position.y < 0.5 ) ? ndcStart : ndcEnd;
				clip.z = clipPose.z * clip.w;

			#else

				vec2 offset = vec2( dir.y, - dir.x );
				// undo aspect ratio adjustment
				dir.x /= aspect;
				offset.x /= aspect;

				// sign flip
				if ( position.x < 0.0 ) offset *= - 1.0;

				// endcaps
				if ( position.y < 0.0 ) {

					offset += - dir;

				} else if ( position.y > 1.0 ) {

					offset += dir;

				}

				// adjust for linewidth
				offset *= linewidth;

				// adjust for clip-space to screen-space conversion // maybe resolution should be based on viewport ...
				offset /= resolution.y;

				// select end
				vec4 clip = ( position.y < 0.5 ) ? clipStart : clipEnd;

				// back to clip space
				offset *= clip.w;

				clip.xy += offset;

			#endif

			gl_Position = clip;

			vec4 mvPosition = ( position.y < 0.5 ) ? start : end; // this is an approximation

			#include <logdepthbuf_vertex>
			#include <clipping_planes_vertex>
			#include <fog_vertex>

		}
		`,fragmentShader:`
		uniform vec3 diffuse;
		uniform float opacity;
		uniform float linewidth;

		#ifdef USE_DASH

			uniform float dashOffset;
			uniform float dashSize;
			uniform float gapSize;

		#endif

		varying float vLineDistance;

		#ifdef WORLD_UNITS

			varying vec4 worldPos;
			varying vec3 worldStart;
			varying vec3 worldEnd;

			#ifdef USE_DASH

				varying vec2 vUv;

			#endif

		#else

			varying vec2 vUv;

		#endif

		#include <common>
		#include <color_pars_fragment>
		#include <fog_pars_fragment>
		#include <logdepthbuf_pars_fragment>
		#include <clipping_planes_pars_fragment>

		vec2 closestLineToLine(vec3 p1, vec3 p2, vec3 p3, vec3 p4) {

			float mua;
			float mub;

			vec3 p13 = p1 - p3;
			vec3 p43 = p4 - p3;

			vec3 p21 = p2 - p1;

			float d1343 = dot( p13, p43 );
			float d4321 = dot( p43, p21 );
			float d1321 = dot( p13, p21 );
			float d4343 = dot( p43, p43 );
			float d2121 = dot( p21, p21 );

			float denom = d2121 * d4343 - d4321 * d4321;

			float numer = d1343 * d4321 - d1321 * d4343;

			mua = numer / denom;
			mua = clamp( mua, 0.0, 1.0 );
			mub = ( d1343 + d4321 * ( mua ) ) / d4343;
			mub = clamp( mub, 0.0, 1.0 );

			return vec2( mua, mub );

		}

		void main() {

			float alpha = opacity;
			vec4 diffuseColor = vec4( diffuse, alpha );

			#include <clipping_planes_fragment>

			#ifdef USE_DASH

				if ( vUv.y < - 1.0 || vUv.y > 1.0 ) discard; // discard endcaps

				if ( mod( vLineDistance + dashOffset, dashSize + gapSize ) > dashSize ) discard; // todo - FIX

			#endif

			#ifdef WORLD_UNITS

				// Find the closest points on the view ray and the line segment
				vec3 rayEnd = normalize( worldPos.xyz ) * 1e5;
				vec3 lineDir = worldEnd - worldStart;
				vec2 params = closestLineToLine( worldStart, worldEnd, vec3( 0.0, 0.0, 0.0 ), rayEnd );

				vec3 p1 = worldStart + lineDir * params.x;
				vec3 p2 = rayEnd * params.y;
				vec3 delta = p1 - p2;
				float len = length( delta );
				float norm = len / linewidth;

				#ifndef USE_DASH

					#ifdef USE_ALPHA_TO_COVERAGE

						float dnorm = fwidth( norm );
						alpha = 1.0 - smoothstep( 0.5 - dnorm, 0.5 + dnorm, norm );

					#else

						if ( norm > 0.5 ) {

							discard;

						}

					#endif

				#endif

			#else

				#ifdef USE_ALPHA_TO_COVERAGE

					// artifacts appear on some hardware if a derivative is taken within a conditional
					float a = vUv.x;
					float b = ( vUv.y > 0.0 ) ? vUv.y - 1.0 : vUv.y + 1.0;
					float len2 = a * a + b * b;
					float dlen = fwidth( len2 );

					if ( abs( vUv.y ) > 1.0 ) {

						alpha = 1.0 - smoothstep( 1.0 - dlen, 1.0 + dlen, len2 );

					}

				#else

					if ( abs( vUv.y ) > 1.0 ) {

						float a = vUv.x;
						float b = ( vUv.y > 0.0 ) ? vUv.y - 1.0 : vUv.y + 1.0;
						float len2 = a * a + b * b;

						if ( len2 > 1.0 ) discard;

					}

				#endif

			#endif

			#include <logdepthbuf_fragment>
			#include <color_fragment>

			gl_FragColor = vec4( diffuseColor.rgb, alpha );

			#include <tonemapping_fragment>
			#include <colorspace_fragment>
			#include <fog_fragment>
			#include <premultiplied_alpha_fragment>

		}
		`};class Nf extends Ar{constructor(t){super({type:"LineMaterial",uniforms:gu.clone(ds.line.uniforms),vertexShader:ds.line.vertexShader,fragmentShader:ds.line.fragmentShader,clipping:!0}),this.isLineMaterial=!0,this.setValues(t)}get color(){return this.uniforms.diffuse.value}set color(t){this.uniforms.diffuse.value=t}get worldUnits(){return"WORLD_UNITS"in this.defines}set worldUnits(t){t===!0?this.defines.WORLD_UNITS="":delete this.defines.WORLD_UNITS}get linewidth(){return this.uniforms.linewidth.value}set linewidth(t){this.uniforms.linewidth&&(this.uniforms.linewidth.value=t)}get dashed(){return"USE_DASH"in this.defines}set dashed(t){t===!0!==this.dashed&&(this.needsUpdate=!0),t===!0?this.defines.USE_DASH="":delete this.defines.USE_DASH}get dashScale(){return this.uniforms.dashScale.value}set dashScale(t){this.uniforms.dashScale.value=t}get dashSize(){return this.uniforms.dashSize.value}set dashSize(t){this.uniforms.dashSize.value=t}get dashOffset(){return this.uniforms.dashOffset.value}set dashOffset(t){this.uniforms.dashOffset.value=t}get gapSize(){return this.uniforms.gapSize.value}set gapSize(t){this.uniforms.gapSize.value=t}get opacity(){return this.uniforms.opacity.value}set opacity(t){this.uniforms&&(this.uniforms.opacity.value=t)}get resolution(){return this.uniforms.resolution.value}set resolution(t){this.uniforms.resolution.value.copy(t)}get alphaToCoverage(){return"USE_ALPHA_TO_COVERAGE"in this.defines}set alphaToCoverage(t){this.defines&&(t===!0!==this.alphaToCoverage&&(this.needsUpdate=!0),t===!0?this.defines.USE_ALPHA_TO_COVERAGE="":delete this.defines.USE_ALPHA_TO_COVERAGE)}}const Si=new Nr,Dc=new V,zc=new V,Ft=new Nr,Tt=new Nr,An=new Nr,ji=new V,Ii=new go,Dt=new Ph,Oc=new V,os=new ga,rs=new pu,Nn=new Nr;let Dn,wo;function $c(e,t,n){return Nn.set(0,0,-t,1).applyMatrix4(e.projectionMatrix),Nn.multiplyScalar(1/Nn.w),Nn.x=wo/n.width,Nn.y=wo/n.height,Nn.applyMatrix4(e.projectionMatrixInverse),Nn.multiplyScalar(1/Nn.w),Math.abs(Math.max(Nn.x,Nn.y))}function $C(e,t){const n=e.matrixWorld,o=e.geometry,s=o.attributes.instanceStart,a=o.attributes.instanceEnd,i=Math.min(o.instanceCount,s.count);for(let l=0,c=i;l<c;l++){Dt.start.fromBufferAttribute(s,l),Dt.end.fromBufferAttribute(a,l),Dt.applyMatrix4(n);const d=new V,u=new V;Dn.distanceSqToSegment(Dt.start,Dt.end,u,d),u.distanceTo(d)<wo*.5&&t.push({point:u,pointOnLine:d,distance:Dn.origin.distanceTo(u),object:e,face:null,faceIndex:l,uv:null,uv1:null})}}function BC(e,t,n){const o=t.projectionMatrix,a=e.material.resolution,i=e.matrixWorld,l=e.geometry,c=l.attributes.instanceStart,d=l.attributes.instanceEnd,u=Math.min(l.instanceCount,c.count),f=-t.near;Dn.at(1,An),An.w=1,An.applyMatrix4(t.matrixWorldInverse),An.applyMatrix4(o),An.multiplyScalar(1/An.w),An.x*=a.x/2,An.y*=a.y/2,An.z=0,ji.copy(An),Ii.multiplyMatrices(t.matrixWorldInverse,i);for(let p=0,g=u;p<g;p++){if(Ft.fromBufferAttribute(c,p),Tt.fromBufferAttribute(d,p),Ft.w=1,Tt.w=1,Ft.applyMatrix4(Ii),Tt.applyMatrix4(Ii),Ft.z>f&&Tt.z>f)continue;if(Ft.z>f){const S=Ft.z-Tt.z,k=(Ft.z-f)/S;Ft.lerp(Tt,k)}else if(Tt.z>f){const S=Tt.z-Ft.z,k=(Tt.z-f)/S;Tt.lerp(Ft,k)}Ft.applyMatrix4(o),Tt.applyMatrix4(o),Ft.multiplyScalar(1/Ft.w),Tt.multiplyScalar(1/Tt.w),Ft.x*=a.x/2,Ft.y*=a.y/2,Tt.x*=a.x/2,Tt.y*=a.y/2,Dt.start.copy(Ft),Dt.start.z=0,Dt.end.copy(Tt),Dt.end.z=0;const v=Dt.closestPointToPointParameter(ji,!0);Dt.at(v,Oc);const w=_h.lerp(Ft.z,Tt.z,v),x=w>=-1&&w<=1,m=ji.distanceTo(Oc)<wo*.5;if(x&&m){Dt.start.fromBufferAttribute(c,p),Dt.end.fromBufferAttribute(d,p),Dt.start.applyMatrix4(i),Dt.end.applyMatrix4(i);const S=new V,k=new V;Dn.distanceSqToSegment(Dt.start,Dt.end,k,S),n.push({point:k,pointOnLine:S,distance:Dn.origin.distanceTo(k),object:e,face:null,faceIndex:p,uv:null,uv1:null})}}}class UC extends Lh{constructor(t=new Af,n=new Nf({color:Math.random()*16777215})){super(t,n),this.isLineSegments2=!0,this.type="LineSegments2"}computeLineDistances(){const t=this.geometry,n=t.attributes.instanceStart,o=t.attributes.instanceEnd,s=new Float32Array(2*n.count);for(let i=0,l=0,c=n.count;i<c;i++,l+=2)Dc.fromBufferAttribute(n,i),zc.fromBufferAttribute(o,i),s[l]=l===0?0:s[l-1],s[l+1]=s[l]+Dc.distanceTo(zc);const a=new zi(s,2,1);return t.setAttribute("instanceDistanceStart",new To(a,1,0)),t.setAttribute("instanceDistanceEnd",new To(a,1,1)),this}raycast(t,n){const o=this.material.worldUnits,s=t.camera;s===null&&!o&&console.error('LineSegments2: "Raycaster.camera" needs to be set in order to raycast against LineSegments2 while worldUnits is set to false.');const a=t.params.Line2!==void 0&&t.params.Line2.threshold||0;Dn=t.ray;const i=this.matrixWorld,l=this.geometry,c=this.material;wo=c.linewidth+a,l.boundingSphere===null&&l.computeBoundingSphere(),rs.copy(l.boundingSphere).applyMatrix4(i);let d;if(o)d=wo*.5;else{const f=Math.max(s.near,rs.distanceToPoint(Dn.origin));d=$c(s,f,c.resolution)}if(rs.radius+=d,Dn.intersectsSphere(rs)===!1)return;l.boundingBox===null&&l.computeBoundingBox(),os.copy(l.boundingBox).applyMatrix4(i);let u;if(o)u=wo*.5;else{const f=Math.max(s.near,os.distanceToPoint(Dn.origin));u=$c(s,f,c.resolution)}os.expandByScalar(u),Dn.intersectsBox(os)!==!1&&(o?$C(this,n):BC(this,s,n))}onBeforeRender(t){const n=this.material.uniforms;n&&n.resolution&&(t.getViewport(Si),this.material.uniforms.resolution.value.set(Si.z,Si.w))}}const WC=`
varying vec2 vUv;

void main() {
  vUv = uv;
  gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
}
`,HC=`
uniform float fx;
uniform float fy;
uniform float cx;
uniform float cy;
uniform float imageWidth;
uniform float imageHeight;
uniform float planeWidth;
uniform float planeHeight;
uniform int modelId;
uniform float k1;
uniform float k2;
uniform float k3;
uniform float k4;
uniform float k5;
uniform float k6;
uniform float p1;
uniform float p2;
uniform float omega;
uniform float sx1;
uniform float sy1;

varying vec2 vUv;

// Camera model constants
const int SIMPLE_PINHOLE = 0;
const int PINHOLE = 1;
const int SIMPLE_RADIAL = 2;
const int RADIAL = 3;
const int OPENCV = 4;
const int OPENCV_FISHEYE = 5;
const int FULL_OPENCV = 6;
const int FOV = 7;
const int SIMPLE_RADIAL_FISHEYE = 8;
const int RADIAL_FISHEYE = 9;
const int THIN_PRISM_FISHEYE = 10;

// Convert UV to normalized camera coordinates (distorted space)
vec2 uvToDistortedNormalized(vec2 uv) {
  float px = uv.x * imageWidth;
  float py = (1.0 - uv.y) * imageHeight;
  return vec2((px - cx) / fx, (py - cy) / fy);
}

// Compute inverse distortion: distorted -> undistorted
// Uses iterative approach for accurate inversion
//
// For fisheye models, follows COLMAP's two-step approach:
// 1. Remove polynomial distortion in fisheye Î¸-space (iteratively)
// 2. Convert from fisheye to pinhole via tan(Î¸)/Î¸ scaling
vec2 inverseDistort(vec2 distorted) {
  if (modelId == SIMPLE_PINHOLE || modelId == PINHOLE) {
    return distorted;
  }

  // Handle fisheye models separately - they need special two-step inversion
  if (modelId == OPENCV_FISHEYE || modelId == SIMPLE_RADIAL_FISHEYE || modelId == RADIAL_FISHEYE) {
    // Input is already in fisheye normalized space: (x-cx)/fx, (y-cy)/fy
    // Step 1: Iteratively remove polynomial distortion in fisheye space
    // The distortion is: distorted = undistorted * (1 + k1*Î¸Â² + k2*Î¸â´ + ...)
    // where Î¸Â² = undistorted.xÂ² + undistorted.yÂ²
    vec2 fisheyeUndist = distorted;

    for (int i = 0; i < 10; i++) {
      float theta2 = fisheyeUndist.x * fisheyeUndist.x + fisheyeUndist.y * fisheyeUndist.y;
      float theta4 = theta2 * theta2;
      float theta6 = theta4 * theta2;
      float theta8 = theta4 * theta4;

      float radial = 0.0;
      if (modelId == OPENCV_FISHEYE) {
        radial = k1 * theta2 + k2 * theta4 + k3 * theta6 + k4 * theta8;
      } else if (modelId == SIMPLE_RADIAL_FISHEYE) {
        radial = k1 * theta2;
      } else if (modelId == RADIAL_FISHEYE) {
        radial = k1 * theta2 + k2 * theta4;
      }

      // Solve: distorted = fisheyeUndist * (1 + radial)
      // So: fisheyeUndist = distorted / (1 + radial)
      fisheyeUndist = distorted / (1.0 + radial);
    }

    // Step 2: Convert from fisheye to pinhole (NormalFromFisheye in COLMAP)
    // In fisheye space, Î¸ = length(fisheyeUndist) represents the angle from optical axis
    // To convert to pinhole: scale by tan(Î¸)/Î¸
    float theta = sqrt(fisheyeUndist.x * fisheyeUndist.x + fisheyeUndist.y * fisheyeUndist.y);
    if (theta < 0.00001) {
      return fisheyeUndist;
    }
    // scale = sin(Î¸)/(Î¸*cos(Î¸)) = tan(Î¸)/Î¸
    float scale = tan(theta) / theta;
    return fisheyeUndist * scale;
  }

  // THIN_PRISM_FISHEYE: fisheye + tangential + thin prism
  // Distortion order: 1) fisheye radial, 2) tangential + thin prism on scaled coords
  // Inverse order: 1) remove tangential + thin prism, 2) remove fisheye radial, 3) fisheye to pinhole
  if (modelId == THIN_PRISM_FISHEYE) {
    vec2 fisheyeUndist = distorted;

    for (int i = 0; i < 10; i++) {
      // First estimate what the fisheye-only point would be (before tangential/thin prism)
      float theta2 = fisheyeUndist.x * fisheyeUndist.x + fisheyeUndist.y * fisheyeUndist.y;
      float theta4 = theta2 * theta2;
      float theta6 = theta4 * theta2;
      float theta8 = theta4 * theta4;
      float radial = k1 * theta2 + k2 * theta4 + k3 * theta6 + k4 * theta8;

      // Compute tangential + thin prism delta at current estimate
      float x = fisheyeUndist.x;
      float y = fisheyeUndist.y;
      float r2d = x * x + y * y;
      float dx = 2.0 * p1 * x * y + p2 * (r2d + 2.0 * x * x) + sx1 * r2d;
      float dy = p1 * (r2d + 2.0 * y * y) + 2.0 * p2 * x * y + sy1 * r2d;

      // Remove tangential/thin prism, then remove radial
      vec2 withoutTangential = distorted - vec2(dx, dy);
      fisheyeUndist = withoutTangential / (1.0 + radial);
    }

    // Convert from fisheye to pinhole
    float theta = sqrt(fisheyeUndist.x * fisheyeUndist.x + fisheyeUndist.y * fisheyeUndist.y);
    if (theta < 0.00001) {
      return fisheyeUndist;
    }
    float scale = tan(theta) / theta;
    return fisheyeUndist * scale;
  }

  // For non-fisheye models: standard iterative undistortion
  // Initial guess: the distorted point itself
  vec2 undistorted = distorted;

  // Newton-Raphson iteration to find undistorted point
  // We're solving: distorted = undistorted + delta(undistorted)
  // So: undistorted = distorted - delta(undistorted)
  for (int i = 0; i < 10; i++) {
    float x = undistorted.x;
    float y = undistorted.y;
    float r2 = x * x + y * y;
    float r = sqrt(r2);

    vec2 delta = vec2(0.0);

    if (modelId == SIMPLE_RADIAL) {
      float radial = k1 * r2;
      delta = undistorted * radial;
    } else if (modelId == RADIAL) {
      float r4 = r2 * r2;
      float radial = k1 * r2 + k2 * r4;
      delta = undistorted * radial;
    } else if (modelId == OPENCV) {
      float r4 = r2 * r2;
      float radial = k1 * r2 + k2 * r4;
      float dx = 2.0 * p1 * x * y + p2 * (r2 + 2.0 * x * x);
      float dy = p1 * (r2 + 2.0 * y * y) + 2.0 * p2 * x * y;
      delta = vec2(x * radial + dx, y * radial + dy);
    } else if (modelId == FULL_OPENCV) {
      float r4 = r2 * r2;
      float r6 = r4 * r2;
      float num = 1.0 + k1 * r2 + k2 * r4 + k3 * r6;
      float denom = 1.0 + k4 * r2 + k5 * r4 + k6 * r6;
      float radial = num / denom - 1.0;
      float dx = 2.0 * p1 * x * y + p2 * (r2 + 2.0 * x * x);
      float dy = p1 * (r2 + 2.0 * y * y) + 2.0 * p2 * x * y;
      delta = vec2(x * radial + dx, y * radial + dy);
    } else if (modelId == FOV) {
      if (r > 0.00001) {
        float rd = atan(r * 2.0 * tan(omega / 2.0)) / omega;
        float factor = rd / r - 1.0;
        delta = undistorted * factor;
      }
    }

    // Update: undistorted = distorted - delta
    undistorted = distorted - delta;
  }

  return undistorted;
}

void main() {
  vUv = uv;

  // Get this vertex's position in distorted normalized coordinates
  vec2 distortedNorm = uvToDistortedNormalized(uv);

  // Compute undistorted position
  vec2 undistortedNorm = inverseDistort(distortedNorm);

  // Convert back to UV space
  float undistortedPx = undistortedNorm.x * fx + cx;
  float undistortedPy = undistortedNorm.y * fy + cy;
  float undistortedU = undistortedPx / imageWidth;
  float undistortedV = 1.0 - (undistortedPy / imageHeight);

  // Compute new position using plane dimensions passed as uniforms
  // PlaneGeometry maps UV (0-1) to position (-width/2 to width/2)
  vec3 newPosition = position;
  newPosition.x = (undistortedU - 0.5) * planeWidth;
  newPosition.y = (undistortedV - 0.5) * planeHeight;

  gl_Position = projectionMatrix * modelViewMatrix * vec4(newPosition, 1.0);
}
`,ZC=`
precision highp float;

uniform sampler2D map;
uniform float opacity;
uniform vec3 color;
uniform bool undistortionEnabled;

// Camera model ID (matches COLMAP)
uniform int modelId;

// Image dimensions
uniform float imageWidth;
uniform float imageHeight;

// Camera intrinsics - up to 12 parameters
uniform float fx;
uniform float fy;
uniform float cx;
uniform float cy;
uniform float k1;
uniform float k2;
uniform float k3;
uniform float k4;
uniform float k5;
uniform float k6;
uniform float p1;
uniform float p2;
uniform float omega;  // FOV model parameter
uniform float sx1;    // Thin prism parameters
uniform float sy1;

varying vec2 vUv;

// Camera model constants (must match CameraModelId in colmap.ts)
const int SIMPLE_PINHOLE = 0;
const int PINHOLE = 1;
const int SIMPLE_RADIAL = 2;
const int RADIAL = 3;
const int OPENCV = 4;
const int OPENCV_FISHEYE = 5;
const int FULL_OPENCV = 6;
const int FOV = 7;
const int SIMPLE_RADIAL_FISHEYE = 8;
const int RADIAL_FISHEYE = 9;
const int THIN_PRISM_FISHEYE = 10;

// Convert UV (0-1) to normalized camera coordinates
vec2 uvToNormalized(vec2 uv) {
  // UV goes from 0-1, convert to pixel coordinates
  float px = uv.x * imageWidth;
  float py = (1.0 - uv.y) * imageHeight; // Flip Y for image coordinate system

  // Convert to normalized camera coordinates (centered at principal point)
  float x = (px - cx) / fx;
  float y = (py - cy) / fy;

  return vec2(x, y);
}

// Convert normalized camera coordinates back to UV
vec2 normalizedToUv(vec2 normalized) {
  // Convert back to pixel coordinates
  float px = normalized.x * fx + cx;
  float py = normalized.y * fy + cy;

  // Convert to UV (0-1), flip Y back
  float u = px / imageWidth;
  float v = 1.0 - (py / imageHeight);

  return vec2(u, v);
}

// ============ DISTORTION FUNCTIONS ============
// These compute the distortion delta for each model

// SIMPLE_RADIAL: du = u * k * r^2
vec2 distortSimpleRadial(vec2 p) {
  float r2 = dot(p, p);
  float radial = k1 * r2;
  return p * radial;
}

// RADIAL: du = u * (k1*r^2 + k2*r^4)
vec2 distortRadial(vec2 p) {
  float r2 = dot(p, p);
  float r4 = r2 * r2;
  float radial = k1 * r2 + k2 * r4;
  return p * radial;
}

// OPENCV: radial + tangential distortion
vec2 distortOpenCV(vec2 p) {
  float x = p.x;
  float y = p.y;
  float r2 = x * x + y * y;
  float r4 = r2 * r2;

  // Radial distortion
  float radial = k1 * r2 + k2 * r4;

  // Tangential distortion
  float dx = 2.0 * p1 * x * y + p2 * (r2 + 2.0 * x * x);
  float dy = p1 * (r2 + 2.0 * y * y) + 2.0 * p2 * x * y;

  return vec2(x * radial + dx, y * radial + dy);
}

// FULL_OPENCV: rational polynomial model
vec2 distortFullOpenCV(vec2 p) {
  float x = p.x;
  float y = p.y;
  float r2 = x * x + y * y;
  float r4 = r2 * r2;
  float r6 = r4 * r2;

  // Rational polynomial
  float num = 1.0 + k1 * r2 + k2 * r4 + k3 * r6;
  float denom = 1.0 + k4 * r2 + k5 * r4 + k6 * r6;
  float radial = num / denom - 1.0;

  // Tangential distortion
  float dx = 2.0 * p1 * x * y + p2 * (r2 + 2.0 * x * x);
  float dy = p1 * (r2 + 2.0 * y * y) + 2.0 * p2 * x * y;

  return vec2(x * radial + dx, y * radial + dy);
}

// FOV model distortion
vec2 distortFOV(vec2 p) {
  float r = length(p);
  if (r < 0.00001) return vec2(0.0);

  float rd = atan(r * 2.0 * tan(omega / 2.0)) / omega;
  float factor = rd / r - 1.0;

  return p * factor;
}

// OPENCV_FISHEYE: equidistant fisheye projection with k1-k4
// This computes the delta to go from perspective to fisheye projection
vec2 distortOpenCVFisheye(vec2 p) {
  float r = length(p);
  if (r < 0.00001) return vec2(0.0);

  float theta = atan(r);
  float theta2 = theta * theta;
  float theta4 = theta2 * theta2;
  float theta6 = theta4 * theta2;
  float theta8 = theta4 * theta4;

  float thetad = theta * (1.0 + k1 * theta2 + k2 * theta4 + k3 * theta6 + k4 * theta8);

  // The distorted point is p * (thetad / r)
  // So delta = p * (thetad/r - 1)
  return p * (thetad / r - 1.0);
}

// SIMPLE_RADIAL_FISHEYE: fisheye with single k parameter
vec2 distortSimpleRadialFisheye(vec2 p) {
  float r = length(p);
  if (r < 0.00001) return vec2(0.0);

  float theta = atan(r);
  float theta2 = theta * theta;

  float thetad = theta * (1.0 + k1 * theta2);
  float factor = thetad / r - 1.0;

  return p * factor;
}

// RADIAL_FISHEYE: fisheye with k1, k2
vec2 distortRadialFisheye(vec2 p) {
  float r = length(p);
  if (r < 0.00001) return vec2(0.0);

  float theta = atan(r);
  float theta2 = theta * theta;
  float theta4 = theta2 * theta2;

  float thetad = theta * (1.0 + k1 * theta2 + k2 * theta4);
  float factor = thetad / r - 1.0;

  return p * factor;
}

// THIN_PRISM_FISHEYE: fisheye + radial + tangential + thin prism
vec2 distortThinPrismFisheye(vec2 p) {
  float r = length(p);
  if (r < 0.00001) return vec2(0.0);

  float theta = atan(r);
  float theta2 = theta * theta;
  float theta4 = theta2 * theta2;
  float theta6 = theta4 * theta2;
  float theta8 = theta4 * theta4;

  float thetad = theta * (1.0 + k1 * theta2 + k2 * theta4 + k3 * theta6 + k4 * theta8);

  // Scale to distorted radius
  vec2 pd = p * (thetad / r);

  // Add tangential and thin prism distortion
  float x = pd.x;
  float y = pd.y;
  float r2d = x * x + y * y;

  float dx = 2.0 * p1 * x * y + p2 * (r2d + 2.0 * x * x) + sx1 * r2d;
  float dy = p1 * (r2d + 2.0 * y * y) + 2.0 * p2 * x * y + sy1 * r2d;

  // Return delta from original point
  return vec2(pd.x + dx - p.x, pd.y + dy - p.y);
}

// Apply distortion based on model ID
vec2 applyDistortion(vec2 p) {
  if (modelId == SIMPLE_PINHOLE || modelId == PINHOLE) {
    return vec2(0.0); // No distortion
  } else if (modelId == SIMPLE_RADIAL) {
    return distortSimpleRadial(p);
  } else if (modelId == RADIAL) {
    return distortRadial(p);
  } else if (modelId == OPENCV) {
    return distortOpenCV(p);
  } else if (modelId == OPENCV_FISHEYE) {
    return distortOpenCVFisheye(p);
  } else if (modelId == FULL_OPENCV) {
    return distortFullOpenCV(p);
  } else if (modelId == FOV) {
    return distortFOV(p);
  } else if (modelId == SIMPLE_RADIAL_FISHEYE) {
    return distortSimpleRadialFisheye(p);
  } else if (modelId == RADIAL_FISHEYE) {
    return distortRadialFisheye(p);
  } else if (modelId == THIN_PRISM_FISHEYE) {
    return distortThinPrismFisheye(p);
  }
  return vec2(0.0);
}

// Given an undistorted (ideal perspective) coordinate, find the corresponding
// coordinate in the distorted (actual captured) image to sample from.
//
// For radial/tangential models: removes lens distortion aberrations
// For fisheye models: converts fisheye projection to perspective projection
//
// IMPORTANT: For fisheye cameras with wide FOV (>90 degrees), the edges of
// the perspective view will sample from the center of the fisheye image,
// and much of the fisheye image won't be visible. This is a fundamental
// limitation of projecting fisheye onto a flat perspective plane.
vec2 perspectiveToDistorted(vec2 undistorted) {
  // For no-distortion models, return as-is
  if (modelId == SIMPLE_PINHOLE || modelId == PINHOLE) {
    return undistorted;
  }

  // COLMAP's distortion model: distorted = undistorted + delta(undistorted)
  // This is a direct computation, no iteration needed.
  return undistorted + applyDistortion(undistorted);
}

void main() {
  vec2 sampleUv;

  if (undistortionEnabled && modelId != SIMPLE_PINHOLE && modelId != PINHOLE) {
    // Convert UV to normalized camera coordinates (perspective projection)
    vec2 normalized = uvToNormalized(vUv);

    // Find where to sample in the distorted image
    vec2 distortedNormalized = perspectiveToDistorted(normalized);

    // Convert back to UV
    sampleUv = normalizedToUv(distortedNormalized);

    // Check bounds - if outside image, render as transparent
    // This is common for fisheye undistortion where perspective FOV exceeds fisheye coverage
    if (sampleUv.x < 0.0 || sampleUv.x > 1.0 || sampleUv.y < 0.0 || sampleUv.y > 1.0) {
      gl_FragColor = vec4(color, 0.0);
      return;
    }
  } else {
    sampleUv = vUv;
  }

  vec4 texColor = texture2D(map, sampleUv);

  // The texture has colorSpace=SRGBColorSpace, so Three.js auto-converts sRGB->linear when sampling.
  // Use Three.js colorspace_fragment to convert back to sRGB for output (same as meshBasicMaterial).
  gl_FragColor = vec4(texColor.rgb, opacity);

  #include <colorspace_fragment>
}
`,VC=`
precision highp float;

uniform sampler2D map;
uniform float opacity;
uniform vec3 color;

varying vec2 vUv;

void main() {
  vec4 texColor = texture2D(map, vUv);
  gl_FragColor = vec4(texColor.rgb, opacity);
  #include <colorspace_fragment>
}
`;function GC({map:e,camera:t,undistortionEnabled:n,undistortionMode:o,planeWidth:s=1,planeHeight:a=1,opacity:i,color:l,side:c,visible:d=!0,depthTest:u=!0,forceTransparent:f=!1,forceDepthWrite:p}){const g=h.useRef(null),y=h.useMemo(()=>Iu(t),[t]),v=o==="fullFrame",w=h.useMemo(()=>{const x=new $n(l),m={map:{value:e},opacity:{value:i},color:{value:new V(x.r,x.g,x.b)},modelId:{value:t.modelId},imageWidth:{value:t.width},imageHeight:{value:t.height},fx:{value:y.fx},fy:{value:y.fy},cx:{value:y.cx},cy:{value:y.cy},k1:{value:y.k1},k2:{value:y.k2},k3:{value:y.k3},k4:{value:y.k4},k5:{value:y.k5},k6:{value:y.k6},p1:{value:y.p1},p2:{value:y.p2},omega:{value:y.omega},sx1:{value:y.sx1},sy1:{value:y.sy1}};v?(m.planeWidth={value:s},m.planeHeight={value:a}):m.undistortionEnabled={value:n};const{transparent:S,depthWrite:k}=Ui(i);return new Ar({vertexShader:v?HC:WC,fragmentShader:v?VC:ZC,uniforms:m,side:c,transparent:f||S,depthWrite:p!==void 0?p:k,depthTest:u,blending:Ah,toneMapped:!1,visible:Ll(i,d)})},[t,y,c,d,i,v,n,s,a,u,f,p,l,e]);return h.useEffect(()=>{const x=g.current;if(!x)return;x.uniforms.map.value=e,x.uniforms.opacity.value=i;const m=new $n(l);x.uniforms.color.value.set(m.r,m.g,m.b),v?(x.uniforms.planeWidth&&(x.uniforms.planeWidth.value=s),x.uniforms.planeHeight&&(x.uniforms.planeHeight.value=a)):x.uniforms.undistortionEnabled&&(x.uniforms.undistortionEnabled.value=n),x.uniforms.modelId.value=t.modelId,x.uniforms.imageWidth.value=t.width,x.uniforms.imageHeight.value=t.height,x.uniforms.fx.value=y.fx,x.uniforms.fy.value=y.fy,x.uniforms.cx.value=y.cx,x.uniforms.cy.value=y.cy,x.uniforms.k1.value=y.k1,x.uniforms.k2.value=y.k2,x.uniforms.k3.value=y.k3,x.uniforms.k4.value=y.k4,x.uniforms.k5.value=y.k5,x.uniforms.k6.value=y.k6,x.uniforms.p1.value=y.p1,x.uniforms.p2.value=y.p2,x.uniforms.omega.value=y.omega,x.uniforms.sx1.value=y.sx1,x.uniforms.sy1.value=y.sy1;const{transparent:S,depthWrite:k}=Ui(i);x.visible=Ll(i,d),x.transparent=f||S,x.depthWrite=p!==void 0?p:k,x.depthTest=u,x.needsUpdate=!0},[e,i,l,n,d,t,y,v,s,a,u,f,p]),r.jsx("primitive",{ref:g,object:w,attach:"material"})}function Rf(){const e=Ve(n=>n.pickingMode),t=Ge(n=>n.detectedPlane);return e!=="off"||t!==null}const Ff=`
  attribute float alpha;
  varying float vAlpha;
  varying vec3 vColor;

  void main() {
    vColor = color;
    vAlpha = alpha;
    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
  }
`,Tf=`
  varying float vAlpha;
  varying vec3 vColor;

  void main() {
    gl_FragColor = vec4(vColor, vAlpha);
  }
`;Nh({LineSegments2:UC,LineSegmentsGeometry:Af,LineMaterial:Nf});const gt=new $n;function Df(e,t){const n=Xn.chroma,o=n*(1-Math.abs(t*6%2-1)),s=Xn.lightness-n/2;let a=0,i=0,l=0;const{hueSegments:c}=Xn;t<c.redToYellow?(a=n,i=o):t<c.yellowToGreen?(a=o,i=n):t<c.greenToCyan?(i=n,l=o):t<c.cyanToBlue?(i=o,l=n):t<c.blueToMagenta?(a=o,l=n):(a=n,l=o),e.setRGB(a+s,i+s,l+s)}function Za(e){return e<.3?e/.3:e<.6?1:e<1?1-(e-.6)/.4:0}function Va(e,t,n,o){if(e==="byCamera")return Bi(t);if(e==="byRigFrame"){const s=o.get(n);return s!==void 0?Bi(s):_t.frustum.default}return _t.frustum.default}const wr=new V,Bc=new V,Mi=new V,Uc=new ut,YC=Math.cos(Math.PI/4),qC=Math.cos(Math.PI/2),Fn=new go,Et=new V,to=new ut,Cn=new V(1,1,1),ss=new pn;function XC({frustums:e,cameraScale:t,selectedImageId:n,hoveredImageId:o,matchedImageIds:s,matchesOpacity:a,matchesDisplayMode:i,matchesColor:l,frustumColorMode:c,selectionColorMode:d,selectionColor:u,selectionAnimationSpeed:f,unselectedCameraOpacity:p,imageFrameIndexMap:g,onHover:y,onClick:v,onDoubleClick:w,onContextMenu:x,lastNavigationToImageId:m}){const S=h.useRef(null),k=h.useRef(null),j=h.useRef(0),b=h.useRef(0),M=h.useRef(null),E=h.useRef(null),P=h.useRef(!0),[I,R]=h.useState(null),{controls:A}=In(),G=h.useCallback(()=>A?.dragging?.current??!1,[A]);h.useEffect(()=>()=>{document.body.style.cursor=""},[]);const F=t*.8,z=t*.04,Z=t*.2,U=t*.08,D=h.useMemo(()=>{const J=new Fh(z,z,F,8);return J.computeBoundingSphere(),J},[z,F]),T=h.useMemo(()=>{const J=new Th(U,Z,12);return J.computeBoundingSphere(),J},[U,Z]),$=h.useMemo(()=>new $i({transparent:!0,depthWrite:!1}),[]),Q=h.useMemo(()=>new $i({transparent:!0,depthWrite:!1}),[]);if(h.useEffect(()=>()=>{D.dispose(),T.dispose()},[D,T]),h.useEffect(()=>()=>{$.dispose(),Q.dispose()},[$,Q]),En((J,L)=>{if(!S.current||!k.current)return;const ee=S.current,ie=k.current,te=(d==="blink"||d==="rainbow")&&n!==null,de=i==="blink"&&s.size>0;te&&d==="rainbow"&&(j.current=(j.current+L*f*Xn.speedMultiplier)%1),de&&(b.current=(b.current+L)%2);const fe=J.clock.elapsedTime*f*2,we=n!==M.current||o!==E.current;!te&&!de&&!we&&!P.current||(M.current=n,E.current=o,P.current=!1,e.forEach((pe,ge)=>{const Re=pe.image.imageId===n,Le=pe.image.imageId===o,xe=s.has(pe.image.imageId);if(Re?Cn.set(0,0,0):Cn.set(1,1,1),Le)gt.set(_t.frustum.hover);else if(Re)if(d==="rainbow")Df(gt,j.current);else if(d==="blink"){const ke=.5+.5*((Math.sin(fe)+1)/2);gt.set(u),gt.multiplyScalar(ke)}else gt.set(u);else if(xe)if(gt.set(l),i==="blink"){const Ee=a*(.1+.9*Za(b.current));gt.multiplyScalar(Ee)}else gt.multiplyScalar(a);else gt.set(Va(c,pe.cameraIndex,pe.image.imageId,g));ss.set(Math.PI/2,0,0),to.setFromEuler(ss),to.premultiply(pe.quaternion),Et.set(0,0,F/2),Et.applyQuaternion(pe.quaternion),Et.add(pe.position),Fn.compose(Et,to,Cn),ee.setMatrixAt(ge,Fn),ee.setColorAt(ge,gt),Et.set(0,0,F+Z/2),Et.applyQuaternion(pe.quaternion),Et.add(pe.position),Fn.compose(Et,to,Cn),ie.setMatrixAt(ge,Fn),ie.setColorAt(ge,gt)}),ee.instanceMatrix.needsUpdate=!0,ie.instanceMatrix.needsUpdate=!0,ee.instanceColor&&(ee.instanceColor.needsUpdate=!0),ie.instanceColor&&(ie.instanceColor.needsUpdate=!0))}),h.useEffect(()=>{P.current=!0},[e,t]),h.useLayoutEffect(()=>{if(!S.current||!k.current)return;const J=S.current,L=k.current;e.forEach((ee,ie)=>{ee.image.imageId===n?Cn.set(0,0,0):Cn.set(1,1,1),ss.set(Math.PI/2,0,0),to.setFromEuler(ss),to.premultiply(ee.quaternion),Et.set(0,0,F/2),Et.applyQuaternion(ee.quaternion),Et.add(ee.position),Fn.compose(Et,to,Cn),J.setMatrixAt(ie,Fn),Et.set(0,0,F+Z/2),Et.applyQuaternion(ee.quaternion),Et.add(ee.position),Fn.compose(Et,to,Cn),L.setMatrixAt(ie,Fn)}),J.instanceMatrix.needsUpdate=!0,L.instanceMatrix.needsUpdate=!0},[e,n,F,Z]),h.useEffect(()=>{const J=n===null?.9:p;$.opacity=J,Q.opacity=J},[$,Q,n,p]),e.length===0)return null;const K=I!==null?e[I.instanceId]:null,re=`arrows-${t.toFixed(4)}`;return r.jsxs(r.Fragment,{children:[r.jsx("instancedMesh",{ref:S,args:[D,$,e.length],onPointerOver:J=>{if(J.instanceId===void 0||G())return;const L=e[J.instanceId];!L||L.image.imageId===n||(J.stopPropagation(),R({instanceId:J.instanceId,x:J.nativeEvent.clientX,y:J.nativeEvent.clientY}),y(L.image.imageId),document.body.style.cursor="pointer")},onPointerMove:J=>{if(G()){I!==null&&(R(null),y(null),document.body.style.cursor="");return}if(I!==null)R({instanceId:I.instanceId,x:J.nativeEvent.clientX,y:J.nativeEvent.clientY});else if(J.instanceId!==void 0){const L=e[J.instanceId];L&&L.image.imageId!==n&&(R({instanceId:J.instanceId,x:J.nativeEvent.clientX,y:J.nativeEvent.clientY}),y(L.image.imageId),document.body.style.cursor="pointer")}},onPointerOut:()=>{R(null),y(null),document.body.style.cursor=""},onClick:J=>{if(J.instanceId===void 0)return;const L=e[J.instanceId];!L||L.image.imageId===n||(J.stopPropagation(),v(L.image.imageId))},onDoubleClick:J=>{if(J.instanceId===void 0)return;const L=e[J.instanceId];!L||L.image.imageId===n||(J.stopPropagation(),w(L.image.imageId))},onContextMenu:J=>{if(J.instanceId===void 0)return;const L=e[J.instanceId];!L||L.image.imageId===n||(J.stopPropagation(),J.nativeEvent.preventDefault(),J.nativeEvent.stopPropagation(),x(L.image.imageId))}},re),r.jsx("instancedMesh",{ref:k,args:[T,Q,e.length]},`${re}-cone`),I!==null&&K&&r.jsx(gn,{style:{position:"fixed",left:I.x+12,top:I.y+12,pointerEvents:"none",transform:"none"},calculatePosition:()=>[0,0],children:r.jsxs("div",{className:se.container,children:[r.jsx("div",{className:se.title,children:K.image.name}),r.jsxs("div",{className:se.subtitle,children:["#",K.image.imageId]}),r.jsxs("div",{className:se.subtitle,children:[K.numPoints3D," points"]}),r.jsxs("div",{className:se.hint,children:[r.jsxs("div",{className:se.hintRow,children:[r.jsxs("svg",{className:tt.hoverCard,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[r.jsx("rect",{x:"6",y:"2",width:"12",height:"20",rx:"6"}),r.jsx("path",{d:"M12 2v8"}),r.jsx("rect",{x:"6",y:"2",width:"6",height:"8",rx:"3",fill:"currentColor",opacity:"0.5"})]}),"Left: select"]}),r.jsxs("div",{className:se.hintRow,children:[r.jsxs("svg",{className:tt.hoverCard,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[r.jsx("rect",{x:"6",y:"2",width:"12",height:"20",rx:"6"}),r.jsx("path",{d:"M12 2v8"}),r.jsx("rect",{x:"6",y:"2",width:"6",height:"8",rx:"3",fill:"currentColor",opacity:"0.5"}),r.jsx("text",{x:"18",y:"18",fontSize:"8",fill:"currentColor",stroke:"none",children:"2"})]}),"2xLeft: details"]}),r.jsxs("div",{className:se.hintRow,children:[r.jsxs("svg",{className:tt.hoverCard,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[r.jsx("rect",{x:"6",y:"2",width:"12",height:"20",rx:"6"}),r.jsx("path",{d:"M12 2v8"}),r.jsx("rect",{x:"12",y:"2",width:"6",height:"8",rx:"3",fill:"currentColor",opacity:"0.5"})]}),s.has(K.image.imageId)?"Right: matches":K.image.imageId===m?"Right: back":"Right: fly to"]})]})]})})]})}function KC({frustums:e,cameraScale:t,selectedImageId:n,hoveredImageId:o,matchedImageIds:s,matchesOpacity:a,matchesDisplayMode:i,matchesColor:l,frustumColorMode:c,selectionColorMode:d,selectionColor:u,selectionAnimationSpeed:f,unselectedCameraOpacity:p,showImagePlanes:g,imageFrameIndexMap:y}){const v=h.useRef(null),w=h.useRef(0),x=h.useRef(0),m=h.useRef(null),{positions:S,baseColors:k,baseAlphas:j}=h.useMemo(()=>{const P=new Float32Array(e.length*48),I=new Float32Array(e.length*48),R=new Float32Array(e.length*16);return e.forEach((A,G)=>{const F=G*48,z=G*16,Z=A.camera.width/A.camera.height,U=A.camera.params[0]||1,D=t*A.camera.width/(2*U),T=D/Z,$=t,Q=new V(0,0,0),K=new V(-D,-T,$),re=new V(D,-T,$),J=new V(D,T,$),L=new V(-D,T,$);Q.applyQuaternion(A.quaternion).add(A.position),K.applyQuaternion(A.quaternion).add(A.position),re.applyQuaternion(A.quaternion).add(A.position),J.applyQuaternion(A.quaternion).add(A.position),L.applyQuaternion(A.quaternion).add(A.position),P[F+0]=Q.x,P[F+1]=Q.y,P[F+2]=Q.z,P[F+3]=K.x,P[F+4]=K.y,P[F+5]=K.z,P[F+6]=Q.x,P[F+7]=Q.y,P[F+8]=Q.z,P[F+9]=re.x,P[F+10]=re.y,P[F+11]=re.z,P[F+12]=Q.x,P[F+13]=Q.y,P[F+14]=Q.z,P[F+15]=J.x,P[F+16]=J.y,P[F+17]=J.z,P[F+18]=Q.x,P[F+19]=Q.y,P[F+20]=Q.z,P[F+21]=L.x,P[F+22]=L.y,P[F+23]=L.z,P[F+24]=K.x,P[F+25]=K.y,P[F+26]=K.z,P[F+27]=re.x,P[F+28]=re.y,P[F+29]=re.z,P[F+30]=re.x,P[F+31]=re.y,P[F+32]=re.z,P[F+33]=J.x,P[F+34]=J.y,P[F+35]=J.z,P[F+36]=J.x,P[F+37]=J.y,P[F+38]=J.z,P[F+39]=L.x,P[F+40]=L.y,P[F+41]=L.z,P[F+42]=L.x,P[F+43]=L.y,P[F+44]=L.z,P[F+45]=K.x,P[F+46]=K.y,P[F+47]=K.z,gt.set(Va(c,A.cameraIndex,A.image.imageId,y));for(let ee=0;ee<16;ee++)I[F+ee*3+0]=gt.r,I[F+ee*3+1]=gt.g,I[F+ee*3+2]=gt.b,R[z+ee]=1}),{positions:P,baseColors:I,baseAlphas:R}},[e,t,c,y]);En((P,I)=>{if(!v.current)return;const R=v.current.getAttribute("color"),A=v.current.getAttribute("alpha");if(!R||!A)return;const G=(d==="blink"||d==="rainbow")&&n!==null,F=i==="blink"&&s.size>0,z=G||F,Z=m.current,U=!Z||Z.selectedImageId!==n||Z.hoveredImageId!==o||Z.matchedImageIds!==s||Z.unselectedCameraOpacity!==p||Z.matchesOpacity!==a||Z.showImagePlanes!==g;if(!z&&!U)return;m.current={selectedImageId:n,hoveredImageId:o,matchedImageIds:s,unselectedCameraOpacity:p,matchesOpacity:a,showImagePlanes:g};const D=R.array,T=A.array;G&&d==="rainbow"&&(w.current=(w.current+I*f*Xn.speedMultiplier)%1),F&&(x.current=(x.current+I)%2);const $=P.clock.elapsedTime*f*2;e.forEach((Q,K)=>{const re=K*48,J=K*16,L=Q.image.imageId===n,ee=Q.image.imageId===o,ie=s.has(Q.image.imageId);ee?gt.set(_t.frustum.hover):L?d==="rainbow"?Df(gt,w.current):gt.set(u):ie?gt.set(l):gt.setRGB(k[re],k[re+1],k[re+2]);let te;if(n===null?te=.9:L||ee?te=1:ie?te=a:te=p,L&&d==="blink"){const fe=(Math.sin($)+1)/2;te*=.1+.9*fe}ie&&i==="blink"&&(te*=.1+.9*Za(x.current)),(L||g&&n===null)&&(te=0);for(let fe=0;fe<16;fe++)D[re+fe*3+0]=gt.r,D[re+fe*3+1]=gt.g,D[re+fe*3+2]=gt.b,T[J+fe]=te}),R.needsUpdate=!0,A.needsUpdate=!0});const b=h.useMemo(()=>new Float32Array(k),[k]),M=h.useMemo(()=>{const P=new Float32Array(j.length),I=n===null?.9:p;for(let R=0;R<j.length;R++)P[R]=I;return P},[j.length,p,n]),E=h.useMemo(()=>new Ar({vertexShader:Ff,fragmentShader:Tf,vertexColors:!0,transparent:!0,depthWrite:!1,depthTest:!0,polygonOffset:!0,polygonOffsetFactor:1,polygonOffsetUnits:1}),[]);return e.length===0?null:r.jsx("lineSegments",{material:E,children:r.jsxs("bufferGeometry",{ref:v,children:[r.jsx("bufferAttribute",{attach:"attributes-position",args:[S,3]}),r.jsx("bufferAttribute",{attach:"attributes-color",args:[b,3]}),r.jsx("bufferAttribute",{attach:"attributes-alpha",args:[M,1]})]})})}function Wc({frustums:e,cameraScale:t,selectedImageId:n,matchedImageIds:o,onHover:s,onClick:a,onDoubleClick:i,onContextMenu:l,lastNavigationToImageId:c}){const d=h.useRef(null),[u,f]=h.useState(null),{controls:p}=In(),g=h.useCallback(()=>p?.dragging?.current??!1,[p]);h.useEffect(()=>()=>{document.body.style.cursor=""},[]);const y=h.useMemo(()=>new Dh(1,1),[]),v=h.useMemo(()=>new $i({transparent:!0,opacity:0,side:so,depthWrite:!1}),[]);h.useEffect(()=>()=>{y.dispose(),v.dispose()},[y,v]);const w=h.useMemo(()=>e.map(m=>{const S=m.camera.width/m.camera.height,k=m.camera.params[0]||1,j=t*m.camera.width/(2*k),b=j/S;return{width:j*2,height:b*2,depth:t}}),[e,t]);if(h.useLayoutEffect(()=>{if(!d.current)return;const m=d.current;e.forEach((S,k)=>{const j=w[k],b=S.image.imageId===n;Et.copy(S.position),wr.set(0,0,j.depth),wr.applyQuaternion(S.quaternion),Et.add(wr),b?Cn.set(0,0,0):Cn.set(j.width,j.height,1),Fn.compose(Et,S.quaternion,Cn),m.setMatrixAt(k,Fn)}),m.instanceMatrix.needsUpdate=!0},[e,w,n]),e.length===0)return null;const x=u!==null?e[u.instanceId]:null;return r.jsxs(r.Fragment,{children:[r.jsx("instancedMesh",{ref:d,args:[y,v,e.length],onPointerOver:m=>{if(m.instanceId===void 0||g())return;const S=e[m.instanceId];!S||S.image.imageId===n||(m.stopPropagation(),f({instanceId:m.instanceId,x:m.nativeEvent.clientX,y:m.nativeEvent.clientY}),s(S.image.imageId),document.body.style.cursor="pointer")},onPointerMove:m=>{if(g()){u!==null&&(f(null),s(null),document.body.style.cursor="");return}if(u!==null)f({instanceId:u.instanceId,x:m.nativeEvent.clientX,y:m.nativeEvent.clientY});else if(m.instanceId!==void 0){const S=e[m.instanceId];S&&S.image.imageId!==n&&(f({instanceId:m.instanceId,x:m.nativeEvent.clientX,y:m.nativeEvent.clientY}),s(S.image.imageId),document.body.style.cursor="pointer")}},onPointerOut:()=>{f(null),s(null),document.body.style.cursor=""},onClick:m=>{if(m.instanceId===void 0)return;const S=e[m.instanceId];!S||S.image.imageId===n||(m.stopPropagation(),a(S.image.imageId))},onDoubleClick:m=>{if(m.instanceId===void 0)return;const S=e[m.instanceId];!S||S.image.imageId===n||(m.stopPropagation(),i(S.image.imageId))},onContextMenu:m=>{if(m.instanceId===void 0)return;const S=e[m.instanceId];!S||S.image.imageId===n||(m.stopPropagation(),m.nativeEvent.preventDefault(),m.nativeEvent.stopPropagation(),l(S.image.imageId))}}),u!==null&&x&&r.jsx(gn,{style:{position:"fixed",left:u.x+12,top:u.y+12,pointerEvents:"none",transform:"none"},calculatePosition:()=>[0,0],children:r.jsxs("div",{className:se.container,children:[r.jsx("div",{className:se.title,children:x.image.name}),r.jsxs("div",{className:se.subtitle,children:["#",x.image.imageId]}),r.jsxs("div",{className:se.subtitle,children:[x.numPoints3D," points"]}),r.jsxs("div",{className:se.hint,children:[r.jsxs("div",{className:se.hintRow,children:[r.jsxs("svg",{className:tt.hoverCard,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[r.jsx("rect",{x:"6",y:"2",width:"12",height:"20",rx:"6"}),r.jsx("path",{d:"M12 2v8"}),r.jsx("rect",{x:"6",y:"2",width:"6",height:"8",rx:"3",fill:"currentColor",opacity:"0.5"})]}),"Left: select"]}),r.jsxs("div",{className:se.hintRow,children:[r.jsxs("svg",{className:tt.hoverCard,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[r.jsx("rect",{x:"6",y:"2",width:"12",height:"20",rx:"6"}),r.jsx("path",{d:"M12 2v8"}),r.jsx("rect",{x:"6",y:"2",width:"6",height:"8",rx:"3",fill:"currentColor",opacity:"0.5"}),r.jsx("text",{x:"18",y:"18",fontSize:"8",fill:"currentColor",stroke:"none",children:"2"})]}),"2xLeft: details"]}),r.jsxs("div",{className:se.hintRow,children:[r.jsxs("svg",{className:tt.hoverCard,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[r.jsx("rect",{x:"6",y:"2",width:"12",height:"20",rx:"6"}),r.jsx("path",{d:"M12 2v8"}),r.jsx("rect",{x:"12",y:"2",width:"6",height:"8",rx:"3",fill:"currentColor",opacity:"0.5"})]}),o.has(x.image.imageId)?"Right: matches":x.image.imageId===c?"Right: back":"Right: fly to"]})]})]})})]})}const QC=10,JC=179,Hc=2,Zc=32,Vc=h.memo(function({position:t,quaternion:n,camera:o,image:s,scale:a,imageFile:i,showImagePlane:l,isSelected:c,isMatched:d=!1,wouldGoBack:u=!1,selectionPlaneOpacity:f,color:p,cullAngleThreshold:g=YC,undistortionEnabled:y=!1,undistortionMode:v="fullFrame",numPoints3D:w,hoveredImageId:x,onHover:m,onClick:S,onDoubleClick:k,onContextMenu:j,disableInteraction:b=!1}){const[M,E]=h.useState(!1),[P,I]=h.useState(!0),[R,A]=h.useState(null),G=ye(H=>H.imageUrlBase),[F,z]=h.useState(null);h.useEffect(()=>{if(!c||!l||i){z(null);return}let H=!1;return(async()=>{let le=null;G?le=mn(s.name)??await er(G,s.name):Zt()&&(le=un(s.name)??await qo(s.name)),!H&&le&&z(le)})(),()=>{H=!0}},[c,l,i,s.name,G]);const Z=i??F??void 0;h.useEffect(()=>{M&&x!==s.imageId&&(E(!1),A(null),document.body.style.cursor="")},[M,x,s.imageId]);const{camera:U,controls:D}=In(),T=h.useRef(null),$=h.useRef(null),Q=B(H=>H.cameraProjection),K=B(H=>H.cameraFov),re=B(H=>H.setCameraFov),J=B(H=>H.selectionColorMode),L=B(H=>H.selectionAnimationSpeed),ee=h.useRef(0),ie=h.useRef(0),te=5;h.useEffect(()=>{if(!c||!M||Q!=="perspective")return;const H=ne=>{ne.preventDefault(),ne.stopPropagation(),D?.wheelHandled&&(D.wheelHandled.current=!0);const le=ne.deltaY>0?Hc:-Hc,_e=Math.max(QC,Math.min(JC,K+le));re(_e)};return window.addEventListener("wheel",H,{passive:!1,capture:!0}),()=>window.removeEventListener("wheel",H,{capture:!0})},[c,M,Q,K,re,D]);const de=()=>D?.dragging?.current??!1,fe=h.useRef(!1);fe.current=M,h.useEffect(()=>()=>{fe.current&&(m(null),document.body.style.cursor="")},[m]);const we=Pp(Z,s.name,l),pe=Lp(Z,s.name,c&&l),ge=c?pe??we:we,Re=h.useRef(null);ge&&(Re.current=ge);const Le=ge??Re.current,xe=l&&Le&&P,Ee=h.useRef(null);T.current&&Ee.current!==(xe?Le:null)&&(T.current.map=xe?Le:null,T.current.needsUpdate=!0,Ee.current=xe?Le:null);const ke=h.useMemo(()=>{const H=o.width/o.height,ne=o.params[0]||1,le=a*o.width/(2*ne),_e=le/H;return{width:le*2,height:_e*2,depth:a}},[o,a]),W=h.useMemo(()=>{const H=ke.width/2,ne=ke.height/2,le=[new V(-H,-ne,0),new V(H,-ne,0),new V(H,ne,0),new V(-H,ne,0)],_e=new Ho().setFromPoints(le),qe=new Oi({color:_t.frustum.selected,transparent:!0}),et=new Rh(_e,qe);return et.position.z=ke.depth,et},[ke.width,ke.height,ke.depth]);h.useEffect(()=>()=>{W&&(W.geometry.dispose(),W.material.dispose())},[W]),En((H,ne)=>{if(c&&W){const le=W.material;if(J==="rainbow")ee.current=(ee.current+ne*L*Xn.speedMultiplier)%1,le.color.copy(ua(ee.current));else if(J==="blink"){const _e=H.clock.elapsedTime*L*2,qe=(Math.sin(_e)+1)/2;le.opacity=.3+.7*qe,le.color.set(p)}else le.opacity=1,le.color.set(p)}if(l&&$.current){if(c){P||I(!0);return}if(ie.current=(ie.current+1)%te,ie.current!==0)return;if($.current.getWorldPosition(Mi),$.current.getWorldQuaternion(Uc),Mi.distanceTo(U.position)<a*3){P||I(!0);return}wr.set(0,0,1).applyQuaternion(Uc),Bc.copy(U.position).sub(Mi).normalize();const et=-wr.dot(Bc)>=g;P!==et&&I(et)}});const me=M?_t.frustum.hover:p;return r.jsxs("group",{ref:$,position:t,quaternion:n,children:[r.jsxs("mesh",{position:[0,0,ke.depth],renderOrder:c?100:0,userData:{isSelectedPlane:c},raycast:b?()=>{}:void 0,onClick:b?void 0:H=>{H.stopPropagation(),S(s.imageId)},onDoubleClick:b?void 0:H=>{H.stopPropagation(),k(s.imageId)},onContextMenu:b?void 0:H=>{H.stopPropagation(),H.nativeEvent.preventDefault(),H.nativeEvent.stopPropagation(),j(s.imageId)},onPointerOver:b?void 0:H=>{de()||!c&&(H.intersections.some(le=>le.object.userData?.isSelectedPlane===!0)||H.intersections[0]?.object!==H.object)||(H.stopPropagation(),E(!0),A({x:H.clientX,y:H.clientY}),m(s.imageId),document.body.style.cursor="pointer")},onPointerMove:b?void 0:H=>{if(de()){M&&(E(!1),A(null),m(null),document.body.style.cursor="");return}M&&A({x:H.clientX,y:H.clientY})},onPointerOut:b?void 0:()=>{E(!1),A(null),m(null),document.body.style.cursor=""},children:[y&&v==="fullFrame"?r.jsx("planeGeometry",{args:[ke.width,ke.height,Zc,Zc]}):r.jsx("planeGeometry",{args:[ke.width,ke.height]}),y&&xe&&Le?r.jsx(GC,{map:Le,camera:o,undistortionEnabled:y,undistortionMode:v,planeWidth:ke.width,planeHeight:ke.height,opacity:M?f*.5:f,color:16777215,side:so,depthTest:!c,forceTransparent:c,forceDepthWrite:c?!1:void 0}):(()=>{const H=M?xe?f*.5:Ms.frustum.hoveredNoTexture:xe?f:f*.2,{transparent:ne,depthWrite:le}=Ui(H);return r.jsx("meshBasicMaterial",{ref:T,map:xe?Le:null,color:xe?16777215:me,side:so,transparent:c?!0:ne,depthWrite:c?!1:le,depthTest:!c,toneMapped:!1,opacity:H})})()]}),c&&r.jsx("primitive",{object:W}),M&&R&&r.jsx(gn,{style:{position:"fixed",left:R.x+12,top:R.y+12,pointerEvents:"none",transform:"none"},calculatePosition:()=>[0,0],children:r.jsxs("div",{className:se.container,children:[r.jsx("div",{className:se.title,children:s.name}),r.jsxs("div",{className:se.subtitle,children:["#",s.imageId]}),r.jsxs("div",{className:se.subtitle,children:[w," points"]}),r.jsxs("div",{className:se.hint,children:[c&&Q==="perspective"&&r.jsxs("div",{className:se.hintRow,children:[r.jsxs("svg",{className:tt.hoverCard,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[r.jsx("rect",{x:"6",y:"2",width:"12",height:"20",rx:"6"}),r.jsx("path",{d:"M12 6v4M12 14v4M9 8l3-3 3 3M9 16l3 3 3-3"})]}),"Scroll: FOV"]}),r.jsxs("div",{className:se.hintRow,children:[r.jsxs("svg",{className:tt.hoverCard,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[r.jsx("rect",{x:"6",y:"2",width:"12",height:"20",rx:"6"}),r.jsx("path",{d:"M12 2v8"}),r.jsx("rect",{x:"6",y:"2",width:"6",height:"8",rx:"3",fill:"currentColor",opacity:"0.5"})]}),c?"Left: details":"Left: select"]}),r.jsxs("div",{className:se.hintRow,children:[r.jsxs("svg",{className:tt.hoverCard,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[r.jsx("rect",{x:"6",y:"2",width:"12",height:"20",rx:"6"}),r.jsx("path",{d:"M12 2v8"}),r.jsx("rect",{x:"12",y:"2",width:"6",height:"8",rx:"3",fill:"currentColor",opacity:"0.5"})]}),d?"Right: matches":u?"Right: back":"Right: fly to"]}),c&&r.jsx("div",{className:se.hintRow,children:"(U) undistort"})]})]})})]})}),Ei=h.memo(function({position:t,quaternion:n,planeDepth:o,planeWidth:s,planeHeight:a,onSelect:i,onGoto:l,onInfo:c,onClose:d}){return r.jsx("group",{position:t,quaternion:n,children:r.jsx(gn,{position:[s/2,a/2,o],style:{pointerEvents:"auto"},children:r.jsxs("div",{className:at.container,onMouseLeave:d,children:[r.jsxs("button",{className:at.button,onClick:i,children:[r.jsxs("svg",{className:at.icon,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[r.jsx("circle",{cx:"12",cy:"12",r:"10"}),r.jsx("circle",{cx:"12",cy:"12",r:"3",fill:"currentColor"})]}),"Select"]}),r.jsxs("button",{className:at.button,onClick:l,children:[r.jsx("svg",{className:at.icon,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:r.jsx("path",{d:"M5 12h14M12 5l7 7-7 7"})}),"Go to"]}),r.jsxs("button",{className:at.button,onClick:c,children:[r.jsxs("svg",{className:at.icon,viewBox:"0 0 24 24",fill:"currentColor",children:[r.jsx("circle",{cx:"12",cy:"5",r:"2.5"}),r.jsx("rect",{x:"9.5",y:"10",width:"5",height:"12",rx:"1"})]}),"Info"]})]})})})});function Gc(){const e=ye(O=>O.reconstruction),t=ye(O=>O.loadedFiles),n=ye(O=>O.imageUrlBase),o=B(O=>O.cameraDisplayMode),s=B(O=>O.cameraScale),a=B(O=>O.cameraScaleFactor),i=s*parseFloat(a),l=B(O=>O.selectedImageId),c=B(O=>O.setSelectedImageId),d=B(O=>O.selectionPlaneOpacity),u=B(O=>O.undistortionEnabled),f=B(O=>O.undistortionMode),p=Rf(),g=o==="imageplane",y=q(O=>O.openImageDetail),v=q(O=>O.setMatchedImageId),w=q(O=>O.setShowMatchesInModal),x=B(O=>O.flyToImage),m=B(O=>O.pushNavigationHistory),S=B(O=>O.popNavigationHistory),k=B(O=>O.peekNavigationHistory),j=B(O=>O.flyToState),b=B(O=>O.selectionColorMode),M=B(O=>O.selectionColor),E=B(O=>O.selectionAnimationSpeed),P=B(O=>O.frustumColorMode),I=B(O=>O.unselectedCameraOpacity),R=q(O=>O.showMatches),A=q(O=>O.matchesDisplayMode),G=q(O=>O.matchesOpacity),F=q(O=>O.matchesColor),[z,Z]=h.useState(null),[U,D]=h.useState(null),{camera:T,controls:$,gl:Q}=In(),K=h.useRef(new V),re=h.useRef(new ut),J=h.useRef(0),L=h.useRef(!1),ee=h.useRef(!1),ie=h.useRef(null);h.useEffect(()=>{const O=Ae=>{ie.current={x:Ae.clientX,y:Ae.clientY}};return document.addEventListener("mousemove",O),()=>document.removeEventListener("mousemove",O)},[]),En(()=>{const O=K.current.distanceToSquared(T.position)>1e-4,Ae=re.current.angleTo(T.quaternion)>.001,De=performance.now();if(O||Ae)K.current.copy(T.position),re.current.copy(T.quaternion),J.current=De,L.current||(L.current=!0,Mp());else if(L.current&&De-J.current>hn.transitionBase&&(L.current=!1,Ep(),ee.current&&ie.current&&Q?.domElement)){ee.current=!1;const We=Q.domElement,ze=new PointerEvent("pointermove",{clientX:ie.current.x,clientY:ie.current.y,bubbles:!0,cancelable:!0,pointerType:"mouse",pointerId:1});We.dispatchEvent(ze)}});const te=t?.imageFiles,de=h.useMemo(()=>{if(!e)return new Map;const O=new Map;let Ae=0;for(const De of e.cameras.keys())O.set(De,Ae++);return O},[e]),fe=h.useMemo(()=>{const O=new Map;if(!e)return O;const Ae=new Map;for(const We of e.images.values()){const ze=We.name.split(/[/\\]/),rt=ze.length>=2?ze[ze.length-1]:We.name,Y=Ae.get(rt)??[];Y.push(We.imageId),Ae.set(rt,Y)}let De=0;for(const We of Ae.values())if(We.length>=2){for(const ze of We)O.set(ze,De);De++}return O},[e]),we=h.useMemo(()=>{if(!e||l===null||!R)return new Set;const O=e.connectedImagesIndex.get(l);return O?new Set(O.keys()):new Set},[e,l,R]),pe=B(O=>O.navigationHistory),ge=h.useMemo(()=>pe.length===0?null:pe[pe.length-1].toImageId,[pe]),[Re,Le]=h.useState(0),[xe,Ee]=h.useState(0),ke=h.useMemo(()=>{if(!e)return[];const O=[];for(const Ae of e.images.values()){const De=e.cameras.get(Ae.cameraId);if(!De)continue;const We=Zo(Ae),ze=ba(Ae);if(!Number.isFinite(We.x)||!Number.isFinite(We.y)||!Number.isFinite(We.z))continue;let rt;n?rt=mn(Ae.name):Zt()?rt=un(Ae.name)??void 0:rt=ao(te,Ae.name),O.push({image:Ae,camera:De,position:We,quaternion:ze,imageFile:rt,cameraIndex:de.get(Ae.cameraId)??0,numPoints3D:e.imageStats.get(Ae.imageId)?.numPoints3D??0})}return O},[e,o,te,n,de,Re,xe]),W=h.useCallback(O=>{D(null),O===l?y(O):c(O)},[l,c,y]),me=h.useCallback(O=>{D(null),y(O)},[y]),H=h.useCallback(O=>{const Ae=ke.find(Y=>Y.image.imageId===O);if(!Ae)return;if(O===l){const Y=k();if(Y&&Y.toImageId===O){const be=S();be&&(Z(null),document.body.style.cursor="",ee.current=!0,j(be.fromState),c(be.fromImageId));return}c(null);return}if(l!==null&&we.has(O)){w(!0),v(O),y(l),setTimeout(()=>v(O),0);return}Ae.imageFile&&Zi(Ae.imageFile,Ae.image.name);const De=$?.getCurrentViewState,We=k();if(De&&We&&We.toImageId===O){const Y=S();Y&&(Z(null),document.body.style.cursor="",ee.current=!0,j(Y.fromState),c(Y.fromImageId));return}if(De){const Y=De();m({fromState:Y,fromImageId:l,toImageId:O})}Z(null),document.body.style.cursor="",ee.current=!0,c(O),x(O);const ze=Iu(Ae.camera);(ze.k1!==0||ze.k2!==0||ze.k3!==0||ze.k4!==0||ze.p1!==0||ze.p2!==0)&&Ca.getState().showTip("undistortion","Press U to toggle lens undistortion")},[ke,x,c,l,we,y,v,w,$,k,S,m,j]),ne=h.useCallback(O=>{const Ae=ke.find(De=>De.image.imageId===O);Ae?.imageFile&&Zi(Ae.imageFile,Ae.image.name)},[ke]);h.useEffect(()=>{if(!n||!e||l===null)return;const O=e.images.get(l);if(!O)return;mn(O.name)||er(n,O.name).then(De=>{De&&Le(We=>We+1)})},[n,e,l]),h.useEffect(()=>{if(n||!Zt()||!e||l===null)return;const O=e.images.get(l);if(!O)return;un(O.name)||qo(O.name).then(De=>{De&&Ee(We=>We+1)})},[n,e,l]);const le=h.useCallback(()=>{U&&(ne(U.imageId),c(U.imageId),D(null))},[U,c,ne]),_e=h.useCallback(()=>{if(!U)return;const O=U.imageId;ne(O);const Ae=$?.getCurrentViewState;if(Z(null),document.body.style.cursor="",ee.current=!0,!Ae){x(O),D(null);return}const De=Ae(),We=k();if(We&&We.toImageId===O){const ze=S();ze&&(j(ze.fromState),c(ze.fromImageId))}else m({fromState:De,fromImageId:l,toImageId:O}),x(O);D(null)},[U,x,ne,k,S,m,j,$,l,c]),qe=h.useCallback(()=>{U&&(y(U.imageId),D(null))},[U,y]),et=h.useCallback(()=>{D(null)},[]);if(ke.length===0||p)return null;const Ue=l!==null?ke.find(O=>O.image.imageId===l)??null:null,Jt=b==="rainbow"?_t.frustum.selected:M,en=Ue&&r.jsx(Vc,{position:Ue.position,quaternion:Ue.quaternion,camera:Ue.camera,image:Ue.image,scale:i,imageFile:Ue.imageFile,showImagePlane:!0,isSelected:!0,isMatched:!1,wouldGoBack:Ue.image.imageId===ge,selectionPlaneOpacity:d,color:Jt,undistortionEnabled:u,undistortionMode:f,numPoints3D:Ue.numPoints3D,hoveredImageId:z,onHover:Z,onClick:W,onDoubleClick:me,onContextMenu:H},`selected-${Ue.image.imageId}`);return o==="arrow"?r.jsxs("group",{children:[r.jsx(XC,{frustums:ke,cameraScale:i,selectedImageId:l,hoveredImageId:z,matchedImageIds:we,matchesOpacity:G,matchesDisplayMode:A,matchesColor:F,frustumColorMode:P,selectionColorMode:b,selectionColor:M,selectionAnimationSpeed:E,unselectedCameraOpacity:I,imageFrameIndexMap:fe,onHover:Z,onClick:W,onDoubleClick:me,onContextMenu:H,lastNavigationToImageId:ge}),en,U&&r.jsx(Ei,{position:U.position,quaternion:U.quaternion,planeDepth:U.planeDepth,planeWidth:U.planeWidth,planeHeight:U.planeHeight,onSelect:le,onGoto:_e,onInfo:qe,onClose:et})]}):o==="imageplane"?r.jsxs("group",{children:[r.jsx(Wc,{frustums:ke,cameraScale:i,selectedImageId:l,matchedImageIds:we,onHover:Z,onClick:W,onDoubleClick:me,onContextMenu:H,lastNavigationToImageId:ge}),ke.map(O=>{if(O.image.imageId===l)return null;const De=we.has(O.image.imageId),We=De?F:Va(P,O.cameraIndex,O.image.imageId,fe);let ze;return l===null?ze=d:De?ze=d*G:ze=d*I,r.jsx(Vc,{position:O.position,quaternion:O.quaternion,camera:O.camera,image:O.image,scale:i,imageFile:O.imageFile,showImagePlane:l===null,isSelected:!1,isMatched:De,wouldGoBack:O.image.imageId===ge,selectionPlaneOpacity:ze,color:We,cullAngleThreshold:qC,undistortionEnabled:u,undistortionMode:f,numPoints3D:O.numPoints3D,hoveredImageId:z,onHover:Z,onClick:W,onDoubleClick:me,onContextMenu:H,disableInteraction:!0},O.image.imageId)}),en,U&&r.jsx(Ei,{position:U.position,quaternion:U.quaternion,planeDepth:U.planeDepth,planeWidth:U.planeWidth,planeHeight:U.planeHeight,onSelect:le,onGoto:_e,onInfo:qe,onClose:et})]}):r.jsxs("group",{children:[r.jsx(KC,{frustums:ke,cameraScale:i,selectedImageId:l,hoveredImageId:z,matchedImageIds:we,matchesOpacity:G,matchesDisplayMode:A,matchesColor:F,frustumColorMode:P,selectionColorMode:b,selectionColor:M,selectionAnimationSpeed:E,unselectedCameraOpacity:I,showImagePlanes:g,imageFrameIndexMap:fe}),r.jsx(Wc,{frustums:ke,cameraScale:i,selectedImageId:l,matchedImageIds:we,onHover:Z,onClick:W,onDoubleClick:me,onContextMenu:H,lastNavigationToImageId:ge}),en,U&&r.jsx(Ei,{position:U.position,quaternion:U.quaternion,planeDepth:U.planeDepth,planeWidth:U.planeWidth,planeHeight:U.planeHeight,onSelect:le,onGoto:_e,onInfo:qe,onClose:et})]})}function Yc(){const e=ye(u=>u.reconstruction),t=B(u=>u.selectedImageId),n=B(u=>u.cameraDisplayMode),o=q(u=>u.showMatches),s=q(u=>u.matchesDisplayMode),a=q(u=>u.matchesOpacity),i=q(u=>u.matchesColor),l=h.useRef(null),c=h.useRef(0);En((u,f)=>{o&&s==="blink"&&l.current&&(c.current=(c.current+f)%2,l.current.opacity=a*(.1+.9*Za(c.current)))});const d=h.useMemo(()=>{if(!e||t===null||!o||n==="imageplane")return null;const u=e.images.get(t);if(!u)return null;const f=Zo(u),p=e.connectedImagesIndex.get(t);if(!p||p.size===0)return null;const g=new Set(p.keys()),y=[];for(const w of g){const x=e.images.get(w);if(!x)continue;const m=Zo(x);y.push(f.x,f.y,f.z),y.push(m.x,m.y,m.z)}const v=new Ho;return v.setAttribute("position",new br(y,3)),v},[e,t,o,n]);return h.useEffect(()=>()=>{d?.dispose()},[d]),!o||n==="imageplane"||!d?null:r.jsx("lineSegments",{geometry:d,renderOrder:999,children:r.jsx("lineBasicMaterial",{ref:l,color:i,transparent:!0,opacity:a,depthTest:!1})})}const wn=new $n;function ek(e){return e<.3?e/.3:e<.6?1:e<1?1-(e-.6)/.4:0}function tk(e){const t=e.split(/[/\\]/);return t.length>=2?t[t.length-1]:e}function qc(){const e=ye(g=>g.reconstruction),t=zt(g=>g.showRig),n=zt(g=>g.rigDisplayMode),o=zt(g=>g.rigColorMode),s=zt(g=>g.rigLineColor),a=zt(g=>g.rigLineOpacity),i=B(g=>g.selectedImageId),l=B(g=>g.unselectedCameraOpacity),c=h.useRef(null),d=h.useRef(0),u=h.useRef(null),f=h.useMemo(()=>{if(!t||!e)return null;const g=new Map;for(const S of e.images.values()){const k=tk(S.name),j=g.get(k);j?j.push(S):g.set(k,[S])}const y=[],v=[],w=[],x=[];let m=0;for(const S of g.values()){if(S.length<2)continue;const k=S.map(M=>Zo(M)),j=new Set(S.map(M=>M.imageId));wn.set(Bi(m)),m++;const b=k[0];for(let M=1;M<k.length;M++){const E=k[M];y.push(b.x,b.y,b.z),v.push(wn.r,wn.g,wn.b),w.push(1),y.push(E.x,E.y,E.z),v.push(wn.r,wn.g,wn.b),w.push(1),x.push(j),x.push(j)}}return y.length===0?null:{positions:new Float32Array(y),colors:new Float32Array(v),alphas:new Float32Array(w),lineFrameImageIds:x}},[e,t,o]),p=h.useMemo(()=>new Ar({vertexShader:Ff,fragmentShader:Tf,vertexColors:!0,transparent:!0,depthWrite:!1,depthTest:!0,polygonOffset:!0,polygonOffsetFactor:1,polygonOffsetUnits:1}),[]);return En((g,y)=>{if(!c.current||!f)return;const v=c.current.getAttribute("color"),w=c.current.getAttribute("alpha");if(!v||!w)return;const x=n==="blink";x&&(d.current=(d.current+y)%2);const m=u.current,S=!m||m.selectedImageId!==i||m.rigLineOpacity!==a||m.unselectedCameraOpacity!==l;if(!x&&!S)return;const k=x?.1+.9*ek(d.current):1,{lineFrameImageIds:j}=f;for(let b=0;b<w.count;b++){const M=j[b],E=i!==null&&M.has(i);let P;i===null||E?P=a*k:P=a*l*k,w.setX(b,P)}if(o==="single"){wn.set(s);for(let b=0;b<v.count;b++)v.setXYZ(b,wn.r,wn.g,wn.b);v.needsUpdate=!0}w.needsUpdate=!0,u.current={selectedImageId:i,rigLineOpacity:a,unselectedCameraOpacity:l}}),!t||!f?null:r.jsx("lineSegments",{material:p,children:r.jsxs("bufferGeometry",{ref:c,children:[r.jsx("bufferAttribute",{attach:"attributes-position",args:[f.positions,3]}),r.jsx("bufferAttribute",{attach:"attributes-color",args:[f.colors,3]}),r.jsx("bufferAttribute",{attach:"attributes-alpha",args:[f.alphas,1]})]})})}const nk={distanceThreshold:.05,maxIterations:1e3,sampleCount:5e4},ok=.8;function rk(e,t,n,o,s,a){return[t*a-n*s,n*o-e*a,e*s-t*o]}function sk(e,t,n,o,s,a){return e*o+t*s+n*a}function ik(e,t,n){const o=Math.sqrt(e*e+t*t+n*n);return o<1e-10?[0,0,1]:[e/o,t/o,n/o]}function ak(e,t,n,o,s,a,i,l,c){const d=o-e,u=s-t,f=a-n,p=i-e,g=l-t,y=c-n,[v,w,x]=rk(d,u,f,p,g,y);if(v*v+w*w+x*x<1e-10)return null;const S=ik(v,w,x),k=-sk(S[0],S[1],S[2],e,t,n);return{normal:S,d:k}}function Cs(e,t,n,o,s,a,i){return o*e+s*t+a*n+i}function lk(e){const t=Math.floor(Math.random()*e);let n=Math.floor(Math.random()*(e-1));n>=t&&n++;let o=Math.floor(Math.random()*(e-2));return o>=Math.min(t,n)&&o++,o>=Math.max(t,n)&&o++,[t,n,o]}function ck(e,t){if(e<=t){const s=new Uint32Array(e);for(let a=0;a<e;a++)s[a]=a;return s}const n=new Uint32Array(t),o=e/t;for(let s=0;s<t;s++){const a=Math.floor(s*o),i=Math.floor(Math.random()*o);n[s]=Math.min(a+i,e-1)}return n}function zf(e,t={}){const{distanceThreshold:n,maxIterations:o,sampleCount:s}={...nk,...t},a=e.length/3;if(a<3)return null;const i=ck(a,s),l=i.length;let c=null,d=0;for(let x=0;x<o;x++){const[m,S,k]=lk(l),j=i[m],b=i[S],M=i[k],E=ak(e[j*3],e[j*3+1],e[j*3+2],e[b*3],e[b*3+1],e[b*3+2],e[M*3],e[M*3+1],e[M*3+2]);if(!E)continue;let P=0;for(let I=0;I<l;I++){const R=i[I];Math.abs(Cs(e[R*3],e[R*3+1],e[R*3+2],E.normal[0],E.normal[1],E.normal[2],E.d))<=n&&P++}if(P>d&&(d=P,c=E,P/l>=ok))break}if(!c||d<3)return null;const{normal:u,d:f}=c;let p=0,g=0,y=0,v=0;for(let x=0;x<a;x++){const m=e[x*3],S=e[x*3+1],k=e[x*3+2];Math.abs(Cs(m,S,k,u[0],u[1],u[2],f))<=n&&(p++,g+=m,y+=S,v+=k)}if(p===0)return null;g/=p,y/=p,v/=p;let w=0;for(let x=0;x<a;x++){const m=e[x*3],S=e[x*3+1],k=e[x*3+2];if(Math.abs(Cs(m,S,k,u[0],u[1],u[2],f))<=n){const b=m-g,M=S-y,E=k-v,P=b*b+M*M+E*E;P>w&&(w=P)}}return{normal:u,d:f,centroid:[g,y,v],inlierCount:p,radius:Math.sqrt(w)}}function Of(e,t){const n=e.length/3,o=new Float32Array(n),{normal:s,d:a}=t;for(let i=0;i<n;i++)o[i]=Cs(e[i*3],e[i*3+1],e[i*3+2],s[0],s[1],s[2],a);return o}function $f(e){return{...e,normal:[-e.normal[0],-e.normal[1],-e.normal[2]],d:-e.d}}function Bf(e,t){const n=e.length/3,o=new Float32Array(e.length),s=new V;for(let a=0;a<n;a++){const i=a*3;s.set(e[i],e[i+1],e[i+2]),s.applyQuaternion(t.rotation),s.multiplyScalar(t.scale),s.add(t.translation),o[i]=s.x,o[i+1]=s.y,o[i+2]=s.z}return o}let fa=null,ks=null,Xc=!1;async function uk(){if(Xc)return;const e=await ma(()=>import("./browser-CXh1ITwj.js"),[]);fa=e.deflateSync,ks=e.inflateSync,Xc=!0}function Uf(e){return btoa(String.fromCharCode(...e)).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}function Wf(e){try{let t=e.replace(/-/g,"+").replace(/_/g,"/");for(;t.length%4!==0;)t+="=";const n=atob(t),o=new Uint8Array(n.length);for(let s=0;s<n.length;s++)o[s]=n.charCodeAt(s);return o}catch{return null}}const is={pointCloud:new Set(["showPointCloud","pointSize","pointOpacity","colorMode","minTrackLength","maxReprojectionError"]),ui:new Set(["showPoints2D","showPoints3D","showAxes","showGrid","axesCoordinateSystem","axesScale","gridScale","axisLabelMode","backgroundColor","showGizmo","galleryCollapsed","showMatches","matchesDisplayMode","matchesOpacity","matchesColor","showMaskOverlay","maskOpacity"]),camera:new Set(["showCameras","cameraDisplayMode","cameraScaleFactor","cameraScale","frustumColorMode","unselectedCameraOpacity","cameraProjection","cameraFov","showSelectionHighlight","selectionPlaneOpacity","undistortionEnabled","undistortionMode"]),rig:new Set(["showRig","rigDisplayMode","rigColorMode","rigLineColor","rigLineOpacity"])};function as(e,t){const n={};for(const[o,s]of Object.entries(e))t.has(o)&&typeof s!="function"&&s!==1/0&&(n[o]=s);return n}function dk(){const e={},t=as(Qe.getState(),is.pointCloud);Object.keys(t).length>0&&(e.pointCloud=t);const n=as(q.getState(),is.ui);Object.keys(n).length>0&&(e.ui=n);const o=as(B.getState(),is.camera);Object.keys(o).length>0&&(e.camera=o);const s=as(zt.getState(),is.rig);Object.keys(s).length>0&&(e.rig=s);const a=Lt.getState();return jo(a.transform)||(e.transform=a.transform),e}function fk(e){e.pointCloud&&Qe.setState(e.pointCloud),e.ui&&q.setState(e.ui),e.camera&&B.setState(e.camera),e.rig&&zt.setState(e.rig),e.transform&&Lt.getState().setTransform(e.transform)}function Hf(e){const t=new ArrayBuffer(72),n=new DataView(t),[o,s,a]=e.position,[i,l,c]=e.target,[d,u,f,p]=e.quaternion,g=p<0?-d:d,y=p<0?-u:u,v=p<0?-f:f;return n.setFloat64(0,o,!0),n.setFloat64(8,s,!0),n.setFloat64(16,a,!0),n.setFloat64(24,i,!0),n.setFloat64(32,l,!0),n.setFloat64(40,c,!0),n.setFloat64(48,g,!0),n.setFloat64(56,y,!0),n.setFloat64(64,v,!0),new Uint8Array(t)}function hk(e){return`c=${Uf(Hf(e))}`}function mk(e,t,n){const o=typeof e!="string",s=o?JSON.stringify(e):e,a=new TextEncoder().encode(s),i=a.length,l=t!==null,c=n!=null,d=c?new TextEncoder().encode(JSON.stringify(n)):null,u=d?.length??0,f=2+i+(l?72:0)+(c?2+u:0),p=new ArrayBuffer(f),g=new DataView(p),y=new Uint8Array(p);let v=0;if(g.setUint16(v,i,!0),v+=2,y.set(a,v),v+=i,l&&t){const k=Hf(t);y.set(k,v),v+=72}c&&d&&(g.setUint16(v,u,!0),v+=2,y.set(d,v));let w,x=!1;if(fa)try{const k=fa(y,{level:9});k.length<y.length?(w=k,x=!0):w=y}catch{w=y}else w=y;const m=new Uint8Array(1+w.length),S=(l?1:0)|(c?2:0)|(o?4:0)|(x?8:0);return m[0]=S,m.set(w,1),`d=${Uf(m)}`}async function Zf(e){const t=e.startsWith("#")?e.slice(1):e,o=new URLSearchParams(t).get("d");if(!o)return null;const s=Wf(o);if(!s||s.length<3)return null;const a=s[0],i=(a&1)!==0,l=(a&2)!==0,c=(a&4)!==0,d=(a&8)!==0;let u=s.slice(1);if(d){if(ks||await uk(),!ks)return null;try{u=new Uint8Array(ks(u))}catch{return null}}if(u.length<2)return null;const f=new DataView(u.buffer,u.byteOffset,u.byteLength);let p=0;const g=f.getUint16(p,!0);if(p+=2,u.length<p+g)return null;const y=u.slice(p,p+g),v=new TextDecoder().decode(y);p+=g;let w=null,x=null;if(c)try{x=JSON.parse(v)}catch{return null}else w=v;let m=null;if(i){if(u.length<p+72)return null;const k=u.slice(p,p+72);m=Vf(k),p+=72}let S=null;if(l){if(u.length<p+2)return null;const k=f.getUint16(p,!0);if(p+=2,u.length<p+k)return null;const j=u.slice(p,p+k);try{S=JSON.parse(new TextDecoder().decode(j))}catch{}}return{manifestUrl:w,manifest:x,viewState:m,config:S}}function Vf(e){if(e.length!==72)return null;const t=new DataView(e.buffer,e.byteOffset,e.byteLength),n=t.getFloat64(0,!0),o=t.getFloat64(8,!0),s=t.getFloat64(16,!0),a=t.getFloat64(24,!0),i=t.getFloat64(32,!0),l=t.getFloat64(40,!0),c=t.getFloat64(48,!0),d=t.getFloat64(56,!0),u=t.getFloat64(64,!0),f=1-c*c-d*d-u*u;if(f<0)return null;const p=Math.sqrt(f);return{position:[n,o,s],target:[a,i,l],quaternion:[c,d,u,p],distance:Math.sqrt((n-a)*(n-a)+(o-i)*(o-i)+(s-l)*(s-l))}}function pk(e){const t=Wf(e);return!t||t.length!==72?null:Vf(t)}function gk(e){const t=e.split(",").map(g=>parseFloat(g));if(t.length!==10||t.some(isNaN))return null;const[n,o,s,a,i,l,c,d,u,f]=t,p=Math.sqrt(c*c+d*d+u*u+f*f);return p<.9||p>1.1?null:{position:[n,o,s],target:[a,i,l],quaternion:[c,d,u,f],distance:Math.sqrt((n-a)*(n-a)+(o-i)*(o-i)+(s-l)*(s-l))}}async function xk(e){const t=e.startsWith("#")?e.slice(1):e,n=new URLSearchParams(t);if(n.get("d"))return(await Zf(e))?.viewState??null;const s=n.get("c");if(s)return pk(s);const a=n.get("camera");return a?gk(a):null}function Ss(e,t,n){const s=window.location.hostname==="colmapview.github.io"?"https://colmapview.github.io/v0.4.7/":window.location.origin+window.location.pathname,a=new URL(s);if(e){const i=dk();return a.hash=mk(e,t,i),a.toString()}return t&&(a.hash=hk(t)),a.toString()}function Kc(e,t,n){const o=Ss(e,t),s=new URL(o);return s.searchParams.set("embed","1"),s.toString()}function yk(e){return`<iframe src="${e}" width="100%" height="600" frameborder="0" allowfullscreen></iframe>`}async function vk(e){try{return await navigator.clipboard.writeText(e),!0}catch{const t=document.createElement("textarea");t.value=e,t.style.position="fixed",t.style.opacity="0",document.body.appendChild(t),t.select();try{return document.execCommand("copy"),!0}catch{return!1}finally{document.body.removeChild(t)}}}const wk=2e3;async function Pi(e,t){await vk(e)&&(t(!0),setTimeout(()=>t(!1),wk))}const Us=h.memo(function({checked:t,onChange:n,size:o="sm",disabled:s=!1,label:a,labelPosition:i="left",className:l=""}){const c=hp(t,o,s),d=()=>{s||n(!t)},u=p=>{(p.key===" "||p.key==="Enter")&&(p.preventDefault(),s||n(!t))},f=r.jsx("div",{role:"switch","aria-checked":t,"aria-disabled":s,tabIndex:s?-1:0,className:c.track,onClick:d,onKeyDown:u,children:r.jsx("span",{className:c.thumb,style:c.thumbStyle})});return a?r.jsxs("label",{className:`${on.container} ${l}`,children:[i==="left"&&r.jsx("span",{className:on.label,children:a}),f,i==="right"&&r.jsx("span",{className:on.label,children:a})]}):f}),wt=Vn;function Gf(e){if(e>=1)return 0;const t=e.toString(),n=t.indexOf(".");return n===-1?0:t.length-n-1}function bk(e,t){const n=Gf(t),o=Math.pow(10,n);return Math.round(e*o)/o}const st=h.memo(function({label:t,value:n,min:o,max:s,step:a,onChange:i,formatValue:l}){const[c,d]=h.useState(!1),[u,f]=h.useState(""),p=h.useRef(null),g=n??o,y=Gf(a),v=l?l(g):g.toFixed(y),w=(g-o)/(s-o)*100,x=()=>{f(String(g)),d(!0)};h.useEffect(()=>{c&&p.current&&(p.current.focus(),p.current.select())},[c]);const m=()=>{const j=parseFloat(u);if(!isNaN(j)){const b=Math.min(s,Math.max(o,j));i(b)}d(!1)},S=j=>{j.key==="Enter"?m():j.key==="Escape"&&d(!1)},k=j=>{j.preventDefault();const b=j.deltaY>0?-a:a,M=bk(Math.min(s,Math.max(o,g+b)),a);i(M)};return r.jsxs("div",{className:wt.row,onWheel:k,children:[r.jsx("label",{className:wt.label,children:t}),r.jsx("input",{type:"range",min:o,max:s,step:a,value:g,onChange:j=>i(parseFloat(j.target.value)),className:wt.slider,style:{"--range-progress":`${w}%`}}),c?r.jsx("input",{ref:p,type:"text",value:u,onChange:j=>f(j.target.value),onBlur:m,onKeyDown:S,className:wt.valueInput}):r.jsx("span",{className:wt.value,onDoubleClick:x,title:"Double-click to edit",children:v})]})}),Li=h.memo(function({label:t,value:n,onChange:o}){const[s,a]=h.useState(!1),[i,l]=h.useState(""),c=h.useRef(null),u=da(n).h,f=w=>{o(Bs(w,100,50))},p=w=>{w.preventDefault();const x=w.deltaY>0?-5:5,m=(u+x+360)%360;f(m)},g=()=>{l(String(u)),a(!0)};h.useEffect(()=>{s&&c.current&&(c.current.focus(),c.current.select())},[s]);const y=()=>{const w=parseInt(i);if(!isNaN(w)){const x=(w%360+360)%360;f(x)}a(!1)},v=w=>{w.key==="Enter"?y():w.key==="Escape"&&a(!1)};return r.jsxs("div",{className:wt.row,onWheel:p,children:[r.jsx("label",{className:wt.label,children:t}),r.jsxs("div",{className:"relative flex-1 min-w-0 h-4 flex items-center",children:[r.jsx("div",{className:"absolute left-0 right-0 h-1.5 rounded-full z-0",style:{background:"linear-gradient(to right, #ff0000, #ffff00, #00ff00, #00ffff, #0000ff, #ff00ff, #ff0000)"}}),r.jsx("input",{type:"range",min:0,max:360,step:1,value:u,onChange:w=>f(parseInt(w.target.value)),className:"w-full h-4 cursor-pointer appearance-none bg-transparent relative z-10 [&::-webkit-slider-thumb]:appearance-none [&::-webkit-slider-thumb]:w-3 [&::-webkit-slider-thumb]:h-3 [&::-webkit-slider-thumb]:rounded-full [&::-webkit-slider-thumb]:bg-white [&::-webkit-slider-thumb]:border [&::-webkit-slider-thumb]:border-gray-400 [&::-webkit-slider-thumb]:shadow [&::-webkit-slider-thumb]:cursor-pointer [&::-moz-range-thumb]:w-3 [&::-moz-range-thumb]:h-3 [&::-moz-range-thumb]:rounded-full [&::-moz-range-thumb]:bg-white [&::-moz-range-thumb]:border [&::-moz-range-thumb]:border-gray-400 [&::-moz-range-thumb]:cursor-pointer [&::-webkit-slider-runnable-track]:bg-transparent [&::-moz-range-track]:bg-transparent"})]}),s?r.jsx("input",{ref:c,type:"text",value:i,onChange:w=>l(w.target.value),onBlur:y,onKeyDown:v,className:wt.valueInput,style:{color:n}}):r.jsxs("span",{className:wt.value,style:{color:n},onDoubleClick:g,title:"Double-click to edit",children:[u,"Â°"]})]})}),Ck=h.memo(function({label:t,value:n,onChange:o}){const[s,a]=h.useState(!1),[i,l]=h.useState(""),c=h.useRef(null),d=y=>{y.preventDefault();const v=y.deltaY>0?-5:5,w=(n+v+360)%360;o(w)},u=()=>{l(String(n)),a(!0)};h.useEffect(()=>{s&&c.current&&(c.current.focus(),c.current.select())},[s]);const f=()=>{const y=parseInt(i);if(!isNaN(y)){const v=(y%360+360)%360;o(v)}a(!1)},p=y=>{y.key==="Enter"?f():y.key==="Escape"&&a(!1)},g=Bs(n,100,50);return r.jsxs("div",{className:wt.row,onWheel:d,children:[r.jsx("label",{className:wt.label,children:t}),r.jsxs("div",{className:"relative flex-1 min-w-0 h-4 flex items-center",children:[r.jsx("div",{className:"absolute left-0 right-0 h-1.5 rounded-full z-0",style:{background:"linear-gradient(to right, #ff0000, #ffff00, #00ff00, #00ffff, #0000ff, #ff00ff, #ff0000)"}}),r.jsx("input",{type:"range",min:0,max:360,step:1,value:n,onChange:y=>o(parseInt(y.target.value)),className:"w-full h-4 cursor-pointer appearance-none bg-transparent relative z-10 [&::-webkit-slider-thumb]:appearance-none [&::-webkit-slider-thumb]:w-3 [&::-webkit-slider-thumb]:h-3 [&::-webkit-slider-thumb]:rounded-full [&::-webkit-slider-thumb]:bg-white [&::-webkit-slider-thumb]:border [&::-webkit-slider-thumb]:border-gray-400 [&::-webkit-slider-thumb]:shadow [&::-webkit-slider-thumb]:cursor-pointer [&::-moz-range-thumb]:w-3 [&::-moz-range-thumb]:h-3 [&::-moz-range-thumb]:rounded-full [&::-moz-range-thumb]:bg-white [&::-moz-range-thumb]:border [&::-moz-range-thumb]:border-gray-400 [&::-moz-range-thumb]:cursor-pointer [&::-webkit-slider-runnable-track]:bg-transparent [&::-moz-range-track]:bg-transparent"})]}),s?r.jsx("input",{ref:c,type:"text",value:i,onChange:y=>l(y.target.value),onBlur:f,onKeyDown:p,className:wt.valueInput,style:{color:g}}):r.jsxs("span",{className:wt.value,style:{color:g},onDoubleClick:u,title:"Double-click to edit",children:[n,"Â°"]})]})}),Rn=h.memo(function({label:t,checked:n,onChange:o}){return r.jsxs("div",{className:wt.row,children:[r.jsx("label",{className:wt.label,children:t}),r.jsx("div",{className:"flex-1"}),r.jsx(Us,{checked:n,onChange:()=>o(!n),size:"sm"})]})}),jt=h.memo(function({label:t,value:n,onChange:o,options:s}){const a=i=>{i.preventDefault();const l=s.findIndex(c=>c.value===n);if(i.deltaY>0){const c=Math.min(l+1,s.length-1);o(s[c].value)}else{const c=Math.max(l-1,0);o(s[c].value)}};return r.jsxs("div",{className:wt.row,onWheel:a,children:[r.jsx("label",{className:wt.label,children:t}),r.jsx("select",{value:n,onChange:i=>o(i.target.value),className:wt.selectRight,children:s.map(i=>r.jsx("option",{value:i.value,children:i.label},i.value))})]})}),kk=48,Sk=h.memo(function({title:t,children:n}){const o=h.useRef(null),[s,a]=h.useState(null);return h.useLayoutEffect(()=>{if(!o.current)return;const i=o.current.getBoundingClientRect(),c=window.innerHeight-kk;if(i.bottom>c){const d=i.bottom-c;a(-d)}else a(null)},[n]),r.jsx("div",{ref:o,className:wt.panelWrapper,style:s!==null?{top:s}:void 0,children:r.jsxs("div",{className:wt.panel,children:[r.jsx("div",{className:wt.panelTitle,children:t}),n]})})}),Ht=h.memo(function({panelId:t,activePanel:n,setActivePanel:o,icon:s,tooltip:a,isActive:i=!1,onClick:l,onDoubleClick:c,panelTitle:d,children:u,disabled:f=!1}){const p=n===t,g=d&&u;return r.jsxs("div",{className:"relative w-10 control-button-responsive",onMouseEnter:()=>!f&&o(t),onMouseLeave:()=>o(null),children:[r.jsx("button",{onClick:f?void 0:l,onDoubleClick:f?void 0:c,disabled:f,className:`group ${dp(i,p)} ${f?"opacity-40 cursor-not-allowed":""}`,...!g&&zu(f?`${a} (no data loaded)`:a,"left"),children:s}),g&&p&&!f&&r.jsx(Sk,{title:d,children:u})]})}),ve=Vn,jk={0:"â°",1:"Â¹",2:"Â²",3:"Â³",4:"â´",5:"âµ",6:"â¶",7:"â·",8:"â¸",9:"â¹","-":"â»",".":"Â·"};function Qc(e){return e.toFixed(1).split("").map(n=>jk[n]||n).join("")}const ls=["Why did COLMAP break up with the blurry photo? No future together.","COLMAP's dating profile: Looking for matches.","My COLMAP crashed. Guess it couldn't handle my good looks.","COLMAP walked into a bar. The bartender said, 'You look like you've seen some points.'","Why is COLMAP bad at poker? It always shows its hand... and tracks it.","COLMAP's favorite dance? The bundle adjustment shuffle.","I told COLMAP a joke. It took 3 hours to get the point.","COLMAP at therapy: 'I have too many issues... with my features.'","Why did the point cloud go to school? To get more depth.","COLMAP's life motto: When in doubt, RANSAC it out."],Ik=h.memo(function({styles:t,activePanel:n,setActivePanel:o}){const s=ye(m=>m.reconstruction),a=ye(m=>m.droppedFiles),i=Lt(m=>m.transform),l=Lt(m=>m.setTransform),c=Lt(m=>m.resetTransform),d=q(m=>m.showGizmo),u=q(m=>m.toggleGizmo),{processFiles:f}=Dr(),p=Ve(m=>m.pickingMode),g=Ve(m=>m.setPickingMode),y=!jo(i),v=m=>m*(180/Math.PI),w=m=>m*(Math.PI/180);lt(Se.toggleGizmo.keys,u,{scopes:Se.toggleGizmo.scopes},[u]);const x=`Transform (T): ${d?"On":"Off"}${y?" (dbl-click to apply)":""}`;return r.jsx(Ht,{panelId:"transform",activePanel:n,setActivePanel:o,icon:r.jsx(jf,{className:"w-6 h-6"}),tooltip:x,isActive:d,onClick:u,onDoubleClick:y?Sr:void 0,panelTitle:"Transform",disabled:!s,children:r.jsxs("div",{className:t.panelContent,children:[r.jsx(Rn,{label:"Gizmo (T)",checked:d,onChange:u}),r.jsx(st,{label:"Scale",value:i.scale,min:.01,max:10,step:.01,onChange:m=>l({scale:m}),formatValue:m=>m.toFixed(2)}),r.jsx(st,{label:"Rotate-X",value:v(i.rotationX),min:-180,max:180,step:1,onChange:m=>l({rotationX:w(m)}),formatValue:m=>`${m.toFixed(0)}Â°`}),r.jsx(st,{label:"Rotate-Y",value:v(i.rotationY),min:-180,max:180,step:1,onChange:m=>l({rotationY:w(m)}),formatValue:m=>`${m.toFixed(0)}Â°`}),r.jsx(st,{label:"Rotate-Z",value:v(i.rotationZ),min:-180,max:180,step:1,onChange:m=>l({rotationZ:w(m)}),formatValue:m=>`${m.toFixed(0)}Â°`}),r.jsx(st,{label:"Translate-X",value:i.translationX,min:-100,max:100,step:.1,onChange:m=>l({translationX:m}),formatValue:m=>m.toFixed(1)}),r.jsx(st,{label:"Translate-Y",value:i.translationY,min:-100,max:100,step:.1,onChange:m=>l({translationY:m}),formatValue:m=>m.toFixed(1)}),r.jsx(st,{label:"Translate-Z",value:i.translationZ,min:-100,max:100,step:.1,onChange:m=>l({translationZ:m}),formatValue:m=>m.toFixed(1)}),r.jsx("div",{className:t.presetGroup,children:r.jsx("button",{onClick:()=>cd(),className:t.presetButton,"data-tooltip":"Move scene center to (0,0,0)","data-tooltip-pos":"bottom",children:"Center at Origin"})}),r.jsxs("div",{className:t.presetGroup,children:[r.jsx("button",{onClick:()=>g(p==="origin-1pt"?"off":"origin-1pt"),className:p==="origin-1pt"?t.actionButtonPrimary:t.presetButton,"data-tooltip":"{LMB} Click 1 point to set as origin (0,0,0)","data-tooltip-pos":"bottom",children:"1-Point Origin"}),r.jsx("button",{onClick:()=>g(p==="distance-2pt"?"off":"distance-2pt"),className:p==="distance-2pt"?t.actionButtonPrimary:t.presetButton,"data-tooltip":"{LMB} Click 2 points, set target distance","data-tooltip-pos":"bottom",children:"2-Point Scale"}),r.jsx("button",{onClick:()=>g(p==="normal-3pt"?"off":"normal-3pt"),className:p==="normal-3pt"?t.actionButtonPrimary:t.presetButton,"data-tooltip":"{LMB} Click 3 points clockwise to align plane with Y-up","data-tooltip-pos":"bottom",children:"3-Point Align"})]}),r.jsxs("div",{className:t.actionGroup,children:[r.jsx("button",{onClick:c,disabled:!y,className:y?t.actionButton:t.actionButtonDisabled,children:"Reset"}),r.jsx("button",{onClick:()=>{a&&(c(),f(a))},disabled:!a,className:a?t.actionButton:t.actionButtonDisabled,children:"Reload"}),r.jsx("button",{onClick:Sr,disabled:!y,className:y?t.actionButtonPrimary:t.actionButtonPrimaryDisabled,children:"Apply"})]}),y&&r.jsx("div",{className:t.hint,children:'Transform will be applied to reconstruction data when you click "Apply".'})]})})}),Mk=h.memo(function({styles:t,activePanel:n,setActivePanel:o}){const s=ye(E=>E.reconstruction),a=ye(E=>E.wasmReconstruction),i=Lt(E=>E.transform),l=Ge(E=>E.detectedPlane),c=Ge(E=>E.setDetectedPlane),d=Ge(E=>E.distanceThreshold),u=Ge(E=>E.setDistanceThreshold),f=Ge(E=>E.sampleCount),p=Ge(E=>E.setSampleCount),g=Ge(E=>E.floorColorMode),y=Ge(E=>E.setFloorColorMode),v=Ge(E=>E.setPointDistances),w=Ge(E=>E.isDetecting),x=Ge(E=>E.setIsDetecting),m=Ge(E=>E.setNormalFlipped),S=Ge(E=>E.reset),k=a?.pointCount??s?.points3D?.size??0,j=h.useCallback(()=>{a?.hasPoints()&&(x(!0),setTimeout(()=>{let E=a.getPositions();if(!E){x(!1);return}if(!jo(i)){const I=zn(i);E=Bf(E,I)}const P=zf(E,{distanceThreshold:d,sampleCount:f});if(c(P),P){const I=Of(E,P);let R=0,A=0;for(let G=0;G<I.length;G++)I[G]>0?R++:I[G]<0&&A++;m(R<A),v(I),g==="off"&&y("binary")}else v(null);x(!1)},10))},[a,d,f,i,c,v,x,m,g,y]),b=h.useCallback(()=>{S()},[S]),M=l&&k>0?(l.inlierCount/k*100).toFixed(1):null;return r.jsx(Ht,{panelId:"floor",activePanel:n,setActivePanel:o,icon:r.jsx(O2,{className:"w-6 h-6"}),tooltip:l?`Floor detected (${M}% inliers)`:"Floor Detection",isActive:l!==null,panelTitle:"Floor Detection",disabled:!s||!a?.hasPoints(),children:r.jsxs("div",{className:t.panelContent,children:[r.jsxs("div",{className:t.presetGroup,children:[r.jsx("button",{onClick:j,disabled:w||!a?.hasPoints(),className:w?t.actionButtonDisabled:t.actionButtonPrimary,"data-tooltip":"Run RANSAC to detect floor plane","data-tooltip-pos":"bottom",children:w?"Detecting...":"Detect Floor"}),r.jsx("button",{onClick:b,disabled:!l,className:l?t.actionButton:t.actionButtonDisabled,"data-tooltip":"Clear floor detection","data-tooltip-pos":"bottom",children:"Clear"})]}),r.jsx(st,{label:"Threshold",value:d,min:.001,max:.5,step:.001,onChange:u,formatValue:E=>E.toFixed(3)}),r.jsx(st,{label:"Samples",value:f,min:1e3,max:1e5,step:1e3,onChange:p,formatValue:E=>`${(E/1e3).toFixed(0)}k`}),r.jsx(jt,{label:"Color",value:g,onChange:E=>y(E),options:[{value:"off",label:"Off"},{value:"binary",label:"Binary (In/Out)"},{value:"distance",label:"Distance"}]}),l&&r.jsxs("div",{className:"text-ds-secondary text-sm mt-3",children:[r.jsx("div",{className:"mb-1 font-medium",children:"Detection Result:"}),r.jsxs("div",{children:[M,"% inliers (",l.inlierCount.toLocaleString()," pts)"]}),r.jsx("div",{className:"text-xs text-ds-muted mt-1",children:"Left-click widget to flip normal"}),r.jsx("div",{className:"text-xs text-ds-muted",children:"Right-click widget to cycle axis"})]}),!l&&r.jsxs("div",{className:"text-ds-secondary text-sm mt-3",children:[r.jsx("div",{className:"mb-1 font-medium",children:"RANSAC Floor Detection:"}),r.jsx("div",{children:"Detect dominant plane in"}),r.jsx("div",{children:"the point cloud for alignment."})]})]})})}),Ek=h.memo(function({activePanel:t,setActivePanel:n}){const o=q(i=>i.galleryCollapsed),s=q(i=>i.toggleGalleryCollapsed);return q(i=>i.embedMode)?null:r.jsx(Ht,{panelId:"gallery",activePanel:t,setActivePanel:n,icon:o?r.jsx(R2,{className:"w-6 h-6"}):r.jsx(F2,{className:"w-6 h-6"}),tooltip:o?"Show gallery":"Hide gallery",isActive:!o,onClick:s})});function Pk(){const[e,t]=h.useState(null),[n,o]=h.useState(!1),[s,a]=h.useState(!1),[i,l]=h.useState(!1),[c,d]=h.useState(!0),[u,f]=h.useState(!0),[p,g]=h.useState(null),y=Qe(C=>C.showPointCloud),v=Qe(C=>C.togglePointCloud),w=Qe(C=>C.pointSize),x=Qe(C=>C.setPointSize),m=Qe(C=>C.pointOpacity),S=Qe(C=>C.setPointOpacity),k=Qe(C=>C.colorMode),j=Qe(C=>C.setColorMode),b=Qe(C=>C.minTrackLength),M=Qe(C=>C.setMinTrackLength),E=Qe(C=>C.maxReprojectionError),P=Qe(C=>C.setMaxReprojectionError),I=B(C=>C.showCameras),R=B(C=>C.setShowCameras),A=B(C=>C.cameraDisplayMode),G=B(C=>C.setCameraDisplayMode),F=B(C=>C.cameraScaleFactor),z=B(C=>C.setCameraScaleFactor),Z=B(C=>C.cameraScale),U=B(C=>C.setCameraScale),D=B(C=>C.selectionPlaneOpacity),T=B(C=>C.setSelectionPlaneOpacity),$=B(C=>C.showSelectionHighlight),Q=B(C=>C.setShowSelectionHighlight),K=B(C=>C.selectionColorMode),re=B(C=>C.setSelectionColorMode),J=B(C=>C.selectionColor),L=B(C=>C.setSelectionColor),ee=B(C=>C.selectionAnimationSpeed),ie=B(C=>C.setSelectionAnimationSpeed),te=B(C=>C.cameraMode),de=B(C=>C.setCameraMode),fe=B(C=>C.flySpeed),we=B(C=>C.setFlySpeed),pe=B(C=>C.flyTransitionDuration),ge=B(C=>C.setFlyTransitionDuration),Re=B(C=>C.pointerLock),Le=B(C=>C.setPointerLock),xe=B(C=>C.frustumColorMode),Ee=B(C=>C.setFrustumColorMode),ke=B(C=>C.unselectedCameraOpacity),W=B(C=>C.setUnselectedCameraOpacity),me=B(C=>C.cameraProjection),H=B(C=>C.setCameraProjection),ne=B(C=>C.cameraFov),le=B(C=>C.setCameraFov),_e=B(C=>C.horizonLock),qe=B(C=>C.setHorizonLock),et=B(C=>C.autoRotateMode),Ue=B(C=>C.setAutoRotateMode),Jt=B(C=>C.autoRotateSpeed),en=B(C=>C.setAutoRotateSpeed),O=B(C=>C.undistortionEnabled),Ae=B(C=>C.setUndistortionEnabled),De=q(C=>C.showMatches),We=q(C=>C.setShowMatches),ze=q(C=>C.matchesDisplayMode),rt=q(C=>C.setMatchesDisplayMode),Y=q(C=>C.matchesOpacity),be=q(C=>C.setMatchesOpacity),he=q(C=>C.matchesColor),Ie=q(C=>C.setMatchesColor),Oe=q(C=>C.showAxes),ce=q(C=>C.showGrid),Ze=q(C=>C.setShowAxes),Je=q(C=>C.setShowGrid),Mt=q(C=>C.toggleAxes),kt=q(C=>C.toggleGrid),Ne=q(C=>C.axesCoordinateSystem),Xe=q(C=>C.setAxesCoordinateSystem),St=q(C=>C.axesScale),_=q(C=>C.setAxesScale),Be=q(C=>C.gridScale),Te=q(C=>C.setGridScale),dt=q(C=>C.axisLabelMode),ft=q(C=>C.setAxisLabelMode),Ye=q(C=>C.backgroundColor),$t=q(C=>C.setBackgroundColor),Pe=q(C=>C.setView),Bt=q(C=>C.openContextMenuEditor),Ut=He(C=>C.screenshotSize),tn=He(C=>C.setScreenshotSize),N=He(C=>C.screenshotFormat),ae=He(C=>C.setScreenshotFormat),oe=He(C=>C.screenshotHideLogo),Fe=He(C=>C.setScreenshotHideLogo),yt=He(C=>C.takeScreenshot),pt=He(C=>C.getScreenshotBlob),Rt=He(C=>C.recordGif),Yt=He(C=>C.isRecordingGif),Pn=He(C=>C.gifBlobUrl),yn=He(C=>C.gifDuration),nr=He(C=>C.setGifDuration),zr=He(C=>C.gifDownsample),Or=He(C=>C.setGifDownsample),or=He(C=>C.downloadGif),Js=He(C=>C.recordingFormat),Jf=He(C=>C.setRecordingFormat),eh=He(C=>C.recordingQuality),th=He(C=>C.setRecordingQuality),nh=He(C=>C.gifSpeed),oh=He(C=>C.setGifSpeed),ei=He(C=>C.exportFormat),$r=He(C=>C.setExportFormat),Ke=ye(C=>C.reconstruction),Qn=ye(C=>C.wasmReconstruction),rh=ye(C=>C.loadedFiles),qa=ye(C=>C.sourceType),sh=ye(C=>C.sourceUrl),ih=ye(C=>C.sourceManifest),Ln=B(C=>C.currentViewState),ah=Lt(C=>C.transform),Xa=!jo(ah),ti=(qa==="url"||qa==="manifest")&&Ke,qt=sh??ih,_n=zt(C=>C.showRig),Br=zt(C=>C.setShowRig),Mo=zt(C=>C.rigDisplayMode),Ur=zt(C=>C.setRigDisplayMode),Ka=zt(C=>C.rigColorMode),lh=zt(C=>C.setRigColorMode),ch=zt(C=>C.rigLineColor),uh=zt(C=>C.setRigLineColor),dh=zt(C=>C.rigLineOpacity),fh=zt(C=>C.setRigLineOpacity),hh=h.useMemo(()=>{if(!Ke)return{hasRigData:!1,cameraCount:0,frameCount:0};const C=new Map;for(const vt of Ke.images.values()){const ht=vt.name.split(/[/\\]/),sr=ht.length>=2?ht[ht.length-1]:vt.name;C.set(sr,(C.get(sr)??0)+1)}let nt=0,At=0;for(const vt of C.values())vt>=2&&(nt++,At=Math.max(At,vt));return{hasRigData:nt>0,cameraCount:At,frameCount:nt}},[Ke]),{hasRigData:Jn,cameraCount:Qa,frameCount:Ja}=hh,mh=h.useCallback(async()=>{if(!qt)return;const C=Ss(qt,Ln);await Pi(C,o)},[qt,Ln]),ph=h.useCallback(async()=>{if(!qt)return;const C=Kc(qt,Ln);await Pi(C,a)},[qt,Ln]),gh=h.useCallback(async()=>{if(!qt)return;const C=Kc(qt,Ln),nt=yk(C);await Pi(nt,l)},[qt,Ln]),Wr=h.useCallback(C=>{const nt=[];if(Ke){const sr=Ke.globalStats?.totalPoints??0,ll=Ke.images.size,cl=Ke.cameras.size,Ih=ir=>ir>=1e6?`${(ir/1e6).toFixed(1)}M`:ir>=1e3?`${(ir/1e3).toFixed(1)}K`:ir.toString();sr>0&&nt.push(`ðŸ“ ${Ih(sr)} points`),ll>0&&nt.push(`ðŸ–¼ï¸ ${ll} images`),cl>1&&nt.push(`ðŸ“· ${cl} cameras`)}const At="#3DReconstruction #Photogrammetry #COLMAP",vt=C?"Made with ColmapView by @opsiclear":"Made with https://colmapview.github.io/ by @opsiclear",ht="[type something here ...]";return nt.length>0?`${ht}

${nt.join(" | ")}

${At}
${vt}`:`${ht}

${At}
${vt}`},[Ke]),rr=h.useCallback(async()=>{if(!pt)return!1;try{const C=await pt();if(C)return await navigator.clipboard.write([new ClipboardItem({"image/png":C})]),Nt.getState().addNotification("info","Screenshot copied! Press Ctrl+V to paste",4e3),!0}catch(C){console.error("Failed to copy screenshot to clipboard:",C)}return!1},[pt]),xh=h.useCallback(()=>{if(!Rt||Yt||p!==null)return;g(3),Nt.getState().addNotification("info","Countdown (3)",900);const C=nt=>{nt>0?(g(nt),nt<3&&Nt.getState().addNotification("info",`Countdown (${nt})`,900),setTimeout(()=>C(nt-1),1e3)):(g(null),Nt.getState().addNotification("info","Recording started!",2e3),Rt().then(()=>{Nt.getState().addNotification("info","Recording complete! Downloading...",3e3),setTimeout(()=>{or()},100)}))};C(3)},[Rt,Yt,p,or]),yh=h.useCallback(async()=>{const C=qt?Ss(qt,Ln):null,nt=c&&!!C,At=Wr(nt);u&&await rr();const vt=nt?`https://twitter.com/intent/tweet?text=${encodeURIComponent(At)}&url=${encodeURIComponent(C)}`:`https://twitter.com/intent/tweet?text=${encodeURIComponent(At)}`;window.open(vt,"_blank","width=700,height=600")},[qt,Ln,Wr,rr,c,u]),vh=h.useCallback(async()=>{const C=qt?Ss(qt,Ln):null,nt=c&&!!C,At=Wr(nt);try{const vt=nt?`${At}
${C}`:At;await navigator.clipboard.writeText(vt),Nt.getState().addNotification("info","Message copied! Paste in LinkedIn post",4e3)}catch{}u&&await rr(),window.open("https://www.linkedin.com/feed/","_blank","width=700,height=600")},[qt,Ln,Wr,rr,c,u]),wh=h.useCallback(()=>{if(ei==="config"){const C=Mc(),nt=Ic(C),At=new Blob([nt],{type:"text/yaml"}),vt=URL.createObjectURL(At),ht=document.createElement("a");ht.href=vt,ht.download="colmapview-config.yml",document.body.appendChild(ht),ht.click(),document.body.removeChild(ht),URL.revokeObjectURL(vt);return}if(Ke)switch(ei){case"text":gl(Ke,Qn);break;case"binary":xl(Ke,Qn);break;case"ply":yl(Ke,Qn);break}},[Ke,Qn,ei]),[vn,el]=h.useState(()=>da(Ye));h.useEffect(()=>{el(C=>Bs(C.h,C.s,C.l)!==Ye?da(Ye):C)},[Ye]);const eo=h.useCallback(C=>{el(C),$t(Bs(C.h,C.s,C.l))},[$t]),ni=h.useCallback(()=>{const C=vn.l<50?100:0;eo({h:0,s:0,l:C})},[vn.l,eo]),bh=h.useCallback(C=>{eo({...vn,h:C})},[vn,eo]),Ch=h.useCallback(C=>{eo({...vn,s:C})},[vn,eo]),kh=h.useCallback(C=>{eo({...vn,l:C})},[vn,eo]),oi=h.useCallback(()=>{de(te==="orbit"?"fly":"orbit")},[te,de]),tl=h.useCallback(()=>{Ae(!O)},[O,Ae]),ri=Qe(C=>C.setShowPointCloud),si=h.useCallback(()=>{y?k==="rgb"?j("error"):k==="error"?j("trackLength"):ri(!1):(ri(!0),j("rgb"))},[y,k,ri,j]),ii=h.useCallback(()=>{I?A==="frustum"?G("arrow"):A==="arrow"?G("imageplane"):R(!1):(R(!0),G("frustum"))},[I,A,R,G]),ai=h.useCallback(()=>{De?ze==="on"?rt("blink"):We(!1):(We(!0),rt("on"))},[De,ze,We,rt]),Sh=h.useCallback(()=>{$?K==="static"?re("blink"):K==="blink"?re("rainbow"):Q(!1):(Q(!0),re("static"))},[$,K,Q,re]),jh=h.useCallback(()=>{_n?Mo==="lines"?Ur("blink"):Br(!1):(Br(!0),Ur("lines"))},[_n,Mo,Br,Ur]),Hr=h.useCallback(()=>{Pe("reset"),H("perspective")},[Pe,H]);lt(Se.resetView.keys,Hr,{scopes:Se.resetView.scopes},[Hr]),lt(Se.viewX.keys,()=>Pe("x"),{scopes:Se.viewX.scopes},[Pe]),lt(Se.viewY.keys,()=>Pe("y"),{scopes:Se.viewY.scopes},[Pe]),lt(Se.viewZ.keys,()=>Pe("z"),{scopes:Se.viewZ.scopes},[Pe]),lt(Se.viewNegX.keys,()=>Pe("-x"),{scopes:Se.viewNegX.scopes},[Pe]),lt(Se.viewNegY.keys,()=>Pe("-y"),{scopes:Se.viewNegY.scopes},[Pe]),lt(Se.viewNegZ.keys,()=>Pe("-z"),{scopes:Se.viewNegZ.scopes},[Pe]);const nl=h.useCallback(()=>{Oe&&ce?Je(!1):Oe&&!ce?(Ze(!1),Je(!0)):!Oe&&ce?Je(!1):(Ze(!0),Je(!0))},[Oe,ce,Ze,Je]);lt(Se.toggleGrid.keys,nl,{scopes:Se.toggleGrid.scopes},[nl]),lt(Se.toggleCameraMode.keys,oi,{scopes:Se.toggleCameraMode.scopes},[oi]),lt(Se.toggleBackground.keys,ni,{scopes:Se.toggleBackground.scopes},[ni]),lt(Se.cyclePointSize.keys,si,{scopes:Se.cyclePointSize.scopes},[si]),lt(Se.cycleCameraDisplay.keys,ii,{scopes:Se.cycleCameraDisplay.scopes},[ii]),lt(Se.cycleMatchesDisplay.keys,ai,{scopes:Se.cycleMatchesDisplay.scopes},[ai]),lt(Se.toggleUndistortion.keys,tl,{scopes:Se.toggleUndistortion.scopes},[tl]);const ol=h.useCallback(()=>{const C=ls[Math.floor(Math.random()*ls.length)];Nt.getState().addNotification("info",C,4e3)},[]),rl=h.useCallback(()=>{const C=ls[Math.floor(Math.random()*ls.length)];Nt.getState().addNotification("warning",C)},[]);lt(Se.showJoke.keys,ol,{scopes:Se.showJoke.scopes,preventDefault:!0},[ol]),lt(Se.showJokePersistent.keys,rl,{scopes:Se.showJokePersistent.scopes,preventDefault:!0},[rl]);const sl=h.useCallback(()=>{Ca.getState().resetGuide(),Nt.getState().addNotification("info","Guide tips reset",3e3)},[]);lt(Se.resetGuide.keys,sl,{scopes:Se.resetGuide.scopes,preventDefault:!0},[sl]);const il=Ve(C=>C.reset),al=Ve(C=>C.pickingMode)!=="off";return lt("escape",il,{enabled:al},[il,al]),r.jsxs("div",{className:ve.container,children:[r.jsx(Ht,{panelId:"view",activePanel:e,setActivePanel:t,icon:r.jsx(_2,{className:"w-6 h-6"}),tooltip:"View options (R)",onClick:Hr,panelTitle:"View",children:r.jsxs("div",{className:ve.panelContent,children:[r.jsxs("div",{className:"flex gap-1 mb-3",children:[r.jsx("button",{onClick:()=>H("perspective"),className:me==="perspective"?ve.actionButtonPrimary:ve.actionButton,style:{flex:1},children:"Persp"}),r.jsx("button",{onClick:()=>H("orthographic"),className:me==="orthographic"?ve.actionButtonPrimary:ve.actionButton,style:{flex:1},children:"Ortho"})]}),me==="perspective"&&r.jsx(st,{label:"FOV",value:ne,min:10,max:120,step:1,onChange:le,formatValue:C=>`${C}Â°`}),r.jsxs("div",{className:"flex gap-1 mb-1",children:[r.jsxs("button",{onClick:()=>Pe("x"),className:ve.actionButton,style:{flex:1},children:["+X ",r.jsx("span",{className:"text-ds-muted text-xs",children:"(1)"})]}),r.jsxs("button",{onClick:()=>Pe("y"),className:ve.actionButton,style:{flex:1},children:["+Y ",r.jsx("span",{className:"text-ds-muted text-xs",children:"(2)"})]}),r.jsxs("button",{onClick:()=>Pe("z"),className:ve.actionButton,style:{flex:1},children:["+Z ",r.jsx("span",{className:"text-ds-muted text-xs",children:"(3)"})]})]}),r.jsxs("div",{className:"flex gap-1 mb-3",children:[r.jsxs("button",{onClick:()=>Pe("-x"),className:ve.actionButton,style:{flex:1},children:["-X ",r.jsx("span",{className:"text-ds-muted text-xs",children:"(4)"})]}),r.jsxs("button",{onClick:()=>Pe("-y"),className:ve.actionButton,style:{flex:1},children:["-Y ",r.jsx("span",{className:"text-ds-muted text-xs",children:"(5)"})]}),r.jsxs("button",{onClick:()=>Pe("-z"),className:ve.actionButton,style:{flex:1},children:["-Z ",r.jsx("span",{className:"text-ds-muted text-xs",children:"(6)"})]})]}),r.jsx("div",{className:ve.actionGroup,children:r.jsxs("button",{onClick:Hr,className:ve.actionButtonPrimary,style:{flex:1},children:["Reset View",r.jsx("span",{className:"text-ds-void/70 ml-2 text-xs",children:"(R)"})]})})]})}),r.jsx(Ht,{panelId:"axes",activePanel:e,setActivePanel:t,icon:r.jsx(dr,{icon:Oe&&ce?r.jsx(I2,{className:"w-6 h-6"}):Oe?r.jsx(Mf,{className:"w-6 h-6"}):ce?r.jsx(j2,{className:"w-6 h-6"}):r.jsx(S2,{className:"w-6 h-6"}),label:Oe&&ce?"A+G":Oe?"AXS":ce?"GRD":"OFF"}),tooltip:"Axes & Grid (G)",isActive:Oe||ce,panelTitle:"Axes & Grid (G)",children:r.jsxs("div",{className:ve.panelContent,children:[r.jsx(Rn,{label:"Show Axes",checked:Oe,onChange:Mt}),r.jsx(Rn,{label:"Show Grid",checked:ce,onChange:kt}),r.jsx(jt,{label:"System",value:Ne,onChange:C=>Xe(C),options:[{value:"colmap",label:"COLMAP"},{value:"opencv",label:"OpenCV"},{value:"threejs",label:"Three.js"},{value:"opengl",label:"OpenGL"},{value:"vulkan",label:"Vulkan"},{value:"blender",label:"Blender"},{value:"houdini",label:"Houdini"},{value:"unity",label:"Unity"},{value:"unreal",label:"Unreal"}]}),r.jsx(jt,{label:"Labels",value:dt,onChange:C=>ft(C),options:[{value:"off",label:"Off"},{value:"xyz",label:"XYZ"},{value:"extra",label:"Extra"}]}),r.jsx(st,{label:"Axes Scale",value:Math.log10(St),min:-3,max:3,step:.1,onChange:C=>_(Math.pow(10,C)),formatValue:C=>`10${Qc(C)}`}),r.jsx(st,{label:"Grid Scale",value:Math.log10(Be),min:-3,max:3,step:.1,onChange:C=>Te(Math.pow(10,C)),formatValue:C=>`10${Qc(C)}`})]})}),r.jsx(Ht,{panelId:"camera",activePanel:e,setActivePanel:t,icon:r.jsx(dr,{icon:te==="orbit"?r.jsx(A2,{className:"w-6 h-6"}):r.jsx(N2,{className:"w-6 h-6"}),label:te==="orbit"?"ORB":"FLY"}),tooltip:te==="orbit"?"Orbit mode (C)":"Fly mode (C)",onClick:oi,panelTitle:"Camera Mode (C)",children:r.jsxs("div",{className:ve.panelContent,children:[r.jsx(jt,{label:"Mode",value:te,onChange:C=>de(C),options:[{value:"orbit",label:"Orbit"},{value:"fly",label:"Fly"}]}),r.jsx(st,{label:"Speed",value:fe,min:.1,max:5,step:.1,onChange:we,formatValue:C=>C.toFixed(1)}),r.jsx(st,{label:"Goto Anim",value:pe,min:0,max:2e3,step:100,onChange:ge,formatValue:C=>C===0?"Off":`${(C/1e3).toFixed(1)}s`}),r.jsxs("div",{className:ve.row,children:[r.jsx("label",{className:ve.label,children:"Pointer Lock"}),r.jsx("span",{className:"flex-1"}),r.jsx(Us,{checked:Re,onChange:Le})]}),r.jsx(jt,{label:"Horizon Lock",value:_e,onChange:C=>qe(C),options:[{value:"off",label:"Off"},{value:"on",label:"On"},{value:"flip",label:"Flip"}]}),r.jsx(jt,{label:"Auto Rotate",value:et,onChange:C=>Ue(C),options:[{value:"off",label:"Off"},{value:"cw",label:"Clockwise"},{value:"ccw",label:"Counter-CW"}]}),r.jsx(st,{label:"Rotate Speed",value:Jt,min:.1,max:2,step:.1,onChange:en,formatValue:C=>C.toFixed(1)}),r.jsxs("div",{className:"text-ds-secondary text-sm mt-3",children:[r.jsx("div",{className:"mb-1 font-medium",children:"Keyboard:"}),r.jsx("div",{children:"WASD: Move"}),r.jsx("div",{children:"Q: Down, E/Space: Up"}),r.jsx("div",{children:"Shift: Speed boost"}),te==="fly"&&r.jsxs(r.Fragment,{children:[r.jsx("div",{className:"mt-1 font-medium",children:"Mouse:"}),r.jsx("div",{children:"Drag: Look around"}),r.jsx("div",{children:"Scroll: Move forward/back"})]})]})]})}),r.jsx(Ht,{panelId:"bg",activePanel:e,setActivePanel:t,icon:r.jsx(Ef,{className:"w-6 h-6"}),tooltip:"Background color (B)",onClick:ni,panelTitle:"Background Color (B)",children:r.jsxs("div",{className:ve.panelContent,children:[r.jsx(Ck,{label:"Hue",value:vn.h,onChange:bh}),r.jsx(st,{label:"Saturation",value:vn.s,min:0,max:100,step:1,onChange:Ch,formatValue:C=>`${Math.round(C)}%`}),r.jsx(st,{label:"Lightness",value:vn.l,min:0,max:100,step:1,onChange:kh,formatValue:C=>`${Math.round(C)}%`})]})}),r.jsx(Ik,{styles:ve,activePanel:e,setActivePanel:t}),r.jsx(Mk,{styles:ve,activePanel:e,setActivePanel:t}),r.jsx(Ht,{panelId:"points",activePanel:e,setActivePanel:t,icon:r.jsx(dr,{icon:y?k==="rgb"?r.jsx(E2,{className:"w-6 h-6"}):k==="error"?r.jsx(P2,{className:"w-6 h-6"}):r.jsx(L2,{className:"w-6 h-6"}):r.jsx(M2,{className:"w-6 h-6"}),label:y?k==="rgb"?"RGB":k==="error"?"ERR":"TRK":"OFF"}),tooltip:y?k==="rgb"?"Point Cloud: RGB (P)":k==="error"?"Point Cloud: Error (P)":"Point Cloud: Track (P)":"Point Cloud: Off (P)",isActive:y,onClick:si,panelTitle:"Point Cloud (P)",children:r.jsxs("div",{className:ve.panelContent,children:[r.jsx(Rn,{label:"Show Points",checked:y,onChange:v}),r.jsx(jt,{label:"Color",value:k,onChange:C=>j(C),options:[{value:"rgb",label:"RGB"},{value:"error",label:"Error"},{value:"trackLength",label:"Track Length"}]}),r.jsx(st,{label:"Size",value:w,min:1,max:10,step:.5,onChange:x}),r.jsx(st,{label:"Opacity",value:m,min:0,max:1,step:.05,onChange:S,formatValue:C=>`${Math.round(C*100)}%`}),r.jsx(st,{label:"Min Track",value:b,min:0,max:20,step:1,onChange:C=>M(Math.round(C))}),r.jsx(st,{label:"Max Error",value:E===1/0?Ke?.globalStats.maxError??10:E,min:0,max:Ke?.globalStats.maxError??10,step:.1,onChange:C=>P(C>=(Ke?.globalStats.maxError??10)?1/0:C),formatValue:C=>E===1/0?"âˆž":C.toFixed(1)}),r.jsx("div",{className:"text-ds-secondary text-sm mt-3",children:k==="rgb"?r.jsxs(r.Fragment,{children:[r.jsx("div",{className:"mb-1 font-medium",children:"RGB Colors:"}),r.jsx("div",{children:"Original point colors from"}),r.jsx("div",{children:"the reconstruction."})]}):k==="error"?r.jsxs(r.Fragment,{children:[r.jsx("div",{className:"mb-1 font-medium",children:"Reprojection Error:"}),r.jsx("div",{children:"Blue = low error (accurate)"}),r.jsx("div",{children:"Red = high error (outliers)"})]}):r.jsxs(r.Fragment,{children:[r.jsx("div",{className:"mb-1 font-medium",children:"Track Length:"}),r.jsx("div",{children:"Dark = few observations"}),r.jsx("div",{children:"Bright = many observations"})]})})]})}),r.jsx(Ht,{panelId:"scale",activePanel:e,setActivePanel:t,icon:r.jsx(dr,{icon:I?A==="frustum"?r.jsx(If,{className:"w-6 h-6"}):A==="arrow"?r.jsx(m2,{className:"w-6 h-6"}):r.jsx(g2,{className:"w-6 h-6"}):r.jsx(p2,{className:"w-6 h-6"}),label:I?A==="frustum"?"FRM":A==="arrow"?"ARW":"IMG":"OFF"}),tooltip:I?A==="frustum"?"Frustum mode (F)":A==="arrow"?"Arrow mode (F)":"Image plane mode (F)":"Cameras hidden (F)",isActive:I,onClick:ii,panelTitle:"Camera Display (F)",children:r.jsxs("div",{className:ve.panelContent,children:[r.jsx(Rn,{label:"Show Cameras",checked:I,onChange:R}),r.jsx(jt,{label:"Mode",value:A,onChange:C=>G(C),options:[{value:"frustum",label:"Frustum"},{value:"arrow",label:"Arrow"},{value:"imageplane",label:"Image Plane"}]}),I&&r.jsxs(r.Fragment,{children:[r.jsx(jt,{label:"Color",value:xe,onChange:C=>Ee(C),options:[{value:"single",label:"Single"},{value:"byCamera",label:"By Cam"},...Jn?[{value:"byRigFrame",label:"By Frame"}]:[]]}),r.jsx(jt,{label:"Scale Ã—",value:F,onChange:C=>z(C),options:[{value:"0.1",label:"0.1Ã—"},{value:"1",label:"1Ã—"},{value:"10",label:"10Ã—"}]}),r.jsx(st,{label:"Scale",value:Z,min:.05,max:1,step:.05,onChange:U,formatValue:C=>C.toFixed(2)}),r.jsx(st,{label:"Selection Î±",value:D,min:0,max:1,step:.05,onChange:T,formatValue:C=>C.toFixed(2)}),r.jsx(st,{label:"Unselected Î±",value:ke,min:0,max:1,step:.05,onChange:W,formatValue:C=>C.toFixed(2)}),r.jsxs("div",{className:ve.row,children:[r.jsx("label",{className:ve.label,children:"Undistort (U)"}),r.jsx("span",{className:"flex-1"}),r.jsx(Us,{checked:O,onChange:Ae})]})]}),r.jsx("div",{className:"text-ds-secondary text-sm mt-3",children:A==="frustum"?r.jsxs(r.Fragment,{children:[r.jsx("div",{className:"mb-1 font-medium",children:"Frustum:"}),r.jsx("div",{children:"Full camera frustum"}),r.jsx("div",{children:"pyramid wireframes."})]}):A==="arrow"?r.jsxs(r.Fragment,{children:[r.jsx("div",{className:"mb-1 font-medium",children:"Arrow:"}),r.jsx("div",{children:"Simple arrow showing"}),r.jsx("div",{children:"camera look direction."})]}):r.jsxs(r.Fragment,{children:[r.jsx("div",{className:"mb-1 font-medium",children:"Image Plane:"}),r.jsx("div",{children:"Shows image textures"}),r.jsx("div",{children:"on camera planes."})]})})]})}),I&&r.jsxs(r.Fragment,{children:[A!=="imageplane"&&r.jsx(Ht,{panelId:"matches",activePanel:e,setActivePanel:t,icon:De?ze==="on"?r.jsx(y2,{className:"w-6 h-6"}):r.jsx(v2,{className:"w-6 h-6"}):r.jsx(x2,{className:"w-6 h-6"}),tooltip:De?ze==="on"?"Matches on (M)":"Matches blink (M)":"Matches off (M)",isActive:De,onClick:ai,panelTitle:"Show Matches (M)",children:r.jsxs("div",{className:ve.panelContent,children:[r.jsx(Rn,{label:"Show Matches",checked:De,onChange:We}),De&&r.jsx(jt,{label:"Mode",value:ze,onChange:C=>rt(C),options:[{value:"on",label:"On"},{value:"blink",label:"Blink"}]}),De&&r.jsxs(r.Fragment,{children:[r.jsx(st,{label:"Opacity",value:Y,min:.5,max:1,step:.05,onChange:be,formatValue:C=>C.toFixed(2)}),r.jsx(Li,{label:"Color",value:he,onChange:Ie})]}),r.jsx("div",{className:"text-ds-secondary text-sm mt-3",children:De?ze==="on"?r.jsxs(r.Fragment,{children:[r.jsx("div",{className:"mb-1 font-medium",children:"On:"}),r.jsx("div",{children:"Show match lines between"}),r.jsx("div",{children:"selected camera and points."})]}):r.jsxs(r.Fragment,{children:[r.jsx("div",{className:"mb-1 font-medium",children:"Blink:"}),r.jsx("div",{children:"Match lines animate with"}),r.jsx("div",{children:"blinking effect."})]}):r.jsxs(r.Fragment,{children:[r.jsx("div",{className:"mb-1 font-medium",children:"Off:"}),r.jsx("div",{children:"Match lines hidden."})]})})]})}),r.jsx(Ht,{panelId:"selectionColor",activePanel:e,setActivePanel:t,icon:$?K==="static"?r.jsx(C2,{className:"w-6 h-6"}):K==="blink"?r.jsx(k2,{className:"w-6 h-6"}):r.jsx(w2,{className:"w-6 h-6"}):r.jsx(b2,{className:"w-6 h-6"}),tooltip:$?K==="static"?"Static color":K==="blink"?"Blink":"Rainbow":"Selection off",isActive:$,onClick:Sh,panelTitle:"Selection Highlight",children:r.jsxs("div",{className:ve.panelContent,children:[r.jsx(Rn,{label:"Show Highlight",checked:$,onChange:Q}),$&&r.jsxs(r.Fragment,{children:[r.jsx(jt,{label:"Mode",value:K,onChange:C=>re(C),options:[{value:"static",label:"Static"},{value:"blink",label:"Blink"},{value:"rainbow",label:"Rainbow"}]}),(K==="static"||K==="blink")&&r.jsx(Li,{label:"Color",value:J,onChange:L}),(K==="blink"||K==="rainbow")&&r.jsx(st,{label:"Speed",value:ee,min:.1,max:5,step:.1,onChange:ie,formatValue:C=>C.toFixed(1)})]}),r.jsx("div",{className:"text-ds-secondary text-sm mt-3",children:K==="static"?r.jsxs(r.Fragment,{children:[r.jsx("div",{className:"mb-1 font-medium",children:"Static:"}),r.jsx("div",{children:"Solid color highlight"}),r.jsx("div",{children:"for selected camera."})]}):K==="blink"?r.jsxs(r.Fragment,{children:[r.jsx("div",{className:"mb-1 font-medium",children:"Blink:"}),r.jsx("div",{children:"Selected camera pulses"}),r.jsx("div",{children:"to draw attention."})]}):r.jsxs(r.Fragment,{children:[r.jsx("div",{className:"mb-1 font-medium",children:"Rainbow:"}),r.jsx("div",{children:"Selected camera cycles"}),r.jsx("div",{children:"through all colors."})]})})]})})]}),r.jsx(Ht,{panelId:"rig",activePanel:e,setActivePanel:t,icon:r.jsx(dr,{icon:!_n||!Jn?r.jsx(D2,{className:"w-6 h-6"}):Mo==="blink"?r.jsx(z2,{className:"w-6 h-6"}):r.jsx(T2,{className:"w-6 h-6"}),label:Jn?_n?Mo==="blink"?"BLK":"RIG":"OFF":"N/A"}),tooltip:Jn?_n?Mo==="blink"?"Rig connections blink":"Show rig connections":"Rig connections off":"Rig not available",isActive:Jn&&_n,onClick:Jn?jh:void 0,panelTitle:"Rig Connections",disabled:!Jn,children:r.jsx("div",{className:ve.panelContent,children:Jn?r.jsxs(r.Fragment,{children:[r.jsx(Rn,{label:"Show Rig",checked:_n,onChange:Br}),_n&&r.jsx(jt,{label:"Mode",value:Mo,onChange:C=>Ur(C),options:[{value:"lines",label:"Lines"},{value:"blink",label:"Blink"}]}),_n&&r.jsxs(r.Fragment,{children:[r.jsx(jt,{label:"Color",value:Ka,onChange:C=>lh(C),options:[{value:"single",label:"Single"},{value:"perFrame",label:"Per Frame"}]}),Ka==="single"&&r.jsx(Li,{label:"Hue",value:ch,onChange:uh}),r.jsx(st,{label:"Opacity",value:dh,min:.1,max:1,step:.05,onChange:fh,formatValue:C=>C.toFixed(2)})]}),r.jsxs("div",{className:"text-ds-secondary text-sm mt-3",children:[r.jsx("div",{className:"mb-1 font-medium",children:"Detected Rig:"}),r.jsxs("div",{children:[Qa," camera",Qa!==1?"s":"",", ",Ja," frame",Ja!==1?"s":""]}),r.jsx("div",{className:"mt-2",children:_n?r.jsx("div",{children:"Lines connect cameras with"}):r.jsx("div",{children:"Connection lines hidden."})}),r.jsx("div",{children:"matching frame names"}),r.jsx("div",{children:"(e.g. cam_1/00.png, cam_2/00.png)"})]})]}):r.jsxs("div",{className:"text-ds-secondary text-sm",children:[r.jsx("div",{className:"mb-2 font-medium",children:"No Multi-Camera Data"}),r.jsx("div",{children:"To use this feature, images"}),r.jsx("div",{children:"need directory/filename format:"}),r.jsxs("div",{className:"mt-2 font-mono text-xs",children:[r.jsx("div",{children:"â€¢ cam_1/frame_00.png"}),r.jsx("div",{children:"â€¢ cam_2/frame_00.png"})]}),r.jsx("div",{className:"mt-2",children:"Images with same filename"}),r.jsx("div",{children:"are connected as a rig."})]})})}),r.jsx(Ht,{panelId:"screenshot",activePanel:e,setActivePanel:t,icon:r.jsx(Sf,{className:"w-6 h-6"}),tooltip:"Save screenshot",onClick:yt,panelTitle:"Screenshot",children:r.jsxs("div",{className:ve.panelContent,children:[r.jsx("div",{className:"text-ds-primary text-sm mb-1",children:"Static:"}),r.jsx(jt,{label:"Size",value:Ut,onChange:C=>tn(C),options:[{value:"current",label:"Current"},{value:"1280x720",label:"1280Ã—720"},{value:"1920x1080",label:"1920Ã—1080"},{value:"3840x2160",label:"3840Ã—2160"},{value:"512x512",label:"512Ã—512"},{value:"1024x1024",label:"1024Ã—1024"},{value:"2048x2048",label:"2048Ã—2048"}]}),r.jsx(jt,{label:"Format",value:N,onChange:C=>ae(C),options:[{value:"jpeg",label:"JPEG"},{value:"png",label:"PNG"},{value:"webp",label:"WebP"}]}),r.jsxs("div",{className:"flex gap-2 mt-2",children:[r.jsx("button",{onClick:yt,className:ve.actionButton,style:{flex:1},children:"Save"}),r.jsx("button",{onClick:rr,className:ve.actionButton,style:{flex:1},children:"Copy"})]}),r.jsx("div",{className:"text-ds-primary text-sm mt-3 mb-1",children:"Dynamic:"}),r.jsx(jt,{label:"Format",value:Js,onChange:C=>Jf(C),options:[{value:"gif",label:"GIF"},{value:"webm",label:"WebM"},{value:"mp4",label:"MP4"}]}),r.jsx(jt,{label:"Quality",value:eh,onChange:C=>th(C),options:[{value:"low",label:"Low"},{value:"medium",label:"Medium"},{value:"high",label:"High"},{value:"ultra",label:"Ultra"}]}),r.jsx(st,{label:"Duration",value:yn,min:5,max:120,step:5,onChange:nr,formatValue:C=>`${C}s`}),r.jsx(jt,{label:"Scale",value:String(zr),onChange:C=>Or(Number(C)),options:[{value:"1",label:"1Ã— (Full)"},{value:"2",label:"Â½"},{value:"4",label:"Â¼"},{value:"8",label:"â…›"}]}),r.jsx(jt,{label:"Speed",value:String(nh),onChange:C=>oh(Number(C)),options:[{value:"1",label:"1Ã—"},{value:"2",label:"2Ã—"},{value:"3",label:"3Ã—"},{value:"4",label:"4Ã—"}]}),r.jsx("button",{onClick:xh,disabled:Yt||!Rt||p!==null,className:Yt||p!==null?ve.actionButtonPrimary:ve.actionButton,style:{width:"100%",marginTop:"8px"},children:p!==null?`Countdown (${p})`:Yt?"Recording...":"Record"}),Pn&&!Yt&&p===null&&r.jsx("button",{onClick:or,className:ve.actionButton,style:{width:"100%",marginTop:"8px"},children:"Save"}),r.jsxs("div",{onClick:()=>Fe(!oe),className:`group text-sm mt-3 cursor-pointer ${oe?"text-blue-400":""}`,children:[r.jsx("div",{className:"mb-1 font-medium",children:oe?"âœ“ Watermark Removed!":r.jsx("span",{className:"underline",children:"Remove watermark:"})}),r.jsx("div",{className:oe?"":"text-ds-secondary group-hover:text-gray-300 transition-colors",children:"By removing watermark, I agree"}),r.jsx("div",{className:oe?"":"text-ds-secondary group-hover:text-gray-300 transition-colors",children:"to provide proper attribution to"}),r.jsx("div",{className:oe?"":"text-ds-secondary group-hover:text-gray-300 transition-colors",children:'"ColmapView by OpsiClear"'}),r.jsx("div",{className:oe?"":"text-ds-secondary group-hover:text-gray-300 transition-colors",children:"when sharing the image."})]})]})}),r.jsx(Ht,{panelId:"share",activePanel:e,setActivePanel:t,icon:r.jsx(c2,{className:"w-6 h-6"}),tooltip:"Share",panelTitle:"Share",children:r.jsxs("div",{className:ve.panelContent,children:[ti&&r.jsxs(r.Fragment,{children:[r.jsx("div",{className:"text-ds-primary text-sm mb-1",children:"Links:"}),r.jsxs("div",{className:"flex flex-col gap-2",children:[r.jsx("button",{onClick:mh,className:n?ve.actionButtonPrimary:ve.actionButton,children:n?r.jsxs(r.Fragment,{children:[r.jsx(yo,{className:"w-4 h-4 inline mr-1"}),"Copied!"]}):"Copy Link"}),r.jsx("button",{onClick:ph,className:s?ve.actionButtonPrimary:ve.actionButton,children:s?r.jsxs(r.Fragment,{children:[r.jsx(yo,{className:"w-4 h-4 inline mr-1"}),"Copied!"]}):"Embed URL"}),r.jsx("button",{onClick:gh,className:i?ve.actionButtonPrimary:ve.actionButton,children:i?r.jsxs(r.Fragment,{children:[r.jsx(yo,{className:"w-4 h-4 inline mr-1"}),"Copied!"]}):"Embed HTML"})]})]}),r.jsx("div",{className:`text-ds-primary text-sm mb-1 ${ti?"mt-3":""}`,children:"Social Media:"}),ti&&r.jsx(Rn,{label:"Include Link",checked:c,onChange:d}),r.jsx(Rn,{label:"Screen to Clipboard",checked:u,onChange:f}),r.jsxs("div",{className:"flex gap-2 mt-2",children:[r.jsx("button",{onClick:yh,className:ve.actionButton,style:{flex:1,padding:"8px"},"data-tooltip":"Share to X","data-tooltip-pos":"bottom",children:r.jsx("svg",{viewBox:"0 0 24 24",className:"w-5 h-5 mx-auto",fill:"currentColor",children:r.jsx("path",{d:"M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"})})}),r.jsx("button",{onClick:vh,className:ve.actionButton,style:{flex:1,padding:"8px"},"data-tooltip":"Share to LinkedIn","data-tooltip-pos":"bottom",children:r.jsx("svg",{viewBox:"0 0 24 24",className:"w-5 h-5 mx-auto",fill:"currentColor",children:r.jsx("path",{d:"M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"})})})]})]})}),r.jsx(Ht,{panelId:"export",activePanel:e,setActivePanel:t,icon:r.jsx(h2,{className:"w-6 h-6"}),tooltip:"Export",onClick:wh,panelTitle:"Export",disabled:!Ke,children:r.jsxs("div",{className:ve.panelContent,children:[r.jsxs("div",{className:"flex flex-col gap-2",children:[r.jsx("button",{onClick:()=>{$r("binary"),Ke&&xl(Ke,Qn)},disabled:!Ke,className:Ke?ve.actionButton:ve.actionButtonDisabled,children:"Binary (.bin)"}),r.jsx("button",{onClick:()=>{$r("text"),Ke&&gl(Ke,Qn)},disabled:!Ke,className:Ke?ve.actionButton:ve.actionButtonDisabled,children:"Text (.txt)"}),r.jsx("button",{onClick:()=>{$r("ply"),Ke&&yl(Ke,Qn)},disabled:!Ke,className:Ke?ve.actionButton:ve.actionButtonDisabled,children:"Points (.ply)"}),r.jsx("button",{onClick:()=>{$r("config");const C=Mc(),nt=Ic(C),At=new Blob([nt],{type:"text/yaml"}),vt=URL.createObjectURL(At),ht=document.createElement("a");ht.href=vt,ht.download="colmapview-config.yml",document.body.appendChild(ht),ht.click(),document.body.removeChild(ht),URL.revokeObjectURL(vt)},className:ve.actionButton,children:"Config (.yml)"}),r.jsx("button",{onClick:async()=>{if(Ke)try{await Om(Ke,{format:"binary"},rh?.imageFiles,Qn)}catch(C){console.error("ZIP export failed:",C)}},disabled:!Ke,className:Ke?ve.actionButton:ve.actionButtonDisabled,children:"ZIP (.zip)"})]}),r.jsx("div",{className:"flex justify-center mt-2",children:r.jsx("button",{onClick:Sr,disabled:!Xa,className:Xa?ve.actionButtonPrimary:ve.actionButtonPrimaryDisabled,children:"Apply Transform"})})]})}),r.jsx(Ht,{panelId:"settings",activePanel:e,setActivePanel:t,icon:r.jsx(kf,{className:"w-6 h-6"}),tooltip:"Settings",panelTitle:"Settings",children:r.jsxs("div",{className:ve.panelContent,children:[r.jsx("div",{className:ve.actionGroup,children:r.jsx("button",{onClick:()=>{Bt(),t(null)},className:ve.actionButton,children:"Edit Context Menu"})}),r.jsx("div",{className:ve.actionGroup,children:r.jsx("button",{onClick:()=>{confirm("Clear all settings and reload? This cannot be undone.")&&(localStorage.clear(),qm(),window.location.reload())},className:ve.actionButton,children:"Clear Settings"})}),r.jsx("div",{className:ve.actionGroup,children:r.jsx("button",{onClick:()=>{const nt=JSON.stringify({version:1,name:"NGS Lady Bug Toy",baseUrl:"https://huggingface.co/datasets/OpsiClear/NGS/resolve/main/objects/scan_20250714_170841_lady_bug_toy",files:{cameras:"sparse/0/cameras.bin",images:"sparse/0/images.bin",points3D:"sparse/0/points3D.bin",rigs:"sparse/0/rigs.bin",frames:"sparse/0/frames.bin"},imagesPath:"images/",masksPath:"masks/"},null,2),At=new Blob([nt],{type:"application/json"}),vt=URL.createObjectURL(At),ht=document.createElement("a");ht.href=vt,ht.download="manifest.json",document.body.appendChild(ht),ht.click(),document.body.removeChild(ht),URL.revokeObjectURL(vt)},className:ve.actionButton,children:"Example Manifest"})}),r.jsxs("div",{className:"text-ds-secondary text-sm mt-3",children:[r.jsx("div",{className:"mb-1 font-medium",children:"Manifest Format:"}),r.jsx("div",{children:"JSON file for loading COLMAP"}),r.jsx("div",{children:"reconstructions from URLs."})]})]})}),r.jsx(Ek,{activePanel:e,setActivePanel:t})]})}const Qs={colmap:{x:[1,0,0],y:[0,1,0],z:[0,0,1]},opencv:{x:[1,0,0],y:[0,1,0],z:[0,0,1]},threejs:{x:[1,0,0],y:[0,1,0],z:[0,0,1]},opengl:{x:[1,0,0],y:[0,1,0],z:[0,0,1]},vulkan:{x:[1,0,0],y:[0,1,0],z:[0,0,1]},blender:{x:[1,0,0],y:[0,0,-1],z:[0,1,0]},houdini:{x:[1,0,0],y:[0,1,0],z:[0,0,1]},unity:{x:[1,0,0],y:[0,1,0],z:[0,0,-1]},unreal:{x:[0,0,-1],y:[1,0,0],z:[0,1,0]}};function Lk(e){const t=Qs[e];return e==="blender"||e==="unreal"?t.z:t.y}const Yf={colmap:{X:"Right",Y:"Down",Z:"Fwd"},opencv:{X:"Right",Y:"Down",Z:"Fwd"},threejs:{X:"Right",Y:"Up",Z:"Back"},opengl:{X:"Right",Y:"Up",Z:"Back"},vulkan:{X:"Right",Y:"Up",Z:"Fwd"},blender:{X:"Right",Y:"Fwd",Z:"Up"},houdini:{X:"Right",Y:"Up",Z:"Fwd"},unity:{X:"Right",Y:"Up",Z:"Fwd"},unreal:{X:"Fwd",Y:"Right",Z:"Up"}};function _k(e){return 1-Math.pow(1-e,3)}const Jc={x:{offset:new V(1,0,0),up:new V(0,1,0)},y:{offset:new V(0,1,0),up:new V(0,0,-1)},z:{offset:new V(0,0,1),up:new V(0,1,0)},"-x":{offset:new V(-1,0,0),up:new V(0,1,0)},"-y":{offset:new V(0,-1,0),up:new V(0,0,1)},"-z":{offset:new V(0,0,-1),up:new V(0,1,0)}};function Ak({target:e,radius:t,resetTrigger:n,viewDirection:o,viewTrigger:s=0}){const{camera:a,gl:i,set:l,size:c}=In(),d=ye(Y=>Y.reconstruction),u=B(Y=>Y.flyToImageId),f=B(Y=>Y.clearFlyTo),p=B(Y=>Y.setCurrentViewState),g=B(Y=>Y.clearNavigationHistory),y=B(Y=>Y.cameraMode),v=B(Y=>Y.cameraProjection),w=B(Y=>Y.cameraFov),x=B(Y=>Y.horizonLock),m=B(Y=>Y.flySpeed),S=B(Y=>Y.flyTransitionDuration),k=B(Y=>Y.pointerLock),j=Ve(Y=>Y.pickingMode),b=B(Y=>Y.autoRotateMode),M=B(Y=>Y.autoRotateSpeed),E=B(Y=>Y.setAutoRotateMode),P=Lt(Y=>Y.transform),I=q(Y=>Y.axesCoordinateSystem),R=B(Y=>Y.setCameraScale),A=Qe(Y=>Y.setPointSize),G=h.useMemo(()=>{const Y=Lk(I),be=new V(...Y);return x==="flip"&&be.negate(),be},[I,x]),F=h.useRef(!1),z=h.useRef(!1),Z=h.useRef(!1),U=h.useRef(new V(...e)),D=h.useRef(new ut),T=h.useRef(5),$=h.useRef(5),Q=h.useRef(n),K=h.useRef(s),re=h.useRef(v),J=h.useRef(1),L=h.useRef({x:0,y:0}),ee=h.useRef({x:0,y:0}),ie=h.useRef({x:0,y:0}),te=h.useRef(0),de=h.useRef(0),fe=h.useRef(new ut),we=h.useRef(new ut),pe=h.useRef(new Set),ge=h.useRef(new V),Re=h.useRef(!1),Le=h.useRef(null),xe=h.useRef(x);xe.current=x;const Ee=h.useRef(G);Ee.current=G;const ke=h.useRef(!0),W=h.useRef(!1),me=nn.rotateSpeed,H=nn.panSpeed,ne=nn.zoomSpeed,le=nn.damping,_e=nn.minVelocity,qe=nn.flyDamping,et=(Y,be)=>{if(!(Math.abs(Y)<1e-10&&Math.abs(be)<1e-10))if(xe.current!=="off"){const he=Ee.current.clone(),Ie=new V(1,0,0).applyQuaternion(D.current),ce=new V(0,0,-1).applyQuaternion(D.current).dot(he),Ze=Math.asin(Math.max(-1,Math.min(1,-ce))),Je=Math.PI/2-.02,Mt=Ze+be,kt=Mt>Je?Je-Ze:Mt<-Je?-Je-Ze:be;we.current.setFromAxisAngle(he,-Y),fe.current.setFromAxisAngle(Ie,-kt),D.current.premultiply(fe.current),D.current.premultiply(we.current),D.current.normalize()}else{const he=new V(1,0,0).applyQuaternion(D.current),Ie=new V(0,1,0).applyQuaternion(D.current);we.current.setFromAxisAngle(Ie,-Y),fe.current.setFromAxisAngle(he,-be),D.current.premultiply(fe.current),D.current.premultiply(we.current),D.current.normalize()}},Ue=()=>{if(y==="orbit"){const Y=new V(0,0,T.current);Y.applyQuaternion(D.current),a.position.copy(U.current).add(Y),a.quaternion.copy(D.current)}else a.quaternion.copy(D.current)},Jt=Y=>{const be=pe.current.has("shift")?nn.shiftSpeedBoost:1,he=t*nn.moveSpeedMultiplier*m*be,Ie=new V,Oe=new V(0,0,-1).applyQuaternion(D.current),ce=new V(1,0,0).applyQuaternion(D.current),Ze=Ee.current.clone();return pe.current.has("w")&&Ie.add(Oe.clone().multiplyScalar(he)),pe.current.has("s")&&Ie.add(Oe.clone().multiplyScalar(-he)),pe.current.has("a")&&Ie.add(ce.clone().multiplyScalar(-he)),pe.current.has("d")&&Ie.add(ce.clone().multiplyScalar(he)),(pe.current.has("e")||pe.current.has(" "))&&Ie.add(Ze.clone().multiplyScalar(he)),pe.current.has("q")&&Ie.add(Ze.clone().multiplyScalar(-he)),ge.current.add(Ie),ge.current.multiplyScalar(Y??qe),ge.current.length()>1e-4?(y==="fly"?a.position.add(ge.current):U.current.add(ge.current),!0):!1};En(()=>{if(!ke.current){L.current.x=0,L.current.y=0,ge.current.set(0,0,0),Le.current=null;return}if(Le.current){const ce=Le.current,Je=performance.now()-ce.startTime,Mt=Math.min(Je/ce.duration,1),kt=_k(Mt);a.position.lerpVectors(ce.startPosition,ce.endPosition,kt),a.quaternion.slerpQuaternions(ce.startQuaternion,ce.endQuaternion,kt),U.current.lerpVectors(ce.startTarget,ce.endTarget,kt),T.current=ce.startDistance+(ce.endDistance-ce.startDistance)*kt,$.current=T.current,D.current.copy(a.quaternion),Mt>=1&&(Le.current=null);return}let Y=!1;const be=performance.now(),he=Math.min(be-de.current,100);de.current=be;const Ie=Math.pow(le,he/ln.frameTimeMs),Oe=Math.pow(qe,he/ln.frameTimeMs);if(y==="orbit"){if(Math.abs($.current-T.current)>1e-4&&(T.current+=($.current-T.current)*ln.zoomTransitionFactor,Y=!0),!F.current){const Ze=L.current.x,Je=L.current.y;if(Math.abs(Ze)>_e||Math.abs(Je)>_e)et(Ze,Je),Y=!0,L.current.x*=Ie,L.current.y*=Ie;else if(b!=="off"){const kt=(b==="cw"?1:-1)*M*(he/1e3);we.current.setFromAxisAngle(Ee.current,kt),D.current.premultiply(we.current),D.current.normalize(),Y=!0}}Jt(Oe)&&(Y=!0),Y&&Ue()}else{let ce=!1;if(!F.current){const Ze=L.current.x,Je=L.current.y;(Math.abs(Ze)>_e||Math.abs(Je)>_e)&&(et(Ze,Je),ce=!0,L.current.x*=Ie,L.current.y*=Ie)}Jt(Oe),ce&&a.quaternion.copy(D.current)}}),h.useEffect(()=>{U.current.set(...e);const Y=n!==Q.current;if(Q.current=n,Y||T.current===5){T.current=Math.max(nn.minDistance,t*ln.initialDistanceMultiplier),$.current=T.current;const be=Math.SQRT1_2;let he,Ie;if(xe.current!=="off"){const Ze=Ee.current.clone();he=new V(-.5,-be*Ze.y,-.5).normalize().multiplyScalar(T.current),Ie=Ze}else he=new V(-.5,-be,-.5).normalize().multiplyScalar(T.current),Ie=new V(.5,-be,.5).normalize();const Oe=U.current.clone().add(he),ce=new go;ce.lookAt(Oe,U.current,Ie),D.current.setFromRotationMatrix(ce),a.position.copy(Oe),a.quaternion.copy(D.current),L.current.x=0,L.current.y=0,ge.current.set(0,0,0)}},[e[0],e[1],e[2],t,n,a]),h.useEffect(()=>{const Y=s!==K.current;if(K.current=s,!Y||!o)return;U.current.set(...e),T.current=Math.max(nn.minDistance,t*ln.initialDistanceMultiplier),$.current=T.current;let be,he;if(o!=="reset"&&Jc[o]){const ce=Jc[o];if(xe.current!=="off"){const Ze=Ee.current.clone();o==="y"?(be=Ze.clone().multiplyScalar(T.current),he=new V(0,0,-1)):(be=ce.offset.clone().multiplyScalar(T.current),he=Ze.clone())}else be=ce.offset.clone().multiplyScalar(T.current),he=ce.up.clone()}else{const ce=Math.SQRT1_2;if(xe.current!=="off"){const Ze=Ee.current.clone();be=new V(-.5,-ce*Ze.y,-.5).normalize().multiplyScalar(T.current),he=Ze.clone()}else be=new V(-.5,-ce,-.5).normalize().multiplyScalar(T.current),he=new V(.5,-ce,.5).normalize()}const Ie=U.current.clone().add(be),Oe=new go;Oe.lookAt(Ie,U.current,he),D.current.setFromRotationMatrix(Oe),a.position.copy(Ie),a.quaternion.copy(D.current),L.current.x=0,L.current.y=0,ge.current.set(0,0,0)},[e[0],e[1],e[2],t,s,o,a]),h.useEffect(()=>{if(v===re.current)return;re.current=v;const Y=c.width/c.height,be=a.position.clone(),he=a.quaternion.clone();if(v==="orthographic"){const Ie=T.current;J.current=1;const Oe=ln.farPlane*10,ce=new ul(-Ie*Y,Ie*Y,Ie,-Ie,-Oe,Oe);ce.position.copy(be),ce.quaternion.copy(he),l({camera:ce})}else{const Ie=new dl(w,Y,ln.nearPlane,ln.farPlane);Ie.position.copy(be),Ie.quaternion.copy(he),l({camera:Ie})}D.current.copy(he)},[v,a,l,c.width,c.height]),h.useEffect(()=>{a instanceof dl&&(a.fov=w,a.updateProjectionMatrix())},[w,a]);const en=h.useRef(x);h.useEffect(()=>{const Y=en.current!==x;if(en.current=x,!Y)return;T.current=Math.max(nn.minDistance,t*ln.initialDistanceMultiplier),$.current=T.current;const be=Math.SQRT1_2;let he,Ie;if(x!=="off"){const Ze=G.clone();he=new V(-.5,-be*Ze.y,-.5).normalize().multiplyScalar(T.current),Ie=Ze}else he=new V(-.5,-be,-.5).normalize().multiplyScalar(T.current),Ie=new V(.5,-be,.5).normalize();const Oe=U.current.clone().add(he),ce=new go;ce.lookAt(Oe,U.current,Ie),D.current.setFromRotationMatrix(ce),a.position.copy(Oe),a.quaternion.copy(D.current),L.current.x=0,L.current.y=0,ge.current.set(0,0,0)},[x,a,G,t]),h.useEffect(()=>{if(u===null||!d)return;const Y=d.images.get(u);if(!Y){f();return}const{position:be,quaternion:he}=Xm(Y),Ie=zn(P),Oe=be.clone().applyQuaternion(Ie.rotation).multiplyScalar(Ie.scale).add(Ie.translation),ce=Ie.rotation.clone().multiply(he),Ze=new ut().setFromAxisAngle(new V(1,0,0),Math.PI);let Je=ce.clone().multiply(Ze);if(x!=="off"){const Ne=new V(0,0,-1).applyQuaternion(Je),Xe=Oe.clone().add(Ne),St=new go;St.lookAt(Oe,Xe,G),Je=new ut().setFromRotationMatrix(St)}const Mt=new V(0,0,-1).applyQuaternion(Je),kt=Oe.clone().add(Mt.multiplyScalar(T.current));L.current.x=0,L.current.y=0,ge.current.set(0,0,0),S>0?Le.current={startPosition:a.position.clone(),startQuaternion:a.quaternion.clone(),startTarget:U.current.clone(),startDistance:T.current,endPosition:Oe.clone(),endQuaternion:Je.clone(),endTarget:kt.clone(),endDistance:T.current,startTime:performance.now(),duration:S}:(U.current.copy(kt),D.current.copy(Je),$.current=T.current,a.position.copy(Oe),a.quaternion.copy(Je)),f()},[u,d,f,a,P,x,G,S]);const O=B(Y=>Y.flyToViewState),Ae=B(Y=>Y.clearFlyToViewState);h.useEffect(()=>{if(O){if(L.current.x=0,L.current.y=0,ge.current.set(0,0,0),S>0){const Y=new V(...O.target),be=new V(...O.position),he=new ut(...O.quaternion);Le.current={startPosition:a.position.clone(),startQuaternion:a.quaternion.clone(),startTarget:U.current.clone(),startDistance:T.current,endPosition:be,endQuaternion:he,endTarget:Y,endDistance:O.distance,startTime:performance.now(),duration:S}}else U.current.set(...O.target),D.current.set(...O.quaternion),T.current=O.distance,$.current=O.distance,a.position.set(...O.position),a.quaternion.set(...O.quaternion);Ae()}},[O,Ae,a,S]),h.useEffect(()=>{if(y==="fly")D.current.copy(a.quaternion),ge.current.set(0,0,0),pe.current.clear();else{const Y=new V(0,0,-1).applyQuaternion(a.quaternion);T.current=Math.max(nn.minDistance,T.current),$.current=T.current,U.current.copy(a.position).add(Y.multiplyScalar(T.current)),D.current.copy(a.quaternion)}L.current.x=0,L.current.y=0},[y,a]);const De=()=>({position:[a.position.x,a.position.y,a.position.z],quaternion:[D.current.x,D.current.y,D.current.z,D.current.w],target:[U.current.x,U.current.y,U.current.z],distance:T.current});h.useEffect(()=>(l({controls:{enabled:ke,dragging:W,wheelHandled:Re,getCurrentViewState:De}}),()=>l({controls:void 0})),[l,a]);const We=h.useRef(!1);h.useEffect(()=>{if(We.current||!d)return;const Y=window.location.hash;Y&&xk(Y).then(be=>{!be||We.current||(We.current=!0,U.current.set(...be.target),D.current.set(...be.quaternion),T.current=be.distance,$.current=be.distance,a.position.set(...be.position),a.quaternion.set(...be.quaternion),console.log("[URL State] Restored camera state from URL hash"))})},[d,a]);const ze=h.useRef(null),rt=h.useRef("");return h.useEffect(()=>{const Y=()=>{const he=De(),Ie=`${he.position.join(",")},${he.target.join(",")},${he.quaternion.join(",")}`;Ie!==rt.current&&(rt.current=Ie,p(he))};Y();const be=setInterval(Y,500);return()=>{clearInterval(be),ze.current&&clearTimeout(ze.current)}},[a,p]),h.useEffect(()=>{const Y=i.domElement,be=Ne=>{const Xe=Ne.button;ie.current={x:Ne.clientX,y:Ne.clientY},te.current=performance.now(),Promise.resolve().then(()=>{ke.current&&(Le.current=null,y==="fly"?Xe===0&&(F.current=!0,W.current=!0,L.current.x=0,L.current.y=0,ee.current.x=0,ee.current.y=0,Z.current=!1,b!=="off"&&E("off")):Xe===0?(F.current=!0,W.current=!0,L.current.x=0,L.current.y=0,ee.current.x=0,ee.current.y=0,b!=="off"&&E("off"),Z.current=!1):(Xe===2||Xe===1)&&(z.current=!0,W.current=!0))})},he=()=>{if(!F.current&&!z.current)return;if(W.current=!1,!ke.current){L.current.x=0,L.current.y=0,F.current=!1,z.current=!1,Z.current=!1;return}performance.now()-te.current>50?(L.current.x=0,L.current.y=0):(et(L.current.x,L.current.y),Ue()),F.current=!1,z.current=!1,Z.current=!1,document.pointerLockElement===Y&&document.exitPointerLock()},Ie=()=>{document.pointerLockElement!==Y&&F.current&&(L.current.x=0,L.current.y=0,ee.current.x=0,ee.current.y=0,F.current=!1,z.current=!1,W.current=!1,Z.current=!1)},Oe=Ne=>{if(!ke.current){(F.current||z.current)&&(L.current.x=0,L.current.y=0,F.current=!1,z.current=!1,W.current=!1);return}const Xe=performance.now(),St=document.pointerLockElement===Y,_=St?Ne.movementX:Ne.clientX-ie.current.x,Be=St?Ne.movementY:Ne.clientY-ie.current.y;if(ie.current={x:Ne.clientX,y:Ne.clientY},te.current=Xe,F.current){(_!==0||Be!==0)&&g(),k&&j==="off"&&!Z.current&&!St&&(Z.current=!0,Y.requestPointerLock());const Te=50,dt=Math.max(-Te,Math.min(Te,_)),ft=Math.max(-Te,Math.min(Te,Be)),Ye=dt*me,$t=ft*me;et(Ye,$t),Ue();const Pe=ln.velocitySmoothingFactor;ee.current.x=ee.current.x*Pe+Ye*(1-Pe),ee.current.y=ee.current.y*Pe+$t*(1-Pe),L.current.x=ee.current.x,L.current.y=ee.current.y}if(z.current&&y==="orbit"){(_!==0||Be!==0)&&g();const Te=new V(1,0,0).applyQuaternion(D.current),dt=new V(0,1,0).applyQuaternion(D.current),ft=T.current*H,Ye=new V().addScaledVector(Te,-_*ft).addScaledVector(dt,Be*ft);U.current.add(Ye),Ue()}},ce=Ne=>{if(Ne.defaultPrevented||Re.current){Re.current=!1;return}if(Ne.preventDefault(),!!ke.current){if(Ne.altKey){const Xe=B.getState().cameraScale,St=Ne.deltaY>0?.9:1.1,_=Math.max(.01,Math.min(10,Xe*St));R(_);return}if(Ne.ctrlKey){const Xe=Qe.getState().pointSize,St=Ne.deltaY>0?.9:1.1,_=Math.max(.1,Math.min(50,Xe*St));A(_);return}if(g(),Le.current=null,y==="fly"){const Xe=new V(0,0,-1).applyQuaternion(D.current),St=-Ne.deltaY*t*nn.wheelMoveMultiplier*m;a.position.add(Xe.multiplyScalar(St))}else if(a instanceof ul){const Xe=1+Ne.deltaY*ne;J.current=Math.max(.1,Math.min(10,J.current/Xe)),a.zoom=J.current,a.updateProjectionMatrix()}else{const Xe=1+Ne.deltaY*ne;$.current=Math.max(nn.minDistance,$.current*Xe)}}},Ze=Ne=>{Ne.preventDefault()},Je=Ne=>{if(!ke.current||Ne.ctrlKey||Ne.metaKey)return;const Xe=Ne.key.toLowerCase();["w","a","s","d","q","e"," ","shift","arrowup","arrowdown","arrowleft","arrowright"].includes(Xe)&&Ne.target?.tagName!=="INPUT"&&Ne.target?.tagName!=="TEXTAREA"&&(Ne.preventDefault(),pe.current.add(Xe),Xe!=="shift"&&(g(),Le.current=null))},Mt=Ne=>{const Xe=Ne.key.toLowerCase();pe.current.delete(Xe)},kt=()=>{pe.current.clear()};return Y.addEventListener("pointerdown",be),document.addEventListener("pointerup",he),document.addEventListener("pointermove",Oe),Y.addEventListener("wheel",ce,{passive:!1}),Y.addEventListener("contextmenu",Ze),document.addEventListener("pointerlockchange",Ie),window.addEventListener("keydown",Je),window.addEventListener("keyup",Mt),window.addEventListener("blur",kt),()=>{Y.removeEventListener("pointerdown",be),document.removeEventListener("pointerup",he),document.removeEventListener("pointermove",Oe),Y.removeEventListener("wheel",ce),Y.removeEventListener("contextmenu",Ze),document.removeEventListener("pointerlockchange",Ie),window.removeEventListener("keydown",Je),window.removeEventListener("keyup",Mt),window.removeEventListener("blur",kt)}},[a,i,y,m,k,j,t,b,E,g,R,A]),null}function eu(e){const t=new V(...e).normalize(),n=new V(0,1,0);if(Math.abs(t.y)>.999)return new pn(0,0,t.y>0?0:Math.PI);const o=new ut;return o.setFromUnitVectors(n,t),new pn().setFromQuaternion(o)}function tu(e,t){return[e[0]*t/2,e[1]*t/2,e[2]*t/2]}const Nk=6710886,ha={colmap:"COLMAP",opencv:"OpenCV",threejs:"Three.js",opengl:"OpenGL",vulkan:"Vulkan",blender:"Blender",houdini:"Houdini",unity:"Unity",unreal:"Unreal"},Rk=["colmap","opencv","threejs","opengl","vulkan","blender","houdini","unity","unreal"],Fk=[{value:"off",label:"Off"},{value:"xyz",label:"XYZ"},{value:"extra",label:"Extra"}],qf="w-4 h-4 text-ds-accent",Tk=h.memo(function({position:t,currentLabelMode:n,onClose:o}){const s=h.useRef(null),a=q(d=>d.setAxisLabelMode),i=q(d=>d.setShowAxes);h.useEffect(()=>{const d=p=>{s.current&&!s.current.contains(p.target)&&o()},u=p=>{p.key==="Escape"&&o()},f=setTimeout(()=>{document.addEventListener("mousedown",d),document.addEventListener("keydown",u)},0);return()=>{clearTimeout(f),document.removeEventListener("mousedown",d),document.removeEventListener("keydown",u)}},[o]);const l=h.useCallback(d=>{a(d),o()},[a,o]),c=h.useCallback(()=>{i(!1),o()},[i,o]);return r.jsx(gn,{style:{position:"fixed",left:t.x,top:t.y,pointerEvents:"auto"},calculatePosition:()=>[0,0],children:r.jsxs("div",{ref:s,className:at.container,children:[Fk.map(d=>r.jsxs("button",{className:at.button,onClick:()=>l(d.value),children:[n===d.value?r.jsx(yo,{className:qf}):r.jsx("span",{className:"w-4"}),d.label]},d.value)),r.jsx("div",{className:"border-t border-ds my-1"}),r.jsxs("button",{className:at.button,onClick:c,children:[r.jsx(K1,{className:at.icon}),"Hide"]})]})})}),Dk=h.memo(function({position:t,currentSystem:n,onClose:o}){const s=h.useRef(null),a=q(l=>l.setAxesCoordinateSystem);h.useEffect(()=>{const l=u=>{s.current&&!s.current.contains(u.target)&&o()},c=u=>{u.key==="Escape"&&o()},d=setTimeout(()=>{document.addEventListener("mousedown",l),document.addEventListener("keydown",c)},0);return()=>{clearTimeout(d),document.removeEventListener("mousedown",l),document.removeEventListener("keydown",c)}},[o]);const i=h.useCallback(l=>{a(l),o()},[a,o]);return r.jsx(gn,{style:{position:"fixed",left:t.x,top:t.y,pointerEvents:"auto"},calculatePosition:()=>[0,0],children:r.jsx("div",{ref:s,className:at.container,children:Rk.map(l=>r.jsxs("button",{className:at.button,onClick:()=>i(l),children:[n===l?r.jsx(yo,{className:qf}):r.jsx("span",{className:"w-4"}),ha[l]]},l))})})}),Xf=16776960,nu=h.memo(function({position:t,rotation:n,radius:o,length:s,color:a,isHovered:i,onPointerOver:l,onPointerMove:c,onPointerOut:d,onClick:u,onContextMenu:f}){const p=i?1.5:1;return r.jsxs("mesh",{position:t,rotation:n,scale:[p,1,p],onPointerOver:l,onPointerMove:c,onPointerOut:d,onClick:u,onContextMenu:f,children:[r.jsx("cylinderGeometry",{args:[o,o,s,8]}),r.jsx("meshBasicMaterial",{color:i?Xf:a})]})}),zk=h.memo(function({position:t,label:n,suffix:o,scaleStr:s,showExtra:a,isXAxis:i,color:l,fontSize:c,isHovered:d,onPointerOver:u,onPointerMove:f,onPointerOut:p,onClick:g,onContextMenu:y}){const v=a&&o,w=d?Xf:l,x=d?1.2:1;return r.jsx(xu,{position:t,follow:!0,children:r.jsxs("group",{scale:[x,x,x],onPointerOver:u,onPointerMove:f,onPointerOut:p,onClick:g,onContextMenu:y,children:[r.jsx(yr,{fontSize:c,color:w,anchorX:i&&a||v?"right":"center",anchorY:"middle",outlineWidth:c*.08,outlineColor:"#000000",outlineOpacity:.5,children:n}),i&&a&&r.jsxs(yr,{fontSize:c*.6,color:w,anchorX:"left",anchorY:"middle",position:[c*.15,0,0],outlineWidth:c*.05,outlineColor:"#000000",outlineOpacity:.5,children:["(",s,")"]}),v&&r.jsxs(yr,{fontSize:c*.6,color:w,anchorX:"left",anchorY:"middle",position:[c*.15,0,0],outlineWidth:c*.05,outlineColor:"#000000",outlineOpacity:.5,children:["(",o,")"]})]})})});function Ok({size:e,scale:t=1,coordinateSystem:n="colmap",labelMode:o="extra"}){const s=e*.5,a=e*.005,i=s*.4,l=Qs[n],{controls:c}=In(),d=()=>c?.dragging?.current??!1,[u,f]=h.useState(null),[p,g]=h.useState(null),[y,v]=h.useState(null),[w,x]=h.useState(null),m=h.useCallback(Z=>U=>{d()||(f(Z),g({x:U.nativeEvent.clientX,y:U.nativeEvent.clientY}),document.body.style.cursor="pointer")},[]),S=h.useCallback(Z=>{if(d()){f(U=>(U&&(g(null),document.body.style.cursor=""),null));return}f(U=>(U&&g({x:Z.nativeEvent.clientX,y:Z.nativeEvent.clientY}),U))},[]),k=h.useCallback(()=>{f(null),g(null),document.body.style.cursor=""},[]),j=h.useCallback(Z=>{Z.stopPropagation(),x(null),v({x:Z.nativeEvent.clientX,y:Z.nativeEvent.clientY})},[]),b=h.useCallback(Z=>{Z.stopPropagation(),Z.nativeEvent.stopPropagation(),Z.nativeEvent.preventDefault(),v(null),x({x:Z.nativeEvent.clientX,y:Z.nativeEvent.clientY})},[]),M=h.useCallback(()=>{v(null)},[]),E=h.useCallback(()=>{x(null)},[]),P=o!=="off",I=o==="extra",R=t.toPrecision(3),A=h.useMemo(()=>[{direction:l.y,color:_t.axis.y,label:"Y",suffix:Yf[n].Y},{direction:l.x,color:_t.axis.x,label:"X"},{direction:l.z,color:_t.axis.z,label:"Z",suffix:ha[n]}],[l,n]),G=h.useMemo(()=>A.map(Z=>({direction:[-Z.direction[0],-Z.direction[1],-Z.direction[2]]})),[A]),F=s*1.15,z=e*.08;return r.jsxs("group",{children:[A.map((Z,U)=>{const D=`pos-${U}`,T=eu(Z.direction),$=tu(Z.direction,s);return r.jsx(nu,{position:$,rotation:T,radius:a,length:s,color:Z.color,isHovered:u===D,onPointerOver:m(D),onPointerMove:S,onPointerOut:k,onClick:j,onContextMenu:b},D)}),G.map((Z,U)=>{const D=`neg-${U}`,T=G[U],$=eu(T.direction),Q=tu(T.direction,i);return r.jsx(nu,{position:Q,rotation:$,radius:a*.7,length:i,color:Nk,isHovered:u===D,onPointerOver:m(D),onPointerMove:S,onPointerOut:k,onClick:j,onContextMenu:b},D)}),P&&A.map((Z,U)=>{const D=`label-${U}`,T=[Z.direction[0]*F,Z.direction[1]*F,Z.direction[2]*F];return r.jsx(zk,{position:T,label:Z.label,suffix:"suffix"in Z?Z.suffix:void 0,scaleStr:R,showExtra:I,isXAxis:U===1,color:Z.color,fontSize:z,isHovered:u===D,onPointerOver:m(D),onPointerMove:S,onPointerOut:k,onClick:j,onContextMenu:b},D)}),u&&p&&!y&&!w&&r.jsx(gn,{style:{position:"fixed",left:p.x+12,top:p.y+12,pointerEvents:"none",transform:"none"},calculatePosition:()=>[0,0],children:r.jsxs("div",{className:se.container,children:[r.jsx("div",{className:se.title,children:"Origin Axes"}),r.jsx("div",{className:se.subtitle,children:ha[n]}),r.jsxs("div",{className:se.hint,children:[r.jsxs("div",{className:se.hintRow,children:[r.jsxs("svg",{className:tt.hoverCard,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[r.jsx("rect",{x:"6",y:"2",width:"12",height:"20",rx:"6"}),r.jsx("path",{d:"M12 2v8"}),r.jsx("rect",{x:"6",y:"2",width:"6",height:"8",rx:"3",fill:"currentColor",opacity:"0.5"})]}),"Left: labels"]}),r.jsxs("div",{className:se.hintRow,children:[r.jsxs("svg",{className:tt.hoverCard,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[r.jsx("rect",{x:"6",y:"2",width:"12",height:"20",rx:"6"}),r.jsx("path",{d:"M12 2v8"}),r.jsx("rect",{x:"12",y:"2",width:"6",height:"8",rx:"3",fill:"currentColor",opacity:"0.5"})]}),"Right: coord system"]})]})]})}),y&&r.jsx(Tk,{position:y,currentLabelMode:o,onClose:M}),w&&r.jsx(Dk,{position:w,currentSystem:n,onClose:E})]})}function $k({size:e,scale:t=1}){const n=h.useRef(null),o=e*.1*t,s=h.useMemo(()=>new Ar({transparent:!0,side:so,depthWrite:!1,uniforms:{uGridScale:{value:o},uColor1:{value:new $n(16764040)},uColor2:{value:new $n(8947848)}},vertexShader:`
        varying vec3 vWorldPos;
        void main() {
          vec4 worldPos = modelMatrix * vec4(position, 1.0);
          vWorldPos = worldPos.xyz;
          gl_Position = projectionMatrix * viewMatrix * worldPos;
        }
      `,fragmentShader:`
        uniform float uGridScale;
        uniform vec3 uColor1;
        uniform vec3 uColor2;
        varying vec3 vWorldPos;

        // Robust grid line calculation that avoids fwidth discontinuities
        float getGrid(vec2 pos, float scale, float lineWidth) {
          vec2 coord = pos / scale;
          vec2 grid = abs(fract(coord - 0.5) - 0.5);
          // Use analytical derivative based on scale for stability
          vec2 deriv = fwidth(coord);
          // Clamp derivatives to avoid precision issues at grazing angles and orthographic view
          // Higher minimum prevents grid from becoming solid in ortho view
          deriv = clamp(deriv, vec2(0.001), vec2(0.5));
          vec2 lines = smoothstep(deriv * lineWidth, vec2(0.0), grid);
          return max(lines.x, lines.y);
        }

        void main() {
          // Major grid lines (every 10 units)
          float majorGrid = getGrid(vWorldPos.xz, uGridScale * 10.0, 1.5);
          // Minor grid lines (every 1 unit)
          float minorGrid = getGrid(vWorldPos.xz, uGridScale, 1.0);

          // Fade based on distance from origin
          float dist = length(vWorldPos.xz);
          float fade = 1.0 - smoothstep(uGridScale * 50.0, uGridScale * 100.0, dist);

          // Combine grids - only show actual grid lines, no fill
          vec3 color = mix(uColor2, uColor1, majorGrid);
          float alpha = max(majorGrid * 0.8, minorGrid * 0.3) * fade;

          // Discard pixels that aren't on grid lines
          if (alpha < 0.05) discard;
          gl_FragColor = vec4(color, alpha);
        }
      `}),[o]);return h.useEffect(()=>{s.uniforms.uGridScale.value=o},[s,o]),r.jsx("mesh",{ref:n,rotation:[-Math.PI/2,0,0],material:s,children:r.jsx("planeGeometry",{args:[1e4,1e4]})})}const no={x:_t.axis.x,y:_t.axis.y,z:_t.axis.z,hover:16776960},Ws={arc:.6,arcHover:.9,axis:.8,axisHover:1};function _i({axis:e,color:t,radius:n,isHovered:o,onPointerDown:s,onPointerOver:a,onPointerMove:i,onPointerOut:l,onContextMenu:c}){const d=h.useMemo(()=>{switch(e){case"x":return new pn(0,Math.PI/2,0);case"y":return new pn(Math.PI/2,0,0);case"z":return new pn(0,0,0)}},[e]),u=n*.02,f=o?no.hover:t,p=o?Ws.arcHover:Ws.arc;return r.jsxs("mesh",{rotation:d,onPointerDown:s,onPointerOver:a,onPointerMove:i,onPointerOut:l,onContextMenu:c,children:[r.jsx("torusGeometry",{args:[n,u,8,64]}),r.jsx("meshBasicMaterial",{color:f,transparent:!0,opacity:p,depthTest:!1,side:so})]})}function Ai({axis:e,color:t,length:n,isHovered:o,onPointerDown:s,onPointerOver:a,onPointerMove:i,onPointerOut:l,onContextMenu:c}){const d=h.useMemo(()=>{switch(e){case"x":return new V(1,0,0);case"y":return new V(0,1,0);case"z":return new V(0,0,1)}},[e]),u=h.useMemo(()=>{const S=new V(0,1,0);if(Math.abs(d.dot(S))>.999)return new pn(d.y>0?0:Math.PI,0,0);const k=new ut;return k.setFromUnitVectors(S,d),new pn().setFromQuaternion(k)},[d]),f=n*.8,p=n*.015,g=n*.2,y=n*.035,v=[d.x*f/2,d.y*f/2,d.z*f/2],w=[d.x*(f+g/2),d.y*(f+g/2),d.z*(f+g/2)],x=o?no.hover:t,m=o?Ws.axisHover:Ws.axis;return r.jsxs("group",{children:[r.jsxs("mesh",{position:v,rotation:u,onPointerDown:s,onPointerOver:a,onPointerMove:i,onPointerOut:l,onContextMenu:c,children:[r.jsx("cylinderGeometry",{args:[p,p,f,8]}),r.jsx("meshBasicMaterial",{color:x,transparent:!0,opacity:m,depthTest:!1})]}),r.jsxs("mesh",{position:w,rotation:u,onPointerDown:s,onPointerOver:a,onPointerMove:i,onPointerOut:l,onContextMenu:c,children:[r.jsx("coneGeometry",{args:[y,g,12]}),r.jsx("meshBasicMaterial",{color:x,transparent:!0,opacity:m,depthTest:!1})]})]})}function Bk({center:e,size:t}){const{camera:n,gl:o}=In(),s=In(T=>T.controls),a=Lt(T=>T.transform),i=Lt(T=>T.setTransform),l=Lt(T=>T.resetTransform),c=ye(T=>T.droppedFiles),d=q(T=>T.setShowGizmo),{processFiles:u}=Dr(),[f,p]=h.useState(null),[g,y]=h.useState(null),[v,w]=h.useState(!1),[x,m]=h.useState(null),[S,k]=h.useState(null),j=h.useRef(null),b=h.useRef(null),M=h.useMemo(()=>{const T=new pn(a.rotationX,a.rotationY,a.rotationZ,"XYZ");return new ut().setFromEuler(T)},[a.rotationX,a.rotationY,a.rotationZ]),E=h.useCallback((T,$)=>{const Q=new V(...e);if($==="translate"){const K=new V;n.getWorldDirection(K);let re;const J=T==="x"?new V(1,0,0):T==="y"?new V(0,1,0):new V(0,0,1);if(re=J.clone().cross(K).cross(J).normalize(),re.lengthSq()<.001){const L=new V(0,1,0).applyQuaternion(n.quaternion);re=J.clone().cross(L).cross(J).normalize()}return new fl().setFromNormalAndCoplanarPoint(re,Q)}else{let K;switch(T){case"x":K=new V(1,0,0);break;case"y":K=new V(0,1,0);break;default:K=new V(0,0,1);break}return new fl().setFromNormalAndCoplanarPoint(K,Q)}},[n,e]),P=h.useCallback((T,$,Q)=>{const K=o.domElement.getBoundingClientRect(),re=(T-K.left)/K.width*2-1,J=-(($-K.top)/K.height)*2+1,L=new zh;L.setFromCamera(new pa(re,J),n);const ee=new V;return L.ray.intersectPlane(Q,ee)?ee:null},[n,o]),I=h.useCallback((T,$)=>Q=>{Q.stopPropagation(),s?.enabled&&(s.enabled.current=!1);const K=E(T,$),re=P(Q.nativeEvent.clientX,Q.nativeEvent.clientY,K);if(!re){s?.enabled&&(s.enabled.current=!0);return}const J={translationX:a.translationX,translationY:a.translationY,translationZ:a.translationZ,rotationX:a.rotationX,rotationY:a.rotationY,rotationZ:a.rotationZ},L=M.clone(),ee=new V(...e);j.current={axis:T,mode:$,startPoint:re,startCenter:ee,startTransform:J,startRotation:L,plane:K},w(!0),o.domElement.setPointerCapture(Q.pointerId)},[E,P,a,o,s,M]),R=h.useCallback(T=>{if(!v||!j.current)return;const{axis:$,mode:Q,startPoint:K,startTransform:re,startRotation:J,plane:L}=j.current,ee=P(T.clientX,T.clientY,L);if(!(!ee||!$)){if(Q==="translate"){const ie=$==="x"?new V(1,0,0):$==="y"?new V(0,1,0):new V(0,0,1),de=ee.clone().sub(K).dot(ie),fe=ie.clone().multiplyScalar(de);i({translationX:re.translationX+fe.x,translationY:re.translationY+fe.y,translationZ:re.translationZ+fe.z})}else if(Q==="rotate"){const ie=j.current.startCenter,te=K.clone().sub(ie).normalize(),de=ee.clone().sub(ie).normalize(),fe=$==="x"?new V(1,0,0):$==="y"?new V(0,1,0):new V(0,0,1),we=te.clone().cross(de),pe=te.dot(de);let ge=Math.atan2(we.length(),pe);we.dot(fe)<0&&(ge=-ge);const Re=new ut().setFromAxisAngle(fe,ge),Le=Re.clone().multiply(J),xe=new V(re.translationX,re.translationY,re.translationZ),ke=ie.clone().sub(xe).clone().applyQuaternion(Re),W=ie.clone().sub(ke),me=new pn().setFromQuaternion(Le,"XYZ");i({translationX:W.x,translationY:W.y,translationZ:W.z,rotationX:me.x,rotationY:me.y,rotationZ:me.z})}}},[v,P,i]),A=h.useCallback(T=>{v&&(w(!1),p(null),y(null),s?.enabled&&(s.enabled.current=!0),j.current=null,o.domElement.releasePointerCapture(T.pointerId))},[v,o,s]);h.useEffect(()=>{if(!v)return;const T=o.domElement;return T.addEventListener("pointermove",R),T.addEventListener("pointerup",A),()=>{T.removeEventListener("pointermove",R),T.removeEventListener("pointerup",A)}},[v,o,R,A]);const G=t*.35,F=G,z=h.useCallback(T=>{T.stopPropagation(),T.nativeEvent.stopPropagation(),T.nativeEvent.preventDefault(),k({x:T.nativeEvent.clientX,y:T.nativeEvent.clientY})},[]),Z=h.useCallback((T,$)=>Q=>{v||(p(T),y($),m({x:Q.nativeEvent.clientX,y:Q.nativeEvent.clientY}))},[v]),U=h.useCallback(T=>{p($=>($&&m({x:T.nativeEvent.clientX,y:T.nativeEvent.clientY}),$))},[]),D=h.useCallback(()=>{v||(p(null),y(null),m(null))},[v]);return r.jsxs("group",{ref:b,position:e,children:[r.jsx(Ai,{axis:"x",color:no.x,length:F,isHovered:f==="x"&&g==="translate"||v&&j.current?.axis==="x"&&j.current?.mode==="translate",onPointerDown:I("x","translate"),onPointerOver:Z("x","translate"),onPointerMove:U,onPointerOut:D,onContextMenu:z}),r.jsx(Ai,{axis:"y",color:no.y,length:F,isHovered:f==="y"&&g==="translate"||v&&j.current?.axis==="y"&&j.current?.mode==="translate",onPointerDown:I("y","translate"),onPointerOver:Z("y","translate"),onPointerMove:U,onPointerOut:D,onContextMenu:z}),r.jsx(Ai,{axis:"z",color:no.z,length:F,isHovered:f==="z"&&g==="translate"||v&&j.current?.axis==="z"&&j.current?.mode==="translate",onPointerDown:I("z","translate"),onPointerOver:Z("z","translate"),onPointerMove:U,onPointerOut:D,onContextMenu:z}),r.jsx(_i,{axis:"x",color:no.x,radius:G,isHovered:f==="x"&&g==="rotate"||v&&j.current?.axis==="x"&&j.current?.mode==="rotate",onPointerDown:I("x","rotate"),onPointerOver:Z("x","rotate"),onPointerMove:U,onPointerOut:D,onContextMenu:z}),r.jsx(_i,{axis:"y",color:no.y,radius:G,isHovered:f==="y"&&g==="rotate"||v&&j.current?.axis==="y"&&j.current?.mode==="rotate",onPointerDown:I("y","rotate"),onPointerOver:Z("y","rotate"),onPointerMove:U,onPointerOut:D,onContextMenu:z}),r.jsx(_i,{axis:"z",color:no.z,radius:G,isHovered:f==="z"&&g==="rotate"||v&&j.current?.axis==="z"&&j.current?.mode==="rotate",onPointerDown:I("z","rotate"),onPointerOver:Z("z","rotate"),onPointerMove:U,onPointerOut:D,onContextMenu:z}),r.jsxs("mesh",{onContextMenu:z,renderOrder:999,children:[r.jsx("sphereGeometry",{args:[t*.02,16,16]}),r.jsx("meshBasicMaterial",{color:16777215,depthTest:!1,transparent:!0,opacity:1})]}),f&&x&&!S&&r.jsx(gn,{style:{position:"fixed",left:x.x+12,top:x.y+12,pointerEvents:"none",transform:"none"},calculatePosition:()=>[0,0],children:r.jsxs("div",{className:se.container,children:[r.jsx("div",{className:se.title,children:"Transform Gizmo"}),r.jsxs("div",{className:se.subtitle,children:[f.toUpperCase(),"-axis â€¢ ",g]}),r.jsxs("div",{className:se.hint,children:[r.jsxs("div",{className:se.hintRow,children:[r.jsxs("svg",{className:tt.hoverCard,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[r.jsx("rect",{x:"6",y:"2",width:"12",height:"20",rx:"6"}),r.jsx("path",{d:"M12 2v8"}),r.jsx("rect",{x:"6",y:"2",width:"6",height:"8",rx:"3",fill:"currentColor",opacity:"0.5"})]}),"Drag: ",g]}),r.jsxs("div",{className:se.hintRow,children:[r.jsxs("svg",{className:tt.hoverCard,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[r.jsx("rect",{x:"6",y:"2",width:"12",height:"20",rx:"6"}),r.jsx("path",{d:"M12 2v8"}),r.jsx("rect",{x:"12",y:"2",width:"6",height:"8",rx:"3",fill:"currentColor",opacity:"0.5"})]}),"Right: options"]})]})]})}),S&&r.jsx(Uk,{position:S,onClose:()=>k(null),onReset:()=>{l(),k(null)},onReload:()=>{c&&(l(),u(c)),k(null)},onApply:()=>{Sr(),k(null)},onOff:()=>{d(!1),k(null)}})]})}function Uk({position:e,onClose:t,onReset:n,onReload:o,onApply:s,onOff:a}){const i=h.useRef(null);return h.useEffect(()=>{const l=u=>{i.current&&!i.current.contains(u.target)&&t()},c=u=>{u.key==="Escape"&&t()},d=setTimeout(()=>{document.addEventListener("mousedown",l),document.addEventListener("keydown",c)},0);return()=>{clearTimeout(d),document.removeEventListener("mousedown",l),document.removeEventListener("keydown",c)}},[t]),r.jsx(gn,{style:{position:"fixed",left:e.x,top:e.y,pointerEvents:"auto"},calculatePosition:()=>[0,0],children:r.jsxs("div",{ref:i,className:at.container,children:[r.jsxs("button",{className:at.button,onClick:n,children:[r.jsx($s,{className:at.icon}),"Reset"]}),r.jsxs("button",{className:at.button,onClick:o,children:[r.jsx(Cf,{className:at.icon}),"Reload"]}),r.jsxs("button",{className:at.button,onClick:s,children:[r.jsx(yo,{className:at.icon}),"Apply"]}),r.jsxs("button",{className:at.button,onClick:a,children:[r.jsx(X1,{className:at.icon}),"Off"]})]})})}const Wk=[16729156,4521796,4474111],ou=16776960,Hk=.012,Zk={X:{hex:16729156,css:"#ff4444"},Y:{hex:4521796,css:"#44ff44"},Z:{hex:4474111,css:"#4444ff"}};function Vk({position:e,baseSize:t}){const n=h.useMemo(()=>new Float32Array([e.x,e.y,e.z]),[e.x,e.y,e.z]);return r.jsxs("points",{children:[r.jsx("bufferGeometry",{children:r.jsx("bufferAttribute",{attach:"attributes-position",args:[n,3]})}),r.jsx("pointsMaterial",{color:"#ffff00",size:t+3,sizeAttenuation:!1,depthTest:!1,transparent:!0,opacity:.8})]})}function Gk(){const e=Ve(I=>I.selectedPoints),t=Ve(I=>I.pickingMode),n=Ve(I=>I.removePointAt),o=Ve(I=>I.normalFlipped),s=Ve(I=>I.toggleNormalFlipped),a=Ve(I=>I.targetAxis),i=Ve(I=>I.cycleTargetAxis),l=Ve(I=>I.setTargetAxis),c=Qe(I=>I.pointSize),d=q(I=>I.axesCoordinateSystem),u=h.useRef(t);h.useEffect(()=>{if(t==="normal-3pt"&&u.current!=="normal-3pt"){const I=op(d);l(I)}u.current=t},[t,d,l]);const f=Zk[a],p=t==="origin-1pt"?1:t==="distance-2pt"?2:t==="normal-3pt"?3:0,g=e.length<p,y=Ve(I=>g?I.hoveredPoint:null),[v,w]=h.useState(null),[x,m]=h.useState(!1),[S,k]=h.useState(null),j=h.useMemo(()=>{if(e.length<2)return .015;const I=e[0].position.distanceTo(e[1].position);return Math.max(Hk,I*.015)},[e]),b=h.useMemo(()=>{if(t!=="normal-3pt"||e.length!==3)return null;const I=e[0].position,R=e[1].position,A=e[2].position,G=new V().subVectors(R,I),F=new V().subVectors(A,I),z=new V().crossVectors(G,F);if(z.lengthSq()<1e-10)return null;z.normalize(),o&&z.negate();const Z=new V().add(I).add(R).add(A).divideScalar(3),U=Math.max(G.length(),F.length())*.5,D=Z.clone().add(z.clone().multiplyScalar(U)),T=new ut;T.setFromUnitVectors(new V(0,1,0),z);const $=U*.2,Q=U*.04,K=new Float32Array([I.x,I.y,I.z,R.x,R.y,R.z,A.x,A.y,A.z]);return{start:Z,end:D,quaternion:T,coneHeight:$,coneRadius:Q,normal:z,trianglePositions:K}},[e,t,o]),M=h.useMemo(()=>{if(e.length<2)return null;const I=[];for(const G of e)I.push(G.position.x,G.position.y,G.position.z);t==="normal-3pt"&&e.length===3&&I.push(e[0].position.x,e[0].position.y,e[0].position.z);const R=new Ho;R.setAttribute("position",new br(I,3));const A=new Oi({color:16776960,transparent:!0,opacity:.8,depthTest:!1});return new hl(R,A)},[e,t]),E=h.useMemo(()=>{if(!b)return null;const I=new Ho,R=new Float32Array([b.start.x,b.start.y,b.start.z,b.end.x,b.end.y,b.end.z]);I.setAttribute("position",new br(R,3));const A=new Oi({color:f.hex,depthTest:!1});return new hl(I,A)},[b,f.hex]),P=h.useMemo(()=>new Oh(1,8,8),[]);return e.length===0&&!y?null:r.jsxs("group",{children:[e.map((I,R)=>r.jsx("mesh",{position:I.position,scale:j,geometry:P,onContextMenu:A=>{A.stopPropagation(),A.nativeEvent.stopPropagation(),A.nativeEvent.preventDefault(),n(R)},onPointerOver:A=>{w(R),k({x:A.nativeEvent.clientX,y:A.nativeEvent.clientY})},onPointerOut:()=>{w(null),k(null)},children:r.jsx("meshBasicMaterial",{color:v===R?ou:Wk[R],transparent:!0,opacity:.9,depthTest:!1})},R)),M&&r.jsx("primitive",{object:M}),b&&E&&r.jsxs(r.Fragment,{children:[r.jsxs("mesh",{onClick:I=>{I.stopPropagation(),s()},onContextMenu:I=>{I.stopPropagation(),I.nativeEvent.preventDefault(),i(d)},onPointerOver:I=>{m(!0),k({x:I.nativeEvent.clientX,y:I.nativeEvent.clientY})},onPointerOut:()=>{m(!1),k(null)},children:[r.jsx("bufferGeometry",{children:r.jsx("bufferAttribute",{attach:"attributes-position",args:[b.trianglePositions,3]})}),r.jsx("meshBasicMaterial",{color:x?ou:f.hex,transparent:!0,opacity:x?.3:.15,side:so,depthTest:!1})]}),r.jsx("primitive",{object:E}),r.jsxs("mesh",{position:b.end,quaternion:b.quaternion,onClick:I=>{I.stopPropagation(),s()},onContextMenu:I=>{I.stopPropagation(),I.nativeEvent.preventDefault(),i(d)},children:[r.jsx("coneGeometry",{args:[b.coneRadius,b.coneHeight,8]}),r.jsx("meshBasicMaterial",{color:f.hex,depthTest:!1})]})]}),y&&g&&r.jsx(Vk,{position:y,baseSize:c}),v!==null&&S&&r.jsx(gn,{style:{position:"fixed",left:S.x+12,top:S.y+12,pointerEvents:"none",transform:"none"},calculatePosition:()=>[0,0],children:r.jsxs("div",{className:se.container,children:[r.jsxs("div",{className:se.title,children:["P",v+1]}),r.jsx("div",{className:se.subtitle,children:"Right-click to remove"})]})}),x&&S&&r.jsx(gn,{style:{position:"fixed",left:S.x+12,top:S.y+12,pointerEvents:"none",transform:"none"},calculatePosition:()=>[0,0],children:r.jsxs("div",{className:se.container,children:[r.jsxs("div",{className:se.title,style:{color:f.css},children:[a,"-axis"]}),r.jsx("div",{className:se.subtitle,children:"Left: flip Â· Right: X/Y/Z"})]})})]})}const Yk={X:{hex:16729156,css:"#ff4444"},Y:{hex:4521796,css:"#44ff44"},Z:{hex:4474111,css:"#4444ff"}},ru=16776960;function qk({boundsRadius:e}){const t=Ge(b=>b.detectedPlane),n=Ge(b=>b.normalFlipped),o=Ge(b=>b.toggleNormalFlipped),s=Ge(b=>b.targetAxis),a=Ge(b=>b.cycleTargetAxis),i=Ge(b=>b.setShowFloorModal),l=Ge(b=>b.setModalPosition),c=Ge(b=>b.showFloorModal),d=q(b=>b.axesScale),u=q(b=>b.axesCoordinateSystem),[f,p]=h.useState(!1),[g,y]=h.useState(null),v=Yk[s],w=h.useMemo(()=>{if(!t)return null;const b=n?$f(t):t,{normal:M,centroid:E,radius:P}=b,I=new V(E[0],E[1],E[2]),R=new V(M[0],M[1],M[2]),A=new ut;A.setFromUnitVectors(new V(0,0,1),R);const G=e*d,F=G*.5,z=G*.005,Z=z*8,U=z*3,D=F-Z,T=I.clone().add(R.clone().multiplyScalar(D/2)),$=I.clone().add(R.clone().multiplyScalar(D+Z/2)),Q=new ut;Q.setFromUnitVectors(new V(0,1,0),R);const K=new ut;K.setFromUnitVectors(new V(0,1,0),R);const re=F*1.15,J=I.clone().add(R.clone().multiplyScalar(re)),L=G*.08;return{position:I,normalVec:R,quaternion:A,radius:P,arrowRadius:z,shaftLength:D,shaftCenter:T,shaftQuaternion:K,conePosition:$,coneHeight:Z,coneRadius:U,coneQuaternion:Q,labelPosition:J,fontSize:L}},[t,n,e,d]);if(!t||!w)return null;const x=b=>{b.stopPropagation(),o()},m=b=>{b.stopPropagation(),b.nativeEvent.stopPropagation(),b.nativeEvent.preventDefault(),a()},S=b=>{p(!0),y({x:b.nativeEvent.clientX,y:b.nativeEvent.clientY}),c||(i(!0),l({x:b.nativeEvent.clientX,y:b.nativeEvent.clientY}))},k=b=>{y({x:b.nativeEvent.clientX,y:b.nativeEvent.clientY})},j=()=>{p(!1),y(null)};return r.jsxs("group",{children:[r.jsxs("mesh",{position:w.position,quaternion:w.quaternion,onClick:x,onContextMenu:m,onPointerOver:S,onPointerMove:k,onPointerOut:j,children:[r.jsx("ringGeometry",{args:[w.radius*.95,w.radius,64]}),r.jsx("meshBasicMaterial",{color:f?ru:v.hex,transparent:!0,opacity:f?.4:.2,side:so,depthTest:!1})]}),r.jsxs("mesh",{position:w.position,quaternion:w.quaternion,onClick:x,onContextMenu:m,onPointerOver:S,onPointerMove:k,onPointerOut:j,children:[r.jsx("circleGeometry",{args:[w.radius*.3,32]}),r.jsx("meshBasicMaterial",{color:f?ru:v.hex,transparent:!0,opacity:f?.5:.3,side:so,depthTest:!1})]}),r.jsxs("mesh",{position:w.shaftCenter,quaternion:w.shaftQuaternion,onClick:x,onContextMenu:m,children:[r.jsx("cylinderGeometry",{args:[w.arrowRadius,w.arrowRadius,w.shaftLength,8]}),r.jsx("meshBasicMaterial",{color:v.hex,depthTest:!1})]}),r.jsxs("mesh",{position:w.conePosition,quaternion:w.coneQuaternion,onClick:x,onContextMenu:m,children:[r.jsx("coneGeometry",{args:[w.coneRadius,w.coneHeight,8]}),r.jsx("meshBasicMaterial",{color:v.hex,depthTest:!1})]}),r.jsx(xu,{position:w.labelPosition,follow:!0,children:r.jsxs("group",{children:[r.jsx(yr,{fontSize:w.fontSize,color:v.hex,anchorX:"right",anchorY:"middle",outlineWidth:w.fontSize*.08,outlineColor:"#000000",outlineOpacity:.5,children:s}),r.jsxs(yr,{fontSize:w.fontSize*.6,color:v.hex,anchorX:"left",anchorY:"middle",position:[w.fontSize*.15,0,0],outlineWidth:w.fontSize*.05,outlineColor:"#000000",outlineOpacity:.5,children:["(",Yf[u][s],")"]})]})}),f&&g&&r.jsx(gn,{style:{position:"fixed",left:g.x+12,top:g.y+12,pointerEvents:"none",transform:"none"},calculatePosition:()=>[0,0],children:r.jsxs("div",{className:se.container,children:[r.jsxs("div",{className:se.title,style:{color:v.css},children:[s,"-axis"]}),r.jsxs("div",{className:se.hint,children:[r.jsxs("div",{className:se.hintRow,children:[r.jsxs("svg",{className:tt.hoverCard,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[r.jsx("rect",{x:"6",y:"2",width:"12",height:"20",rx:"6"}),r.jsx("path",{d:"M12 2v8"}),r.jsx("rect",{x:"6",y:"2",width:"6",height:"8",rx:"3",fill:"currentColor",opacity:"0.5"})]}),"Flip normal"]}),r.jsxs("div",{className:se.hintRow,children:[r.jsxs("svg",{className:tt.hoverCard,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[r.jsx("rect",{x:"6",y:"2",width:"12",height:"20",rx:"6"}),r.jsx("path",{d:"M12 2v8"}),r.jsx("rect",{x:"12",y:"2",width:"6",height:"8",rx:"3",fill:"currentColor",opacity:"0.5"})]}),"Cycle X/Y/Z"]})]})]})})]})}const su=["#ff4444","#44ff44","#4444ff"],Xk=["P1","P2","P3"];function Kk(){const e=Ve(u=>u.pickingMode),t=Ve(u=>u.selectedPoints.length),[n,o]=h.useState({x:0,y:0}),s=e==="origin-1pt"?1:e==="distance-2pt"?2:e==="normal-3pt"?3:0,a=e!=="off",i=t,l=i>=s;if(h.useEffect(()=>{if(!a)return;const u=f=>{o({x:f.clientX,y:f.clientY})};return window.addEventListener("mousemove",u),()=>window.removeEventListener("mousemove",u)},[a]),!a||l)return null;const c=su[i]||su[0],d=Xk[i]||"P1";return r.jsx("div",{className:"fixed pointer-events-none z-[1000]",style:{left:n.x+16,top:n.y+16},children:r.jsxs("div",{className:"bg-black/90 text-white text-xs px-2 py-1.5 rounded whitespace-nowrap flex items-center gap-2",children:[r.jsx("span",{className:"w-3 h-3 rounded-full inline-block",style:{backgroundColor:c}}),r.jsxs("span",{children:["Select ",r.jsx("strong",{children:d})]})]})})}function cs(e){throw new Error('Could not dynamically require "'+e+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var Ni={exports:{}},iu;function Qk(){return iu||(iu=1,(function(e,t){(function(n){e.exports=n()})(function(){return(function n(o,s,a){function i(d,u){if(!s[d]){if(!o[d]){var f=typeof cs=="function"&&cs;if(!u&&f)return f(d,!0);if(l)return l(d,!0);var p=new Error("Cannot find module '"+d+"'");throw p.code="MODULE_NOT_FOUND",p}var g=s[d]={exports:{}};o[d][0].call(g.exports,function(y){var v=o[d][1][y];return i(v||y)},g,g.exports,n,o,s,a)}return s[d].exports}for(var l=typeof cs=="function"&&cs,c=0;c<a.length;c++)i(a[c]);return i})({1:[function(n,o,s){function a(){this._events=this._events||{},this._maxListeners=this._maxListeners||void 0}o.exports=a,a.EventEmitter=a,a.prototype._events=void 0,a.prototype._maxListeners=void 0,a.defaultMaxListeners=10,a.prototype.setMaxListeners=function(u){if(!l(u)||u<0||isNaN(u))throw TypeError("n must be a positive number");return this._maxListeners=u,this},a.prototype.emit=function(u){var f,p,g,y,v,w;if(this._events||(this._events={}),u==="error"&&(!this._events.error||c(this._events.error)&&!this._events.error.length)){if(f=arguments[1],f instanceof Error)throw f;var x=new Error('Uncaught, unspecified "error" event. ('+f+")");throw x.context=f,x}if(p=this._events[u],d(p))return!1;if(i(p))switch(arguments.length){case 1:p.call(this);break;case 2:p.call(this,arguments[1]);break;case 3:p.call(this,arguments[1],arguments[2]);break;default:y=Array.prototype.slice.call(arguments,1),p.apply(this,y)}else if(c(p))for(y=Array.prototype.slice.call(arguments,1),w=p.slice(),g=w.length,v=0;v<g;v++)w[v].apply(this,y);return!0},a.prototype.addListener=function(u,f){var p;if(!i(f))throw TypeError("listener must be a function");return this._events||(this._events={}),this._events.newListener&&this.emit("newListener",u,i(f.listener)?f.listener:f),this._events[u]?c(this._events[u])?this._events[u].push(f):this._events[u]=[this._events[u],f]:this._events[u]=f,c(this._events[u])&&!this._events[u].warned&&(d(this._maxListeners)?p=a.defaultMaxListeners:p=this._maxListeners,p&&p>0&&this._events[u].length>p&&(this._events[u].warned=!0,console.error("(node) warning: possible EventEmitter memory leak detected. %d listeners added. Use emitter.setMaxListeners() to increase limit.",this._events[u].length),typeof console.trace=="function"&&console.trace())),this},a.prototype.on=a.prototype.addListener,a.prototype.once=function(u,f){if(!i(f))throw TypeError("listener must be a function");var p=!1;function g(){this.removeListener(u,g),p||(p=!0,f.apply(this,arguments))}return g.listener=f,this.on(u,g),this},a.prototype.removeListener=function(u,f){var p,g,y,v;if(!i(f))throw TypeError("listener must be a function");if(!this._events||!this._events[u])return this;if(p=this._events[u],y=p.length,g=-1,p===f||i(p.listener)&&p.listener===f)delete this._events[u],this._events.removeListener&&this.emit("removeListener",u,f);else if(c(p)){for(v=y;v-- >0;)if(p[v]===f||p[v].listener&&p[v].listener===f){g=v;break}if(g<0)return this;p.length===1?(p.length=0,delete this._events[u]):p.splice(g,1),this._events.removeListener&&this.emit("removeListener",u,f)}return this},a.prototype.removeAllListeners=function(u){var f,p;if(!this._events)return this;if(!this._events.removeListener)return arguments.length===0?this._events={}:this._events[u]&&delete this._events[u],this;if(arguments.length===0){for(f in this._events)f!=="removeListener"&&this.removeAllListeners(f);return this.removeAllListeners("removeListener"),this._events={},this}if(p=this._events[u],i(p))this.removeListener(u,p);else if(p)for(;p.length;)this.removeListener(u,p[p.length-1]);return delete this._events[u],this},a.prototype.listeners=function(u){var f;return!this._events||!this._events[u]?f=[]:i(this._events[u])?f=[this._events[u]]:f=this._events[u].slice(),f},a.prototype.listenerCount=function(u){if(this._events){var f=this._events[u];if(i(f))return 1;if(f)return f.length}return 0},a.listenerCount=function(u,f){return u.listenerCount(f)};function i(u){return typeof u=="function"}function l(u){return typeof u=="number"}function c(u){return typeof u=="object"&&u!==null}function d(u){return u===void 0}},{}],2:[function(n,o,s){var a,i,l,c,d;d=navigator.userAgent.toLowerCase(),c=navigator.platform.toLowerCase(),a=d.match(/(opera|ie|firefox|chrome|version)[\s\/:]([\w\d\.]+)?.*?(safari|version[\s\/:]([\w\d\.]+)|$)/)||[null,"unknown",0],l=a[1]==="ie"&&document.documentMode,i={name:a[1]==="version"?a[3]:a[1],version:l||parseFloat(a[1]==="opera"&&a[4]?a[4]:a[2]),platform:{name:d.match(/ip(?:ad|od|hone)/)?"ios":(d.match(/(?:webos|android)/)||c.match(/mac|win|linux/)||["other"])[0]}},i[i.name]=!0,i[i.name+parseInt(i.version,10)]=!0,i.platform[i.platform.name]=!0,o.exports=i},{}],3:[function(n,o,s){var a,i,l,c=function(p,g){for(var y in g)d.call(g,y)&&(p[y]=g[y]);function v(){this.constructor=p}return v.prototype=g.prototype,p.prototype=new v,p.__super__=g.prototype,p},d={}.hasOwnProperty,u=[].indexOf||function(p){for(var g=0,y=this.length;g<y;g++)if(g in this&&this[g]===p)return g;return-1},f=[].slice;a=n("events").EventEmitter,l=n("./browser.coffee"),i=(function(p){var g,y;c(v,p),g={workerScript:"gif.worker.js",workers:2,repeat:0,background:"#fff",quality:10,width:null,height:null,transparent:null,debug:!1,dither:!1},y={delay:500,copy:!1};function v(w){var x,m,S;this.running=!1,this.options={},this.frames=[],this.freeWorkers=[],this.activeWorkers=[],this.setOptions(w);for(m in g)S=g[m],(x=this.options)[m]==null&&(x[m]=S)}return v.prototype.setOption=function(w,x){if(this.options[w]=x,this._canvas!=null&&(w==="width"||w==="height"))return this._canvas[w]=x},v.prototype.setOptions=function(w){var x,m,S;m=[];for(x in w)d.call(w,x)&&(S=w[x],m.push(this.setOption(x,S)));return m},v.prototype.addFrame=function(w,x){var m,S;x==null&&(x={}),m={},m.transparent=this.options.transparent;for(S in y)m[S]=x[S]||y[S];if(this.options.width==null&&this.setOption("width",w.width),this.options.height==null&&this.setOption("height",w.height),typeof ImageData<"u"&&ImageData!==null&&w instanceof ImageData)m.data=w.data;else if(typeof CanvasRenderingContext2D<"u"&&CanvasRenderingContext2D!==null&&w instanceof CanvasRenderingContext2D||typeof WebGLRenderingContext<"u"&&WebGLRenderingContext!==null&&w instanceof WebGLRenderingContext)x.copy?m.data=this.getContextData(w):m.context=w;else if(w.childNodes!=null)x.copy?m.data=this.getImageData(w):m.image=w;else throw new Error("Invalid image");return this.frames.push(m)},v.prototype.render=function(){var w,x,m;if(this.running)throw new Error("Already running");if(this.options.width==null||this.options.height==null)throw new Error("Width and height must be set prior to rendering");if(this.running=!0,this.nextFrame=0,this.finishedFrames=0,this.imageParts=function(){var S,k,j;for(j=[],S=0,k=this.frames.length;0<=k?S<k:S>k;0<=k?++S:--S)j.push(null);return j}.call(this),x=this.spawnWorkers(),this.options.globalPalette===!0)this.renderNextFrame();else for(w=0,m=x;0<=m?w<m:w>m;0<=m?++w:--w)this.renderNextFrame();return this.emit("start"),this.emit("progress",0)},v.prototype.abort=function(){for(var w;w=this.activeWorkers.shift(),w!=null;)this.log("killing active worker"),w.terminate();return this.running=!1,this.emit("abort")},v.prototype.spawnWorkers=function(){var w,x,m;return w=Math.min(this.options.workers,this.frames.length),(function(){m=[];for(var S=x=this.freeWorkers.length;x<=w?S<w:S>w;x<=w?S++:S--)m.push(S);return m}).apply(this).forEach((function(S){return function(k){var j;return S.log("spawning worker "+k),j=new Worker(S.options.workerScript),j.onmessage=function(b){return S.activeWorkers.splice(S.activeWorkers.indexOf(j),1),S.freeWorkers.push(j),S.frameFinished(b.data)},S.freeWorkers.push(j)}})(this)),w},v.prototype.frameFinished=function(w){var x,m;if(this.log("frame "+w.index+" finished - "+this.activeWorkers.length+" active"),this.finishedFrames++,this.emit("progress",this.finishedFrames/this.frames.length),this.imageParts[w.index]=w,this.options.globalPalette===!0&&(this.options.globalPalette=w.globalPalette,this.log("global palette analyzed"),this.frames.length>2))for(x=1,m=this.freeWorkers.length;1<=m?x<m:x>m;1<=m?++x:--x)this.renderNextFrame();return u.call(this.imageParts,null)>=0?this.renderNextFrame():this.finishRendering()},v.prototype.finishRendering=function(){var w,x,m,S,k,j,b,M,E,P,I,R,A,G,F,z;for(M=0,G=this.imageParts,k=0,E=G.length;k<E;k++)x=G[k],M+=(x.data.length-1)*x.pageSize+x.cursor;for(M+=x.pageSize-x.cursor,this.log("rendering finished - filesize "+Math.round(M/1e3)+"kb"),w=new Uint8Array(M),R=0,F=this.imageParts,j=0,P=F.length;j<P;j++)for(x=F[j],z=x.data,m=b=0,I=z.length;b<I;m=++b)A=z[m],w.set(A,R),m===x.data.length-1?R+=x.cursor:R+=x.pageSize;return S=new Blob([w],{type:"image/gif"}),this.emit("finished",S,w)},v.prototype.renderNextFrame=function(){var w,x,m;if(this.freeWorkers.length===0)throw new Error("No free workers");if(!(this.nextFrame>=this.frames.length))return w=this.frames[this.nextFrame++],m=this.freeWorkers.shift(),x=this.getTask(w),this.log("starting frame "+(x.index+1)+" of "+this.frames.length),this.activeWorkers.push(m),m.postMessage(x)},v.prototype.getContextData=function(w){return w.getImageData(0,0,this.options.width,this.options.height).data},v.prototype.getImageData=function(w){var x;return this._canvas==null&&(this._canvas=document.createElement("canvas"),this._canvas.width=this.options.width,this._canvas.height=this.options.height),x=this._canvas.getContext("2d"),x.setFill=this.options.background,x.fillRect(0,0,this.options.width,this.options.height),x.drawImage(w,0,0),this.getContextData(x)},v.prototype.getTask=function(w){var x,m;if(x=this.frames.indexOf(w),m={index:x,last:x===this.frames.length-1,delay:w.delay,transparent:w.transparent,width:this.options.width,height:this.options.height,quality:this.options.quality,dither:this.options.dither,globalPalette:this.options.globalPalette,repeat:this.options.repeat,canTransfer:l.name==="chrome"},w.data!=null)m.data=w.data;else if(w.context!=null)m.data=this.getContextData(w.context);else if(w.image!=null)m.data=this.getImageData(w.image);else throw new Error("Invalid frame");return m},v.prototype.log=function(){var w;if(w=1<=arguments.length?f.call(arguments,0):[],!!this.options.debug)return console.log.apply(console,w)},v})(a),o.exports=i},{"./browser.coffee":2,events:1}]},{},[3])(3)})})(Ni)),Ni.exports}var Jk=Qk();const eS=Zh(Jk),Kf=30,au=1e3/Kf,lu={low:{bitrate:5e6,gifQuality:15},medium:{bitrate:1e7,gifQuality:10},high:{bitrate:2e7,gifQuality:5},ultra:{bitrate:4e7,gifQuality:2}};function tS(){const{gl:e,scene:t,camera:n,size:o}=In(),s=He(L=>L.screenshotTrigger),a=He(L=>L.screenshotSize),i=He(L=>L.screenshotFormat),l=He(L=>L.screenshotHideLogo),c=He(L=>L.setGetScreenshotBlob),d=He(L=>L.setRecordGif),u=He(L=>L.setIsRecordingGif),f=He(L=>L.setGifBlobUrl),p=He(L=>L.gifDuration),g=He(L=>L.gifDownsample),y=He(L=>L.gifSpeed),v=He(L=>L.recordingQuality),w=He(L=>L.recordingFormat),x=h.useRef(0),m=h.useRef(null),S=h.useRef(null),k=h.useRef(0),j=h.useRef(0),b=h.useRef(null),M=h.useRef(2e3),E=h.useRef(2),P=h.useRef(1),I=h.useRef(null),R=h.useRef(null),A=h.useRef(0),G=h.useRef(2e3),F=h.useRef([]),z=h.useRef(null),Z=h.useRef(!1),U=h.useRef(1),D=h.useRef(0);h.useEffect(()=>{const L=new Image;L.src=bo("LOGO.png"),L.onload=()=>{m.current=L}},[]);const T=h.useCallback((L,ee)=>{const ie=L.getContext("2d"),te=m.current;if(te&&!ee){const de=L.height*di.logoHeightPercent,fe=te.width/te.height*de,we=L.height*di.paddingPercent;ie.globalAlpha=di.logoAlpha,ie.drawImage(te,we,L.height-de-we,fe,de),ie.globalAlpha=1}},[]),$=h.useCallback(async()=>{e.render(t,n);const L=document.createElement("canvas");return L.width=e.domElement.width,L.height=e.domElement.height,L.getContext("2d").drawImage(e.domElement,0,0),T(L,l),new Promise(ie=>{L.toBlob(te=>{ie(te)},"image/png")})},[e,t,n,l,T]);h.useEffect(()=>(c($),()=>c(null)),[$,c]);const Q=h.useCallback(()=>new Promise(L=>{const ee=Math.floor(e.domElement.width/g),ie=Math.floor(e.domElement.height/g),te=lu[v],de=new eS({workers:2,quality:te.gifQuality,width:ee,height:ie,workerScript:bo("gif.worker.js")});de.on("finished",fe=>{const we=URL.createObjectURL(fe);f(we),u(!1),L(fe)}),S.current=de,k.current=performance.now(),j.current=0,b.current=L,M.current=p*1e3,E.current=g,P.current=y,u(!0)}),[e,u,f,p,g,y,v]),K=h.useCallback(L=>new Promise(ee=>{const ie=g,te=Math.floor(e.domElement.width/ie),de=Math.floor(e.domElement.height/ie),fe=document.createElement("canvas");fe.width=te,fe.height=de,R.current=fe;const we=fe.captureStream(Kf);let pe,ge;L==="mp4"?MediaRecorder.isTypeSupported("video/mp4;codecs=avc1")?(pe="video/mp4;codecs=avc1",ge="video/mp4"):MediaRecorder.isTypeSupported("video/mp4")?(pe="video/mp4",ge="video/mp4"):(console.warn("MP4 not supported, falling back to WebM"),pe=MediaRecorder.isTypeSupported("video/webm;codecs=vp9")?"video/webm;codecs=vp9":"video/webm",ge="video/webm"):(pe=MediaRecorder.isTypeSupported("video/webm;codecs=vp9")?"video/webm;codecs=vp9":"video/webm",ge="video/webm");const Re=lu[v],Le=new MediaRecorder(we,{mimeType:pe,videoBitsPerSecond:Re.bitrate});F.current=[],Le.ondataavailable=xe=>{xe.data.size>0&&F.current.push(xe.data)},Le.onstop=()=>{const xe=new Blob(F.current,{type:ge}),Ee=URL.createObjectURL(xe);f(Ee),u(!1),Z.current=!1,I.current=null,R.current=null,ee(xe)},I.current=Le,A.current=performance.now(),G.current=p*1e3,z.current=ee,U.current=y,D.current=0,Z.current=!0,Le.start(),u(!0)}),[e,u,f,p,g,y,v]),re=h.useCallback(()=>w==="webm"||w==="mp4"?K(w):Q(),[w,Q,K]);En(()=>{if(S.current){const ee=performance.now()-k.current;if(ee-j.current>=au){j.current=ee,e.render(t,n);const ie=E.current,te=document.createElement("canvas");te.width=Math.floor(e.domElement.width/ie),te.height=Math.floor(e.domElement.height/ie);const de=te.getContext("2d");de.imageSmoothingEnabled=!0,de.imageSmoothingQuality="high",de.drawImage(e.domElement,0,0,te.width,te.height),T(te,l);const fe=Math.round(au/P.current);S.current.addFrame(te,{delay:fe,copy:!0})}if(ee>=M.current){const ie=S.current;S.current=null,ie.render()}}if(Z.current&&R.current&&I.current){const ee=performance.now()-A.current;e.render(t,n);const ie=R.current.getContext("2d");ie.imageSmoothingEnabled=!0,ie.imageSmoothingQuality="high",ie.drawImage(e.domElement,0,0,R.current.width,R.current.height),T(R.current,l),ee>=G.current&&I.current.stop()}}),h.useEffect(()=>(d(re),()=>d(null)),[re,d]);const J=h.useCallback((L,ee,ie)=>{T(L,ie);const te=`image/${ee}`,de=ee==="jpeg"?"jpg":ee,fe=ee==="jpeg"?.92:void 0,we=document.createElement("a");we.download=`colmap-view-${new Date().toISOString().slice(0,19).replace(/[:-]/g,"")}.${de}`,we.href=L.toDataURL(te,fe),we.click()},[T]);return h.useEffect(()=>{if(s>0&&s!==x.current){x.current=s;let L=o.width,ee=o.height;if(a!=="current"){const[ie,te]=a.split("x").map(Number);L=ie,ee=te}if(a!=="current"){const ie=new $h(L,ee,{format:Uh,type:Bh}),te=n.clone();te.aspect=L/ee,te.updateProjectionMatrix(),e.setRenderTarget(ie),e.render(t,te),e.setRenderTarget(null);const de=new Uint8Array(L*ee*4);e.readRenderTargetPixels(ie,0,0,L,ee,de);const fe=document.createElement("canvas");fe.width=L,fe.height=ee;const we=fe.getContext("2d"),pe=we.createImageData(L,ee),ge=L*4;for(let Re=0;Re<ee;Re++){const Le=(ee-1-Re)*ge,xe=Re*ge;pe.data.set(de.subarray(Le,Le+ge),xe)}we.putImageData(pe,0,0),J(fe,i,l),ie.dispose()}else{e.render(t,n);const ie=document.createElement("canvas");ie.width=e.domElement.width,ie.height=e.domElement.height,ie.getContext("2d").drawImage(e.domElement,0,0),J(ie,i,l)}}},[s,a,i,l,e,t,n,o,J]),null}function nS(){const e=q(o=>o.setFps),t=h.useRef(0),n=h.useRef(performance.now());return En(()=>{t.current++;const o=performance.now(),s=o-n.current;if(s>=500){const a=Math.round(t.current/s*1e3);e(a),t.current=0,n.current=o}}),null}function oS(){return r.jsxs(r.Fragment,{children:[r.jsx("a",{href:"https://opsiclear.com",target:"_blank",rel:"noopener noreferrer",className:Lo.logo,draggable:!1,children:r.jsx("img",{src:bo("LOGO.png"),alt:"Opsiclear",className:Lo.logoImage,style:{height:io.logoHeight},draggable:!1})}),r.jsxs("div",{className:Lo.socialContainer,children:[r.jsx("a",{href:"https://x.com/OpsiClear",target:"_blank",rel:"noopener noreferrer",className:Lo.socialLink,children:r.jsx("svg",{className:tt.socialSm,viewBox:"0 0 24 24",fill:"currentColor",children:r.jsx("path",{d:"M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"})})}),r.jsx("a",{href:"https://www.linkedin.com/company/opsiclear",target:"_blank",rel:"noopener noreferrer",className:Lo.socialLink,children:r.jsx("svg",{className:tt.social,viewBox:"0 0 24 24",fill:"currentColor",children:r.jsx("path",{d:"M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433a2.062 2.062 0 01-2.063-2.065 2.064 2.064 0 112.063 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"})})}),r.jsx("a",{href:"https://github.com/ColmapView/colmapview.github.io",target:"_blank",rel:"noopener noreferrer",className:Lo.socialLink,children:r.jsx("svg",{className:tt.social,viewBox:"0 0 24 24",fill:"currentColor",children:r.jsx("path",{d:"M12 0C5.37 0 0 5.37 0 12c0 5.31 3.435 9.795 8.205 11.385.6.105.825-.255.825-.57 0-.285-.015-1.23-.015-2.235-3.015.555-3.795-.735-4.035-1.41-.135-.345-.72-1.41-1.23-1.695-.42-.225-1.02-.78-.015-.795.945-.015 1.62.87 1.845 1.23 1.08 1.815 2.805 1.305 3.495.99.105-.78.42-1.305.765-1.605-2.67-.3-5.46-1.335-5.46-5.925 0-1.305.465-2.385 1.23-3.225-.12-.3-.54-1.53.12-3.18 0 0 1.005-.315 3.3 1.23.96-.27 1.98-.405 3-.405s2.04.135 3 .405c2.295-1.56 3.3-1.23 3.3-1.23.66 1.65.24 2.88.12 3.18.765.84 1.23 1.905 1.23 3.225 0 4.605-2.805 5.625-5.475 5.925.435.375.81 1.095.81 2.22 0 1.605-.015 2.895-.015 3.3 0 .315.225.69.825.57A12.02 12.02 0 0024 12c0-6.63-5.37-12-12-12z"})})})]})]})}const rS={view:"View & Navigation",display:"Display & Points",cameras:"Cameras",transform:"Transform",export:"Export",menu:"Menu"},Ga=[{id:"resetView",label:"Reset View",section:"view",hotkey:Se.resetView.keys,icon:r.jsx($s,{})},{id:"viewPosX",label:"View +X",section:"view",hotkey:Se.viewX.keys,icon:$2},{id:"viewPosY",label:"View +Y",section:"view",hotkey:Se.viewY.keys,icon:B2},{id:"viewPosZ",label:"View +Z",section:"view",hotkey:Se.viewZ.keys,icon:U2},{id:"toggleFullscreen",label:"Fullscreen",section:"view",hotkey:"F11",icon:r.jsx(Q1,{})},{id:"toggleProjection",label:"Persp/Ortho",section:"view",icon:W2},{id:"toggleCameraMode",label:"Camera Mode",section:"view",hotkey:Se.toggleCameraMode.keys,icon:H2},{id:"toggleHorizonLock",label:"Horizon Lock",section:"view",icon:Z2},{id:"cycleAutoRotate",label:"Auto Rotate",section:"view",icon:V2},{id:"toggleBackground",label:"Background",section:"display",hotkey:Se.toggleBackground.keys,icon:r.jsx(Ef,{})},{id:"toggleAxes",label:"Toggle Axes",section:"display",icon:r.jsx(Mf,{})},{id:"toggleGallery",label:"Gallery Panel",section:"display",icon:G2},{id:"cycleCoordinateSystem",label:"Coord System",section:"display",icon:Y2},{id:"cycleFrustumColor",label:"Frustum Color",section:"display",icon:q2},{id:"cyclePointColor",label:"Point Color",section:"display",hotkey:Se.cyclePointSize.keys,icon:X2},{id:"pointSizeUp",label:"Point Size +",section:"display",icon:r.jsx(n2,{})},{id:"pointSizeDown",label:"Point Size -",section:"display",icon:r.jsx(o2,{})},{id:"togglePointFiltering",label:"Min Track",section:"display",icon:r.jsx(J1,{})},{id:"cycleCameraDisplay",label:"Camera Display",section:"cameras",hotkey:Se.cycleCameraDisplay.keys,icon:r.jsx(If,{})},{id:"cycleMatchesDisplay",label:"Matches",section:"cameras",hotkey:Se.cycleMatchesDisplay.keys,icon:K2},{id:"cycleSelectionColor",label:"Selection Color",section:"cameras",icon:Q2},{id:"deselectAll",label:"Deselect All",section:"cameras",icon:J2},{id:"flyToSelected",label:"Fly to Selected",section:"cameras",icon:r.jsx(s2,{})},{id:"toggleImagePlanes",label:"Image Planes",section:"cameras",icon:eC},{id:"toggleUndistort",label:"Undistort",section:"cameras",icon:tC},{id:"toggleGizmo",label:"Transform Gizmo",section:"transform",hotkey:Se.toggleGizmo.keys,icon:r.jsx(jf,{})},{id:"centerAtOrigin",label:"Center at Origin",section:"transform",icon:nC},{id:"onePointOrigin",label:"1-Point Origin",section:"transform",icon:oC},{id:"twoPointScale",label:"2-Point Scale",section:"transform",icon:rC},{id:"threePointAlign",label:"3-Point Align",section:"transform",icon:sC},{id:"resetTransform",label:"Reset Transform",section:"transform",icon:r.jsx($s,{})},{id:"applyTransform",label:"Apply Transform",section:"transform",icon:r.jsx(yo,{})},{id:"reloadData",label:"Reload Data",section:"transform",icon:r.jsx(Cf,{})},{id:"takeScreenshot",label:"Screenshot",section:"export",icon:r.jsx(Sf,{})},{id:"exportPLY",label:"Export PLY",section:"export",icon:iC},{id:"exportConfig",label:"Export Config",section:"export",icon:aC},{id:"togglePointerLock",label:"Pointer Lock",section:"view",icon:r.jsx(r2,{})},{id:"flySpeedUp",label:"Fly Speed +",section:"view",icon:r.jsx(e2,{})},{id:"flySpeedDown",label:"Fly Speed -",section:"view",icon:r.jsx(t2,{})},{id:"editMenu",label:"Edit Menu...",section:"menu",icon:r.jsx(kf,{})}];function cu(e){return Ga.find(t=>t.id===e)}const sS=Ga.filter(e=>e.id!=="editMenu");function iS(){const e=h.useRef(null),t=h.useRef(null),[n,o]=h.useState(null),s=q(_=>_.contextMenuPosition),a=q(_=>_.contextMenuActions),i=q(_=>_.closeContextMenu),l=q(_=>_.addContextMenuAction),c=q(_=>_.removeContextMenuAction),d=q(_=>_.showContextMenuEditor),u=q(_=>_.openContextMenuEditor),f=q(_=>_.closeContextMenuEditor),p=q(_=>_.setView),g=q(_=>_.resetView),y=q(_=>_.backgroundColor),v=q(_=>_.setBackgroundColor),w=q(_=>_.toggleAxes),x=q(_=>_.axesCoordinateSystem),m=q(_=>_.setAxesCoordinateSystem),S=q(_=>_.axisLabelMode),k=q(_=>_.setAxisLabelMode),j=q(_=>_.toggleGalleryCollapsed),b=q(_=>_.galleryCollapsed),M=q(_=>_.toggleGizmo),E=q(_=>_.showMatches),P=q(_=>_.setShowMatches),I=q(_=>_.matchesDisplayMode),R=q(_=>_.setMatchesDisplayMode),A=B(_=>_.cameraProjection),G=B(_=>_.setCameraProjection),F=B(_=>_.cameraMode),z=B(_=>_.setCameraMode),Z=B(_=>_.horizonLock),U=B(_=>_.setHorizonLock),D=B(_=>_.autoRotateMode),T=B(_=>_.setAutoRotateMode),$=B(_=>_.showCameras),Q=B(_=>_.setShowCameras),K=B(_=>_.cameraDisplayMode),re=B(_=>_.setCameraDisplayMode),J=B(_=>_.showSelectionHighlight),L=B(_=>_.setShowSelectionHighlight),ee=B(_=>_.selectionColorMode),ie=B(_=>_.setSelectionColorMode),te=B(_=>_.frustumColorMode),de=B(_=>_.setFrustumColorMode),fe=B(_=>_.selectedImageId),we=B(_=>_.setSelectedImageId),pe=B(_=>_.flyToImage),ge=B(_=>_.pointerLock),Re=B(_=>_.setPointerLock),Le=B(_=>_.flySpeed),xe=B(_=>_.setFlySpeed),Ee=B(_=>_.undistortionEnabled),ke=B(_=>_.setUndistortionEnabled),W=Qe(_=>_.showPointCloud),me=Qe(_=>_.setShowPointCloud),H=Qe(_=>_.colorMode),ne=Qe(_=>_.setColorMode),le=Qe(_=>_.pointSize),_e=Qe(_=>_.setPointSize),qe=Qe(_=>_.minTrackLength),et=Qe(_=>_.setMinTrackLength),Ue=Lt(_=>_.resetTransform),Jt=ye(_=>_.droppedFiles),{processFiles:en}=Dr(),O=He(_=>_.takeScreenshot),Ae=He(_=>_.setExportFormat),De=He(_=>_.triggerExport),We=Ve(_=>_.pickingMode),ze=Ve(_=>_.setPickingMode),rt=["colmap","opencv","threejs","opengl","blender","unity","unreal"],Y=["off","xyz","extra"],be=["single","byCamera"],he=["toggleProjection","toggleCameraMode","toggleHorizonLock","cycleAutoRotate","toggleBackground","toggleAxes","toggleGallery","cycleCoordinateSystem","cycleFrustumColor","cyclePointColor","pointSizeUp","pointSizeDown","togglePointFiltering","cycleCameraDisplay","cycleMatchesDisplay","cycleSelectionColor","toggleImagePlanes","toggleUndistort","toggleGizmo","togglePointerLock","flySpeedUp","flySpeedDown"],Ie=h.useCallback(_=>{switch(_){case"resetView":g(),G("perspective");break;case"viewPosX":p("x");break;case"viewPosY":p("y");break;case"viewPosZ":p("z");break;case"toggleFullscreen":document.fullscreenElement?document.exitFullscreen():document.documentElement.requestFullscreen();break;case"toggleProjection":{const Te=(hs.indexOf(A)+1)%hs.length;G(hs[Te]);break}case"toggleCameraMode":{const Te=(fs.indexOf(F)+1)%fs.length;z(fs[Te]);break}case"toggleHorizonLock":{const Te=(ps.indexOf(Z)+1)%ps.length;U(ps[Te]);break}case"cycleAutoRotate":{const Te=(ms.indexOf(D)+1)%ms.length;T(ms[Te]);break}case"toggleBackground":{v(y==="#ffffff"||y==="#fff"?"#000000":"#ffffff");break}case"toggleAxes":w();break;case"toggleGallery":j();break;case"cycleAxisLabels":{const Te=(Y.indexOf(S)+1)%Y.length;k(Y[Te]);break}case"cycleCoordinateSystem":{const Te=(rt.indexOf(x)+1)%rt.length;m(rt[Te]);break}case"cycleFrustumColor":{const Te=(be.indexOf(te)+1)%be.length;de(be[Te]);break}case"cyclePointColor":{W?H==="rgb"?ne("error"):H==="error"?ne("trackLength"):me(!1):(me(!0),ne("rgb"));break}case"pointSizeUp":_e(Math.min(le+1,20));break;case"pointSizeDown":_e(Math.max(le-1,1));break;case"togglePointFiltering":et(qe===2?3:2);break;case"cycleCameraDisplay":{const Te=(gs.indexOf(K)+1)%gs.length;re(gs[Te]);break}case"cycleMatchesDisplay":{E?I==="on"?R("blink"):P(!1):(P(!0),R("on"));break}case"cycleSelectionColor":{if(!J)L(!0),ie("static");else{const Be=xs.indexOf(ee);Be===xs.length-1?L(!1):ie(xs[Be+1])}break}case"deselectAll":we(null);break;case"flyToSelected":fe!==null&&pe(fe);break;case"toggleImagePlanes":{$?K==="frustum"?re("imageplane"):Q(!1):(Q(!0),re("frustum"));break}case"toggleUndistort":ke(!Ee);break;case"toggleGizmo":M();break;case"centerAtOrigin":cd();break;case"onePointOrigin":ze(We==="origin-1pt"?"off":"origin-1pt");break;case"twoPointScale":ze(We==="distance-2pt"?"off":"distance-2pt");break;case"threePointAlign":ze(We==="normal-3pt"?"off":"normal-3pt");break;case"resetTransform":Ue();break;case"applyTransform":Sr();break;case"reloadData":Jt&&(Ue(),en(Jt));break;case"takeScreenshot":O();break;case"exportPLY":Ae("ply"),De();break;case"exportConfig":Ae("config"),De();break;case"togglePointerLock":Re(!ge);break;case"flySpeedUp":xe(Math.min(Le*1.5,20));break;case"flySpeedDown":xe(Math.max(Le/1.5,.5));break;case"editMenu":u();break}!he.includes(_)&&_!=="editMenu"&&i()},[g,p,A,G,F,z,Z,U,D,T,y,v,w,x,m,S,k,te,de,j,W,me,H,ne,le,_e,qe,et,K,re,E,P,I,R,J,L,ee,ie,fe,we,pe,Ee,ke,M,We,ze,Ue,Jt,en,O,Ae,De,ge,Re,Le,xe,i]),Oe=h.useCallback(_=>{a.includes(_)?c(_):l(_)},[a,l,c]),ce=h.useCallback(()=>{f(),i()},[i,f]);if(h.useEffect(()=>{if(!s&&!d)return;const _=dt=>{const ft=dt.target,Ye=e.current&&!e.current.contains(ft),$t=t.current&&!t.current.contains(ft);d?$t&&ce():Ye&&i()},Be=dt=>{dt.key==="Escape"&&(d?ce():i())},Te=setTimeout(()=>{document.addEventListener("mousedown",_),document.addEventListener("keydown",Be)},0);return()=>{clearTimeout(Te),document.removeEventListener("mousedown",_),document.removeEventListener("keydown",Be)}},[s,d,i,ce]),h.useLayoutEffect(()=>{if(!s||!e.current){o(null);return}const Be=e.current.getBoundingClientRect(),Te=window.innerHeight,dt=window.innerWidth,ft=8,Ye=Be.width>0?Be.width:200,$t=Be.height>0?Be.height:400,Pe=b?0:Math.max(dt*.3,300),Bt=dt-Pe;let Ut=s.x,tn=s.y;tn+$t>Te-ft&&(tn=s.y-$t,tn<ft&&(tn=ft)),Ut+Ye>Bt-ft&&(Ut=s.x-Ye,Ut<ft&&(Ut=ft)),o({x:Ut,y:tn})},[s,a,b]),!s&&!d)return null;const Ze=new Map(Ga.map((_,Be)=>[_.id,Be])),Je=a.map(_=>cu(_)).filter(_=>_!==void 0),Mt=["view","display","cameras","transform","export"],kt=Mt.map(_=>{const Be=Je.filter(Te=>Te.section===_);return Be.sort((Te,dt)=>(Ze.get(Te.id)??999)-(Ze.get(dt.id)??999)),{section:_,actions:Be}}).filter(_=>_.actions.length>0),Ne=cu("editMenu"),Xe=Mt.map(_=>({section:_,label:rS[_],actions:sS.filter(Be=>Be.section===_)})).filter(_=>_.actions.length>0);if(d){const _=Pe=>r.jsxs("label",{className:"flex items-center gap-2 cursor-pointer hover-ds-hover rounded px-2 py-1",style:{breakInside:"avoid"},children:[r.jsx("span",{className:"w-4 h-4 flex-shrink-0 opacity-60",children:Pe.icon}),r.jsx("span",{className:"text-sm text-ds-primary whitespace-nowrap",children:Pe.label}),Pe.hotkey&&r.jsxs("span",{className:"text-xs font-mono text-gray-500 uppercase tracking-wide",children:["(",Wi(Pe.hotkey),")"]}),r.jsx("span",{className:"ml-auto",children:r.jsx(Us,{checked:a.includes(Pe.id),onChange:()=>Oe(Pe.id)})})]},Pe.id),Be=(Pe,Bt=1)=>{const Ut=Math.ceil(Pe.actions.length/Bt),tn=[];for(let N=0;N<Bt;N++)tn.push(Pe.actions.slice(N*Ut,(N+1)*Ut));return r.jsxs("div",{className:"col-span-3",children:[r.jsx("div",{className:"text-xs font-medium text-ds-muted uppercase tracking-wide mb-1 px-1",children:Pe.label}),r.jsx("div",{className:"grid gap-x-4",style:{gridTemplateColumns:`repeat(${Bt}, minmax(180px, 1fr))`},children:tn.map((N,ae)=>r.jsx("div",{children:N.map(_)},ae))})]},Pe.section)},Te=Xe.find(Pe=>Pe.section==="view"),dt=Xe.find(Pe=>Pe.section==="display"),ft=Xe.find(Pe=>Pe.section==="cameras"),Ye=Xe.find(Pe=>Pe.section==="transform"),$t=Xe.find(Pe=>Pe.section==="export");return xa.createPortal(r.jsx("div",{className:"fixed inset-0 flex items-center justify-center",style:{backgroundColor:"rgba(0,0,0,0.5)",zIndex:1e4},children:r.jsxs("div",{ref:t,className:"bg-ds-tertiary rounded-lg shadow-ds-lg border border-ds context-menu-edit-responsive",style:{padding:"16px 24px"},children:[r.jsxs("div",{className:"flex items-center justify-between mb-2",children:[r.jsx("h3",{className:"text-ds-primary font-medium text-sm",children:"Edit Context Menu"}),r.jsx("button",{onClick:ce,className:"text-ds-muted hover-ds-text-primary transition-colors",children:r.jsx(bf,{className:"w-5 h-5"})})]}),r.jsx("div",{className:"text-ds-secondary text-xs mb-3",children:"Select which actions appear in the right-click menu."}),r.jsxs("div",{className:"grid grid-cols-3 gap-x-5 gap-y-3",children:[Te&&Be(Te,3),dt&&Be(dt,3),ft&&Be(ft,3),Ye&&Be(Ye,3),$t&&Be($t,3)]}),r.jsx("div",{className:"mt-4 pt-3 border-t border-ds",children:r.jsx("button",{onClick:ce,className:Yn.buttonFullWidth,children:"Done"})})]})}),document.body)}const St=n??s;return r.jsxs("div",{ref:e,className:at.container,style:{position:"fixed",left:St?.x??0,top:St?.y??0,zIndex:1050,minWidth:"160px",visibility:n?"visible":"hidden"},children:[kt.map((_,Be)=>r.jsxs("div",{children:[Be>0&&r.jsx("div",{className:"border-t border-ds my-1"}),_.actions.map(Te=>r.jsxs("button",{className:at.button,onClick:()=>Ie(Te.id),children:[r.jsx("span",{className:at.icon,children:Te.icon}),r.jsx("span",{className:"flex-1",children:Te.label}),Te.hotkey&&r.jsxs("span",{className:at.hotkey,children:["(",Wi(Te.hotkey),")"]})]},Te.id))]},_.section)),r.jsx("div",{className:"border-t border-ds my-1"}),r.jsxs("button",{className:at.button,onClick:()=>Ie("editMenu"),children:[r.jsx("span",{className:at.icon,children:Ne.icon}),Ne.label]})]})}function Ya(e){const t=e.message.toLowerCase(),n=e.name.toLowerCase();return t.includes("context lost")||t.includes("webgl")||t.includes("gl_")?"webgl_context_lost":t.includes("shader")||t.includes("render")||t.includes("draw")||t.includes("buffer")||t.includes("three")?"webgl_render_error":t.includes("image")||t.includes("load")||t.includes("decode")||t.includes("blob")?"image_load_error":n.includes("networkerror")||t.includes("fetch")||t.includes("network")||t.includes("timeout")||t.includes("cors")?"network_error":"unknown"}function aS(e){switch(e){case"webgl_context_lost":return"retry";case"webgl_render_error":return"reload";case"image_load_error":return"retry";case"network_error":return"retry";default:return"dismiss"}}const uu={webgl_context_lost:{title:"3D View Error",message:"The graphics context was lost. This can happen when the system is under heavy load or the browser tab was inactive for a while.",retryLabel:"Retry",reloadLabel:"Reload Page"},webgl_render_error:{title:"3D Rendering Error",message:"Failed to render the 3D scene. This may be due to an unsupported graphics feature or driver issue.",retryLabel:"Retry",reloadLabel:"Reload Page"},image_load_error:{title:"Image Loading Error",message:"Failed to load one or more images. Please check that the image files are accessible.",retryLabel:"Retry Loading"},network_error:{title:"Network Error",message:"Failed to connect to the server. Please check your internet connection and try again.",retryLabel:"Retry"},unknown:{title:"Something went wrong",message:"An unexpected error occurred. Please try again or reload the page.",retryLabel:"Retry",reloadLabel:"Reload Page"}};function Ko(e){return uu[e]??uu.unknown}const lS={modalError:"Modal closed due to an error. Click to reopen."};class cS extends h.Component{canvasRef=h.createRef();contextLostHandler=null;contextRestoredHandler=null;constructor(t){super(t),this.state={hasError:!1,error:null,errorType:null,retryCount:0}}static getDerivedStateFromError(t){const n=Ya(t);return{hasError:!0,error:t,errorType:n}}componentDidMount(){this.setupWebGLContextListeners()}componentDidUpdate(t){t.children!==this.props.children&&this.setupWebGLContextListeners()}componentWillUnmount(){this.cleanupWebGLContextListeners()}componentDidCatch(t,n){console.error("Scene3DErrorBoundary caught an error:",t,n)}setupWebGLContextListeners(){this.cleanupWebGLContextListeners();const t=this.canvasRef.current;if(!t)return;const n=t.querySelectorAll("canvas");n.length!==0&&(this.contextLostHandler=o=>{o.preventDefault(),console.warn("WebGL context lost"),this.setState({hasError:!0,error:new Error("WebGL context lost"),errorType:"webgl_context_lost"})},this.contextRestoredHandler=()=>{console.info("WebGL context restored"),this.handleRetry()},n.forEach(o=>{o.addEventListener("webglcontextlost",this.contextLostHandler),o.addEventListener("webglcontextrestored",this.contextRestoredHandler)}))}cleanupWebGLContextListeners(){const t=this.canvasRef.current;if(!t)return;t.querySelectorAll("canvas").forEach(o=>{this.contextLostHandler&&o.removeEventListener("webglcontextlost",this.contextLostHandler),this.contextRestoredHandler&&o.removeEventListener("webglcontextrestored",this.contextRestoredHandler)})}handleRetry=()=>{this.setState(t=>({hasError:!1,error:null,errorType:null,retryCount:t.retryCount+1}))};handleReload=()=>{window.location.reload()};render(){const{children:t,backgroundColor:n}=this.props,{hasError:o,error:s,errorType:a,retryCount:i}=this.state;if(o){const l=Ko(a||"webgl_render_error"),c=i>=2;return r.jsx("div",{className:"w-full h-full flex flex-col items-center justify-center",style:{backgroundColor:n??"var(--ds-secondary)"},children:r.jsxs("div",{className:"text-center max-w-md px-4",children:[r.jsx("div",{className:cn.icon,children:"!"}),r.jsx("h2",{className:cn.title,children:l.title}),r.jsx("p",{className:cn.message,children:s?.message??l.message}),c&&r.jsx("p",{className:"text-ds-warning text-sm mb-4",children:"Multiple retry attempts failed. Consider reloading the page."}),r.jsxs("div",{className:"flex gap-3 justify-center mt-4",children:[r.jsx("button",{onClick:this.handleRetry,className:cn.button,children:l.retryLabel??"Retry"}),r.jsx("button",{onClick:this.handleReload,className:`${ue.base} ${ue.sizes.md} ${ue.variants.ghost}`,children:l.reloadLabel??"Reload Page"})]})]})})}return r.jsx("div",{ref:this.canvasRef,className:"w-full h-full",children:t})}}function uS(){const e=Ve(I=>I.showDistanceModal),t=Ve(I=>I.modalPosition),n=Ve(I=>I.setShowDistanceModal),o=Ve(I=>I.selectedPoints),s=Ve(I=>I.setTargetDistance),a=Ve(I=>I.pickingMode),i=Ve(I=>I.clearSelectedPoints),l=Ve(I=>I.normalFlipped),c=Ve(I=>I.targetAxis),d=Ve(I=>I.reset),u=Lt(I=>I.transform),f=Lt(I=>I.setTransform),p=q(I=>I.axesCoordinateSystem),g=a==="origin-1pt",y=a==="normal-3pt",v=h.useMemo(()=>{const I=Qs[p],R=c.toLowerCase(),A=I[R];return new V(A[0],A[1],A[2])},[p,c]),[w,x]=h.useState(""),m=h.useRef(null),S=h.useRef(null),k=o.length===2?o[0].position.distanceTo(o[1].position):null,j=h.useMemo(()=>{if(!t)return{left:"50%",top:"50%",transform:"translate(-50%, -50%)"};const I=200,R=80,A=16,G=typeof window<"u"?window.innerWidth:1920,F=typeof window<"u"?window.innerHeight:1080;let z=t.x+8,Z=t.y-8;return z+I+A>G&&(z=t.x-I-20),Z+R+A>F&&(Z=F-R-A),Z<A&&(Z=A),z<A&&(z=A),{left:`${z}px`,top:`${Z}px`,transform:"none"}},[t]);h.useEffect(()=>{e&&m.current&&setTimeout(()=>{m.current?.focus(),m.current?.select()},50)},[e]),h.useEffect(()=>{e&&k!==null&&x(k.toFixed(4))},[e]);const b=h.useCallback(()=>{n(!1),d()},[n,d]);lt("escape",()=>b(),{enabled:e},[e,b]);const M=h.useCallback(()=>{n(!1),i()},[n,i]),E=h.useCallback(()=>{if(g){if(o.length!==1)return;const I=tp(o[0].position),R=zn(u),A=Uo(I,R),G=Bo(A);f(G),n(!1),d()}else if(y){if(o.length!==3)return;const I=np(o[0].position,o[1].position,o[2].position,l,v),R=zn(u),A=Uo(I,R),G=Bo(A);f(G),n(!1),d()}else{const I=parseFloat(w);if(isNaN(I)||I<=0||o.length!==2)return;const R=ep(o[0].position,o[1].position,I),A=zn(u),G=Uo(R,A),F=Bo(G);f(F),s(I),n(!1),d()}},[g,y,w,o,l,u,f,s,n,d,v]),P=h.useCallback(I=>{I.key==="Enter"&&E()},[E]);return e?r.jsx("div",{ref:S,className:"fixed z-[1100] bg-ds-tertiary border border-ds rounded shadow-ds-lg p-1",style:j,children:r.jsxs("div",{className:"flex items-center gap-0.5",children:[!g&&!y&&r.jsx("input",{ref:m,type:"text",value:w,onChange:I=>x(I.target.value),onKeyDown:P,className:`${Vn.valueInput} w-14 font-mono`,title:"Target distance"}),r.jsx("button",{onClick:E,className:jn.iconButtonConfirm,title:"Confirm",children:r.jsx("svg",{className:"w-3.5 h-3.5",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2.5",children:r.jsx("path",{d:"M20 6L9 17l-5-5"})})}),r.jsx("button",{onClick:M,className:jn.iconButtonRetry,title:"Retry",children:r.jsxs("svg",{className:"w-3.5 h-3.5",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2.5",children:[r.jsx("path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"}),r.jsx("path",{d:"M3 3v5h5"})]})}),r.jsx("button",{onClick:b,className:jn.iconButtonCancel,title:"Cancel",children:r.jsx("svg",{className:"w-3.5 h-3.5",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2.5",children:r.jsx("path",{d:"M18 6L6 18M6 6l12 12"})})})]})}):null}function dS(e,t,n){const o=new V(e[0],e[1],e[2]).normalize(),s=new V(t[0],t[1],t[2]),a=new ut;a.setFromUnitVectors(o,n);const l=s.clone().applyQuaternion(a).dot(n),c=n.clone().multiplyScalar(-l);return{rotation:a,translation:c,scale:1}}function fS(){const e=Ge(b=>b.showFloorModal),t=Ge(b=>b.modalPosition),n=Ge(b=>b.setShowFloorModal),o=Ge(b=>b.detectedPlane),s=Ge(b=>b.setDetectedPlane),a=Ge(b=>b.normalFlipped),i=Ge(b=>b.targetAxis),l=Ge(b=>b.distanceThreshold),c=Ge(b=>b.maxIterations),d=Ge(b=>b.sampleCount),u=Ge(b=>b.setPointDistances),f=Ge(b=>b.setIsDetecting),p=Ge(b=>b.reset),g=Lt(b=>b.transform),y=Lt(b=>b.setTransform),v=q(b=>b.axesCoordinateSystem),w=ye(b=>b.wasmReconstruction),x=h.useMemo(()=>{const b=Qs[v],M=i.toLowerCase(),E=b[M];return new V(E[0],E[1],E[2])},[v,i]),m=h.useMemo(()=>{if(!t)return{left:"50%",top:"50%",transform:"translate(-50%, -50%)"};const b=120,M=40,E=16,P=typeof window<"u"?window.innerWidth:1920,I=typeof window<"u"?window.innerHeight:1080;let R=t.x+8,A=t.y-8;return R+b+E>P&&(R=t.x-b-20),A+M+E>I&&(A=I-M-E),A<E&&(A=E),R<E&&(R=E),{left:`${R}px`,top:`${A}px`,transform:"none"}},[t]),S=h.useCallback(()=>{n(!1),p()},[n,p]);lt("escape",()=>S(),{enabled:e},[e,S]);const k=h.useCallback(()=>{w?.hasPoints()&&(f(!0),setTimeout(()=>{let b=w.getPositions();if(!b){f(!1);return}if(!jo(g)){const E=zn(g);b=Bf(b,E)}const M=zf(b,{distanceThreshold:l,maxIterations:c,sampleCount:d});if(s(M),M){const E=Of(b,M);u(E)}else u(null);f(!1)},10))},[w,l,c,d,g,s,u,f]),j=h.useCallback(()=>{if(!o)return;const b=a?$f(o):o,M=dS(b.normal,b.centroid,x),E=zn(g),P=Uo(M,E),I=Bo(P);y(I),n(!1),p()},[o,a,x,g,y,n,p]);return!e||!o?null:r.jsx("div",{className:"fixed z-[1100] bg-ds-tertiary border border-ds rounded shadow-ds-lg p-1",style:m,children:r.jsxs("div",{className:"flex items-center gap-0.5",children:[r.jsx("button",{onClick:j,className:jn.iconButtonConfirm,title:"Apply alignment",children:r.jsx("svg",{className:"w-3.5 h-3.5",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2.5",children:r.jsx("path",{d:"M20 6L9 17l-5-5"})})}),r.jsx("button",{onClick:k,className:jn.iconButtonRetry,title:"Re-detect floor",children:r.jsxs("svg",{className:"w-3.5 h-3.5",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2.5",children:[r.jsx("path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"}),r.jsx("path",{d:"M3 3v5h5"})]})}),r.jsx("button",{onClick:S,className:jn.iconButtonCancel,title:"Cancel",children:r.jsx("svg",{className:"w-3.5 h-3.5",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2.5",children:r.jsx("path",{d:"M18 6L6 18M6 6l12 12"})})})]})})}function hS(){const e=ye(m=>m.reconstruction),t=ye(m=>m.wasmReconstruction),n=Rf(),o=h.useMemo(()=>{if(!e)return{center:[0,0,0],radius:5};const m=Array.from(e.images.values());if(m.length>0){const S=[],k=[],j=[];for(const F of m){const z=Zo(F);S.push(z.x),k.push(z.y),j.push(z.z)}const b=[$o(S),$o(k),$o(j)],M=[...S].sort((F,z)=>F-z),E=[...k].sort((F,z)=>F-z),P=[...j].sort((F,z)=>F-z),I=fo(M,95)-fo(M,5),R=fo(E,95)-fo(E,5),A=fo(P,95)-fo(P,5),G=Math.max(I,R,A,.001)/2;return{center:b,radius:G}}if(t?.hasPoints()){const S=t.getBoundingBox();if(S){const k=[(S.minX+S.maxX)/2,(S.minY+S.maxY)/2,(S.minZ+S.maxZ)/2],j=Math.max(S.maxX-S.minX,S.maxY-S.minY,S.maxZ-S.minZ)/2;return{center:k,radius:Math.max(j,.001)}}}if(e.points3D&&e.points3D.size>0){let S=1/0,k=-1/0,j=1/0,b=-1/0,M=1/0,E=-1/0;for(const R of e.points3D.values())S=Math.min(S,R.xyz[0]),k=Math.max(k,R.xyz[0]),j=Math.min(j,R.xyz[1]),b=Math.max(b,R.xyz[1]),M=Math.min(M,R.xyz[2]),E=Math.max(E,R.xyz[2]);const P=[(S+k)/2,(j+b)/2,(M+E)/2],I=Math.max(k-S,b-j,E-M)/2;return{center:P,radius:I}}return{center:[0,0,0],radius:5}},[e,t]),s=B(m=>m.showCameras),a=q(m=>m.showAxes),i=q(m=>m.showGrid),l=q(m=>m.axesCoordinateSystem),c=q(m=>m.axesScale),d=q(m=>m.gridScale),u=q(m=>m.axisLabelMode),f=q(m=>m.showGizmo),p=q(m=>m.viewResetTrigger),g=q(m=>m.viewDirection),y=q(m=>m.viewTrigger),v=Lt(m=>m.transform),{transformMatrix:w,transformedCenter:x}=h.useMemo(()=>{if(jo(v))return{transformMatrix:null,transformedCenter:o.center};const m=zn(v),S=Jm(m),k=Ru(m,o.center);return{transformMatrix:S,transformedCenter:k}},[v,o.center]);return r.jsxs(r.Fragment,{children:[r.jsx("ambientLight",{intensity:Ms.light.ambient}),r.jsx("directionalLight",{position:[10,10,5],intensity:Ms.light.directional}),w?r.jsxs("group",{matrixAutoUpdate:!1,matrix:w,children:[r.jsx(Fc,{}),!n&&s&&r.jsx(Gc,{}),!n&&s&&r.jsx(Yc,{}),!n&&s&&r.jsx(qc,{})]}):r.jsxs(r.Fragment,{children:[r.jsx(Fc,{}),!n&&s&&r.jsx(Gc,{}),!n&&s&&r.jsx(Yc,{}),!n&&s&&r.jsx(qc,{})]}),r.jsxs(h.Suspense,{fallback:null,children:[(a||n)&&r.jsx(Ok,{size:o.radius*c,scale:c,coordinateSystem:l,labelMode:u}),i&&r.jsx($k,{size:o.radius,scale:d})]}),!n&&e&&f&&r.jsx(Bk,{center:x,size:o.radius*v.scale*c}),r.jsx(Gk,{}),r.jsx(qk,{boundsRadius:o.radius}),r.jsx(Ak,{target:o.center,radius:o.radius,resetTrigger:p,viewDirection:g,viewTrigger:y})]})}function mS(){return r.jsxs("mesh",{children:[r.jsx("boxGeometry",{args:[1,1,1]}),r.jsx("meshBasicMaterial",{color:_t.wireframe,wireframe:!0})]})}function pS({color:e}){const{scene:t,invalidate:n}=In();return h.useEffect(()=>{t.background=new $n(e),n()},[t,e,n]),null}function gS(){const e=ye(x=>x.reconstruction),t=q(x=>x.backgroundColor),n=B(x=>x.setSelectedImageId),o=q(x=>x.openContextMenu),s=q(x=>x.closeContextMenu),a=Ve(x=>x.pickingMode),i=Ve(x=>x.selectedPoints.length),l=Ve(x=>x.removeLastPoint),c=Ve(x=>x.reset),d=Ve(x=>x.markerRightClickHandled),u=h.useRef(null),f=5,p=ye(x=>x.wasmReconstruction),g=h.useMemo(()=>{if(p?.hasPoints()){const m=p.getBoundingBox();if(m)return[0,0,Math.max(Math.abs(m.minX),Math.abs(m.maxX),Math.abs(m.minY),Math.abs(m.maxY),Math.abs(m.minZ),Math.abs(m.maxZ))*2]}if(!e||!e.points3D||e.points3D.size===0)return[0,0,5];let x=0;for(const m of e.points3D.values()){const S=Math.sqrt(m.xyz[0]**2+m.xyz[1]**2+m.xyz[2]**2);x=Math.max(x,S)}return[0,0,x*2]},[e,p]),y=h.useCallback(x=>{if(u.current){const m=Math.abs(x.clientX-u.current.x),S=Math.abs(x.clientY-u.current.y);if(m>f||S>f)return}if(x.preventDefault(),a!=="off"){if(d){Ve.setState({markerRightClickHandled:!1});return}i>0?l():c();return}o(x.clientX,x.clientY)},[o,a,i,l,c,d]),v=h.useCallback(x=>{x.button===2&&(u.current={x:x.clientX,y:x.clientY},s())},[s]),w=h.useCallback(()=>{setTimeout(()=>{u.current=null},0)},[]);return r.jsxs("div",{className:"w-full h-full relative isolate",style:{backgroundColor:t},onContextMenu:y,onMouseDown:v,onMouseUp:w,children:[r.jsx(cS,{backgroundColor:t,children:r.jsxs(Wh,{camera:{position:g,fov:ln.fov,near:ln.nearPlane,far:ln.farPlane},gl:{antialias:!0},onPointerMissed:x=>{(x.button===0||x.button===2)&&n(null)},children:[r.jsx(pS,{color:t}),r.jsx(nS,{}),r.jsx(tS,{}),r.jsx(h.Suspense,{fallback:r.jsx(mS,{}),children:r.jsx(hS,{})})]})}),r.jsx(Pk,{}),r.jsx(oS,{}),r.jsx(Kk,{}),r.jsx(iS,{}),r.jsx(uS,{}),r.jsx(fS,{})]})}function xS({className:e}){return r.jsxs("svg",{className:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[r.jsx("rect",{x:"3",y:"3",width:"7",height:"7"}),r.jsx("rect",{x:"14",y:"3",width:"7",height:"7"}),r.jsx("rect",{x:"3",y:"14",width:"7",height:"7"}),r.jsx("rect",{x:"14",y:"14",width:"7",height:"7"})]})}function yS({className:e}){return r.jsxs("svg",{className:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[r.jsx("rect",{x:"3",y:"4",width:"4",height:"4"}),r.jsx("line",{x1:"10",y1:"6",x2:"21",y2:"6"}),r.jsx("rect",{x:"3",y:"10",width:"4",height:"4"}),r.jsx("line",{x1:"10",y1:"12",x2:"21",y2:"12"}),r.jsx("rect",{x:"3",y:"16",width:"4",height:"4"}),r.jsx("line",{x1:"10",y1:"18",x2:"21",y2:"18"})]})}function vS({className:e}){return r.jsx("svg",{className:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:r.jsx("path",{d:"M12 5v14M5 12l7-7 7 7"})})}function wS({className:e}){return r.jsx("svg",{className:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:r.jsx("path",{d:"M12 5v14M5 12l7 7 7-7"})})}const bS=h.memo(function({img:t,isSelected:n,isMatched:o,matchesColor:s,matchesBlink:a,onClick:i,onDoubleClick:l,onRightClick:c,isScrolling:d,skipImages:u,isSettling:f,isResizing:p,wouldGoBack:g}){const y=Bu(t.file,t.name,!d&&!u&&!f&&!p),[v,w]=h.useState(!1),[x,m]=h.useState(null);h.useEffect(()=>{d&&v&&(w(!1),m(null),document.body.style.cursor="")},[d,v]);const S=()=>{n?l(t.imageId):i(t.imageId)},k=n?Wn.itemSelected:o?`${a?"matches-blink":""}`:Wn.itemHover,j=o&&!n?{borderColor:s}:{};return r.jsxs("div",{className:`${Wn.itemAspect} group ${Wn.item} ${k}`,style:{position:"relative",...j},onClick:S,onContextMenu:b=>{b.preventDefault(),c(t.imageId)},onPointerOver:b=>{w(!0),m({x:b.clientX,y:b.clientY}),document.body.style.cursor="pointer"},onPointerMove:b=>{v&&m({x:b.clientX,y:b.clientY})},onPointerOut:()=>{w(!1),m(null),document.body.style.cursor=""},children:[r.jsxs("div",{className:Wn.itemInner,children:[y?r.jsx("img",{src:y,alt:t.name,className:Wn.itemImage,draggable:!1}):r.jsx("div",{className:Wn.placeholder,children:d?"...":t.name}),!n&&r.jsx("div",{className:"absolute inset-0 pointer-events-none z-10",style:{background:`
                radial-gradient(
                  ellipse 100% 100% at center,
                  transparent 20%,
                  rgba(0,0,0,0.15) 40%,
                  rgba(0,0,0,0.4) 60%,
                  rgba(0,0,0,0.7) 80%,
                  rgba(0,0,0,0.9) 100%
                )
              `}})]}),r.jsx("div",{className:`${Wn.overlay} z-20`,children:r.jsx("div",{className:Wn.overlayText,children:t.name})}),v&&x&&xa.createPortal(r.jsx("div",{style:{position:"fixed",left:x.x+12,top:x.y+12,pointerEvents:"none",zIndex:9999},children:r.jsxs("div",{className:se.container,children:[r.jsx("div",{className:se.title,children:t.name}),r.jsxs("div",{className:se.subtitle,children:["#",t.imageId]}),r.jsxs("div",{className:se.subtitle,children:[t.numPoints3D," 3D points"]}),r.jsxs("div",{className:se.subtitle,children:[t.numPoints2D," 2D points"]}),r.jsxs("div",{className:se.subtitle,children:[t.covisibleCount," covisible"]}),r.jsxs("div",{className:se.subtitle,children:[t.avgError.toFixed(2)," avg error"]}),r.jsxs("div",{className:se.hint,children:[r.jsxs("div",{className:se.hintRow,children:[r.jsxs("svg",{className:tt.hoverCard,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[r.jsx("rect",{x:"6",y:"2",width:"12",height:"20",rx:"6"}),r.jsx("path",{d:"M12 2v8"}),r.jsx("rect",{x:"6",y:"2",width:"6",height:"8",rx:"3",fill:"currentColor",opacity:"0.5"})]}),n?"Left: details":"Left: select"]}),r.jsxs("div",{className:se.hintRow,children:[r.jsxs("svg",{className:tt.hoverCard,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[r.jsx("rect",{x:"6",y:"2",width:"12",height:"20",rx:"6"}),r.jsx("path",{d:"M12 2v8"}),r.jsx("rect",{x:"12",y:"2",width:"6",height:"8",rx:"3",fill:"currentColor",opacity:"0.5"})]}),o?"Right: matches":g?"Right: back":"Right: fly to"]})]})]})}),document.body)]})}),CS=h.memo(function({img:t,isSelected:n,isMatched:o,matchesColor:s,matchesBlink:a,onClick:i,onDoubleClick:l,onRightClick:c,isScrolling:d,skipImages:u,isSettling:f,isResizing:p,wouldGoBack:g}){const y=Bu(t.file,t.name,!d&&!u&&!f&&!p),[v,w]=h.useState(!1),[x,m]=h.useState(null);h.useEffect(()=>{d&&v&&(w(!1),m(null),document.body.style.cursor="")},[d,v]);const S=()=>{n?l(t.imageId):i(t.imageId)},k=n?Hn.itemSelected:o?`${a?"matches-blink":""}`:Hn.itemHover,j=o&&!n?{borderColor:s}:{};return r.jsxs("div",{onClick:S,onContextMenu:b=>{b.preventDefault(),c(t.imageId)},onPointerOver:b=>{w(!0),m({x:b.clientX,y:b.clientY}),document.body.style.cursor="pointer"},onPointerMove:b=>{v&&m({x:b.clientX,y:b.clientY})},onPointerOut:()=>{w(!1),m(null),document.body.style.cursor=""},style:{height:io.listRowHeight,...j},className:`${Hn.item} px-3 list-stats-container ${k}`,children:[r.jsx("div",{className:`${Hn.thumbnail} ${Hn.thumbnailSize}`,children:y?r.jsx("img",{src:y,alt:t.name,className:"w-full h-full object-cover",draggable:!1}):r.jsx("div",{className:Hn.thumbnailPlaceholder,children:t.imageId})}),r.jsxs("div",{className:Hn.content,children:[r.jsx("div",{className:Hn.title,children:t.name}),r.jsxs("div",{className:Hn.subtitle,children:["ID ",t.imageId," Â· Camera ",t.cameraId," (",t.cameraWidth,"Ã—",t.cameraHeight,")"]})]}),r.jsxs("div",{className:"flex-shrink-0 text-right list-stats-compact",children:[r.jsxs("div",{className:"text-ds-primary text-xs whitespace-nowrap",children:[t.numPoints3D,r.jsxs("span",{className:"text-ds-muted",children:["/",t.numPoints2D]})," Â· ",t.covisibleCount," Â· ",t.avgError.toFixed(2)]}),r.jsx("div",{className:"text-ds-muted text-xs whitespace-nowrap",children:"pts Â· covis Â· err"})]}),r.jsxs("div",{className:"flex-shrink-0 text-right list-stats-full",children:[r.jsxs("div",{className:"text-ds-primary text-sm",children:[t.numPoints3D,r.jsxs("span",{className:"text-ds-muted",children:["/",t.numPoints2D]})]}),r.jsx("div",{className:"text-ds-muted text-xs",children:"3D/2D pts"})]}),r.jsxs("div",{className:"flex-shrink-0 text-right w-16 list-stats-full",children:[r.jsx("div",{className:"text-ds-primary text-sm",children:t.covisibleCount}),r.jsx("div",{className:"text-ds-muted text-xs",children:"covisible"})]}),r.jsxs("div",{className:"flex-shrink-0 text-right w-16 list-stats-full",children:[r.jsx("div",{className:"text-ds-primary text-sm",children:t.avgError.toFixed(2)}),r.jsx("div",{className:"text-ds-muted text-xs",children:"avg err"})]}),v&&x&&xa.createPortal(r.jsx("div",{style:{position:"fixed",left:x.x+12,top:x.y+12,pointerEvents:"none",zIndex:9999},children:r.jsx("div",{className:se.container,children:r.jsxs("div",{className:se.hint,children:[r.jsxs("div",{className:se.hintRow,children:[r.jsxs("svg",{className:tt.hoverCard,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[r.jsx("rect",{x:"6",y:"2",width:"12",height:"20",rx:"6"}),r.jsx("path",{d:"M12 2v8"}),r.jsx("rect",{x:"6",y:"2",width:"6",height:"8",rx:"3",fill:"currentColor",opacity:"0.5"})]}),n?"Left: details":"Left: select"]}),r.jsxs("div",{className:se.hintRow,children:[r.jsxs("svg",{className:tt.hoverCard,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[r.jsx("rect",{x:"6",y:"2",width:"12",height:"20",rx:"6"}),r.jsx("path",{d:"M12 2v8"}),r.jsx("rect",{x:"12",y:"2",width:"6",height:"8",rx:"3",fill:"currentColor",opacity:"0.5"})]}),o?"Right: matches":g?"Right: back":"Right: fly to"]})]})})}),document.body)]})});function kS(e,t){const n=[];for(let o=0;o<e.length;o+=t)n.push(e.slice(o,o+t));return n}function du(e){const t=`${ue.base} ${ue.sizes.icon}`;return e?`${t} ${ue.variants.toggleActive}`:`${t} ${ue.variants.toggle}`}function SS({isResizing:e=!1}){const t=ye(W=>W.reconstruction),n=ye(W=>W.loadedFiles),o=ye(W=>W.imageUrlBase),s=q(W=>W.openImageDetail),a=q(W=>W.setMatchedImageId),i=q(W=>W.setShowMatchesInModal),l=q(W=>W.showMatches),c=q(W=>W.matchesDisplayMode),d=q(W=>W.matchesColor),u=B(W=>W.selectedImageId),f=B(W=>W.setSelectedImageId),p=B(W=>W.flyToImage),g=B(W=>W.currentViewState),y=B(W=>W.pushNavigationHistory),v=B(W=>W.popNavigationHistory),w=B(W=>W.peekNavigationHistory),x=B(W=>W.flyToState),m=B(W=>W.navigationHistory),[S,k]=h.useState("gallery"),[j,b]=h.useState(ui.default),[M,E]=h.useState("all"),[P,I]=h.useState("name"),[R,A]=h.useState("asc"),G=h.useRef(null),[F,z]=h.useState(0),[Z,U]=h.useState(0),D=h.useMemo(()=>{if(!t||u===null||!l)return new Set;const W=t.connectedImagesIndex.get(u);return W?new Set(W.keys()):new Set},[t,u,l]),T=h.useCallback(W=>{f(W)},[f]),$=h.useCallback(W=>{s(W)},[s]),Q=h.useCallback(W=>{if(u!==null&&D.has(W)){i(!0),a(W),s(u),setTimeout(()=>a(W),0);return}const me=w();if(g&&me&&me.toImageId===W){const H=v();H&&(x(H.fromState),f(H.fromImageId));return}if(t){const H=t.images.get(W);if(H){let ne;o?ne=mn(H.name):Zt()?ne=un(H.name)??void 0:ne=ao(n?.imageFiles,H.name),ne&&Zi(ne,H.name)}}g&&y({fromState:g,fromImageId:u,toImageId:W}),f(W),p(W)},[f,p,g,w,v,y,x,u,D,i,a,s,t,o,n]),K=h.useMemo(()=>m.length===0?null:m[m.length-1].toImageId,[m]);h.useEffect(()=>{E("all")},[t]);const[re,J]=h.useState(!1),L=h.useRef(null);h.useEffect(()=>(J(!0),Al(),L.current!==null&&clearTimeout(L.current),L.current=setTimeout(()=>{J(!1),Nl(),L.current=null},50),()=>{L.current!==null&&clearTimeout(L.current)}),[M,P,R,u]);const ee=h.useMemo(()=>t?Array.from(t.cameras.values()).sort((W,me)=>W.cameraId-me.cameraId):[],[t]),ie=n?.imageFiles,te=h.useMemo(()=>{if(!t)return[];const W=Array.from(t.images.values()).filter(H=>M==="all"||H.cameraId===M).map(H=>{const ne=t.imageStats.get(H.imageId),le=t.cameras.get(H.cameraId);let _e;return o?_e=mn(H.name):Zt()?_e=un(H.name)??void 0:_e=ao(ie,H.name),{imageId:H.imageId,name:H.name,file:_e,numPoints2D:H.numPoints2D??H.points2D.length,numPoints3D:ne?.numPoints3D??0,cameraId:H.cameraId,cameraWidth:le?.width??0,cameraHeight:le?.height??0,covisibleCount:ne?.covisibleCount??0,avgError:ne?.avgError??0}}),me=R==="asc"?1:-1;return W.sort((H,ne)=>P==="name"?me*H.name.localeCompare(ne.name):me*(H[P]-ne[P])),W},[t,ie,o,M,P,R,F,Z]),de=h.useRef(null),fe=h.useRef(null);h.useEffect(()=>{const W=G.current;if(!W||S!=="gallery")return;const me=H=>{if(!H.shiftKey)return;H.preventDefault();const ne=H.deltaY>0?1:-1,le=de.current??j,_e=Math.max(ui.min,Math.min(ui.max,le+ne));de.current=_e,fe.current!==null&&clearTimeout(fe.current),fe.current=setTimeout(()=>{const qe=de.current;de.current=null,fe.current=null,qe!==null&&qe!==j&&h.startTransition(()=>{b(qe)})},hn.wheelDebounce)};return W.addEventListener("wheel",me,{passive:!1,capture:!0}),()=>{W.removeEventListener("wheel",me,{capture:!0}),fe.current!==null&&clearTimeout(fe.current)}},[S,j]);const we=h.useMemo(()=>kS(te,j),[te,j]),pe=h.useMemo(()=>te.map(W=>[W]),[te]),ge=ml({count:we.length,getScrollElement:()=>G.current,estimateSize:()=>io.defaultCellHeight+mr.gallery,overscan:hn.galleryOverscan}),Re=ml({count:pe.length,getScrollElement:()=>G.current,estimateSize:()=>io.listRowHeight+mr.gallery,overscan:hn.listOverscan}),[Le,xe]=h.useState(!1),Ee=h.useRef(null),ke=S==="gallery"?ge.isScrolling:Re.isScrolling;return h.useEffect(()=>(ke?(Ee.current!==null&&(clearTimeout(Ee.current),Ee.current=null),xe(!0),Al()):Ee.current===null&&(Ee.current=setTimeout(()=>{xe(!1),Nl(),Ee.current=null},hn.transitionBase)),()=>{Ee.current!==null&&clearTimeout(Ee.current)}),[ke]),h.useEffect(()=>{if(!o||!t||Le||re)return;const W=S==="gallery"?ge.getVirtualItems():Re.getVirtualItems(),me=[];for(const le of W){const _e=S==="gallery"?we[le.index]||[]:[te[le.index]].filter(Boolean);for(const qe of _e)qe&&!mn(qe.name)&&me.push(qe.name)}if(me.length===0)return;let H=!1;return(async()=>{for(let _e=0;_e<me.length&&!H;_e+=5){const qe=me.slice(_e,_e+5),et=await Promise.all(qe.map(Ue=>er(o,Ue)));!H&&et.some(Ue=>Ue!==null)&&z(Ue=>Ue+1)}})(),()=>{H=!0}},[o,t,S,we,te,Le,re,ge,Re]),h.useEffect(()=>{if(o||!Zt()||!t||Le||re)return;const W=S==="gallery"?ge.getVirtualItems():Re.getVirtualItems(),me=[];for(const le of W){const _e=S==="gallery"?we[le.index]||[]:[te[le.index]].filter(Boolean);for(const qe of _e)qe&&!un(qe.name)&&me.push(qe.name)}if(me.length===0)return;let H=!1;return(async()=>{for(let _e=0;_e<me.length&&!H;_e+=5){const qe=me.slice(_e,_e+5),et=await Promise.all(qe.map(Ue=>qo(Ue)));!H&&et.some(Ue=>Ue!==null)&&U(Ue=>Ue+1)}})(),()=>{H=!0}},[o,t,S,we,te,Le,re,ge,Re]),h.useEffect(()=>{if(u===null)return;const W=te.findIndex(me=>me.imageId===u);if(W!==-1)if(S==="gallery"){const me=Math.floor(W/j);ge.scrollToIndex(me,{align:"center",behavior:"smooth"})}else Re.scrollToIndex(W,{align:"center",behavior:"smooth"})},[u,te,S,j,ge,Re]),h.useEffect(()=>{const W=me=>{if(me.target instanceof HTMLInputElement||me.target instanceof HTMLTextAreaElement||te.length===0)return;const H=me.key;if(!["ArrowLeft","ArrowRight","ArrowUp","ArrowDown"].includes(H))return;me.preventDefault();const ne=u!==null?te.findIndex(qe=>qe.imageId===u):-1;let le;if(S==="gallery")switch(H){case"ArrowLeft":le=ne<=0?te.length-1:ne-1;break;case"ArrowRight":le=ne>=te.length-1?0:ne+1;break;case"ArrowUp":le=ne-j,le<0&&(le=ne);break;case"ArrowDown":le=ne+j,le>=te.length&&(le=ne);break;default:return}else switch(H){case"ArrowLeft":case"ArrowUp":le=ne<=0?te.length-1:ne-1;break;case"ArrowRight":case"ArrowDown":le=ne>=te.length-1?0:ne+1;break;default:return}ne===-1&&(le=H==="ArrowLeft"||H==="ArrowUp"?te.length-1:0);const _e=te[le].imageId;me.shiftKey?Q(_e):T(_e)};return window.addEventListener("keydown",W),()=>window.removeEventListener("keydown",W)},[te,u,S,j,T,Q]),t?te.length===0?r.jsx("div",{className:cn.container,children:"No images found"}):r.jsxs("div",{className:"h-full flex flex-col bg-ds-secondary",children:[r.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-1 py-1 pl-0.5 pr-1 bg-ds-tertiary",children:[r.jsx("div",{className:hi.group,children:r.jsxs("select",{value:M,onChange:W=>E(W.target.value==="all"?"all":parseInt(W.target.value)),className:`${Sn.select} ${Sn.sizes.sm}`,children:[r.jsxs("option",{value:"all",children:["All Cameras (",ee.length,")"]}),ee.map(W=>r.jsxs("option",{value:W.cameraId,children:["Camera ",W.cameraId," (",W.width,"Ã—",W.height,")"]},W.cameraId))]})}),r.jsxs("div",{className:`${hi.group} flex-nowrap`,children:[r.jsxs("select",{value:P,onChange:W=>I(W.target.value),className:`${Sn.select} ${Sn.sizes.sm}`,children:[r.jsx("option",{value:"name",children:"Sort: Name"}),r.jsx("option",{value:"imageId",children:"Sort: Image ID"}),r.jsx("option",{value:"avgError",children:"Sort: Avg Error"}),r.jsx("option",{value:"covisibleCount",children:"Sort: Covisible"}),r.jsx("option",{value:"numPoints3D",children:"Sort: 3D Points"}),r.jsx("option",{value:"numPoints2D",children:"Sort: 2D Points"})]}),r.jsx("button",{onClick:()=>A(W=>W==="asc"?"desc":"asc"),className:`${ue.base} ${ue.sizes.icon} ${ue.variants.toggle}`,...zu(R==="asc"?"Ascending":"Descending","bottom"),children:R==="asc"?r.jsx(vS,{className:"w-4 h-4"}):r.jsx(wS,{className:"w-4 h-4"})})]}),r.jsx("div",{className:`${hi.group} ml-auto`,children:r.jsxs("div",{className:"flex items-center gap-1",children:[r.jsx("button",{onClick:()=>k("gallery"),className:du(S==="gallery"),"data-tooltip":"Grid view (Shift+{SCROLL} to resize)",children:r.jsx(xS,{className:"w-4 h-4"})}),r.jsx("button",{onClick:()=>k("list"),className:du(S==="list"),"data-tooltip":"List view with stats",children:r.jsx(yS,{className:"w-4 h-4"})})]})})]}),r.jsx("div",{ref:G,className:"flex-1 overflow-auto min-h-0 relative p-2",children:S==="gallery"?r.jsx("div",{style:{height:ge.getTotalSize(),width:"100%",position:"relative"},children:ge.getVirtualItems().map(W=>{const me=we[W.index];return r.jsx("div",{ref:ge.measureElement,"data-index":W.index,style:{position:"absolute",top:0,left:0,width:"100%",transform:`translateY(${W.start}px)`,display:"grid",gridTemplateColumns:`repeat(${j}, 1fr)`,gap:mr.gallery,paddingBottom:mr.gallery,willChange:"transform"},children:me.map(H=>r.jsx(bS,{img:H,isSelected:u===H.imageId,isMatched:D.has(H.imageId),matchesColor:d,matchesBlink:l&&c==="blink",onClick:T,onDoubleClick:$,onRightClick:Q,isScrolling:Le,skipImages:!1,isSettling:re,isResizing:e,wouldGoBack:H.imageId===K},H.imageId))},W.key)})}):r.jsx("div",{style:{height:Re.getTotalSize(),width:"100%",position:"relative"},children:Re.getVirtualItems().map(W=>{const me=pe[W.index][0];return r.jsx("div",{style:{position:"absolute",top:0,left:0,width:"100%",transform:`translateY(${W.start}px)`,willChange:"transform"},children:r.jsx(CS,{img:me,isSelected:u===me.imageId,isMatched:D.has(me.imageId),matchesColor:d,matchesBlink:l&&c==="blink",onClick:T,onDoubleClick:$,onRightClick:Q,isScrolling:Le,skipImages:!1,isSettling:re,isResizing:e,wouldGoBack:me.imageId===K})},W.key)})})})]}):r.jsx("div",{className:cn.container,children:"Load COLMAP data to view images"})}class jS extends h.Component{constructor(t){super(t),this.state={hasError:!1,error:null,errorType:null}}static getDerivedStateFromError(t){const n=Ya(t);return{hasError:!0,error:t,errorType:n}}componentDidCatch(t,n){console.error("GalleryErrorBoundary caught an error:",t,n)}handleRetry=()=>{this.setState({hasError:!1,error:null,errorType:null})};render(){const{children:t}=this.props,{hasError:n,error:o,errorType:s}=this.state;if(n){const a=Ko(s||"image_load_error");return r.jsxs("div",{className:"h-full flex flex-col items-center justify-center p-4 text-center bg-ds-secondary",children:[r.jsx("div",{className:"text-ds-error text-3xl mb-3",children:"!"}),r.jsx("h3",{className:"text-sm font-medium text-ds-primary mb-2",children:"Gallery Error"}),r.jsx("p",{className:"text-xs text-ds-secondary mb-4 max-w-xs",children:o?.message??a.message}),r.jsx("button",{onClick:this.handleRetry,className:`${ue.base} ${ue.sizes.sm} ${ue.variants.secondary}`,children:"Retry Loading Gallery"})]})}return t}}function Ri(e){const[t,n]=h.useState(null),o=h.useRef(new Set);return h.useEffect(()=>{if(!e){n(null);return}const s=URL.createObjectURL(e);return n(s),()=>{const a=o.current;a.add(s);const i=()=>{a.has(s)&&(a.delete(s),URL.revokeObjectURL(s))};typeof requestIdleCallback<"u"?requestIdleCallback(i,{timeout:1e3}):setTimeout(i,100)}},[e]),h.useEffect(()=>{const s=o.current;return()=>{s.forEach(a=>{URL.revokeObjectURL(a)}),s.clear()}},[]),t}class IS extends h.Component{constructor(t){super(t),this.state={hasError:!1}}static getDerivedStateFromError(){return{hasError:!0}}componentDidCatch(t,n){console.error("ModalErrorBoundary caught an error:",t,n),Nt.getState().addNotification("warning",lS.modalError),this.props.onClose()}componentDidUpdate(t){this.state.hasError&&t.children!==this.props.children&&this.setState({hasError:!1})}render(){return this.state.hasError?null:this.props.children}}const MS={0:"SIMPLE_PINHOLE",1:"PINHOLE",2:"SIMPLE_RADIAL",3:"RADIAL",4:"OPENCV",5:"OPENCV_FISHEYE",6:"FULL_OPENCV",7:"FOV",8:"SIMPLE_RADIAL_FISHEYE",9:"RADIAL_FISHEYE",10:"THIN_PRISM_FISHEYE"},ES={0:"f, cx, cy",1:"fx, fy, cx, cy",2:"f, cx, cy, k",3:"f, cx, cy, k1, k2",4:"fx, fy, cx, cy, k1, k2, p1, p2",5:"fx, fy, cx, cy, k1, k2, k3, k4",6:"fx, fy, cx, cy, k1, k2, p1, p2, k3, k4, k5, k6",7:"fx, fy, cx, cy, omega",8:"f, cx, cy, k",9:"f, cx, cy, k1, k2",10:"fx, fy, cx, cy, k1, k2, p1, p2, k3, k4, sx1, sy1"};function PS(e){const t=Math.abs(e);return t>=1?e.toFixed(1):t===0?"0":e.toPrecision(4)}function LS({camera:e,qvec:t,tvec:n}){const o=MS[e.modelId]||`MODEL_${e.modelId}`,s=(ES[e.modelId]||"").split(", "),a=[t[1],t[2],t[3],t[0]];return r.jsxs("div",{className:"flex items-center gap-2 text-xs flex-wrap",children:[r.jsx("span",{className:"text-ds-accent font-mono",children:o}),r.jsx("span",{className:"text-ds-muted",children:"|"}),r.jsxs("span",{className:"font-mono text-ds-primary",children:[e.width,r.jsx("span",{className:"text-ds-muted",children:"Ã—"}),e.height]}),r.jsx("span",{className:"text-ds-muted",children:"|"}),r.jsx("span",{className:"font-mono",children:e.params.map((i,l)=>r.jsxs("span",{children:[l>0&&r.jsx("span",{className:"text-ds-muted",children:", "}),r.jsxs("span",{className:"text-ds-muted",children:[s[l]||`p${l}`,"="]}),r.jsx("span",{className:"text-ds-primary",children:PS(i)})]},l))}),r.jsx("span",{className:"text-ds-muted",children:"|"}),r.jsxs("span",{className:"font-mono",children:[r.jsx("span",{className:"text-ds-muted",children:"R="}),a.map((i,l)=>r.jsxs("span",{children:[l>0&&r.jsx("span",{className:"text-ds-muted",children:","}),r.jsx("span",{className:i<0?"text-ds-error":"text-ds-primary",children:i.toFixed(3)})]},l))]}),r.jsx("span",{className:"text-ds-muted",children:"|"}),r.jsxs("span",{className:"font-mono",children:[r.jsx("span",{className:"text-ds-muted",children:"T="}),n.map((i,l)=>r.jsxs("span",{children:[l>0&&r.jsx("span",{className:"text-ds-muted",children:","}),r.jsx("span",{className:i<0?"text-ds-error":"text-ds-primary",children:i.toFixed(2)})]},l))]})]})}const _S=h.memo(function({points2D:t,camera:n,imageWidth:o,imageHeight:s,containerWidth:a,containerHeight:i,showPoints2D:l,showPoints3D:c}){const d=h.useRef(null);h.useEffect(()=>{const p=d.current;if(!p)return;const g=p.getContext("2d");if(!g)return;g.clearRect(0,0,p.width,p.height);const y=o/n.width,v=s/n.height,w=[],x=[];for(const m of t){const S=m.point3DId!==BigInt(-1),k=m.xy[0]*y,j=m.xy[1]*v;S?w.push({x:k,y:j}):x.push({x:k,y:j})}if(l&&x.length>0){g.fillStyle=_t.point.triangulated,g.beginPath();for(const{x:m,y:S}of x)g.moveTo(m+2,S),g.arc(m,S,2,0,Math.PI*2);g.fill()}if(w.length>0&&(l||c)){g.fillStyle=c?_t.point.untriangulated:_t.point.triangulated,g.beginPath();for(const{x:m,y:S}of w)g.moveTo(m+2,S),g.arc(m,S,2,0,Math.PI*2);g.fill()}},[t,n,o,s,l,c]);const u=(a-o)/2,f=(i-s)/2;return r.jsx("canvas",{ref:d,width:o,height:s,className:"absolute pointer-events-none",style:{left:u,top:f}})}),AS=h.memo(function({lines:t,image1Camera:n,image2Camera:o,image1Width:s,image1Height:a,image2Width:i,image2Height:l,containerWidth:c,containerHeight:d,gap:u,lineOpacity:f}){const p=h.useRef(null);return h.useEffect(()=>{const g=p.current;if(!g)return;const y=g.getContext("2d");if(!y)return;if(s<=0||a<=0||i<=0||l<=0||n.width<=0||n.height<=0||o.width<=0||o.height<=0||c<=0||d<=0){y.clearRect(0,0,g.width,g.height);return}y.clearRect(0,0,g.width,g.height);const v=(c-u)/2,w=(v-s)/2,x=(d-a)/2,m=v+u+(v-i)/2,S=(d-l)/2,k=s/n.width,j=a/n.height,b=i/o.width,M=l/o.height;y.strokeStyle=_t.point.triangulated,y.lineWidth=1,y.globalAlpha=f;for(const{point1:E,point2:P}of t){const I=w+E[0]*k,R=x+E[1]*j,A=m+P[0]*b,G=S+P[1]*M;y.beginPath(),y.moveTo(I,R),y.lineTo(A,G),y.stroke()}y.globalAlpha=1,y.fillStyle=_t.point.triangulated;for(const{point1:E,point2:P}of t){const I=w+E[0]*k,R=x+E[1]*j,A=m+P[0]*b,G=S+P[1]*M;y.beginPath(),y.arc(I,R,2,0,Math.PI*2),y.fill(),y.beginPath(),y.arc(A,G,2,0,Math.PI*2),y.fill()}},[t,n,o,s,a,i,l,c,d,u,f]),r.jsx("canvas",{ref:p,width:c,height:d,className:"absolute inset-0 pointer-events-none"})}),Fi=io.modalMinWidth,Ti=io.modalMinHeight,NS=hn.resizeDebounce,hr={bgSecondary:"#161616",bgTertiary:"#1e1e1e",textPrimary:"#e8e8e8",textMuted:"#5a5a5a"};function Di({width:e,height:t,cameraWidth:n,cameraHeight:o,label:s,style:a}){const i=h.useRef(null);return h.useEffect(()=>{const l=i.current;if(!l||e<=0||t<=0)return;const c=l.getContext("2d");if(!c)return;const d=Math.max(10,Math.min(30,e/15)),u=hr.bgSecondary,f=hr.bgTertiary;for(let b=0;b<t;b+=d)for(let M=0;M<e;M+=d){const E=(Math.floor(M/d)+Math.floor(b/d))%2===0;c.fillStyle=E?f:u,c.fillRect(M,b,d,d)}c.strokeStyle=hr.textMuted,c.lineWidth=1,c.setLineDash([4,4]),c.strokeRect(.5,.5,e-1,t-1),c.setLineDash([]);const p=Math.max(10,Math.min(16,e/25));c.font=`${p}px "JetBrains Mono", "Fira Code", Consolas, monospace`,c.textAlign="center",c.textBaseline="middle";const g=`${n} Ã— ${o}`,y=s||"No image loaded",v=c.measureText(g),w=c.measureText(y),x=Math.max(v.width,w.width),m=p*1.5,S=12,k=x+S*2,j=m*2+S;c.fillStyle="rgba(22, 22, 22, 0.85)",c.beginPath(),c.roundRect(e/2-k/2,t/2-j/2,k,j,4),c.fill(),c.fillStyle=hr.textPrimary,c.fillText(g,e/2,t/2-m*.35),c.fillStyle=hr.textMuted,c.fillText(y,e/2,t/2+m*.5)},[e,t,n,o,s]),e<=0||t<=0?null:r.jsx("canvas",{ref:i,width:e,height:t,style:{...a,width:e,height:t}})}const RS=20;function FS(){const e=ye(N=>N.reconstruction),t=ye(N=>N.loadedFiles),n=ye(N=>N.imageUrlBase),o=ye(N=>N.maskUrlBase),s=ye(N=>N.wasmReconstruction),[a,i]=h.useState(0),[l,c]=h.useState(0),[d,u]=h.useState(null),[f,p]=h.useState(null),g=q(N=>N.imageDetailId),y=q(N=>N.closeImageDetail),v=q(N=>N.openImageDetail),w=q(N=>N.showPoints2D),x=q(N=>N.showPoints3D),m=q(N=>N.setShowPoints2D),S=q(N=>N.setShowPoints3D),k=q(N=>N.showMatchesInModal),j=q(N=>N.setShowMatchesInModal),b=q(N=>N.matchedImageId),M=q(N=>N.setMatchedImageId),[E,P]=h.useState(Ms.matchLines),[I,R]=h.useState(!1),[A,G]=h.useState(""),F=h.useRef(null),[z,Z]=h.useState(new Map),U=h.useRef([]),D=h.useRef(null);h.useEffect(()=>{s!==D.current&&(D.current=s,Z(new Map),U.current=[])},[s]),h.useEffect(()=>{if(!g||!w&&!x&&!k||!s||s!==D.current)return;const N=[];if((w||x||k)&&!z.has(g)){const Fe=e?.images.get(g);Fe&&Fe.points2D.length===0&&(Fe.numPoints2D??0)>0&&N.push(g)}if(k&&b!==null&&!z.has(b)){const Fe=e?.images.get(b);Fe&&Fe.points2D.length===0&&(Fe.numPoints2D??0)>0&&N.push(b)}if(N.length===0)return;const ae=new Map(z),oe=[...U.current];for(const Fe of N){const yt=s.getImagePoints2DArray(Fe);if(yt.length>0){ae.set(Fe,yt);const pt=oe.indexOf(Fe);pt!==-1&&oe.splice(pt,1),oe.push(Fe)}}for(;oe.length>RS;){const Fe=oe.shift();ae.delete(Fe)}U.current=oe,Z(ae)},[g,b,w,x,k,s,e,z]),h.useEffect(()=>{if(!n||!e)return;const N=[];if(g!==null){const oe=e.images.get(g);oe&&!mn(oe.name)&&N.push(oe.name)}if(b!==null){const oe=e.images.get(b);oe&&!mn(oe.name)&&N.push(oe.name)}if(N.length===0)return;let ae=!1;return Promise.all(N.map(oe=>er(n,oe))).then(oe=>{!ae&&oe.some(Fe=>Fe!==null)&&i(Fe=>Fe+1)}),()=>{ae=!0}},[n,e,g,b]),h.useEffect(()=>{if(n||!Zt()||!e)return;const N=[];if(g!==null){const oe=e.images.get(g);oe&&!un(oe.name)&&N.push(oe.name)}if(b!==null){const oe=e.images.get(b);oe&&!un(oe.name)&&N.push(oe.name)}if(N.length===0)return;let ae=!1;return Promise.all(N.map(oe=>qo(oe))).then(oe=>{!ae&&oe.some(Fe=>Fe!==null)&&c(Fe=>Fe+1)}),()=>{ae=!0}},[n,e,g,b]),h.useEffect(()=>{if(u(null),!o||!e||g===null)return;const N=e.images.get(g);if(!N)return;let ae=!1;return rd(o,N.name).then(oe=>{ae||u(oe)}),()=>{ae=!0}},[o,e,g]),h.useEffect(()=>{if(p(null),o||!Zt()||!e||g===null)return;const N=e.images.get(g);if(!N)return;let ae=!1;return sd(N.name).then(oe=>{ae||p(oe)}),()=>{ae=!0}},[o,e,g]);const T=h.useMemo(()=>e?Array.from(e.images.keys()).sort((N,ae)=>N-ae):[],[e]),$=g!==null?T.indexOf(g):-1,Q=$>0,K=$>=0&&$<T.length-1,re=h.useCallback(()=>{Q&&v(T[$-1])},[Q,T,$,v]),J=h.useCallback(()=>{K&&v(T[$+1])},[K,T,$,v]);h.useEffect(()=>{I&&F.current&&(F.current.focus(),F.current.select())},[I]);const L=h.useCallback(()=>{G(String(Math.round(E*100))),R(!0)},[E]),ee=h.useCallback(()=>{const N=parseFloat(A);if(!isNaN(N)){const ae=Math.min(100,Math.max(0,N))/100;P(ae)}R(!1)},[A]),ie=h.useCallback(N=>{N.key==="Enter"?ee():N.key==="Escape"&&R(!1)},[ee]),te=h.useCallback(N=>{N.preventDefault(),N.stopPropagation();const ae=.05,oe=N.deltaY>0?-ae:ae,Fe=Math.min(1,Math.max(0,E+oe));P(Fe)},[E]),[de,fe]=h.useState({width:0,height:0}),we=h.useRef(null),[pe,ge]=h.useState({x:0,y:0}),[Re,Le]=h.useState({width:800,height:600}),[xe,Ee]=h.useState(!1),[ke,W]=h.useState(null),me=h.useRef({x:0,y:0,posX:0,posY:0}),H=h.useRef({x:0,y:0,width:0,height:0,posX:0,posY:0}),ne=g!==null?e?.images.get(g):null,le=ne?e?.cameras.get(ne.cameraId):null,_e=h.useMemo(()=>ne?n?mn(ne.name)??null:Zt()?un(ne.name)??null:ao(t?.imageFiles,ne.name)??null:null,[ne,n,t?.imageFiles,a,l]),qe=h.useMemo(()=>ne?o?d:Zt()?f:t?.hasMasks?qi(t?.imageFiles,ne.name)??null:null:null,[ne,o,d,f,t?.hasMasks,t?.imageFiles]),et=!!qe,[Ue,Jt]=h.useState("hover"),[en,O]=h.useState(.5),Ae=h.useCallback(()=>{Jt(N=>{const ae=["hover","mask","split","image"],oe=ae.indexOf(N);return ae[(oe+1)%ae.length]})},[]),De=h.useCallback(N=>{const ae=N.currentTarget.getBoundingClientRect(),oe=(N.clientX-ae.left)/ae.width;O(Math.max(0,Math.min(1,oe)))},[]),We=h.useCallback(()=>{Jt("hover")},[]);h.useEffect(()=>{Jt("hover"),O(.5)},[g]);const ze=Ri(_e),rt=Ri(qe),{numPoints2D:Y,numPoints3D:be}=h.useMemo(()=>{if(!ne||!e)return{numPoints2D:0,numPoints3D:0};const N=ne.numPoints2D??ne.points2D.length,oe=(g!==null?e.imageStats.get(g):null)?.numPoints3D??0;return{numPoints2D:N,numPoints3D:oe}},[ne,e,g]),he=h.useMemo(()=>{if(!e||g===null)return[];const N=e.connectedImagesIndex.get(g);return N?Array.from(N.entries()).sort((ae,oe)=>oe[1]-ae[1]).map(([ae,oe])=>({imageId:ae,matchCount:oe,name:e.images.get(ae)?.name||`Image ${ae}`})):[]},[e,g]),Ie=h.useMemo(()=>b===null?0:he.find(ae=>ae.imageId===b)?.matchCount??0,[he,b]),Oe=h.useMemo(()=>ne?ne.points2D.length>0?ne.points2D:z.get(ne.imageId)??[]:[],[ne,z]),ce=b!==null?e?.images.get(b):null,Ze=h.useMemo(()=>ce?ce.points2D.length>0?ce.points2D:z.get(ce.imageId)??[]:[],[ce,z]),Je=h.useCallback(N=>{if(N.stopPropagation(),he.length===0)return;const ae=b!==null?he.findIndex(oe=>oe.imageId===b):-1;if(N.deltaY>0){const oe=Math.min(ae+1,he.length-1);M(he[oe].imageId)}else{const oe=Math.max(ae-1,0);M(he[oe].imageId)}},[he,b,M]),Mt=h.useRef(0),kt=100;h.useEffect(()=>{const N=we.current;if(!N)return;const ae=oe=>{oe.preventDefault();const Fe=Date.now();if(!(Fe-Mt.current<kt))if(Mt.current=Fe,k&&he.length>0){const yt=b!==null?he.findIndex(pt=>pt.imageId===b):-1;if(oe.deltaY>0){const pt=yt+1;pt<he.length&&M(he[pt].imageId)}else if(oe.deltaY<0){const pt=yt-1;pt>=0&&M(he[pt].imageId)}}else oe.deltaY>0?J():oe.deltaY<0&&re()};return N.addEventListener("wheel",ae,{passive:!1}),()=>N.removeEventListener("wheel",ae)},[J,re,k,he,b,M]);const Ne=ce?e?.cameras.get(ce.cameraId):null,Xe=h.useMemo(()=>ce?n?mn(ce.name)??null:Zt()?un(ce.name)??null:ao(t?.imageFiles,ce.name)??null:null,[ce,n,t?.imageFiles,a,l]),St=Ri(Xe),_=h.useMemo(()=>{if(!k||b===null||!e||!ne||!ce)return[];const N=[],ae=new Map;for(const oe of Ze)oe.point3DId!==BigInt(-1)&&ae.set(oe.point3DId,oe);for(const oe of Oe){if(oe.point3DId===BigInt(-1))continue;const Fe=ae.get(oe.point3DId);Fe&&N.push({point1:oe.xy,point2:Fe.xy})}return N},[k,b,e,ne,ce,Oe,Ze]),Be=k&&b!==null&&ce&&Ne,Te=mr.matchView,{renderedImageWidth:dt,renderedImageHeight:ft}=h.useMemo(()=>{if(!le||de.width<=0||de.height<=0)return{renderedImageWidth:0,renderedImageHeight:0};const N=le.width/le.height,ae=de.width/de.height;return N>ae?{renderedImageWidth:de.width,renderedImageHeight:de.width/N}:{renderedImageHeight:de.height,renderedImageWidth:de.height*N}},[le,de.width,de.height]),Ye=h.useMemo(()=>{if(!le||!Ne||de.width<=0||de.height<=0)return{image1Width:0,image1Height:0,image2Width:0,image2Height:0};const N=(de.width-Te)/2,ae=de.height,oe=N/ae,Fe=le.width/le.height,yt=Fe>oe?N:ae*Fe,pt=Fe>oe?N/Fe:ae,Rt=Ne.width/Ne.height,Yt=Rt>oe?N:ae*Rt,Pn=Rt>oe?N/Rt:ae;return{image1Width:yt,image1Height:pt,image2Width:Yt,image2Height:Pn}},[le,Ne,de.width,de.height]),$t=h.useRef(!1);h.useEffect(()=>{if(g!==null&&!$t.current&&le){const N=window.innerWidth,ae=window.innerHeight,oe=Math.round(N*Eo.maxWidthPercent),Fe=Math.round(ae*Eo.maxHeightPercent),yt=Eo.headerHeight+Eo.footerHeight+Eo.padding,pt=Eo.padding,Rt=oe-pt,Yt=Fe-yt,Pn=le.width/le.height;let yn,nr;Pn>Rt/Yt?(yn=Rt,nr=Rt/Pn):(nr=Yt,yn=Yt*Pn);const zr=Math.max(Fi,Math.round(yn+pt)),Or=Math.max(Ti,Math.round(nr+yt));Le({width:zr,height:Or});const or=(N-zr)/2,Js=(ae-Or)/2;ge({x:or,y:Js})}$t.current=g!==null},[g,le]),lt(Se.closeModal.keys,y,{scopes:Se.closeModal.scopes,enabled:g!==null},[y]),lt(Se.prevImage.keys,re,{scopes:Se.prevImage.scopes,enabled:g!==null&&Q},[Q,re]),lt(Se.nextImage.keys,J,{scopes:Se.nextImage.scopes,enabled:g!==null&&K},[K,J]);const Pe=h.useCallback(N=>{N.preventDefault(),Ee(!0),me.current={x:N.clientX,y:N.clientY,posX:pe.x,posY:pe.y}},[pe]),Bt=h.useCallback((N,ae)=>{N.preventDefault(),N.stopPropagation(),W(ae),H.current={x:N.clientX,y:N.clientY,width:Re.width,height:Re.height,posX:pe.x,posY:pe.y}},[Re,pe]);h.useEffect(()=>{const N=oe=>{if(xe){const Fe=oe.clientX-me.current.x,yt=oe.clientY-me.current.y;ge({x:me.current.posX+Fe,y:me.current.posY+yt})}else if(ke){const Fe=oe.clientX-H.current.x,yt=oe.clientY-H.current.y;let pt=H.current.width,Rt=H.current.height,Yt=H.current.posX,Pn=H.current.posY;if(ke.includes("e")&&(pt=Math.max(Fi,H.current.width+Fe)),ke.includes("w")){const yn=H.current.width-Fe;yn>=Fi&&(pt=yn,Yt=H.current.posX+Fe)}if(ke.includes("s")&&(Rt=Math.max(Ti,H.current.height+yt)),ke.includes("n")){const yn=H.current.height-yt;yn>=Ti&&(Rt=yn,Pn=H.current.posY+yt)}Le({width:pt,height:Rt}),ge({x:Yt,y:Pn})}},ae=()=>{Ee(!1),W(null)};if(xe||ke)return window.addEventListener("mousemove",N),window.addEventListener("mouseup",ae),()=>{window.removeEventListener("mousemove",N),window.removeEventListener("mouseup",ae)}},[xe,ke]),h.useEffect(()=>{if(g===null)return;const N=()=>{ge(ae=>({x:Math.max(0,Math.min(ae.x,window.innerWidth-Re.width)),y:Math.max(0,Math.min(ae.y,window.innerHeight-Re.height))}))};return window.addEventListener("resize",N),()=>window.removeEventListener("resize",N)},[g,Re.width,Re.height]);const Ut=h.useRef(void 0),tn=h.useCallback(()=>{we.current&&fe({width:we.current.clientWidth,height:we.current.clientHeight})},[]);return h.useEffect(()=>{if(!we.current)return;tn();const N=new ResizeObserver(()=>{Ut.current&&clearTimeout(Ut.current),Ut.current=setTimeout(tn,NS)});return N.observe(we.current),()=>{N.disconnect(),Ut.current&&clearTimeout(Ut.current)}},[tn,g]),g===null||!ne||!le?null:r.jsxs("div",{className:"fixed inset-0 z-[1000] pointer-events-none",children:[r.jsx("div",{className:jn.backdrop,onClick:y,onContextMenu:N=>{N.preventDefault(),y()}}),r.jsxs("div",{className:jn.panel,style:{left:pe.x,top:pe.y,width:Re.width,height:Re.height},onClick:N=>N.stopPropagation(),children:[r.jsxs(IS,{onClose:y,children:[r.jsxs("div",{className:"flex items-center justify-between px-4 py-2 rounded-t-lg bg-ds-secondary text-xs cursor-move select-none",onMouseDown:Pe,children:[r.jsx("span",{className:"text-ds-primary",children:Be?`Image Matches: ${ne?.name} â†” ${ce?.name} (${Ie} matches)`:`Image #${g}: ${ne?.name}`}),r.jsx("button",{onClick:y,onMouseDown:N=>N.stopPropagation(),className:jn.closeButton,children:"Ã—"})]}),r.jsxs("div",{className:"flex flex-col flex-1 overflow-hidden px-4 pt-1 pb-4 gap-2",children:[r.jsx("div",{className:"flex-shrink-0 overflow-x-auto py-1",children:r.jsx(LS,{camera:le,qvec:ne.qvec,tvec:ne.tvec})}),r.jsxs("div",{className:"flex-1 min-h-0 flex flex-col",children:[r.jsxs("div",{ref:we,className:"group/scroll relative flex-1 min-h-0 bg-ds-secondary rounded overflow-hidden",children:[r.jsxs("div",{className:"absolute bottom-2 left-1/2 -translate-x-1/2 z-10 px-2 py-1 bg-ds-void/70 text-ds-secondary text-xs rounded opacity-0 group-hover/scroll:opacity-100 transition-opacity pointer-events-none whitespace-nowrap flex gap-3",children:[r.jsxs("span",{children:["Scroll: iterate through ",k&&he.length>0?"matched images":"images"]}),et&&rt&&!k&&r.jsxs("span",{children:["Click: ",r.jsx("span",{className:"text-ds-primary",children:Ue})," â†’ ",Ue==="hover"?"mask":Ue==="mask"?"split":Ue==="split"?"image":"hover"]})]}),Be?(()=>{const N=(de.width-Te)/2,ae=(N-Ye.image1Width)/2,oe=(de.height-Ye.image1Height)/2,Fe=N+Te+(N-Ye.image2Width)/2,yt=(de.height-Ye.image2Height)/2;return r.jsxs(r.Fragment,{children:[Ye.image1Width>0&&(ze?r.jsx("img",{src:ze,alt:ne.name,className:"absolute object-contain",style:{width:Ye.image1Width,height:Ye.image1Height,left:ae,top:oe},draggable:!1}):r.jsx(Di,{width:Ye.image1Width,height:Ye.image1Height,cameraWidth:le.width,cameraHeight:le.height,label:ne.name,style:{position:"absolute",left:ae,top:oe}})),Ye.image2Width>0&&Ne&&(St?r.jsx("img",{src:St,alt:ce?.name||"",className:"absolute object-contain",style:{width:Ye.image2Width,height:Ye.image2Height,left:Fe,top:yt},draggable:!1}):r.jsx(Di,{width:Ye.image2Width,height:Ye.image2Height,cameraWidth:Ne.width,cameraHeight:Ne.height,label:ce?.name,style:{position:"absolute",left:Fe,top:yt}})),_.length>0&&Ye.image1Width>0&&Ye.image2Width>0&&r.jsx(AS,{lines:_,image1Camera:le,image2Camera:Ne,image1Width:Ye.image1Width,image1Height:Ye.image1Height,image2Width:Ye.image2Width,image2Height:Ye.image2Height,containerWidth:de.width,containerHeight:de.height,gap:Te,lineOpacity:E})]})})():(()=>{const N=(de.width-dt)/2,ae=(de.height-ft)/2;return r.jsxs("div",{className:"group absolute inset-0",onClick:et&&rt?Ae:void 0,onMouseMove:et&&rt?De:void 0,onMouseLeave:et&&rt?We:void 0,style:{cursor:et&&rt?"pointer":void 0},children:[dt>0&&(ze?r.jsxs(r.Fragment,{children:[r.jsx("img",{src:ze,alt:ne.name,className:"absolute object-contain pointer-events-none",style:{width:dt,height:ft,left:N,top:ae,opacity:Ue==="mask"?0:1,clipPath:Ue==="split"?`inset(0 ${(1-en)*100}% 0 0)`:void 0},draggable:!1}),et&&rt&&r.jsx("img",{src:rt,alt:"mask",className:`absolute object-contain pointer-events-none ${Ue==="hover"?"opacity-0 group-hover:opacity-50":""}`,style:{width:dt,height:ft,left:N,top:ae,...Ue!=="hover"&&{opacity:Ue==="image"?0:1},clipPath:Ue==="split"?`inset(0 0 0 ${en*100}%)`:void 0},draggable:!1})]}):r.jsx(Di,{width:dt,height:ft,cameraWidth:le.width,cameraHeight:le.height,label:"No image loaded",style:{position:"absolute",left:N,top:ae}})),(w||x)&&dt>0&&Oe.length>0&&r.jsx(_S,{points2D:Oe,camera:le,imageWidth:dt,imageHeight:ft,containerWidth:de.width,containerHeight:de.height,showPoints2D:w,showPoints3D:x})]})})()]}),r.jsxs("div",{className:"mt-2 mb-2 flex items-center justify-between text-xs",children:[r.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[!k&&r.jsxs(r.Fragment,{children:[r.jsxs("button",{onClick:()=>m(!w),className:`${ue.base} ${ue.sizes.toggleResponsive} ${w?ue.variants.toggleActive:ue.variants.toggle}`,children:["Points2D ",r.jsxs("span",{className:w?"":"text-ds-success",children:["(",Y,")"]})]}),r.jsxs("button",{onClick:()=>S(!x),className:`${ue.base} ${ue.sizes.toggleResponsive} ${x?ue.variants.toggleActive:ue.variants.toggle}`,children:["Points3D ",r.jsxs("span",{className:x?"":"text-ds-error",children:["(",be,")"]})]})]}),r.jsx("button",{onClick:()=>j(!k),className:`${ue.base} ${ue.sizes.toggleResponsive} ${k?ue.variants.toggleActive:ue.variants.toggle}`,children:"Show Matches"}),k&&r.jsxs(r.Fragment,{children:[r.jsxs("select",{value:b??"",onChange:N=>M(N.target.value?parseInt(N.target.value):null),onWheel:Je,className:`${Sn.select} py-1 pl-2 pr-1 text-xs`,children:[r.jsx("option",{value:"",children:"Select connected image..."}),he.map(({imageId:N,matchCount:ae,name:oe})=>r.jsxs("option",{value:N,children:[oe," (",ae," matches)"]},N))]}),r.jsxs("div",{className:"flex items-center gap-2",onWheel:te,children:[r.jsx("label",{className:"text-ds-secondary whitespace-nowrap text-xs pl-1",children:"Opacity"}),r.jsx("input",{type:"range",min:"0",max:"1",step:"0.05",value:E,onChange:N=>P(parseFloat(N.target.value)),className:"w-14 accent-ds-success"}),I?r.jsx("input",{ref:F,type:"text",value:A,onChange:N=>G(N.target.value),onBlur:ee,onKeyDown:ie,className:"bg-transparent text-ds-primary text-xs w-8 text-right flex-shrink-0 border-none p-0 m-0 focus-outline-none"}):r.jsxs("span",{className:"text-ds-primary text-xs w-8 text-right flex-shrink-0 cursor-pointer hover-bg-ds-accent",onDoubleClick:L,title:"Double-click to edit",children:[Math.round(E*100),"%"]})]})]})]}),r.jsxs("div",{className:"flex items-center gap-2",children:[r.jsx("button",{onClick:re,disabled:!Q,className:`${ue.base} ${ue.sizes.toggleResponsive} ${Q?ue.variants.toggle:ue.disabled+" bg-ds-secondary text-ds-muted"}`,children:"â† Prev"}),r.jsxs("div",{className:"flex items-center text-xs",children:[r.jsx("input",{type:"text",defaultValue:g??"",className:`${Sn.base} py-1 w-14 rounded-l rounded-r-none text-center text-xs`,onKeyDown:N=>{if(N.stopPropagation(),N.key==="Enter"){const ae=parseInt(N.target.value);!isNaN(ae)&&e?.images.has(ae)&&v(ae),N.target.blur()}else N.key==="Escape"&&(N.target.value=String(g??""),N.target.blur())},onBlur:N=>{N.target.value=String(g??"")}},g),r.jsx("span",{className:"w-14 px-2 py-1 text-center bg-ds-secondary text-ds-muted border-y border-r border-ds rounded-r",children:T.length})]}),r.jsx("button",{onClick:J,disabled:!K,className:`${ue.base} ${ue.sizes.toggleResponsive} ${K?ue.variants.toggle:ue.disabled+" bg-ds-secondary text-ds-muted"}`,children:"Next â†’"})]})]})]})]})]}),r.jsx("div",{className:`${Wt.corner} ${Wt.nw}`,onMouseDown:N=>Bt(N,"nw")}),r.jsx("div",{className:`${Wt.corner} ${Wt.ne}`,onMouseDown:N=>Bt(N,"ne")}),r.jsx("div",{className:`${Wt.corner} ${Wt.sw}`,onMouseDown:N=>Bt(N,"sw")}),r.jsx("div",{className:`${Wt.corner} ${Wt.se}`,onMouseDown:N=>Bt(N,"se")}),r.jsx("div",{className:`${Wt.edge} ${Wt.n}`,onMouseDown:N=>Bt(N,"n")}),r.jsx("div",{className:`${Wt.edge} ${Wt.s}`,onMouseDown:N=>Bt(N,"s")}),r.jsx("div",{className:`${Wt.edge} ${Wt.w}`,onMouseDown:N=>Bt(N,"w")}),r.jsx("div",{className:`${Wt.edge} ${Wt.e}`,onMouseDown:N=>Bt(N,"e")})]})]})}function TS(){const{enableScope:e,disableScope:t}=ju(),o=q(s=>s.imageDetailId)!==null;return h.useEffect(()=>{o?(t("viewer"),e("modal")):(t("modal"),e("viewer"))},[o,e,t]),{isModalOpen:o}}const Qf=300,fu=.6;function DS(e){const[t,n]=h.useState(()=>Math.round(window.innerWidth*(e/100))),[o,s]=h.useState(!1),a=h.useCallback(i=>{i.preventDefault(),s(!0),document.body.style.cursor="col-resize",document.body.style.userSelect="none"},[]);return h.useEffect(()=>{const i=c=>{if(!o)return;const d=window.innerWidth-c.clientX,u=window.innerWidth*fu,f=Math.max(Qf,Math.min(u,d));n(f)},l=()=>{o&&(s(!1),document.body.style.cursor="",document.body.style.userSelect="")};return o&&(window.addEventListener("mousemove",i),window.addEventListener("mouseup",l)),()=>{window.removeEventListener("mousemove",i),window.removeEventListener("mouseup",l)}},[o]),h.useEffect(()=>{const i=()=>{const l=window.innerWidth*fu;n(c=>Math.min(c,l))};return window.addEventListener("resize",i),()=>window.removeEventListener("resize",i)},[]),{panelWidth:t,handleMouseDown:a,isResizing:o}}function zS(){return r.jsxs("div",{className:"h-screen flex flex-col bg-ds-primary",children:[r.jsxs("div",{className:"flex-1 flex flex-col items-center justify-center p-6 text-center cursor-default select-none",children:[r.jsx("div",{className:"relative w-32 h-28 mb-6 pointer-events-none",children:r.jsxs("svg",{className:"w-full h-full",viewBox:"0 0 120 100",fill:"none",children:[r.jsx("rect",{x:"10",y:"5",width:"100",height:"65",rx:"4",fill:"#4a4a4a",stroke:"#888",strokeWidth:"2"}),r.jsx("rect",{x:"15",y:"10",width:"90",height:"55",rx:"2",fill:"#2a2a2a"}),r.jsx("path",{d:"M50 70 L50 82 L70 82 L70 70",fill:"#666"}),r.jsx("ellipse",{cx:"60",cy:"88",rx:"25",ry:"6",fill:"#666"})]})}),r.jsx("h1",{className:Pl.title,children:"Desktop Only"}),r.jsx("p",{className:Pl.message,children:"Drag and drop a COLMAP folder into ColmapView is difficult on mobile devices."}),r.jsx("a",{href:"https://github.com/ColmapView/colmapview.github.io",target:"_blank",rel:"noopener noreferrer",className:"mt-6 no-underline",style:{color:"#facc15"},children:"â˜… Save on GitHub to try on desktop later"})]}),r.jsxs("div",{className:"flex items-center justify-between p-5",children:[r.jsx("a",{href:"https://opsiclear.com",target:"_blank",rel:"noopener noreferrer",children:r.jsx("img",{src:bo("LOGO.png"),alt:"OpsiClear",style:{height:"32px"}})}),r.jsxs("div",{className:"flex items-center gap-5",children:[r.jsx("a",{href:"https://x.com/OpsiClear",target:"_blank",rel:"noopener noreferrer",className:"text-ds-secondary",children:r.jsx("svg",{className:"w-6 h-6",viewBox:"0 0 24 24",fill:"currentColor",children:r.jsx("path",{d:"M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"})})}),r.jsx("a",{href:"https://www.linkedin.com/company/opsiclear",target:"_blank",rel:"noopener noreferrer",className:"text-ds-secondary",children:r.jsx("svg",{className:"w-6 h-6",viewBox:"0 0 24 24",fill:"currentColor",children:r.jsx("path",{d:"M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433a2.062 2.062 0 01-2.063-2.065 2.064 2.064 0 112.063 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"})})}),r.jsx("a",{href:"https://github.com/ColmapView/colmapview.github.io",target:"_blank",rel:"noopener noreferrer",className:"text-ds-secondary",children:r.jsx("svg",{className:"w-6 h-6",viewBox:"0 0 24 24",fill:"currentColor",children:r.jsx("path",{d:"M12 0C5.37 0 0 5.37 0 12c0 5.31 3.435 9.795 8.205 11.385.6.105.825-.255.825-.57 0-.285-.015-1.23-.015-2.235-3.015.555-3.795-.735-4.035-1.41-.135-.345-.72-1.41-1.23-1.695-.42-.225-1.02-.78-.015-.795.945-.015 1.62.87 1.845 1.23 1.08 1.815 2.805 1.305 3.495.99.105-.78.42-1.305.765-1.605-2.67-.3-5.46-1.335-5.46-5.925 0-1.305.465-2.385 1.23-3.225-.12-.3-.54-1.53.12-3.18 0 0 1.005-.315 3.3 1.23.96-.27 1.98-.405 3-.405s2.04.135 3 .405c2.295-1.56 3.3-1.23 3.3-1.23.66 1.65.24 2.88.12 3.18.765.84 1.23 1.905 1.23 3.225 0 4.605-2.805 5.625-5.475 5.925.435.375.81 1.095.81 2.22 0 1.605-.015 2.895-.015 3.3 0 .315.225.69.825.57A12.02 12.02 0 0024 12c0-6.63-5.37-12-12-12z"})})})]})]})]})}function OS(){const e=wf();TS();const t=q(u=>u.galleryCollapsed),n=q(u=>u.embedMode),{panelWidth:o,handleMouseDown:s,isResizing:a}=DS(cp.gallery.defaultSize),i=n||t,l=ye(u=>u.reconstruction),c=ye(u=>u.urlLoading),d=h.useRef(!1);return h.useEffect(()=>{l&&!c&&!d.current&&(d.current=!0,Ca.getState().showTip("contextMenu","Right-click anywhere for quick actions"))},[l,c]),e?r.jsx(zS,{}):r.jsxs("div",{className:"h-screen flex flex-col bg-ds-primary",children:[r.jsxs("div",{className:"flex-1 flex overflow-hidden",children:[r.jsx("div",{className:"flex-1 min-w-0",children:r.jsx(gS,{})}),!i&&r.jsx("div",{className:"resize-handle",onMouseDown:s}),!n&&r.jsx("div",{className:`overflow-hidden flex-shrink-0 ${a?"":"transition-all duration-300 ease-in-out"}`,style:{width:i?0:o},children:r.jsx("div",{className:"h-full border-l border-ds",style:{minWidth:`${Qf}px`},children:r.jsx(jS,{children:r.jsx(SS,{isResizing:a})})})})]}),!n&&r.jsx(SC,{}),r.jsx(FS,{})]})}class $S extends h.Component{constructor(t){super(t),this.state={hasError:!1,error:null,errorType:null}}static getDerivedStateFromError(t){const n=Ya(t);return{hasError:!0,error:t,errorType:n}}componentDidCatch(t,n){console.error("ErrorBoundary caught an error:",t,n),this.props.onError?.(t,n)}handleRetry=()=>{this.setState({hasError:!1,error:null,errorType:null}),this.props.onRetry?.()};handleReload=()=>{window.location.reload()};renderFallback(){const{variant:t="full",title:n,showReload:o,showRetry:s,fallback:a}=this.props,{error:i,errorType:l}=this.state;if(a)return typeof a=="function"?a(i,this.handleRetry):a;if(t==="silent")return null;const c=Ko(l||"unknown"),d=n??c.title,u=l?aS(l):"reload",f=s??(u==="retry"||u==="dismiss"),p=o??u==="reload";return t==="inline"?r.jsxs("div",{className:"flex flex-col items-center justify-center h-full p-4 text-center bg-ds-secondary",children:[r.jsx("div",{className:"text-ds-error text-2xl mb-2",children:"!"}),r.jsx("h3",{className:"text-sm font-medium text-ds-primary mb-1",children:d}),r.jsx("p",{className:"text-xs text-ds-secondary mb-3 max-w-xs",children:i?.message??c.message}),r.jsxs("div",{className:"flex gap-2",children:[f&&r.jsx("button",{onClick:this.handleRetry,className:`${ue.base} ${ue.sizes.sm} ${ue.variants.secondary}`,children:c.retryLabel??"Retry"}),p&&r.jsx("button",{onClick:this.handleReload,className:`${ue.base} ${ue.sizes.sm} ${ue.variants.ghost}`,children:c.reloadLabel??"Reload"})]})]}):r.jsxs("div",{className:cn.containerFull,children:[r.jsx("div",{className:cn.icon,children:"!"}),r.jsx("h2",{className:cn.title,children:d}),r.jsx("p",{className:cn.message,children:i?.message??c.message}),r.jsxs("div",{className:"flex gap-3 mt-4",children:[f&&r.jsx("button",{onClick:this.handleRetry,className:cn.button,children:c.retryLabel??"Retry"}),p&&r.jsx("button",{onClick:this.handleReload,className:`${ue.base} ${ue.sizes.md} ${ue.variants.ghost}`,children:c.reloadLabel??"Reload Page"})]})]})}render(){return this.state.hasError?this.renderFallback():this.props.children}}function BS(){const[e,t]=h.useState(!1);if(lt(Se.showHelp.keys,()=>t(o=>!o),{scopes:Se.showHelp.scopes,preventDefault:Se.showHelp.preventDefault},[]),lt("escape",()=>t(!1),{enabled:e},[e]),!e)return null;const n=Object.keys(_l);return r.jsxs("div",{className:"fixed inset-0 z-[1100] pointer-events-none",children:[r.jsx("div",{className:jn.backdrop,onClick:()=>t(!1)}),r.jsxs("div",{className:`${jn.panel} top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 p-6 max-w-lg w-full max-h-[80vh] overflow-auto`,children:[r.jsxs("div",{className:"flex items-center justify-between mb-4",children:[r.jsx("h2",{className:"text-ds-primary text-lg font-semibold",children:"Keyboard Shortcuts"}),r.jsx("button",{onClick:()=>t(!1),className:ue.close,children:"Ã—"})]}),n.map(o=>{const s=gp(o);return s.length===0?null:r.jsxs("div",{className:"mb-4",children:[r.jsx("h3",{className:"text-ds-secondary text-sm font-medium mb-2",children:_l[o]}),r.jsx("table",{className:"w-full text-sm",children:r.jsx("tbody",{children:s.map((a,i)=>r.jsxs("tr",{className:up.row,children:[r.jsx("td",{className:"py-1.5 text-ds-primary",children:a.description}),r.jsx("td",{className:"py-1.5 text-right",children:r.jsx("kbd",{className:"px-2 py-0.5 bg-ds-secondary rounded text-ds-primary text-xs font-mono",children:Wi(a.keys)})})]},i))})})]},o)}),r.jsxs("div",{className:"mt-4 pt-4 border-t border-ds text-ds-muted text-xs text-center",children:["Press"," ",r.jsx("kbd",{className:"px-1.5 py-0.5 bg-ds-secondary rounded",children:"?"})," ","to toggle this panel"]})]})]})}function US(e){const t=[],n=/\{(LMB|RMB|SCROLL)\}/g;let o=0,s;for(;(s=n.exec(e))!==null;){s.index>o&&t.push(e.slice(o,s.index));const a=s[1];a==="LMB"?t.push(r.jsx(bs,{className:`${tt.hoverCard} inline-block align-text-bottom`},`icon-${s.index}`)):a==="RMB"?t.push(r.jsx(la,{className:`${tt.hoverCard} inline-block align-text-bottom`},`icon-${s.index}`)):a==="SCROLL"&&t.push(r.jsx(lC,{className:`${tt.hoverCard} inline-block align-text-bottom`},`icon-${s.index}`)),o=n.lastIndex}return o<e.length&&t.push(e.slice(o)),t.length>0?t:[e]}function WS(){const[e,t]=h.useState(null),[n,o]=h.useState({x:0,y:0}),s=h.useRef(null),a=h.useCallback(c=>{o({x:c.clientX,y:c.clientY});const u=c.target.closest("[data-tooltip]");u?(u!==s.current||u.dataset.tooltip!==e)&&(s.current=u,t(u.dataset.tooltip||null)):s.current&&(s.current=null,t(null))},[e]),i=h.useCallback(c=>{const u=c.target.closest("[data-tooltip]");u&&(s.current=u,t(u.dataset.tooltip||null))},[]),l=h.useCallback(c=>{const d=c.relatedTarget;if(!d){s.current=null,t(null);return}d.closest("[data-tooltip]")||(s.current=null,t(null))},[]);return h.useEffect(()=>(document.addEventListener("mousemove",a),document.addEventListener("mouseover",i),document.addEventListener("mouseout",l),()=>{document.removeEventListener("mousemove",a),document.removeEventListener("mouseover",i),document.removeEventListener("mouseout",l)}),[a,i,l]),e?r.jsx("div",{className:"fixed pointer-events-none z-[9999]",style:{right:`calc(100vw - ${n.x}px + 12px)`,top:n.y+12},children:r.jsx("div",{className:`${se.container} border border-ds rounded text-xs px-2 py-1 whitespace-pre-line max-w-xs`,children:US(e)})}):null}function HS({notification:e,onClose:t}){const[n,o]=h.useState(!1),s=h.useCallback(()=>{o(!0),setTimeout(()=>{t(e.id)},200)},[e.id,t]);h.useEffect(()=>{if(e.type==="info"&&e.duration){const d=setTimeout(()=>{s()},e.duration);return()=>clearTimeout(d)}},[e.type,e.duration,s]);const a=e.type==="info",i=a?i2:a2,l=a?bn.iconContainerInfo:bn.iconContainerWarning,c=n?bn.exiting:bn.entering;return r.jsxs("div",{className:`${bn.toast} ${c}`,children:[r.jsx("div",{className:`${bn.iconContainer} ${l}`,children:r.jsx(i,{className:bn.icon})}),r.jsx("div",{className:bn.content,children:r.jsx("span",{className:bn.message,children:e.message})}),r.jsx("button",{className:bn.closeButton,onClick:s,"aria-label":"Close notification",children:r.jsx(bf,{className:"w-4 h-4"})})]})}function ZS(){const e=Nt(n=>n.notifications),t=Nt(n=>n.removeNotification);return e.length===0?null:r.jsx("div",{className:bn.container,children:e.map(n=>r.jsx(HS,{notification:n,onClose:t},n.id))})}Ym();function VS(){const{loadFromUrl:e,loadFromManifest:t}=vf(),n=h.useRef(!1);return h.useEffect(()=>{if(n.current)return;n.current=!0;const o=new URLSearchParams(window.location.search),s=o.get("embed");(s==="1"||s==="true")&&(console.log("[App] Embed mode enabled"),q.getState().setEmbedMode(!0)),(async()=>{const i=await Zf(window.location.hash);if(i){if(i.config&&(console.log("[App] Applying shared config"),fk(i.config)),i.manifest){console.log(`[App] Loading from inline manifest in URL hash: ${i.manifest.name||"unnamed"}`),t(i.manifest);return}if(i.manifestUrl){console.log(`[App] Loading from combined URL hash: ${i.manifestUrl}`),e(i.manifestUrl);return}}const l=o.get("url");l&&(console.log(`[App] Loading from URL parameter: ${l}`),e(l))})()},[e,t]),r.jsx($S,{children:r.jsxs(om,{initiallyActiveScopes:["global","viewer"],children:[r.jsx(uC,{children:r.jsx(OS,{})}),r.jsx(BS,{}),r.jsx(WS,{}),r.jsx(ZS,{})]})})}xg();Hh.createRoot(document.getElementById("root")).render(r.jsx(h.StrictMode,{children:r.jsx(VS,{})}));
