import{r as f,j as o,_ as ci,c as sr,p as bs,V as X,Q as Tt,E as or,M as jo,T as th,S as nh,C as Er,u as mr,a as Ec,b as pr,B as us,d as ha,e as Pc,I as gg,F as Ks,f as Ul,g as Xo,W as xg,h as rh,U as Yi,i as oh,k as Gi,l as ui,m as di,L as yg,n as vg,o as wg,N as bg,q as Cg,s as Hl,t as Sg,D as ao,H as Gr,v as kg,w as Ig,x as Wl,P as Mg,O as Ii,y as Hu,z as sh,A as Us,G as Wu,R as jg,J as Vu,K as Eg,X as Pg,Y as Ng,Z as Ag,$ as Lg,a0 as _g}from"./three-vendor-CtFJPH5L.js";import{r as Qs,u as Zu}from"./ui-vendor-BZ2PVVaw.js";import{g as Tg}from"./react-vendor-Cgg2GOmP.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))r(s);new MutationObserver(s=>{for(const i of s)if(i.type==="childList")for(const a of i.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&r(a)}).observe(document,{childList:!0,subtree:!0});function n(s){const i={};return s.integrity&&(i.integrity=s.integrity),s.referrerPolicy&&(i.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?i.credentials="include":s.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function r(s){if(s.ep)return;s.ep=!0;const i=n(s);fetch(s.href,i)}})();const ih=["shift","alt","meta","mod","ctrl","control"],Rg={esc:"escape",return:"enter",left:"arrowleft",right:"arrowright",up:"arrowup",down:"arrowdown",ShiftLeft:"shift",ShiftRight:"shift",AltLeft:"alt",AltRight:"alt",MetaLeft:"meta",MetaRight:"meta",OSLeft:"meta",OSRight:"meta",ControlLeft:"ctrl",ControlRight:"ctrl"};function ro(e){return(Rg[e.trim()]||e.trim()).toLowerCase().replace(/key|digit|numpad/,"")}function ah(e){return ih.includes(e)}function al(e,t=","){return e.toLowerCase().split(t)}function ll(e,t="+",n=">",r=!1,s,i){let a=[],l=!1;e=e.trim(),e.includes(n)?(l=!0,a=e.toLocaleLowerCase().split(n).map(h=>ro(h))):a=e.toLocaleLowerCase().split(t).map(h=>ro(h));const c={alt:a.includes("alt"),ctrl:a.includes("ctrl")||a.includes("control"),shift:a.includes("shift"),meta:a.includes("meta"),mod:a.includes("mod"),useKey:r},d=a.filter(h=>!ih.includes(h));return{...c,keys:d,description:s,isSequence:l,hotkey:e,metadata:i}}typeof document<"u"&&(document.addEventListener("keydown",e=>{e.code!==void 0&&lh([ro(e.code)])}),document.addEventListener("keyup",e=>{e.code!==void 0&&ch([ro(e.code)])})),typeof window<"u"&&(window.addEventListener("blur",()=>{Ur.clear()}),window.addEventListener("contextmenu",()=>{setTimeout(()=>{Ur.clear()},0)}));const Ur=new Set;function Nc(e){return Array.isArray(e)}function Dg(e,t=","){return(Nc(e)?e:e.split(t)).every(n=>Ur.has(n.trim().toLowerCase()))}function lh(e){const t=Array.isArray(e)?e:[e];Ur.has("meta")&&Ur.forEach(n=>{ah(n)||Ur.delete(n.toLowerCase())}),t.forEach(n=>{Ur.add(n.toLowerCase())})}function ch(e){const t=Array.isArray(e)?e:[e];e==="meta"?Ur.clear():t.forEach(n=>{Ur.delete(n.toLowerCase())})}function Fg(e,t,n){(typeof n=="function"&&n(e,t)||n===!0)&&e.preventDefault()}function zg(e,t,n){return typeof n=="function"?n(e,t):n===!0||n===void 0}const Og=["input","textarea","select","searchbox","slider","spinbutton","menuitem","menuitemcheckbox","menuitemradio","option","radio","textbox"];function $g(e){return uh(e,Og)}function uh(e,t=!1){const{target:n,composed:r}=e;let s,i;return Bg(n)&&r?(s=e.composedPath()[0]&&e.composedPath()[0].tagName,i=e.composedPath()[0]&&e.composedPath()[0].role):(s=n&&n.tagName,i=n&&n.role),Nc(t)?!!(s&&t&&t.some(a=>a.toLowerCase()===s.toLowerCase()||a===i)):!!(s&&t&&t)}function Bg(e){return!!e.tagName&&!e.tagName.startsWith("-")&&e.tagName.includes("-")}function Ug(e,t){return e.length===0&&t?!1:t?e.some(n=>t.includes(n))||e.includes("*"):!0}const Hg=(e,t,n=!1)=>{const{alt:r,meta:s,mod:i,shift:a,ctrl:l,keys:c,useKey:d}=t,{code:h,key:u,ctrlKey:m,metaKey:g,shiftKey:p,altKey:y}=e,w=ro(h);if(d){if(c?.length===1&&c.includes(u.toLowerCase())){if(!n){if(r!==y||a!==p)return!1;if(i){if(!g&&!m)return!1}else if(s!==g||l!==m)return!1}return!0}return!1}if(!c?.includes(w)&&!["ctrl","control","unknown","meta","alt","shift","os"].includes(w))return!1;if(!n){if(r!==y&&w!=="alt"||a!==p&&w!=="shift")return!1;if(i){if(!g&&!m)return!1}else if(s!==g&&w!=="meta"&&w!=="os"||l!==m&&w!=="ctrl"&&w!=="control")return!1}return c&&c.length===1&&c.includes(w)?!0:c&&c.length>0?c.includes(w)?Dg(c):!1:!c||c.length===0},dh=f.createContext(void 0),Wg=()=>f.useContext(dh);function Vg({addHotkey:e,removeHotkey:t,children:n}){return o.jsx(dh.Provider,{value:{addHotkey:e,removeHotkey:t},children:n})}function Ac(e,t){return e&&t&&typeof e=="object"&&typeof t=="object"?Object.keys(e).length===Object.keys(t).length&&Object.keys(e).reduce((n,r)=>n&&Ac(e[r],t[r]),!0):e===t}const fh=f.createContext({hotkeys:[],activeScopes:[],toggleScope:()=>{},enableScope:()=>{},disableScope:()=>{}}),hh=()=>f.useContext(fh),Zg=({initiallyActiveScopes:e=["*"],children:t})=>{const[n,r]=f.useState(e),[s,i]=f.useState([]),a=f.useCallback(u=>{r(m=>m.includes("*")?[u]:Array.from(new Set([...m,u])))},[]),l=f.useCallback(u=>{r(m=>m.filter(g=>g!==u))},[]),c=f.useCallback(u=>{r(m=>m.includes(u)?m.filter(g=>g!==u):m.includes("*")?[u]:Array.from(new Set([...m,u])))},[]),d=f.useCallback(u=>{i(m=>[...m,u])},[]),h=f.useCallback(u=>{i(m=>m.filter(g=>!Ac(g,u)))},[]);return o.jsx(fh.Provider,{value:{activeScopes:n,hotkeys:s,enableScope:a,disableScope:l,toggleScope:c},children:o.jsx(Vg,{addHotkey:d,removeHotkey:h,children:t})})};function Yg(e){const t=f.useRef(void 0);return Ac(t.current,e)||(t.current=e),t.current}const Yu=e=>{e.stopPropagation(),e.preventDefault(),e.stopImmediatePropagation()},Gg=typeof window<"u"?f.useLayoutEffect:f.useEffect;function kt(e,t,n,r){const s=f.useRef(null),i=f.useRef(!1),a=Array.isArray(n)?Array.isArray(r)?void 0:r:n,l=Nc(e)?e.join(a?.delimiter):e,c=Array.isArray(n)?n:Array.isArray(r)?r:void 0,d=f.useCallback(t,c??[]),h=f.useRef(d);c?h.current=d:h.current=t;const u=Yg(a),{activeScopes:m}=hh(),g=Wg();return Gg(()=>{if(u?.enabled===!1||!Ug(m,u?.scopes))return;let p=[],y;const w=(b,S=!1)=>{if(!($g(b)&&!uh(b,u?.enableOnFormTags))){if(s.current!==null){const C=s.current.getRootNode();if((C instanceof Document||C instanceof ShadowRoot)&&C.activeElement!==s.current&&!s.current.contains(C.activeElement)){Yu(b);return}}b.target?.isContentEditable&&!u?.enableOnContentEditable||al(l,u?.delimiter).forEach(C=>{if(C.includes(u?.splitKey??"+")&&C.includes(u?.sequenceSplitKey??">")){console.warn(`Hotkey ${C} contains both ${u?.splitKey??"+"} and ${u?.sequenceSplitKey??">"} which is not supported.`);return}const M=ll(C,u?.splitKey,u?.sequenceSplitKey,u?.useKey,u?.description,u?.metadata);if(M.isSequence){y=setTimeout(()=>{p=[]},u?.sequenceTimeoutMs??1e3);const I=M.useKey?b.key:ro(b.code);if(ah(I.toLowerCase()))return;p.push(I);const L=M.keys?.[p.length-1];if(I!==L){p=[],y&&clearTimeout(y);return}p.length===M.keys?.length&&(h.current(b,M),y&&clearTimeout(y),p=[])}else if(Hg(b,M,u?.ignoreModifiers)||M.keys?.includes("*")){if(u?.ignoreEventWhen?.(b)||S&&i.current)return;if(Fg(b,M,u?.preventDefault),!zg(b,M,u?.enabled)){Yu(b);return}h.current(b,M),S||(i.current=!0)}})}},x=b=>{b.code!==void 0&&(lh(ro(b.code)),(u?.keydown===void 0&&u?.keyup!==!0||u?.keydown)&&w(b))},v=b=>{b.code!==void 0&&(ch(ro(b.code)),i.current=!1,u?.keyup&&w(b,!0))},k=s.current||a?.document||document;return k.addEventListener("keyup",v,a?.eventListenerOptions),k.addEventListener("keydown",x,a?.eventListenerOptions),g&&al(l,u?.delimiter).forEach(b=>{g.addHotkey(ll(b,u?.splitKey,u?.sequenceSplitKey,u?.useKey,u?.description,u?.metadata))}),()=>{k.removeEventListener("keyup",v,a?.eventListenerOptions),k.removeEventListener("keydown",x,a?.eventListenerOptions),g&&al(l,u?.delimiter).forEach(b=>{g.removeHotkey(ll(b,u?.splitKey,u?.sequenceSplitKey,u?.useKey,u?.description,u?.metadata))}),p=[],y&&clearTimeout(y)}},[l,u,m]),s}class fi{view;offset=0;constructor(t){this.view=new DataView(t)}get position(){return this.offset}get remaining(){return this.view.byteLength-this.offset}get length(){return this.view.byteLength}readUint8(){const t=this.view.getUint8(this.offset);return this.offset+=1,t}readUint32(){const t=this.view.getUint32(this.offset,!0);return this.offset+=4,t}readInt32(){const t=this.view.getInt32(this.offset,!0);return this.offset+=4,t}readUint64(){const t=this.view.getBigUint64(this.offset,!0);return this.offset+=8,t}readUint64AsNumber(){return Number(this.readUint64())}readInt64(){const t=this.view.getBigInt64(this.offset,!0);return this.offset+=8,t}readFloat64(){const t=this.view.getFloat64(this.offset,!0);return this.offset+=8,t}readString(){const t=[];let n;for(;(n=this.readUint8())!==0;)t.push(String.fromCharCode(n));return t.join("")}skip(t){this.offset+=t}seek(t){this.offset=t}hasMore(){return this.offset<this.view.byteLength}}class hi{chunks=[];currentBuffer;currentView;offset=0;chunkSize=65536;constructor(){this.currentBuffer=new ArrayBuffer(this.chunkSize),this.currentView=new DataView(this.currentBuffer)}ensureCapacity(t){this.offset+t>this.chunkSize&&(this.chunks.push(this.currentBuffer.slice(0,this.offset)),this.currentBuffer=new ArrayBuffer(this.chunkSize),this.currentView=new DataView(this.currentBuffer),this.offset=0)}writeUint8(t){this.ensureCapacity(1),this.currentView.setUint8(this.offset,t),this.offset+=1}writeUint32(t){this.ensureCapacity(4),this.currentView.setUint32(this.offset,t,!0),this.offset+=4}writeInt32(t){this.ensureCapacity(4),this.currentView.setInt32(this.offset,t,!0),this.offset+=4}writeUint64(t){this.ensureCapacity(8),this.currentView.setBigUint64(this.offset,t,!0),this.offset+=8}writeUint64FromNumber(t){this.writeUint64(BigInt(t))}writeInt64(t){this.ensureCapacity(8),this.currentView.setBigInt64(this.offset,t,!0),this.offset+=8}writeFloat64(t){this.ensureCapacity(8),this.currentView.setFloat64(this.offset,t,!0),this.offset+=8}writeString(t){for(let n=0;n<t.length;n++)this.writeUint8(t.charCodeAt(n));this.writeUint8(0)}toArrayBuffer(){this.offset>0&&this.chunks.push(this.currentBuffer.slice(0,this.offset));const t=this.chunks.reduce((i,a)=>i+a.byteLength,0),n=new ArrayBuffer(t),r=new Uint8Array(n);let s=0;for(const i of this.chunks)r.set(new Uint8Array(i),s),s+=i.byteLength;return n}toBlob(){return new Blob([this.toArrayBuffer()],{type:"application/octet-stream"})}get bytesWritten(){return this.chunks.reduce((n,r)=>n+r.byteLength,0)+this.offset}}const qg=["rgb","error","trackLength"],qi=["orbit","fly"],Xi=["perspective","orthographic"],Ki=["off","cw","ccw"],Qi=["off","on","flip"],Ji=["frustum","arrow","imageplane"],Xg=["single","byCamera","byRigFrame"],Kg=["0.1","1","10"],Qg=["cropped","fullFrame"],Jg=["static","blink"],ea=["static","blink","rainbow"],ex=["colmap","opencv","threejs","opengl","vulkan","blender","houdini","unity","unreal"],tx=["off","xyz","extra"],nx=["static","blink"],rx=["single","perFrame"],ox=["current","1920x1080","1280x720","3840x2160","1024x1024","512x512","2048x2048"],sx=["jpeg","png","webp"];function mh(e){const t=e.params,n=e.modelId,r={fx:1,fy:1,cx:0,cy:0,k1:0,k2:0,k3:0,k4:0,k5:0,k6:0,p1:0,p2:0,omega:0,sx1:0,sy1:0};switch(n){case A.SIMPLE_PINHOLE:r.fx=r.fy=t[0],r.cx=t[1],r.cy=t[2];break;case A.PINHOLE:r.fx=t[0],r.fy=t[1],r.cx=t[2],r.cy=t[3];break;case A.SIMPLE_RADIAL:r.fx=r.fy=t[0],r.cx=t[1],r.cy=t[2],r.k1=t[3];break;case A.RADIAL:r.fx=r.fy=t[0],r.cx=t[1],r.cy=t[2],r.k1=t[3],r.k2=t[4];break;case A.OPENCV:r.fx=t[0],r.fy=t[1],r.cx=t[2],r.cy=t[3],r.k1=t[4],r.k2=t[5],r.p1=t[6],r.p2=t[7];break;case A.OPENCV_FISHEYE:r.fx=t[0],r.fy=t[1],r.cx=t[2],r.cy=t[3],r.k1=t[4],r.k2=t[5],r.k3=t[6],r.k4=t[7];break;case A.FULL_OPENCV:r.fx=t[0],r.fy=t[1],r.cx=t[2],r.cy=t[3],r.k1=t[4],r.k2=t[5],r.p1=t[6],r.p2=t[7],r.k3=t[8],r.k4=t[9],r.k5=t[10],r.k6=t[11];break;case A.FOV:r.fx=t[0],r.fy=t[1],r.cx=t[2],r.cy=t[3],r.omega=t[4];break;case A.SIMPLE_RADIAL_FISHEYE:r.fx=r.fy=t[0],r.cx=t[1],r.cy=t[2],r.k1=t[3];break;case A.RADIAL_FISHEYE:r.fx=r.fy=t[0],r.cx=t[1],r.cy=t[2],r.k1=t[3],r.k2=t[4];break;case A.THIN_PRISM_FISHEYE:r.fx=t[0],r.fy=t[1],r.cx=t[2],r.cy=t[3],r.k1=t[4],r.k2=t[5],r.p1=t[6],r.p2=t[7],r.k3=t[8],r.k4=t[9],r.sx1=t[10],r.sy1=t[11];break}return r}const Lc=BigInt(-1),A={SIMPLE_PINHOLE:0,PINHOLE:1,SIMPLE_RADIAL:2,RADIAL:3,OPENCV:4,OPENCV_FISHEYE:5,FULL_OPENCV:6,FOV:7,SIMPLE_RADIAL_FISHEYE:8,RADIAL_FISHEYE:9,THIN_PRISM_FISHEYE:10,RAD_TAN_THIN_PRISM_FISHEYE:11},ix={[A.SIMPLE_PINHOLE]:3,[A.PINHOLE]:4,[A.SIMPLE_RADIAL]:4,[A.RADIAL]:5,[A.OPENCV]:8,[A.OPENCV_FISHEYE]:8,[A.FULL_OPENCV]:12,[A.FOV]:5,[A.SIMPLE_RADIAL_FISHEYE]:4,[A.RADIAL_FISHEYE]:5,[A.THIN_PRISM_FISHEYE]:12,[A.RAD_TAN_THIN_PRISM_FISHEYE]:16};function ax(e){const t=new fi(e),n=new Map,r=t.readUint64AsNumber();for(let s=0;s<r;s++){const i=t.readUint32(),a=t.readInt32(),l=t.readUint64AsNumber(),c=t.readUint64AsNumber(),d=ix[a]??0,h=[];for(let u=0;u<d;u++)h.push(t.readFloat64());n.set(i,{cameraId:i,modelId:a,width:l,height:c,params:h})}return n}function lx(e){const t=new Map,n=e.split(`
`),r={SIMPLE_PINHOLE:A.SIMPLE_PINHOLE,PINHOLE:A.PINHOLE,SIMPLE_RADIAL:A.SIMPLE_RADIAL,RADIAL:A.RADIAL,OPENCV:A.OPENCV,OPENCV_FISHEYE:A.OPENCV_FISHEYE,FULL_OPENCV:A.FULL_OPENCV,FOV:A.FOV,SIMPLE_RADIAL_FISHEYE:A.SIMPLE_RADIAL_FISHEYE,RADIAL_FISHEYE:A.RADIAL_FISHEYE,THIN_PRISM_FISHEYE:A.THIN_PRISM_FISHEYE};for(const s of n){if(s.startsWith("#")||s.trim()==="")continue;const i=s.trim().split(/\s+/);if(i.length<4)continue;const a=parseInt(i[0]),l=i[1],c=r[l];if(c===void 0){console.warn(`Unknown camera model: ${l}`);continue}const d=parseInt(i[2]),h=parseInt(i[3]),u=[];for(let m=4;m<i.length;m++)u.push(parseFloat(i[m]));t.set(a,{cameraId:a,modelId:c,width:d,height:h,params:u})}return t}function cx(e,t=!1){const n=new fi(e),r=new Map,s=n.readUint64AsNumber();for(let i=0;i<s;i++){const a=n.readUint32(),l=[n.readFloat64(),n.readFloat64(),n.readFloat64(),n.readFloat64()],c=[n.readFloat64(),n.readFloat64(),n.readFloat64()],d=n.readUint32(),h=n.readString(),u=n.readUint64AsNumber(),m=[];if(t)n.skip(u*24);else for(let g=0;g<u;g++){const p=n.readFloat64(),y=n.readFloat64(),w=n.readInt64();m.push({xy:[p,y],point3DId:w})}r.set(a,{imageId:a,qvec:l,tvec:c,cameraId:d,name:h,points2D:m,numPoints2D:u})}return r}function ux(e){const t=new Map,n=e.split(`
`);let r=0;for(;r<n.length;){const s=n[r].trim();if(s.startsWith("#")||s===""){r++;continue}const i=s.split(/\s+/);if(i.length<10){r++;continue}const a=parseInt(i[0]),l=[parseFloat(i[1]),parseFloat(i[2]),parseFloat(i[3]),parseFloat(i[4])],c=[parseFloat(i[5]),parseFloat(i[6]),parseFloat(i[7])],d=parseInt(i[8]),h=i[9];r++;const u=[];if(r<n.length&&!n[r].startsWith("#")){const m=n[r].trim();if(m!==""){const g=m.split(/\s+/);for(let p=0;p+2<g.length;p+=3){const y=parseFloat(g[p]),w=parseFloat(g[p+1]),x=BigInt(g[p+2]);u.push({xy:[y,w],point3DId:x})}}}t.set(a,{imageId:a,qvec:l,tvec:c,cameraId:d,name:h,points2D:u}),r++}return t}function dx(e){const t=new fi(e),n=new Map,r=t.readUint64AsNumber();for(let s=0;s<r;s++){const i=t.readUint64(),a=[t.readFloat64(),t.readFloat64(),t.readFloat64()],l=[t.readUint8(),t.readUint8(),t.readUint8()],c=t.readFloat64(),d=t.readUint64AsNumber(),h=[];for(let u=0;u<d;u++)h.push({imageId:t.readUint32(),point2DIdx:t.readUint32()});n.set(i,{point3DId:i,xyz:a,rgb:l,error:c,track:h})}return n}function fx(e){const t=new Map,n=e.split(`
`);for(const r of n){if(r.startsWith("#")||r.trim()==="")continue;const s=r.trim().split(/\s+/);if(s.length<8)continue;const i=BigInt(s[0]),a=[parseFloat(s[1]),parseFloat(s[2]),parseFloat(s[3])],l=[parseInt(s[4]),parseInt(s[5]),parseInt(s[6])],c=parseFloat(s[7]),d=[];for(let h=8;h+1<s.length;h+=2)d.push({imageId:parseInt(s[h]),point2DIdx:parseInt(s[h+1])});t.set(i,{point3DId:i,xyz:a,rgb:l,error:c,track:d})}return t}const hx={CAMERA:0};function mx(e){const t=new fi(e),n=new Map,r=t.readUint64AsNumber();for(let s=0;s<r;s++){const i=t.readUint32(),a=t.readUint32(),l=[];let c=null;if(a>0){const d=t.readInt32(),h=t.readUint32();c={type:d,id:h},l.push({sensorId:c,hasPose:!1});for(let u=1;u<a;u++){const m=t.readInt32(),g=t.readUint32(),p=t.readUint8()!==0,y={sensorId:{type:m,id:g},hasPose:p};if(p){const w=t.readFloat64(),x=t.readFloat64(),v=t.readFloat64(),k=t.readFloat64(),b=t.readFloat64(),S=t.readFloat64(),C=t.readFloat64();y.pose={qvec:[w,x,v,k],tvec:[b,S,C]}}l.push(y)}}n.set(i,{rigId:i,refSensorId:c,sensors:l})}return n}function px(e){const t=new Map,n=e.split(`
`);let r=0;for(;r<n.length;){const s=n[r].trim();if(r++,s.startsWith("#")||s==="")continue;const i=s.split(/\s+/);if(i.length<4)continue;const a=parseInt(i[0]),l=parseInt(i[1]),d={type:parseInt(i[2]),id:parseInt(i[3])},h=[];h.push({sensorId:d,hasPose:!1});for(let u=1;u<l&&r<n.length;u++){const m=n[r].trim();if(r++,m.startsWith("#")||m===""){u--;continue}const g=m.split(/\s+/);if(g.length<3)continue;const p=parseInt(g[0]),y=parseInt(g[1]),w=parseInt(g[2])!==0,x={sensorId:{type:p,id:y},hasPose:w};w&&g.length>=10&&(x.pose={qvec:[parseFloat(g[3]),parseFloat(g[4]),parseFloat(g[5]),parseFloat(g[6])],tvec:[parseFloat(g[7]),parseFloat(g[8]),parseFloat(g[9])]}),h.push(x)}t.set(a,{rigId:a,refSensorId:d,sensors:h})}return t}function gx(e){const t=new fi(e),n=new Map,r=t.readUint64AsNumber();for(let s=0;s<r;s++){const i=t.readUint32(),a=t.readUint32(),l=t.readFloat64(),c=t.readFloat64(),d=t.readFloat64(),h=t.readFloat64(),u=t.readFloat64(),m=t.readFloat64(),g=t.readFloat64(),p={qvec:[l,c,d,h],tvec:[u,m,g]},y=t.readUint32(),w=[];for(let x=0;x<y;x++){const v=t.readInt32(),k=t.readUint32(),b=t.readUint64AsNumber();w.push({sensorId:{type:v,id:k},dataId:b})}n.set(i,{frameId:i,rigId:a,rigFromWorld:p,dataIds:w})}return n}function xx(e){const t=new Map,n=e.split(`
`);let r=0;for(;r<n.length;){const s=n[r].trim();if(r++,s.startsWith("#")||s==="")continue;const i=s.split(/\s+/);if(i.length<10)continue;const a=parseInt(i[0]),l=parseInt(i[1]),c={qvec:[parseFloat(i[2]),parseFloat(i[3]),parseFloat(i[4]),parseFloat(i[5])],tvec:[parseFloat(i[6]),parseFloat(i[7]),parseFloat(i[8])]},d=parseInt(i[9]),h=[];for(let u=0;u<d&&r<n.length;u++){const m=n[r].trim();if(r++,m.startsWith("#")||m===""){u--;continue}const g=m.split(/\s+/);g.length<3||h.push({sensorId:{type:parseInt(g[0]),id:parseInt(g[1])},dataId:parseInt(g[2])})}t.set(a,{frameId:a,rigId:l,rigFromWorld:c,dataIds:h})}return t}function ph(e,t,n){const r=new Map;for(const y of e.keys())r.set(y,{numPoints3D:0,totalError:0,errorCount:0,covisibleSet:new Set});const s=new Map;for(const y of e.keys())s.set(y,new Map);const i=new Map;for(const y of e.keys())i.set(y,new Set);let a=0,l=0,c=0,d=1/0,h=-1/0,u=1/0,m=-1/0;for(const{error:y,trackImageIds:w,point3DId:x}of t){const v=w.length,k=y>=0;c+=v,v<u&&(u=v),v>m&&(m=v),k&&(a+=y,l++,y<d&&(d=y),y>h&&(h=y));for(const b of w){const S=r.get(b);if(S){S.numPoints3D++,k&&(S.totalError+=y,S.errorCount++);for(const M of w)M!==b&&S.covisibleSet.add(M)}const C=i.get(b);C&&C.add(x)}for(let b=0;b<w.length;b++)for(let S=b+1;S<w.length;S++){const C=w[b],M=w[S],I=s.get(C),L=s.get(M);I&&I.set(M,(I.get(M)||0)+1),L&&L.set(C,(L.get(C)||0)+1)}}const g=new Map;for(const[y,w]of r)g.set(y,{numPoints3D:w.numPoints3D,avgError:w.errorCount>0?w.totalError/w.errorCount:0,covisibleCount:w.covisibleSet.size});const p={minError:l>0?d:0,maxError:l>0?h:0,avgError:l>0?a/l:0,minTrackLength:n>0?u:0,maxTrackLength:n>0?m:0,avgTrackLength:n>0?c/n:0,totalObservations:c,totalPoints:n};return{imageStats:g,connectedImagesIndex:s,globalStats:p,imageToPoint3DIds:i}}function yx(e,t){function*n(){for(const r of t.values())yield{error:r.error,trackImageIds:r.track.map(s=>s.imageId),point3DId:r.point3DId}}return ph(e,n(),t.size)}function vx(e,t){const n=t.pointCount,r=t.getErrors(),s=t.getTrackOffsets(),i=t.getTrackImageIds(),a=t.getPoint3DIds();function*l(){if(!(!s||!i||!r))for(let c=0;c<n;c++){const d=s[c],h=s[c+1],u=[];for(let m=d;m<h;m++)u.push(i[m]);yield{error:r[c],trackImageIds:u,point3DId:a?a[c]:BigInt(c+1)}}}return ph(e,l(),n)}let Ps=null,cl=null;function wx(){try{if(typeof WebAssembly=="object"&&typeof WebAssembly.instantiate=="function")return new WebAssembly.Module(new Uint8Array([0,97,115,109,1,0,0,0]))instanceof WebAssembly.Module}catch{}return!1}async function bx(){return cl||Ps||(wx()?(Ps=(async()=>{try{const e="/v0.5.6/",t=`${e}wasm/colmap_wasm.js`,n=await fetch(t);if(!n.ok)throw new Error(`Failed to fetch WASM loader: ${n.status}`);const r=await n.text(),s=new Blob([r],{type:"application/javascript"}),i=URL.createObjectURL(s),a=await import(i);URL.revokeObjectURL(i);const l=a.default,c=await l({locateFile:d=>`${e}wasm/${d}`});return cl=c,console.log("colmap-wasm module loaded successfully"),c}catch(e){return console.warn("Failed to load colmap-wasm module:",e),Ps=null,null}})(),Ps):(console.warn("WebAssembly is not supported in this browser"),null))}class Cx{module=null;reconstruction=null;memoryVersion=0;_disposed=!1;cachedPositions=null;cachedColors=null;cachedErrors=null;cachedTrackLengths=null;imagesBuffer=null;async initialize(){return this.reconstruction?!0:(this.module=await bx(),this.module?(this.reconstruction=new this.module.Reconstruction,!0):!1)}get isReady(){return this.reconstruction!==null}get raw(){return this.reconstruction}invalidateCaches(){this.memoryVersion++,this.cachedPositions=null,this.cachedColors=null,this.cachedErrors=null,this.cachedTrackLengths=null}parsePoints3D(t){if(!this.reconstruction)throw new Error("WASM module not initialized");return this.invalidateCaches(),this.reconstruction.parsePoints3D(t)}parseImages(t){if(!this.reconstruction)throw new Error("WASM module not initialized");return this.invalidateCaches(),this.reconstruction.parseImages(t)}parseImagesLite(t){if(!this.reconstruction)throw new Error("WASM module not initialized");return this.invalidateCaches(),this.imagesBuffer=null,this.reconstruction.parseImagesLite(t)}parseImagesLazy(t){if(!this.reconstruction)throw new Error("WASM module not initialized");return this.invalidateCaches(),this.imagesBuffer=t,typeof this.reconstruction.parseImagesLazy=="function"?this.reconstruction.parseImagesLazy(t):(console.warn("[WASM] parseImagesLazy not available, falling back to parseImages"),this.reconstruction.parseImages(t))}isLazyMode(){return!this.reconstruction||typeof this.reconstruction.isLazyMode!="function"?!1:this.reconstruction.isLazyMode()}loadImagePoints2D(t){return!this.reconstruction||!this.imagesBuffer?null:this.reconstruction.isLazyMode()?this.reconstruction.loadImagePoints2DFromBuffer(t,this.imagesBuffer):this.getImagePoints2D(t)}parseCameras(t){if(!this.reconstruction)throw new Error("WASM module not initialized");return this.reconstruction.parseCameras(t)}parseRigs(t){if(!this.reconstruction)throw new Error("WASM module not initialized");return this.reconstruction.parseRigs(t)}parseFrames(t){if(!this.reconstruction)throw new Error("WASM module not initialized");return this.reconstruction.parseFrames(t)}clear(){this.reconstruction&&(this.reconstruction.clear(),this.invalidateCaches()),this.imagesBuffer=null}get pointCount(){return this.reconstruction?.getPointCount()??0}get imageCount(){return this.reconstruction?.getImageCount()??0}get cameraCount(){return this.reconstruction?.getCameraCount()??0}get rigCount(){return this.reconstruction?.getRigCount()??0}get frameCount(){return this.reconstruction?.getFrameCount()??0}hasPoints(){return!this._disposed&&this.pointCount>0}isDetached(t){return t!==null&&t.buffer.byteLength===0}getPositions(){return this._disposed||!this.reconstruction?null:((!this.cachedPositions||this.isDetached(this.cachedPositions))&&(this.cachedPositions=this.reconstruction.getPositions()),this.cachedPositions)}getPositionsCopy(){const t=this.getPositions();return t?new Float32Array(t):null}getColors(){return this._disposed||!this.reconstruction?null:((!this.cachedColors||this.isDetached(this.cachedColors))&&(this.cachedColors=this.reconstruction.getColors()),this.cachedColors)}getColorsCopy(){const t=this.getColors();return t?new Float32Array(t):null}getErrors(){return this._disposed||!this.reconstruction?null:((!this.cachedErrors||this.isDetached(this.cachedErrors))&&(this.cachedErrors=this.reconstruction.getErrors()),this.cachedErrors)}getTrackLengths(){return this._disposed||!this.reconstruction?null:((!this.cachedTrackLengths||this.isDetached(this.cachedTrackLengths))&&(this.cachedTrackLengths=this.reconstruction.getTrackLengths()),this.cachedTrackLengths)}getImageQuaternions(){return this.reconstruction?.getImageQuaternions()??null}getImageTranslations(){return this.reconstruction?.getImageTranslations()??null}getTrackOffsets(){return this.reconstruction?.getTrackOffsets()??null}getTrackImageIds(){return this.reconstruction?.getTrackImageIds()??null}getTrackPoint2DIdxs(){return this.reconstruction?.getTrackPoint2DIdxs()??null}getPoint3DIds(){return this._disposed?null:this.reconstruction?.getPoint3DIds()??null}getPoints2DXY(){return this.reconstruction?.getPoints2DXY()??null}getPoints2DPoint3DIds(){return this.reconstruction?.getPoints2DPoint3DIds()??null}getPoints2DOffsets(){return this.reconstruction?.getPoints2DOffsets()??null}getNumPoints2DPerImage(){return this.reconstruction?.getNumPoints2DPerImage()??null}getBoundingBox(){return this.reconstruction?.getBoundingBox()??null}getStats(){return this.reconstruction?.getStats()??null}getCameraInfo(t){return this.reconstruction?.getCameraInfo(t)??null}getImageInfo(t){return this.reconstruction?.getImageInfo(t)??null}getAllCameras(){return this.reconstruction?.getAllCameras()??{}}getAllImageInfos(){return this.reconstruction?.getAllImageInfos()??[]}getRig(t){return this.reconstruction?.getRig(t)??null}getFrame(t){return this.reconstruction?.getFrame(t)??null}getAllRigs(){return this.reconstruction?.getAllRigs()??{}}getAllFrames(){return this.reconstruction?.getAllFrames()??{}}hasRigData(){return this.reconstruction?.hasRigData()??!1}getImagePoints2D(t){if(!this.reconstruction)return null;const n=this.reconstruction.getImagePoints2D(t);return n?{xy:n.xy,point3dIds:n.point3dIds,count:n.count}:null}getImagePoints2DArray(t){let n=null;if(this.isLazyMode()?n=this.loadImagePoints2D(t):n=this.getImagePoints2D(t),!n||n.count===0)return[];const r=[];for(let s=0;s<n.count;s++)r.push({xy:[n.xy[s*2],n.xy[s*2+1]],point3DId:n.point3dIds[s]});return r}buildPoints3DMap(){const t=new Map;if(!this.reconstruction)return t;const n=this.pointCount,r=this.getPositions(),s=this.getColors(),i=this.getErrors(),a=this.getTrackOffsets(),l=this.getTrackImageIds(),c=this.getTrackPoint2DIdxs(),d=this.getPoint3DIds();if(!r||!s||!i)return t;for(let h=0;h<n;h++){const u=d?d[h]:BigInt(h+1),m=[];if(a&&l&&c&&h<a.length-1){const g=a[h],p=a[h+1];for(let y=g;y<p;y++)m.push({imageId:l[y],point2DIdx:c[y]})}t.set(u,{point3DId:u,xyz:[r[h*3],r[h*3+1],r[h*3+2]],rgb:[Math.round(s[h*3]*255),Math.round(s[h*3+1]*255),Math.round(s[h*3+2]*255)],error:i[h],track:m})}return t}dispose(){this._disposed=!0,this.invalidateCaches(),this.reconstruction&&(this.reconstruction.delete(),this.reconstruction=null),this.module=null,this.imagesBuffer=null}}async function Sx(){const e=new Cx;return await e.initialize()?e:null}async function kx(e,t,n,r,s){try{const i=await Sx();if(!i)return console.warn("[WASM] Module not available, falling back to JS parser"),null;if(!e.name.endsWith(".bin")||!t.name.endsWith(".bin")||!n.name.endsWith(".bin"))return console.log("[WASM] Text files detected, using JS parser"),i.dispose(),null;const a=r&&s&&r.name.endsWith(".bin")&&s.name.endsWith(".bin"),l=performance.now(),[c,d,h]=await Promise.all([e.arrayBuffer(),t.arrayBuffer(),n.arrayBuffer()]),u=i.parseCameras(c),m=i.parseImagesLazy(d),g=i.parsePoints3D(h);if(!u||!m||!g)return console.warn("[WASM] Failed to parse some files, falling back to JS parser"),i.dispose(),null;const p=performance.now()-l;console.log(`[WASM] Parsed in ${p.toFixed(0)}ms: ${i.cameraCount} cameras, ${i.imageCount} images, ${i.pointCount} points`);const y=new Map,w=i.getAllCameras();for(const C of Object.values(w))y.set(C.cameraId,{cameraId:C.cameraId,modelId:C.modelId,width:C.width,height:C.height,params:C.params});const x=i.getNumPoints2DPerImage(),v=new Map,k=i.getAllImageInfos();for(let C=0;C<k.length;C++){const M=k[C],I=M.quaternion||[1,0,0,0],L=M.translation||[0,0,0],P=x&&C<x.length?x[C]:0;v.set(M.imageId,{imageId:M.imageId,cameraId:M.cameraId,name:M.name,qvec:[I[0],I[1],I[2],I[3]],tvec:[L[0],L[1],L[2]],points2D:[],numPoints2D:P})}let b;if(a&&r&&s)try{const[C,M]=await Promise.all([r.arrayBuffer(),s.arrayBuffer()]),I=i.parseRigs(C),L=i.parseFrames(M);if(I&&L&&i.hasRigData()){const P=new Map,_=i.getAllRigs();for(const B of Object.values(_)){const E=B.sensors.map(F=>{const $={sensorId:{type:F.sensorId.type,id:F.sensorId.id},hasPose:F.hasPose};return F.hasPose&&F.pose&&($.pose={qvec:F.pose.qvec,tvec:F.pose.tvec}),$}),Z=B.refSensorId?{type:B.refSensorId.type,id:B.refSensorId.id}:null;P.set(B.rigId,{rigId:B.rigId,refSensorId:Z,sensors:E})}const N=new Map,D=i.getAllFrames();for(const B of Object.values(D)){const E=B.dataIds.map(Z=>({sensorId:{type:Z.sensorId.type,id:Z.sensorId.id},dataId:Z.dataId}));N.set(B.frameId,{frameId:B.frameId,rigId:B.rigId,rigFromWorld:{qvec:B.rigFromWorld.qvec,tvec:B.rigFromWorld.tvec},dataIds:E})}b={rigs:P,frames:N},console.log(`[WASM] Parsed rig data: ${P.size} rigs, ${N.size} frames`)}}catch(C){console.warn("[WASM] Failed to parse rig/frame files:",C)}const S=performance.now()-l-p;return console.log(`[WASM] Converted to JS Maps in ${S.toFixed(0)}ms`),{cameras:y,images:v,rigData:b,wasmWrapper:i}}catch(i){return console.warn("[WASM] Error during parsing, falling back to JS:",i),null}}const _c={[A.SIMPLE_PINHOLE]:"Simple Pinhole",[A.PINHOLE]:"Pinhole",[A.SIMPLE_RADIAL]:"Simple Radial",[A.RADIAL]:"Radial",[A.OPENCV]:"OpenCV",[A.OPENCV_FISHEYE]:"OpenCV Fisheye",[A.FULL_OPENCV]:"Full OpenCV",[A.FOV]:"FOV",[A.SIMPLE_RADIAL_FISHEYE]:"Simple Radial Fisheye",[A.RADIAL_FISHEYE]:"Radial Fisheye",[A.THIN_PRISM_FISHEYE]:"Thin Prism Fisheye",[A.RAD_TAN_THIN_PRISM_FISHEYE]:"Rad-Tan Thin Prism"},gh={[A.SIMPLE_PINHOLE]:"SIMPLE_PINHOLE",[A.PINHOLE]:"PINHOLE",[A.SIMPLE_RADIAL]:"SIMPLE_RADIAL",[A.RADIAL]:"RADIAL",[A.OPENCV]:"OPENCV",[A.OPENCV_FISHEYE]:"OPENCV_FISHEYE",[A.FULL_OPENCV]:"FULL_OPENCV",[A.FOV]:"FOV",[A.SIMPLE_RADIAL_FISHEYE]:"SIMPLE_RADIAL_FISHEYE",[A.RADIAL_FISHEYE]:"RADIAL_FISHEYE",[A.THIN_PRISM_FISHEYE]:"THIN_PRISM_FISHEYE",[A.RAD_TAN_THIN_PRISM_FISHEYE]:"RAD_TAN_THIN_PRISM_FISHEYE"};function ul(e){return _c[e]??`Unknown (${e})`}function Oa(e,t){if(e.points3D&&e.points3D.size>0)return e.points3D;if(t?.hasPoints()){console.log("[Export] Building points3D Map on-demand from WASM...");const n=performance.now(),r=t.buildPoints3DMap(),s=performance.now()-n;return console.log(`[Export] Built ${r.size.toLocaleString()} points in ${s.toFixed(0)}ms`),r}return console.warn("[Export] No points3D data available for export"),new Map}const Ix=BigInt("18446744073709551615");function At(e){return e.toPrecision(17).replace(/\.?0+$/,"")}function Ar(e){return Array.from(e.keys()).sort((t,n)=>typeof t=="bigint"&&typeof n=="bigint"?t<n?-1:t>n?1:0:Number(t)-Number(n))}function Mx(e){return e===Lc?Ix:e}function jx(e){return e===Lc?"-1":e.toString()}function Ex(e){const t=[];t.push("# Camera list with one line of data per camera:"),t.push("#   CAMERA_ID, MODEL, WIDTH, HEIGHT, PARAMS[]"),t.push(`# Number of cameras: ${e.size}`);for(const n of Ar(e)){const r=e.get(n),s=gh[r.modelId]??"UNKNOWN",i=r.params.map(At).join(" ");t.push(`${n} ${s} ${r.width} ${r.height} ${i}`)}return t.join(`
`)+`
`}function Px(e,t){const n=[],r=a=>a.points2D.length>0?a.points2D:t?t.getImagePoints2DArray(a.imageId):[];let s=0;for(const a of e.values()){const l=r(a);s+=l.filter(c=>c.point3DId!==Lc).length}const i=e.size>0?(s/e.size).toFixed(6):"0";n.push("# Image list with two lines of data per image:"),n.push("#   IMAGE_ID, QW, QX, QY, QZ, TX, TY, TZ, CAMERA_ID, NAME"),n.push("#   POINTS2D[] as (X, Y, POINT3D_ID)"),n.push(`# Number of images: ${e.size}, mean observations per image: ${i}`);for(const a of Ar(e)){const l=e.get(a),[c,d,h,u]=l.qvec,[m,g,p]=l.tvec;n.push([a,At(c),At(d),At(h),At(u),At(m),At(g),At(p),l.cameraId,l.name].join(" "));const w=r(l).map(x=>`${At(x.xy[0])} ${At(x.xy[1])} ${jx(x.point3DId)}`).join(" ");n.push(w)}return n.join(`
`)+`
`}function Nx(e){const t=[];let n=0;for(const s of e.values())n+=s.track.length;const r=e.size>0?(n/e.size).toFixed(6):"0";t.push("# 3D point list with one line of data per point:"),t.push("#   POINT3D_ID, X, Y, Z, R, G, B, ERROR, TRACK[] as (IMAGE_ID, POINT2D_IDX)"),t.push(`# Number of points: ${e.size}, mean track length: ${r}`);for(const s of Ar(e)){const i=e.get(s),[a,l,c]=i.xyz,[d,h,u]=i.rgb,m=i.track.map(g=>`${g.imageId} ${g.point2DIdx}`).join(" ");t.push([s.toString(),At(a),At(l),At(c),d,h,u,At(i.error),m].join(" "))}return t.join(`
`)+`
`}function xh(e){const t=new hi;t.writeUint64FromNumber(e.size);for(const n of Ar(e)){const r=e.get(n);t.writeUint32(n),t.writeInt32(r.modelId),t.writeUint64FromNumber(r.width),t.writeUint64FromNumber(r.height);for(const s of r.params)t.writeFloat64(s)}return t.toArrayBuffer()}function yh(e,t){const n=new hi;n.writeUint64FromNumber(e.size);for(const r of Ar(e)){const s=e.get(r);n.writeUint32(r),n.writeFloat64(s.qvec[0]),n.writeFloat64(s.qvec[1]),n.writeFloat64(s.qvec[2]),n.writeFloat64(s.qvec[3]),n.writeFloat64(s.tvec[0]),n.writeFloat64(s.tvec[1]),n.writeFloat64(s.tvec[2]),n.writeUint32(s.cameraId),n.writeString(s.name);let i=s.points2D;i.length===0&&t&&(i=t.getImagePoints2DArray(r)),n.writeUint64FromNumber(i.length);for(const a of i)n.writeFloat64(a.xy[0]),n.writeFloat64(a.xy[1]),n.writeUint64(Mx(a.point3DId))}return n.toArrayBuffer()}function vh(e){const t=new hi;t.writeUint64FromNumber(e.size);for(const n of Ar(e)){const r=e.get(n);t.writeUint64(n),t.writeFloat64(r.xyz[0]),t.writeFloat64(r.xyz[1]),t.writeFloat64(r.xyz[2]),t.writeUint8(r.rgb[0]),t.writeUint8(r.rgb[1]),t.writeUint8(r.rgb[2]),t.writeFloat64(r.error),t.writeUint64FromNumber(r.track.length);for(const s of r.track)t.writeUint32(s.imageId),t.writeUint32(s.point2DIdx)}return t.toArrayBuffer()}function Ax(e){const t=["ply","format ascii 1.0",`element vertex ${e.size}`,"property float x","property float y","property float z","property uchar red","property uchar green","property uchar blue","end_header"].join(`
`)+`
`,n=[];for(const r of e.values())n.push(`${r.xyz[0]} ${r.xyz[1]} ${r.xyz[2]} ${r.rgb[0]} ${r.rgb[1]} ${r.rgb[2]}`);return t+n.join(`
`)+`
`}function Lx(e){const t=[];t.push("# Rig list with one line per sensor"),t.push("# RIG_ID, NUM_SENSORS, REF_SENSOR_TYPE, REF_SENSOR_ID"),t.push("# SENSOR_TYPE, SENSOR_ID, HAS_POSE[, QW, QX, QY, QZ, TX, TY, TZ]"),t.push(`# Number of rigs: ${e.size}`);for(const n of Ar(e)){const r=e.get(n),s=r.refSensorId?.type??0,i=r.refSensorId?.id??0;t.push(`${n} ${r.sensors.length} ${s} ${i}`);for(let a=1;a<r.sensors.length;a++){const l=r.sensors[a],c=l.hasPose?1:0;if(l.hasPose&&l.pose){const[d,h,u,m]=l.pose.qvec,[g,p,y]=l.pose.tvec;t.push(`${l.sensorId.type} ${l.sensorId.id} ${c} ${At(d)} ${At(h)} ${At(u)} ${At(m)} ${At(g)} ${At(p)} ${At(y)}`)}else t.push(`${l.sensorId.type} ${l.sensorId.id} ${c}`)}}return t.join(`
`)+`
`}function wh(e){const t=new hi;t.writeUint64FromNumber(e.size);for(const n of Ar(e)){const r=e.get(n);if(t.writeUint32(n),t.writeUint32(r.sensors.length),r.sensors.length>0){const s=r.refSensorId?.type??0,i=r.refSensorId?.id??0;t.writeInt32(s),t.writeUint32(i);for(let a=1;a<r.sensors.length;a++){const l=r.sensors[a];t.writeInt32(l.sensorId.type),t.writeUint32(l.sensorId.id),t.writeUint8(l.hasPose?1:0),l.hasPose&&l.pose&&(t.writeFloat64(l.pose.qvec[0]),t.writeFloat64(l.pose.qvec[1]),t.writeFloat64(l.pose.qvec[2]),t.writeFloat64(l.pose.qvec[3]),t.writeFloat64(l.pose.tvec[0]),t.writeFloat64(l.pose.tvec[1]),t.writeFloat64(l.pose.tvec[2]))}}}return t.toArrayBuffer()}function _x(e){const t=[];t.push("# Frame list with one line of data per frame"),t.push("# FRAME_ID, RIG_ID, QW, QX, QY, QZ, TX, TY, TZ, NUM_DATA_IDS"),t.push("# SENSOR_TYPE, SENSOR_ID, DATA_ID"),t.push(`# Number of frames: ${e.size}`);for(const n of Ar(e)){const r=e.get(n),[s,i,a,l]=r.rigFromWorld.qvec,[c,d,h]=r.rigFromWorld.tvec;t.push([n,r.rigId,At(s),At(i),At(a),At(l),At(c),At(d),At(h),r.dataIds.length].join(" "));for(const u of r.dataIds)t.push(`${u.sensorId.type} ${u.sensorId.id} ${u.dataId}`)}return t.join(`
`)+`
`}function bh(e){const t=new hi;t.writeUint64FromNumber(e.size);for(const n of Ar(e)){const r=e.get(n);t.writeUint32(n),t.writeUint32(r.rigId),t.writeFloat64(r.rigFromWorld.qvec[0]),t.writeFloat64(r.rigFromWorld.qvec[1]),t.writeFloat64(r.rigFromWorld.qvec[2]),t.writeFloat64(r.rigFromWorld.qvec[3]),t.writeFloat64(r.rigFromWorld.tvec[0]),t.writeFloat64(r.rigFromWorld.tvec[1]),t.writeFloat64(r.rigFromWorld.tvec[2]),t.writeUint32(r.dataIds.length);for(const s of r.dataIds)t.writeInt32(s.sensorId.type),t.writeUint32(s.sensorId.id),t.writeUint64FromNumber(s.dataId)}return t.toArrayBuffer()}function hr(e,t){const n=typeof e=="string"?new Blob([e],{type:"text/plain;charset=utf-8"}):new Blob([e],{type:"application/octet-stream"}),r=URL.createObjectURL(n),s=document.createElement("a");s.href=r,s.download=t,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(r)}function Tx(e,t){const n=Oa(e,t);if(hr(Ex(e.cameras),"cameras.txt"),hr(Px(e.images,t),"images.txt"),hr(Nx(n),"points3D.txt"),e.rigData){const{rigs:r,frames:s}=e.rigData;r.size>0&&hr(Lx(r),"rigs.txt"),s.size>0&&hr(_x(s),"frames.txt")}}function Gu(e,t){const n=Oa(e,t);if(hr(xh(e.cameras),"cameras.bin"),hr(yh(e.images,t),"images.bin"),hr(vh(n),"points3D.bin"),e.rigData){const{rigs:r,frames:s}=e.rigData;r.size>0&&hr(wh(r),"rigs.bin"),s.size>0&&hr(bh(s),"frames.bin")}}function Rx(e,t){const n=Oa(e,t);hr(Ax(n),"points.ply")}async function Dx(e,t,n,r,s){const{zipSync:i}=await ci(async()=>{const{zipSync:h}=await import("./browser-CXh1ITwj.js");return{zipSync:h}},[]),a={},l=t.compressionLevel??6,c=Oa(e,r);if(a["sparse/0/cameras.bin"]=new Uint8Array(xh(e.cameras)),a["sparse/0/images.bin"]=new Uint8Array(yh(e.images,r)),a["sparse/0/points3D.bin"]=new Uint8Array(vh(c)),e.rigData){const{rigs:h,frames:u}=e.rigData;h.size>0&&(a["sparse/0/rigs.bin"]=new Uint8Array(wh(h))),u.size>0&&(a["sparse/0/frames.bin"]=new Uint8Array(bh(u)))}if(t.includeImages&&n&&n.size>0){let h=0;const u=n.size,m=new Map;for(const[g,p]of n)m.has(p)||m.set(p,g);for(const[g,p]of m){if(!p.includes("/")&&p!==g.name)continue;let y=p.replace(/\\/g,"/");y.startsWith("images/")||(y=`images/${y}`);try{const w=await g.arrayBuffer();if(a[y]=new Uint8Array(w),h++,h%10===0){const x=25+Math.round(h/u*50);s?.(x,`Adding images (${h}/${u})...`)}}catch(w){console.warn(`[ZIP Export] Failed to add image: ${p}`,w)}}}const d=i(a,{level:l});return new Blob([d],{type:"application/zip"})}async function Fx(e,t,n,r,s,i="reconstruction.zip"){const a=await Dx(e,t,n,r,s),l=URL.createObjectURL(a),c=document.createElement("a");c.href=l,c.download=i,document.body.appendChild(c),c.click(),document.body.removeChild(c),URL.revokeObjectURL(l)}function zx(e){const t=e.type.toLowerCase();if(t==="image/jpeg"||t==="image/jpg")return!0;const n=e.name.toLowerCase();return n.endsWith(".jpg")||n.endsWith(".jpeg")}async function Ox(e,t){const n=zx(e)?Math.min(t,.85):t,r=await createImageBitmap(e),s=new OffscreenCanvas(r.width,r.height);return s.getContext("2d").drawImage(r,0,0),r.close(),s.convertToBlob({type:"image/jpeg",quality:n})}function $x(e){let t=e.replace(/\\/g,"/");return t.startsWith("images/")||(t="images/"+t),t}async function Bx(e,t,n,r){const{zipSync:s}=await ci(async()=>{const{zipSync:h}=await import("./browser-CXh1ITwj.js");return{zipSync:h}},[]),i=e.length,a={};let l=0,c=0;for(const h of e){try{const u=await t(h);if(!u){c++,l++,r?.(Math.round(l/i*100),`Skipped: ${h}`);continue}const g=await(await Ox(u,n.jpegQuality)).arrayBuffer(),y=$x(h).replace(/\.[^.]+$/,".jpg");a[y]=new Uint8Array(g)}catch(u){console.warn(`[Image Export] Failed to process ${h}:`,u),c++}l++,r?.(Math.round(l/i*100))}c>0&&console.warn(`[Image Export] ${c}/${i} images failed to export`);const d=s(a,{level:6});return new Blob([d],{type:"application/zip"})}async function Ux(e,t,n,r){const s=await Bx(e,t,n,r),i=URL.createObjectURL(s),a=document.createElement("a");a.href=i,a.download="images.zip",document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(i)}function Hx(e){let t=e.replace(/\\/g,"/");return t.startsWith("images/")&&(t=t.slice(7)),`masks/${t}.png`}async function Wx(e,t,n){const{zipSync:r}=await ci(async()=>{const{zipSync:d}=await import("./browser-CXh1ITwj.js");return{zipSync:d}},[]),s=e.length,i={};let a=0,l=0;for(const d of e){try{const h=await t(d);if(!h){l++,a++,n?.(Math.round(a/s*100),`Skipped: ${d}`);continue}const u=await h.arrayBuffer(),m=Hx(d);i[m]=new Uint8Array(u)}catch(h){console.warn(`[Mask Export] Failed to process ${d}:`,h),l++}a++,n?.(Math.round(a/s*100))}l>0&&console.warn(`[Mask Export] ${l}/${s} masks failed to export`);const c=r(i,{level:6});return new Blob([c],{type:"application/zip"})}async function Vx(e,t,n){const r=await Wx(e,t,n),s=URL.createObjectURL(r),i=document.createElement("a");i.href=s,i.download="masks.zip",document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(s)}function Vl(){if(typeof window>"u")return!1;const e=window.location.hash;if(e){const n=e.startsWith("#")?e.slice(1):e;if(new URLSearchParams(n).get("d"))return!0}return!!new URLSearchParams(window.location.search).get("url")}const qu=Vl(),me=sr((e,t)=>({reconstruction:null,wasmReconstruction:null,loadedFiles:null,droppedFiles:null,loading:!1,error:null,progress:0,sourceType:null,sourceUrl:null,imageUrlBase:null,maskUrlBase:null,sourceManifest:null,urlLoading:qu,urlProgress:qu?{percent:0,message:"Initializing..."}:null,urlError:null,setReconstruction:n=>{e({reconstruction:n,loading:!1,progress:100,error:null})},setWasmReconstruction:n=>{const r=t().wasmReconstruction;r&&r!==n&&r.dispose(),e({wasmReconstruction:n})},setLoadedFiles:n=>e({loadedFiles:n}),setDroppedFiles:n=>e({droppedFiles:n}),setLoading:n=>e({loading:n}),setError:n=>e({error:n,loading:!1}),setProgress:n=>e({progress:n}),setSourceInfo:(n,r=null,s=null,i=null,a=null)=>e({sourceType:n,sourceUrl:r,imageUrlBase:s,maskUrlBase:i,sourceManifest:a}),setUrlLoading:n=>e({urlLoading:n}),setUrlProgress:n=>e({urlProgress:n}),setUrlError:n=>e(n?{urlError:n,urlLoading:!1}:{urlError:n}),clear:()=>{const n=t().wasmReconstruction;n&&n.dispose(),e({reconstruction:null,wasmReconstruction:null,loadedFiles:null,droppedFiles:null,error:null,progress:0,loading:!1,sourceType:null,sourceUrl:null,imageUrlBase:null,maskUrlBase:null,sourceManifest:null,urlLoading:!1,urlProgress:null,urlError:null})}})),Cs=e=>e.reconstruction?.cameras.size??0,Zt={legacy:"colmap-viewer-settings",pointCloud:"colmap-viewer-pointcloud",camera:"colmap-viewer-camera",ui:"colmap-viewer-ui",export:"colmap-viewer-export",rig:"colmap-viewer-rig",guide:"colmap-viewer-guide",profiles:"colmap-viewer-profiles",lastSeenVersion:"colmap-viewer-last-seen-version"},Zx=["pointSize","colorMode","minTrackLength"],Yx=["cameraDisplayMode","cameraScale","cameraMode","flySpeed","frustumColorMode","unselectedCameraOpacity","selectionColorMode","selectionAnimationSpeed","showImagePlanes","selectionPlaneOpacity"],Gx=["showPoints2D","showPoints3D","matchesDisplayMode","matchesOpacity","showMaskOverlay","maskOpacity","showAxes","showGrid","axesOpacity","backgroundColor","autoRotate"],qx=["screenshotSize","screenshotFormat","screenshotHideLogo","exportFormat"];let Xu=!1;function Xx(e){const t={...e};return"showCameras"in t&&typeof t.showCameras=="boolean"&&(t.cameraDisplayMode=t.showCameras?"frustum":"off",delete t.showCameras),"showMatches"in t&&typeof t.showMatches=="boolean"&&(t.matchesDisplayMode=t.showMatches?"static":"off",delete t.showMatches),"rainbowMode"in t&&typeof t.rainbowMode=="boolean"&&(t.selectionColorMode=t.rainbowMode?"rainbow":"static",delete t.rainbowMode),"rainbowSpeed"in t&&(t.selectionAnimationSpeed=t.rainbowSpeed,delete t.rainbowSpeed),t}function Mi(e,t){const n={};for(const r of t)r in e&&(n[r]=e[r]);return n}function ji(e,t){Object.keys(t).length>0&&localStorage.setItem(e,JSON.stringify({state:t,version:0}))}function Kx(){return typeof window>"u"||!localStorage.getItem(Zt.legacy)?!1:![Zt.pointCloud,Zt.camera,Zt.ui,Zt.export].some(n=>localStorage.getItem(n)!==null)}function Qx(){if(Xu||(Xu=!0,!Kx()))return!1;try{const e=localStorage.getItem(Zt.legacy);if(!e)return!1;const t=JSON.parse(e),n=t.state||t,r=Xx(n);return ji(Zt.pointCloud,Mi(r,Zx)),ji(Zt.camera,Mi(r,Yx)),ji(Zt.ui,Mi(r,Gx)),ji(Zt.export,Mi(r,qx)),localStorage.removeItem(Zt.legacy),console.log("[Store Migration] Successfully migrated from legacy store to domain stores"),!0}catch(e){return console.error("[Store Migration] Failed to migrate legacy store:",e),!1}}function Jx(){if(typeof window>"u")return;const e="0.5.6",t=localStorage.getItem(Zt.lastSeenVersion);if(t===null){localStorage.setItem(Zt.lastSeenVersion,e);return}t!==e&&ci(async()=>{const{useNotificationStore:n}=await Promise.resolve().then(()=>d0);return{useNotificationStore:n}},void 0).then(({useNotificationStore:n})=>{n.getState().addNotification("info",`Updated to v${e}! Consider resetting settings via the âŸ³ button in Settings to enable new defaults.`),localStorage.setItem(Zt.lastSeenVersion,e)})}function e0(){Qx(),Jx()}const Vt=sr()(bs(e=>({showPointCloud:!0,pointSize:2,pointOpacity:1,colorMode:"rgb",minTrackLength:2,maxReprojectionError:1/0,thinning:0,selectedPointId:null,setShowPointCloud:t=>e({showPointCloud:t}),togglePointCloud:()=>e(t=>({showPointCloud:!t.showPointCloud})),setPointSize:t=>e({pointSize:t}),setPointOpacity:t=>e({pointOpacity:t}),setColorMode:t=>e({colorMode:t}),setMinTrackLength:t=>e({minTrackLength:t}),setMaxReprojectionError:t=>e({maxReprojectionError:t}),setThinning:t=>e({thinning:t}),setSelectedPointId:t=>e({selectedPointId:t})}),{name:Zt.pointCloud,version:0,partialize:e=>({showPointCloud:e.showPointCloud,pointSize:e.pointSize,pointOpacity:e.pointOpacity,colorMode:e.colorMode,minTrackLength:e.minTrackLength,maxReprojectionError:e.maxReprojectionError,thinning:e.thinning}),merge:(e,t)=>({...t,...e,maxReprojectionError:e?.maxReprojectionError??1/0})})),ce=sr()(bs((e,t)=>({showCameras:!0,cameraDisplayMode:"frustum",cameraScaleFactor:"1",cameraScale:.25,frustumColorMode:"byCamera",frustumSingleColor:"#ff0000",frustumStandbyOpacity:.9,unselectedCameraOpacity:.5,cameraMode:"orbit",cameraProjection:"perspective",cameraFov:60,horizonLock:"off",autoRotateMode:"off",autoRotateSpeed:.5,flySpeed:2.5,flyTransitionDuration:600,flyToImageId:null,pointerLock:!0,selectedImageId:null,showSelectionHighlight:!0,selectionColorMode:"rainbow",selectionColor:"#00ff00",selectionAnimationSpeed:2,selectionPlaneOpacity:1,undistortionEnabled:!1,undistortionMode:"fullFrame",autoFovEnabled:!0,navigationHistory:[],flyToViewState:null,currentViewState:null,setShowCameras:n=>e({showCameras:n}),toggleCameras:()=>e(n=>({showCameras:!n.showCameras})),setCameraDisplayMode:n=>e({cameraDisplayMode:n}),setCameraScaleFactor:n=>e({cameraScaleFactor:n}),setCameraScale:n=>e({cameraScale:n}),setFrustumColorMode:n=>e({frustumColorMode:n}),setFrustumSingleColor:n=>e({frustumSingleColor:n}),setFrustumStandbyOpacity:n=>e({frustumStandbyOpacity:n}),setUnselectedCameraOpacity:n=>e({unselectedCameraOpacity:n}),setCameraMode:n=>e({cameraMode:n}),setCameraProjection:n=>e({cameraProjection:n}),setCameraFov:n=>e({cameraFov:n}),setHorizonLock:n=>e({horizonLock:n}),setAutoRotateMode:n=>e({autoRotateMode:n}),setAutoRotateSpeed:n=>e({autoRotateSpeed:n}),setFlySpeed:n=>e({flySpeed:n}),setFlyTransitionDuration:n=>e({flyTransitionDuration:n}),setPointerLock:n=>e({pointerLock:n}),flyToImage:n=>e({flyToImageId:n}),clearFlyTo:()=>e({flyToImageId:null}),setSelectedImageId:n=>e({selectedImageId:n}),toggleSelectedImageId:n=>e(r=>({selectedImageId:r.selectedImageId===n?null:n})),setShowSelectionHighlight:n=>e({showSelectionHighlight:n}),toggleSelectionHighlight:()=>e(n=>({showSelectionHighlight:!n.showSelectionHighlight})),setSelectionColorMode:n=>e({selectionColorMode:n}),setSelectionColor:n=>e({selectionColor:n}),setSelectionAnimationSpeed:n=>e({selectionAnimationSpeed:n}),setSelectionPlaneOpacity:n=>e({selectionPlaneOpacity:n}),setUndistortionEnabled:n=>e({undistortionEnabled:n}),setUndistortionMode:n=>e({undistortionMode:n}),setAutoFovEnabled:n=>e({autoFovEnabled:n}),pushNavigationHistory:n=>e(r=>({navigationHistory:[...r.navigationHistory,n].slice(-50)})),popNavigationHistory:()=>{const n=t();if(n.navigationHistory.length===0)return;const r=n.navigationHistory[n.navigationHistory.length-1];return e({navigationHistory:n.navigationHistory.slice(0,-1)}),r},peekNavigationHistory:()=>{const n=t();return n.navigationHistory.length>0?n.navigationHistory[n.navigationHistory.length-1]:void 0},clearNavigationHistory:()=>e({navigationHistory:[]}),flyToState:n=>e({flyToViewState:n}),clearFlyToViewState:()=>e({flyToViewState:null}),setCurrentViewState:n=>e({currentViewState:n})}),{name:Zt.camera,version:2,migrate:(e,t)=>{const n=e;return t<1&&(n.cameraDisplayMode==="off"?(n.showCameras=!1,n.cameraDisplayMode="frustum"):n.showCameras=!0),t<2&&(n.selectionColorMode==="off"?(n.showSelectionHighlight=!1,n.selectionColorMode="rainbow"):n.showSelectionHighlight=!0),n},partialize:e=>({showCameras:e.showCameras,cameraDisplayMode:e.cameraDisplayMode,cameraScaleFactor:e.cameraScaleFactor,cameraScale:e.cameraScale,frustumColorMode:e.frustumColorMode,frustumSingleColor:e.frustumSingleColor,frustumStandbyOpacity:e.frustumStandbyOpacity,unselectedCameraOpacity:e.unselectedCameraOpacity,cameraMode:e.cameraMode,cameraProjection:e.cameraProjection,cameraFov:e.cameraFov,horizonLock:e.horizonLock,autoRotateMode:e.autoRotateMode,autoRotateSpeed:e.autoRotateSpeed,flySpeed:e.flySpeed,flyTransitionDuration:e.flyTransitionDuration,pointerLock:e.pointerLock,showSelectionHighlight:e.showSelectionHighlight,selectionColorMode:e.selectionColorMode,selectionColor:e.selectionColor,selectionAnimationSpeed:e.selectionAnimationSpeed,selectionPlaneOpacity:e.selectionPlaneOpacity,undistortionEnabled:e.undistortionEnabled,undistortionMode:e.undistortionMode,autoFovEnabled:e.autoFovEnabled})})),Ku=["resetView","cycleAutoRotate","toggleBackground","toggleAxes","toggleGizmo","onePointOrigin","twoPointScale","threePointAlign","takeScreenshot"],G=sr()(bs(e=>({imageDetailId:null,showPoints2D:!1,showPoints3D:!1,showMatchesInModal:!1,matchedImageId:null,showMatches:!1,matchesDisplayMode:"static",matchesOpacity:.7,matchesColor:"#ff00ff",showMaskOverlay:!1,maskOpacity:.7,showAxes:!0,showGrid:!0,axesCoordinateSystem:"colmap",axesScale:1,gridScale:1,axisLabelMode:"extra",backgroundColor:"#ffffff",showGizmo:!1,idleHideTimeout:3,autoHideElements:{axes:!1,grid:!1,gizmo:!1,points:!1,cameras:!1,matches:!1,rigs:!1,buttons:!0},isIdle:!1,galleryCollapsed:!1,touchUI:{statusBar:!0,galleryFAB:!0,galleryDrawer:!1,modalControls:!0},embedMode:!1,touchMode:!1,touchModeSource:"auto",showDeletionModal:!1,showFloorModal:!1,showConversionModal:!1,showAutoHideEditor:!1,contextMenuActions:Ku,contextMenuPosition:null,showContextMenuEditor:!1,viewResetTrigger:0,viewDirection:null,viewTrigger:0,fps:0,openImageDetail:t=>e({imageDetailId:t,matchedImageId:null}),closeImageDetail:()=>e({imageDetailId:null,matchedImageId:null}),setShowPoints2D:t=>e({showPoints2D:t}),setShowPoints3D:t=>e({showPoints3D:t}),setShowMatchesInModal:t=>e({showMatchesInModal:t,matchedImageId:null}),setMatchedImageId:t=>e({matchedImageId:t}),setShowMatches:t=>e({showMatches:t}),toggleMatches:()=>e(t=>({showMatches:!t.showMatches})),setMatchesDisplayMode:t=>e({matchesDisplayMode:t}),setMatchesOpacity:t=>e({matchesOpacity:t}),setMatchesColor:t=>e({matchesColor:t}),setShowMaskOverlay:t=>e({showMaskOverlay:t}),setMaskOpacity:t=>e({maskOpacity:t}),setShowAxes:t=>e({showAxes:t}),setShowGrid:t=>e({showGrid:t}),toggleAxes:()=>e(t=>({showAxes:!t.showAxes})),toggleGrid:()=>e(t=>({showGrid:!t.showGrid})),setAxesCoordinateSystem:t=>e({axesCoordinateSystem:t}),setAxesScale:t=>e({axesScale:t}),setGridScale:t=>e({gridScale:t}),setAxisLabelMode:t=>e({axisLabelMode:t}),setBackgroundColor:t=>e({backgroundColor:t}),setShowGizmo:t=>e({showGizmo:t}),toggleGizmo:()=>e(t=>({showGizmo:!t.showGizmo})),setIdleHideTimeout:t=>e({idleHideTimeout:t}),setAutoHideElement:(t,n)=>e(r=>({autoHideElements:{...r.autoHideElements,[t]:n}})),setIsIdle:t=>e({isIdle:t}),resetView:()=>e(t=>({viewResetTrigger:t.viewResetTrigger+1})),setView:t=>e(n=>({viewDirection:t,viewTrigger:n.viewTrigger+1})),setGalleryCollapsed:t=>e({galleryCollapsed:t}),toggleGalleryCollapsed:()=>e(t=>({galleryCollapsed:!t.galleryCollapsed})),setTouchUIVisible:(t,n)=>e(r=>({touchUI:{...r.touchUI,[t]:n}})),toggleTouchUI:t=>e(n=>({touchUI:{...n.touchUI,[t]:!n.touchUI[t]}})),setTouchUI:t=>e(n=>({touchUI:{...n.touchUI,...t}})),setEmbedMode:t=>e({embedMode:t}),setTouchMode:(t,n="auto")=>e({touchMode:t,touchModeSource:n}),setShowDeletionModal:t=>e({showDeletionModal:t}),setShowFloorModal:t=>e({showFloorModal:t}),setShowConversionModal:t=>e({showConversionModal:t}),setShowAutoHideEditor:t=>e({showAutoHideEditor:t}),openContextMenu:(t,n)=>e({contextMenuPosition:{x:t,y:n}}),closeContextMenu:()=>e({contextMenuPosition:null}),setContextMenuActions:t=>e({contextMenuActions:t}),addContextMenuAction:t=>e(n=>({contextMenuActions:n.contextMenuActions.includes(t)?n.contextMenuActions:[...n.contextMenuActions,t]})),removeContextMenuAction:t=>e(n=>({contextMenuActions:n.contextMenuActions.filter(r=>r!==t)})),openContextMenuEditor:()=>e({showContextMenuEditor:!0}),closeContextMenuEditor:()=>e({showContextMenuEditor:!1}),setFps:t=>e({fps:t})}),{name:Zt.ui,version:10,migrate:(e,t)=>{const n=e;if(t<3&&(n.contextMenuActions=Ku),t<6&&(delete n.useWasmParser,delete n.liteParserThresholdMB,delete n.memoryStrategy,delete n.imageLoadMode),t<7){const r=n.axesDisplayMode;n.showAxes=r==="axes"||r==="both"||r===void 0,n.showGrid=r==="grid"||r==="both"||r===void 0,delete n.axesDisplayMode}if(t<8){const r=n.gizmoMode;n.showGizmo=r==="local"||r==="global",delete n.gizmoMode}if(t<9){const r=n.matchesDisplayMode;r==="off"?(n.showMatches=!1,n.matchesDisplayMode="static"):n.showMatches=r!==void 0}if(t<10){const r=n.autoHideElements;r&&r.buttons===void 0&&(r.buttons=!0)}return n},partialize:e=>({showPoints2D:e.showPoints2D,showPoints3D:e.showPoints3D,showMatches:e.showMatches,matchesDisplayMode:e.matchesDisplayMode,matchesOpacity:e.matchesOpacity,matchesColor:e.matchesColor,showMaskOverlay:e.showMaskOverlay,maskOpacity:e.maskOpacity,showAxes:e.showAxes,showGrid:e.showGrid,axesCoordinateSystem:e.axesCoordinateSystem,axesScale:e.axesScale,gridScale:e.gridScale,axisLabelMode:e.axisLabelMode,backgroundColor:e.backgroundColor,showGizmo:e.showGizmo,idleHideTimeout:e.idleHideTimeout,autoHideElements:e.autoHideElements,galleryCollapsed:e.galleryCollapsed,contextMenuActions:e.contextMenuActions})})),rt=sr()(bs((e,t)=>({screenshotSize:"current",screenshotFormat:"jpeg",screenshotHideLogo:!1,screenshotTrigger:0,exportFormat:"binary",exportTrigger:0,isRecordingGif:!1,gifRenderProgress:null,gifBlobUrl:null,gifDuration:5,gifDownsample:2,gifSpeed:1,recordingQuality:"high",recordingFormat:"webm",getScreenshotBlob:null,recordGif:null,stopRecording:null,setScreenshotSize:n=>e({screenshotSize:n}),setScreenshotFormat:n=>e({screenshotFormat:n}),setScreenshotHideLogo:n=>e({screenshotHideLogo:n}),takeScreenshot:()=>e(n=>({screenshotTrigger:n.screenshotTrigger+1})),setExportFormat:n=>e({exportFormat:n}),triggerExport:()=>e(n=>({exportTrigger:n.exportTrigger+1})),setGetScreenshotBlob:n=>e({getScreenshotBlob:n}),setRecordGif:n=>e({recordGif:n}),setStopRecording:n=>e({stopRecording:n}),setIsRecordingGif:n=>e({isRecordingGif:n}),setGifRenderProgress:n=>e({gifRenderProgress:n}),setGifBlobUrl:n=>{const r=t().gifBlobUrl;r&&URL.revokeObjectURL(r),e({gifBlobUrl:n})},setGifDuration:n=>e({gifDuration:n}),setGifDownsample:n=>e({gifDownsample:n}),setGifSpeed:n=>e({gifSpeed:n}),setRecordingQuality:n=>e({recordingQuality:n}),setRecordingFormat:n=>e({recordingFormat:n}),downloadGif:()=>{const n=t().gifBlobUrl,r=t().recordingFormat;if(!n)return;const s=r==="webm"?"webm":r==="mp4"?"mp4":"gif",i=document.createElement("a");i.download=`colmap-view-${new Date().toISOString().slice(0,19).replace(/[:-]/g,"")}.${s}`,i.href=n,i.click()}}),{name:Zt.export,version:0,partialize:e=>({screenshotSize:e.screenshotSize,screenshotFormat:e.screenshotFormat,screenshotHideLogo:e.screenshotHideLogo,exportFormat:e.exportFormat,gifDuration:e.gifDuration,gifDownsample:e.gifDownsample,gifSpeed:e.gifSpeed,recordingQuality:e.recordingQuality,recordingFormat:e.recordingFormat})}));function Tc(e){return new Tt(e.qvec[1],e.qvec[2],e.qvec[3],e.qvec[0]).invert()}function ds(e){const t=Tc(e);return new X(e.tvec[0],e.tvec[1],e.tvec[2]).negate().applyQuaternion(t)}function t0(e){const t=Tc(e);return{position:new X(e.tvec[0],e.tvec[1],e.tvec[2]).negate().applyQuaternion(t),quaternion:t}}function xo(e,t){if(e.length===0)return 0;const n=t/100*(e.length-1),r=Math.floor(n),s=Math.ceil(n);return r===s?e[r]:e[r]*(s-n)+e[s]*(n-r)}function os(e){if(e.length===0)return 0;const t=[...e].sort((n,r)=>n-r);return xo(t,50)}function ma(){return{scale:1,rotation:new Tt,translation:new X}}function Hr(e){const t=new Tt,n=new or(e.rotationX,e.rotationY,e.rotationZ,"XYZ");return t.setFromEuler(n),{scale:e.scale,rotation:t,translation:new X(e.translationX,e.translationY,e.translationZ)}}function ss(e){const t=new or().setFromQuaternion(e.rotation,"XYZ");return{scale:e.scale,rotationX:t.x,rotationY:t.y,rotationZ:t.z,translationX:e.translation.x,translationY:e.translation.y,translationZ:e.translation.z}}function Qu(){return{scale:1,rotationX:0,rotationY:0,rotationZ:0,translationX:0,translationY:0,translationZ:0}}function Ch(e,t){const n=new X(t[0],t[1],t[2]);return n.applyQuaternion(e.rotation),n.multiplyScalar(e.scale),n.add(e.translation),[n.x,n.y,n.z]}function n0(e){const t=1/e.scale,n=e.rotation.clone().invert(),r=e.translation.clone().applyQuaternion(n).multiplyScalar(-t);return{scale:t,rotation:n,translation:r}}function is(e,t){const n=e.scale*t.scale,r=e.rotation.clone().multiply(t.rotation).normalize(),s=t.translation.clone().applyQuaternion(e.rotation).multiplyScalar(e.scale).add(e.translation);return{scale:n,rotation:r,translation:s}}function r0(e,t,n){const r={scale:1,rotation:new Tt(t[1],t[2],t[3],t[0]),translation:new X(n[0],n[1],n[2])},s=n0(e),i=is(r,s),a=i.translation.clone().multiplyScalar(e.scale);return{qvec:[i.rotation.w,i.rotation.x,i.rotation.y,i.rotation.z],tvec:[a.x,a.y,a.z]}}function Sh(e,t,n){const r=new Map;for(const[a,l]of t.images){const{qvec:c,tvec:d}=r0(e,l.qvec,l.tvec);r.set(a,{...l,qvec:c,tvec:d})}let s=t.points3D;if(!s||s.size===0)if(n?.hasPoints()){console.log("[Transform] Building points3D Map on-demand from WASM...");const a=performance.now();s=n.buildPoints3DMap();const l=performance.now()-a;console.log(`[Transform] Built ${s.size.toLocaleString()} points in ${l.toFixed(0)}ms`)}else s=new Map;const i=new Map;for(const[a,l]of s){const c=Ch(e,l.xyz);i.set(a,{...l,xyz:c})}return{...t,images:r,points3D:i}}function Ju(e){const t=[];for(const i of e.images.values())t.push(ds(i));if(t.length===0)return ma();const n=os(t.map(i=>i.x)),r=os(t.map(i=>i.y)),s=os(t.map(i=>i.z));return{scale:1,rotation:new Tt,translation:new X(-n,-r,-s)}}function o0(e){const t=new jo;return t.compose(e.translation,e.rotation,new X(e.scale,e.scale,e.scale)),t}function mi(e){return Math.abs(e.scale-1)<1e-9&&Math.abs(e.rotationX)<1e-9&&Math.abs(e.rotationY)<1e-9&&Math.abs(e.rotationZ)<1e-9&&Math.abs(e.translationX)<1e-9&&Math.abs(e.translationY)<1e-9&&Math.abs(e.translationZ)<1e-9}function s0(e,t,n){const r=e.distanceTo(t);if(r<1e-10)return ma();const s=n/r,a=new X().addVectors(e,t).multiplyScalar(.5).clone().multiplyScalar(1-s);return{scale:s,rotation:new Tt,translation:a}}function i0(e){return{scale:1,rotation:new Tt,translation:new X(-e.x,-e.y,-e.z)}}function a0(e,t,n,r=!1,s=new X(0,1,0)){const i=new X().subVectors(t,e),a=new X().subVectors(n,e),l=new X().crossVectors(i,a);if(l.lengthSq()<1e-10)return ma();l.normalize(),r&&l.negate();const c=s.clone().normalize(),d=l.dot(c);if(Math.abs(d-1)<1e-6)return ma();let h;if(Math.abs(d+1)<1e-6){const p=new X(1,0,0);Math.abs(c.dot(p))>.9&&p.set(0,0,1),h=new Tt().setFromAxisAngle(p,Math.PI)}else h=new Tt().setFromUnitVectors(l,c);const u=new X().add(e).add(t).add(n).divideScalar(3),m=u.clone().applyQuaternion(h),g=new X().subVectors(u,m);return{scale:1,rotation:h,translation:g}}const mn=sr()(e=>({transform:Qu(),setTransform:t=>e(n=>({transform:{...n.transform,...t}})),resetTransform:()=>e({transform:Qu()})}));function kh(e){return e==="blender"||e==="unreal"?["Z","Y","X"]:["Y","X","Z"]}function l0(e){return kh(e)[0]}const lt=sr()((e,t)=>({pickingMode:"off",selectedPoints:[],hoveredPoint:null,targetDistance:null,showDistanceModal:!1,modalPosition:null,normalFlipped:!1,targetAxis:"Y",markerRightClickHandled:!1,setPickingMode:n=>e({pickingMode:n,selectedPoints:[],hoveredPoint:null,targetDistance:null,showDistanceModal:!1,modalPosition:null,normalFlipped:!1,targetAxis:"Y",markerRightClickHandled:!1}),addSelectedPoint:(n,r)=>{const{pickingMode:s,selectedPoints:i}=t(),a=s==="origin-1pt"?1:s==="distance-2pt"?2:s==="normal-3pt"?3:0;if(i.length>=a)return;const l=[...i,n],c=l.length>=a;e({selectedPoints:l,...c&&{showDistanceModal:!0,modalPosition:r||null}})},removePointAt:n=>e(r=>({selectedPoints:r.selectedPoints.filter((s,i)=>i!==n),showDistanceModal:!1,modalPosition:null,markerRightClickHandled:!0})),removeLastPoint:()=>e(n=>({selectedPoints:n.selectedPoints.slice(0,-1),showDistanceModal:!1,modalPosition:null})),clearSelectedPoints:()=>e({selectedPoints:[],hoveredPoint:null,targetDistance:null,showDistanceModal:!1,modalPosition:null,normalFlipped:!1,targetAxis:"Y"}),setHoveredPoint:n=>e({hoveredPoint:n}),setTargetDistance:n=>e({targetDistance:n}),setShowDistanceModal:n=>e({showDistanceModal:n}),toggleNormalFlipped:()=>e(n=>({normalFlipped:!n.normalFlipped})),cycleTargetAxis:n=>e(r=>{const s=kh(n),i=s.indexOf(r.targetAxis),a=i===-1?0:(i+1)%3;return{targetAxis:s[a],markerRightClickHandled:!0}}),setTargetAxis:n=>e({targetAxis:n}),reset:()=>e({pickingMode:"off",selectedPoints:[],hoveredPoint:null,targetDistance:null,showDistanceModal:!1,modalPosition:null,normalFlipped:!1,targetAxis:"Y",markerRightClickHandled:!1})})),Bn=sr()(bs(e=>({showRig:!0,rigDisplayMode:"static",rigColorMode:"perFrame",rigLineColor:"#00ffff",rigLineOpacity:.7,setShowRig:t=>e({showRig:t}),toggleRig:()=>e(t=>({showRig:!t.showRig})),setRigDisplayMode:t=>e({rigDisplayMode:t}),setRigColorMode:t=>e({rigColorMode:t}),setRigLineColor:t=>e({rigLineColor:t}),setRigLineOpacity:t=>e({rigLineOpacity:t})}),{name:Zt.rig,version:1,migrate:(e,t)=>{const n=e;return t<1&&(n.rigDisplayMode==="off"?(n.showRig=!1,n.rigDisplayMode="static"):n.showRig=!0),n},partialize:e=>({showRig:e.showRig,rigDisplayMode:e.rigDisplayMode,rigColorMode:e.rigColorMode,rigLineColor:e.rigLineColor,rigLineOpacity:e.rigLineOpacity})}));let c0=0;function u0(){return`notification-${Date.now()}-${++c0}`}const Ft=sr(e=>({notifications:[],addNotification:(t,n,r)=>{const s=u0(),i={id:s,type:t,message:n,duration:t==="info"?r??3e3:void 0};return e(a=>({notifications:[...a.notifications,i]})),s},removeNotification:t=>{e(n=>({notifications:n.notifications.filter(r=>r.id!==t)}))},clearAll:()=>{e({notifications:[]})}})),d0=Object.freeze(Object.defineProperty({__proto__:null,useNotificationStore:Ft},Symbol.toStringTag,{value:"Module"})),pa=sr()(bs((e,t)=>({tipShownCounts:{},showTip:(n,r,s=1)=>{const i=t().tipShownCounts[n]||0;return i>=s?!1:(Ft.getState().addNotification("info",r,5e3),e(a=>({tipShownCounts:{...a.tipShownCounts,[n]:i+1}})),!0)},getTipShownCount:n=>t().tipShownCounts[n]||0,resetGuide:()=>e({tipShownCounts:{}})}),{name:Zt.guide,version:0})),ed={detectedPlane:null,distanceThreshold:.05,maxIterations:1e3,sampleCount:5e4,pointDistances:null,normalFlipped:!1,targetAxis:"Y",floorColorMode:"off",showFloorModal:!1,modalPosition:null,isDetecting:!1},Ct=sr()(e=>({...ed,setDetectedPlane:t=>e({detectedPlane:t}),setDistanceThreshold:t=>e({distanceThreshold:t}),setMaxIterations:t=>e({maxIterations:t}),setSampleCount:t=>e({sampleCount:t}),setPointDistances:t=>e({pointDistances:t}),toggleNormalFlipped:()=>e(t=>({normalFlipped:!t.normalFlipped})),setNormalFlipped:t=>e({normalFlipped:t}),cycleTargetAxis:()=>e(t=>{const n=["X","Y","Z"],s=(n.indexOf(t.targetAxis)+1)%n.length;return{targetAxis:n[s]}}),setTargetAxis:t=>e({targetAxis:t}),setFloorColorMode:t=>e({floorColorMode:t}),setShowFloorModal:t=>e({showFloorModal:t}),setModalPosition:t=>e({modalPosition:t}),setIsDetecting:t=>e({isDetecting:t}),reset:()=>e(ed)})),Qn=sr()((e,t)=>({pendingDeletions:new Set,markForDeletion:n=>e(r=>{const s=new Set(r.pendingDeletions);return s.add(n),{pendingDeletions:s}}),unmarkDeletion:n=>e(r=>{const s=new Set(r.pendingDeletions);return s.delete(n),{pendingDeletions:s}}),toggleDeletion:n=>e(r=>{const s=new Set(r.pendingDeletions);return s.has(n)?s.delete(n):s.add(n),{pendingDeletions:s}}),isMarkedForDeletion:n=>t().pendingDeletions.has(n),markBulkForDeletion:n=>e(r=>{const s=new Set(r.pendingDeletions);for(const i of n)s.add(i);return{pendingDeletions:s}}),unmarkBulkDeletion:n=>e(r=>{const s=new Set(r.pendingDeletions);for(const i of n)s.delete(i);return{pendingDeletions:s}}),clearPendingDeletions:()=>e({pendingDeletions:new Set})})),er={TEXTURE:0,BITMAP:10,BLOB_URL:20,FILE_CACHE:30,STORE_STATE:40,ARCHIVE:50};class f0{entries=new Map;isClearing=!1;register(t){this.entries.has(t.name)&&console.warn(`[CacheManager] Cache "${t.name}" already registered, overwriting`),this.entries.set(t.name,t)}unregister(t){this.entries.delete(t)}clearAll(t={}){if(this.isClearing){console.warn("[CacheManager] clearAll already in progress, skipping");return}this.isClearing=!0;const n=performance.now();try{const r=this.topologicalSort(t);for(const i of r)try{i.clear()}catch(a){console.error(`[CacheManager] Error clearing "${i.name}":`,a)}const s=performance.now()-n;console.log(`[CacheManager] Cleared ${r.length} caches in ${s.toFixed(1)}ms`)}finally{this.isClearing=!1}}clearByNames(t){if(this.isClearing){console.warn("[CacheManager] clearAll already in progress, skipping clearByNames");return}this.isClearing=!0;try{const n=t.map(r=>this.entries.get(r)).filter(r=>r!==void 0).sort((r,s)=>r.priority-s.priority);for(const r of n)try{r.clear()}catch(s){console.error(`[CacheManager] Error clearing "${r.name}":`,s)}}finally{this.isClearing=!1}}getRegisteredNames(){return Array.from(this.entries.keys())}getStatsEntries(){const t=[];for(const n of this.entries.values())if(n.showInStats&&n.getStats)try{const r=n.getStats();t.push({name:n.name,label:n.label,strategy:n.strategy??"memory",memoryType:n.memoryType??"js",stats:r})}catch(r){console.error(`[CacheManager] Error getting stats for "${n.name}":`,r)}return t}getEntry(t){return this.entries.get(t)}topologicalSort(t){let n=Array.from(this.entries.values());t.preserveZip&&(n=n.filter(a=>a.name!=="zipCache"));const r=new Map;for(const a of n){const l=r.get(a.priority)||[];l.push(a),r.set(a.priority,l)}const s=Array.from(r.keys()).sort((a,l)=>a-l),i=[];for(const a of s){const l=r.get(a),c=this.sortGroupByDependencies(l);i.push(...c)}return i}sortGroupByDependencies(t){const n=new Map,r=new Map;for(const l of t)n.set(l.name,0),r.set(l.name,[]);for(const l of t)if(l.dependsOn)for(const c of l.dependsOn)n.has(c)&&(n.set(l.name,(n.get(l.name)||0)+1),r.get(c)?.push(l.name));const s=[];for(const[l,c]of n)c===0&&s.push(l);const i=[],a=new Map(t.map(l=>[l.name,l]));for(;s.length>0;){const l=s.shift();i.push(a.get(l));for(const c of r.get(l)||[]){const d=(n.get(c)||1)-1;n.set(c,d),d===0&&s.push(c)}}for(const l of t)i.includes(l)||(console.warn(`[CacheManager] Circular dependency detected for "${l.name}"`),i.push(l));return i}reset(){this.entries.clear(),this.isClearing=!1}}const Ln=new f0,td={md:8,xl:16},Ds={gallery:td.md,matchView:td.xl},lo={listRowHeight:72,defaultCellHeight:100,modalMinWidth:400,modalMinHeight:300,frustumMaxSize:128,maxConcurrentLoads:12,logoHeight:"5vh"},_t={hoverCard:"w-3.5 h-3.5",social:"w-8 h-8",socialSm:"w-7 h-7"},dl={min:1,max:10,default:2},h0={mobile:1080},ga={width:1920,height:1080},rn={viewportPadding:16,cursorOffset:12,minTop:20},$o={maxWidthPercent:.85,maxHeightPercent:.85,headerHeight:40,footerHeight:50,padding:32},m0={gallery:{defaultSize:30}},fl={logoHeightPercent:.05,paddingPercent:.02,logoAlpha:.7},It={minTapTarget:44,drawerWidth:320,compactButtonHeight:36,longPressDelay:500,doubleTapDelay:300,dragThreshold:10,pinchThreshold:.02,hitTargetScale:2.5,orbitSensitivity:1.5,panSensitivity:1,zoomSensitivity:.5},rr={wheelDebounce:100,resizeDebounce:16,transitionBase:150,galleryOverscan:3,listOverscan:5,textureUploadTimeout:150,textureUploadFallback:16,idleDeadlineBuffer:5,errorToastDuration:5e3},On={fov:60,nearPlane:.001,farPlane:1e4,initialDistanceMultiplier:2.5,zoomTransitionFactor:.2,velocitySmoothingFactor:.5,frameTimeMs:16},kn={rotateSpeed:.003,panSpeed:.002,zoomSpeed:5e-4,damping:.92,flyDamping:.85,minVelocity:1e-4,moveSpeedMultiplier:.02,wheelMoveMultiplier:.001,shiftSpeedBoost:3,minDistance:.1},st={frustum:{default:"#ff0000",selected:"#ff00ff",hover:"#6699aa",deleted:"#ff4444"},point:{triangulated:"#00ff00",untriangulated:"#ff0000"},axis:{x:15073280,y:58880,z:230},interaction:{axisX:"#ff4444",axisY:"#44ff44",axisZ:"#4444ff",hover:"#ffff00"},material:{white:16777215},match:"#ff00ff",wireframe:"#333333"};function Eo(e){return parseInt(e.slice(1),16)}const Ih={X:{hex:Eo(st.interaction.axisX),css:st.interaction.axisX},Y:{hex:Eo(st.interaction.axisY),css:st.interaction.axisY},Z:{hex:Eo(st.interaction.axisZ),css:st.interaction.axisZ}},oo=Eo(st.interaction.hover),p0=[Eo(st.interaction.axisX),Eo(st.interaction.axisY),Eo(st.interaction.axisZ)],nd=[st.interaction.axisX,st.interaction.axisY,st.interaction.axisZ],Zl={negativeAxis:6710886,majorLines:16764040,minorLines:8947848},Ei={bar:"#f59e0b",barBackground:"rgba(255,255,255,0.05)",label:"#e5e7eb",percentage:"#fbbf24"},so={bgVoid:"#0a0a0a",bgSecondary:"#161616",bgSecondaryOverlay:"rgba(22, 22, 22, 0.85)",bgTertiary:"#1e1e1e",textPrimary:"#e8e8e8",textMuted:"#5a5a5a",outline:"#000000",white:"#ffffff"},hl={github:"#facc15",bugs:"#ef4444",colmap:"#60a5fa"},Ns={threshold:.04045,linearScale:12.92,gammaOffset:.055,gammaScale:1.055,gamma:2.4},Wr={chroma:.8,lightness:.4,saturation:1,speedMultiplier:.5,hueSegments:{redToYellow:1/6,yellowToGreen:2/6,greenToCyan:3/6,cyanToBlue:4/6,blueToMagenta:5/6}},$a={jet:{threshold1:.25,threshold2:.5,threshold3:.75,multiplier:4},trackLength:{baseR:.1,rangeR:.1,baseG:.1,rangeG:.9,baseB:.5,rangeB:.2}},ml={max:255},rd=["#e6194b","#3cb44b","#ffe119","#4363d8","#f58231","#911eb4","#42d4f4","#f032e6","#bfef45","#fabed4","#469990","#dcbeff","#9a6324","#fffac8","#800000","#aaffc3","#808000","#ffd8b1","#000075","#a9a9a9"];function Yl(e){return rd[e%rd.length]}const Ir={success:"text-green-400",info:"text-blue-400",warning:"text-amber-400",error:"text-red-400",caution:"text-orange-400",highlight:"text-purple-400"},pl={success:"bg-green-400",info:"bg-blue-400",inactive:"bg-neutral-600"},Cn={axisX:"#e74c3c",axisY:"#2ecc71",axisZ:"#3498db"},Rn={controls:10,dropdown:100,modal:1e3,contextMenu:1050,modalOverlay:1100,mouseTooltip:9999},Wn={matchLines:.7,frustum:{hoveredNoTexture:.6},interaction:{markerHighlight:.8,marker:.9,triangleHovered:.3,triangleDefault:.15,circleHovered:.5,circleDefault:.3,ringHovered:.4,ringDefault:.2},light:{ambient:.5,directional:.5}},ue={base:"inline-flex items-center justify-center rounded transition-colors cursor-pointer select-none",sizes:{xs:"px-2 py-1 text-xs gap-1",sm:"px-2.5 py-1.5 text-sm gap-1.5",md:"px-3 py-1.5 text-base gap-2",lg:"px-4 py-2 text-base gap-2",xl:"px-6 py-3 text-lg gap-3",toggle:"px-4 py-1 text-sm gap-1.5",toggleResponsive:"px-4 py-1 text-xs gap-1",action:"px-4 py-1.5 text-sm gap-2 min-w-[120px]",icon:"p-1",iconMd:"p-1.5",iconLg:"p-2",iconXl:"w-10 h-10"},variants:{primary:"bg-ds-accent text-ds-void hover-bg-ds-accent-90",secondary:"bg-ds-hover text-ds-primary hover-ds-elevated",tertiary:"bg-ds-tertiary text-ds-primary hover-ds-hover border border-ds",ghost:"bg-transparent text-ds-secondary hover-ds-text-primary hover-ds-hover",outline:"bg-transparent text-ds-primary border border-ds hover-ds-hover",danger:"bg-ds-error text-white hover-opacity-90",tab:"bg-transparent text-ds-secondary hover-ds-text-primary hover-ds-tertiary-50",tabActive:"bg-ds-tertiary text-ds-accent border-b-2 border-ds-accent",toggle:"bg-ds-hover text-ds-secondary hover-ds-text-primary hover-ds-elevated",toggleActive:"bg-ds-accent text-ds-void",toggleError:"bg-ds-error/20 text-ds-error border border-ds-error",toggleSuccess:"bg-ds-success/20 text-ds-success border border-ds-success",control:"bg-ds-tertiary text-ds-secondary hover-ds-hover hover-ds-text-primary rounded-lg border border-ds",controlActive:"bg-ds-accent text-ds-void rounded-lg border border-ds-accent",controlHover:"bg-ds-hover text-ds-primary rounded-lg border border-ds"},disabled:"opacity-50 cursor-not-allowed pointer-events-none",close:"text-ds-muted hover-ds-text-primary text-xl leading-none cursor-pointer"};function od(e="secondary",t="md",n=!1){const r=[ue.base,ue.sizes[t],ue.variants[e]];return n&&r.push(ue.disabled),r.join(" ")}const Br={group:"flex gap-2 mt-3",button:`${ue.base} px-1 py-1 text-sm ${ue.variants.toggle} flex-1`,buttonDisabled:`${ue.base} px-1 py-1 text-sm ${ue.disabled} bg-ds-secondary text-ds-muted flex-1`,buttonPrimary:`${ue.base} px-1 py-1 text-sm ${ue.variants.toggleActive} flex-1`,buttonPrimaryDisabled:`${ue.base} px-1 py-1 text-sm ${ue.disabled} bg-ds-secondary text-ds-muted flex-1`,buttonFullWidth:"w-full px-3 py-1.5 bg-ds-accent text-ds-void rounded text-sm hover:opacity-90 transition-opacity",iconButtonConfirm:`p-0.5 ${Ir.success} hover:text-green-300 transition-colors flex items-center`,iconButtonRetry:"p-0.5 text-yellow-400 hover:text-yellow-300 transition-colors flex items-center",iconButtonCancel:`p-0.5 ${Ir.error} hover:text-red-300 transition-colors flex items-center`},nn={base:"bg-ds-input text-ds-primary border border-ds rounded focus-ds transition-colors",sizes:{sm:"px-2 py-1 text-sm",lg:"px-3 py-2 text-base"},select:"bg-ds-input text-ds-primary border border-ds-subtle rounded focus-ds cursor-pointer px-2 py-1",selectPanel:"bg-ds-input text-ds-primary rounded focus-ds cursor-pointer px-2 py-1",selectSizes:{xs:"px-2 py-0.5 text-xs"},range:{base:"accent-ds-accent cursor-pointer"}},_r={item:"bg-ds-tertiary rounded cursor-pointer relative border-2 transition-all",itemSelected:"border-ds-accent bg-ds-hover",itemHover:"border-transparent hover-border-ds-light hover-brightness-110",itemAspect:"aspect-square",itemInner:"absolute inset-0 overflow-hidden rounded-sm",itemImage:"absolute inset-0 w-full h-full object-cover",overlay:"absolute bottom-0 left-0 right-0 px-1.5 py-1.5",overlayText:"text-white text-sm truncate",placeholder:"absolute inset-0 flex items-center justify-center text-ds-muted text-xs p-1 text-center"},Tr={item:"flex items-center gap-3 px-2 h-full rounded cursor-pointer border-2 transition-all",itemSelected:"border-ds-accent bg-ds-hover",itemHover:"border-transparent hover-ds-hover hover-border-ds-light",thumbnail:"flex-shrink-0 bg-ds-hover rounded overflow-hidden",thumbnailSize:"w-14 h-14",thumbnailPlaceholder:"w-full h-full flex items-center justify-center text-ds-muted text-xs",content:"flex-1 min-w-0 overflow-hidden",title:"text-ds-primary text-sm truncate font-medium whitespace-nowrap",subtitle:"text-ds-muted text-xs truncate whitespace-nowrap"},ft={backdrop:"absolute inset-0 bg-ds-void/50 pointer-events-auto",panel:"absolute bg-ds-tertiary rounded-lg shadow-ds-lg flex flex-col pointer-events-auto",toolPanel:"absolute bg-ds-tertiary rounded-lg shadow-ds-lg flex flex-col pointer-events-auto tool-modal-responsive",toolHeader:"flex items-center justify-between px-4 py-2 rounded-t-lg bg-ds-secondary cursor-move select-none",toolHeaderTitle:"text-ds-primary text-sm font-medium",toolHeaderClose:"w-6 h-6 flex items-center justify-center rounded cursor-pointer text-ds-muted hover:text-ds-primary hover:bg-ds-tertiary transition-colors tool-header-close",headerIconButton:"w-6 h-6 flex items-center justify-center rounded cursor-pointer transition-colors",toolContent:"px-4 py-3 space-y-3",iconButtonConfirm:Br.iconButtonConfirm,iconButtonRetry:Br.iconButtonRetry,iconButtonCancel:Br.iconButtonCancel,actionButtonPrimary:Br.buttonFullWidth},g0={row:"hover-ds-tertiary-50"},Pi={attr:"data-tooltip",posAttr:"data-tooltip-pos",positions:{top:void 0,bottom:"bottom",left:"left",right:"right"}};function Mh(e,t){const n={[Pi.attr]:e};return t&&Pi.positions[t]&&(n[Pi.posAttr]=Pi.positions[t]),n}const ve={container:"bg-ds-tertiary rounded-lg px-3 py-2 shadow-ds-lg whitespace-nowrap text-sm",title:"text-ds-primary",subtitle:"text-ds-secondary",hint:"text-ds-secondary text-sm mt-2",hintRow:"flex items-center gap-1"},As={containerWithLayout:"absolute top-4 left-1/2 -translate-x-1/2 z-[500] bg-ds-tertiary rounded-lg shadow-ds-lg max-w-md flex items-start gap-3",error:"border border-ds-error",content:"px-6 py-3 text-ds-primary",titleError:"font-semibold mb-1 text-ds-error",message:"text-base text-ds-secondary"},dr={container:"fixed top-4 left-1/2 -translate-x-1/2 z-toast flex flex-col gap-3 pointer-events-none items-center",toast:"pointer-events-auto bg-ds-tertiary/90 rounded-lg shadow-ds-lg min-w-[300px] max-w-[400px] flex items-stretch",iconContainer:"flex-shrink-0 px-3 flex items-center rounded-l-lg",iconContainerInfo:"text-ds-info",iconContainerWarning:"text-ds-warning",icon:"w-5 h-5",content:"flex items-center py-4 px-4 flex-1",message:"text-sm text-ds-primary break-words",closeButton:"flex-shrink-0 px-3 flex items-center text-ds-muted hover-ds-text-primary hover-ds-hover cursor-pointer transition-colors rounded-r-lg",entering:"animate-slide-in-right",exiting:"animate-fade-out"},Bo={overlay:"absolute inset-0 bg-black/50 backdrop-blur-sm z-[500] flex items-center justify-center",container:"text-center",progressBar:"w-64 h-2 bg-ds-tertiary rounded-full overflow-hidden",progressFill:"h-full bg-white transition-all duration-300",text:"text-xl mb-4 text-white",percentage:"text-base text-white mt-2"},cn={container:"absolute top-3 right-3 flex flex-col gap-2 z-tooltip control-panel-responsive",button:"w-10 h-10 rounded-lg flex items-center justify-center transition-colors relative border border-ds control-button-responsive",buttonActive:"bg-ds-accent text-ds-void border-ds-accent",buttonHover:"bg-ds-hover text-ds-primary",buttonInactive:"bg-ds-tertiary text-ds-secondary hover-ds-hover hover-ds-text-primary",panelWrapper:"absolute right-full top-0 pr-2 z-tooltip",panel:"bg-ds-tertiary border border-ds rounded-lg p-4 w-[240px] shadow-ds-lg hover-panel-responsive",panelTitle:"text-ds-primary text-sm font-medium mb-3",panelContent:"space-y-2",row:"flex items-center gap-2",label:"text-ds-secondary text-sm whitespace-nowrap w-24 flex-shrink-0",value:"text-ds-primary text-sm w-8 text-right flex-shrink-0 cursor-pointer hover-ds-accent box-border",valueInput:"bg-transparent text-ds-primary text-sm w-8 text-right flex-shrink-0 border-none p-0 m-0 focus:outline-none box-border",slider:`${nn.range.base} flex-1 min-w-0`,select:`${nn.selectPanel} py-0.5 pl-2 ml-1.5 text-sm flex-1`,selectRight:`${nn.selectPanel} py-0.5 pl-2 pr-6 text-sm flex-1 min-w-0 w-full`,hint:"text-ds-secondary text-sm mt-3",hintTitle:"mb-1 font-medium",presetGroup:"flex flex-col gap-2 mt-3",presetButton:`${ue.base} ${ue.sizes.toggle} ${ue.variants.toggle} w-full justify-start`,actionGroup:Br.group,actionButton:Br.button,actionButtonDisabled:Br.buttonDisabled,actionButtonPrimary:Br.buttonPrimary,actionButtonPrimaryDisabled:Br.buttonPrimaryDisabled};function x0(e,t){return e?`${cn.button} ${cn.buttonActive}`:t?`${cn.button} ${cn.buttonHover}`:`${cn.button} ${cn.buttonInactive}`}const $n={track:"relative inline-flex items-center cursor-pointer transition-colors duration-200 rounded-full",trackSm:"w-7 h-4",trackMd:"w-9 h-5",trackLg:"w-11 h-6",trackOff:"bg-ds-secondary border border-ds-light",trackOn:"bg-ds-accent border border-ds-accent",thumb:"absolute bg-white rounded-full shadow-sm transition-all duration-200 ease-in-out",thumbSm:"w-2.5 h-2.5",thumbMd:"w-3.5 h-3.5",thumbLg:"w-4.5 h-4.5",disabled:"opacity-50 cursor-not-allowed",container:"flex items-center gap-2",label:"text-ds-secondary text-sm whitespace-nowrap cursor-pointer"},y0={sm:{off:3,on:14},md:{off:3,on:18},lg:{off:3,on:22}};function v0(e,t="md",n=!1){const s={sm:{track:$n.trackSm,thumb:$n.thumbSm},md:{track:$n.trackMd,thumb:$n.thumbMd},lg:{track:$n.trackLg,thumb:$n.thumbLg}}[t],i=y0[t],a=e?$n.trackOn:$n.trackOff;return{track:`${$n.track} ${s.track} ${a}${n?` ${$n.disabled}`:""}`,thumb:`${$n.thumb} ${s.thumb}`,thumbStyle:{left:e?i.on:i.off,top:"50%",transform:"translateY(-50%)"}}}const Ls={container:"absolute inset-0 bg-ds-accent/10 border-4 border-dashed border-ds-accent z-overlay flex items-center justify-center backdrop-blur-sm",content:"text-center",icon:"text-4xl mb-4",title:"text-xl font-semibold text-ds-primary",subtitle:"text-base text-ds-secondary mt-2"},Uo={logo:"absolute bottom-6 left-6 footer-logo-responsive",logoImage:"opacity-70 hover-opacity-100 transition-opacity",socialContainer:"absolute bottom-6 right-6 flex items-center gap-4 footer-social-responsive",socialLink:"text-ds-secondary opacity-70 hover-opacity-100 transition-opacity"},Lt={container:"bg-ds-tertiary rounded-lg shadow-ds-lg overflow-hidden border border-ds py-1",button:"flex items-center gap-2 px-3 py-1.5 text-sm text-ds-primary hover-ds-hover cursor-pointer transition-colors w-full text-left",icon:"w-4 h-4 flex-shrink-0",hotkey:"text-xs font-mono text-gray-500 ml-auto uppercase tracking-wide"},gl={group:"flex items-center gap-2"},sd={container:"h-10 border-t border-ds bg-ds-tertiary text-ds-secondary text-base px-4 flex items-center justify-between status-bar-responsive overflow-visible",group:"flex items-center gap-6 status-bar-group overflow-visible"},Un={container:"h-full flex items-center justify-center text-ds-muted bg-ds-secondary",containerFull:"flex flex-col items-center justify-center h-full p-8 text-center bg-ds-secondary",icon:"text-ds-error text-6xl mb-4",title:"text-xl font-semibold text-ds-primary mb-2",message:"text-ds-secondary mb-4 max-w-md",button:"px-4 py-2 bg-ds-accent text-ds-void rounded hover-bg-ds-accent-90 transition-colors"},In={corner:"absolute w-3 h-3",edge:"absolute",nw:"top-0 left-0 cursor-nw-resize",ne:"top-0 right-0 cursor-ne-resize",sw:"bottom-0 left-0 cursor-sw-resize",se:"bottom-0 right-0 cursor-se-resize",n:"top-0 left-3 right-3 h-2 cursor-n-resize",s:"bottom-0 left-3 right-3 h-2 cursor-s-resize",w:"left-0 top-3 bottom-3 w-2 cursor-w-resize",e:"right-0 top-3 bottom-3 w-2 cursor-e-resize"},xl={container:"absolute left-1/2 z-tooltip",card:"bg-ds-tertiary rounded-lg px-4 py-3 shadow-ds-lg text-sm border border-ds",title:"text-ds-primary text-sm font-medium mb-1"},xa={hueGradient:"linear-gradient(to right, #ff0000, #ffff00, #00ff00, #00ffff, #0000ff, #ff00ff, #ff0000)",hueSlider:"w-full h-4 cursor-pointer appearance-none bg-transparent relative z-10 [&::-webkit-slider-thumb]:appearance-none [&::-webkit-slider-thumb]:w-3 [&::-webkit-slider-thumb]:h-3 [&::-webkit-slider-thumb]:rounded-full [&::-webkit-slider-thumb]:bg-white [&::-webkit-slider-thumb]:border [&::-webkit-slider-thumb]:border-gray-400 [&::-webkit-slider-thumb]:shadow [&::-webkit-slider-thumb]:cursor-pointer [&::-moz-range-thumb]:w-3 [&::-moz-range-thumb]:h-3 [&::-moz-range-thumb]:rounded-full [&::-moz-range-thumb]:bg-white [&::-moz-range-thumb]:border [&::-moz-range-thumb]:border-gray-400 [&::-moz-range-thumb]:cursor-pointer [&::-webkit-slider-runnable-track]:bg-transparent [&::-moz-range-track]:bg-transparent"},Te={wrapper:"relative cursor-help overflow-visible",indicator:"inline-flex items-center gap-1",indicatorLabel:"text-ds-secondary",indicatorValue:"text-ds-primary",tooltipContainer:"absolute z-tooltip",card:"bg-ds-tertiary rounded-lg px-4 py-3 shadow-ds-lg text-sm border border-ds whitespace-nowrap",header:"flex items-center justify-between gap-8 mb-2",headerTitle:"flex items-center gap-1.5 text-ds-primary text-sm font-medium whitespace-nowrap",headerLegend:"flex items-center gap-4 text-[10px]",legendItem:"flex items-center gap-1",legendText:"text-ds-muted",dotMemoryJs:`inline-block w-1.5 h-1.5 rounded-full ${pl.success} flex-shrink-0`,dotMemoryWasm:"inline-block w-1.5 h-1.5 rounded-full bg-amber-400 flex-shrink-0",dotLazy:`inline-block w-1.5 h-1.5 rounded-full ${pl.info} flex-shrink-0`,dotUnavailable:`inline-block w-1.5 h-1.5 rounded-full ${pl.inactive} flex-shrink-0`,table:"w-full text-xs",tableHeader:"text-[10px] text-ds-muted border-b border-ds",tableHeaderCell:"py-1 font-normal whitespace-nowrap",tableHeaderLeft:"text-left",tableHeaderRight:"text-right",tableRowDimmed:"opacity-40",tableCellLabel:"pr-6 whitespace-nowrap",tableCellLabelInner:"flex items-center gap-2",tableCellLabelText:"text-ds-secondary whitespace-nowrap",tableCellCount:"px-4 text-right tabular-nums text-ds-primary whitespace-nowrap",tableCellSize:"pl-4 text-right tabular-nums text-ds-muted whitespace-nowrap w-20",tableFooter:"border-t border-ds font-medium",tableFooterCell:"pt-1.5",tableFooterLabel:"text-ds-secondary"},w0=.99;function Gl(e){const t=e>=w0;return{transparent:!t,depthWrite:t}}const Rc="grayscale(100%) opacity(0.5)",b0=.001;function id(e,t=!0){return t&&e>b0}const ze={showHelp:{keys:"shift+/",description:"Show keyboard shortcuts",category:"general",scopes:["global"],preventDefault:!0},showJoke:{keys:"shift+z",description:"Show random COLMAP joke",category:"general",scopes:["viewer"],preventDefault:!0},showJokePersistent:{keys:"ctrl+shift+z",description:"Show random COLMAP joke (persistent)",category:"general",scopes:["viewer"],preventDefault:!0},resetGuide:{keys:"shift+0",description:"Reset guide tips",category:"general",scopes:["viewer"],preventDefault:!0},closeModal:{keys:"escape",description:"Close modal",category:"modal",scopes:["modal"]},prevImage:{keys:"left",description:"Previous image",category:"modal",scopes:["modal"]},nextImage:{keys:"right",description:"Next image",category:"modal",scopes:["modal"]},resetView:{keys:"r",description:"Reset view",category:"camera",scopes:["viewer"]},viewX:{keys:"1",description:"X-axis view",category:"camera",scopes:["viewer"]},viewY:{keys:"2",description:"Y-axis view",category:"camera",scopes:["viewer"]},viewZ:{keys:"3",description:"Z-axis view",category:"camera",scopes:["viewer"]},viewNegX:{keys:"4",description:"-X axis view",category:"camera",scopes:["viewer"]},viewNegY:{keys:"5",description:"-Y axis view",category:"camera",scopes:["viewer"]},viewNegZ:{keys:"6",description:"-Z axis view",category:"camera",scopes:["viewer"]},toggleGrid:{keys:"g",description:"Toggle grid",category:"camera",scopes:["viewer"]},toggleCameraMode:{keys:"c",description:"Toggle orbit/fly mode",category:"camera",scopes:["viewer"]},toggleBackground:{keys:"b",description:"Toggle background",category:"camera",scopes:["viewer"]},cycleImageLoad:{keys:"i",description:"Cycle image load mode",category:"camera",scopes:["viewer"]},cyclePointSize:{keys:"p",description:"Cycle point cloud color mode",category:"camera",scopes:["viewer"]},cycleCameraDisplay:{keys:"f",description:"Cycle frustum display",category:"camera",scopes:["viewer"]},cycleMatchesDisplay:{keys:"m",description:"Cycle matches display",category:"camera",scopes:["viewer"]},toggleGizmo:{keys:"t",description:"Toggle transform gizmo",category:"camera",scopes:["viewer"]},toggleUndistortion:{keys:"u",description:"Toggle image undistortion",category:"camera",scopes:["viewer"]},moveForward:{keys:"w",description:"Move forward",category:"camera",scopes:["viewer"]},moveBackward:{keys:"s",description:"Move backward",category:"camera",scopes:["viewer"]},moveLeft:{keys:"a",description:"Strafe left",category:"camera",scopes:["viewer"]},moveRight:{keys:"d",description:"Strafe right",category:"camera",scopes:["viewer"]},moveUp:{keys:"e, space",description:"Move up",category:"camera",scopes:["viewer"]},moveDown:{keys:"q",description:"Move down",category:"camera",scopes:["viewer"]},speedBoost:{keys:"shift",description:"Speed boost (hold)",category:"camera",scopes:["viewer"]},adjustFrustumSize:{keys:"alt+scroll",description:"Adjust camera frustum size",category:"camera",scopes:["viewer"]},adjustPointSize:{keys:"ctrl+scroll",description:"Adjust point cloud size",category:"camera",scopes:["viewer"]}},ad={general:"General",modal:"Image Modal",camera:"Camera Controls",navigation:"Navigation"};function C0(e){return Object.values(ze).filter(t=>t.category===e)}function ql(e){return e.split(", ")[0].replace(/ctrl/gi,"Ctrl").replace(/cmd/gi,"âŒ˜").replace(/shift/gi,"Shift").replace(/alt/gi,"Alt").replace(/\+/g," + ").replace(/^left$/gi,"â†").replace(/^right$/gi,"â†’").replace(/^up$/gi,"â†‘").replace(/^down$/gi,"â†“").replace(/^escape$/gi,"Esc").replace(/^enter$/gi,"Enter").replace(/^space$/gi,"Space")}const yl=lo.maxConcurrentLoads,yo=new Set,S0=3e3,k0=50;function I0(){}async function M0(e,t){return new Promise((n,r)=>{let s=!1;const i=setTimeout(()=>{s||(s=!0,r(new Error(`Image decode timed out after ${t}ms`)))},t);createImageBitmap(e).then(a=>{s?a.close():(s=!0,clearTimeout(i),n(a))}).catch(a=>{s||(s=!0,clearTimeout(i),r(a))})})}function j0(){return yo.size}function jh(e){const{maxSize:t,processCanvas:n,dispose:r,idleTimeout:s=rr.textureUploadTimeout,idleFallback:i=rr.textureUploadFallback}=e,a={cache:new Map,loadingPromises:new Map,pendingQueue:[],pendingItems:[],activeLoads:0,cacheGeneration:0,idleCallbackScheduled:!1,paused:!1,bulkMode:!1};function l(p,y){if(a.paused){a.idleCallbackScheduled=!1;return}const w=1;let x=0;for(;a.pendingItems.length>0&&!(y!==void 0&&x>=y||x>=w&&p&&p.timeRemaining()<rr.idleDeadlineBuffer);){x++;const v=a.pendingItems.shift(),k=a.cache.get(v.cacheKey);if(k){v.bitmap.close(),v.resolve(k);continue}const b=Math.min(t/v.bitmap.width,t/v.bitmap.height,1),S=Math.round(v.bitmap.width*b),C=Math.round(v.bitmap.height*b);let M,I;typeof OffscreenCanvas<"u"?(M=new OffscreenCanvas(S,C),I=M.getContext("2d")):(M=document.createElement("canvas"),M.width=S,M.height=C,I=M.getContext("2d")),I&&I.drawImage(v.bitmap,0,0,S,C),v.bitmap.close();const L=n(M);L instanceof Promise?L.then(P=>{P!==null&&a.cache.set(v.cacheKey,P),v.resolve(P)}).catch(()=>{v.resolve(null)}):(a.cache.set(v.cacheKey,L),v.resolve(L))}a.idleCallbackScheduled=!1,a.pendingItems.length>0&&h()}let c=0,d=0;function h(){if(!(a.idleCallbackScheduled||a.paused)){if(a.idleCallbackScheduled=!0,a.bulkMode){queueMicrotask(()=>{l()});return}"requestIdleCallback"in window?requestIdleCallback(p=>{c++;const y=Date.now();(c%100===0||a.pendingItems.length>0&&y-d>1e4)&&(d=y,console.log(`Idle callback #${c}: ${a.pendingItems.length} items to process, ${p?.timeRemaining()?.toFixed(0)}ms remaining`)),l(p)},{timeout:s}):setTimeout(()=>{c++,l()},i)}}function u(){if(!a.paused)for(;a.activeLoads<yl&&a.pendingQueue.length>0;){const p=a.pendingQueue.shift();p&&(a.activeLoads++,p())}}async function m(p,y,w){const x=()=>{w===a.cacheGeneration&&(a.activeLoads--,a.loadingPromises.delete(y),u())};try{if(yo.has(y))return x(),null;if(w!==a.cacheGeneration)return null;const v=a.cache.get(y);if(v)return x(),v;let k;try{k=await M0(p,S0)}catch(b){return yo.add(y),yo.size<=20?console.warn(`[decode] Failed: "${y}" (${(p.size/1024).toFixed(0)} KB) -`,b):yo.size===21&&console.warn(`... suppressing further decode errors (${yo.size} images failed)`),x(),null}return w!==a.cacheGeneration?(k.close(),null):new Promise(b=>{a.pendingItems.length>=k0&&l(void 0,10),a.pendingItems.push({bitmap:k,cacheKey:y,resolve:S=>{x(),b(S)}}),h()})}catch(v){return console.warn(`Failed to load image "${y}":`,v),x(),null}}function g(p,y){const w=a.cacheGeneration;return new Promise(x=>{const v=()=>{if(w!==a.cacheGeneration){x(null);return}m(p,y,w).then(x)};a.activeLoads<yl?(a.activeLoads++,v()):a.pendingQueue.push(()=>v())})}return{getCached(p){return a.cache.get(p)??null},load(p,y){const w=a.cache.get(y);if(w)return Promise.resolve(w);let x=a.loadingPromises.get(y);return x||(x=g(p,y),a.loadingPromises.set(y,x)),x},prioritize(p,y){const w=a.cache.get(y);if(w)return Promise.resolve(w);const x=a.loadingPromises.get(y),v=a.pendingItems.findIndex(k=>k.cacheKey===y);if(v>0){const[k]=a.pendingItems.splice(v,1);return a.pendingItems.unshift(k),h(),x??Promise.resolve(null)}return x||this.load(p,y)},clear(){a.cacheGeneration++;for(const p of a.pendingItems)p.bitmap.close(),p.resolve(null);a.pendingItems.length=0;for(const p of a.cache.values())r(p);a.cache.clear(),a.loadingPromises.clear(),a.pendingQueue.length=0,a.activeLoads=0,a.idleCallbackScheduled=!1,yo.clear()},pause(){a.paused=!0},resume(){a.paused&&(a.paused=!1,a.pendingItems.length>0&&h(),a.pendingQueue.length>0&&u())},async prefetch(p,y){if(p.length===0){y?.(1);return}a.bulkMode=!0;let w=0;const x=p.length;let v=0;const k=()=>{const b=w/x;(b-v>=.05||w===x)&&(v=b,y?.(b))};try{const b=yl*4;for(let S=0;S<p.length;S+=b){const M=p.slice(S,S+b).map(async({file:I,name:L})=>{if(a.cache.has(L)){w++,k();return}let P=a.loadingPromises.get(L);P||(P=g(I,L),a.loadingPromises.set(L,P)),await P,w++,k()});await Promise.all(M)}}finally{a.bulkMode=!1}},getCacheGeneration(){return a.cacheGeneration},getStats(){return{count:a.cache.size,loading:a.loadingPromises.size,pending:a.pendingItems.length}},useCache(p,y,w){const[x,v]=f.useState(()=>w&&y?a.cache.get(y)??null:null),[k,b]=f.useState(a.cacheGeneration),S=k!==a.cacheGeneration;return f.useEffect(()=>{if(S&&(b(a.cacheGeneration),v(null)),!w||!p||!y){v(null);return}const C=a.cache.get(y);if(C){v(C);return}v(null);let M=a.loadingPromises.get(y);M||(M=g(p,y),a.loadingPromises.set(y,M));let I=!1;return M.then(L=>{I||v(L)}),()=>{I=!0}},[p,y,w,S]),S?null:x}}}async function E0(e){try{const t=e instanceof OffscreenCanvas?await e.convertToBlob({type:"image/jpeg",quality:.75}):await new Promise(n=>e.toBlob(n,"image/jpeg",.75));return t?URL.createObjectURL(t):null}catch{return null}}const Ss=jh({maxSize:lo.frustumMaxSize,processCanvas:E0,dispose:e=>URL.revokeObjectURL(e),idleTimeout:rr.textureUploadTimeout,idleFallback:rr.textureUploadFallback}),fs=new Map,P0=50,Pr=new Map;async function Dc(e,t){const n=fs.get(t);if(n)return n.lastUsed=Date.now(),n.bitmap;try{const s=await(await fetch(e)).blob(),i=await createImageBitmap(s);return fs.set(t,{bitmap:i,lastUsed:Date.now()}),i}catch{return null}}function Fc(e,t){if(!e||e.width<=0||e.height<=0)return console.warn(`[useFrustumTexture] Invalid bitmap dimensions for ${t}: ${e?.width}x${e?.height}`),null;const n=new th(e);return n.colorSpace=nh,n.flipY=!1,n.needsUpdate=!0,Pr.set(t,{texture:n,lastUsed:Date.now()}),Pr.size>P0&&A0(),n}function N0(e,t){const n=Pr.get(t);if(n)return n.lastUsed=Date.now(),n.texture;const r=fs.get(t);return r?(r.lastUsed=Date.now(),Fc(r.bitmap,t)):(Dc(e,t),null)}function A0(){const e=Array.from(Pr.entries());e.sort((n,r)=>n[1].lastUsed-r[1].lastUsed);const t=Math.floor(e.length/2);for(let n=0;n<t;n++){const[r,{texture:s}]=e[n];s.dispose(),Pr.delete(r)}}function L0(){Ss.clear();for(const{texture:e}of Pr.values())e.image=null,e.needsUpdate=!1,e.dispose();if(Pr.clear(),$r){const e=$r.texture;e.image=null,e.needsUpdate=!1,e._bitmap&&(e._bitmap.close(),e._bitmap=void 0),e.dispose(),$r=null}for(const{bitmap:e}of fs.values())e.close();fs.clear()}function _0(){Ss.pause()}function T0(){Ss.resume()}function Xl(){return{urlCache:Ss.getStats(),bitmaps:fs.size,textures:Pr.size}}async function Kl(e,t){const n=await Ss.prioritize(e,t);if(!n)return null;const r=Pr.get(t);if(r)return r.lastUsed=Date.now(),r.texture;const s=await Dc(n,t);return s?Fc(s,t):null}function R0(e,t,n){const[r,s]=f.useState(null),i=f.useRef(null),a=Ss.useCache(e,t,n);return f.useEffect(()=>{if(!n||!a){s(null);return}const l=N0(a,t);if(l){i.current=a,s(l);return}let c=!1;return Dc(a,t).then(d=>{if(c||!d)return;const h=Fc(d,t);h&&(i.current=a,s(h))}),()=>{c=!0}},[a,t,n]),f.useEffect(()=>{if(r&&t){const l=Pr.get(t);l&&(l.lastUsed=Date.now())}},[r,t]),r}let $r=null;function D0(e,t,n){const[r,s]=f.useState(null);return f.useEffect(()=>{if(!n||!e){s(null);return}if($r?.name===t){s($r.texture);return}if($r){const a=$r.texture;a._bitmap&&a._bitmap.close(),a.dispose(),$r=null}let i=!1;return createImageBitmap(e).then(a=>{if(i){a.close();return}const l=new th(a);l.colorSpace=nh,l.flipY=!1,l.needsUpdate=!0,l._bitmap=a,$r={name:t,texture:l},s(l)}).catch(()=>{s(null)}),()=>{i=!0}},[e,t,n]),r}const F0=256;async function z0(e){return new Promise(t=>{e instanceof OffscreenCanvas?e.convertToBlob({type:"image/jpeg",quality:.75}).then(n=>{t(URL.createObjectURL(n))}).catch(()=>{t(null)}):e.toBlob(n=>{t(n?URL.createObjectURL(n):null)},"image/jpeg",.75)})}const pi=jh({maxSize:F0,processCanvas:z0,dispose:e=>URL.revokeObjectURL(e),idleTimeout:500,idleFallback:16});function O0(){pi.clear()}function ld(){pi.pause()}function cd(){pi.resume()}function Eh(){return pi.getStats()}function zc(e,t,n){return pi.useCache(e,t,n)}const Ph=Symbol("Comlink.proxy"),$0=Symbol("Comlink.endpoint"),B0=Symbol("Comlink.releaseProxy"),vl=Symbol("Comlink.finalizer"),ta=Symbol("Comlink.thrown"),ud=e=>typeof e=="object"&&e!==null||typeof e=="function",Nh=new Map([["proxy",{canHandle:e=>ud(e)&&e[Ph],serialize(e){const{port1:t,port2:n}=new MessageChannel;return Ah(e,t),[n,[n]]},deserialize:e=>(e.start(),_h(e))}],["throw",{canHandle:e=>ud(e)&&ta in e,serialize({value:e}){let t;return t=e instanceof Error?{isError:!0,value:{message:e.message,name:e.name,stack:e.stack}}:{isError:!1,value:e},[t,[]]},deserialize(e){throw e.isError?Object.assign(new Error(e.value.message),e.value):e.value}}]]);function Ah(e,t=globalThis,n=["*"]){t.addEventListener("message",(function r(s){if(!s||!s.data)return;if(!(function(h,u){for(const m of h)if(u===m||m==="*"||m instanceof RegExp&&m.test(u))return!0;return!1})(n,s.origin))return void console.warn(`Invalid origin '${s.origin}' for comlink proxy`);const{id:i,type:a,path:l}=Object.assign({path:[]},s.data),c=(s.data.argumentList||[]).map(Mo);let d;try{const h=l.slice(0,-1).reduce(((m,g)=>m[g]),e),u=l.reduce(((m,g)=>m[g]),e);switch(a){case"GET":d=u;break;case"SET":h[l.slice(-1)[0]]=Mo(s.data.value),d=!0;break;case"APPLY":d=u.apply(h,c);break;case"CONSTRUCT":d=Oc(new u(...c));break;case"ENDPOINT":{const{port1:m,port2:g}=new MessageChannel;Ah(e,g),d=(function(p,y){return Rh.set(p,y),p})(m,[m])}break;case"RELEASE":d=void 0;break;default:return}}catch(h){d={value:h,[ta]:0}}Promise.resolve(d).catch((h=>({value:h,[ta]:0}))).then((h=>{const[u,m]=va(h);t.postMessage(Object.assign(Object.assign({},u),{id:i}),m),a==="RELEASE"&&(t.removeEventListener("message",r),Lh(t),vl in e&&typeof e[vl]=="function"&&e[vl]())})).catch((h=>{const[u,m]=va({value:new TypeError("Unserializable return value"),[ta]:0});t.postMessage(Object.assign(Object.assign({},u),{id:i}),m)}))})),t.start&&t.start()}function Lh(e){(function(t){return t.constructor.name==="MessagePort"})(e)&&e.close()}function _h(e,t){return Ql(e,[],t)}function Ni(e){if(e)throw new Error("Proxy has been released and is not useable")}function Th(e){return Yo(e,{type:"RELEASE"}).then((()=>{Lh(e)}))}const ya=new WeakMap,Ai="FinalizationRegistry"in globalThis&&new FinalizationRegistry((e=>{const t=(ya.get(e)||0)-1;ya.set(e,t),t===0&&Th(e)}));function Ql(e,t=[],n=function(){}){let r=!1;const s=new Proxy(n,{get(i,a){if(Ni(r),a===B0)return()=>{(function(l){Ai&&Ai.unregister(l)})(s),Th(e),r=!0};if(a==="then"){if(t.length===0)return{then:()=>s};const l=Yo(e,{type:"GET",path:t.map((c=>c.toString()))}).then(Mo);return l.then.bind(l)}return Ql(e,[...t,a])},set(i,a,l){Ni(r);const[c,d]=va(l);return Yo(e,{type:"SET",path:[...t,a].map((h=>h.toString())),value:c},d).then(Mo)},apply(i,a,l){Ni(r);const c=t[t.length-1];if(c===$0)return Yo(e,{type:"ENDPOINT"}).then(Mo);if(c==="bind")return Ql(e,t.slice(0,-1));const[d,h]=dd(l);return Yo(e,{type:"APPLY",path:t.map((u=>u.toString())),argumentList:d},h).then(Mo)},construct(i,a){Ni(r);const[l,c]=dd(a);return Yo(e,{type:"CONSTRUCT",path:t.map((d=>d.toString())),argumentList:l},c).then(Mo)}});return(function(i,a){const l=(ya.get(a)||0)+1;ya.set(a,l),Ai&&Ai.register(i,a,i)})(s,e),s}function dd(e){const t=e.map(va);return[t.map((r=>r[0])),(n=t.map((r=>r[1])),Array.prototype.concat.apply([],n))];var n}const Rh=new WeakMap;function Oc(e){return Object.assign(e,{[Ph]:!0})}function va(e){for(const[t,n]of Nh)if(n.canHandle(e)){const[r,s]=n.serialize(e);return[{type:"HANDLER",name:t,value:r},s]}return[{type:"RAW",value:e},Rh.get(e)||[]]}function Mo(e){switch(e.type){case"HANDLER":return Nh.get(e.name).deserialize(e.value);case"RAW":return e.value}}function Yo(e,t,n){return new Promise((r=>{const s=new Array(4).fill(0).map((()=>Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16))).join("-");e.addEventListener("message",(function i(a){a.data&&a.data.id&&a.data.id===s&&(e.removeEventListener("message",i),r(a.data))})),e.start&&e.start(),e.postMessage(Object.assign({id:s},t),n)}))}class $c{constructor(t,n,r,s,i){this._name=t,this._size=n,this._path=r,this._lastModified=s,this._archiveRef=i}get name(){return this._name}get size(){return this._size}get lastModified(){return this._lastModified}extract(){return this._archiveRef.extractSingleFile(this._path)}}function Jl(e){if(e instanceof File||e instanceof $c||e===null)return e;const t={};for(const n of Object.keys(e))t[n]=Jl(e[n]);return t}function Dh(e,t=""){const n=[];for(const r of Object.keys(e))e[r]instanceof File||e[r]instanceof $c||e[r]===null?n.push({file:e[r]||r,path:t}):n.push(...Dh(e[r],`${t}${r}/`));return n}function fd(e,t){const n=t.split("/");n[n.length-1]===""&&n.pop();let r=e,s=null;for(const i of n)r[i]=r[i]||{},s=r,r=r[i];return[s,n[n.length-1]]}class U0{constructor(t,n,r){this._content={},this._processed=0,this.file=t,this.client=n,this.worker=r}open(){return this._content={},this._processed=0,new Promise(((t,n)=>{this.client.open(this.file,Oc((()=>{t(this)})))}))}async close(){var t;(t=this.worker)===null||t===void 0||t.terminate(),this.worker=null,this.client=null,this.file=null}async hasEncryptedData(){return await this.client.hasEncryptedData()}async usePassword(t){await this.client.usePassword(t)}async setLocale(t){await this.client.setLocale(t)}async getFilesObject(){return this._processed>0?Promise.resolve().then((()=>this._content)):((await this.client.listFiles()).forEach((t=>{const[n,r]=fd(this._content,t.path);t.type==="FILE"&&(n[r]=new $c(t.fileName,t.size,t.path,t.lastModified,this))})),this._processed=1,Jl(this._content))}getFilesArray(){return this.getFilesObject().then((t=>Dh(t)))}async extractSingleFile(t){if(this.worker===null)throw new Error("Archive already closed");const n=await this.client.extractSingleFile(t);return new File([n.fileData],n.fileName,{type:"application/octet-stream",lastModified:n.lastModified/1e6})}async extractFiles(t=void 0){var n;return this._processed>1?Promise.resolve().then((()=>this._content)):((await this.client.extractFiles()).forEach((r=>{const[s,i]=fd(this._content,r.path);r.type==="FILE"&&(s[i]=new File([r.fileData],r.fileName,{type:"application/octet-stream"}),t!==void 0&&setTimeout(t.bind(null,{file:s[i],path:r.path})))})),this._processed=2,(n=this.worker)===null||n===void 0||n.terminate(),Jl(this._content))}}var hd,md;(function(e){e.SEVEN_ZIP="7zip",e.AR="ar",e.ARBSD="arbsd",e.ARGNU="argnu",e.ARSVR4="arsvr4",e.BIN="bin",e.BSDTAR="bsdtar",e.CD9660="cd9660",e.CPIO="cpio",e.GNUTAR="gnutar",e.ISO="iso",e.ISO9660="iso9660",e.MTREE="mtree",e.MTREE_CLASSIC="mtree-classic",e.NEWC="newc",e.ODC="odc",e.OLDTAR="oldtar",e.PAX="pax",e.PAXR="paxr",e.POSIX="posix",e.PWB="pwb",e.RAW="raw",e.RPAX="rpax",e.SHAR="shar",e.SHARDUMP="shardump",e.USTAR="ustar",e.V7TAR="v7tar",e.V7="v7",e.WARC="warc",e.XAR="xar",e.ZIP="zip"})(hd||(hd={})),(function(e){e.B64ENCODE="b64encode",e.BZIP2="bzip2",e.COMPRESS="compress",e.GRZIP="grzip",e.GZIP="gzip",e.LRZIP="lrzip",e.LZ4="lz4",e.LZIP="lzip",e.LZMA="lzma",e.LZOP="lzop",e.UUENCODE="uuencode",e.XZ="xz",e.ZSTD="zstd",e.NONE="none"})(md||(md={}));class _n{static init(t=null){return _n._options=t||{},_n._options}static async open(t){const n=_n.getWorker(_n._options),r=await _n.getClient(n,_n._options);return await new U0(t,r,n).open()}static async write({files:t,outputFileName:n,compression:r,format:s,passphrase:i=null}){const a=_n.getWorker(_n._options),l=await _n.getClient(a,_n._options),c=await l.writeArchive(t,r,s,i);return a.terminate(),new File([c],n,{type:"application/octet-stream"})}static getWorker(t){return t.getWorker?t.getWorker():new Worker(t.workerUrl||new URL("/v0.5.6/assets/worker-bundle-Dx5mKZOL.js",import.meta.url),{type:"module"})}static async getClient(t,n){var r;const s=((r=n.createClient)===null||r===void 0?void 0:r.call(n,t))||_h(t);let{promise:i,resolve:a}=Promise.withResolvers();const l=await new s(Oc((()=>{a()})));return await i,l}}_n._options={},Promise.withResolvers||(Promise.withResolvers=function(){var e,t,n=new this((function(r,s){e=r,t=s}));return{resolve:e,reject:t,promise:n}});const no=e=>`/v0.5.6/${e.replace(/^\//,"")}`,H0=3e4;async function ec(e,t=H0){const n=new AbortController,r=setTimeout(()=>n.abort(),t);try{const s=await fetch(e,{signal:n.signal});return clearTimeout(r),s}catch(s){throw clearTimeout(r),s}}function Fh(e,t){return e instanceof Error?e.name==="AbortError"?{type:"timeout",message:"Request timed out",details:`The request to ${t||"the server"} took too long to respond.`,failedFile:t}:e.name==="TypeError"&&(e.message.includes("Failed to fetch")||e.message.includes("NetworkError")||e.message.includes("CORS"))?{type:"cors",message:"Cross-origin request blocked",details:"This URL does not allow cross-origin requests. The server needs to include CORS headers.",failedFile:t}:e.name==="TypeError"?{type:"network",message:"Network error",details:e.message,failedFile:t}:{type:"unknown",message:e.message,failedFile:t}:{type:"unknown",message:String(e),failedFile:t}}function W0(e,t){return new File([e],t,{type:e.type})}function V0(e){return new URL(e).pathname.split("/").pop()||"unknown"}function Z0(e){if(e.includes("huggingface.co"))return e.replace("/tree/main/","/resolve/main/").replace("/blob/main/","/resolve/main/");const t=e.match(/^https?:\/\/github\.com\/([^/]+)\/([^/]+)\/(blob|tree)\/([^/]+)\/(.*)$/);if(t){const[,n,r,,s,i]=t;return`https://raw.githubusercontent.com/${n}/${r}/${s}/${i}`}return e.includes("gitlab.com")||e.includes("gitlab.")?e.replace("/-/tree/","/-/raw/").replace("/-/blob/","/-/raw/"):e.includes("bitbucket.org")?e.replace("/src/","/raw/"):e.includes("codeberg.org")||e.includes("gitea.")?e.replace("/src/branch/","/raw/branch/"):e}function Y0(e){try{return new URL(e).pathname.toLowerCase().endsWith(".json")}catch{return!1}}function G0(e){if(e.startsWith("s3://"))return"s3";if(e.startsWith("gs://"))return"gcs";try{const n=new URL(e).hostname.toLowerCase();return n.endsWith(".s3.amazonaws.com")||n.includes(".s3.")&&n.endsWith(".amazonaws.com")||n==="s3.amazonaws.com"?"s3":n==="storage.googleapis.com"||n==="storage.cloud.google.com"||n.endsWith(".storage.googleapis.com")?"gcs":n.endsWith(".r2.cloudflarestorage.com")||n.endsWith(".r2.dev")?"r2":n==="www.dropbox.com"||n==="dropbox.com"||n==="dl.dropboxusercontent.com"?"dropbox":null}catch{return null}}function q0(e){try{const n=new URL(e).searchParams;return!!(n.has("X-Amz-Signature")||n.has("Signature")||n.has("X-Goog-Signature")||n.has("Signature")||n.has("token")||n.has("sig")||n.has("signature"))}catch{return!1}}function X0(e){if(q0(e))return e;if(e.startsWith("s3://")){const t=e.match(/^s3:\/\/([^/]+)\/?(.*)?$/);if(t){const[,n,r]=t;return`https://${n}.s3.amazonaws.com/${r||""}`}}if(e.startsWith("gs://")){const t=e.match(/^gs:\/\/([^/]+)\/?(.*)?$/);if(t){const[,n,r]=t;return`https://storage.googleapis.com/${n}/${r||""}`}}try{const t=new URL(e);if(t.hostname==="console.cloud.google.com"&&t.pathname.startsWith("/storage/browser/"))return`https://storage.googleapis.com/${t.pathname.replace("/storage/browser/","")}`;if(t.hostname==="storage.cloud.google.com")return`https://storage.googleapis.com${t.pathname}`;if(t.hostname==="www.dropbox.com"||t.hostname==="dropbox.com"){const n=new URLSearchParams(t.search);n.delete("dl");const r=n.toString();return`https://dl.dropboxusercontent.com${t.pathname+(r?`?${r}`:"")}`}}catch{}return e}function K0(e){switch(e){case"s3":return`AWS S3 CORS Configuration:
1. Go to your S3 bucket in the AWS Console
2. Navigate to Permissions â†’ CORS configuration
3. Add a CORS rule allowing your origin:
   [
     {
       "AllowedOrigins": ["*"],
       "AllowedMethods": ["GET", "HEAD"],
       "AllowedHeaders": ["*"],
       "ExposeHeaders": ["Content-Length", "Content-Type"],
       "MaxAgeSeconds": 3600
     }
   ]
4. Save the configuration`;case"gcs":return`Google Cloud Storage CORS Configuration:
1. Create a cors.json file:
   [
     {
       "origin": ["*"],
       "method": ["GET", "HEAD"],
       "responseHeader": ["Content-Type", "Content-Length"],
       "maxAgeSeconds": 3600
     }
   ]
2. Apply using gsutil:
   gsutil cors set cors.json gs://YOUR_BUCKET_NAME`;case"r2":return`Cloudflare R2 CORS Configuration:
1. Go to your R2 bucket in Cloudflare Dashboard
2. Navigate to Settings â†’ CORS Policy
3. Add a CORS rule:
   - Allowed Origins: * (or your specific domain)
   - Allowed Methods: GET, HEAD
   - Allowed Headers: *
   - Max Age: 3600
4. Save the configuration`;case"dropbox":return`Dropbox Sharing Setup:
1. Right-click the file/folder in Dropbox
2. Select "Share" â†’ "Copy link"
3. Ensure link access is set to "Anyone with the link"

Note: Dropbox automatically handles CORS for shared links.
If you're getting errors, ensure:
- The file is shared publicly (not restricted)
- The link hasn't expired
- You're using a file link, not a folder link`}}function pd(e,t){const n=Fh(e,t);if(n.type==="cors"&&t){const r=G0(t);if(r){const s=K0(r);n.details=`This ${r.toUpperCase()} bucket does not allow cross-origin requests.

${s}`}}return n}const Js=2*1024*1024*1024,Q0=5e3;let gd=!1;function J0(e){try{return new URL(e).pathname.toLowerCase().endsWith(".zip")}catch{return e.toLowerCase().endsWith(".zip")}}function ey(e){return e.name.toLowerCase().endsWith(".zip")||e.type==="application/zip"}async function zh(){gd||(_n.init({workerUrl:no("workers/worker-bundle.js")}),gd=!0)}async function ty(e){try{const t=new AbortController,n=setTimeout(()=>t.abort(),Q0),r=await fetch(e,{method:"HEAD",signal:t.signal});if(clearTimeout(n),!r.ok)return{valid:!1,error:`Failed to access ZIP file (${r.status})`};const s=r.headers.get("content-length");if(!s)return{valid:!0};const i=parseInt(s,10);if(i>Js){const a=(i/1048576).toFixed(1),l=(Js/(1024*1024)).toFixed(0);return{valid:!1,size:i,error:`ZIP file exceeds ${l}MB limit (actual: ${a}MB)`}}return{valid:!0,size:i}}catch(t){return t instanceof Error&&t.name==="AbortError"?{valid:!1,error:"Size check timed out"}:{valid:!0}}}function ny(e){if(e.size>Js){const t=(e.size/1048576).toFixed(1),n=(Js/(1024*1024)).toFixed(0);return{valid:!1,size:e.size,error:`ZIP file exceeds ${n}MB limit (actual: ${t}MB)`}}return{valid:!0,size:e.size}}const ry=[".jpg",".jpeg",".png",".gif",".bmp",".webp",".tiff",".tif"];function oy(e){const t=e.toLowerCase();return ry.some(n=>t.endsWith(n))}function sy(e){const t=e.split("/").pop()?.toLowerCase()??"";return t==="cameras.bin"||t==="cameras.txt"||t==="images.bin"||t==="images.txt"||t==="points3d.bin"||t==="points3d.txt"||t==="rigs.bin"||t==="rigs.txt"||t==="frames.bin"||t==="frames.txt"}async function iy(e,t){t({percent:2,message:"Starting download..."});const n=await ec(e,12e4);if(!n.ok)throw new Error(`Failed to download ZIP (${n.status})`);const r=n.headers.get("content-length"),s=r?parseInt(r,10):0;if(!n.body)return await n.blob();const i=n.body.getReader(),a=[];let l=0;for(;;){const{done:u,value:m}=await i.read();if(u)break;if(a.push(new Uint8Array(m)),l+=m.length,s>0){const g=2+Math.round(l/s*38),p=(l/(1024*1024)).toFixed(1),y=(s/(1024*1024)).toFixed(1);t({percent:g,message:`Downloading ZIP (${p} / ${y} MB)...`,bytesLoaded:l,bytesTotal:s})}else{const g=(l/1048576).toFixed(1);t({percent:20,message:`Downloading ZIP (${g} MB)...`,bytesLoaded:l})}}const c=a.reduce((u,m)=>u+m.length,0),d=new Uint8Array(c);let h=0;for(const u of a)d.set(u,h),h+=u.length;return new Blob([d])}async function Oh(e,t){t({percent:50,message:"Reading archive contents..."});const n=await e.getFilesArray();t({percent:55,message:"Identifying COLMAP files..."});const r=[],s=new Map;let i=0;for(const l of n){let c;if(l.path?c=`${l.path.endsWith("/")?l.path:`${l.path}/`}${l.file.name}`:c=l.file.name,sy(c))r.push({file:l.file,path:c});else if(oy(c)){s.set(c,l.file),i++;const d=c.split("/").pop()??c;s.has(d)||s.set(d,l.file)}}t({percent:60,message:`Extracting ${r.length} COLMAP files...`});const a=new Map;for(let l=0;l<r.length;l++){const c=r[l],d=await c.file.extract();let h=c.path;const u=c.path.split("/").pop()??c.path;if(c.path.includes("sparse/")){const g=c.path.match(/(sparse\/\d+\/[^/]+)$/);g?h=g[1]:h=`sparse/0/${u}`}else h=`sparse/0/${u}`;a.set(h,d);const m=60+Math.round((l+1)/r.length*10);t({percent:m,message:`Extracting ${u}...`})}return t({percent:70,message:`Indexed ${i} images for lazy loading`}),{colmapFiles:a,imageIndex:s,imageCount:i}}async function ay(e,t){await zh(),t({percent:0,message:"Checking ZIP file..."});const n=await ty(e);if(!n.valid)throw new Error(n.error??"Invalid ZIP file");const r=await iy(e,t);if(r.size>Js){const h=(r.size/1048576).toFixed(1);throw new Error(`Downloaded ZIP exceeds size limit (${h}MB)`)}t({percent:40,message:"Opening archive..."});const s=new File([r],"archive.zip",{type:"application/zip"}),i=await _n.open(s),{colmapFiles:a,imageIndex:l,imageCount:c}=await Oh(i,t);if(!((a.has("sparse/0/cameras.bin")||a.has("sparse/0/cameras.txt"))&&(a.has("sparse/0/images.bin")||a.has("sparse/0/images.txt"))&&(a.has("sparse/0/points3d.bin")||a.has("sparse/0/points3D.txt")))){let h=!1,u=!1,m=!1;for(const g of a.keys()){const p=g.toLowerCase();p.includes("cameras.")&&(h=!0),p.includes("images.")&&(u=!0),p.includes("points3d.")&&(m=!0)}if(!h||!u||!m)throw new Error("ZIP does not contain valid COLMAP files (cameras.bin, images.bin, points3D.bin)")}return{colmapFiles:a,imageIndex:l,archive:i,fileSize:r.size,imageCount:c}}async function ly(e,t){await zh(),t({percent:0,message:"Checking ZIP file..."});const n=ny(e);if(!n.valid)throw new Error(n.error??"Invalid ZIP file");t({percent:40,message:"Opening archive..."});const r=await _n.open(e),{colmapFiles:s,imageIndex:i,imageCount:a}=await Oh(r,t);let l=!1,c=!1,d=!1;for(const h of s.keys()){const u=h.toLowerCase();u.includes("cameras.")&&(l=!0),u.includes("images.")&&(c=!0),u.includes("points3d.")&&(d=!0)}if(!l||!c||!d)throw new Error("ZIP does not contain valid COLMAP files (cameras.bin, images.bin, points3D.bin)");return{colmapFiles:s,imageIndex:i,archive:r,fileSize:e.size,imageCount:a}}let Ba=null,hs=null,Bc=0,Uc=0;function $h(e,t,n=0,r=0){Bh(),Ba=e,hs=t,Bc=n,Uc=r}function cy(){return hs}function Hc(){return Ba!==null&&hs!==null}function Bh(){Ba=null,hs=null,Bc=0,Uc=0}function Uh(){return{fileSize:Bc,imageCount:Uc}}function Hh(e,t){const n=e.replace(/\\/g,"/");if(t.has(n))return t.get(n);const r=n.toLowerCase();for(const[a,l]of t.entries())if(a.toLowerCase()===r)return l;const s=n.split("/").pop()??n;if(t.has(s))return t.get(s);const i=["images/","sparse/0/",""];for(const a of i){const l=`${a}${n}`;if(t.has(l))return t.get(l)}return null}async function uy(e){if(!Ba||!hs)return null;const t=Hh(e,hs);if(!t)return null;try{return await t.extract()}catch(n){return console.warn(`[ZIP] Failed to extract ${e}:`,n),null}}const dy=[".jpg",".jpeg",".png",".gif",".bmp",".webp",".tiff",".tif"];function fy(e){const t=e.toLowerCase();return dy.some(n=>t.endsWith(n))}function hy(e){const t=e.split("/"),n=[];for(let r=0;r<t.length;r++)n.push(t.slice(r).join("/"));return n}function my(e){for(const t of e.keys()){const n=t.replace(/\\/g,"/").toLowerCase();if(n.includes("/masks/")||n.startsWith("masks/"))return!0}return!1}function py(e){const t=new Map;for(const[n,r]of e){if(!fy(n))continue;const s=n.replace(/\\/g,"/"),i=hy(s);for(const a of i){t.has(a)||t.set(a,r);const l=a.toLowerCase();t.has(l)||t.set(l,r)}}return t}function Zr(e,t){if(!e||!t)return;const n=t.replace(/\\/g,"/"),r=e.get(n);return r||e.get(n.toLowerCase())}const xd=.75,yd=2048,To=new Map,na=new Set,vo=new Map;function gy(){const e=typeof window<"u"?Math.min(window.devicePixelRatio||1,2):1,t=typeof screen<"u"?screen.width:ga.width,n=typeof screen<"u"?screen.height:ga.height;return{maxWidth:Math.min(Math.round(t*e),yd),maxHeight:Math.min(Math.round(n*e),yd)}}async function Wh(e,t){try{const n=await createImageBitmap(e),{maxWidth:r,maxHeight:s}=gy();let i=n.width,a=n.height;if(n.width>r||n.height>s){const u=Math.min(r/n.width,s/n.height);i=Math.round(n.width*u),a=Math.round(n.height*u)}let l,c;if(typeof OffscreenCanvas<"u"?(l=new OffscreenCanvas(i,a),c=l.getContext("2d")):(l=document.createElement("canvas"),l.width=i,l.height=a,c=l.getContext("2d")),!c)return n.close(),new File([e],t,{type:e.type||"image/png"});c.drawImage(n,0,0,i,a),n.close();let d;l instanceof OffscreenCanvas?d=await l.convertToBlob({type:"image/jpeg",quality:xd}):d=await new Promise((u,m)=>{l.toBlob(g=>g?u(g):m(new Error("Failed to create blob")),"image/jpeg",xd)});const h=t.replace(/\.[^.]+$/,".jpg");return new File([d],h,{type:"image/jpeg"})}catch(n){return console.warn("[URL Image] Compression failed, using original:",n),new File([e],t,{type:e.type||"application/octet-stream"})}}function xy(){To.clear(),na.clear(),vo.clear()}function Jn(e){return To.get(e)}async function ks(e,t){const n=To.get(t);if(n)return n;let r=t.replace(/\\/g,"/");const s=e.toLowerCase(),i=r.toLowerCase();s.endsWith("/images/")&&i.startsWith("images/")&&(r=r.slice(7));const a=e.endsWith("/")?`${e}${r}`:`${e}/${r}`;if(na.has(a))return new Promise(l=>{const c=vo.get(a)||[];c.push(l),vo.set(a,c)});na.add(a);try{const l=await fetch(a);if(!l.ok)return console.warn(`[URL Image] Failed to fetch ${t}: ${l.status}`),null;const c=await l.blob(),d=r.split("/").pop()||r,h=await Wh(c,d);To.set(t,h);const u=vo.get(a)||[];for(const m of u)m(h);return vo.delete(a),h}catch(l){console.warn(`[URL Image] Error fetching ${t}:`,l);const c=vo.get(a)||[];for(const d of c)d(null);return vo.delete(a),null}finally{na.delete(a)}}async function Vh(e,t){let n=t.replace(/\\/g,"/");const r=e.toLowerCase(),s=n.toLowerCase();r.endsWith("/masks/")&&s.startsWith("masks/")&&(n=n.slice(6)),n.toLowerCase().startsWith("images/")&&(n=n.slice(7));const i=e.endsWith("/")?e:`${e}/`,a=[n,`${n}.png`];for(const l of a){const c=`${i}${l}`;try{const d=await fetch(c);if(d.ok){const h=await d.blob(),u=l.split("/").pop()||l;return console.debug(`[URL Mask] Found mask for ${t}`),new File([h],u,{type:h.type||"image/png"})}}catch(d){console.debug(`[URL Mask] Error trying ${c}:`,d)}}return console.debug(`[URL Mask] No mask found for ${t}`),null}async function yy(e,t,n=5){const r=t.filter(s=>!To.has(s));if(r.length!==0)for(let s=0;s<r.length;s+=n){const i=r.slice(s,s+n);await Promise.all(i.map(a=>ks(e,a)))}}function vy(e,t){const n=[];for(const r of e.values())Zr(t,r.name)||n.push({imageId:r.imageId,name:r.name});return{missingImages:n,totalImages:e.size,totalFiles:t.size}}function tc(e,t){if(!e||!t)return;const n=t.replace(/\\/g,"/"),r=n.replace(/\/images\//i,"/masks/").replace(/^images\//i,"masks/"),s=r!==n,a=`masks/${n.replace(/^images\//i,"")}`,c=`masks/${n.split("/").pop()||""}`,d=[];s&&d.push(r,`${r}.png`),d.push(a,`${a}.png`),c!==a&&d.push(c,`${c}.png`);for(const h of d){const u=e.get(h)||e.get(h.toLowerCase());if(u)return u}}const ms=new Map,ps=new Map,ra=new Set,Fr=new Map;function Vn(e){return ms.get(e)}function bn(){return Hc()}async function gs(e){const t=ms.get(e);if(t)return t;if(!Hc())return null;if(ra.has(e))return new Promise(n=>{const r=Fr.get(e)||[];r.push(n),Fr.set(e,r)});ra.add(e);try{const n=await uy(e);if(!n){const a=Fr.get(e)||[];for(const l of a)l(null);return Fr.delete(e),null}const r=e.split("/").pop()||e,s=await Wh(new Blob([await n.arrayBuffer()]),r);ms.set(e,s);const i=Fr.get(e)||[];for(const a of i)a(s);return Fr.delete(e),s}catch(n){console.warn(`[ZIP Image] Error extracting ${e}:`,n);const r=Fr.get(e)||[];for(const s of r)s(null);return Fr.delete(e),null}finally{ra.delete(e)}}function wy(e){const t=e.replace(/\\/g,"/");let n=t;return t.toLowerCase().startsWith("images/")&&(n=t.slice(7)),[`masks/${n}`,`masks/${n}.png`,`masks/${n.split("/").pop()||n}`,`masks/${n.split("/").pop()||n}.png`]}async function Zh(e){const t=ps.get(e);if(t)return t;if(!Hc())return null;const n=cy();if(!n)return null;const r=wy(e);for(const s of r){const i=Hh(s,n);if(i)try{const a=await i.extract();return ps.set(e,a),console.log(`[ZIP Mask] Found mask for ${e}`),a}catch(a){console.debug(`[ZIP Mask] Error extracting ${s}:`,a)}}return console.debug(`[ZIP Mask] No mask found for ${e}`),null}function by(e){for(const t of e)ps.delete(t)}function Cy(){ms.clear(),ps.clear(),ra.clear(),Fr.clear(),Bh()}function Wc(e){let t=0;for(const n of e.values())t+=n.size;return t}function Yh(){return{count:To.size,sizeBytes:Wc(To)}}function Gh(){return{count:ms.size,sizeBytes:Wc(ms)}}function qh(){return{count:ps.size,sizeBytes:Wc(ps)}}function Sy(e){if(!e)return{count:0,sizeBytes:0};const t=new Set;for(const r of e.values())t.add(r);let n=0;for(const r of t)n+=r.size;return{count:t.size,sizeBytes:n}}let vd=!1;function ky(){vd||(vd=!0,Ln.register({name:"frustumTextures",label:"Frustum Textures",priority:er.TEXTURE,clear:L0,getStats:()=>{const e=Xl();return{count:e.textures,sizeBytes:e.textures*65e3}},strategy:"lazy",memoryType:"js",showInStats:!0}),Ln.register({name:"frustumBitmaps",label:"Decoded Bitmaps",priority:er.BITMAP,clear:()=>{},getStats:()=>{const e=Xl();return{count:e.bitmaps,sizeBytes:e.bitmaps*65e3}},strategy:"lazy",memoryType:"js",showInStats:!0}),Ln.register({name:"thumbnails",label:"Thumbnails",priority:er.BLOB_URL,clear:O0,getStats:()=>{const e=Eh();return{count:e.count,sizeBytes:e.count*75e3}},strategy:"lazy",memoryType:"js",showInStats:!0}),Ln.register({name:"sharedDecode",label:"Shared Decode",priority:er.FILE_CACHE,clear:I0}),Ln.register({name:"urlImages",label:"URL Images",priority:er.FILE_CACHE,clear:xy,getStats:Yh,strategy:"lazy",memoryType:"js",showInStats:!0}),Ln.register({name:"zipImages",label:"ZIP Images",priority:er.FILE_CACHE,clear:()=>{},getStats:Gh,strategy:"lazy",memoryType:"js",showInStats:!0}),Ln.register({name:"zipMasks",label:"ZIP Masks",priority:er.FILE_CACHE,clear:()=>{},getStats:qh,strategy:"lazy",memoryType:"js",showInStats:!0}),Ln.register({name:"floorPlaneStore",label:"Floor Plane Store",priority:er.STORE_STATE,clear:()=>{Ct.getState().reset()}}),Ln.register({name:"pointPickingStore",label:"Point Picking Store",priority:er.STORE_STATE,clear:()=>{lt.getState().reset()}}),Ln.register({name:"cameraStoreNavigation",label:"Camera Navigation",priority:er.STORE_STATE,clear:()=>{const e=ce.getState();e.setSelectedImageId(null),e.clearNavigationHistory()}}),Ln.register({name:"uiStoreImageDetail",label:"UI Image Detail",priority:er.STORE_STATE,clear:()=>{G.getState().closeImageDetail()}}),Ln.register({name:"zipCache",label:"ZIP Archive",priority:er.ARCHIVE,clear:Cy,getStats:()=>{const e=Uh();return{count:e.imageCount,sizeBytes:e.fileSize}},strategy:"memory",memoryType:"js",showInStats:!0}),console.log(`[CacheManager] Registered ${Ln.getRegisteredNames().length} caches`))}function Iy(){return Ln.getStatsEntries()}function Cr(e){Ln.clearAll(e??{})}function Xh(e){const{reconstruction:t,wasmReconstruction:n}=me.getState();if(!t)return!1;const r=mn.getState(),s=r.transform;if(!mi(s)){const a=Hr(s),l=Sh(a,t,n),c=Ju(l),d=is(c,a);r.setTransform(ss(d))}else{const a=Ju(t);r.setTransform(ss(a))}return!0}function wa(){const e=me.getState(),{reconstruction:t,wasmReconstruction:n}=e;if(!t)return!1;const r=mn.getState(),{transform:s}=r,i=Hr(s),a=Sh(i,t,n);return n&&e.setWasmReconstruction(null),e.setReconstruction(a),r.resetTransform(),!0}function My(e,t){if(t.size===0)return null;const n=new Map;for(const[d,h]of e.images)t.has(d)||n.set(d,h);const r=new Set;for(const d of n.values())r.add(d.cameraId);const s=new Map;for(const[d,h]of e.cameras)r.has(d)&&s.set(d,h);const i=new Map;for(const[d,h]of e.imageStats)t.has(d)||i.set(d,h);const a=new Map;for(const[d,h]of e.connectedImagesIndex)if(!t.has(d)){const u=new Map;for(const[m,g]of h)t.has(m)||u.set(m,g);u.size>0&&a.set(d,u)}const l=new Map;for(const[d,h]of e.imageToPoint3DIds)t.has(d)||l.set(d,h);let c;if(e.points3D){c=new Map;for(const[d,h]of e.points3D){const u=h.track.filter(m=>!t.has(m.imageId));c.set(d,{...h,track:u})}for(const[d,h]of l){const u=new Set;for(const m of h)c.has(m)&&u.add(m);u.size>0?l.set(d,u):l.delete(d)}}return{cameras:s,images:n,points3D:c,imageStats:i,connectedImagesIndex:a,globalStats:e.globalStats,imageToPoint3DIds:l,rigData:e.rigData}}function jy(){const e=me.getState(),{reconstruction:t}=e;if(!t)return!1;const n=Qn.getState(),{pendingDeletions:r}=n;if(r.size===0)return!1;const s=My(t,r);if(!s)return!1;Ct.getState().setPointDistances(null);const i=Array.from(r).map(c=>t.images.get(c)?.name).filter(c=>c!==void 0);by(i),e.setReconstruction(s),n.clearPendingDeletions();const a=ce.getState();a.selectedImageId!==null&&r.has(a.selectedImageId)&&a.setSelectedImageId(null);const l=G.getState();return l.imageDetailId!==null&&r.has(l.imageDetailId)&&l.closeImageDetail(),l.matchedImageId!==null&&r.has(l.matchedImageId)&&l.setMatchedImageId(null),!0}function Ey(){Qn.getState().clearPendingDeletions()}function Py(e){for(const[,t]of e){const n=t.name.toLowerCase();if(n.endsWith(".yaml")||n.endsWith(".yml"))return t}return null}function Ny(e){for(const[,t]of e){const n=t.name.toLowerCase();if(n==="cameras.bin"||n==="cameras.txt"||n==="images.bin"||n==="images.txt"||n==="points3d.bin"||n==="points3d.txt")return!0}return!1}function wd(e){const t=[".jpg",".jpeg",".png",".gif",".bmp",".webp",".tiff",".tif"];for(const[,n]of e){const r=n.name.toLowerCase();if(t.some(s=>r.endsWith(s)))return!0}return!1}function Ay(e){const s={cameraId:1,modelId:A.PINHOLE,width:1920,height:1080,params:[1920,1920,960,540]},i=new Map;i.set(1,s);const a=new Map,l=new Map,c=new Set;for(const[,u]of e)c.add(u.name);let d=1;for(const u of c){const m={imageId:d,cameraId:1,name:u,qvec:[1,0,0,0],tvec:[0,0,0],points2D:[],numPoints2D:0};a.set(d,m),l.set(d,{numPoints3D:0,avgError:0,covisibleCount:0}),d++}return{cameras:i,images:a,imageStats:l,connectedImagesIndex:new Map,globalStats:{minError:0,maxError:0,avgError:0,minTrackLength:0,maxTrackLength:0,avgTrackLength:0,totalObservations:0,totalPoints:0},imageToPoint3DIds:new Map}}const Vc=1;const Ly={key:"pointCloud",storeHook:"usePointCloudStore",properties:[{key:"showPointCloud",type:"boolean",default:!0,persist:!0,description:"Show point cloud"},{key:"pointSize",type:"number",min:.1,max:50,default:2,persist:!0,description:"Point size (0.1 - 50)"},{key:"pointOpacity",type:"number",min:0,max:1,default:1,persist:!0,description:"Point opacity (0 - 1)"},{key:"colorMode",type:"enum",enumValues:qg,default:"rgb",persist:!0,description:"rgb | error | trackLength"},{key:"minTrackLength",type:"number",min:1,isInt:!0,default:2,persist:!0,description:"Minimum observations for a point"},{key:"maxReprojectionError",type:"number",min:0,nullable:!0,default:null,persist:!0,description:"null = show all points"},{key:"thinning",type:"number",min:0,max:99,isInt:!0,default:0,persist:!0,description:"Skip every N points (0 = show all)"}]},_y={key:"camera",storeHook:"useCameraStore",properties:[{key:"show",storeKey:"showCameras",type:"boolean",default:!0,persist:!0,description:"Show/hide camera frustums"},{key:"displayMode",storeKey:"cameraDisplayMode",type:"enum",enumValues:Ji,default:"frustum",persist:!0,description:"frustum | arrow | imageplane"},{key:"scaleFactor",storeKey:"cameraScaleFactor",type:"enum",enumValues:Kg,default:"1",persist:!0,description:"0.1 | 1 | 10"},{key:"scale",storeKey:"cameraScale",type:"number",min:.01,max:10,default:.25,persist:!0,description:"Frustum size multiplier (0.01 - 10)"},{key:"frustumColorMode",type:"enum",enumValues:Xg,default:"byCamera",persist:!0,description:"single | byCamera | byRigFrame"},{key:"frustumSingleColor",type:"string",pattern:/^#[0-9A-Fa-f]{6}$/,patternDesc:"hex color (#RRGGBB)",default:st.frustum.default,persist:!0,description:"Hex color for single frustum color mode"},{key:"frustumStandbyOpacity",type:"number",min:0,max:1,default:.9,persist:!0,description:"Frustum opacity when no camera is selected (0 - 1)"},{key:"unselectedOpacity",storeKey:"unselectedCameraOpacity",type:"number",min:.1,max:.6,default:.5,persist:!0,description:"Opacity of non-selected cameras (0.1 - 0.6)"},{key:"mode",storeKey:"cameraMode",type:"enum",enumValues:qi,default:"orbit",persist:!0,description:"orbit | fly"},{key:"projection",storeKey:"cameraProjection",type:"enum",enumValues:Xi,default:"perspective",persist:!0,description:"perspective | orthographic"},{key:"fov",storeKey:"cameraFov",type:"number",min:10,max:120,default:60,persist:!0,description:"Field of view (10 - 120)"},{key:"horizonLock",type:"enum",enumValues:Qi,default:"off",persist:!0,description:"off | on | flip"},{key:"autoRotateMode",type:"enum",enumValues:Ki,default:"off",persist:!0,description:"off | cw | ccw"},{key:"autoRotateSpeed",type:"number",min:.1,max:2,default:.5,persist:!0,description:"Auto-rotate speed in radians per second (0.1 - 2)"},{key:"flySpeed",type:"number",min:.1,max:50,default:2.5,persist:!0,description:"Flying speed (0.1 - 50)"},{key:"flyTransitionDuration",type:"number",min:0,max:2e3,default:600,persist:!0,description:"Fly-to animation duration in ms (0 = instant)"},{key:"pointerLock",type:"boolean",default:!0,persist:!0},{key:"showSelectionHighlight",type:"boolean",default:!0,persist:!0,description:"Show/hide selection point highlighting"},{key:"selectionColorMode",type:"enum",enumValues:ea,default:"rainbow",persist:!0,description:"static | blink | rainbow"},{key:"selectionColor",type:"string",pattern:/^#[0-9A-Fa-f]{6}$/,patternDesc:"hex color (#RRGGBB)",default:"#00ff00",persist:!0,description:"Hex color for static selection mode"},{key:"selectionAnimationSpeed",type:"number",min:.1,max:10,default:2,persist:!0},{key:"selectionPlaneOpacity",type:"number",min:0,max:1,default:1,persist:!0},{key:"undistortionEnabled",type:"boolean",default:!1,persist:!0,description:"Apply lens undistortion to frustum images"},{key:"undistortionMode",type:"enum",enumValues:Qg,default:"fullFrame",persist:!0,description:"cropped | fullFrame"},{key:"autoFovEnabled",type:"boolean",default:!0,persist:!0,description:"Auto-adjust FOV when flying to cameras"},{key:"flyToImageId",type:"number",default:0,persist:!1,transient:!0},{key:"selectedImageId",type:"number",default:0,persist:!1,transient:!0}]},Ty={key:"ui",storeHook:"useUIStore",properties:[{key:"showPoints2D",type:"boolean",default:!1,persist:!0},{key:"showPoints3D",type:"boolean",default:!1,persist:!0},{key:"backgroundColor",type:"string",pattern:/^#[0-9A-Fa-f]{6}$/,patternDesc:"hex color (#RRGGBB)",default:"#ffffff",persist:!0},{key:"showMatches",type:"boolean",default:!1,persist:!0,description:"Show/hide match lines"},{key:"matchesDisplayMode",type:"enum",enumValues:Jg,default:"static",persist:!0,description:"static | blink"},{key:"matchesOpacity",type:"number",min:0,max:1,default:Wn.matchLines,persist:!0},{key:"matchesColor",type:"string",pattern:/^#[0-9A-Fa-f]{6}$/,patternDesc:"hex color (#RRGGBB)",default:st.match,persist:!0,description:"Hex color for matches visualization"},{key:"maskOverlay",storeKey:"showMaskOverlay",type:"boolean",default:!1,persist:!0},{key:"maskOpacity",type:"number",min:0,max:1,default:.7,persist:!0},{key:"showAxes",type:"boolean",default:!0,persist:!0,description:"Show origin axes"},{key:"showGrid",type:"boolean",default:!0,persist:!0,description:"Show grid plane"},{key:"axesCoordinateSystem",type:"enum",enumValues:ex,default:"colmap",persist:!0,description:"colmap | opencv | threejs | opengl | vulkan | blender | houdini | unity | unreal"},{key:"axesScale",type:"number",min:.1,max:100,default:1,persist:!0},{key:"gridScale",type:"number",min:.1,max:100,default:1,persist:!0,description:"Grid size multiplier (0.1 - 100)"},{key:"axisLabelMode",type:"enum",enumValues:tx,default:"extra",persist:!0,description:"off | xyz | extra"},{key:"showGizmo",type:"boolean",default:!1,persist:!0,description:"Show transform gizmo"},{key:"galleryCollapsed",type:"boolean",default:!1,persist:!0,description:"Start with gallery panel collapsed"},{key:"imageDetailId",type:"number",default:0,persist:!1,transient:!0},{key:"showMatchesInModal",type:"boolean",default:!1,persist:!1,transient:!0},{key:"matchedImageId",type:"number",default:0,persist:!1,transient:!0},{key:"viewResetTrigger",type:"number",default:0,persist:!1,transient:!0},{key:"viewDirection",type:"string",default:"",persist:!1,transient:!0},{key:"viewTrigger",type:"number",default:0,persist:!1,transient:!0}]},Ry=["text","binary","ply","zip"],Dy={key:"export",storeHook:"useExportStore",properties:[{key:"screenshotSize",type:"enum",enumValues:ox,default:"current",persist:!0,description:"current | 1920x1080 | 1280x720 | 3840x2160 | 1024x1024 | 512x512 | 2048x2048"},{key:"screenshotFormat",type:"enum",enumValues:sx,default:"jpeg",persist:!0,description:"jpeg | png | webp"},{key:"screenshotHideLogo",type:"boolean",default:!1,persist:!0},{key:"modelFormat",storeKey:"exportFormat",type:"enum",enumValues:Ry,default:"binary",persist:!0,description:"text | binary | ply | zip"},{key:"screenshotTrigger",type:"number",default:0,persist:!1,transient:!0},{key:"exportTrigger",type:"number",default:0,persist:!1,transient:!0}]},Fy={key:"rig",storeHook:"useRigStore",properties:[{key:"showRig",type:"boolean",default:!0,persist:!0,description:"Show rig connections"},{key:"rigDisplayMode",type:"enum",enumValues:nx,default:"static",persist:!0,description:"static | blink"},{key:"rigColorMode",type:"enum",enumValues:rx,default:"perFrame",persist:!0,description:"single | perFrame"},{key:"rigLineColor",type:"string",default:"#00ffff",persist:!0,description:"Rig line color (hex)"},{key:"rigLineOpacity",type:"number",min:0,max:1,default:.7,persist:!0,description:"Rig line opacity (0-1)"}]},gi=[Ly,_y,Ty,Dy,Fy];function xi(e){return e.properties.filter(t=>t.persist&&!t.transient)}function Zc(e){return e.storeKey??e.key}function zy(){const e={};for(const t of gi){const n=xi(t);n.length>0&&(e[t.key]=new Set(n.map(r=>Zc(r))))}return e}function Oy(e){const t={};for(const n of xi(e))t[n.key]=n.default;return t}function $y(){const e={version:Vc};for(const t of gi)e[t.key]=Oy(t);return e}function By(){return $y()}function te(e,t,n){function r(l,c){if(l._zod||Object.defineProperty(l,"_zod",{value:{def:c,constr:a,traits:new Set},enumerable:!1}),l._zod.traits.has(e))return;l._zod.traits.add(e),t(l,c);const d=a.prototype,h=Object.keys(d);for(let u=0;u<h.length;u++){const m=h[u];m in l||(l[m]=d[m].bind(l))}}const s=n?.Parent??Object;class i extends s{}Object.defineProperty(i,"name",{value:e});function a(l){var c;const d=n?.Parent?new i:this;r(d,l),(c=d._zod).deferred??(c.deferred=[]);for(const h of d._zod.deferred)h();return d}return Object.defineProperty(a,"init",{value:r}),Object.defineProperty(a,Symbol.hasInstance,{value:l=>n?.Parent&&l instanceof n.Parent?!0:l?._zod?.traits?.has(e)}),Object.defineProperty(a,"name",{value:e}),a}class as extends Error{constructor(){super("Encountered Promise during synchronous parse. Use .parseAsync() instead.")}}class Kh extends Error{constructor(t){super(`Encountered unidirectional transform during encode: ${t}`),this.name="ZodEncodeError"}}const Qh={};function Ro(e){return Qh}function Jh(e){const t=Object.values(e).filter(r=>typeof r=="number");return Object.entries(e).filter(([r,s])=>t.indexOf(+r)===-1).map(([r,s])=>s)}function nc(e,t){return typeof t=="bigint"?t.toString():t}function Yc(e){return{get value(){{const t=e();return Object.defineProperty(this,"value",{value:t}),t}}}}function Gc(e){return e==null}function qc(e){const t=e.startsWith("^")?1:0,n=e.endsWith("$")?e.length-1:e.length;return e.slice(t,n)}function Uy(e,t){const n=(e.toString().split(".")[1]||"").length,r=t.toString();let s=(r.split(".")[1]||"").length;if(s===0&&/\d?e-\d?/.test(r)){const c=r.match(/\d?e-(\d?)/);c?.[1]&&(s=Number.parseInt(c[1]))}const i=n>s?n:s,a=Number.parseInt(e.toFixed(i).replace(".","")),l=Number.parseInt(t.toFixed(i).replace(".",""));return a%l/10**i}const bd=Symbol("evaluating");function Mt(e,t,n){let r;Object.defineProperty(e,t,{get(){if(r!==bd)return r===void 0&&(r=bd,r=n()),r},set(s){Object.defineProperty(e,t,{value:s})},configurable:!0})}function zo(e,t,n){Object.defineProperty(e,t,{value:n,writable:!0,enumerable:!0,configurable:!0})}function uo(...e){const t={};for(const n of e){const r=Object.getOwnPropertyDescriptors(n);Object.assign(t,r)}return Object.defineProperties({},t)}function Cd(e){return JSON.stringify(e)}function Hy(e){return e.toLowerCase().trim().replace(/[^\w\s-]/g,"").replace(/[\s_-]+/g,"-").replace(/^-+|-+$/g,"")}const em="captureStackTrace"in Error?Error.captureStackTrace:(...e)=>{};function ba(e){return typeof e=="object"&&e!==null&&!Array.isArray(e)}const Wy=Yc(()=>{if(typeof navigator<"u"&&navigator?.userAgent?.includes("Cloudflare"))return!1;try{const e=Function;return new e(""),!0}catch{return!1}});function ei(e){if(ba(e)===!1)return!1;const t=e.constructor;if(t===void 0||typeof t!="function")return!0;const n=t.prototype;return!(ba(n)===!1||Object.prototype.hasOwnProperty.call(n,"isPrototypeOf")===!1)}function tm(e){return ei(e)?{...e}:Array.isArray(e)?[...e]:e}const Vy=new Set(["string","number","symbol"]);function Ua(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function fo(e,t,n){const r=new e._zod.constr(t??e._zod.def);return(!t||n?.parent)&&(r._zod.parent=e),r}function Ue(e){const t=e;if(!t)return{};if(typeof t=="string")return{error:()=>t};if(t?.message!==void 0){if(t?.error!==void 0)throw new Error("Cannot specify both `message` and `error` params");t.error=t.message}return delete t.message,typeof t.error=="string"?{...t,error:()=>t.error}:t}function Zy(e){return Object.keys(e).filter(t=>e[t]._zod.optin==="optional"&&e[t]._zod.optout==="optional")}const Yy={safeint:[Number.MIN_SAFE_INTEGER,Number.MAX_SAFE_INTEGER],int32:[-2147483648,2147483647],uint32:[0,4294967295],float32:[-34028234663852886e22,34028234663852886e22],float64:[-Number.MAX_VALUE,Number.MAX_VALUE]};function Gy(e,t){const n=e._zod.def,r=n.checks;if(r&&r.length>0)throw new Error(".pick() cannot be used on object schemas containing refinements");const i=uo(e._zod.def,{get shape(){const a={};for(const l in t){if(!(l in n.shape))throw new Error(`Unrecognized key: "${l}"`);t[l]&&(a[l]=n.shape[l])}return zo(this,"shape",a),a},checks:[]});return fo(e,i)}function qy(e,t){const n=e._zod.def,r=n.checks;if(r&&r.length>0)throw new Error(".omit() cannot be used on object schemas containing refinements");const i=uo(e._zod.def,{get shape(){const a={...e._zod.def.shape};for(const l in t){if(!(l in n.shape))throw new Error(`Unrecognized key: "${l}"`);t[l]&&delete a[l]}return zo(this,"shape",a),a},checks:[]});return fo(e,i)}function Xy(e,t){if(!ei(t))throw new Error("Invalid input to extend: expected a plain object");const n=e._zod.def.checks;if(n&&n.length>0){const i=e._zod.def.shape;for(const a in t)if(Object.getOwnPropertyDescriptor(i,a)!==void 0)throw new Error("Cannot overwrite keys on object schemas containing refinements. Use `.safeExtend()` instead.")}const s=uo(e._zod.def,{get shape(){const i={...e._zod.def.shape,...t};return zo(this,"shape",i),i}});return fo(e,s)}function Ky(e,t){if(!ei(t))throw new Error("Invalid input to safeExtend: expected a plain object");const n=uo(e._zod.def,{get shape(){const r={...e._zod.def.shape,...t};return zo(this,"shape",r),r}});return fo(e,n)}function Qy(e,t){const n=uo(e._zod.def,{get shape(){const r={...e._zod.def.shape,...t._zod.def.shape};return zo(this,"shape",r),r},get catchall(){return t._zod.def.catchall},checks:[]});return fo(e,n)}function Jy(e,t,n){const s=t._zod.def.checks;if(s&&s.length>0)throw new Error(".partial() cannot be used on object schemas containing refinements");const a=uo(t._zod.def,{get shape(){const l=t._zod.def.shape,c={...l};if(n)for(const d in n){if(!(d in l))throw new Error(`Unrecognized key: "${d}"`);n[d]&&(c[d]=e?new e({type:"optional",innerType:l[d]}):l[d])}else for(const d in l)c[d]=e?new e({type:"optional",innerType:l[d]}):l[d];return zo(this,"shape",c),c},checks:[]});return fo(t,a)}function ev(e,t,n){const r=uo(t._zod.def,{get shape(){const s=t._zod.def.shape,i={...s};if(n)for(const a in n){if(!(a in i))throw new Error(`Unrecognized key: "${a}"`);n[a]&&(i[a]=new e({type:"nonoptional",innerType:s[a]}))}else for(const a in s)i[a]=new e({type:"nonoptional",innerType:s[a]});return zo(this,"shape",i),i}});return fo(t,r)}function Ko(e,t=0){if(e.aborted===!0)return!0;for(let n=t;n<e.issues.length;n++)if(e.issues[n]?.continue!==!0)return!0;return!1}function nm(e,t){return t.map(n=>{var r;return(r=n).path??(r.path=[]),n.path.unshift(e),n})}function Li(e){return typeof e=="string"?e:e?.message}function Do(e,t,n){const r={...e,path:e.path??[]};if(!e.message){const s=Li(e.inst?._zod.def?.error?.(e))??Li(t?.error?.(e))??Li(n.customError?.(e))??Li(n.localeError?.(e))??"Invalid input";r.message=s}return delete r.inst,delete r.continue,t?.reportInput||delete r.input,r}function Xc(e){return Array.isArray(e)?"array":typeof e=="string"?"string":"unknown"}function ti(...e){const[t,n,r]=e;return typeof t=="string"?{message:t,code:"custom",input:n,inst:r}:{...t}}const rm=(e,t)=>{e.name="$ZodError",Object.defineProperty(e,"_zod",{value:e._zod,enumerable:!1}),Object.defineProperty(e,"issues",{value:t,enumerable:!1}),e.message=JSON.stringify(t,nc,2),Object.defineProperty(e,"toString",{value:()=>e.message,enumerable:!1})},om=te("$ZodError",rm),sm=te("$ZodError",rm,{Parent:Error});function tv(e,t=n=>n.message){const n={},r=[];for(const s of e.issues)s.path.length>0?(n[s.path[0]]=n[s.path[0]]||[],n[s.path[0]].push(t(s))):r.push(t(s));return{formErrors:r,fieldErrors:n}}function nv(e,t=n=>n.message){const n={_errors:[]},r=s=>{for(const i of s.issues)if(i.code==="invalid_union"&&i.errors.length)i.errors.map(a=>r({issues:a}));else if(i.code==="invalid_key")r({issues:i.issues});else if(i.code==="invalid_element")r({issues:i.issues});else if(i.path.length===0)n._errors.push(t(i));else{let a=n,l=0;for(;l<i.path.length;){const c=i.path[l];l===i.path.length-1?(a[c]=a[c]||{_errors:[]},a[c]._errors.push(t(i))):a[c]=a[c]||{_errors:[]},a=a[c],l++}}};return r(e),n}const Kc=e=>(t,n,r,s)=>{const i=r?Object.assign(r,{async:!1}):{async:!1},a=t._zod.run({value:n,issues:[]},i);if(a instanceof Promise)throw new as;if(a.issues.length){const l=new(s?.Err??e)(a.issues.map(c=>Do(c,i,Ro())));throw em(l,s?.callee),l}return a.value},Qc=e=>async(t,n,r,s)=>{const i=r?Object.assign(r,{async:!0}):{async:!0};let a=t._zod.run({value:n,issues:[]},i);if(a instanceof Promise&&(a=await a),a.issues.length){const l=new(s?.Err??e)(a.issues.map(c=>Do(c,i,Ro())));throw em(l,s?.callee),l}return a.value},Ha=e=>(t,n,r)=>{const s=r?{...r,async:!1}:{async:!1},i=t._zod.run({value:n,issues:[]},s);if(i instanceof Promise)throw new as;return i.issues.length?{success:!1,error:new(e??om)(i.issues.map(a=>Do(a,s,Ro())))}:{success:!0,data:i.value}},rv=Ha(sm),Wa=e=>async(t,n,r)=>{const s=r?Object.assign(r,{async:!0}):{async:!0};let i=t._zod.run({value:n,issues:[]},s);return i instanceof Promise&&(i=await i),i.issues.length?{success:!1,error:new e(i.issues.map(a=>Do(a,s,Ro())))}:{success:!0,data:i.value}},ov=Wa(sm),sv=e=>(t,n,r)=>{const s=r?Object.assign(r,{direction:"backward"}):{direction:"backward"};return Kc(e)(t,n,s)},iv=e=>(t,n,r)=>Kc(e)(t,n,r),av=e=>async(t,n,r)=>{const s=r?Object.assign(r,{direction:"backward"}):{direction:"backward"};return Qc(e)(t,n,s)},lv=e=>async(t,n,r)=>Qc(e)(t,n,r),cv=e=>(t,n,r)=>{const s=r?Object.assign(r,{direction:"backward"}):{direction:"backward"};return Ha(e)(t,n,s)},uv=e=>(t,n,r)=>Ha(e)(t,n,r),dv=e=>async(t,n,r)=>{const s=r?Object.assign(r,{direction:"backward"}):{direction:"backward"};return Wa(e)(t,n,s)},fv=e=>async(t,n,r)=>Wa(e)(t,n,r),hv=/^[cC][^\s-]{8,}$/,mv=/^[0-9a-z]+$/,pv=/^[0-9A-HJKMNP-TV-Za-hjkmnp-tv-z]{26}$/,gv=/^[0-9a-vA-V]{20}$/,xv=/^[A-Za-z0-9]{27}$/,yv=/^[a-zA-Z0-9_-]{21}$/,vv=/^P(?:(\d+W)|(?!.*W)(?=\d|T\d)(\d+Y)?(\d+M)?(\d+D)?(T(?=\d)(\d+H)?(\d+M)?(\d+([.,]\d+)?S)?)?)$/,wv=/^([0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12})$/,Sd=e=>e?new RegExp(`^([0-9a-fA-F]{8}-[0-9a-fA-F]{4}-${e}[0-9a-fA-F]{3}-[89abAB][0-9a-fA-F]{3}-[0-9a-fA-F]{12})$`):/^([0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[1-8][0-9a-fA-F]{3}-[89abAB][0-9a-fA-F]{3}-[0-9a-fA-F]{12}|00000000-0000-0000-0000-000000000000|ffffffff-ffff-ffff-ffff-ffffffffffff)$/,bv=/^(?!\.)(?!.*\.\.)([A-Za-z0-9_'+\-\.]*)[A-Za-z0-9_+-]@([A-Za-z0-9][A-Za-z0-9\-]*\.)+[A-Za-z]{2,}$/,Cv="^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$";function Sv(){return new RegExp(Cv,"u")}const kv=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,Iv=/^(([0-9a-fA-F]{1,4}:){7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:))$/,Mv=/^((25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/([0-9]|[1-2][0-9]|3[0-2])$/,jv=/^(([0-9a-fA-F]{1,4}:){7}[0-9a-fA-F]{1,4}|::|([0-9a-fA-F]{1,4})?::([0-9a-fA-F]{1,4}:?){0,6})\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,Ev=/^$|^(?:[0-9a-zA-Z+/]{4})*(?:(?:[0-9a-zA-Z+/]{2}==)|(?:[0-9a-zA-Z+/]{3}=))?$/,im=/^[A-Za-z0-9_-]*$/,Pv=/^\+[1-9]\d{6,14}$/,am="(?:(?:\\d\\d[2468][048]|\\d\\d[13579][26]|\\d\\d0[48]|[02468][048]00|[13579][26]00)-02-29|\\d{4}-(?:(?:0[13578]|1[02])-(?:0[1-9]|[12]\\d|3[01])|(?:0[469]|11)-(?:0[1-9]|[12]\\d|30)|(?:02)-(?:0[1-9]|1\\d|2[0-8])))",Nv=new RegExp(`^${am}$`);function lm(e){const t="(?:[01]\\d|2[0-3]):[0-5]\\d";return typeof e.precision=="number"?e.precision===-1?`${t}`:e.precision===0?`${t}:[0-5]\\d`:`${t}:[0-5]\\d\\.\\d{${e.precision}}`:`${t}(?::[0-5]\\d(?:\\.\\d+)?)?`}function Av(e){return new RegExp(`^${lm(e)}$`)}function Lv(e){const t=lm({precision:e.precision}),n=["Z"];e.local&&n.push(""),e.offset&&n.push("([+-](?:[01]\\d|2[0-3]):[0-5]\\d)");const r=`${t}(?:${n.join("|")})`;return new RegExp(`^${am}T(?:${r})$`)}const _v=e=>{const t=e?`[\\s\\S]{${e?.minimum??0},${e?.maximum??""}}`:"[\\s\\S]*";return new RegExp(`^${t}$`)},Tv=/^-?\d+$/,Rv=/^-?\d+(?:\.\d+)?$/,Dv=/^(?:true|false)$/i,Fv=/^[^A-Z]*$/,zv=/^[^a-z]*$/,Gn=te("$ZodCheck",(e,t)=>{var n;e._zod??(e._zod={}),e._zod.def=t,(n=e._zod).onattach??(n.onattach=[])}),cm={number:"number",bigint:"bigint",object:"date"},um=te("$ZodCheckLessThan",(e,t)=>{Gn.init(e,t);const n=cm[typeof t.value];e._zod.onattach.push(r=>{const s=r._zod.bag,i=(t.inclusive?s.maximum:s.exclusiveMaximum)??Number.POSITIVE_INFINITY;t.value<i&&(t.inclusive?s.maximum=t.value:s.exclusiveMaximum=t.value)}),e._zod.check=r=>{(t.inclusive?r.value<=t.value:r.value<t.value)||r.issues.push({origin:n,code:"too_big",maximum:typeof t.value=="object"?t.value.getTime():t.value,input:r.value,inclusive:t.inclusive,inst:e,continue:!t.abort})}}),dm=te("$ZodCheckGreaterThan",(e,t)=>{Gn.init(e,t);const n=cm[typeof t.value];e._zod.onattach.push(r=>{const s=r._zod.bag,i=(t.inclusive?s.minimum:s.exclusiveMinimum)??Number.NEGATIVE_INFINITY;t.value>i&&(t.inclusive?s.minimum=t.value:s.exclusiveMinimum=t.value)}),e._zod.check=r=>{(t.inclusive?r.value>=t.value:r.value>t.value)||r.issues.push({origin:n,code:"too_small",minimum:typeof t.value=="object"?t.value.getTime():t.value,input:r.value,inclusive:t.inclusive,inst:e,continue:!t.abort})}}),Ov=te("$ZodCheckMultipleOf",(e,t)=>{Gn.init(e,t),e._zod.onattach.push(n=>{var r;(r=n._zod.bag).multipleOf??(r.multipleOf=t.value)}),e._zod.check=n=>{if(typeof n.value!=typeof t.value)throw new Error("Cannot mix number and bigint in multiple_of check.");(typeof n.value=="bigint"?n.value%t.value===BigInt(0):Uy(n.value,t.value)===0)||n.issues.push({origin:typeof n.value,code:"not_multiple_of",divisor:t.value,input:n.value,inst:e,continue:!t.abort})}}),$v=te("$ZodCheckNumberFormat",(e,t)=>{Gn.init(e,t),t.format=t.format||"float64";const n=t.format?.includes("int"),r=n?"int":"number",[s,i]=Yy[t.format];e._zod.onattach.push(a=>{const l=a._zod.bag;l.format=t.format,l.minimum=s,l.maximum=i,n&&(l.pattern=Tv)}),e._zod.check=a=>{const l=a.value;if(n){if(!Number.isInteger(l)){a.issues.push({expected:r,format:t.format,code:"invalid_type",continue:!1,input:l,inst:e});return}if(!Number.isSafeInteger(l)){l>0?a.issues.push({input:l,code:"too_big",maximum:Number.MAX_SAFE_INTEGER,note:"Integers must be within the safe integer range.",inst:e,origin:r,inclusive:!0,continue:!t.abort}):a.issues.push({input:l,code:"too_small",minimum:Number.MIN_SAFE_INTEGER,note:"Integers must be within the safe integer range.",inst:e,origin:r,inclusive:!0,continue:!t.abort});return}}l<s&&a.issues.push({origin:"number",input:l,code:"too_small",minimum:s,inclusive:!0,inst:e,continue:!t.abort}),l>i&&a.issues.push({origin:"number",input:l,code:"too_big",maximum:i,inclusive:!0,inst:e,continue:!t.abort})}}),Bv=te("$ZodCheckMaxLength",(e,t)=>{var n;Gn.init(e,t),(n=e._zod.def).when??(n.when=r=>{const s=r.value;return!Gc(s)&&s.length!==void 0}),e._zod.onattach.push(r=>{const s=r._zod.bag.maximum??Number.POSITIVE_INFINITY;t.maximum<s&&(r._zod.bag.maximum=t.maximum)}),e._zod.check=r=>{const s=r.value;if(s.length<=t.maximum)return;const a=Xc(s);r.issues.push({origin:a,code:"too_big",maximum:t.maximum,inclusive:!0,input:s,inst:e,continue:!t.abort})}}),Uv=te("$ZodCheckMinLength",(e,t)=>{var n;Gn.init(e,t),(n=e._zod.def).when??(n.when=r=>{const s=r.value;return!Gc(s)&&s.length!==void 0}),e._zod.onattach.push(r=>{const s=r._zod.bag.minimum??Number.NEGATIVE_INFINITY;t.minimum>s&&(r._zod.bag.minimum=t.minimum)}),e._zod.check=r=>{const s=r.value;if(s.length>=t.minimum)return;const a=Xc(s);r.issues.push({origin:a,code:"too_small",minimum:t.minimum,inclusive:!0,input:s,inst:e,continue:!t.abort})}}),Hv=te("$ZodCheckLengthEquals",(e,t)=>{var n;Gn.init(e,t),(n=e._zod.def).when??(n.when=r=>{const s=r.value;return!Gc(s)&&s.length!==void 0}),e._zod.onattach.push(r=>{const s=r._zod.bag;s.minimum=t.length,s.maximum=t.length,s.length=t.length}),e._zod.check=r=>{const s=r.value,i=s.length;if(i===t.length)return;const a=Xc(s),l=i>t.length;r.issues.push({origin:a,...l?{code:"too_big",maximum:t.length}:{code:"too_small",minimum:t.length},inclusive:!0,exact:!0,input:r.value,inst:e,continue:!t.abort})}}),Va=te("$ZodCheckStringFormat",(e,t)=>{var n,r;Gn.init(e,t),e._zod.onattach.push(s=>{const i=s._zod.bag;i.format=t.format,t.pattern&&(i.patterns??(i.patterns=new Set),i.patterns.add(t.pattern))}),t.pattern?(n=e._zod).check??(n.check=s=>{t.pattern.lastIndex=0,!t.pattern.test(s.value)&&s.issues.push({origin:"string",code:"invalid_format",format:t.format,input:s.value,...t.pattern?{pattern:t.pattern.toString()}:{},inst:e,continue:!t.abort})}):(r=e._zod).check??(r.check=()=>{})}),Wv=te("$ZodCheckRegex",(e,t)=>{Va.init(e,t),e._zod.check=n=>{t.pattern.lastIndex=0,!t.pattern.test(n.value)&&n.issues.push({origin:"string",code:"invalid_format",format:"regex",input:n.value,pattern:t.pattern.toString(),inst:e,continue:!t.abort})}}),Vv=te("$ZodCheckLowerCase",(e,t)=>{t.pattern??(t.pattern=Fv),Va.init(e,t)}),Zv=te("$ZodCheckUpperCase",(e,t)=>{t.pattern??(t.pattern=zv),Va.init(e,t)}),Yv=te("$ZodCheckIncludes",(e,t)=>{Gn.init(e,t);const n=Ua(t.includes),r=new RegExp(typeof t.position=="number"?`^.{${t.position}}${n}`:n);t.pattern=r,e._zod.onattach.push(s=>{const i=s._zod.bag;i.patterns??(i.patterns=new Set),i.patterns.add(r)}),e._zod.check=s=>{s.value.includes(t.includes,t.position)||s.issues.push({origin:"string",code:"invalid_format",format:"includes",includes:t.includes,input:s.value,inst:e,continue:!t.abort})}}),Gv=te("$ZodCheckStartsWith",(e,t)=>{Gn.init(e,t);const n=new RegExp(`^${Ua(t.prefix)}.*`);t.pattern??(t.pattern=n),e._zod.onattach.push(r=>{const s=r._zod.bag;s.patterns??(s.patterns=new Set),s.patterns.add(n)}),e._zod.check=r=>{r.value.startsWith(t.prefix)||r.issues.push({origin:"string",code:"invalid_format",format:"starts_with",prefix:t.prefix,input:r.value,inst:e,continue:!t.abort})}}),qv=te("$ZodCheckEndsWith",(e,t)=>{Gn.init(e,t);const n=new RegExp(`.*${Ua(t.suffix)}$`);t.pattern??(t.pattern=n),e._zod.onattach.push(r=>{const s=r._zod.bag;s.patterns??(s.patterns=new Set),s.patterns.add(n)}),e._zod.check=r=>{r.value.endsWith(t.suffix)||r.issues.push({origin:"string",code:"invalid_format",format:"ends_with",suffix:t.suffix,input:r.value,inst:e,continue:!t.abort})}}),Xv=te("$ZodCheckOverwrite",(e,t)=>{Gn.init(e,t),e._zod.check=n=>{n.value=t.tx(n.value)}});class Kv{constructor(t=[]){this.content=[],this.indent=0,this&&(this.args=t)}indented(t){this.indent+=1,t(this),this.indent-=1}write(t){if(typeof t=="function"){t(this,{execution:"sync"}),t(this,{execution:"async"});return}const r=t.split(`
`).filter(a=>a),s=Math.min(...r.map(a=>a.length-a.trimStart().length)),i=r.map(a=>a.slice(s)).map(a=>" ".repeat(this.indent*2)+a);for(const a of i)this.content.push(a)}compile(){const t=Function,n=this?.args,s=[...(this?.content??[""]).map(i=>`  ${i}`)];return new t(...n,s.join(`
`))}}const Qv={major:4,minor:3,patch:5},Qt=te("$ZodType",(e,t)=>{var n;e??(e={}),e._zod.def=t,e._zod.bag=e._zod.bag||{},e._zod.version=Qv;const r=[...e._zod.def.checks??[]];e._zod.traits.has("$ZodCheck")&&r.unshift(e);for(const s of r)for(const i of s._zod.onattach)i(e);if(r.length===0)(n=e._zod).deferred??(n.deferred=[]),e._zod.deferred?.push(()=>{e._zod.run=e._zod.parse});else{const s=(a,l,c)=>{let d=Ko(a),h;for(const u of l){if(u._zod.def.when){if(!u._zod.def.when(a))continue}else if(d)continue;const m=a.issues.length,g=u._zod.check(a);if(g instanceof Promise&&c?.async===!1)throw new as;if(h||g instanceof Promise)h=(h??Promise.resolve()).then(async()=>{await g,a.issues.length!==m&&(d||(d=Ko(a,m)))});else{if(a.issues.length===m)continue;d||(d=Ko(a,m))}}return h?h.then(()=>a):a},i=(a,l,c)=>{if(Ko(a))return a.aborted=!0,a;const d=s(l,r,c);if(d instanceof Promise){if(c.async===!1)throw new as;return d.then(h=>e._zod.parse(h,c))}return e._zod.parse(d,c)};e._zod.run=(a,l)=>{if(l.skipChecks)return e._zod.parse(a,l);if(l.direction==="backward"){const d=e._zod.parse({value:a.value,issues:[]},{...l,skipChecks:!0});return d instanceof Promise?d.then(h=>i(h,a,l)):i(d,a,l)}const c=e._zod.parse(a,l);if(c instanceof Promise){if(l.async===!1)throw new as;return c.then(d=>s(d,r,l))}return s(c,r,l)}}Mt(e,"~standard",()=>({validate:s=>{try{const i=rv(e,s);return i.success?{value:i.data}:{issues:i.error?.issues}}catch{return ov(e,s).then(a=>a.success?{value:a.data}:{issues:a.error?.issues})}},vendor:"zod",version:1}))}),Jc=te("$ZodString",(e,t)=>{Qt.init(e,t),e._zod.pattern=[...e?._zod.bag?.patterns??[]].pop()??_v(e._zod.bag),e._zod.parse=(n,r)=>{if(t.coerce)try{n.value=String(n.value)}catch{}return typeof n.value=="string"||n.issues.push({expected:"string",code:"invalid_type",input:n.value,inst:e}),n}}),Ut=te("$ZodStringFormat",(e,t)=>{Va.init(e,t),Jc.init(e,t)}),Jv=te("$ZodGUID",(e,t)=>{t.pattern??(t.pattern=wv),Ut.init(e,t)}),ew=te("$ZodUUID",(e,t)=>{if(t.version){const r={v1:1,v2:2,v3:3,v4:4,v5:5,v6:6,v7:7,v8:8}[t.version];if(r===void 0)throw new Error(`Invalid UUID version: "${t.version}"`);t.pattern??(t.pattern=Sd(r))}else t.pattern??(t.pattern=Sd());Ut.init(e,t)}),tw=te("$ZodEmail",(e,t)=>{t.pattern??(t.pattern=bv),Ut.init(e,t)}),nw=te("$ZodURL",(e,t)=>{Ut.init(e,t),e._zod.check=n=>{try{const r=n.value.trim(),s=new URL(r);t.hostname&&(t.hostname.lastIndex=0,t.hostname.test(s.hostname)||n.issues.push({code:"invalid_format",format:"url",note:"Invalid hostname",pattern:t.hostname.source,input:n.value,inst:e,continue:!t.abort})),t.protocol&&(t.protocol.lastIndex=0,t.protocol.test(s.protocol.endsWith(":")?s.protocol.slice(0,-1):s.protocol)||n.issues.push({code:"invalid_format",format:"url",note:"Invalid protocol",pattern:t.protocol.source,input:n.value,inst:e,continue:!t.abort})),t.normalize?n.value=s.href:n.value=r;return}catch{n.issues.push({code:"invalid_format",format:"url",input:n.value,inst:e,continue:!t.abort})}}}),rw=te("$ZodEmoji",(e,t)=>{t.pattern??(t.pattern=Sv()),Ut.init(e,t)}),ow=te("$ZodNanoID",(e,t)=>{t.pattern??(t.pattern=yv),Ut.init(e,t)}),sw=te("$ZodCUID",(e,t)=>{t.pattern??(t.pattern=hv),Ut.init(e,t)}),iw=te("$ZodCUID2",(e,t)=>{t.pattern??(t.pattern=mv),Ut.init(e,t)}),aw=te("$ZodULID",(e,t)=>{t.pattern??(t.pattern=pv),Ut.init(e,t)}),lw=te("$ZodXID",(e,t)=>{t.pattern??(t.pattern=gv),Ut.init(e,t)}),cw=te("$ZodKSUID",(e,t)=>{t.pattern??(t.pattern=xv),Ut.init(e,t)}),uw=te("$ZodISODateTime",(e,t)=>{t.pattern??(t.pattern=Lv(t)),Ut.init(e,t)}),dw=te("$ZodISODate",(e,t)=>{t.pattern??(t.pattern=Nv),Ut.init(e,t)}),fw=te("$ZodISOTime",(e,t)=>{t.pattern??(t.pattern=Av(t)),Ut.init(e,t)}),hw=te("$ZodISODuration",(e,t)=>{t.pattern??(t.pattern=vv),Ut.init(e,t)}),mw=te("$ZodIPv4",(e,t)=>{t.pattern??(t.pattern=kv),Ut.init(e,t),e._zod.bag.format="ipv4"}),pw=te("$ZodIPv6",(e,t)=>{t.pattern??(t.pattern=Iv),Ut.init(e,t),e._zod.bag.format="ipv6",e._zod.check=n=>{try{new URL(`http://[${n.value}]`)}catch{n.issues.push({code:"invalid_format",format:"ipv6",input:n.value,inst:e,continue:!t.abort})}}}),gw=te("$ZodCIDRv4",(e,t)=>{t.pattern??(t.pattern=Mv),Ut.init(e,t)}),xw=te("$ZodCIDRv6",(e,t)=>{t.pattern??(t.pattern=jv),Ut.init(e,t),e._zod.check=n=>{const r=n.value.split("/");try{if(r.length!==2)throw new Error;const[s,i]=r;if(!i)throw new Error;const a=Number(i);if(`${a}`!==i)throw new Error;if(a<0||a>128)throw new Error;new URL(`http://[${s}]`)}catch{n.issues.push({code:"invalid_format",format:"cidrv6",input:n.value,inst:e,continue:!t.abort})}}});function fm(e){if(e==="")return!0;if(e.length%4!==0)return!1;try{return atob(e),!0}catch{return!1}}const yw=te("$ZodBase64",(e,t)=>{t.pattern??(t.pattern=Ev),Ut.init(e,t),e._zod.bag.contentEncoding="base64",e._zod.check=n=>{fm(n.value)||n.issues.push({code:"invalid_format",format:"base64",input:n.value,inst:e,continue:!t.abort})}});function vw(e){if(!im.test(e))return!1;const t=e.replace(/[-_]/g,r=>r==="-"?"+":"/"),n=t.padEnd(Math.ceil(t.length/4)*4,"=");return fm(n)}const ww=te("$ZodBase64URL",(e,t)=>{t.pattern??(t.pattern=im),Ut.init(e,t),e._zod.bag.contentEncoding="base64url",e._zod.check=n=>{vw(n.value)||n.issues.push({code:"invalid_format",format:"base64url",input:n.value,inst:e,continue:!t.abort})}}),bw=te("$ZodE164",(e,t)=>{t.pattern??(t.pattern=Pv),Ut.init(e,t)});function Cw(e,t=null){try{const n=e.split(".");if(n.length!==3)return!1;const[r]=n;if(!r)return!1;const s=JSON.parse(atob(r));return!("typ"in s&&s?.typ!=="JWT"||!s.alg||t&&(!("alg"in s)||s.alg!==t))}catch{return!1}}const Sw=te("$ZodJWT",(e,t)=>{Ut.init(e,t),e._zod.check=n=>{Cw(n.value,t.alg)||n.issues.push({code:"invalid_format",format:"jwt",input:n.value,inst:e,continue:!t.abort})}}),hm=te("$ZodNumber",(e,t)=>{Qt.init(e,t),e._zod.pattern=e._zod.bag.pattern??Rv,e._zod.parse=(n,r)=>{if(t.coerce)try{n.value=Number(n.value)}catch{}const s=n.value;if(typeof s=="number"&&!Number.isNaN(s)&&Number.isFinite(s))return n;const i=typeof s=="number"?Number.isNaN(s)?"NaN":Number.isFinite(s)?void 0:"Infinity":void 0;return n.issues.push({expected:"number",code:"invalid_type",input:s,inst:e,...i?{received:i}:{}}),n}}),kw=te("$ZodNumberFormat",(e,t)=>{$v.init(e,t),hm.init(e,t)}),Iw=te("$ZodBoolean",(e,t)=>{Qt.init(e,t),e._zod.pattern=Dv,e._zod.parse=(n,r)=>{if(t.coerce)try{n.value=!!n.value}catch{}const s=n.value;return typeof s=="boolean"||n.issues.push({expected:"boolean",code:"invalid_type",input:s,inst:e}),n}}),Mw=te("$ZodUnknown",(e,t)=>{Qt.init(e,t),e._zod.parse=n=>n}),jw=te("$ZodNever",(e,t)=>{Qt.init(e,t),e._zod.parse=(n,r)=>(n.issues.push({expected:"never",code:"invalid_type",input:n.value,inst:e}),n)});function kd(e,t,n){e.issues.length&&t.issues.push(...nm(n,e.issues)),t.value[n]=e.value}const Ew=te("$ZodArray",(e,t)=>{Qt.init(e,t),e._zod.parse=(n,r)=>{const s=n.value;if(!Array.isArray(s))return n.issues.push({expected:"array",code:"invalid_type",input:s,inst:e}),n;n.value=Array(s.length);const i=[];for(let a=0;a<s.length;a++){const l=s[a],c=t.element._zod.run({value:l,issues:[]},r);c instanceof Promise?i.push(c.then(d=>kd(d,n,a))):kd(c,n,a)}return i.length?Promise.all(i).then(()=>n):n}});function Ca(e,t,n,r,s){if(e.issues.length){if(s&&!(n in r))return;t.issues.push(...nm(n,e.issues))}e.value===void 0?n in r&&(t.value[n]=void 0):t.value[n]=e.value}function mm(e){const t=Object.keys(e.shape);for(const r of t)if(!e.shape?.[r]?._zod?.traits?.has("$ZodType"))throw new Error(`Invalid element at key "${r}": expected a Zod schema`);const n=Zy(e.shape);return{...e,keys:t,keySet:new Set(t),numKeys:t.length,optionalKeys:new Set(n)}}function pm(e,t,n,r,s,i){const a=[],l=s.keySet,c=s.catchall._zod,d=c.def.type,h=c.optout==="optional";for(const u in t){if(l.has(u))continue;if(d==="never"){a.push(u);continue}const m=c.run({value:t[u],issues:[]},r);m instanceof Promise?e.push(m.then(g=>Ca(g,n,u,t,h))):Ca(m,n,u,t,h)}return a.length&&n.issues.push({code:"unrecognized_keys",keys:a,input:t,inst:i}),e.length?Promise.all(e).then(()=>n):n}const Pw=te("$ZodObject",(e,t)=>{if(Qt.init(e,t),!Object.getOwnPropertyDescriptor(t,"shape")?.get){const l=t.shape;Object.defineProperty(t,"shape",{get:()=>{const c={...l};return Object.defineProperty(t,"shape",{value:c}),c}})}const r=Yc(()=>mm(t));Mt(e._zod,"propValues",()=>{const l=t.shape,c={};for(const d in l){const h=l[d]._zod;if(h.values){c[d]??(c[d]=new Set);for(const u of h.values)c[d].add(u)}}return c});const s=ba,i=t.catchall;let a;e._zod.parse=(l,c)=>{a??(a=r.value);const d=l.value;if(!s(d))return l.issues.push({expected:"object",code:"invalid_type",input:d,inst:e}),l;l.value={};const h=[],u=a.shape;for(const m of a.keys){const g=u[m],p=g._zod.optout==="optional",y=g._zod.run({value:d[m],issues:[]},c);y instanceof Promise?h.push(y.then(w=>Ca(w,l,m,d,p))):Ca(y,l,m,d,p)}return i?pm(h,d,l,c,r.value,e):h.length?Promise.all(h).then(()=>l):l}}),Nw=te("$ZodObjectJIT",(e,t)=>{Pw.init(e,t);const n=e._zod.parse,r=Yc(()=>mm(t)),s=m=>{const g=new Kv(["shape","payload","ctx"]),p=r.value,y=k=>{const b=Cd(k);return`shape[${b}]._zod.run({ value: input[${b}], issues: [] }, ctx)`};g.write("const input = payload.value;");const w=Object.create(null);let x=0;for(const k of p.keys)w[k]=`key_${x++}`;g.write("const newResult = {};");for(const k of p.keys){const b=w[k],S=Cd(k),M=m[k]?._zod?.optout==="optional";g.write(`const ${b} = ${y(k)};`),M?g.write(`
        if (${b}.issues.length) {
          if (${S} in input) {
            payload.issues = payload.issues.concat(${b}.issues.map(iss => ({
              ...iss,
              path: iss.path ? [${S}, ...iss.path] : [${S}]
            })));
          }
        }
        
        if (${b}.value === undefined) {
          if (${S} in input) {
            newResult[${S}] = undefined;
          }
        } else {
          newResult[${S}] = ${b}.value;
        }
        
      `):g.write(`
        if (${b}.issues.length) {
          payload.issues = payload.issues.concat(${b}.issues.map(iss => ({
            ...iss,
            path: iss.path ? [${S}, ...iss.path] : [${S}]
          })));
        }
        
        if (${b}.value === undefined) {
          if (${S} in input) {
            newResult[${S}] = undefined;
          }
        } else {
          newResult[${S}] = ${b}.value;
        }
        
      `)}g.write("payload.value = newResult;"),g.write("return payload;");const v=g.compile();return(k,b)=>v(m,k,b)};let i;const a=ba,l=!Qh.jitless,d=l&&Wy.value,h=t.catchall;let u;e._zod.parse=(m,g)=>{u??(u=r.value);const p=m.value;return a(p)?l&&d&&g?.async===!1&&g.jitless!==!0?(i||(i=s(t.shape)),m=i(m,g),h?pm([],p,m,g,u,e):m):n(m,g):(m.issues.push({expected:"object",code:"invalid_type",input:p,inst:e}),m)}});function Id(e,t,n,r){for(const i of e)if(i.issues.length===0)return t.value=i.value,t;const s=e.filter(i=>!Ko(i));return s.length===1?(t.value=s[0].value,s[0]):(t.issues.push({code:"invalid_union",input:t.value,inst:n,errors:e.map(i=>i.issues.map(a=>Do(a,r,Ro())))}),t)}const Aw=te("$ZodUnion",(e,t)=>{Qt.init(e,t),Mt(e._zod,"optin",()=>t.options.some(s=>s._zod.optin==="optional")?"optional":void 0),Mt(e._zod,"optout",()=>t.options.some(s=>s._zod.optout==="optional")?"optional":void 0),Mt(e._zod,"values",()=>{if(t.options.every(s=>s._zod.values))return new Set(t.options.flatMap(s=>Array.from(s._zod.values)))}),Mt(e._zod,"pattern",()=>{if(t.options.every(s=>s._zod.pattern)){const s=t.options.map(i=>i._zod.pattern);return new RegExp(`^(${s.map(i=>qc(i.source)).join("|")})$`)}});const n=t.options.length===1,r=t.options[0]._zod.run;e._zod.parse=(s,i)=>{if(n)return r(s,i);let a=!1;const l=[];for(const c of t.options){const d=c._zod.run({value:s.value,issues:[]},i);if(d instanceof Promise)l.push(d),a=!0;else{if(d.issues.length===0)return d;l.push(d)}}return a?Promise.all(l).then(c=>Id(c,s,e,i)):Id(l,s,e,i)}}),Lw=te("$ZodIntersection",(e,t)=>{Qt.init(e,t),e._zod.parse=(n,r)=>{const s=n.value,i=t.left._zod.run({value:s,issues:[]},r),a=t.right._zod.run({value:s,issues:[]},r);return i instanceof Promise||a instanceof Promise?Promise.all([i,a]).then(([c,d])=>Md(n,c,d)):Md(n,i,a)}});function rc(e,t){if(e===t)return{valid:!0,data:e};if(e instanceof Date&&t instanceof Date&&+e==+t)return{valid:!0,data:e};if(ei(e)&&ei(t)){const n=Object.keys(t),r=Object.keys(e).filter(i=>n.indexOf(i)!==-1),s={...e,...t};for(const i of r){const a=rc(e[i],t[i]);if(!a.valid)return{valid:!1,mergeErrorPath:[i,...a.mergeErrorPath]};s[i]=a.data}return{valid:!0,data:s}}if(Array.isArray(e)&&Array.isArray(t)){if(e.length!==t.length)return{valid:!1,mergeErrorPath:[]};const n=[];for(let r=0;r<e.length;r++){const s=e[r],i=t[r],a=rc(s,i);if(!a.valid)return{valid:!1,mergeErrorPath:[r,...a.mergeErrorPath]};n.push(a.data)}return{valid:!0,data:n}}return{valid:!1,mergeErrorPath:[]}}function Md(e,t,n){const r=new Map;let s;for(const l of t.issues)if(l.code==="unrecognized_keys"){s??(s=l);for(const c of l.keys)r.has(c)||r.set(c,{}),r.get(c).l=!0}else e.issues.push(l);for(const l of n.issues)if(l.code==="unrecognized_keys")for(const c of l.keys)r.has(c)||r.set(c,{}),r.get(c).r=!0;else e.issues.push(l);const i=[...r].filter(([,l])=>l.l&&l.r).map(([l])=>l);if(i.length&&s&&e.issues.push({...s,keys:i}),Ko(e))return e;const a=rc(t.value,n.value);if(!a.valid)throw new Error(`Unmergable intersection. Error path: ${JSON.stringify(a.mergeErrorPath)}`);return e.value=a.data,e}const _w=te("$ZodEnum",(e,t)=>{Qt.init(e,t);const n=Jh(t.entries),r=new Set(n);e._zod.values=r,e._zod.pattern=new RegExp(`^(${n.filter(s=>Vy.has(typeof s)).map(s=>typeof s=="string"?Ua(s):s.toString()).join("|")})$`),e._zod.parse=(s,i)=>{const a=s.value;return r.has(a)||s.issues.push({code:"invalid_value",values:n,input:a,inst:e}),s}}),Tw=te("$ZodTransform",(e,t)=>{Qt.init(e,t),e._zod.parse=(n,r)=>{if(r.direction==="backward")throw new Kh(e.constructor.name);const s=t.transform(n.value,n);if(r.async)return(s instanceof Promise?s:Promise.resolve(s)).then(a=>(n.value=a,n));if(s instanceof Promise)throw new as;return n.value=s,n}});function jd(e,t){return e.issues.length&&t===void 0?{issues:[],value:void 0}:e}const gm=te("$ZodOptional",(e,t)=>{Qt.init(e,t),e._zod.optin="optional",e._zod.optout="optional",Mt(e._zod,"values",()=>t.innerType._zod.values?new Set([...t.innerType._zod.values,void 0]):void 0),Mt(e._zod,"pattern",()=>{const n=t.innerType._zod.pattern;return n?new RegExp(`^(${qc(n.source)})?$`):void 0}),e._zod.parse=(n,r)=>{if(t.innerType._zod.optin==="optional"){const s=t.innerType._zod.run(n,r);return s instanceof Promise?s.then(i=>jd(i,n.value)):jd(s,n.value)}return n.value===void 0?n:t.innerType._zod.run(n,r)}}),Rw=te("$ZodExactOptional",(e,t)=>{gm.init(e,t),Mt(e._zod,"values",()=>t.innerType._zod.values),Mt(e._zod,"pattern",()=>t.innerType._zod.pattern),e._zod.parse=(n,r)=>t.innerType._zod.run(n,r)}),Dw=te("$ZodNullable",(e,t)=>{Qt.init(e,t),Mt(e._zod,"optin",()=>t.innerType._zod.optin),Mt(e._zod,"optout",()=>t.innerType._zod.optout),Mt(e._zod,"pattern",()=>{const n=t.innerType._zod.pattern;return n?new RegExp(`^(${qc(n.source)}|null)$`):void 0}),Mt(e._zod,"values",()=>t.innerType._zod.values?new Set([...t.innerType._zod.values,null]):void 0),e._zod.parse=(n,r)=>n.value===null?n:t.innerType._zod.run(n,r)}),Fw=te("$ZodDefault",(e,t)=>{Qt.init(e,t),e._zod.optin="optional",Mt(e._zod,"values",()=>t.innerType._zod.values),e._zod.parse=(n,r)=>{if(r.direction==="backward")return t.innerType._zod.run(n,r);if(n.value===void 0)return n.value=t.defaultValue,n;const s=t.innerType._zod.run(n,r);return s instanceof Promise?s.then(i=>Ed(i,t)):Ed(s,t)}});function Ed(e,t){return e.value===void 0&&(e.value=t.defaultValue),e}const zw=te("$ZodPrefault",(e,t)=>{Qt.init(e,t),e._zod.optin="optional",Mt(e._zod,"values",()=>t.innerType._zod.values),e._zod.parse=(n,r)=>(r.direction==="backward"||n.value===void 0&&(n.value=t.defaultValue),t.innerType._zod.run(n,r))}),Ow=te("$ZodNonOptional",(e,t)=>{Qt.init(e,t),Mt(e._zod,"values",()=>{const n=t.innerType._zod.values;return n?new Set([...n].filter(r=>r!==void 0)):void 0}),e._zod.parse=(n,r)=>{const s=t.innerType._zod.run(n,r);return s instanceof Promise?s.then(i=>Pd(i,e)):Pd(s,e)}});function Pd(e,t){return!e.issues.length&&e.value===void 0&&e.issues.push({code:"invalid_type",expected:"nonoptional",input:e.value,inst:t}),e}const $w=te("$ZodCatch",(e,t)=>{Qt.init(e,t),Mt(e._zod,"optin",()=>t.innerType._zod.optin),Mt(e._zod,"optout",()=>t.innerType._zod.optout),Mt(e._zod,"values",()=>t.innerType._zod.values),e._zod.parse=(n,r)=>{if(r.direction==="backward")return t.innerType._zod.run(n,r);const s=t.innerType._zod.run(n,r);return s instanceof Promise?s.then(i=>(n.value=i.value,i.issues.length&&(n.value=t.catchValue({...n,error:{issues:i.issues.map(a=>Do(a,r,Ro()))},input:n.value}),n.issues=[]),n)):(n.value=s.value,s.issues.length&&(n.value=t.catchValue({...n,error:{issues:s.issues.map(i=>Do(i,r,Ro()))},input:n.value}),n.issues=[]),n)}}),Bw=te("$ZodPipe",(e,t)=>{Qt.init(e,t),Mt(e._zod,"values",()=>t.in._zod.values),Mt(e._zod,"optin",()=>t.in._zod.optin),Mt(e._zod,"optout",()=>t.out._zod.optout),Mt(e._zod,"propValues",()=>t.in._zod.propValues),e._zod.parse=(n,r)=>{if(r.direction==="backward"){const i=t.out._zod.run(n,r);return i instanceof Promise?i.then(a=>_i(a,t.in,r)):_i(i,t.in,r)}const s=t.in._zod.run(n,r);return s instanceof Promise?s.then(i=>_i(i,t.out,r)):_i(s,t.out,r)}});function _i(e,t,n){return e.issues.length?(e.aborted=!0,e):t._zod.run({value:e.value,issues:e.issues},n)}const Uw=te("$ZodReadonly",(e,t)=>{Qt.init(e,t),Mt(e._zod,"propValues",()=>t.innerType._zod.propValues),Mt(e._zod,"values",()=>t.innerType._zod.values),Mt(e._zod,"optin",()=>t.innerType?._zod?.optin),Mt(e._zod,"optout",()=>t.innerType?._zod?.optout),e._zod.parse=(n,r)=>{if(r.direction==="backward")return t.innerType._zod.run(n,r);const s=t.innerType._zod.run(n,r);return s instanceof Promise?s.then(Nd):Nd(s)}});function Nd(e){return e.value=Object.freeze(e.value),e}const Hw=te("$ZodCustom",(e,t)=>{Gn.init(e,t),Qt.init(e,t),e._zod.parse=(n,r)=>n,e._zod.check=n=>{const r=n.value,s=t.fn(r);if(s instanceof Promise)return s.then(i=>Ad(i,n,r,e));Ad(s,n,r,e)}});function Ad(e,t,n,r){if(!e){const s={code:"custom",input:n,inst:r,path:[...r._zod.def.path??[]],continue:!r._zod.def.abort};r._zod.def.params&&(s.params=r._zod.def.params),t.issues.push(ti(s))}}var Ld;class Ww{constructor(){this._map=new WeakMap,this._idmap=new Map}add(t,...n){const r=n[0];return this._map.set(t,r),r&&typeof r=="object"&&"id"in r&&this._idmap.set(r.id,t),this}clear(){return this._map=new WeakMap,this._idmap=new Map,this}remove(t){const n=this._map.get(t);return n&&typeof n=="object"&&"id"in n&&this._idmap.delete(n.id),this._map.delete(t),this}get(t){const n=t._zod.parent;if(n){const r={...this.get(n)??{}};delete r.id;const s={...r,...this._map.get(t)};return Object.keys(s).length?s:void 0}return this._map.get(t)}has(t){return this._map.has(t)}}function Vw(){return new Ww}(Ld=globalThis).__zod_globalRegistry??(Ld.__zod_globalRegistry=Vw());const Fs=globalThis.__zod_globalRegistry;function Zw(e,t){return new e({type:"string",...Ue(t)})}function Yw(e,t){return new e({type:"string",format:"email",check:"string_format",abort:!1,...Ue(t)})}function _d(e,t){return new e({type:"string",format:"guid",check:"string_format",abort:!1,...Ue(t)})}function Gw(e,t){return new e({type:"string",format:"uuid",check:"string_format",abort:!1,...Ue(t)})}function qw(e,t){return new e({type:"string",format:"uuid",check:"string_format",abort:!1,version:"v4",...Ue(t)})}function Xw(e,t){return new e({type:"string",format:"uuid",check:"string_format",abort:!1,version:"v6",...Ue(t)})}function Kw(e,t){return new e({type:"string",format:"uuid",check:"string_format",abort:!1,version:"v7",...Ue(t)})}function Qw(e,t){return new e({type:"string",format:"url",check:"string_format",abort:!1,...Ue(t)})}function Jw(e,t){return new e({type:"string",format:"emoji",check:"string_format",abort:!1,...Ue(t)})}function eb(e,t){return new e({type:"string",format:"nanoid",check:"string_format",abort:!1,...Ue(t)})}function tb(e,t){return new e({type:"string",format:"cuid",check:"string_format",abort:!1,...Ue(t)})}function nb(e,t){return new e({type:"string",format:"cuid2",check:"string_format",abort:!1,...Ue(t)})}function rb(e,t){return new e({type:"string",format:"ulid",check:"string_format",abort:!1,...Ue(t)})}function ob(e,t){return new e({type:"string",format:"xid",check:"string_format",abort:!1,...Ue(t)})}function sb(e,t){return new e({type:"string",format:"ksuid",check:"string_format",abort:!1,...Ue(t)})}function ib(e,t){return new e({type:"string",format:"ipv4",check:"string_format",abort:!1,...Ue(t)})}function ab(e,t){return new e({type:"string",format:"ipv6",check:"string_format",abort:!1,...Ue(t)})}function lb(e,t){return new e({type:"string",format:"cidrv4",check:"string_format",abort:!1,...Ue(t)})}function cb(e,t){return new e({type:"string",format:"cidrv6",check:"string_format",abort:!1,...Ue(t)})}function ub(e,t){return new e({type:"string",format:"base64",check:"string_format",abort:!1,...Ue(t)})}function db(e,t){return new e({type:"string",format:"base64url",check:"string_format",abort:!1,...Ue(t)})}function fb(e,t){return new e({type:"string",format:"e164",check:"string_format",abort:!1,...Ue(t)})}function hb(e,t){return new e({type:"string",format:"jwt",check:"string_format",abort:!1,...Ue(t)})}function mb(e,t){return new e({type:"string",format:"datetime",check:"string_format",offset:!1,local:!1,precision:null,...Ue(t)})}function pb(e,t){return new e({type:"string",format:"date",check:"string_format",...Ue(t)})}function gb(e,t){return new e({type:"string",format:"time",check:"string_format",precision:null,...Ue(t)})}function xb(e,t){return new e({type:"string",format:"duration",check:"string_format",...Ue(t)})}function yb(e,t){return new e({type:"number",checks:[],...Ue(t)})}function vb(e,t){return new e({type:"number",check:"number_format",abort:!1,format:"safeint",...Ue(t)})}function wb(e,t){return new e({type:"boolean",...Ue(t)})}function bb(e){return new e({type:"unknown"})}function Cb(e,t){return new e({type:"never",...Ue(t)})}function Td(e,t){return new um({check:"less_than",...Ue(t),value:e,inclusive:!1})}function wl(e,t){return new um({check:"less_than",...Ue(t),value:e,inclusive:!0})}function Rd(e,t){return new dm({check:"greater_than",...Ue(t),value:e,inclusive:!1})}function bl(e,t){return new dm({check:"greater_than",...Ue(t),value:e,inclusive:!0})}function Dd(e,t){return new Ov({check:"multiple_of",...Ue(t),value:e})}function xm(e,t){return new Bv({check:"max_length",...Ue(t),maximum:e})}function Sa(e,t){return new Uv({check:"min_length",...Ue(t),minimum:e})}function ym(e,t){return new Hv({check:"length_equals",...Ue(t),length:e})}function Sb(e,t){return new Wv({check:"string_format",format:"regex",...Ue(t),pattern:e})}function kb(e){return new Vv({check:"string_format",format:"lowercase",...Ue(e)})}function Ib(e){return new Zv({check:"string_format",format:"uppercase",...Ue(e)})}function Mb(e,t){return new Yv({check:"string_format",format:"includes",...Ue(t),includes:e})}function jb(e,t){return new Gv({check:"string_format",format:"starts_with",...Ue(t),prefix:e})}function Eb(e,t){return new qv({check:"string_format",format:"ends_with",...Ue(t),suffix:e})}function Is(e){return new Xv({check:"overwrite",tx:e})}function Pb(e){return Is(t=>t.normalize(e))}function Nb(){return Is(e=>e.trim())}function Ab(){return Is(e=>e.toLowerCase())}function Lb(){return Is(e=>e.toUpperCase())}function _b(){return Is(e=>Hy(e))}function Tb(e,t,n){return new e({type:"array",element:t,...Ue(n)})}function Rb(e,t,n){return new e({type:"custom",check:"custom",fn:t,...Ue(n)})}function Db(e){const t=Fb(n=>(n.addIssue=r=>{if(typeof r=="string")n.issues.push(ti(r,n.value,t._zod.def));else{const s=r;s.fatal&&(s.continue=!1),s.code??(s.code="custom"),s.input??(s.input=n.value),s.inst??(s.inst=t),s.continue??(s.continue=!t._zod.def.abort),n.issues.push(ti(s))}},e(n.value,n)));return t}function Fb(e,t){const n=new Gn({check:"custom",...Ue(t)});return n._zod.check=e,n}function vm(e){let t=e?.target??"draft-2020-12";return t==="draft-4"&&(t="draft-04"),t==="draft-7"&&(t="draft-07"),{processors:e.processors??{},metadataRegistry:e?.metadata??Fs,target:t,unrepresentable:e?.unrepresentable??"throw",override:e?.override??(()=>{}),io:e?.io??"output",counter:0,seen:new Map,cycles:e?.cycles??"ref",reused:e?.reused??"inline",external:e?.external??void 0}}function Sn(e,t,n={path:[],schemaPath:[]}){var r;const s=e._zod.def,i=t.seen.get(e);if(i)return i.count++,n.schemaPath.includes(e)&&(i.cycle=n.path),i.schema;const a={schema:{},count:1,cycle:void 0,path:n.path};t.seen.set(e,a);const l=e._zod.toJSONSchema?.();if(l)a.schema=l;else{const h={...n,schemaPath:[...n.schemaPath,e],path:n.path};if(e._zod.processJSONSchema)e._zod.processJSONSchema(t,a.schema,h);else{const m=a.schema,g=t.processors[s.type];if(!g)throw new Error(`[toJSONSchema]: Non-representable type encountered: ${s.type}`);g(e,t,m,h)}const u=e._zod.parent;u&&(a.ref||(a.ref=u),Sn(u,t,h),t.seen.get(u).isParent=!0)}const c=t.metadataRegistry.get(e);return c&&Object.assign(a.schema,c),t.io==="input"&&An(e)&&(delete a.schema.examples,delete a.schema.default),t.io==="input"&&a.schema._prefault&&((r=a.schema).default??(r.default=a.schema._prefault)),delete a.schema._prefault,t.seen.get(e).schema}function wm(e,t){const n=e.seen.get(t);if(!n)throw new Error("Unprocessed schema. This is a bug in Zod.");const r=new Map;for(const a of e.seen.entries()){const l=e.metadataRegistry.get(a[0])?.id;if(l){const c=r.get(l);if(c&&c!==a[0])throw new Error(`Duplicate schema id "${l}" detected during JSON Schema conversion. Two different schemas cannot share the same id when converted together.`);r.set(l,a[0])}}const s=a=>{const l=e.target==="draft-2020-12"?"$defs":"definitions";if(e.external){const u=e.external.registry.get(a[0])?.id,m=e.external.uri??(p=>p);if(u)return{ref:m(u)};const g=a[1].defId??a[1].schema.id??`schema${e.counter++}`;return a[1].defId=g,{defId:g,ref:`${m("__shared")}#/${l}/${g}`}}if(a[1]===n)return{ref:"#"};const d=`#/${l}/`,h=a[1].schema.id??`__schema${e.counter++}`;return{defId:h,ref:d+h}},i=a=>{if(a[1].schema.$ref)return;const l=a[1],{ref:c,defId:d}=s(a);l.def={...l.schema},d&&(l.defId=d);const h=l.schema;for(const u in h)delete h[u];h.$ref=c};if(e.cycles==="throw")for(const a of e.seen.entries()){const l=a[1];if(l.cycle)throw new Error(`Cycle detected: #/${l.cycle?.join("/")}/<root>

Set the \`cycles\` parameter to \`"ref"\` to resolve cyclical schemas with defs.`)}for(const a of e.seen.entries()){const l=a[1];if(t===a[0]){i(a);continue}if(e.external){const d=e.external.registry.get(a[0])?.id;if(t!==a[0]&&d){i(a);continue}}if(e.metadataRegistry.get(a[0])?.id){i(a);continue}if(l.cycle){i(a);continue}if(l.count>1&&e.reused==="ref"){i(a);continue}}}function bm(e,t){const n=e.seen.get(t);if(!n)throw new Error("Unprocessed schema. This is a bug in Zod.");const r=a=>{const l=e.seen.get(a);if(l.ref===null)return;const c=l.def??l.schema,d={...c},h=l.ref;if(l.ref=null,h){r(h);const m=e.seen.get(h),g=m.schema;if(g.$ref&&(e.target==="draft-07"||e.target==="draft-04"||e.target==="openapi-3.0")?(c.allOf=c.allOf??[],c.allOf.push(g)):Object.assign(c,g),Object.assign(c,d),a._zod.parent===h)for(const y in c)y==="$ref"||y==="allOf"||y in d||delete c[y];if(g.$ref)for(const y in c)y==="$ref"||y==="allOf"||y in m.def&&JSON.stringify(c[y])===JSON.stringify(m.def[y])&&delete c[y]}const u=a._zod.parent;if(u&&u!==h){r(u);const m=e.seen.get(u);if(m?.schema.$ref&&(c.$ref=m.schema.$ref,m.def))for(const g in c)g==="$ref"||g==="allOf"||g in m.def&&JSON.stringify(c[g])===JSON.stringify(m.def[g])&&delete c[g]}e.override({zodSchema:a,jsonSchema:c,path:l.path??[]})};for(const a of[...e.seen.entries()].reverse())r(a[0]);const s={};if(e.target==="draft-2020-12"?s.$schema="https://json-schema.org/draft/2020-12/schema":e.target==="draft-07"?s.$schema="http://json-schema.org/draft-07/schema#":e.target==="draft-04"?s.$schema="http://json-schema.org/draft-04/schema#":e.target,e.external?.uri){const a=e.external.registry.get(t)?.id;if(!a)throw new Error("Schema is missing an `id` property");s.$id=e.external.uri(a)}Object.assign(s,n.def??n.schema);const i=e.external?.defs??{};for(const a of e.seen.entries()){const l=a[1];l.def&&l.defId&&(i[l.defId]=l.def)}e.external||Object.keys(i).length>0&&(e.target==="draft-2020-12"?s.$defs=i:s.definitions=i);try{const a=JSON.parse(JSON.stringify(s));return Object.defineProperty(a,"~standard",{value:{...t["~standard"],jsonSchema:{input:ka(t,"input",e.processors),output:ka(t,"output",e.processors)}},enumerable:!1,writable:!1}),a}catch{throw new Error("Error converting schema to JSON.")}}function An(e,t){const n=t??{seen:new Set};if(n.seen.has(e))return!1;n.seen.add(e);const r=e._zod.def;if(r.type==="transform")return!0;if(r.type==="array")return An(r.element,n);if(r.type==="set")return An(r.valueType,n);if(r.type==="lazy")return An(r.getter(),n);if(r.type==="promise"||r.type==="optional"||r.type==="nonoptional"||r.type==="nullable"||r.type==="readonly"||r.type==="default"||r.type==="prefault")return An(r.innerType,n);if(r.type==="intersection")return An(r.left,n)||An(r.right,n);if(r.type==="record"||r.type==="map")return An(r.keyType,n)||An(r.valueType,n);if(r.type==="pipe")return An(r.in,n)||An(r.out,n);if(r.type==="object"){for(const s in r.shape)if(An(r.shape[s],n))return!0;return!1}if(r.type==="union"){for(const s of r.options)if(An(s,n))return!0;return!1}if(r.type==="tuple"){for(const s of r.items)if(An(s,n))return!0;return!!(r.rest&&An(r.rest,n))}return!1}const zb=(e,t={})=>n=>{const r=vm({...n,processors:t});return Sn(e,r),wm(r,e),bm(r,e)},ka=(e,t,n={})=>r=>{const{libraryOptions:s,target:i}=r??{},a=vm({...s??{},target:i,io:t,processors:n});return Sn(e,a),wm(a,e),bm(a,e)},Ob={guid:"uuid",url:"uri",datetime:"date-time",json_string:"json-string",regex:""},$b=(e,t,n,r)=>{const s=n;s.type="string";const{minimum:i,maximum:a,format:l,patterns:c,contentEncoding:d}=e._zod.bag;if(typeof i=="number"&&(s.minLength=i),typeof a=="number"&&(s.maxLength=a),l&&(s.format=Ob[l]??l,s.format===""&&delete s.format,l==="time"&&delete s.format),d&&(s.contentEncoding=d),c&&c.size>0){const h=[...c];h.length===1?s.pattern=h[0].source:h.length>1&&(s.allOf=[...h.map(u=>({...t.target==="draft-07"||t.target==="draft-04"||t.target==="openapi-3.0"?{type:"string"}:{},pattern:u.source}))])}},Bb=(e,t,n,r)=>{const s=n,{minimum:i,maximum:a,format:l,multipleOf:c,exclusiveMaximum:d,exclusiveMinimum:h}=e._zod.bag;typeof l=="string"&&l.includes("int")?s.type="integer":s.type="number",typeof h=="number"&&(t.target==="draft-04"||t.target==="openapi-3.0"?(s.minimum=h,s.exclusiveMinimum=!0):s.exclusiveMinimum=h),typeof i=="number"&&(s.minimum=i,typeof h=="number"&&t.target!=="draft-04"&&(h>=i?delete s.minimum:delete s.exclusiveMinimum)),typeof d=="number"&&(t.target==="draft-04"||t.target==="openapi-3.0"?(s.maximum=d,s.exclusiveMaximum=!0):s.exclusiveMaximum=d),typeof a=="number"&&(s.maximum=a,typeof d=="number"&&t.target!=="draft-04"&&(d<=a?delete s.maximum:delete s.exclusiveMaximum)),typeof c=="number"&&(s.multipleOf=c)},Ub=(e,t,n,r)=>{n.type="boolean"},Hb=(e,t,n,r)=>{n.not={}},Wb=(e,t,n,r)=>{},Vb=(e,t,n,r)=>{const s=e._zod.def,i=Jh(s.entries);i.every(a=>typeof a=="number")&&(n.type="number"),i.every(a=>typeof a=="string")&&(n.type="string"),n.enum=i},Zb=(e,t,n,r)=>{if(t.unrepresentable==="throw")throw new Error("Custom types cannot be represented in JSON Schema")},Yb=(e,t,n,r)=>{if(t.unrepresentable==="throw")throw new Error("Transforms cannot be represented in JSON Schema")},Gb=(e,t,n,r)=>{const s=n,i=e._zod.def,{minimum:a,maximum:l}=e._zod.bag;typeof a=="number"&&(s.minItems=a),typeof l=="number"&&(s.maxItems=l),s.type="array",s.items=Sn(i.element,t,{...r,path:[...r.path,"items"]})},qb=(e,t,n,r)=>{const s=n,i=e._zod.def;s.type="object",s.properties={};const a=i.shape;for(const d in a)s.properties[d]=Sn(a[d],t,{...r,path:[...r.path,"properties",d]});const l=new Set(Object.keys(a)),c=new Set([...l].filter(d=>{const h=i.shape[d]._zod;return t.io==="input"?h.optin===void 0:h.optout===void 0}));c.size>0&&(s.required=Array.from(c)),i.catchall?._zod.def.type==="never"?s.additionalProperties=!1:i.catchall?i.catchall&&(s.additionalProperties=Sn(i.catchall,t,{...r,path:[...r.path,"additionalProperties"]})):t.io==="output"&&(s.additionalProperties=!1)},Xb=(e,t,n,r)=>{const s=e._zod.def,i=s.inclusive===!1,a=s.options.map((l,c)=>Sn(l,t,{...r,path:[...r.path,i?"oneOf":"anyOf",c]}));i?n.oneOf=a:n.anyOf=a},Kb=(e,t,n,r)=>{const s=e._zod.def,i=Sn(s.left,t,{...r,path:[...r.path,"allOf",0]}),a=Sn(s.right,t,{...r,path:[...r.path,"allOf",1]}),l=d=>"allOf"in d&&Object.keys(d).length===1,c=[...l(i)?i.allOf:[i],...l(a)?a.allOf:[a]];n.allOf=c},Qb=(e,t,n,r)=>{const s=e._zod.def,i=Sn(s.innerType,t,r),a=t.seen.get(e);t.target==="openapi-3.0"?(a.ref=s.innerType,n.nullable=!0):n.anyOf=[i,{type:"null"}]},Jb=(e,t,n,r)=>{const s=e._zod.def;Sn(s.innerType,t,r);const i=t.seen.get(e);i.ref=s.innerType},e1=(e,t,n,r)=>{const s=e._zod.def;Sn(s.innerType,t,r);const i=t.seen.get(e);i.ref=s.innerType,n.default=JSON.parse(JSON.stringify(s.defaultValue))},t1=(e,t,n,r)=>{const s=e._zod.def;Sn(s.innerType,t,r);const i=t.seen.get(e);i.ref=s.innerType,t.io==="input"&&(n._prefault=JSON.parse(JSON.stringify(s.defaultValue)))},n1=(e,t,n,r)=>{const s=e._zod.def;Sn(s.innerType,t,r);const i=t.seen.get(e);i.ref=s.innerType;let a;try{a=s.catchValue(void 0)}catch{throw new Error("Dynamic catch values are not supported in JSON Schema")}n.default=a},r1=(e,t,n,r)=>{const s=e._zod.def,i=t.io==="input"?s.in._zod.def.type==="transform"?s.out:s.in:s.out;Sn(i,t,r);const a=t.seen.get(e);a.ref=i},o1=(e,t,n,r)=>{const s=e._zod.def;Sn(s.innerType,t,r);const i=t.seen.get(e);i.ref=s.innerType,n.readOnly=!0},Cm=(e,t,n,r)=>{const s=e._zod.def;Sn(s.innerType,t,r);const i=t.seen.get(e);i.ref=s.innerType},s1=te("ZodISODateTime",(e,t)=>{uw.init(e,t),Gt.init(e,t)});function i1(e){return mb(s1,e)}const a1=te("ZodISODate",(e,t)=>{dw.init(e,t),Gt.init(e,t)});function l1(e){return pb(a1,e)}const c1=te("ZodISOTime",(e,t)=>{fw.init(e,t),Gt.init(e,t)});function u1(e){return gb(c1,e)}const d1=te("ZodISODuration",(e,t)=>{hw.init(e,t),Gt.init(e,t)});function f1(e){return xb(d1,e)}const h1=(e,t)=>{om.init(e,t),e.name="ZodError",Object.defineProperties(e,{format:{value:n=>nv(e,n)},flatten:{value:n=>tv(e,n)},addIssue:{value:n=>{e.issues.push(n),e.message=JSON.stringify(e.issues,nc,2)}},addIssues:{value:n=>{e.issues.push(...n),e.message=JSON.stringify(e.issues,nc,2)}},isEmpty:{get(){return e.issues.length===0}}})},ir=te("ZodError",h1,{Parent:Error}),m1=Kc(ir),p1=Qc(ir),g1=Ha(ir),x1=Wa(ir),y1=sv(ir),v1=iv(ir),w1=av(ir),b1=lv(ir),C1=cv(ir),S1=uv(ir),k1=dv(ir),I1=fv(ir),Jt=te("ZodType",(e,t)=>(Qt.init(e,t),Object.assign(e["~standard"],{jsonSchema:{input:ka(e,"input"),output:ka(e,"output")}}),e.toJSONSchema=zb(e,{}),e.def=t,e.type=t.type,Object.defineProperty(e,"_def",{value:t}),e.check=(...n)=>e.clone(uo(t,{checks:[...t.checks??[],...n.map(r=>typeof r=="function"?{_zod:{check:r,def:{check:"custom"},onattach:[]}}:r)]}),{parent:!0}),e.with=e.check,e.clone=(n,r)=>fo(e,n,r),e.brand=()=>e,e.register=((n,r)=>(n.add(e,r),e)),e.parse=(n,r)=>m1(e,n,r,{callee:e.parse}),e.safeParse=(n,r)=>g1(e,n,r),e.parseAsync=async(n,r)=>p1(e,n,r,{callee:e.parseAsync}),e.safeParseAsync=async(n,r)=>x1(e,n,r),e.spa=e.safeParseAsync,e.encode=(n,r)=>y1(e,n,r),e.decode=(n,r)=>v1(e,n,r),e.encodeAsync=async(n,r)=>w1(e,n,r),e.decodeAsync=async(n,r)=>b1(e,n,r),e.safeEncode=(n,r)=>C1(e,n,r),e.safeDecode=(n,r)=>S1(e,n,r),e.safeEncodeAsync=async(n,r)=>k1(e,n,r),e.safeDecodeAsync=async(n,r)=>I1(e,n,r),e.refine=(n,r)=>e.check(x2(n,r)),e.superRefine=n=>e.check(y2(n)),e.overwrite=n=>e.check(Is(n)),e.optional=()=>Od(e),e.exactOptional=()=>o2(e),e.nullable=()=>$d(e),e.nullish=()=>Od($d(e)),e.nonoptional=n=>u2(e,n),e.array=()=>sc(e),e.or=n=>Q1([e,n]),e.and=n=>e2(e,n),e.transform=n=>Bd(e,n2(n)),e.default=n=>a2(e,n),e.prefault=n=>c2(e,n),e.catch=n=>f2(e,n),e.pipe=n=>Bd(e,n),e.readonly=()=>p2(e),e.describe=n=>{const r=e.clone();return Fs.add(r,{description:n}),r},Object.defineProperty(e,"description",{get(){return Fs.get(e)?.description},configurable:!0}),e.meta=(...n)=>{if(n.length===0)return Fs.get(e);const r=e.clone();return Fs.add(r,n[0]),r},e.isOptional=()=>e.safeParse(void 0).success,e.isNullable=()=>e.safeParse(null).success,e.apply=n=>n(e),e)),Sm=te("_ZodString",(e,t)=>{Jc.init(e,t),Jt.init(e,t),e._zod.processJSONSchema=(r,s,i)=>$b(e,r,s);const n=e._zod.bag;e.format=n.format??null,e.minLength=n.minimum??null,e.maxLength=n.maximum??null,e.regex=(...r)=>e.check(Sb(...r)),e.includes=(...r)=>e.check(Mb(...r)),e.startsWith=(...r)=>e.check(jb(...r)),e.endsWith=(...r)=>e.check(Eb(...r)),e.min=(...r)=>e.check(Sa(...r)),e.max=(...r)=>e.check(xm(...r)),e.length=(...r)=>e.check(ym(...r)),e.nonempty=(...r)=>e.check(Sa(1,...r)),e.lowercase=r=>e.check(kb(r)),e.uppercase=r=>e.check(Ib(r)),e.trim=()=>e.check(Nb()),e.normalize=(...r)=>e.check(Pb(...r)),e.toLowerCase=()=>e.check(Ab()),e.toUpperCase=()=>e.check(Lb()),e.slugify=()=>e.check(_b())}),M1=te("ZodString",(e,t)=>{Jc.init(e,t),Sm.init(e,t),e.email=n=>e.check(Yw(j1,n)),e.url=n=>e.check(Qw(E1,n)),e.jwt=n=>e.check(hb(H1,n)),e.emoji=n=>e.check(Jw(P1,n)),e.guid=n=>e.check(_d(Fd,n)),e.uuid=n=>e.check(Gw(Ti,n)),e.uuidv4=n=>e.check(qw(Ti,n)),e.uuidv6=n=>e.check(Xw(Ti,n)),e.uuidv7=n=>e.check(Kw(Ti,n)),e.nanoid=n=>e.check(eb(N1,n)),e.guid=n=>e.check(_d(Fd,n)),e.cuid=n=>e.check(tb(A1,n)),e.cuid2=n=>e.check(nb(L1,n)),e.ulid=n=>e.check(rb(_1,n)),e.base64=n=>e.check(ub($1,n)),e.base64url=n=>e.check(db(B1,n)),e.xid=n=>e.check(ob(T1,n)),e.ksuid=n=>e.check(sb(R1,n)),e.ipv4=n=>e.check(ib(D1,n)),e.ipv6=n=>e.check(ab(F1,n)),e.cidrv4=n=>e.check(lb(z1,n)),e.cidrv6=n=>e.check(cb(O1,n)),e.e164=n=>e.check(fb(U1,n)),e.datetime=n=>e.check(i1(n)),e.date=n=>e.check(l1(n)),e.time=n=>e.check(u1(n)),e.duration=n=>e.check(f1(n))});function tr(e){return Zw(M1,e)}const Gt=te("ZodStringFormat",(e,t)=>{Ut.init(e,t),Sm.init(e,t)}),j1=te("ZodEmail",(e,t)=>{tw.init(e,t),Gt.init(e,t)}),Fd=te("ZodGUID",(e,t)=>{Jv.init(e,t),Gt.init(e,t)}),Ti=te("ZodUUID",(e,t)=>{ew.init(e,t),Gt.init(e,t)}),E1=te("ZodURL",(e,t)=>{nw.init(e,t),Gt.init(e,t)}),P1=te("ZodEmoji",(e,t)=>{rw.init(e,t),Gt.init(e,t)}),N1=te("ZodNanoID",(e,t)=>{ow.init(e,t),Gt.init(e,t)}),A1=te("ZodCUID",(e,t)=>{sw.init(e,t),Gt.init(e,t)}),L1=te("ZodCUID2",(e,t)=>{iw.init(e,t),Gt.init(e,t)}),_1=te("ZodULID",(e,t)=>{aw.init(e,t),Gt.init(e,t)}),T1=te("ZodXID",(e,t)=>{lw.init(e,t),Gt.init(e,t)}),R1=te("ZodKSUID",(e,t)=>{cw.init(e,t),Gt.init(e,t)}),D1=te("ZodIPv4",(e,t)=>{mw.init(e,t),Gt.init(e,t)}),F1=te("ZodIPv6",(e,t)=>{pw.init(e,t),Gt.init(e,t)}),z1=te("ZodCIDRv4",(e,t)=>{gw.init(e,t),Gt.init(e,t)}),O1=te("ZodCIDRv6",(e,t)=>{xw.init(e,t),Gt.init(e,t)}),$1=te("ZodBase64",(e,t)=>{yw.init(e,t),Gt.init(e,t)}),B1=te("ZodBase64URL",(e,t)=>{ww.init(e,t),Gt.init(e,t)}),U1=te("ZodE164",(e,t)=>{bw.init(e,t),Gt.init(e,t)}),H1=te("ZodJWT",(e,t)=>{Sw.init(e,t),Gt.init(e,t)}),km=te("ZodNumber",(e,t)=>{hm.init(e,t),Jt.init(e,t),e._zod.processJSONSchema=(r,s,i)=>Bb(e,r,s),e.gt=(r,s)=>e.check(Rd(r,s)),e.gte=(r,s)=>e.check(bl(r,s)),e.min=(r,s)=>e.check(bl(r,s)),e.lt=(r,s)=>e.check(Td(r,s)),e.lte=(r,s)=>e.check(wl(r,s)),e.max=(r,s)=>e.check(wl(r,s)),e.int=r=>e.check(zd(r)),e.safe=r=>e.check(zd(r)),e.positive=r=>e.check(Rd(0,r)),e.nonnegative=r=>e.check(bl(0,r)),e.negative=r=>e.check(Td(0,r)),e.nonpositive=r=>e.check(wl(0,r)),e.multipleOf=(r,s)=>e.check(Dd(r,s)),e.step=(r,s)=>e.check(Dd(r,s)),e.finite=()=>e;const n=e._zod.bag;e.minValue=Math.max(n.minimum??Number.NEGATIVE_INFINITY,n.exclusiveMinimum??Number.NEGATIVE_INFINITY)??null,e.maxValue=Math.min(n.maximum??Number.POSITIVE_INFINITY,n.exclusiveMaximum??Number.POSITIVE_INFINITY)??null,e.isInt=(n.format??"").includes("int")||Number.isSafeInteger(n.multipleOf??.5),e.isFinite=!0,e.format=n.format??null});function eu(e){return yb(km,e)}const W1=te("ZodNumberFormat",(e,t)=>{kw.init(e,t),km.init(e,t)});function zd(e){return vb(W1,e)}const V1=te("ZodBoolean",(e,t)=>{Iw.init(e,t),Jt.init(e,t),e._zod.processJSONSchema=(n,r,s)=>Ub(e,n,r)});function Im(e){return wb(V1,e)}const Z1=te("ZodUnknown",(e,t)=>{Mw.init(e,t),Jt.init(e,t),e._zod.processJSONSchema=(n,r,s)=>Wb()});function oc(){return bb(Z1)}const Y1=te("ZodNever",(e,t)=>{jw.init(e,t),Jt.init(e,t),e._zod.processJSONSchema=(n,r,s)=>Hb(e,n,r)});function G1(e){return Cb(Y1,e)}const q1=te("ZodArray",(e,t)=>{Ew.init(e,t),Jt.init(e,t),e._zod.processJSONSchema=(n,r,s)=>Gb(e,n,r,s),e.element=t.element,e.min=(n,r)=>e.check(Sa(n,r)),e.nonempty=n=>e.check(Sa(1,n)),e.max=(n,r)=>e.check(xm(n,r)),e.length=(n,r)=>e.check(ym(n,r)),e.unwrap=()=>e.element});function sc(e,t){return Tb(q1,e,t)}const X1=te("ZodObject",(e,t)=>{Nw.init(e,t),Jt.init(e,t),e._zod.processJSONSchema=(n,r,s)=>qb(e,n,r,s),Mt(e,"shape",()=>t.shape),e.keyof=()=>Mm(Object.keys(e._zod.def.shape)),e.catchall=n=>e.clone({...e._zod.def,catchall:n}),e.passthrough=()=>e.clone({...e._zod.def,catchall:oc()}),e.loose=()=>e.clone({...e._zod.def,catchall:oc()}),e.strict=()=>e.clone({...e._zod.def,catchall:G1()}),e.strip=()=>e.clone({...e._zod.def,catchall:void 0}),e.extend=n=>Xy(e,n),e.safeExtend=n=>Ky(e,n),e.merge=n=>Qy(e,n),e.pick=n=>Gy(e,n),e.omit=n=>qy(e,n),e.partial=(...n)=>Jy(jm,e,n[0]),e.required=(...n)=>ev(Em,e,n[0])});function Ia(e,t){const n={type:"object",shape:e??{},...Ue(t)};return new X1(n)}const K1=te("ZodUnion",(e,t)=>{Aw.init(e,t),Jt.init(e,t),e._zod.processJSONSchema=(n,r,s)=>Xb(e,n,r,s),e.options=t.options});function Q1(e,t){return new K1({type:"union",options:e,...Ue(t)})}const J1=te("ZodIntersection",(e,t)=>{Lw.init(e,t),Jt.init(e,t),e._zod.processJSONSchema=(n,r,s)=>Kb(e,n,r,s)});function e2(e,t){return new J1({type:"intersection",left:e,right:t})}const ic=te("ZodEnum",(e,t)=>{_w.init(e,t),Jt.init(e,t),e._zod.processJSONSchema=(r,s,i)=>Vb(e,r,s),e.enum=t.entries,e.options=Object.values(t.entries);const n=new Set(Object.keys(t.entries));e.extract=(r,s)=>{const i={};for(const a of r)if(n.has(a))i[a]=t.entries[a];else throw new Error(`Key ${a} not found in enum`);return new ic({...t,checks:[],...Ue(s),entries:i})},e.exclude=(r,s)=>{const i={...t.entries};for(const a of r)if(n.has(a))delete i[a];else throw new Error(`Key ${a} not found in enum`);return new ic({...t,checks:[],...Ue(s),entries:i})}});function Mm(e,t){const n=Array.isArray(e)?Object.fromEntries(e.map(r=>[r,r])):e;return new ic({type:"enum",entries:n,...Ue(t)})}const t2=te("ZodTransform",(e,t)=>{Tw.init(e,t),Jt.init(e,t),e._zod.processJSONSchema=(n,r,s)=>Yb(e,n),e._zod.parse=(n,r)=>{if(r.direction==="backward")throw new Kh(e.constructor.name);n.addIssue=i=>{if(typeof i=="string")n.issues.push(ti(i,n.value,t));else{const a=i;a.fatal&&(a.continue=!1),a.code??(a.code="custom"),a.input??(a.input=n.value),a.inst??(a.inst=e),n.issues.push(ti(a))}};const s=t.transform(n.value,n);return s instanceof Promise?s.then(i=>(n.value=i,n)):(n.value=s,n)}});function n2(e){return new t2({type:"transform",transform:e})}const jm=te("ZodOptional",(e,t)=>{gm.init(e,t),Jt.init(e,t),e._zod.processJSONSchema=(n,r,s)=>Cm(e,n,r,s),e.unwrap=()=>e._zod.def.innerType});function Od(e){return new jm({type:"optional",innerType:e})}const r2=te("ZodExactOptional",(e,t)=>{Rw.init(e,t),Jt.init(e,t),e._zod.processJSONSchema=(n,r,s)=>Cm(e,n,r,s),e.unwrap=()=>e._zod.def.innerType});function o2(e){return new r2({type:"optional",innerType:e})}const s2=te("ZodNullable",(e,t)=>{Dw.init(e,t),Jt.init(e,t),e._zod.processJSONSchema=(n,r,s)=>Qb(e,n,r,s),e.unwrap=()=>e._zod.def.innerType});function $d(e){return new s2({type:"nullable",innerType:e})}const i2=te("ZodDefault",(e,t)=>{Fw.init(e,t),Jt.init(e,t),e._zod.processJSONSchema=(n,r,s)=>e1(e,n,r,s),e.unwrap=()=>e._zod.def.innerType,e.removeDefault=e.unwrap});function a2(e,t){return new i2({type:"default",innerType:e,get defaultValue(){return typeof t=="function"?t():tm(t)}})}const l2=te("ZodPrefault",(e,t)=>{zw.init(e,t),Jt.init(e,t),e._zod.processJSONSchema=(n,r,s)=>t1(e,n,r,s),e.unwrap=()=>e._zod.def.innerType});function c2(e,t){return new l2({type:"prefault",innerType:e,get defaultValue(){return typeof t=="function"?t():tm(t)}})}const Em=te("ZodNonOptional",(e,t)=>{Ow.init(e,t),Jt.init(e,t),e._zod.processJSONSchema=(n,r,s)=>Jb(e,n,r,s),e.unwrap=()=>e._zod.def.innerType});function u2(e,t){return new Em({type:"nonoptional",innerType:e,...Ue(t)})}const d2=te("ZodCatch",(e,t)=>{$w.init(e,t),Jt.init(e,t),e._zod.processJSONSchema=(n,r,s)=>n1(e,n,r,s),e.unwrap=()=>e._zod.def.innerType,e.removeCatch=e.unwrap});function f2(e,t){return new d2({type:"catch",innerType:e,catchValue:typeof t=="function"?t:()=>t})}const h2=te("ZodPipe",(e,t)=>{Bw.init(e,t),Jt.init(e,t),e._zod.processJSONSchema=(n,r,s)=>r1(e,n,r,s),e.in=t.in,e.out=t.out});function Bd(e,t){return new h2({type:"pipe",in:e,out:t})}const m2=te("ZodReadonly",(e,t)=>{Uw.init(e,t),Jt.init(e,t),e._zod.processJSONSchema=(n,r,s)=>o1(e,n,r,s),e.unwrap=()=>e._zod.def.innerType});function p2(e){return new m2({type:"readonly",innerType:e})}const g2=te("ZodCustom",(e,t)=>{Hw.init(e,t),Jt.init(e,t),e._zod.processJSONSchema=(n,r,s)=>Zb(e,n)});function x2(e,t={}){return Rb(g2,e,t)}function y2(e){return Db(e)}function v2(e){let t;switch(e.type){case"number":{const n=e;let r=eu();n.min!==void 0&&(r=r.min(n.min)),n.max!==void 0&&(r=r.max(n.max)),n.isInt&&(r=r.int()),t=r,n.nullable===!0&&(t=r.nullable());break}case"boolean":{t=Im();break}case"string":{const n=e;let r=tr();if(n.pattern){const s=n.patternDesc?`Invalid format: expected ${n.patternDesc}`:"Invalid format";r=r.regex(n.pattern,s)}t=r;break}case"enum":{t=Mm(e.enumValues);break}default:t=oc()}return t.optional()}function w2(e){const t={};for(const n of xi(e))t[n.key]=v2(n);return Ia(t).optional()}function b2(){const e={version:eu().int().min(1).max(Vc).optional()};for(const t of gi)e[t.key]=w2(t);return Ia(e)}const C2=b2(),S2=C2;function k2(e){const t=S2.safeParse(e);return t.success?{valid:!0,errors:[],config:t.data}:{valid:!1,errors:t.error.issues.map(r=>({path:r.path.join("."),message:r.message,value:void 0})),config:null}}function Pm(e){return typeof e>"u"||e===null}function I2(e){return typeof e=="object"&&e!==null}function M2(e){return Array.isArray(e)?e:Pm(e)?[]:[e]}function j2(e,t){var n,r,s,i;if(t)for(i=Object.keys(t),n=0,r=i.length;n<r;n+=1)s=i[n],e[s]=t[s];return e}function E2(e,t){var n="",r;for(r=0;r<t;r+=1)n+=e;return n}function P2(e){return e===0&&Number.NEGATIVE_INFINITY===1/e}var N2=Pm,A2=I2,L2=M2,_2=E2,T2=P2,R2=j2,un={isNothing:N2,isObject:A2,toArray:L2,repeat:_2,isNegativeZero:T2,extend:R2};function Nm(e,t){var n="",r=e.reason||"(unknown reason)";return e.mark?(e.mark.name&&(n+='in "'+e.mark.name+'" '),n+="("+(e.mark.line+1)+":"+(e.mark.column+1)+")",!t&&e.mark.snippet&&(n+=`

`+e.mark.snippet),r+" "+n):r}function ni(e,t){Error.call(this),this.name="YAMLException",this.reason=e,this.mark=t,this.message=Nm(this,!1),Error.captureStackTrace?Error.captureStackTrace(this,this.constructor):this.stack=new Error().stack||""}ni.prototype=Object.create(Error.prototype);ni.prototype.constructor=ni;ni.prototype.toString=function(t){return this.name+": "+Nm(this,t)};var Hn=ni;function Cl(e,t,n,r,s){var i="",a="",l=Math.floor(s/2)-1;return r-t>l&&(i=" ... ",t=r-l+i.length),n-r>l&&(a=" ...",n=r+l-a.length),{str:i+e.slice(t,n).replace(/\t/g,"â†’")+a,pos:r-t+i.length}}function Sl(e,t){return un.repeat(" ",t-e.length)+e}function D2(e,t){if(t=Object.create(t||null),!e.buffer)return null;t.maxLength||(t.maxLength=79),typeof t.indent!="number"&&(t.indent=1),typeof t.linesBefore!="number"&&(t.linesBefore=3),typeof t.linesAfter!="number"&&(t.linesAfter=2);for(var n=/\r?\n|\r|\0/g,r=[0],s=[],i,a=-1;i=n.exec(e.buffer);)s.push(i.index),r.push(i.index+i[0].length),e.position<=i.index&&a<0&&(a=r.length-2);a<0&&(a=r.length-1);var l="",c,d,h=Math.min(e.line+t.linesAfter,s.length).toString().length,u=t.maxLength-(t.indent+h+3);for(c=1;c<=t.linesBefore&&!(a-c<0);c++)d=Cl(e.buffer,r[a-c],s[a-c],e.position-(r[a]-r[a-c]),u),l=un.repeat(" ",t.indent)+Sl((e.line-c+1).toString(),h)+" | "+d.str+`
`+l;for(d=Cl(e.buffer,r[a],s[a],e.position,u),l+=un.repeat(" ",t.indent)+Sl((e.line+1).toString(),h)+" | "+d.str+`
`,l+=un.repeat("-",t.indent+h+3+d.pos)+`^
`,c=1;c<=t.linesAfter&&!(a+c>=s.length);c++)d=Cl(e.buffer,r[a+c],s[a+c],e.position-(r[a]-r[a+c]),u),l+=un.repeat(" ",t.indent)+Sl((e.line+c+1).toString(),h)+" | "+d.str+`
`;return l.replace(/\n$/,"")}var F2=D2,z2=["kind","multi","resolve","construct","instanceOf","predicate","represent","representName","defaultStyle","styleAliases"],O2=["scalar","sequence","mapping"];function $2(e){var t={};return e!==null&&Object.keys(e).forEach(function(n){e[n].forEach(function(r){t[String(r)]=n})}),t}function B2(e,t){if(t=t||{},Object.keys(t).forEach(function(n){if(z2.indexOf(n)===-1)throw new Hn('Unknown option "'+n+'" is met in definition of "'+e+'" YAML type.')}),this.options=t,this.tag=e,this.kind=t.kind||null,this.resolve=t.resolve||function(){return!0},this.construct=t.construct||function(n){return n},this.instanceOf=t.instanceOf||null,this.predicate=t.predicate||null,this.represent=t.represent||null,this.representName=t.representName||null,this.defaultStyle=t.defaultStyle||null,this.multi=t.multi||!1,this.styleAliases=$2(t.styleAliases||null),O2.indexOf(this.kind)===-1)throw new Hn('Unknown kind "'+this.kind+'" is specified for "'+e+'" YAML type.')}var Mn=B2;function Ud(e,t){var n=[];return e[t].forEach(function(r){var s=n.length;n.forEach(function(i,a){i.tag===r.tag&&i.kind===r.kind&&i.multi===r.multi&&(s=a)}),n[s]=r}),n}function U2(){var e={scalar:{},sequence:{},mapping:{},fallback:{},multi:{scalar:[],sequence:[],mapping:[],fallback:[]}},t,n;function r(s){s.multi?(e.multi[s.kind].push(s),e.multi.fallback.push(s)):e[s.kind][s.tag]=e.fallback[s.tag]=s}for(t=0,n=arguments.length;t<n;t+=1)arguments[t].forEach(r);return e}function ac(e){return this.extend(e)}ac.prototype.extend=function(t){var n=[],r=[];if(t instanceof Mn)r.push(t);else if(Array.isArray(t))r=r.concat(t);else if(t&&(Array.isArray(t.implicit)||Array.isArray(t.explicit)))t.implicit&&(n=n.concat(t.implicit)),t.explicit&&(r=r.concat(t.explicit));else throw new Hn("Schema.extend argument should be a Type, [ Type ], or a schema definition ({ implicit: [...], explicit: [...] })");n.forEach(function(i){if(!(i instanceof Mn))throw new Hn("Specified list of YAML types (or a single Type object) contains a non-Type object.");if(i.loadKind&&i.loadKind!=="scalar")throw new Hn("There is a non-scalar type in the implicit list of a schema. Implicit resolving of such types is not supported.");if(i.multi)throw new Hn("There is a multi type in the implicit list of a schema. Multi tags can only be listed as explicit.")}),r.forEach(function(i){if(!(i instanceof Mn))throw new Hn("Specified list of YAML types (or a single Type object) contains a non-Type object.")});var s=Object.create(ac.prototype);return s.implicit=(this.implicit||[]).concat(n),s.explicit=(this.explicit||[]).concat(r),s.compiledImplicit=Ud(s,"implicit"),s.compiledExplicit=Ud(s,"explicit"),s.compiledTypeMap=U2(s.compiledImplicit,s.compiledExplicit),s};var H2=ac,W2=new Mn("tag:yaml.org,2002:str",{kind:"scalar",construct:function(e){return e!==null?e:""}}),V2=new Mn("tag:yaml.org,2002:seq",{kind:"sequence",construct:function(e){return e!==null?e:[]}}),Z2=new Mn("tag:yaml.org,2002:map",{kind:"mapping",construct:function(e){return e!==null?e:{}}}),Y2=new H2({explicit:[W2,V2,Z2]});function G2(e){if(e===null)return!0;var t=e.length;return t===1&&e==="~"||t===4&&(e==="null"||e==="Null"||e==="NULL")}function q2(){return null}function X2(e){return e===null}var K2=new Mn("tag:yaml.org,2002:null",{kind:"scalar",resolve:G2,construct:q2,predicate:X2,represent:{canonical:function(){return"~"},lowercase:function(){return"null"},uppercase:function(){return"NULL"},camelcase:function(){return"Null"},empty:function(){return""}},defaultStyle:"lowercase"});function Q2(e){if(e===null)return!1;var t=e.length;return t===4&&(e==="true"||e==="True"||e==="TRUE")||t===5&&(e==="false"||e==="False"||e==="FALSE")}function J2(e){return e==="true"||e==="True"||e==="TRUE"}function eC(e){return Object.prototype.toString.call(e)==="[object Boolean]"}var tC=new Mn("tag:yaml.org,2002:bool",{kind:"scalar",resolve:Q2,construct:J2,predicate:eC,represent:{lowercase:function(e){return e?"true":"false"},uppercase:function(e){return e?"TRUE":"FALSE"},camelcase:function(e){return e?"True":"False"}},defaultStyle:"lowercase"});function nC(e){return 48<=e&&e<=57||65<=e&&e<=70||97<=e&&e<=102}function rC(e){return 48<=e&&e<=55}function oC(e){return 48<=e&&e<=57}function sC(e){if(e===null)return!1;var t=e.length,n=0,r=!1,s;if(!t)return!1;if(s=e[n],(s==="-"||s==="+")&&(s=e[++n]),s==="0"){if(n+1===t)return!0;if(s=e[++n],s==="b"){for(n++;n<t;n++)if(s=e[n],s!=="_"){if(s!=="0"&&s!=="1")return!1;r=!0}return r&&s!=="_"}if(s==="x"){for(n++;n<t;n++)if(s=e[n],s!=="_"){if(!nC(e.charCodeAt(n)))return!1;r=!0}return r&&s!=="_"}if(s==="o"){for(n++;n<t;n++)if(s=e[n],s!=="_"){if(!rC(e.charCodeAt(n)))return!1;r=!0}return r&&s!=="_"}}if(s==="_")return!1;for(;n<t;n++)if(s=e[n],s!=="_"){if(!oC(e.charCodeAt(n)))return!1;r=!0}return!(!r||s==="_")}function iC(e){var t=e,n=1,r;if(t.indexOf("_")!==-1&&(t=t.replace(/_/g,"")),r=t[0],(r==="-"||r==="+")&&(r==="-"&&(n=-1),t=t.slice(1),r=t[0]),t==="0")return 0;if(r==="0"){if(t[1]==="b")return n*parseInt(t.slice(2),2);if(t[1]==="x")return n*parseInt(t.slice(2),16);if(t[1]==="o")return n*parseInt(t.slice(2),8)}return n*parseInt(t,10)}function aC(e){return Object.prototype.toString.call(e)==="[object Number]"&&e%1===0&&!un.isNegativeZero(e)}var lC=new Mn("tag:yaml.org,2002:int",{kind:"scalar",resolve:sC,construct:iC,predicate:aC,represent:{binary:function(e){return e>=0?"0b"+e.toString(2):"-0b"+e.toString(2).slice(1)},octal:function(e){return e>=0?"0o"+e.toString(8):"-0o"+e.toString(8).slice(1)},decimal:function(e){return e.toString(10)},hexadecimal:function(e){return e>=0?"0x"+e.toString(16).toUpperCase():"-0x"+e.toString(16).toUpperCase().slice(1)}},defaultStyle:"decimal",styleAliases:{binary:[2,"bin"],octal:[8,"oct"],decimal:[10,"dec"],hexadecimal:[16,"hex"]}}),cC=new RegExp("^(?:[-+]?(?:[0-9][0-9_]*)(?:\\.[0-9_]*)?(?:[eE][-+]?[0-9]+)?|\\.[0-9_]+(?:[eE][-+]?[0-9]+)?|[-+]?\\.(?:inf|Inf|INF)|\\.(?:nan|NaN|NAN))$");function uC(e){return!(e===null||!cC.test(e)||e[e.length-1]==="_")}function dC(e){var t,n;return t=e.replace(/_/g,"").toLowerCase(),n=t[0]==="-"?-1:1,"+-".indexOf(t[0])>=0&&(t=t.slice(1)),t===".inf"?n===1?Number.POSITIVE_INFINITY:Number.NEGATIVE_INFINITY:t===".nan"?NaN:n*parseFloat(t,10)}var fC=/^[-+]?[0-9]+e/;function hC(e,t){var n;if(isNaN(e))switch(t){case"lowercase":return".nan";case"uppercase":return".NAN";case"camelcase":return".NaN"}else if(Number.POSITIVE_INFINITY===e)switch(t){case"lowercase":return".inf";case"uppercase":return".INF";case"camelcase":return".Inf"}else if(Number.NEGATIVE_INFINITY===e)switch(t){case"lowercase":return"-.inf";case"uppercase":return"-.INF";case"camelcase":return"-.Inf"}else if(un.isNegativeZero(e))return"-0.0";return n=e.toString(10),fC.test(n)?n.replace("e",".e"):n}function mC(e){return Object.prototype.toString.call(e)==="[object Number]"&&(e%1!==0||un.isNegativeZero(e))}var pC=new Mn("tag:yaml.org,2002:float",{kind:"scalar",resolve:uC,construct:dC,predicate:mC,represent:hC,defaultStyle:"lowercase"}),gC=Y2.extend({implicit:[K2,tC,lC,pC]}),xC=gC,Am=new RegExp("^([0-9][0-9][0-9][0-9])-([0-9][0-9])-([0-9][0-9])$"),Lm=new RegExp("^([0-9][0-9][0-9][0-9])-([0-9][0-9]?)-([0-9][0-9]?)(?:[Tt]|[ \\t]+)([0-9][0-9]?):([0-9][0-9]):([0-9][0-9])(?:\\.([0-9]*))?(?:[ \\t]*(Z|([-+])([0-9][0-9]?)(?::([0-9][0-9]))?))?$");function yC(e){return e===null?!1:Am.exec(e)!==null||Lm.exec(e)!==null}function vC(e){var t,n,r,s,i,a,l,c=0,d=null,h,u,m;if(t=Am.exec(e),t===null&&(t=Lm.exec(e)),t===null)throw new Error("Date resolve error");if(n=+t[1],r=+t[2]-1,s=+t[3],!t[4])return new Date(Date.UTC(n,r,s));if(i=+t[4],a=+t[5],l=+t[6],t[7]){for(c=t[7].slice(0,3);c.length<3;)c+="0";c=+c}return t[9]&&(h=+t[10],u=+(t[11]||0),d=(h*60+u)*6e4,t[9]==="-"&&(d=-d)),m=new Date(Date.UTC(n,r,s,i,a,l,c)),d&&m.setTime(m.getTime()-d),m}function wC(e){return e.toISOString()}var bC=new Mn("tag:yaml.org,2002:timestamp",{kind:"scalar",resolve:yC,construct:vC,instanceOf:Date,represent:wC});function CC(e){return e==="<<"||e===null}var SC=new Mn("tag:yaml.org,2002:merge",{kind:"scalar",resolve:CC}),tu=`ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=
\r`;function kC(e){if(e===null)return!1;var t,n,r=0,s=e.length,i=tu;for(n=0;n<s;n++)if(t=i.indexOf(e.charAt(n)),!(t>64)){if(t<0)return!1;r+=6}return r%8===0}function IC(e){var t,n,r=e.replace(/[\r\n=]/g,""),s=r.length,i=tu,a=0,l=[];for(t=0;t<s;t++)t%4===0&&t&&(l.push(a>>16&255),l.push(a>>8&255),l.push(a&255)),a=a<<6|i.indexOf(r.charAt(t));return n=s%4*6,n===0?(l.push(a>>16&255),l.push(a>>8&255),l.push(a&255)):n===18?(l.push(a>>10&255),l.push(a>>2&255)):n===12&&l.push(a>>4&255),new Uint8Array(l)}function MC(e){var t="",n=0,r,s,i=e.length,a=tu;for(r=0;r<i;r++)r%3===0&&r&&(t+=a[n>>18&63],t+=a[n>>12&63],t+=a[n>>6&63],t+=a[n&63]),n=(n<<8)+e[r];return s=i%3,s===0?(t+=a[n>>18&63],t+=a[n>>12&63],t+=a[n>>6&63],t+=a[n&63]):s===2?(t+=a[n>>10&63],t+=a[n>>4&63],t+=a[n<<2&63],t+=a[64]):s===1&&(t+=a[n>>2&63],t+=a[n<<4&63],t+=a[64],t+=a[64]),t}function jC(e){return Object.prototype.toString.call(e)==="[object Uint8Array]"}var EC=new Mn("tag:yaml.org,2002:binary",{kind:"scalar",resolve:kC,construct:IC,predicate:jC,represent:MC}),PC=Object.prototype.hasOwnProperty,NC=Object.prototype.toString;function AC(e){if(e===null)return!0;var t=[],n,r,s,i,a,l=e;for(n=0,r=l.length;n<r;n+=1){if(s=l[n],a=!1,NC.call(s)!=="[object Object]")return!1;for(i in s)if(PC.call(s,i))if(!a)a=!0;else return!1;if(!a)return!1;if(t.indexOf(i)===-1)t.push(i);else return!1}return!0}function LC(e){return e!==null?e:[]}var _C=new Mn("tag:yaml.org,2002:omap",{kind:"sequence",resolve:AC,construct:LC}),TC=Object.prototype.toString;function RC(e){if(e===null)return!0;var t,n,r,s,i,a=e;for(i=new Array(a.length),t=0,n=a.length;t<n;t+=1){if(r=a[t],TC.call(r)!=="[object Object]"||(s=Object.keys(r),s.length!==1))return!1;i[t]=[s[0],r[s[0]]]}return!0}function DC(e){if(e===null)return[];var t,n,r,s,i,a=e;for(i=new Array(a.length),t=0,n=a.length;t<n;t+=1)r=a[t],s=Object.keys(r),i[t]=[s[0],r[s[0]]];return i}var FC=new Mn("tag:yaml.org,2002:pairs",{kind:"sequence",resolve:RC,construct:DC}),zC=Object.prototype.hasOwnProperty;function OC(e){if(e===null)return!0;var t,n=e;for(t in n)if(zC.call(n,t)&&n[t]!==null)return!1;return!0}function $C(e){return e!==null?e:{}}var BC=new Mn("tag:yaml.org,2002:set",{kind:"mapping",resolve:OC,construct:$C}),_m=xC.extend({implicit:[bC,SC],explicit:[EC,_C,FC,BC]}),co=Object.prototype.hasOwnProperty,Ma=1,Tm=2,Rm=3,ja=4,kl=1,UC=2,Hd=3,HC=/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F-\x84\x86-\x9F\uFFFE\uFFFF]|[\uD800-\uDBFF](?![\uDC00-\uDFFF])|(?:[^\uD800-\uDBFF]|^)[\uDC00-\uDFFF]/,WC=/[\x85\u2028\u2029]/,VC=/[,\[\]\{\}]/,Dm=/^(?:!|!!|![a-z\-]+!)$/i,Fm=/^(?:!|[^,\[\]\{\}])(?:%[0-9a-f]{2}|[0-9a-z\-#;\/\?:@&=\+\$,_\.!~\*'\(\)\[\]])*$/i;function Wd(e){return Object.prototype.toString.call(e)}function Mr(e){return e===10||e===13}function Po(e){return e===9||e===32}function Zn(e){return e===9||e===32||e===10||e===13}function Qo(e){return e===44||e===91||e===93||e===123||e===125}function ZC(e){var t;return 48<=e&&e<=57?e-48:(t=e|32,97<=t&&t<=102?t-97+10:-1)}function YC(e){return e===120?2:e===117?4:e===85?8:0}function GC(e){return 48<=e&&e<=57?e-48:-1}function Vd(e){return e===48?"\0":e===97?"\x07":e===98?"\b":e===116||e===9?"	":e===110?`
`:e===118?"\v":e===102?"\f":e===114?"\r":e===101?"\x1B":e===32?" ":e===34?'"':e===47?"/":e===92?"\\":e===78?"Â…":e===95?"Â ":e===76?"\u2028":e===80?"\u2029":""}function qC(e){return e<=65535?String.fromCharCode(e):String.fromCharCode((e-65536>>10)+55296,(e-65536&1023)+56320)}function zm(e,t,n){t==="__proto__"?Object.defineProperty(e,t,{configurable:!0,enumerable:!0,writable:!0,value:n}):e[t]=n}var Om=new Array(256),$m=new Array(256);for(var Ho=0;Ho<256;Ho++)Om[Ho]=Vd(Ho)?1:0,$m[Ho]=Vd(Ho);function XC(e,t){this.input=e,this.filename=t.filename||null,this.schema=t.schema||_m,this.onWarning=t.onWarning||null,this.legacy=t.legacy||!1,this.json=t.json||!1,this.listener=t.listener||null,this.implicitTypes=this.schema.compiledImplicit,this.typeMap=this.schema.compiledTypeMap,this.length=e.length,this.position=0,this.line=0,this.lineStart=0,this.lineIndent=0,this.firstTabInLine=-1,this.documents=[]}function Bm(e,t){var n={name:e.filename,buffer:e.input.slice(0,-1),position:e.position,line:e.line,column:e.position-e.lineStart};return n.snippet=F2(n),new Hn(t,n)}function Oe(e,t){throw Bm(e,t)}function Ea(e,t){e.onWarning&&e.onWarning.call(null,Bm(e,t))}var Zd={YAML:function(t,n,r){var s,i,a;t.version!==null&&Oe(t,"duplication of %YAML directive"),r.length!==1&&Oe(t,"YAML directive accepts exactly one argument"),s=/^([0-9]+)\.([0-9]+)$/.exec(r[0]),s===null&&Oe(t,"ill-formed argument of the YAML directive"),i=parseInt(s[1],10),a=parseInt(s[2],10),i!==1&&Oe(t,"unacceptable YAML version of the document"),t.version=r[0],t.checkLineBreaks=a<2,a!==1&&a!==2&&Ea(t,"unsupported YAML version of the document")},TAG:function(t,n,r){var s,i;r.length!==2&&Oe(t,"TAG directive accepts exactly two arguments"),s=r[0],i=r[1],Dm.test(s)||Oe(t,"ill-formed tag handle (first argument) of the TAG directive"),co.call(t.tagMap,s)&&Oe(t,'there is a previously declared suffix for "'+s+'" tag handle'),Fm.test(i)||Oe(t,"ill-formed tag prefix (second argument) of the TAG directive");try{i=decodeURIComponent(i)}catch{Oe(t,"tag prefix is malformed: "+i)}t.tagMap[s]=i}};function io(e,t,n,r){var s,i,a,l;if(t<n){if(l=e.input.slice(t,n),r)for(s=0,i=l.length;s<i;s+=1)a=l.charCodeAt(s),a===9||32<=a&&a<=1114111||Oe(e,"expected valid JSON character");else HC.test(l)&&Oe(e,"the stream contains non-printable characters");e.result+=l}}function Yd(e,t,n,r){var s,i,a,l;for(un.isObject(n)||Oe(e,"cannot merge mappings; the provided source object is unacceptable"),s=Object.keys(n),a=0,l=s.length;a<l;a+=1)i=s[a],co.call(t,i)||(zm(t,i,n[i]),r[i]=!0)}function Jo(e,t,n,r,s,i,a,l,c){var d,h;if(Array.isArray(s))for(s=Array.prototype.slice.call(s),d=0,h=s.length;d<h;d+=1)Array.isArray(s[d])&&Oe(e,"nested arrays are not supported inside keys"),typeof s=="object"&&Wd(s[d])==="[object Object]"&&(s[d]="[object Object]");if(typeof s=="object"&&Wd(s)==="[object Object]"&&(s="[object Object]"),s=String(s),t===null&&(t={}),r==="tag:yaml.org,2002:merge")if(Array.isArray(i))for(d=0,h=i.length;d<h;d+=1)Yd(e,t,i[d],n);else Yd(e,t,i,n);else!e.json&&!co.call(n,s)&&co.call(t,s)&&(e.line=a||e.line,e.lineStart=l||e.lineStart,e.position=c||e.position,Oe(e,"duplicated mapping key")),zm(t,s,i),delete n[s];return t}function nu(e){var t;t=e.input.charCodeAt(e.position),t===10?e.position++:t===13?(e.position++,e.input.charCodeAt(e.position)===10&&e.position++):Oe(e,"a line break is expected"),e.line+=1,e.lineStart=e.position,e.firstTabInLine=-1}function en(e,t,n){for(var r=0,s=e.input.charCodeAt(e.position);s!==0;){for(;Po(s);)s===9&&e.firstTabInLine===-1&&(e.firstTabInLine=e.position),s=e.input.charCodeAt(++e.position);if(t&&s===35)do s=e.input.charCodeAt(++e.position);while(s!==10&&s!==13&&s!==0);if(Mr(s))for(nu(e),s=e.input.charCodeAt(e.position),r++,e.lineIndent=0;s===32;)e.lineIndent++,s=e.input.charCodeAt(++e.position);else break}return n!==-1&&r!==0&&e.lineIndent<n&&Ea(e,"deficient indentation"),r}function Za(e){var t=e.position,n;return n=e.input.charCodeAt(t),!!((n===45||n===46)&&n===e.input.charCodeAt(t+1)&&n===e.input.charCodeAt(t+2)&&(t+=3,n=e.input.charCodeAt(t),n===0||Zn(n)))}function ru(e,t){t===1?e.result+=" ":t>1&&(e.result+=un.repeat(`
`,t-1))}function KC(e,t,n){var r,s,i,a,l,c,d,h,u=e.kind,m=e.result,g;if(g=e.input.charCodeAt(e.position),Zn(g)||Qo(g)||g===35||g===38||g===42||g===33||g===124||g===62||g===39||g===34||g===37||g===64||g===96||(g===63||g===45)&&(s=e.input.charCodeAt(e.position+1),Zn(s)||n&&Qo(s)))return!1;for(e.kind="scalar",e.result="",i=a=e.position,l=!1;g!==0;){if(g===58){if(s=e.input.charCodeAt(e.position+1),Zn(s)||n&&Qo(s))break}else if(g===35){if(r=e.input.charCodeAt(e.position-1),Zn(r))break}else{if(e.position===e.lineStart&&Za(e)||n&&Qo(g))break;if(Mr(g))if(c=e.line,d=e.lineStart,h=e.lineIndent,en(e,!1,-1),e.lineIndent>=t){l=!0,g=e.input.charCodeAt(e.position);continue}else{e.position=a,e.line=c,e.lineStart=d,e.lineIndent=h;break}}l&&(io(e,i,a,!1),ru(e,e.line-c),i=a=e.position,l=!1),Po(g)||(a=e.position+1),g=e.input.charCodeAt(++e.position)}return io(e,i,a,!1),e.result?!0:(e.kind=u,e.result=m,!1)}function QC(e,t){var n,r,s;if(n=e.input.charCodeAt(e.position),n!==39)return!1;for(e.kind="scalar",e.result="",e.position++,r=s=e.position;(n=e.input.charCodeAt(e.position))!==0;)if(n===39)if(io(e,r,e.position,!0),n=e.input.charCodeAt(++e.position),n===39)r=e.position,e.position++,s=e.position;else return!0;else Mr(n)?(io(e,r,s,!0),ru(e,en(e,!1,t)),r=s=e.position):e.position===e.lineStart&&Za(e)?Oe(e,"unexpected end of the document within a single quoted scalar"):(e.position++,s=e.position);Oe(e,"unexpected end of the stream within a single quoted scalar")}function JC(e,t){var n,r,s,i,a,l;if(l=e.input.charCodeAt(e.position),l!==34)return!1;for(e.kind="scalar",e.result="",e.position++,n=r=e.position;(l=e.input.charCodeAt(e.position))!==0;){if(l===34)return io(e,n,e.position,!0),e.position++,!0;if(l===92){if(io(e,n,e.position,!0),l=e.input.charCodeAt(++e.position),Mr(l))en(e,!1,t);else if(l<256&&Om[l])e.result+=$m[l],e.position++;else if((a=YC(l))>0){for(s=a,i=0;s>0;s--)l=e.input.charCodeAt(++e.position),(a=ZC(l))>=0?i=(i<<4)+a:Oe(e,"expected hexadecimal character");e.result+=qC(i),e.position++}else Oe(e,"unknown escape sequence");n=r=e.position}else Mr(l)?(io(e,n,r,!0),ru(e,en(e,!1,t)),n=r=e.position):e.position===e.lineStart&&Za(e)?Oe(e,"unexpected end of the document within a double quoted scalar"):(e.position++,r=e.position)}Oe(e,"unexpected end of the stream within a double quoted scalar")}function eS(e,t){var n=!0,r,s,i,a=e.tag,l,c=e.anchor,d,h,u,m,g,p=Object.create(null),y,w,x,v;if(v=e.input.charCodeAt(e.position),v===91)h=93,g=!1,l=[];else if(v===123)h=125,g=!0,l={};else return!1;for(e.anchor!==null&&(e.anchorMap[e.anchor]=l),v=e.input.charCodeAt(++e.position);v!==0;){if(en(e,!0,t),v=e.input.charCodeAt(e.position),v===h)return e.position++,e.tag=a,e.anchor=c,e.kind=g?"mapping":"sequence",e.result=l,!0;n?v===44&&Oe(e,"expected the node content, but found ','"):Oe(e,"missed comma between flow collection entries"),w=y=x=null,u=m=!1,v===63&&(d=e.input.charCodeAt(e.position+1),Zn(d)&&(u=m=!0,e.position++,en(e,!0,t))),r=e.line,s=e.lineStart,i=e.position,xs(e,t,Ma,!1,!0),w=e.tag,y=e.result,en(e,!0,t),v=e.input.charCodeAt(e.position),(m||e.line===r)&&v===58&&(u=!0,v=e.input.charCodeAt(++e.position),en(e,!0,t),xs(e,t,Ma,!1,!0),x=e.result),g?Jo(e,l,p,w,y,x,r,s,i):u?l.push(Jo(e,null,p,w,y,x,r,s,i)):l.push(y),en(e,!0,t),v=e.input.charCodeAt(e.position),v===44?(n=!0,v=e.input.charCodeAt(++e.position)):n=!1}Oe(e,"unexpected end of the stream within a flow collection")}function tS(e,t){var n,r,s=kl,i=!1,a=!1,l=t,c=0,d=!1,h,u;if(u=e.input.charCodeAt(e.position),u===124)r=!1;else if(u===62)r=!0;else return!1;for(e.kind="scalar",e.result="";u!==0;)if(u=e.input.charCodeAt(++e.position),u===43||u===45)kl===s?s=u===43?Hd:UC:Oe(e,"repeat of a chomping mode identifier");else if((h=GC(u))>=0)h===0?Oe(e,"bad explicit indentation width of a block scalar; it cannot be less than one"):a?Oe(e,"repeat of an indentation width identifier"):(l=t+h-1,a=!0);else break;if(Po(u)){do u=e.input.charCodeAt(++e.position);while(Po(u));if(u===35)do u=e.input.charCodeAt(++e.position);while(!Mr(u)&&u!==0)}for(;u!==0;){for(nu(e),e.lineIndent=0,u=e.input.charCodeAt(e.position);(!a||e.lineIndent<l)&&u===32;)e.lineIndent++,u=e.input.charCodeAt(++e.position);if(!a&&e.lineIndent>l&&(l=e.lineIndent),Mr(u)){c++;continue}if(e.lineIndent<l){s===Hd?e.result+=un.repeat(`
`,i?1+c:c):s===kl&&i&&(e.result+=`
`);break}for(r?Po(u)?(d=!0,e.result+=un.repeat(`
`,i?1+c:c)):d?(d=!1,e.result+=un.repeat(`
`,c+1)):c===0?i&&(e.result+=" "):e.result+=un.repeat(`
`,c):e.result+=un.repeat(`
`,i?1+c:c),i=!0,a=!0,c=0,n=e.position;!Mr(u)&&u!==0;)u=e.input.charCodeAt(++e.position);io(e,n,e.position,!1)}return!0}function Gd(e,t){var n,r=e.tag,s=e.anchor,i=[],a,l=!1,c;if(e.firstTabInLine!==-1)return!1;for(e.anchor!==null&&(e.anchorMap[e.anchor]=i),c=e.input.charCodeAt(e.position);c!==0&&(e.firstTabInLine!==-1&&(e.position=e.firstTabInLine,Oe(e,"tab characters must not be used in indentation")),!(c!==45||(a=e.input.charCodeAt(e.position+1),!Zn(a))));){if(l=!0,e.position++,en(e,!0,-1)&&e.lineIndent<=t){i.push(null),c=e.input.charCodeAt(e.position);continue}if(n=e.line,xs(e,t,Rm,!1,!0),i.push(e.result),en(e,!0,-1),c=e.input.charCodeAt(e.position),(e.line===n||e.lineIndent>t)&&c!==0)Oe(e,"bad indentation of a sequence entry");else if(e.lineIndent<t)break}return l?(e.tag=r,e.anchor=s,e.kind="sequence",e.result=i,!0):!1}function nS(e,t,n){var r,s,i,a,l,c,d=e.tag,h=e.anchor,u={},m=Object.create(null),g=null,p=null,y=null,w=!1,x=!1,v;if(e.firstTabInLine!==-1)return!1;for(e.anchor!==null&&(e.anchorMap[e.anchor]=u),v=e.input.charCodeAt(e.position);v!==0;){if(!w&&e.firstTabInLine!==-1&&(e.position=e.firstTabInLine,Oe(e,"tab characters must not be used in indentation")),r=e.input.charCodeAt(e.position+1),i=e.line,(v===63||v===58)&&Zn(r))v===63?(w&&(Jo(e,u,m,g,p,null,a,l,c),g=p=y=null),x=!0,w=!0,s=!0):w?(w=!1,s=!0):Oe(e,"incomplete explicit mapping pair; a key node is missed; or followed by a non-tabulated empty line"),e.position+=1,v=r;else{if(a=e.line,l=e.lineStart,c=e.position,!xs(e,n,Tm,!1,!0))break;if(e.line===i){for(v=e.input.charCodeAt(e.position);Po(v);)v=e.input.charCodeAt(++e.position);if(v===58)v=e.input.charCodeAt(++e.position),Zn(v)||Oe(e,"a whitespace character is expected after the key-value separator within a block mapping"),w&&(Jo(e,u,m,g,p,null,a,l,c),g=p=y=null),x=!0,w=!1,s=!1,g=e.tag,p=e.result;else if(x)Oe(e,"can not read an implicit mapping pair; a colon is missed");else return e.tag=d,e.anchor=h,!0}else if(x)Oe(e,"can not read a block mapping entry; a multiline key may not be an implicit key");else return e.tag=d,e.anchor=h,!0}if((e.line===i||e.lineIndent>t)&&(w&&(a=e.line,l=e.lineStart,c=e.position),xs(e,t,ja,!0,s)&&(w?p=e.result:y=e.result),w||(Jo(e,u,m,g,p,y,a,l,c),g=p=y=null),en(e,!0,-1),v=e.input.charCodeAt(e.position)),(e.line===i||e.lineIndent>t)&&v!==0)Oe(e,"bad indentation of a mapping entry");else if(e.lineIndent<t)break}return w&&Jo(e,u,m,g,p,null,a,l,c),x&&(e.tag=d,e.anchor=h,e.kind="mapping",e.result=u),x}function rS(e){var t,n=!1,r=!1,s,i,a;if(a=e.input.charCodeAt(e.position),a!==33)return!1;if(e.tag!==null&&Oe(e,"duplication of a tag property"),a=e.input.charCodeAt(++e.position),a===60?(n=!0,a=e.input.charCodeAt(++e.position)):a===33?(r=!0,s="!!",a=e.input.charCodeAt(++e.position)):s="!",t=e.position,n){do a=e.input.charCodeAt(++e.position);while(a!==0&&a!==62);e.position<e.length?(i=e.input.slice(t,e.position),a=e.input.charCodeAt(++e.position)):Oe(e,"unexpected end of the stream within a verbatim tag")}else{for(;a!==0&&!Zn(a);)a===33&&(r?Oe(e,"tag suffix cannot contain exclamation marks"):(s=e.input.slice(t-1,e.position+1),Dm.test(s)||Oe(e,"named tag handle cannot contain such characters"),r=!0,t=e.position+1)),a=e.input.charCodeAt(++e.position);i=e.input.slice(t,e.position),VC.test(i)&&Oe(e,"tag suffix cannot contain flow indicator characters")}i&&!Fm.test(i)&&Oe(e,"tag name cannot contain such characters: "+i);try{i=decodeURIComponent(i)}catch{Oe(e,"tag name is malformed: "+i)}return n?e.tag=i:co.call(e.tagMap,s)?e.tag=e.tagMap[s]+i:s==="!"?e.tag="!"+i:s==="!!"?e.tag="tag:yaml.org,2002:"+i:Oe(e,'undeclared tag handle "'+s+'"'),!0}function oS(e){var t,n;if(n=e.input.charCodeAt(e.position),n!==38)return!1;for(e.anchor!==null&&Oe(e,"duplication of an anchor property"),n=e.input.charCodeAt(++e.position),t=e.position;n!==0&&!Zn(n)&&!Qo(n);)n=e.input.charCodeAt(++e.position);return e.position===t&&Oe(e,"name of an anchor node must contain at least one character"),e.anchor=e.input.slice(t,e.position),!0}function sS(e){var t,n,r;if(r=e.input.charCodeAt(e.position),r!==42)return!1;for(r=e.input.charCodeAt(++e.position),t=e.position;r!==0&&!Zn(r)&&!Qo(r);)r=e.input.charCodeAt(++e.position);return e.position===t&&Oe(e,"name of an alias node must contain at least one character"),n=e.input.slice(t,e.position),co.call(e.anchorMap,n)||Oe(e,'unidentified alias "'+n+'"'),e.result=e.anchorMap[n],en(e,!0,-1),!0}function xs(e,t,n,r,s){var i,a,l,c=1,d=!1,h=!1,u,m,g,p,y,w;if(e.listener!==null&&e.listener("open",e),e.tag=null,e.anchor=null,e.kind=null,e.result=null,i=a=l=ja===n||Rm===n,r&&en(e,!0,-1)&&(d=!0,e.lineIndent>t?c=1:e.lineIndent===t?c=0:e.lineIndent<t&&(c=-1)),c===1)for(;rS(e)||oS(e);)en(e,!0,-1)?(d=!0,l=i,e.lineIndent>t?c=1:e.lineIndent===t?c=0:e.lineIndent<t&&(c=-1)):l=!1;if(l&&(l=d||s),(c===1||ja===n)&&(Ma===n||Tm===n?y=t:y=t+1,w=e.position-e.lineStart,c===1?l&&(Gd(e,w)||nS(e,w,y))||eS(e,y)?h=!0:(a&&tS(e,y)||QC(e,y)||JC(e,y)?h=!0:sS(e)?(h=!0,(e.tag!==null||e.anchor!==null)&&Oe(e,"alias node should not have any properties")):KC(e,y,Ma===n)&&(h=!0,e.tag===null&&(e.tag="?")),e.anchor!==null&&(e.anchorMap[e.anchor]=e.result)):c===0&&(h=l&&Gd(e,w))),e.tag===null)e.anchor!==null&&(e.anchorMap[e.anchor]=e.result);else if(e.tag==="?"){for(e.result!==null&&e.kind!=="scalar"&&Oe(e,'unacceptable node kind for !<?> tag; it should be "scalar", not "'+e.kind+'"'),u=0,m=e.implicitTypes.length;u<m;u+=1)if(p=e.implicitTypes[u],p.resolve(e.result)){e.result=p.construct(e.result),e.tag=p.tag,e.anchor!==null&&(e.anchorMap[e.anchor]=e.result);break}}else if(e.tag!=="!"){if(co.call(e.typeMap[e.kind||"fallback"],e.tag))p=e.typeMap[e.kind||"fallback"][e.tag];else for(p=null,g=e.typeMap.multi[e.kind||"fallback"],u=0,m=g.length;u<m;u+=1)if(e.tag.slice(0,g[u].tag.length)===g[u].tag){p=g[u];break}p||Oe(e,"unknown tag !<"+e.tag+">"),e.result!==null&&p.kind!==e.kind&&Oe(e,"unacceptable node kind for !<"+e.tag+'> tag; it should be "'+p.kind+'", not "'+e.kind+'"'),p.resolve(e.result,e.tag)?(e.result=p.construct(e.result,e.tag),e.anchor!==null&&(e.anchorMap[e.anchor]=e.result)):Oe(e,"cannot resolve a node with !<"+e.tag+"> explicit tag")}return e.listener!==null&&e.listener("close",e),e.tag!==null||e.anchor!==null||h}function iS(e){var t=e.position,n,r,s,i=!1,a;for(e.version=null,e.checkLineBreaks=e.legacy,e.tagMap=Object.create(null),e.anchorMap=Object.create(null);(a=e.input.charCodeAt(e.position))!==0&&(en(e,!0,-1),a=e.input.charCodeAt(e.position),!(e.lineIndent>0||a!==37));){for(i=!0,a=e.input.charCodeAt(++e.position),n=e.position;a!==0&&!Zn(a);)a=e.input.charCodeAt(++e.position);for(r=e.input.slice(n,e.position),s=[],r.length<1&&Oe(e,"directive name must not be less than one character in length");a!==0;){for(;Po(a);)a=e.input.charCodeAt(++e.position);if(a===35){do a=e.input.charCodeAt(++e.position);while(a!==0&&!Mr(a));break}if(Mr(a))break;for(n=e.position;a!==0&&!Zn(a);)a=e.input.charCodeAt(++e.position);s.push(e.input.slice(n,e.position))}a!==0&&nu(e),co.call(Zd,r)?Zd[r](e,r,s):Ea(e,'unknown document directive "'+r+'"')}if(en(e,!0,-1),e.lineIndent===0&&e.input.charCodeAt(e.position)===45&&e.input.charCodeAt(e.position+1)===45&&e.input.charCodeAt(e.position+2)===45?(e.position+=3,en(e,!0,-1)):i&&Oe(e,"directives end mark is expected"),xs(e,e.lineIndent-1,ja,!1,!0),en(e,!0,-1),e.checkLineBreaks&&WC.test(e.input.slice(t,e.position))&&Ea(e,"non-ASCII line breaks are interpreted as content"),e.documents.push(e.result),e.position===e.lineStart&&Za(e)){e.input.charCodeAt(e.position)===46&&(e.position+=3,en(e,!0,-1));return}if(e.position<e.length-1)Oe(e,"end of the stream or a document separator is expected");else return}function aS(e,t){e=String(e),t=t||{},e.length!==0&&(e.charCodeAt(e.length-1)!==10&&e.charCodeAt(e.length-1)!==13&&(e+=`
`),e.charCodeAt(0)===65279&&(e=e.slice(1)));var n=new XC(e,t),r=e.indexOf("\0");for(r!==-1&&(n.position=r,Oe(n,"null byte is not allowed in input")),n.input+="\0";n.input.charCodeAt(n.position)===32;)n.lineIndent+=1,n.position+=1;for(;n.position<n.length-1;)iS(n);return n.documents}function lS(e,t){var n=aS(e,t);if(n.length!==0){if(n.length===1)return n[0];throw new Hn("expected a single document in the stream, but found more")}}var cS=lS,uS={load:cS},Um=Object.prototype.toString,Hm=Object.prototype.hasOwnProperty,ou=65279,dS=9,ri=10,fS=13,hS=32,mS=33,pS=34,lc=35,gS=37,xS=38,yS=39,vS=42,Wm=44,wS=45,Pa=58,bS=61,CS=62,SS=63,kS=64,Vm=91,Zm=93,IS=96,Ym=123,MS=124,Gm=125,jn={};jn[0]="\\0";jn[7]="\\a";jn[8]="\\b";jn[9]="\\t";jn[10]="\\n";jn[11]="\\v";jn[12]="\\f";jn[13]="\\r";jn[27]="\\e";jn[34]='\\"';jn[92]="\\\\";jn[133]="\\N";jn[160]="\\_";jn[8232]="\\L";jn[8233]="\\P";var jS=["y","Y","yes","Yes","YES","on","On","ON","n","N","no","No","NO","off","Off","OFF"],ES=/^[-+]?[0-9_]+(?::[0-9_]+)+(?:\.[0-9_]*)?$/;function PS(e,t){var n,r,s,i,a,l,c;if(t===null)return{};for(n={},r=Object.keys(t),s=0,i=r.length;s<i;s+=1)a=r[s],l=String(t[a]),a.slice(0,2)==="!!"&&(a="tag:yaml.org,2002:"+a.slice(2)),c=e.compiledTypeMap.fallback[a],c&&Hm.call(c.styleAliases,l)&&(l=c.styleAliases[l]),n[a]=l;return n}function NS(e){var t,n,r;if(t=e.toString(16).toUpperCase(),e<=255)n="x",r=2;else if(e<=65535)n="u",r=4;else if(e<=4294967295)n="U",r=8;else throw new Hn("code point within a string may not be greater than 0xFFFFFFFF");return"\\"+n+un.repeat("0",r-t.length)+t}var AS=1,oi=2;function LS(e){this.schema=e.schema||_m,this.indent=Math.max(1,e.indent||2),this.noArrayIndent=e.noArrayIndent||!1,this.skipInvalid=e.skipInvalid||!1,this.flowLevel=un.isNothing(e.flowLevel)?-1:e.flowLevel,this.styleMap=PS(this.schema,e.styles||null),this.sortKeys=e.sortKeys||!1,this.lineWidth=e.lineWidth||80,this.noRefs=e.noRefs||!1,this.noCompatMode=e.noCompatMode||!1,this.condenseFlow=e.condenseFlow||!1,this.quotingType=e.quotingType==='"'?oi:AS,this.forceQuotes=e.forceQuotes||!1,this.replacer=typeof e.replacer=="function"?e.replacer:null,this.implicitTypes=this.schema.compiledImplicit,this.explicitTypes=this.schema.compiledExplicit,this.tag=null,this.result="",this.duplicates=[],this.usedDuplicates=null}function qd(e,t){for(var n=un.repeat(" ",t),r=0,s=-1,i="",a,l=e.length;r<l;)s=e.indexOf(`
`,r),s===-1?(a=e.slice(r),r=l):(a=e.slice(r,s+1),r=s+1),a.length&&a!==`
`&&(i+=n),i+=a;return i}function cc(e,t){return`
`+un.repeat(" ",e.indent*t)}function _S(e,t){var n,r,s;for(n=0,r=e.implicitTypes.length;n<r;n+=1)if(s=e.implicitTypes[n],s.resolve(t))return!0;return!1}function Na(e){return e===hS||e===dS}function si(e){return 32<=e&&e<=126||161<=e&&e<=55295&&e!==8232&&e!==8233||57344<=e&&e<=65533&&e!==ou||65536<=e&&e<=1114111}function Xd(e){return si(e)&&e!==ou&&e!==fS&&e!==ri}function Kd(e,t,n){var r=Xd(e),s=r&&!Na(e);return(n?r:r&&e!==Wm&&e!==Vm&&e!==Zm&&e!==Ym&&e!==Gm)&&e!==lc&&!(t===Pa&&!s)||Xd(t)&&!Na(t)&&e===lc||t===Pa&&s}function TS(e){return si(e)&&e!==ou&&!Na(e)&&e!==wS&&e!==SS&&e!==Pa&&e!==Wm&&e!==Vm&&e!==Zm&&e!==Ym&&e!==Gm&&e!==lc&&e!==xS&&e!==vS&&e!==mS&&e!==MS&&e!==bS&&e!==CS&&e!==yS&&e!==pS&&e!==gS&&e!==kS&&e!==IS}function RS(e){return!Na(e)&&e!==Pa}function zs(e,t){var n=e.charCodeAt(t),r;return n>=55296&&n<=56319&&t+1<e.length&&(r=e.charCodeAt(t+1),r>=56320&&r<=57343)?(n-55296)*1024+r-56320+65536:n}function qm(e){var t=/^\n* /;return t.test(e)}var Xm=1,uc=2,Km=3,Qm=4,Go=5;function DS(e,t,n,r,s,i,a,l){var c,d=0,h=null,u=!1,m=!1,g=r!==-1,p=-1,y=TS(zs(e,0))&&RS(zs(e,e.length-1));if(t||a)for(c=0;c<e.length;d>=65536?c+=2:c++){if(d=zs(e,c),!si(d))return Go;y=y&&Kd(d,h,l),h=d}else{for(c=0;c<e.length;d>=65536?c+=2:c++){if(d=zs(e,c),d===ri)u=!0,g&&(m=m||c-p-1>r&&e[p+1]!==" ",p=c);else if(!si(d))return Go;y=y&&Kd(d,h,l),h=d}m=m||g&&c-p-1>r&&e[p+1]!==" "}return!u&&!m?y&&!a&&!s(e)?Xm:i===oi?Go:uc:n>9&&qm(e)?Go:a?i===oi?Go:uc:m?Qm:Km}function FS(e,t,n,r,s){e.dump=(function(){if(t.length===0)return e.quotingType===oi?'""':"''";if(!e.noCompatMode&&(jS.indexOf(t)!==-1||ES.test(t)))return e.quotingType===oi?'"'+t+'"':"'"+t+"'";var i=e.indent*Math.max(1,n),a=e.lineWidth===-1?-1:Math.max(Math.min(e.lineWidth,40),e.lineWidth-i),l=r||e.flowLevel>-1&&n>=e.flowLevel;function c(d){return _S(e,d)}switch(DS(t,l,e.indent,a,c,e.quotingType,e.forceQuotes&&!r,s)){case Xm:return t;case uc:return"'"+t.replace(/'/g,"''")+"'";case Km:return"|"+Qd(t,e.indent)+Jd(qd(t,i));case Qm:return">"+Qd(t,e.indent)+Jd(qd(zS(t,a),i));case Go:return'"'+OS(t)+'"';default:throw new Hn("impossible error: invalid scalar style")}})()}function Qd(e,t){var n=qm(e)?String(t):"",r=e[e.length-1]===`
`,s=r&&(e[e.length-2]===`
`||e===`
`),i=s?"+":r?"":"-";return n+i+`
`}function Jd(e){return e[e.length-1]===`
`?e.slice(0,-1):e}function zS(e,t){for(var n=/(\n+)([^\n]*)/g,r=(function(){var d=e.indexOf(`
`);return d=d!==-1?d:e.length,n.lastIndex=d,ef(e.slice(0,d),t)})(),s=e[0]===`
`||e[0]===" ",i,a;a=n.exec(e);){var l=a[1],c=a[2];i=c[0]===" ",r+=l+(!s&&!i&&c!==""?`
`:"")+ef(c,t),s=i}return r}function ef(e,t){if(e===""||e[0]===" ")return e;for(var n=/ [^ ]/g,r,s=0,i,a=0,l=0,c="";r=n.exec(e);)l=r.index,l-s>t&&(i=a>s?a:l,c+=`
`+e.slice(s,i),s=i+1),a=l;return c+=`
`,e.length-s>t&&a>s?c+=e.slice(s,a)+`
`+e.slice(a+1):c+=e.slice(s),c.slice(1)}function OS(e){for(var t="",n=0,r,s=0;s<e.length;n>=65536?s+=2:s++)n=zs(e,s),r=jn[n],!r&&si(n)?(t+=e[s],n>=65536&&(t+=e[s+1])):t+=r||NS(n);return t}function $S(e,t,n){var r="",s=e.tag,i,a,l;for(i=0,a=n.length;i<a;i+=1)l=n[i],e.replacer&&(l=e.replacer.call(n,String(i),l)),(Yr(e,t,l,!1,!1)||typeof l>"u"&&Yr(e,t,null,!1,!1))&&(r!==""&&(r+=","+(e.condenseFlow?"":" ")),r+=e.dump);e.tag=s,e.dump="["+r+"]"}function tf(e,t,n,r){var s="",i=e.tag,a,l,c;for(a=0,l=n.length;a<l;a+=1)c=n[a],e.replacer&&(c=e.replacer.call(n,String(a),c)),(Yr(e,t+1,c,!0,!0,!1,!0)||typeof c>"u"&&Yr(e,t+1,null,!0,!0,!1,!0))&&((!r||s!=="")&&(s+=cc(e,t)),e.dump&&ri===e.dump.charCodeAt(0)?s+="-":s+="- ",s+=e.dump);e.tag=i,e.dump=s||"[]"}function BS(e,t,n){var r="",s=e.tag,i=Object.keys(n),a,l,c,d,h;for(a=0,l=i.length;a<l;a+=1)h="",r!==""&&(h+=", "),e.condenseFlow&&(h+='"'),c=i[a],d=n[c],e.replacer&&(d=e.replacer.call(n,c,d)),Yr(e,t,c,!1,!1)&&(e.dump.length>1024&&(h+="? "),h+=e.dump+(e.condenseFlow?'"':"")+":"+(e.condenseFlow?"":" "),Yr(e,t,d,!1,!1)&&(h+=e.dump,r+=h));e.tag=s,e.dump="{"+r+"}"}function US(e,t,n,r){var s="",i=e.tag,a=Object.keys(n),l,c,d,h,u,m;if(e.sortKeys===!0)a.sort();else if(typeof e.sortKeys=="function")a.sort(e.sortKeys);else if(e.sortKeys)throw new Hn("sortKeys must be a boolean or a function");for(l=0,c=a.length;l<c;l+=1)m="",(!r||s!=="")&&(m+=cc(e,t)),d=a[l],h=n[d],e.replacer&&(h=e.replacer.call(n,d,h)),Yr(e,t+1,d,!0,!0,!0)&&(u=e.tag!==null&&e.tag!=="?"||e.dump&&e.dump.length>1024,u&&(e.dump&&ri===e.dump.charCodeAt(0)?m+="?":m+="? "),m+=e.dump,u&&(m+=cc(e,t)),Yr(e,t+1,h,!0,u)&&(e.dump&&ri===e.dump.charCodeAt(0)?m+=":":m+=": ",m+=e.dump,s+=m));e.tag=i,e.dump=s||"{}"}function nf(e,t,n){var r,s,i,a,l,c;for(s=n?e.explicitTypes:e.implicitTypes,i=0,a=s.length;i<a;i+=1)if(l=s[i],(l.instanceOf||l.predicate)&&(!l.instanceOf||typeof t=="object"&&t instanceof l.instanceOf)&&(!l.predicate||l.predicate(t))){if(n?l.multi&&l.representName?e.tag=l.representName(t):e.tag=l.tag:e.tag="?",l.represent){if(c=e.styleMap[l.tag]||l.defaultStyle,Um.call(l.represent)==="[object Function]")r=l.represent(t,c);else if(Hm.call(l.represent,c))r=l.represent[c](t,c);else throw new Hn("!<"+l.tag+'> tag resolver accepts not "'+c+'" style');e.dump=r}return!0}return!1}function Yr(e,t,n,r,s,i,a){e.tag=null,e.dump=n,nf(e,n,!1)||nf(e,n,!0);var l=Um.call(e.dump),c=r,d;r&&(r=e.flowLevel<0||e.flowLevel>t);var h=l==="[object Object]"||l==="[object Array]",u,m;if(h&&(u=e.duplicates.indexOf(n),m=u!==-1),(e.tag!==null&&e.tag!=="?"||m||e.indent!==2&&t>0)&&(s=!1),m&&e.usedDuplicates[u])e.dump="*ref_"+u;else{if(h&&m&&!e.usedDuplicates[u]&&(e.usedDuplicates[u]=!0),l==="[object Object]")r&&Object.keys(e.dump).length!==0?(US(e,t,e.dump,s),m&&(e.dump="&ref_"+u+e.dump)):(BS(e,t,e.dump),m&&(e.dump="&ref_"+u+" "+e.dump));else if(l==="[object Array]")r&&e.dump.length!==0?(e.noArrayIndent&&!a&&t>0?tf(e,t-1,e.dump,s):tf(e,t,e.dump,s),m&&(e.dump="&ref_"+u+e.dump)):($S(e,t,e.dump),m&&(e.dump="&ref_"+u+" "+e.dump));else if(l==="[object String]")e.tag!=="?"&&FS(e,e.dump,t,i,c);else{if(l==="[object Undefined]")return!1;if(e.skipInvalid)return!1;throw new Hn("unacceptable kind of an object to dump "+l)}e.tag!==null&&e.tag!=="?"&&(d=encodeURI(e.tag[0]==="!"?e.tag.slice(1):e.tag).replace(/!/g,"%21"),e.tag[0]==="!"?d="!"+d:d.slice(0,18)==="tag:yaml.org,2002:"?d="!!"+d.slice(18):d="!<"+d+">",e.dump=d+" "+e.dump)}return!0}function HS(e,t){var n=[],r=[],s,i;for(dc(e,n,r),s=0,i=r.length;s<i;s+=1)t.duplicates.push(n[r[s]]);t.usedDuplicates=new Array(i)}function dc(e,t,n){var r,s,i;if(e!==null&&typeof e=="object")if(s=t.indexOf(e),s!==-1)n.indexOf(s)===-1&&n.push(s);else if(t.push(e),Array.isArray(e))for(s=0,i=e.length;s<i;s+=1)dc(e[s],t,n);else for(r=Object.keys(e),s=0,i=r.length;s<i;s+=1)dc(e[r[s]],t,n)}function WS(e,t){t=t||{};var n=new LS(t);n.noRefs||HS(e,n);var r=e;return n.replacer&&(r=n.replacer.call({"":r},"",r)),Yr(n,0,r,!0,!0)?n.dump+`
`:""}var VS=WS,ZS={dump:VS},YS=uS.load,GS=ZS.dump;function qS(e){return e.replace(/[A-Z]/g,t=>`_${t.toLowerCase()}`)}function XS(e){return e.replace(/_([a-z])/g,(t,n)=>n.toUpperCase())}function fc(e){if(e==null)return null;if(Array.isArray(e))return e.map(fc);if(typeof e=="object"){const t={};for(const[n,r]of Object.entries(e))t[qS(n)]=fc(r);return t}return typeof e=="string"||typeof e=="number"||typeof e=="boolean"?e:null}function hc(e){if(e==null)return null;if(Array.isArray(e))return e.map(hc);if(typeof e=="object"){const t={};for(const[n,r]of Object.entries(e))t[XS(n)]=hc(r);return t}return e}function Jm(e){try{const t=YS(e);if(t==null)return{valid:!1,errors:[{path:"",message:"Empty configuration file"}],config:null};if(typeof t!="object")return{valid:!1,errors:[{path:"",message:"Configuration must be an object"}],config:null};const n=hc(t);return k2(n)}catch(t){return{valid:!1,errors:[{path:"",message:`YAML parse error: ${t instanceof Error?t.message:"Unknown YAML parse error"}`}],config:null}}}function KS(e){const t=fc(e);return GS(t,{indent:2,lineWidth:120,noRefs:!0,sortKeys:!1,quotingType:'"'})}const QS={usePointCloudStore:Vt,useCameraStore:ce,useUIStore:G,useExportStore:rt,useRigStore:Bn};function ep(e){return QS[e].getState()}function JS(e,t){return e.type==="number"&&e.nullable&&t===1/0?null:t}function ek(e,t){return e.type==="number"&&e.nullable&&t===null?1/0:t}function tk(e){return`set${e.charAt(0).toUpperCase()}${e.slice(1)}`}function tp(){const e={version:Vc};for(const t of gi){const n=ep(t.storeHook),r={};for(const s of xi(t)){const i=Zc(s);r[s.key]=JS(s,n[i])}e[t.key]=r}return e}function su(e){for(const t of gi){const n=e[t.key];if(!n)continue;const r=ep(t.storeHook);for(const s of xi(t)){const i=n[s.key];if(i===void 0)continue;const a=Zc(s),l=r[tk(a)];l&&l(ek(s,i))}}}function Ms(){const{setReconstruction:e,setWasmReconstruction:t,setLoadedFiles:n,setDroppedFiles:r,setError:s,setSourceInfo:i,setUrlLoading:a,setUrlProgress:l}=me(),c=G(x=>x.resetView),d=f.useCallback(async(x,v,k)=>{const b=v?`${v}/${x.name}`:x.name;try{if(x.isFile){const S=await new Promise((C,M)=>{x.file(C,M)});k.set(b,S)}else if(x.isDirectory){const S=x.createReader();let C=[],M;do M=await new Promise((L,P)=>{S.readEntries(L,P)}),C=C.concat(M);while(M.length>0);const I=50;for(let L=0;L<C.length;L+=I){const P=C.slice(L,L+I);await Promise.all(P.map(_=>d(_,b,k)))}}}catch(S){console.warn(`Failed to scan entry: ${b}`,S)}},[]),h=f.useCallback(x=>{const v=C=>{const M=C.lastIndexOf("/");return M>=0?C.substring(0,M):""},k=new Map;for(const[C,M]of x){const I=M.name.toLowerCase(),L=v(C);k.has(L)||k.set(L,{});const P=k.get(L);I==="cameras.bin"||I==="cameras.txt"&&!P.cameras?.name.endsWith(".bin")?P.cameras=M:I==="images.bin"||I==="images.txt"&&!P.images?.name.endsWith(".bin")?P.images=M:I==="points3d.bin"||I==="points3d.txt"&&!P.points3D?.name.endsWith(".bin")?P.points3D=M:I==="database.db"||I==="colmap.db"?P.database=M:I==="rigs.bin"||I==="rigs.txt"&&!P.rigs?.name.endsWith(".bin")?P.rigs=M:(I==="frames.bin"||I==="frames.txt"&&!P.frames?.name.endsWith(".bin"))&&(P.frames=M)}const b=[];for(const[C,M]of k)M.cameras&&M.images&&M.points3D&&b.push({dir:C,files:M});if(b.length===0)return{};b.sort((C,M)=>{const I=L=>{const P=L.toLowerCase();return P.endsWith("/sparse/0")||P==="sparse/0"?0:P.endsWith("/sparse")||P==="sparse"?1:P.includes("/sparse/")?2:P.includes("/sparse")?3:4+L.length};return I(C.dir)-I(M.dir)});const S=b[0].files;return{camerasFile:S.cameras,imagesFile:S.images,points3DFile:S.points3D,databaseFile:S.database,rigsFile:S.rigs,framesFile:S.frames}},[]),u=f.useCallback(async(x,v)=>{const k=v?.start??0,b=v?.end??100,S=I=>Math.round(k+I/100*(b-k));me.getState().urlLoading||(a(!0),l({percent:S(0),message:"Starting..."}));const M=Py(x);if(M){try{const I=await M.text(),L=Jm(I);if(L.valid&&L.config)su(L.config),console.log(`[Config] Applied settings from ${M.name}`);else{const P=L.errors.map(_=>_.path?`${_.path}: ${_.message}`:_.message).join(", ");console.error(`[Config] Invalid configuration: ${P}`),s(`Config error: ${P}`)}}catch(I){const L=I instanceof Error?I.message:"Unknown error";console.error("[Config] Failed to load config file:",I),s(`Config error: ${L}`)}if(!Ny(x)&&!wd(x)){a(!1);return}}try{r(x);const{camerasFile:I,imagesFile:L,points3DFile:P,databaseFile:_,rigsFile:N,framesFile:D}=h(x);l({percent:S(5),message:"Scanning image files..."});const B=py(x),E=my(x);if(!I||!L||!P){if(wd(x)){console.log(`[Images-only] Creating gallery from ${B.size} image lookup keys`),l({percent:S(50),message:"Creating image gallery..."});const ye=Ay(B);n({camerasFile:void 0,imagesFile:void 0,points3DFile:void 0,databaseFile:void 0,rigsFile:void 0,framesFile:void 0,imageFiles:B,hasMasks:E}),Cr({preserveZip:!0}),l({percent:S(95),message:"Finalizing..."}),e(ye),c(),Ft.getState().addNotification("info",`Loaded ${ye.images.size} images (gallery only, no 3D data)`,5e3),console.log(`[Images-only] Loaded ${ye.images.size} images for gallery viewing`);return}throw new Error("Missing required COLMAP files. Expected cameras.bin/txt, images.bin/txt, and points3D.bin/txt")}console.log(`Scanned ${x.size} total files, ${B.size} image lookup keys`),n({camerasFile:I,imagesFile:L,points3DFile:P,databaseFile:_,rigsFile:N,framesFile:D,imageFiles:B,hasMasks:E}),l({percent:S(10),message:"Parsing COLMAP files..."});let Z,F,$,T,z=null,H=!1;console.log("[Parser] Attempting WASM parser (memory-optimized)...");const O=await kx(I,L,P,N,D);if(O)Z=O.cameras,F=O.images,T=O.rigData,z=O.wasmWrapper,H=!0,Ft.getState().addNotification("info",`Loaded ${z.pointCount.toLocaleString()} points`,5e3);else{console.log("[Parser] WASM failed, falling back to JS parser (without 2D points)");const ye=L.name.endsWith(".bin");[Z,F,$]=await Promise.all([I.name.endsWith(".bin")?I.arrayBuffer().then(ax):I.text().then(lx),L.name.endsWith(".bin")?L.arrayBuffer().then(Pe=>cx(Pe,!0)):L.text().then(ux),P.name.endsWith(".bin")?P.arrayBuffer().then(dx):P.text().then(fx)]),ye&&Ft.getState().addNotification("info","2D point data not loaded. Keypoint overlay may be limited.",5e3)}l({percent:S(35),message:"Computing statistics..."});const{imageStats:J,connectedImagesIndex:re,globalStats:q,imageToPoint3DIds:ie}=H&&z?vx(F,z):yx(F,$);l({percent:S(40),message:"Processing rig data..."});let we=T;if(!we&&N&&D)try{const[ye,Pe]=await Promise.all([N.name.endsWith(".bin")?N.arrayBuffer().then(mx):N.text().then(px),D.name.endsWith(".bin")?D.arrayBuffer().then(gx):D.text().then(xx)]);we={rigs:ye,frames:Pe},console.log(`Loaded rig data: ${ye.size} rigs, ${Pe.size} frames`)}catch(ye){console.warn("Failed to parse rig/frame files:",ye)}const Ce={cameras:Z,images:F,...$&&{points3D:$},imageStats:J,connectedImagesIndex:re,globalStats:q,imageToPoint3DIds:ie,rigData:we};Cr({preserveZip:!0}),await new Promise(ye=>setTimeout(ye,200)),l({percent:S(95),message:"Finalizing..."}),z&&t(z),e(Ce),c();const Re=z?.pointCount??$?.size??0;console.log(`Loaded: ${Z.size} cameras, ${F.size} images, ${Re.toLocaleString()} points`);const ee=Vt.getState().minTrackLength;if(ee>=2&&Re>0){let ye=0;if(z){const Pe=z.getTrackLengths();if(Pe)for(let Ye=0;Ye<Pe.length;Ye++)Pe[Ye]<ee&&ye++}else if($)for(const Pe of $.values())Pe.track.length<ee&&ye++;if(ye>0){const Pe=(ye/Re*100).toFixed(1);Ft.getState().addNotification("warning",`${ye.toLocaleString()} points (${Pe}%) hidden due to min track length filter (${ee}). Adjust in Point Cloud settings.`)}}const{missingImages:he,totalImages:Se,totalFiles:xe}=vy(F,B);if(he.length>0){console.warn(`âš ï¸ ${he.length}/${Se} images could not find their files (${xe} image files in lookup map)`);const ye=Math.min(10,he.length);console.warn("First missing images:",he.slice(0,ye).map(Pe=>`ID ${Pe.imageId}: "${Pe.name}"`)),he.length>ye&&console.warn(`... and ${he.length-ye} more`)}const Ae=j0();Ae>0&&(console.warn(`âš ï¸ ${Ae} images failed to decode (createImageBitmap error). These images may be corrupted or use unsupported encoding.`),console.warn("To fix: Re-export these images from your image editing software, or convert them using a tool like ImageMagick."))}catch(I){console.error("Error processing files:",I),s(I instanceof Error?I.message:"Unknown error")}finally{a(!1)}},[e,t,n,r,s,i,a,l,h,c]),m=f.useCallback(async x=>{if(me.getState().urlLoading){console.log("[ZIP Loader] Already loading, ignoring duplicate request");return}a(!0),l({percent:0,message:"Opening ZIP archive..."}),await new Promise(k=>setTimeout(k,0));try{Cr(),console.log(`[ZIP Loader] Processing local ZIP file: ${x.name}`);const{colmapFiles:k,imageIndex:b,archive:S,fileSize:C,imageCount:M}=await ly(x,I=>{l({percent:Math.round(I.percent*.1),message:"Extracting ZIP archive..."})});$h(S,b,C,M),i("zip",null),console.log(`[ZIP Loader] ZIP contains ${k.size} COLMAP files, ${M} indexed images`),await u(k),console.log("[ZIP Loader] Successfully loaded reconstruction from local ZIP")}catch(k){console.error("[ZIP Loader] Error processing ZIP file:",k),Cr(),s(k instanceof Error?k.message:"Failed to process ZIP file"),a(!1)}},[u,a,l,s,i]),g=f.useCallback(async x=>{if(x.preventDefault(),x.stopPropagation(),me.getState().urlLoading){console.log("[File Dropzone] Ignoring drop during active loading");return}if(!x.dataTransfer?.types.includes("Files"))return;const k=x.dataTransfer?.items;if(!k)return;if(x.dataTransfer.files.length===1){const C=x.dataTransfer.files[0];if(ey(C)){console.log(`[Drop] Detected ZIP file: ${C.name}`),await m(C);return}}const b=[];for(let C=0;C<k.length;C++){const M=k[C];if(M.kind!=="file")continue;const I=M.webkitGetAsEntry();I&&b.push(I)}const S=[];for(let C=0;C<x.dataTransfer.files.length;C++)S.push(x.dataTransfer.files[C]);a(!0),l({percent:0,message:"Scanning files..."}),await new Promise(C=>setTimeout(C,0));try{const C=new Map;console.log(`[Drop] Scanning ${b.length} entries...`);for(const M of b)await d(M,"",C);if(C.size===0&&S.length>0){console.log(`[Drop] Fallback: using ${S.length} files from dataTransfer.files`);for(const M of S)C.set(M.name,M)}console.log(`[Drop] Found ${C.size} files`),Cr(),i("local",null),await u(C)}catch(C){console.error("[File Dropzone] Error processing drop:",C),s(C instanceof Error?C.message:"Failed to process dropped files"),a(!1)}},[d,u,m,a,l,s]),p=f.useCallback(x=>{x.preventDefault(),x.stopPropagation()},[]),y=f.useCallback(async(x,v,k)=>{try{for await(const b of x.values()){const S=v?`${v}/${b.name}`:b.name;if(b.kind==="file"){const C=await b.getFile();k.set(S,C)}else b.kind==="directory"&&await y(b,S,k)}}catch(b){console.warn(`Failed to scan directory: ${v}`,b)}},[]),w=f.useCallback(async()=>{if(me.getState().urlLoading){console.log("[File Dropzone] Ignoring browse during active loading");return}if(!("showDirectoryPicker"in window)){s("Your browser does not support folder selection. Please use drag and drop, or try Chrome/Edge.");return}try{const v=await window.showDirectoryPicker();a(!0),l({percent:0,message:"Scanning folder..."}),await new Promise(b=>setTimeout(b,0));const k=new Map;await y(v,"",k),Cr(),i("local",null),await u(k)}catch(v){if(v instanceof Error&&v.name==="AbortError")return;console.error("Error browsing for folder:",v),s(v instanceof Error?v.message:"Failed to open folder"),a(!1)}},[y,u,s,a,l]);return{handleDrop:g,handleDragOver:p,processFiles:u,processZipFile:m,handleBrowse:w}}const np=Ia({version:eu().int().min(1).max(1),name:tr().optional(),baseUrl:tr().url(),files:Ia({cameras:tr().min(1),images:tr().min(1),points3D:tr().min(1),rigs:tr().optional(),frames:tr().optional()}),imagesPath:tr().optional(),masksPath:tr().optional(),skipImages:Im().optional(),images:sc(tr()).optional(),masks:sc(tr()).optional()});let Wo=!1;function nk(e){return{version:1,baseUrl:e.endsWith("/")?e.slice(0,-1):e,files:{cameras:"sparse/0/cameras.bin",images:"sparse/0/images.bin",points3D:"sparse/0/points3D.bin",rigs:"sparse/0/rigs.bin",frames:"sparse/0/frames.bin"},imagesPath:"images/",masksPath:"masks/"}}function rp(){const{processFiles:e}=Ms(),t=me(x=>x.setError),n=me(x=>x.setSourceInfo),r=me(x=>x.urlLoading),s=me(x=>x.urlProgress),i=me(x=>x.urlError),a=me(x=>x.setUrlLoading),l=me(x=>x.setUrlProgress),c=me(x=>x.setUrlError),d=f.useCallback(async x=>{l({percent:2,message:"Fetching manifest..."});const v=await ec(x);if(!v.ok)throw{type:v.status===404?"not_found":"network",message:`Failed to fetch manifest (${v.status})`,details:v.statusText,failedFile:x};const k=await v.json(),b=np.safeParse(k);if(!b.success)throw{type:"invalid_manifest",message:"Invalid manifest format",details:b.error.issues.map(C=>`${C.path.join(".")}: ${C.message}`).join("; "),failedFile:x};return l({percent:5,message:"Manifest loaded"}),b.data},[l]),h=f.useCallback(async(x,v)=>{const k=x.endsWith("/")?`${x}${v}`:`${x}/${v}`,b=await ec(k);if(!b.ok)throw{type:b.status===404?"not_found":"network",message:`Failed to fetch file (${b.status})`,details:`${v}: ${b.statusText}`,failedFile:k};const S=await b.blob(),C=V0(k);return W0(S,C)},[]),u=f.useCallback(async x=>{const v=new Map,{baseUrl:k,files:b}=x,S=[{key:"sparse/0/cameras.bin",path:b.cameras},{key:"sparse/0/images.bin",path:b.images},{key:"sparse/0/points3D.bin",path:b.points3D}],C=[];b.rigs&&C.push({key:"sparse/0/rigs.bin",path:b.rigs}),b.frames&&C.push({key:"sparse/0/frames.bin",path:b.frames});const M=S.length;let I=0;l({percent:5,message:"Downloading COLMAP files...",filesDownloaded:0,totalFiles:M});const L=await Promise.all(S.map(async({key:P,path:_})=>{try{const N=await h(k,_);I++;const D=5+Math.round(I/M*25);return l({percent:D,message:"Downloading COLMAP files...",currentFile:_,filesDownloaded:I,totalFiles:M}),{key:P,file:N}}catch(N){throw N.type?N:Fh(N,`${k}/${_}`)}}));for(const{key:P,file:_}of L)v.set(P,_);if(C.length>0){const P=await Promise.all(C.map(async({key:_,path:N})=>{try{const D=await h(k,N);return console.log(`[URL Loader] Optional file loaded: ${N}`),{key:_,file:D}}catch{return console.log(`[URL Loader] Optional file not found: ${N}`),null}}));for(const _ of P)_&&v.set(_.key,_.file)}return v},[h,l]),m=f.useCallback(async(x,v)=>{const k=await u(x);console.log(`[URL Loader] Downloaded ${k.size} COLMAP files:`,Array.from(k.keys())),console.log("[URL Loader] Skipping image download (images will be loaded lazily)"),l({percent:80,message:"Parsing reconstruction..."});const b=x.imagesPath??"images/",S=x.baseUrl.endsWith("/")?`${x.baseUrl}${b}`:`${x.baseUrl}/${b}`,C=x.masksPath??"masks/",M=x.baseUrl.endsWith("/")?`${x.baseUrl}${C}`:`${x.baseUrl}/${C}`;return n("url",v||x.baseUrl,S,M),console.log(`[URL Loader] Image URL base for lazy loading: ${S}`),console.log(`[URL Loader] Mask URL base for lazy loading: ${M}`),console.log("[URL Loader] Calling processFiles..."),await e(k,{start:80,end:100}),l({percent:100,message:"Complete"}),console.log(`[URL Loader] Successfully loaded ${k.size} files from URL`),!0},[u,e,n,l]),g=f.useCallback(async x=>{console.log(`[URL Loader] Loading ZIP from URL: ${x}`);const v=I=>{l({percent:I.percent,message:I.message,filesDownloaded:I.bytesLoaded,totalFiles:I.bytesTotal})},{colmapFiles:k,imageIndex:b,archive:S,fileSize:C,imageCount:M}=await ay(x,v);return $h(S,b,C,M),l({percent:80,message:"Parsing reconstruction..."}),n("zip",x),console.log(`[URL Loader] ZIP contains ${k.size} COLMAP files, ${M} indexed images`),console.log("[URL Loader] Calling processFiles..."),await e(k,{start:80,end:100}),l({percent:100,message:"Complete"}),console.log("[URL Loader] Successfully loaded reconstruction from ZIP"),!0},[e,n,l]),p=f.useCallback(async x=>{if(Wo)return console.log("[URL Loader] Already loading (sync guard), ignoring duplicate request"),!1;Wo=!0,a(!0),c(null),l({percent:0,message:"Starting..."});let v=X0(x);v!==x&&console.log(`[URL Loader] Normalized cloud URL: ${x} -> ${v}`);const k=Z0(v);k!==v&&(console.log(`[URL Loader] Normalized Git URL: ${v} -> ${k}`),v=k);try{if(Cr(),J0(v))return console.log(`[URL Loader] Detected ZIP URL: ${v}`),await g(v);let b;return Y0(v)?(b=await d(v),console.log(`[URL Loader] Loaded manifest: ${b.name||"unnamed"}`)):(b=nk(v),console.log(`[URL Loader] Using direct URL with default paths: ${v}`)),await m(b,v)}catch(b){console.error("[URL Loader] Error:",b),Cr();const S=b.type?b:pd(b,v);return c(S),t(S.message+(S.details?`: ${S.details}`:"")),!1}finally{Wo=!1,a(!1)}},[d,g,m,t,a,l,c]),y=f.useCallback(async x=>{if(Wo)return console.log("[URL Loader] Already loading (sync guard), ignoring duplicate request"),!1;Wo=!0,a(!0),c(null),l({percent:0,message:"Starting..."});try{Cr(),console.log(`[URL Loader] Loading from manifest: ${x.name||"unnamed"}`);const v=await u(x);console.log(`[URL Loader] Downloaded ${v.size} COLMAP files:`,Array.from(v.keys())),console.log("[URL Loader] Skipping image download (images will be loaded lazily)"),l({percent:80,message:"Parsing reconstruction..."});const k=x.imagesPath??"images/",b=x.baseUrl.endsWith("/")?`${x.baseUrl}${k}`:`${x.baseUrl}/${k}`,S=x.masksPath??"masks/",C=x.baseUrl.endsWith("/")?`${x.baseUrl}${S}`:`${x.baseUrl}/${S}`;return n("manifest",null,b,C,x),console.log(`[URL Loader] Image URL base for lazy loading: ${b}`),console.log(`[URL Loader] Mask URL base for lazy loading: ${C}`),console.log("[URL Loader] Calling processFiles..."),await e(v,{start:80,end:100}),l({percent:100,message:"Complete"}),console.log(`[URL Loader] Successfully loaded ${v.size} files from manifest`),!0}catch(v){console.error("[URL Loader] Error:",v),Cr();const k=v.type?v:pd(v,x.baseUrl);return c(k),t(k.message+(k.details?`: ${k.details}`:"")),!1}finally{Wo=!1,a(!1)}},[u,e,t,n,a,l,c]),w=f.useCallback(()=>{c(null)},[c]);return{loadFromUrl:p,loadFromManifest:y,urlLoading:r,urlProgress:s,urlError:i,clearUrlError:w,setUrlLoading:a,setUrlProgress:l}}function rk(e=h0.mobile){const[t,n]=f.useState(()=>typeof window<"u"&&window.innerWidth<e);return f.useEffect(()=>{function r(){n(window.innerWidth<e)}return window.addEventListener("resize",r),()=>window.removeEventListener("resize",r)},[e]),t}const ok="https://huggingface.co/datasets/OpsiClear/NGS/resolve/main/objects",rf=[{name:"Lady Bug Toy",scanId:"scan_20250714_170841_lady_bug_toy"},{name:"Red Car Toy",scanId:"scan_20250714_172700_red_car_toy"},{name:"USB Microscope",scanId:"scan_20250711_112222_usb_microscope"},{name:"Mouse on USB Cable",scanId:"scan_20250711_110733_mouse_on_top_of_usb_cable"},{name:"Abrasive on Torch",scanId:"scan_20250711_102546_abbrasive_on_torch"},{name:"Stamp (New Lighting)",scanId:"scan_20250711_113305_stamp_new_lighting"},{name:"Gold Cup with Mandarins",scanId:"scan_20250714_174136_goldcup_with_scar_mandarins"},{name:"Strawberry Hydro",scanId:"scan_20250713_155826_ilovehydros_strawberry"},{name:"Beef",scanId:"scan_20250713_042803_beef"},{name:"Potato Blend",scanId:"scan_20250713_142608_tasteful_selections_bite_size_creamers_sunburst_blend_potato"},{name:"Object Scan 1",scanId:"scan_20250403_094132"},{name:"Object Scan 2",scanId:"scan_20250408_172911"},{name:"Object Scan 3",scanId:"scan_20250521_153106"}];function sk(e){return`${ok}/${e}/`}function ik(){return rf[Math.floor(Math.random()*rf.length)]}function _s({icon:e,label:t}){return o.jsxs("span",{className:"relative w-6 h-6 flex items-center justify-center",children:[o.jsx("span",{className:"absolute inset-0 flex items-center justify-center opacity-100 group-hover:opacity-0",children:e}),o.jsx("span",{className:"absolute inset-0 flex items-center justify-center text-2xs font-bold tracking-tight opacity-0 group-hover:opacity-100",children:t})]})}function Oo({className:e}){return o.jsx("svg",{className:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2.5",strokeLinecap:"round",children:o.jsx("path",{d:"M18 6L6 18M6 6l12 12"})})}function No({className:e}){return o.jsx("svg",{className:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:o.jsx("path",{d:"M20 6L9 17l-5-5"})})}function ii({className:e}){return o.jsxs("svg",{className:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[o.jsx("path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"}),o.jsx("path",{d:"M3 3v5h5"})]})}function op({className:e}){return o.jsxs("svg",{className:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[o.jsx("path",{d:"M20 12a8 8 0 0 0-8-8"}),o.jsx("path",{d:"M12 1l-3 3 3 3"}),o.jsx("path",{d:"M4 12a8 8 0 0 0 8 8"}),o.jsx("path",{d:"M12 23l3-3-3-3"})]})}function ak({className:e}){return o.jsxs("svg",{className:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[o.jsx("path",{d:"M12 15V3M12 3l-4 4M12 3l4 4"}),o.jsx("path",{d:"M4 17v2a2 2 0 002 2h12a2 2 0 002-2v-2"})]})}function lk({className:e}){return o.jsxs("svg",{className:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[o.jsx("circle",{cx:"12",cy:"12",r:"10"}),o.jsx("path",{d:"M4 4l16 16"})]})}function ck({className:e}){return o.jsx("svg",{className:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:o.jsx("path",{d:"M3 3l18 18M10.5 10.5a3 3 0 004.5 4.5M6.5 6.5C4 8.5 2 12 2 12s4 6 10 6c1.5 0 3-.5 4.5-1.5M17 17c2-1.5 3.5-3.5 5-5-1-1.5-4-6-10-6-.5 0-1 0-1.5.1"})})}function iu({className:e}){return o.jsxs("svg",{className:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[o.jsx("circle",{cx:"12",cy:"12",r:"3"}),o.jsx("path",{d:"M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"})]})}function uk({className:e}){return o.jsx("svg",{className:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:o.jsx("path",{d:"M8 3H5a2 2 0 00-2 2v3M21 8V5a2 2 0 00-2-2h-3M3 16v3a2 2 0 002 2h3M16 21h3a2 2 0 002-2v-3"})})}function dk({className:e}){return o.jsx("svg",{className:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:o.jsx("path",{d:"M22 3H2l8 9.46V19l4 2v-8.54L22 3z"})})}function fk({className:e}){return o.jsx("svg",{className:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:o.jsx("path",{d:"M13 2L3 14h9l-1 8 10-12h-9l1-8z"})})}function hk({className:e}){return o.jsx("svg",{className:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:o.jsx("path",{d:"M13 2L3 14h9l-1 8 10-12h-9l1-8z",opacity:"0.4"})})}function mk({className:e}){return o.jsxs("svg",{className:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[o.jsx("circle",{cx:"12",cy:"12",r:"6",fill:"currentColor",opacity:"0.3"}),o.jsx("path",{d:"M12 8v8M8 12h8"})]})}function pk({className:e}){return o.jsxs("svg",{className:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[o.jsx("circle",{cx:"12",cy:"12",r:"4",fill:"currentColor",opacity:"0.3"}),o.jsx("path",{d:"M8 12h8"})]})}function gk({className:e}){return o.jsxs("svg",{className:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[o.jsx("circle",{cx:"12",cy:"12",r:"3"}),o.jsx("path",{d:"M12 2v4M12 18v4M2 12h4M18 12h4"})]})}function xk({className:e}){return o.jsxs("svg",{className:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[o.jsx("circle",{cx:"12",cy:"12",r:"10"}),o.jsx("path",{d:"M12 16v-4"}),o.jsx("circle",{cx:"12",cy:"8",r:"1",fill:"currentColor",stroke:"none"})]})}function yk({className:e}){return o.jsxs("svg",{className:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[o.jsx("path",{d:"M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"}),o.jsx("path",{d:"M12 9v4"}),o.jsx("circle",{cx:"12",cy:"17",r:"1",fill:"currentColor",stroke:"none"})]})}function of({className:e}){return o.jsxs("svg",{className:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[o.jsx("path",{d:"M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"}),o.jsx("path",{d:"M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"})]})}function vk({className:e}){return o.jsxs("svg",{className:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[o.jsx("circle",{cx:"18",cy:"5",r:"3"}),o.jsx("circle",{cx:"6",cy:"12",r:"3"}),o.jsx("circle",{cx:"18",cy:"19",r:"3"}),o.jsx("path",{d:"M8.59 13.51l6.83 3.98M15.41 6.51l-6.82 3.98"})]})}function wk({className:e}){return o.jsxs("svg",{className:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[o.jsx("path",{d:"M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"}),o.jsx("path",{d:"M14 2v6h6"}),o.jsx("path",{d:"M8 13h1.5a1 1 0 011 1v1.5a1 1 0 01-1 1h0a1 1 0 01-1-1V14"}),o.jsx("path",{d:"M14.5 13H16a1 1 0 011 1v1.5a1 1 0 01-1 1h0a1 1 0 01-1-1V14"})]})}function sp({className:e}){return o.jsx("svg",{className:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:o.jsx("path",{d:"M6 9l6 6 6-6"})})}function bk({className:e}){return o.jsx("svg",{className:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:o.jsx("path",{d:"M9 18l6-6-6-6"})})}function Ck({className:e}){return o.jsxs("svg",{className:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[o.jsx("path",{d:"M3 6h18"}),o.jsx("path",{d:"M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6"}),o.jsx("path",{d:"M8 6V4a2 2 0 012-2h4a2 2 0 012 2v2"})]})}function Sk({className:e}){return o.jsxs("svg",{className:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[o.jsx("rect",{x:"3",y:"3",width:"7",height:"7"}),o.jsx("rect",{x:"14",y:"3",width:"7",height:"7"}),o.jsx("rect",{x:"3",y:"14",width:"7",height:"7"}),o.jsx("rect",{x:"14",y:"14",width:"7",height:"7"})]})}function kk({className:e}){return o.jsxs("svg",{className:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[o.jsx("rect",{x:"3",y:"4",width:"4",height:"4"}),o.jsx("line",{x1:"10",y1:"6",x2:"21",y2:"6"}),o.jsx("rect",{x:"3",y:"10",width:"4",height:"4"}),o.jsx("line",{x1:"10",y1:"12",x2:"21",y2:"12"}),o.jsx("rect",{x:"3",y:"16",width:"4",height:"4"}),o.jsx("line",{x1:"10",y1:"18",x2:"21",y2:"18"})]})}function Ik({className:e}){return o.jsx("svg",{className:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:o.jsx("path",{d:"M12 5v14M5 12l7-7 7 7"})})}function Mk({className:e}){return o.jsx("svg",{className:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:o.jsx("path",{d:"M12 5v14M5 12l7 7 7-7"})})}function ip({className:e}){return o.jsxs("svg",{className:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[o.jsx("path",{d:"M23 19a2 2 0 01-2 2H3a2 2 0 01-2-2V8a2 2 0 012-2h4l2-3h6l2 3h4a2 2 0 012 2z"}),o.jsx("circle",{cx:"12",cy:"13",r:"4"})]})}function jk({className:e}){return o.jsxs("svg",{className:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[o.jsx("path",{d:"M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"}),o.jsx("polyline",{points:"7 10 12 15 17 10"}),o.jsx("line",{x1:"12",y1:"15",x2:"12",y2:"3"})]})}function au({className:e}){return o.jsxs("svg",{className:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[o.jsx("line",{x1:"12",y1:"3",x2:"12",y2:"21"}),o.jsx("line",{x1:"3",y1:"12",x2:"21",y2:"12"}),o.jsx("polyline",{points:"9 5 12 3 15 5"}),o.jsx("polyline",{points:"9 19 12 21 15 19"}),o.jsx("polyline",{points:"5 9 3 12 5 15"}),o.jsx("polyline",{points:"19 9 21 12 19 15"})]})}function lu({className:e}){return o.jsxs("svg",{className:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[o.jsx("rect",{x:"2",y:"6",width:"13",height:"12",rx:"2"}),o.jsx("path",{d:"M15 10l7-4v12l-7-4z"})]})}function Ek({className:e}){return o.jsx("svg",{className:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:o.jsx("path",{d:"M5 12h14M19 12l-6-6M19 12l-6 6"})})}function Pk({className:e}){return o.jsxs("svg",{className:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[o.jsx("rect",{x:"2",y:"6",width:"13",height:"12",rx:"2"}),o.jsx("path",{d:"M15 10l7-4v12l-7-4z"}),o.jsx("path",{d:"M3 21L21 3",strokeWidth:"2.5"})]})}function Nk({className:e}){return o.jsxs("svg",{className:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[o.jsx("rect",{x:"1",y:"1",width:"7",height:"5",rx:"1",strokeWidth:"1.5"}),o.jsx("path",{d:"M8 2.5l3-1.5v6l-3-1.5z",strokeWidth:"1.5"}),o.jsx("rect",{x:"8",y:"8",width:"14",height:"14",rx:"1"}),o.jsx("circle",{cx:"12",cy:"12",r:"1.5"}),o.jsx("path",{d:"M22 18l-4-4-6 8"})]})}function Ak({className:e}){return o.jsxs("svg",{className:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"1.5",children:[o.jsx("rect",{x:"1",y:"1",width:"7",height:"5",rx:"1"}),o.jsx("path",{d:"M8 2.5l3-1.5v6l-3-1.5z"}),o.jsx("rect",{x:"13",y:"17",width:"7",height:"5",rx:"1"}),o.jsx("path",{d:"M20 18.5l3-1.5v6l-3-1.5z"})]})}function ap({className:e}){return o.jsxs("svg",{className:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"1.5",children:[o.jsx("rect",{x:"1",y:"1",width:"7",height:"5",rx:"1"}),o.jsx("path",{d:"M8 2.5l3-1.5v6l-3-1.5z"}),o.jsx("rect",{x:"13",y:"17",width:"7",height:"5",rx:"1"}),o.jsx("path",{d:"M20 18.5l3-1.5v6l-3-1.5z"}),o.jsx("path",{d:"M9 6l6 12",strokeWidth:"2"})]})}function Lk({className:e}){return o.jsxs("svg",{className:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"1.5",children:[o.jsx("rect",{x:"1",y:"1",width:"7",height:"5",rx:"1"}),o.jsx("path",{d:"M8 2.5l3-1.5v6l-3-1.5z"}),o.jsx("rect",{x:"13",y:"17",width:"7",height:"5",rx:"1"}),o.jsx("path",{d:"M20 18.5l3-1.5v6l-3-1.5z"}),o.jsx("path",{d:"M9 6l6 12",strokeWidth:"2",strokeDasharray:"2 2"})]})}function _k({className:e}){return o.jsxs("svg",{className:e,viewBox:"0 0 24 24",fill:"none",strokeLinecap:"round",children:[o.jsx("rect",{x:"1",y:"1",width:"7",height:"5",rx:"1",stroke:"currentColor",strokeWidth:"1.5"}),o.jsx("path",{d:"M8 2.5l3-1.5v6l-3-1.5z",stroke:"currentColor",strokeWidth:"1.5"}),o.jsx("path",{d:"M10 19a7 7 0 0 1 14 0",stroke:"#FF00FF",strokeWidth:"2.5"}),o.jsx("path",{d:"M12 19a5 5 0 0 1 10 0",stroke:"#FFFF00",strokeWidth:"2.5"}),o.jsx("path",{d:"M14 19a3 3 0 0 1 6 0",stroke:"#00FFFF",strokeWidth:"2.5"})]})}function Tk({className:e}){return o.jsxs("svg",{className:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[o.jsx("rect",{x:"1",y:"1",width:"7",height:"5",rx:"1",strokeWidth:"1.5"}),o.jsx("path",{d:"M8 2.5l3-1.5v6l-3-1.5z",strokeWidth:"1.5"}),o.jsx("circle",{cx:"17",cy:"17",r:"6",fill:"none"})]})}function Rk({className:e}){return o.jsxs("svg",{className:e,viewBox:"0 0 24 24",fill:"none",strokeWidth:"1.5",children:[o.jsx("rect",{x:"1",y:"1",width:"7",height:"5",rx:"1",stroke:"currentColor"}),o.jsx("path",{d:"M8 2.5l3-1.5v6l-3-1.5z",stroke:"currentColor"}),o.jsx("circle",{cx:"17",cy:"17",r:"6",fill:"#FF00FF"})]})}function Dk({className:e}){return o.jsxs("svg",{className:e,viewBox:"0 0 24 24",fill:"none",strokeWidth:"1.5",children:[o.jsx("rect",{x:"1",y:"1",width:"7",height:"5",rx:"1",stroke:"currentColor"}),o.jsx("path",{d:"M8 2.5l3-1.5v6l-3-1.5z",stroke:"currentColor"}),o.jsx("circle",{cx:"17",cy:"17",r:"2.5",fill:"#FF00FF"}),o.jsx("circle",{cx:"17",cy:"17",r:"4.5",stroke:"#FF00FF",strokeWidth:"1.5",opacity:"0.6",fill:"none"}),o.jsx("circle",{cx:"17",cy:"17",r:"6",stroke:"#FF00FF",strokeWidth:"1",opacity:"0.3",fill:"none"})]})}function cu({className:e}){return o.jsxs("svg",{className:e,viewBox:"0 0 24 24",fill:"none",strokeWidth:"2",strokeLinecap:"round",children:[o.jsx("path",{d:"M12 12h9",stroke:Cn.axisX}),o.jsx("path",{d:"M12 12v-9",stroke:Cn.axisY}),o.jsx("path",{d:"M12 12l-6 6",stroke:Cn.axisZ})]})}function Fk({className:e}){return o.jsxs("svg",{className:e,viewBox:"0 0 24 24",fill:"none",strokeLinecap:"round",children:[o.jsx("path",{d:"M12 12h4",stroke:"currentColor",strokeWidth:"2",opacity:"0.35"}),o.jsx("path",{d:"M12 12v-4",stroke:"currentColor",strokeWidth:"2",opacity:"0.35"}),o.jsx("path",{d:"M12 12l-2.5 2.5",stroke:"currentColor",strokeWidth:"2",opacity:"0.35"}),o.jsx("circle",{cx:"12",cy:"12",r:"1.5",fill:"currentColor",opacity:"0.4"})]})}function lp({className:e}){return o.jsx("svg",{className:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:o.jsx("path",{d:"M3 8h18M3 16h18M8 3v18M16 3v18"})})}function zk({className:e}){return o.jsxs("svg",{className:e,viewBox:"0 0 24 24",fill:"none",strokeLinecap:"round",children:[o.jsx("path",{d:"M4 8h16M4 16h16M8 4v16M16 4v16",stroke:"currentColor",strokeWidth:"1",opacity:"0.4"}),o.jsx("path",{d:"M12 12h9",stroke:Cn.axisX,strokeWidth:"2.5"}),o.jsx("path",{d:"M12 12v-9",stroke:Cn.axisY,strokeWidth:"2.5"}),o.jsx("path",{d:"M12 12l-6 6",stroke:Cn.axisZ,strokeWidth:"2.5"})]})}function Ok({className:e}){return o.jsxs("svg",{className:e,viewBox:"0 0 24 24",fill:"none",children:[o.jsx("circle",{cx:"12",cy:"7",r:"2.5",fill:"currentColor",opacity:"0.3"}),o.jsx("circle",{cx:"7",cy:"12",r:"2.2",fill:"currentColor",opacity:"0.3"}),o.jsx("circle",{cx:"17",cy:"11",r:"2.3",fill:"currentColor",opacity:"0.3"}),o.jsx("circle",{cx:"9",cy:"17",r:"2",fill:"currentColor",opacity:"0.3"}),o.jsx("circle",{cx:"15",cy:"16",r:"1.8",fill:"currentColor",opacity:"0.3"}),o.jsx("circle",{cx:"5",cy:"7",r:"1.5",fill:"currentColor",opacity:"0.3"}),o.jsx("circle",{cx:"19",cy:"6",r:"1.3",fill:"currentColor",opacity:"0.3"}),o.jsx("path",{d:"M3 21L21 3",stroke:"currentColor",strokeWidth:"2.5"})]})}function cp({className:e}){return o.jsxs("svg",{className:e,viewBox:"0 0 24 24",fill:"none",children:[o.jsx("circle",{cx:"12",cy:"7",r:"2.5",fill:"#e74c3c"}),o.jsx("circle",{cx:"7",cy:"12",r:"2.2",fill:"#3498db"}),o.jsx("circle",{cx:"17",cy:"11",r:"2.3",fill:"#2ecc71"}),o.jsx("circle",{cx:"9",cy:"17",r:"2",fill:"#f39c12"}),o.jsx("circle",{cx:"15",cy:"16",r:"1.8",fill:"#9b59b6"}),o.jsx("circle",{cx:"5",cy:"7",r:"1.5",fill:"#1abc9c"}),o.jsx("circle",{cx:"19",cy:"6",r:"1.3",fill:"#e91e63"})]})}function $k({className:e}){return o.jsxs("svg",{className:e,viewBox:"0 0 24 24",fill:"none",children:[o.jsx("circle",{cx:"12",cy:"7",r:"2.5",fill:"#e74c3c"}),o.jsx("circle",{cx:"7",cy:"12",r:"2.2",fill:"#3498db"}),o.jsx("circle",{cx:"17",cy:"11",r:"2.3",fill:"#f39c12"}),o.jsx("circle",{cx:"9",cy:"17",r:"2",fill:"#2980b9"}),o.jsx("circle",{cx:"15",cy:"16",r:"1.8",fill:"#c0392b"}),o.jsx("circle",{cx:"5",cy:"7",r:"1.5",fill:"#1e90ff"}),o.jsx("circle",{cx:"19",cy:"6",r:"1.3",fill:"#ff6347"})]})}function Bk({className:e}){return o.jsxs("svg",{className:e,viewBox:"0 0 24 24",fill:"none",children:[o.jsx("circle",{cx:"12",cy:"7",r:"2.5",fill:"#2ecc71"}),o.jsx("circle",{cx:"7",cy:"12",r:"2.2",fill:"#145a32"}),o.jsx("circle",{cx:"17",cy:"11",r:"2.3",fill:"#27ae60"}),o.jsx("circle",{cx:"9",cy:"17",r:"2",fill:"#1e8449"}),o.jsx("circle",{cx:"15",cy:"16",r:"1.8",fill:"#0b5345"}),o.jsx("circle",{cx:"5",cy:"7",r:"1.5",fill:"#58d68d"}),o.jsx("circle",{cx:"19",cy:"6",r:"1.3",fill:"#196f3d"})]})}function up({className:e}){return o.jsxs("svg",{className:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[o.jsx("circle",{cx:"12",cy:"12",r:"9"}),o.jsx("path",{d:"M12 3v18"}),o.jsx("path",{d:"M12 3a9 9 0 0 0 0 18",fill:"currentColor",opacity:"0.3"})]})}function Uk({className:e}){return o.jsxs("svg",{className:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[o.jsx("path",{d:"M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"}),o.jsx("circle",{cx:"12",cy:"12",r:"3"})]})}function Hk({className:e}){return o.jsxs("svg",{className:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"1.5",children:[o.jsx("circle",{cx:"12",cy:"12",r:"9"}),o.jsx("circle",{cx:"12",cy:"12",r:"3",fill:"currentColor",stroke:"none"}),o.jsx("circle",{cx:"21",cy:"12",r:"3",fill:"currentColor",stroke:"none"})]})}function Wk({className:e}){return o.jsxs("svg",{className:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"1.5",children:[o.jsx("path",{d:"M2.5 12 Q12 2 21.5 12 Q12 22 2.5 12"}),o.jsx("circle",{cx:"12",cy:"12",r:"4",fill:"currentColor",stroke:"none"})]})}function Vk({className:e}){return o.jsxs("svg",{className:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[o.jsx("rect",{x:"3",y:"3",width:"18",height:"18",rx:"2"}),o.jsx("line",{x1:"15",y1:"3",x2:"15",y2:"21"}),o.jsx("polyline",{points:"11 9 7 12 11 15",strokeLinecap:"round",strokeLinejoin:"round"})]})}function Zk({className:e}){return o.jsxs("svg",{className:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[o.jsx("rect",{x:"3",y:"3",width:"18",height:"18",rx:"2"}),o.jsx("line",{x1:"15",y1:"3",x2:"15",y2:"21"}),o.jsx("polyline",{points:"7 9 11 12 7 15",strokeLinecap:"round",strokeLinejoin:"round"})]})}function dp({className:e}){return o.jsxs("svg",{className:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"1.5",children:[o.jsx("rect",{x:"8",y:"1",width:"5",height:"4",rx:"0.5"}),o.jsx("path",{d:"M13 2.5l2.5-1v4l-2.5-1z"}),o.jsx("rect",{x:"1",y:"16",width:"5",height:"4",rx:"0.5"}),o.jsx("path",{d:"M6 17.5l2.5-1v4l-2.5-1z"}),o.jsx("rect",{x:"15",y:"16",width:"5",height:"4",rx:"0.5"}),o.jsx("path",{d:"M20 17.5l2.5-1v4l-2.5-1z"}),o.jsx("line",{x1:"10",y1:"5",x2:"4",y2:"16",strokeWidth:"1.5"}),o.jsx("line",{x1:"11",y1:"5",x2:"17",y2:"16",strokeWidth:"1.5"}),o.jsx("line",{x1:"6",y1:"18",x2:"15",y2:"18",strokeWidth:"1.5"})]})}function Yk({className:e}){return o.jsxs("svg",{className:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"1.5",children:[o.jsx("rect",{x:"8",y:"1",width:"5",height:"4",rx:"0.5"}),o.jsx("path",{d:"M13 2.5l2.5-1v4l-2.5-1z"}),o.jsx("rect",{x:"1",y:"16",width:"5",height:"4",rx:"0.5"}),o.jsx("path",{d:"M6 17.5l2.5-1v4l-2.5-1z"}),o.jsx("rect",{x:"15",y:"16",width:"5",height:"4",rx:"0.5"}),o.jsx("path",{d:"M20 17.5l2.5-1v4l-2.5-1z"}),o.jsx("path",{d:"M2 22L22 2",strokeWidth:"2.5"})]})}function Gk({className:e}){return o.jsxs("svg",{className:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"1.5",children:[o.jsx("rect",{x:"8",y:"1",width:"5",height:"4",rx:"0.5"}),o.jsx("path",{d:"M13 2.5l2.5-1v4l-2.5-1z"}),o.jsx("rect",{x:"1",y:"16",width:"5",height:"4",rx:"0.5"}),o.jsx("path",{d:"M6 17.5l2.5-1v4l-2.5-1z"}),o.jsx("rect",{x:"15",y:"16",width:"5",height:"4",rx:"0.5"}),o.jsx("path",{d:"M20 17.5l2.5-1v4l-2.5-1z"}),o.jsx("line",{x1:"10",y1:"5",x2:"4",y2:"16",strokeWidth:"1.5",strokeDasharray:"2 2"}),o.jsx("line",{x1:"11",y1:"5",x2:"17",y2:"16",strokeWidth:"1.5",strokeDasharray:"2 2"}),o.jsx("line",{x1:"6",y1:"18",x2:"15",y2:"18",strokeWidth:"1.5",strokeDasharray:"2 2"})]})}const qk=o.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[o.jsx("circle",{cx:"12",cy:"12",r:"9"}),o.jsx("path",{d:"M12 12h6",stroke:Cn.axisX,strokeWidth:"3"}),o.jsx("path",{d:"M15 9l3 3-3 3",stroke:Cn.axisX})]}),Xk=o.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[o.jsx("circle",{cx:"12",cy:"12",r:"9"}),o.jsx("path",{d:"M12 12v-6",stroke:Cn.axisY,strokeWidth:"3"}),o.jsx("path",{d:"M9 9l3-3 3 3",stroke:Cn.axisY})]}),Kk=o.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[o.jsx("circle",{cx:"12",cy:"12",r:"9"}),o.jsx("circle",{cx:"12",cy:"12",r:"3",fill:Cn.axisZ}),o.jsx("path",{d:"M12 12l4 4",stroke:Cn.axisZ,strokeWidth:"2"})]}),Qk=o.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[o.jsx("path",{d:"M2 12h4M18 12h4"}),o.jsx("rect",{x:"6",y:"4",width:"12",height:"16",rx:"1"}),o.jsx("circle",{cx:"12",cy:"12",r:"3"})]}),Jk=o.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[o.jsx("circle",{cx:"12",cy:"12",r:"9"}),o.jsx("path",{d:"M12 8v8M8 12h8"})]}),eI=o.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[o.jsx("path",{d:"M3 12h18"}),o.jsx("path",{d:"M12 3v6M12 15v6"}),o.jsx("circle",{cx:"12",cy:"12",r:"2",fill:"currentColor",stroke:"none"})]}),tI=o.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[o.jsx("line",{x1:"12",y1:"2",x2:"12",y2:"22",strokeDasharray:"2 2"}),o.jsx("ellipse",{cx:"12",cy:"12",rx:"10",ry:"4",fill:"none",strokeDasharray:"42 21"}),o.jsx("path",{d:"M2 12l0 3.5 3.5 -0.5"})]}),nI=o.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[o.jsx("rect",{x:"3",y:"3",width:"18",height:"18",rx:"2"}),o.jsx("line",{x1:"15",y1:"3",x2:"15",y2:"21"})]}),rI=o.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[o.jsx("path",{d:"M12 3v18M3 12h18"}),o.jsx("path",{d:"M12 12l6-6",strokeDasharray:"2 2"})]}),oI=o.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[o.jsx("rect",{x:"2",y:"6",width:"13",height:"12",rx:"2"}),o.jsx("path",{d:"M15 10l7-4v12l-7-4z"}),o.jsx("circle",{cx:"7",cy:"12",r:"1.5",fill:Cn.axisX,stroke:"none"}),o.jsx("circle",{cx:"11",cy:"12",r:"1.5",fill:Cn.axisY,stroke:"none"})]}),sI=o.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[o.jsx("circle",{cx:"7",cy:"12",r:"3",fill:Cn.axisX,stroke:"none"}),o.jsx("circle",{cx:"12",cy:"12",r:"3",fill:Cn.axisY,stroke:"none"}),o.jsx("circle",{cx:"17",cy:"12",r:"3",fill:Cn.axisZ,stroke:"none"})]}),iI=o.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[o.jsx("circle",{cx:"6",cy:"6",r:"3"}),o.jsx("circle",{cx:"18",cy:"18",r:"3"}),o.jsx("path",{d:"M8.5 8.5l7 7",strokeDasharray:"2 2"})]}),aI=o.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[o.jsx("rect",{x:"3",y:"3",width:"18",height:"18",rx:"2",strokeDasharray:"4 2"}),o.jsx("circle",{cx:"12",cy:"12",r:"4",fill:"currentColor",opacity:"0.3"})]}),lI=o.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[o.jsx("rect",{x:"3",y:"3",width:"18",height:"18",rx:"2"}),o.jsx("path",{d:"M9 9l6 6M15 9l-6 6"})]}),cI=o.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[o.jsx("rect",{x:"3",y:"3",width:"18",height:"14",rx:"2"}),o.jsx("circle",{cx:"8",cy:"8",r:"2"}),o.jsx("path",{d:"M21 15l-5-5L5 17"})]}),uI=o.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[o.jsx("path",{d:"M4 6q8 3 16 0",strokeDasharray:"2 2",opacity:"0.5"}),o.jsx("path",{d:"M4 12h16"}),o.jsx("path",{d:"M4 18q8 -3 16 0",strokeDasharray:"2 2",opacity:"0.5"}),o.jsx("path",{d:"M12 8v-4M10 6l2-2 2 2",strokeWidth:"1.5"})]}),dI=o.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[o.jsx("circle",{cx:"12",cy:"12",r:"8",strokeDasharray:"4 2"}),o.jsx("path",{d:"M12 4v4M12 16v4M4 12h4M16 12h4"}),o.jsx("circle",{cx:"12",cy:"12",r:"2",fill:"currentColor"})]}),fI=o.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[o.jsx("circle",{cx:"12",cy:"12",r:"4",fill:"currentColor"}),o.jsx("path",{d:"M12 2v6M12 16v6M2 12h6M16 12h6",strokeDasharray:"2 2"})]}),hI=o.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[o.jsx("circle",{cx:"5",cy:"12",r:"3"}),o.jsx("circle",{cx:"19",cy:"12",r:"3"}),o.jsx("path",{d:"M8 12h8",strokeDasharray:"2 2"})]}),mI=o.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[o.jsx("path",{d:"M12 5L5 19L19 19Z",fill:"currentColor",opacity:"0.15"}),o.jsx("path",{d:"M12 5L5 19L19 19Z"}),o.jsx("circle",{cx:"12",cy:"5",r:"2",fill:"currentColor"}),o.jsx("circle",{cx:"5",cy:"19",r:"2",fill:"currentColor"}),o.jsx("circle",{cx:"19",cy:"19",r:"2",fill:"currentColor"})]}),pI=o.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[o.jsx("path",{d:"M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"}),o.jsx("path",{d:"M7 10l5 5 5-5"}),o.jsx("path",{d:"M12 15V3"})]}),gI=o.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[o.jsx("path",{d:"M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"}),o.jsx("path",{d:"M14 2v6h6"}),o.jsx("path",{d:"M12 18v-6"}),o.jsx("path",{d:"M9 15l3 3 3-3"})]}),xI=o.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[o.jsx("path",{d:"M3 6h18"}),o.jsx("path",{d:"M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6"}),o.jsx("path",{d:"M8 6V4a2 2 0 012-2h4a2 2 0 012 2v2"})]}),yI=o.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[o.jsx("path",{d:"M2 20l10-6 10 6"}),o.jsx("path",{d:"M12 14V4"}),o.jsx("path",{d:"M9 7l3-3 3 3"})]}),vI=o.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[o.jsx("path",{d:"M23 19a2 2 0 01-2 2H3a2 2 0 01-2-2V8a2 2 0 012-2h4l2-3h6l2 3h4a2 2 0 012 2z"}),o.jsx("circle",{cx:"12",cy:"13",r:"4"})]});function oa({className:e}){return o.jsxs("svg",{className:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[o.jsx("rect",{x:"6",y:"2",width:"12",height:"20",rx:"6"}),o.jsx("path",{d:"M12 2v8"}),o.jsx("rect",{x:"6",y:"2",width:"6",height:"8",rx:"3",fill:"currentColor",opacity:"0.5"})]})}function mc({className:e}){return o.jsxs("svg",{className:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[o.jsx("rect",{x:"6",y:"2",width:"12",height:"20",rx:"6"}),o.jsx("path",{d:"M12 2v8"}),o.jsx("rect",{x:"12",y:"2",width:"6",height:"8",rx:"3",fill:"currentColor",opacity:"0.5"})]})}function wI({className:e}){return o.jsxs("svg",{className:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[o.jsx("rect",{x:"6",y:"2",width:"12",height:"20",rx:"6"}),o.jsx("path",{d:"M12 6v4M12 14v4M9 8l3-3 3 3M9 16l3 3 3-3"})]})}function bI({isOpen:e,onClose:t,onLoad:n,loading:r=!1}){const[s,i]=f.useState(""),[a,l]=f.useState(!1),c=f.useRef(null);f.useEffect(()=>{e&&c.current&&setTimeout(()=>{c.current?.focus()},50)},[e]),f.useEffect(()=>{e||i("")},[e]);const d=f.useCallback(()=>{const u=s.trim();!u||r||n(u)},[s,r,n]),h=f.useCallback(u=>{u.key==="Enter"&&!r&&d()},[d,r]);return kt("escape",()=>t(),{enabled:e&&!r},[e,r,t]),e?o.jsx("div",{className:"fixed inset-0 flex items-center justify-center bg-ds-void/50",style:{zIndex:Rn.modalOverlay},onClick:u=>{u.target===u.currentTarget&&!r&&t()},children:o.jsxs("div",{className:"bg-ds-tertiary border border-ds rounded-lg shadow-ds-lg p-5 min-w-[400px] max-w-[520px]","data-testid":"url-modal",onClick:u=>u.stopPropagation(),children:[o.jsx("h3",{className:"text-ds-primary font-medium mb-3",children:"Load from URL"}),o.jsx("p",{className:"text-ds-muted text-sm mb-4",children:"Enter a manifest URL (.json), a ZIP file URL (.zip), or a direct path to a COLMAP folder"}),o.jsx("input",{ref:c,type:"url",value:s,onChange:u=>i(u.target.value),onKeyDown:h,placeholder:"https://huggingface.co/.../resolve/main/reconstruction",className:`${nn.base} ${nn.sizes.lg} w-full mb-4 text-sm placeholder-ds-muted`,disabled:r}),o.jsxs("div",{className:"mb-4",children:[o.jsxs("button",{type:"button",onClick:()=>l(!a),className:"flex items-center gap-1 text-ds-muted text-xs hover:text-ds-primary transition-colors",children:[a?o.jsx(sp,{className:"w-3 h-3"}):o.jsx(bk,{className:"w-3 h-3"}),"Supported URL formats"]}),a&&o.jsxs("div",{className:"mt-2 p-3 bg-ds-secondary rounded border border-ds text-xs text-ds-muted",children:[o.jsx("div",{className:"font-medium text-ds-primary mb-2",children:"ZIP Files"}),o.jsxs("ul",{className:"space-y-1 mb-3",children:[o.jsx("li",{children:o.jsx("code",{className:"text-ds-accent",children:"https://example.com/reconstruction.zip"})}),o.jsx("li",{className:"text-ds-muted/70",children:"ZIP should contain cameras.bin, images.bin, points3D.bin"}),o.jsx("li",{className:"text-ds-muted/70",children:"Images in ZIP are loaded lazily on-demand"}),o.jsx("li",{className:"text-ds-muted/70",children:"Maximum ZIP size: 2GB"})]}),o.jsx("div",{className:"font-medium text-ds-primary mb-2",children:"Cloud Storage URLs"}),o.jsxs("ul",{className:"space-y-1 mb-3",children:[o.jsxs("li",{children:[o.jsx("code",{className:"text-ds-accent",children:"s3://bucket/path"})," â€” AWS S3"]}),o.jsxs("li",{children:[o.jsx("code",{className:"text-ds-accent",children:"gs://bucket/path"})," â€” Google Cloud Storage"]}),o.jsx("li",{children:o.jsx("code",{className:"text-ds-accent",children:"https://bucket.s3.amazonaws.com/path"})}),o.jsx("li",{children:o.jsx("code",{className:"text-ds-accent",children:"https://storage.googleapis.com/bucket/path"})}),o.jsx("li",{children:o.jsx("code",{className:"text-ds-accent",children:"https://account.r2.cloudflarestorage.com/bucket/path"})})]}),o.jsx("div",{className:"font-medium text-ds-primary mb-2",children:"Dropbox"}),o.jsxs("ul",{className:"space-y-1 mb-3",children:[o.jsx("li",{children:o.jsx("code",{className:"text-ds-accent",children:"https://www.dropbox.com/s/.../file.txt?dl=0"})}),o.jsx("li",{children:o.jsx("code",{className:"text-ds-accent",children:"https://www.dropbox.com/scl/fi/.../file.txt?rlkey=..."})}),o.jsx("li",{className:"text-ds-muted/70",children:"Share links auto-converted to direct downloads"})]}),o.jsx("div",{className:"font-medium text-ds-primary mb-2",children:"Git Hosting URLs"}),o.jsxs("ul",{className:"space-y-1 mb-3",children:[o.jsx("li",{children:o.jsx("code",{className:"text-ds-accent",children:"https://huggingface.co/.../resolve/main/..."})}),o.jsx("li",{children:o.jsx("code",{className:"text-ds-accent",children:"https://github.com/.../blob/main/..."})}),o.jsx("li",{children:o.jsx("code",{className:"text-ds-accent",children:"https://gitlab.com/.../-/blob/main/..."})})]}),o.jsx("div",{className:"font-medium text-ds-primary mb-2",children:"Local / Self-hosted Server"}),o.jsxs("ul",{className:"space-y-1 mb-3",children:[o.jsx("li",{children:o.jsx("code",{className:"text-ds-accent",children:"http://localhost:8080/"})}),o.jsxs("li",{className:"text-ds-muted/70",children:["Start with: ",o.jsx("code",{className:"text-ds-accent",children:"npx http-server --cors -p 8080"})]})]}),o.jsx("div",{className:"font-medium text-amber-400 mb-1",children:"CORS Requirements"}),o.jsx("p",{className:"text-ds-muted/80",children:"Cloud buckets must have CORS configured. Dropbox, pre-signed URLs, and same-origin servers work automatically."})]})]}),o.jsxs("div",{className:"flex justify-end gap-2",children:[o.jsx("button",{type:"button",onClick:t,disabled:r,className:od("ghost","lg",r),children:"Cancel"}),o.jsx("button",{type:"button",onClick:d,disabled:r||!s.trim(),className:od("primary","lg",r||!s.trim()),children:r?"Loading...":"Load"})]})]})}):null}const Il={profiles:{},activeProfile:null},zr="Default";function CI(){try{const e=localStorage.getItem(Zt.profiles);if(!e)return Il;const t=JSON.parse(e);return typeof t.profiles!="object"||t.profiles===null?Il:{profiles:t.profiles,activeProfile:t.activeProfile??null}}catch{return Il}}function SI(e){const{[zr]:t,...n}=e.profiles;localStorage.setItem(Zt.profiles,JSON.stringify({profiles:n,activeProfile:e.activeProfile}))}function kI(e){let t=1;for(;e.includes(`Profile ${t}`);)t++;return`Profile ${t}`}function fp(){const[e,t]=f.useState(CI);f.useEffect(()=>{SI(e)},[e]);const n=f.useMemo(()=>{const h=Object.keys(e.profiles);return h.includes(zr)||h.unshift(zr),h.sort((u,m)=>u===zr?-1:m===zr?1:u.localeCompare(m))},[e.profiles]),r=e.activeProfile,s=r===zr,i=f.useCallback(h=>{const u=tp();t(m=>({profiles:{...m.profiles,[h]:u},activeProfile:h}))},[]),a=f.useCallback(h=>{const u=h===zr?By():e.profiles[h];u&&(su(u),t(m=>({...m,activeProfile:h})))},[e.profiles]),l=f.useCallback(h=>{h!==zr&&t(u=>{const{[h]:m,...g}=u.profiles;return{profiles:g,activeProfile:u.activeProfile===h?zr:u.activeProfile}})},[]),c=f.useCallback(()=>{t(h=>({...h,activeProfile:null}))},[]),d=f.useCallback(()=>kI(n),[n]);return{profileNames:n,activeProfile:r,isActiveProfileReadOnly:s,saveProfile:i,loadProfile:a,deleteProfile:l,clearActiveProfile:c,suggestName:d}}function Ya(e,t,n=!0){f.useEffect(()=>{if(!n)return;const r=a=>{e.current&&!e.current.contains(a.target)&&t()},s=a=>{a.key==="Escape"&&t()},i=setTimeout(()=>{document.addEventListener("mousedown",r),document.addEventListener("keydown",s)},0);return()=>{clearTimeout(i),document.removeEventListener("mousedown",r),document.removeEventListener("keydown",s)}},[e,t,n])}function II(){const{profileNames:e,activeProfile:t,loadProfile:n}=fp(),[r,s]=f.useState(!1),i=f.useRef(null),a=f.useCallback(()=>s(!1),[]);Ya(i,a,r);const l=f.useCallback(c=>{n(c),s(!1)},[n]);return o.jsxs("div",{className:"relative",ref:i,children:[o.jsxs("button",{type:"button",onClick:()=>s(!r),className:`${ue.base} ${ue.variants.ghost} h-8 px-2 gap-1`,"data-tooltip":"Select settings profile",children:[o.jsx("span",{className:"text-sm truncate max-w-[80px]",children:t||"Profile"}),o.jsx(sp,{className:`w-3 h-3 transition-transform ${r?"rotate-180":""}`})]}),r&&o.jsx("div",{className:`absolute top-full right-0 mt-1 bg-ds-tertiary border border-ds rounded shadow-lg z-[${Rn.dropdown}] min-w-[120px] py-1`,children:e.map(c=>o.jsx("div",{onClick:()=>l(c),className:`px-3 py-1.5 cursor-pointer hover-ds-hover text-sm ${c===t?"bg-ds-hover text-ds-accent":"text-ds-primary"}`,children:c},c))})]})}function MI({children:e}){const[t,n]=f.useState(!1),[r,s]=f.useState(!1),[i,a]=f.useState(!1),[l,c]=f.useState(null),{handleDrop:d,handleDragOver:h,handleBrowse:u}=Ms(),{loadFromUrl:m,loadFromManifest:g,urlLoading:p,urlProgress:y,setUrlLoading:w,setUrlProgress:x}=rp(),{error:v,setError:k,reconstruction:b}=me(),S=f.useRef(null),C=f.useRef(null),M=rk(),I=G(T=>T.touchMode),L=f.useCallback(async T=>{w(!0),x({percent:0,message:"Starting..."}),a(!1),await new Promise(z=>setTimeout(z,0)),await m(T)},[m,w,x]),P=f.useCallback(async T=>{const z=T.target.files?.[0];if(z){w(!0),x({percent:0,message:"Loading manifest..."}),await new Promise(H=>setTimeout(H,0));try{const H=await z.text(),O=JSON.parse(H),J=np.safeParse(O);if(!J.success){const re=J.error.issues.map(q=>`${q.path.join(".")}: ${q.message}`).join("; ");k(`Invalid manifest: ${re}`),w(!1);return}await g(J.data)}catch(H){const O=H instanceof Error?H.message:"Unknown error";k(`Failed to load manifest: ${O}`),w(!1)}T.target.value=""}},[g,k,w,x]),_=f.useCallback(async()=>{if(p)return;w(!0),x({percent:0,message:"Starting..."}),await new Promise(z=>setTimeout(z,0));const T=ik();console.log(`[Try a Toy] Loading random dataset: ${T.name}`),await m(sk(T.scanId))},[m,p,w,x]),N=f.useCallback(()=>{const T={version:1,name:"Example Dataset",baseUrl:"https://example.com/colmap-data",files:{cameras:"sparse/0/cameras.bin",images:"sparse/0/images.bin",points3D:"sparse/0/points3D.bin"},imagesPath:"images/",masksPath:"masks/"},z=new Blob([JSON.stringify(T,null,2)],{type:"application/json"}),H=URL.createObjectURL(z),O=document.createElement("a");O.href=H,O.download="manifest.json",document.body.appendChild(O),O.click(),document.body.removeChild(O),URL.revokeObjectURL(H)},[]),D=f.useCallback(()=>{confirm("Reset all settings to defaults? This will clear your saved preferences.")&&(Object.values(Zt).forEach(T=>localStorage.removeItem(T)),window.location.reload())},[]),B=f.useCallback(()=>{S.current?.click()},[]),E=f.useCallback(async T=>{const z=T.target.files?.[0];if(z){try{const H=await z.text(),O=Jm(H);if(O.valid&&O.config)su(O.config),console.log(`[Config] Applied settings from ${z.name}`);else{const J=O.errors.map(re=>re.path?`${re.path}: ${re.message}`:re.message).join(", ");k(`Config error: ${J}`)}}catch(H){const O=H instanceof Error?H.message:"Unknown error";k(`Config error: ${O}`)}T.target.value=""}},[k]);f.useEffect(()=>{if(v){const T=setTimeout(()=>{k(null)},rr.errorToastDuration);return()=>clearTimeout(T)}},[v,k]);const Z=f.useCallback(T=>{T.preventDefault(),T.stopPropagation(),T.dataTransfer.types.includes("Files")&&n(!0)},[]),F=f.useCallback(T=>{T.preventDefault(),T.stopPropagation(),T.currentTarget.contains(T.relatedTarget)||n(!1)},[]),$=f.useCallback(async T=>{n(!1),await d(T)},[d]);return o.jsxs("div",{className:"relative w-full h-full","data-testid":"drop-zone",onDragEnter:Z,onDragLeave:F,onDragOver:h,onDrop:$,children:[e,t&&o.jsx("div",{className:Ls.container,children:o.jsxs("div",{className:Ls.content,children:[o.jsx("div",{className:Ls.icon,children:"+"}),o.jsx("div",{className:Ls.title,children:"Drop COLMAP folder or ZIP here"}),o.jsx("div",{className:Ls.subtitle,children:"Expected: cameras.bin, images.bin, points3D.bin (or .zip containing them)"})]})}),!b&&!p&&!Vl()&&!t&&!r&&!M&&!I&&o.jsx("div",{className:`absolute inset-0 flex items-center justify-center z-[${Rn.controls}]`,children:o.jsxs("div",{className:"flex flex-col bg-ds-secondary rounded-lg border border-ds p-6 min-w-[420px]",children:[o.jsxs("div",{className:"flex justify-between -mt-4 -mx-4 mb-6",children:[o.jsxs("div",{className:"flex items-center gap-1",children:[o.jsx(II,{}),o.jsx("div",{className:"w-px h-5 bg-ds-muted/30 mx-1"}),o.jsx("button",{type:"button",className:`${ue.base} w-8 h-8 ${ue.variants.ghost}`,onClick:B,"data-tooltip":"Upload configuration file (.yaml)",children:o.jsx(ak,{className:"w-4 h-4"})}),o.jsx("button",{type:"button",className:`${ue.base} w-8 h-8 ${ue.variants.ghost}`,onClick:D,"data-tooltip":"Reset all settings to defaults",children:o.jsx(ii,{className:"w-4 h-4"})})]}),o.jsx("button",{type:"button",className:`${ue.base} w-8 h-8 ${ue.variants.ghost}`,onClick:()=>s(!0),"data-tooltip":"Dismiss this panel",children:"Ã—"})]}),o.jsx("input",{ref:S,type:"file",accept:".yaml,.yml",className:"hidden",onChange:E}),o.jsx("input",{ref:C,type:"file",accept:".json",className:"hidden",onChange:P}),o.jsxs("div",{className:"flex flex-col items-center",children:[o.jsx("div",{className:"w-32 h-32 mt-6 mb-6 flex items-center justify-center border-2 border-dashed border-ds-muted rounded-lg cursor-pointer hover-border-ds-primary transition-colors",onClick:u,children:o.jsx("span",{className:"text-ds-muted font-light leading-none",style:{fontSize:"72px"},children:"+"})}),o.jsx("h2",{className:Un.title,children:"Load COLMAP Data"}),o.jsxs("p",{className:Un.message,children:["Drag and drop a COLMAP dataset folder here.",o.jsx("br",{}),"Or click the box above to browse."]}),o.jsx("style",{children:".info-line:hover { color: rgba(255,255,255,0.9); }"}),o.jsxs("div",{className:"text-ds-muted text-sm text-left max-w-md mt-6 mb-4",children:[o.jsxs("div",{className:"info-line px-2 rounded",children:[o.jsx("strong",{children:"Drop folder or ZIP file"})," â€” subfolders are scanned automatically"]}),o.jsxs("div",{className:"info-line px-2 rounded",children:[o.jsx("strong",{children:"Required:"})," cameras, images, points3D (.bin or .txt preferred)"]}),o.jsxs("div",{className:"info-line px-2 rounded",children:[o.jsx("strong",{children:"Auto-detected:"})," sparse/0/, sparse/, or any subfolder"]}),o.jsxs("div",{className:"info-line px-2 rounded",children:[o.jsx("strong",{children:"Optional:"})," source images (jpg, png, webp, tiff), config (.yaml), masks/"]}),o.jsx("div",{className:"info-line px-2 rounded text-ds-muted/70",children:"ZIP: max 2GB, images loaded lazily on-demand"})]}),o.jsxs("div",{className:"flex gap-2 mt-2",children:[o.jsxs("div",{className:"relative",children:[o.jsxs("button",{type:"button",onClick:()=>a(!0),onContextMenu:T=>{T.preventDefault(),window.open("https://huggingface.co/datasets/OpsiClear/NGS","_blank")},onMouseEnter:()=>c("url"),onMouseLeave:()=>c(null),disabled:p,className:`${ue.base} ${ue.sizes.action} ${ue.variants.secondary} ${p?ue.disabled:""}`,children:[o.jsx(of,{className:"w-3.5 h-3.5"}),"Load URL"]}),l==="url"&&o.jsxs("div",{className:`absolute left-1/2 -translate-x-1/2 bottom-full mb-2 z-[${Rn.dropdown}] ${ve.container}`,children:[o.jsx("div",{className:ve.title,children:"Load from URL"}),o.jsx("div",{className:`${ve.subtitle} whitespace-pre mt-1`,children:`Direct URL expects:
  <baseUrl>/sparse/0/cameras.bin
  <baseUrl>/sparse/0/images.bin
  <baseUrl>/sparse/0/points3D.bin
  <baseUrl>/images/  (optional)
  <baseUrl>/masks/   (optional)`}),o.jsx("div",{className:`${ve.subtitle} mt-2`,children:"Or provide a .zip or manifest.json URL"}),o.jsx("div",{className:`${ve.subtitle} mt-1 text-ds-muted/70`,children:"Supports: S3, GCS, R2, Dropbox, HuggingFace, GitHub"}),o.jsx("div",{className:`${ve.subtitle} mt-1 text-ds-muted/70`,children:"Local server: npx http-server --cors -p 8080"}),o.jsxs("div",{className:ve.hint,children:[o.jsxs("div",{className:ve.hintRow,children:[o.jsx(oa,{className:_t.hoverCard}),"Left: open URL dialog"]}),o.jsxs("div",{className:ve.hintRow,children:[o.jsx(mc,{className:_t.hoverCard}),"Right: open NGS dataset"]})]})]})]}),o.jsxs("div",{className:"relative",children:[o.jsxs("button",{type:"button",onClick:()=>C.current?.click(),onContextMenu:T=>{T.preventDefault(),N()},onMouseEnter:()=>c("json"),onMouseLeave:()=>c(null),disabled:p,className:`${ue.base} ${ue.sizes.action} ${ue.variants.secondary} ${p?ue.disabled:""}`,children:[o.jsx(wk,{className:"w-3.5 h-3.5"}),"Load JSON"]}),l==="json"&&o.jsxs("div",{className:`absolute left-1/2 -translate-x-1/2 bottom-full mb-2 z-[${Rn.dropdown}] ${ve.container}`,children:[o.jsx("div",{className:ve.title,children:"Load manifest.json"}),o.jsx("div",{className:`${ve.subtitle} whitespace-pre mt-1 font-mono text-xs`,children:`{
  "version": 1,
  "baseUrl": "https://...",
  "files": {
    "cameras": "sparse/0/cameras.bin",
    "images": "sparse/0/images.bin",
    "points3D": "sparse/0/points3D.bin"
  },
  "imagesPath": "images/",
  "masksPath": "masks/"
}`}),o.jsxs("div",{className:ve.hint,children:[o.jsxs("div",{className:ve.hintRow,children:[o.jsx(oa,{className:_t.hoverCard}),"Left: browse manifest file"]}),o.jsxs("div",{className:ve.hintRow,children:[o.jsx(mc,{className:_t.hoverCard}),"Right: download example"]})]})]})]}),o.jsxs("div",{className:"relative",children:[o.jsxs("button",{type:"button",onClick:_,onMouseEnter:()=>c("toy"),onMouseLeave:()=>c(null),disabled:p,className:`${ue.base} ${ue.sizes.action} ${ue.variants.secondary} ${p?ue.disabled:""}`,children:[o.jsx("img",{src:no("LOGO.png"),alt:"",className:"w-3.5 h-3.5"}),"Try a Toy!"]}),l==="toy"&&o.jsxs("div",{className:`absolute left-1/2 -translate-x-1/2 bottom-full mb-2 z-[${Rn.dropdown}] ${ve.container}`,children:[o.jsx("div",{className:ve.title,children:"Load random 3D scan"}),o.jsx("div",{className:ve.subtitle,children:"Multiview data from OpsiClear NGS dataset"}),o.jsx("div",{className:`${ve.subtitle} text-ds-muted/70`,children:"huggingface.co/datasets/OpsiClear/NGS"}),o.jsx("div",{className:`${ve.subtitle} mt-1`,children:"Includes: images, masks, sparse reconstruction"}),o.jsx("div",{className:ve.hint,children:o.jsxs("div",{className:ve.hintRow,children:[o.jsx(oa,{className:_t.hoverCard}),"Left: load random scan"]})})]})]})]})]})]})}),!b&&!p&&!Vl()&&!r&&(I||M)&&o.jsx("div",{className:`absolute inset-0 flex items-center justify-center z-[${Rn.controls}] px-3`,children:o.jsxs("div",{className:"flex flex-col bg-ds-secondary rounded-lg border border-ds p-4 w-full max-w-xs",children:[o.jsx("div",{className:"flex justify-end -mt-1 -mr-1",children:o.jsx("button",{type:"button",className:`${ue.base} w-11 h-11 ${ue.variants.ghost} text-xl`,onClick:()=>s(!0),"aria-label":"Dismiss",children:"Ã—"})}),o.jsxs("div",{className:"flex flex-col items-center mb-3",children:[o.jsx("img",{src:no("LOGO.png"),alt:"ColmapView",className:"w-12 h-12 mb-2"}),o.jsx("h2",{className:Un.title,children:"ColmapView"}),o.jsx("p",{className:"text-ds-secondary text-xs text-center mt-1",children:"View COLMAP 3D reconstructions"})]}),o.jsxs("div",{className:"flex flex-col gap-2",children:[o.jsxs("button",{type:"button",onClick:()=>a(!0),disabled:p,className:`${ue.base} h-12 text-sm ${ue.variants.secondary} ${p?ue.disabled:""} active:scale-98`,children:[o.jsx(of,{className:"w-5 h-5 mr-2"}),"Load from URL"]}),o.jsxs("button",{type:"button",onClick:_,disabled:p,className:`${ue.base} h-12 text-sm ${ue.variants.primary} ${p?ue.disabled:""} active:scale-98`,children:[o.jsx("img",{src:no("LOGO.png"),alt:"",className:"w-5 h-5 mr-2"}),"Try a Toy!"]})]}),o.jsx("p",{className:"text-ds-muted text-xs text-center mt-3",children:"Load a URL or try a sample dataset"})]})}),p&&y&&o.jsx("div",{className:Bo.overlay,children:o.jsxs("div",{className:Bo.container,children:[o.jsx("div",{className:"flex justify-center mb-4",children:o.jsx("img",{src:no("LOGO.png"),alt:"Loading",className:"w-12 h-12 animate-bounce"})}),o.jsx("div",{className:Bo.text,children:y.message}),o.jsx("div",{className:Bo.progressBar,children:o.jsx("div",{className:Bo.progressFill,style:{width:`${Math.round(y.percent)}%`}})}),o.jsxs("div",{className:Bo.percentage,children:[Math.round(y.percent),"%"]}),y.currentFile&&o.jsx("div",{className:"text-white/70 text-xs mt-2 max-w-xs truncate",children:y.currentFile}),y.filesDownloaded!==void 0&&y.totalFiles!==void 0&&o.jsxs("div",{className:"text-white/70 text-xs mt-1",children:[y.filesDownloaded," / ",y.totalFiles," files"]})]})}),v&&o.jsxs("div",{className:`${As.containerWithLayout} ${As.error}`,children:[o.jsxs("div",{className:As.content,children:[o.jsx("div",{className:As.titleError,children:"Error loading data"}),o.jsx("div",{className:As.message,children:v})]}),o.jsx("button",{onClick:()=>k(null),className:ue.close,children:"Ã—"})]}),o.jsx(bI,{isOpen:i,onClose:()=>a(!1),onLoad:L,loading:p})]})}const sf=320,Ts=100,af=2,jI=18,Ri=16,Di=8;function EI({title:e,bins:t}){const n=f.useRef(null),[r,s]=f.useState(null);f.useLayoutEffect(()=>{if(!n.current)return;const c=n.current.getBoundingClientRect(),d=window.innerWidth;if(c.left<Di){const h=Di-c.left;s(h)}else if(c.right>d-Di){const h=c.right-(d-Di);s(-h)}else s(null)},[]);const i=Math.max(...t.map(c=>c.percentage),1),a=(sf-(t.length-1)*af)/t.length,l=r!==null?`translateX(calc(-50% + ${r}px))`:"translateX(-50%)";return o.jsx("div",{ref:n,className:xl.container,style:{bottom:"100%",marginBottom:"8px",transform:l},children:o.jsxs("div",{className:xl.card,children:[o.jsx("div",{className:xl.title,children:e}),o.jsx("svg",{width:sf,height:Ts+jI+Ri,className:"mt-2",children:t.map((c,d)=>{const h=c.percentage/i*Ts,u=d*(a+af),m=Ri+Ts-h;return o.jsxs("g",{children:[o.jsx("rect",{x:u,y:Ri,width:a,height:Ts,fill:Ei.barBackground,rx:3}),o.jsx("rect",{x:u,y:m,width:a,height:h||1,fill:Ei.bar,rx:3}),o.jsx("text",{x:u+a/2,y:Ri+Ts+12,textAnchor:"middle",fontSize:8,fontWeight:500,fill:Ei.label,children:c.label}),c.percentage>=5&&o.jsxs("text",{x:u+a/2,y:m-3,textAnchor:"middle",fontSize:8,fontWeight:600,fill:Ei.percentage,children:[c.percentage.toFixed(0),"%"]})]},c.label)})})]})})}const hp=[{label:"2",min:2,max:3},{label:"3",min:3,max:4},{label:"4",min:4,max:5},{label:"5",min:5,max:6},{label:"6",min:6,max:7},{label:"7",min:7,max:8},{label:"8",min:8,max:9},{label:"9",min:9,max:10},{label:"10",min:10,max:11},{label:"11-15",min:11,max:16},{label:"16-20",min:16,max:21},{label:"21+",min:21,max:1/0}],mp=[{label:"0-.25",min:0,max:.25},{label:".25-.5",min:.25,max:.5},{label:".5-.75",min:.5,max:.75},{label:".75-1",min:.75,max:1},{label:"1-1.25",min:1,max:1.25},{label:"1.25-1.5",min:1.25,max:1.5},{label:"1.5-2",min:1.5,max:2},{label:"2-2.5",min:2,max:2.5},{label:"2.5-3",min:2.5,max:3},{label:"3-4",min:3,max:4},{label:"4-5",min:4,max:5},{label:"5+",min:5,max:1/0}];function pp(e,t){for(let n=0;n<t.length;n++)if(e>=t[n].min&&e<t[n].max)return n;return-1}function pc(e,t,n){return t.map((r,s)=>({label:r.label,count:e[s],percentage:n>0?e[s]/n*100:0}))}function PI(e,t){const n=t==="trackLength"?hp:mp,r=t==="trackLength"?e.getTrackLengths():e.getErrors();if(!r)return{bins:pc(new Array(n.length).fill(0),n,0),mean:0,total:0};const s=new Array(n.length).fill(0);let i=0;for(let l=0;l<r.length;l++){i+=r[l];const c=pp(r[l],n);c>=0&&s[c]++}const a=r.length;return{bins:pc(s,n,a),mean:a>0?i/a:0,total:a}}function NI(e,t){const n=t==="trackLength"?hp:mp,r=new Array(n.length).fill(0);let s=0,i=0;for(const a of e.values()){const l=t==="trackLength"?a.track.length:a.error;s+=l,i++;const c=pp(l,n);c>=0&&r[c]++}return{bins:pc(r,n,i),mean:i>0?s/i:0,total:i}}function lf({label:e,value:t,type:n,points3D:r,wasmReconstruction:s}){const[i,a]=f.useState(!1),l=f.useMemo(()=>i?s?.hasPoints()?PI(s,n):r&&r.size>0?NI(r,n):null:null,[i,r,s,n]),c=n==="trackLength"?"Track Length Distribution":"Reprojection Error Distribution";return o.jsxs("span",{className:"relative cursor-help overflow-visible",onMouseEnter:()=>a(!0),onMouseLeave:()=>a(!1),children:[e,": ",o.jsx("span",{className:"text-ds-primary",children:t}),i&&l&&o.jsx(EI,{title:c,bins:l.bins})]})}class AI{getState;constructor(t){this.getState=t}getSourceType(){return this.getState().sourceType}isLoaded(){return this.getState().sourceType!==null}async getImage(t){const{sourceType:n,loadedFiles:r,imageUrlBase:s}=this.getState();switch(n){case"local":return Zr(r?.imageFiles,t)??null;case"url":case"manifest":return s?Jn(t)??await ks(s,t):null;case"zip":return bn()?Vn(t)??await gs(t):null;default:return null}}getImageSync(t){const{sourceType:n,loadedFiles:r}=this.getState();switch(n){case"local":return Zr(r?.imageFiles,t);case"url":case"manifest":return Jn(t);case"zip":return Vn(t);default:return}}async getMask(t){const{sourceType:n,loadedFiles:r,maskUrlBase:s}=this.getState();switch(n){case"local":return tc(r?.imageFiles,t)??null;case"url":case"manifest":return s?await Vh(s,t):null;case"zip":return bn()?await Zh(t):null;default:return null}}getMaskSync(t){const{sourceType:n,loadedFiles:r}=this.getState();switch(n){case"local":return tc(r?.imageFiles,t);case"url":case"manifest":case"zip":return;default:return}}async prefetchImages(t,n=5){const{sourceType:r,imageUrlBase:s}=this.getState();switch(r){case"local":return;case"url":case"manifest":if(!s)return;await yy(s,t,n);return;case"zip":if(!bn())return;const i=t.filter(a=>!Vn(a));for(let a=0;a<i.length;a+=n){const l=i.slice(a,a+n);await Promise.all(l.map(c=>gs(c)))}return;default:return}}hasImages(){const{sourceType:t,loadedFiles:n}=this.getState();switch(t){case"local":return(n?.imageFiles?.size??0)>0;case"url":case"manifest":return this.getState().imageUrlBase!==null;case"zip":return bn();default:return!1}}hasMasks(){const{sourceType:t,loadedFiles:n,maskUrlBase:r}=this.getState();switch(t){case"local":return n?.hasMasks??!1;case"url":case"manifest":return r!==null;case"zip":return bn();default:return!1}}getCacheStats(){const{sourceType:t,loadedFiles:n}=this.getState(),r=Yh(),s=Gh(),i=qh(),a=Sy(n?.imageFiles),l=r.count+s.count+i.count+a.count,c=r.sizeBytes+s.sizeBytes+i.sizeBytes+a.sizeBytes;return{urlImages:this.formatCacheEntry(r),zipImages:this.formatCacheEntry(s),zipMasks:this.formatCacheEntry(i),localImages:this.formatCacheEntry(a),total:this.formatCacheEntry({count:l,sizeBytes:c}),sourceType:t}}formatCacheEntry(t){return{count:t.count,sizeBytes:t.sizeBytes,sizeFormatted:this.formatBytes(t.sizeBytes)}}formatBytes(t){if(t===0)return"0 B";const n=["B","KB","MB","GB"],r=1024,s=Math.floor(Math.log(t)/Math.log(r)),i=t/Math.pow(r,s),a=i<10?2:i<100?1:0;return`${i.toFixed(a)} ${n[s]}`}getMemoryStats(){const{sourceType:t,loadedFiles:n}=this.getState(),r=me.getState().reconstruction,s=me.getState().wasmReconstruction,i=(q,ie)=>({count:q,sizeBytes:ie,sizeFormatted:this.formatBytes(ie)}),a=(q,ie,we,Ce,Re)=>({available:q,strategy:ie,memoryType:we,memory:i(Ce,Re)}),l=s?.hasPoints()??!1,c=l?s.pointCount:r?.points3D?.size??0,d=c*80;let h=0;if(r?.images)for(const q of r.images.values())h+=q.numPoints2D??q.points2D.length;const u=h*16,m=r?.cameras.size??0,g=m*200,p=r?.images.size??0,y=p*200,w=!!n?.databaseFile,x=r?.globalStats?.totalObservations??0,v=x*12,k=this.getCacheStats(),b=t==="local",S=b?"memory":"lazy",C=b?k.localImages.count:k.urlImages.count+k.zipImages.count,M=b?k.localImages.sizeBytes:k.urlImages.sizeBytes+k.zipImages.sizeBytes,I=k.zipMasks.count,L=k.zipMasks.sizeBytes,P=Eh(),_=Xl(),N=P.count+_.bitmaps,D=P.count*75e3+_.bitmaps*65e3,B=w?n.databaseFile.size:0,E=!!n?.rigsFile,Z=E?n.rigsFile.size:0,F=Uh(),$=t==="zip",T=F.fileSize,z=l?d:0,O=(l?0:d)+u+g+y+v+B+Z;return{points3D:a(c>0,"memory",l?"wasm":"js",c,d),points2D:a(h>0,"memory","js",h,u),matches:a(x>0,"memory","js",x,v),cameras:a(m>0,"memory","js",m,g),imagePoses:a(p>0,"memory","js",p,y),imageFiles:a(this.hasImages(),S,"js",C,M),maskFiles:a(this.hasMasks(),b?"memory":"lazy","js",I,L),imagesDecoded:a(N>0,"memory","js",N,D),database:a(w,"memory","js",w?1:0,B),rigs:a(E,"memory","js",E?1:0,Z),zipArchive:a($&&T>0,"memory","js",1,T),totalWasm:i(0,z),totalJs:i(0,O),totalCached:i(0,0),sourceType:t}}}let Ml=null;function LI(){return Ml||(Ml=new AI(()=>{const e=me.getState();return{sourceType:e.sourceType,imageUrlBase:e.imageUrlBase,maskUrlBase:e.maskUrlBase,loadedFiles:e.loadedFiles}})),Ml}function gp(){return me(e=>e.sourceType),me(e=>e.imageUrlBase),me(e=>e.loadedFiles),LI()}const _I={local:{label:"Local",color:Ir.success},url:{label:"URL",color:Ir.info},manifest:{label:"Manifest",color:Ir.highlight},zip:{label:"ZIP",color:Ir.warning}};function cf({className:e=""}){return o.jsx("svg",{className:`w-3.5 h-3.5 ${e}`,fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",strokeWidth:2,children:o.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"})})}function TI({className:e=""}){return o.jsx("svg",{className:`w-3.5 h-3.5 ${e}`,fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",strokeWidth:2,children:o.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"})})}function RI({className:e=""}){return o.jsx("svg",{className:`w-3.5 h-3.5 ${e}`,fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",strokeWidth:2,children:o.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})})}function DI({className:e=""}){return o.jsx("svg",{className:`w-3.5 h-3.5 ${e}`,fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",strokeWidth:2,children:o.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"})})}function uf(e,t=""){switch(e){case"local":return o.jsx(cf,{className:t});case"url":return o.jsx(TI,{className:t});case"manifest":return o.jsx(RI,{className:t});case"zip":return o.jsx(DI,{className:t});default:return o.jsx(cf,{className:t})}}function Hs({strategy:e,memoryType:t="js"}){return e==="lazy"?o.jsx("span",{className:Te.dotLazy}):e==="unavailable"?o.jsx("span",{className:Te.dotUnavailable}):o.jsx("span",{className:t==="wasm"?Te.dotMemoryWasm:Te.dotMemoryJs})}function Os(e){if(e===0)return"0 B";const t=["B","KB","MB","GB"],n=1024,r=Math.floor(Math.log(e)/Math.log(n)),s=e/Math.pow(n,r),i=s<10?2:s<100?1:0;return`${s.toFixed(i)} ${t[r]}`}function Vo({label:e,strategy:t,memoryType:n="js",count:r,size:s,available:i}){const a=i?t:"unavailable",l=i?"":Te.tableRowDimmed;return o.jsxs("tr",{className:l,children:[o.jsx("td",{className:Te.tableCellLabel,children:o.jsxs("div",{className:Te.tableCellLabelInner,children:[o.jsx(Hs,{strategy:a,memoryType:n}),o.jsx("span",{className:Te.tableCellLabelText,children:e})]})}),o.jsx("td",{className:Te.tableCellCount,children:i?r.toLocaleString():"-"}),o.jsx("td",{className:Te.tableCellSize,children:i?s:"-"})]})}function FI({entry:e}){return e.stats.count>0||e.stats.sizeBytes>0?o.jsxs("tr",{children:[o.jsx("td",{className:Te.tableCellLabel,children:o.jsxs("div",{className:Te.tableCellLabelInner,children:[o.jsx(Hs,{strategy:e.strategy,memoryType:e.memoryType}),o.jsx("span",{className:Te.tableCellLabelText,children:e.label})]})}),o.jsx("td",{className:Te.tableCellCount,children:e.stats.count.toLocaleString()}),o.jsx("td",{className:Te.tableCellSize,children:Os(e.stats.sizeBytes)})]}):null}const Fi=8;function zI(){const e=gp(),t=me(p=>p.reconstruction),[n,r]=f.useState(!1),[s,i]=f.useState(null),[a,l]=f.useState([]),c=f.useRef(null),[d,h]=f.useState(null),u=e.getSourceType(),m=u?_I[u]:null;f.useEffect(()=>{n&&(i(e.getMemoryStats()),l(Iy()))},[n,e]),f.useLayoutEffect(()=>{if(!n||!c.current){h(null);return}const p=c.current.getBoundingClientRect(),y=window.innerWidth;p.left<Fi?h(Fi-p.left):p.right>y-Fi?h(-(p.right-(y-Fi))):h(null)},[n,s]);const g=f.useMemo(()=>{let p=0,y=0,w=0,x=0;for(const v of a)v.strategy==="lazy"?(w+=v.stats.sizeBytes,x+=v.stats.count):v.memoryType==="wasm"?y+=v.stats.sizeBytes:p+=v.stats.sizeBytes;return{jsBytes:p,wasmBytes:y,lazyBytes:w,lazyCount:x}},[a]);return t?o.jsxs("span",{className:Te.wrapper,onMouseEnter:()=>r(!0),onMouseLeave:()=>r(!1),children:[o.jsxs("span",{className:Te.indicator,children:[o.jsx("span",{className:`flex items-center ${m?.color}`,children:uf(u)}),o.jsx("span",{className:Te.indicatorLabel,children:"Source:"}),o.jsx("span",{className:Te.indicatorValue,children:m?.label??"None"})]}),n&&s&&o.jsx("div",{ref:c,className:Te.tooltipContainer,style:{bottom:"100%",marginBottom:"8px",left:d!==null?d:0},children:o.jsxs("div",{className:Te.card,children:[o.jsxs("div",{className:Te.header,children:[o.jsxs("div",{className:Te.headerTitle,children:[o.jsx("span",{className:m?.color,children:uf(u)}),m?.label," Dataset"]}),o.jsxs("div",{className:Te.headerLegend,children:[o.jsxs("span",{className:Te.legendItem,children:[o.jsx(Hs,{strategy:"memory",memoryType:"js"}),o.jsx("span",{className:Te.legendText,children:"Loaded"})]}),o.jsxs("span",{className:Te.legendItem,children:[o.jsx(Hs,{strategy:"memory",memoryType:"wasm"}),o.jsx("span",{className:Te.legendText,children:"WASM"})]}),o.jsxs("span",{className:Te.legendItem,children:[o.jsx(Hs,{strategy:"lazy"}),o.jsx("span",{className:Te.legendText,children:"Lazy"})]})]})]}),o.jsxs("table",{className:Te.table,children:[o.jsx("thead",{children:o.jsxs("tr",{className:Te.tableHeader,children:[o.jsx("th",{className:`${Te.tableHeaderCell} ${Te.tableHeaderLeft}`,children:"Resource"}),o.jsx("th",{className:`${Te.tableHeaderCell} ${Te.tableHeaderRight} px-2`,children:"Count"}),o.jsx("th",{className:`${Te.tableHeaderCell} ${Te.tableHeaderRight} pl-2`,children:"Size"})]})}),o.jsxs("tbody",{children:[o.jsx(Vo,{label:"3D Points",strategy:s.points3D.strategy,memoryType:s.points3D.memoryType,count:s.points3D.memory.count,size:s.points3D.memory.sizeFormatted,available:s.points3D.available}),o.jsx(Vo,{label:"2D Keypoints",strategy:s.points2D.strategy,memoryType:s.points2D.memoryType,count:s.points2D.memory.count,size:s.points2D.memory.sizeFormatted,available:s.points2D.available}),o.jsx(Vo,{label:"Matches",strategy:s.matches.strategy,memoryType:s.matches.memoryType,count:s.matches.memory.count,size:s.matches.memory.sizeFormatted,available:s.matches.available}),o.jsx(Vo,{label:s.rigs.available?"Cameras/Rigs":"Cameras",strategy:s.cameras.strategy,memoryType:s.cameras.memoryType,count:s.cameras.memory.count+(s.rigs.available?s.rigs.memory.count:0),size:Os(s.cameras.memory.sizeBytes+(s.rigs.available?s.rigs.memory.sizeBytes:0)),available:s.cameras.available}),o.jsx(Vo,{label:"Camera Poses",strategy:s.imagePoses.strategy,memoryType:s.imagePoses.memoryType,count:s.imagePoses.memory.count,size:s.imagePoses.memory.sizeFormatted,available:s.imagePoses.available}),s.database.available&&o.jsx(Vo,{label:"Database",strategy:s.database.strategy,memoryType:s.database.memoryType,count:s.database.memory.count,size:s.database.memory.sizeFormatted,available:s.database.available}),a.map(p=>o.jsx(FI,{entry:p},p.name))]}),o.jsxs("tfoot",{children:[(s.totalWasm.sizeBytes>0||g.wasmBytes>0)&&o.jsxs("tr",{className:Te.tableFooter,children:[o.jsx("td",{className:Te.tableFooterCell,children:o.jsx("span",{className:Te.tableFooterLabel,children:"WASM Loaded"})}),o.jsx("td",{className:`${Te.tableFooterCell} ${Te.tableCellCount}`}),o.jsx("td",{className:`${Te.tableFooterCell} ${Te.tableCellSize} text-amber-400`,children:Os(s.totalWasm.sizeBytes+g.wasmBytes)})]}),o.jsxs("tr",{className:Te.tableFooter,style:{borderTop:s.totalWasm.sizeBytes>0||g.wasmBytes>0?"none":void 0},children:[o.jsx("td",{className:Te.tableFooterCell,children:o.jsx("span",{className:Te.tableFooterLabel,children:"JS Loaded"})}),o.jsx("td",{className:`${Te.tableFooterCell} ${Te.tableCellCount}`}),o.jsx("td",{className:`${Te.tableFooterCell} ${Te.tableCellSize} text-green-400`,children:Os(s.totalJs.sizeBytes+g.jsBytes)})]}),(s.totalCached.sizeBytes>0||g.lazyBytes>0)&&o.jsxs("tr",{className:Te.tableFooter,style:{borderTop:"none"},children:[o.jsx("td",{className:Te.tableFooterCell,children:o.jsx("span",{className:Te.tableFooterLabel,children:"JS Lazy"})}),o.jsx("td",{className:`${Te.tableFooterCell} ${Te.tableCellCount} text-blue-400`,children:(s.totalCached.count+g.lazyCount).toLocaleString()}),o.jsx("td",{className:`${Te.tableFooterCell} ${Te.tableCellSize} text-blue-400`,children:Os(s.totalCached.sizeBytes+g.lazyBytes)})]})]})]})]})})]}):null}function OI(){const e=me(i=>i.urlLoading),t=me(i=>i.reconstruction),n=me(i=>i.wasmReconstruction),r=G(i=>i.fps),s=t?.globalStats;return o.jsxs("footer",{className:sd.container,children:[o.jsxs("div",{className:sd.group,children:[o.jsxs("span",{className:"text-ds-tertiary",children:[r," FPS"]}),o.jsx(zI,{}),t&&s&&o.jsxs(o.Fragment,{children:[o.jsx(lf,{label:"Avg Track",value:s.avgTrackLength.toFixed(2),type:"trackLength",points3D:t.points3D,wasmReconstruction:n}),o.jsx(lf,{label:"Avg Reproj Error",value:`${s.avgError.toFixed(3)}px`,type:"error",points3D:t.points3D,wasmReconstruction:n})]}),!t&&o.jsx("span",{children:e?"Loading...":"Drop COLMAP folder to load"})]}),o.jsxs("div",{className:"flex items-center gap-2 text-ds-secondary",children:[o.jsx("span",{children:"ColmapView by OpsiClear"}),o.jsx("span",{children:"|"}),o.jsx("a",{href:"https://github.com/ColmapView/colmapview.github.io",target:"_blank",rel:"noopener noreferrer",className:"no-underline transition-colors",style:{color:"inherit"},title:"Star on GitHub",onMouseEnter:i=>i.currentTarget.style.color=hl.github,onMouseLeave:i=>i.currentTarget.style.color="inherit",children:"â˜… Star on GitHub"}),o.jsx("span",{children:"|"}),o.jsx("a",{href:"https://github.com/ColmapView/colmapview.github.io/issues",target:"_blank",rel:"noopener noreferrer",className:"no-underline transition-colors",style:{color:"inherit"},title:"Report Bugs",onMouseEnter:i=>i.currentTarget.style.color=hl.bugs,onMouseLeave:i=>i.currentTarget.style.color="inherit",children:"Report Bugs"}),o.jsx("span",{children:"|"}),o.jsx("span",{children:"AGPL 3.0"}),o.jsx("span",{children:"|"}),o.jsxs("span",{children:["Based on"," ",o.jsx("a",{href:"https://github.com/colmap/colmap",target:"_blank",rel:"noopener noreferrer",className:"no-underline transition-colors",style:{color:"inherit"},title:"COLMAP - Structure-from-Motion and Multi-View Stereo",onMouseEnter:i=>i.currentTarget.style.color=hl.colmap,onMouseLeave:i=>i.currentTarget.style.color="inherit",children:"COLMAP"})]}),o.jsx("span",{children:"|"}),o.jsxs("span",{children:["v","0.5.6"]})]})]})}function $I(){const e=G(s=>s.fps),t=G(s=>s.touchUI),n=me(s=>s.urlLoading),r=me(s=>s.reconstruction);return t.statusBar?o.jsxs("footer",{className:"h-6 border-t border-ds bg-ds-tertiary text-ds-secondary text-xs px-3 flex items-center justify-between",children:[o.jsxs("span",{className:"text-ds-tertiary",children:[e," FPS"]}),!r&&o.jsx("span",{className:"text-ds-muted",children:n?"Loading...":""})]}):null}function xp({onLongPress:e,onClick:t,delay:n=It.longPressDelay}){const r=f.useRef(null),s=f.useRef(null),i=f.useRef(!1),a=f.useRef(null),l=f.useCallback(()=>{r.current!==null&&(clearTimeout(r.current),r.current=null)},[]),c=f.useCallback(m=>{const g=m.touches[0];s.current={x:g.clientX,y:g.clientY},i.current=!1,a.current=m,r.current=setTimeout(()=>{i.current=!0,e(a.current)},n)},[e,n]),d=f.useCallback(m=>{if(!s.current)return;const g=m.touches[0],p=Math.abs(g.clientX-s.current.x),y=Math.abs(g.clientY-s.current.y);(p>It.dragThreshold||y>It.dragThreshold)&&(l(),s.current=null)},[l]),h=f.useCallback(m=>{l(),!i.current&&s.current&&t&&t(m),s.current=null,a.current=null},[l,t]),u=f.useCallback(()=>{l(),s.current=null,i.current=!1,a.current=null},[l]);return{onTouchStart:c,onTouchEnd:h,onTouchMove:d,onTouchCancel:u}}const BI=f.memo(function({img:t,isSelected:n,isMatched:r,isMarkedForDeletion:s,matchesColor:i,matchesBlink:a,onClick:l,onDoubleClick:c,onRightClick:d,isScrolling:h,skipImages:u,isSettling:m,isResizing:g,wouldGoBack:p,touchMode:y=!1}){const w=me(Cs)>1,x=zc(t.file,t.name,!h&&!u&&!m&&!g),[v,k]=f.useState(!1),[b,S]=f.useState(null);f.useEffect(()=>{h&&v&&(k(!1),S(null),document.body.style.cursor="")},[h,v]);const C=()=>{n?c(t.imageId):l(t.imageId)},M=xp({onLongPress:()=>d(t.imageId),onClick:()=>C()}),I=n?_r.itemSelected:r?`${a?"matches-blink":""}`:_r.itemHover,L=r&&!n?{borderColor:i}:{};return o.jsxs("div",{className:`${_r.itemAspect} group ${_r.item} ${I}`,style:{position:"relative",...L},onClick:y?void 0:C,onContextMenu:P=>{P.preventDefault(),d(t.imageId)},onPointerOver:P=>{y||(k(!0),S({x:P.clientX,y:P.clientY}),document.body.style.cursor="pointer")},onPointerMove:P=>{y||v&&S({x:P.clientX,y:P.clientY})},onPointerOut:()=>{y||(k(!1),S(null),document.body.style.cursor="")},...y?M:{},children:[o.jsxs("div",{className:_r.itemInner,children:[x?o.jsx("img",{src:x,alt:t.name,className:_r.itemImage,style:s?{filter:Rc}:void 0,draggable:!1}):o.jsx("div",{className:_r.placeholder,style:s?{opacity:.5}:void 0,children:h?"...":t.name}),s&&o.jsx("div",{className:"absolute inset-0 pointer-events-none z-20",children:o.jsxs("svg",{className:"w-full h-full",viewBox:"0 0 100 100",preserveAspectRatio:"none",children:[o.jsx("line",{x1:"0",y1:"0",x2:"100",y2:"100",stroke:"var(--bg-primary)",strokeWidth:"1.5"}),o.jsx("line",{x1:"100",y1:"0",x2:"0",y2:"100",stroke:"var(--bg-primary)",strokeWidth:"1.5"})]})}),!n&&!s&&o.jsx("div",{className:"absolute inset-0 pointer-events-none z-10",style:{background:`
                radial-gradient(
                  ellipse 100% 100% at center,
                  transparent 20%,
                  rgba(0,0,0,0.15) 40%,
                  rgba(0,0,0,0.4) 60%,
                  rgba(0,0,0,0.7) 80%,
                  rgba(0,0,0,0.9) 100%
                )
              `}})]}),o.jsx("div",{className:`${_r.overlay} z-20`,children:o.jsx("div",{className:_r.overlayText,children:t.name})}),!y&&v&&b&&Qs.createPortal(o.jsx("div",{style:{position:"fixed",left:b.x+rn.cursorOffset,top:b.y+rn.cursorOffset,pointerEvents:"none",zIndex:Rn.mouseTooltip},children:o.jsxs("div",{className:ve.container,children:[o.jsx("div",{className:ve.title,children:t.name}),o.jsx("div",{className:ve.subtitle,children:w?`#${t.cameraId}:${t.imageId}`:`#${t.imageId}`}),o.jsxs("div",{className:ve.subtitle,children:[t.numPoints3D," 3D points"]}),o.jsxs("div",{className:ve.subtitle,children:[t.numPoints2D," 2D points"]}),o.jsxs("div",{className:ve.subtitle,children:[t.covisibleCount," covisible"]}),o.jsxs("div",{className:ve.subtitle,children:[t.avgError.toFixed(2)," avg error"]}),o.jsxs("div",{className:ve.hint,children:[o.jsxs("div",{className:ve.hintRow,children:[o.jsxs("svg",{className:_t.hoverCard,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[o.jsx("rect",{x:"6",y:"2",width:"12",height:"20",rx:"6"}),o.jsx("path",{d:"M12 2v8"}),o.jsx("rect",{x:"6",y:"2",width:"6",height:"8",rx:"3",fill:"currentColor",opacity:"0.5"})]}),n?"Left: details":"Left: select"]}),o.jsxs("div",{className:ve.hintRow,children:[o.jsxs("svg",{className:_t.hoverCard,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[o.jsx("rect",{x:"6",y:"2",width:"12",height:"20",rx:"6"}),o.jsx("path",{d:"M12 2v8"}),o.jsx("rect",{x:"12",y:"2",width:"6",height:"8",rx:"3",fill:"currentColor",opacity:"0.5"})]}),r?"Right: matches":p?"Right: back":"Right: fly to"]})]})]})}),document.body)]})}),UI=f.memo(function({img:t,isSelected:n,isMatched:r,isMarkedForDeletion:s,matchesColor:i,matchesBlink:a,onClick:l,onDoubleClick:c,onRightClick:d,isScrolling:h,skipImages:u,isSettling:m,isResizing:g,wouldGoBack:p,touchMode:y=!1}){const w=me(Cs)>1,x=zc(t.file,t.name,!h&&!u&&!m&&!g),[v,k]=f.useState(!1),[b,S]=f.useState(null);f.useEffect(()=>{h&&v&&(k(!1),S(null),document.body.style.cursor="")},[h,v]);const C=()=>{n?c(t.imageId):l(t.imageId)},M=xp({onLongPress:()=>d(t.imageId),onClick:()=>C()}),I=n?Tr.itemSelected:r?`${a?"matches-blink":""}`:Tr.itemHover,L=r&&!n?{borderColor:i}:{};return o.jsxs("div",{onClick:y?void 0:C,onContextMenu:P=>{P.preventDefault(),d(t.imageId)},onPointerOver:P=>{y||(k(!0),S({x:P.clientX,y:P.clientY}),document.body.style.cursor="pointer")},onPointerMove:P=>{y||v&&S({x:P.clientX,y:P.clientY})},onPointerOut:()=>{y||(k(!1),S(null),document.body.style.cursor="")},style:{height:lo.listRowHeight,...L},className:`${Tr.item} px-3 list-stats-container ${I}`,...y?M:{},children:[o.jsxs("div",{className:`${Tr.thumbnail} ${Tr.thumbnailSize} relative`,children:[x?o.jsx("img",{src:x,alt:t.name,className:"w-full h-full object-cover",style:s?{filter:Rc}:void 0,draggable:!1}):o.jsx("div",{className:Tr.thumbnailPlaceholder,style:s?{opacity:.5}:void 0,children:t.imageId}),s&&o.jsx("div",{className:"absolute inset-0 pointer-events-none",children:o.jsxs("svg",{className:"w-full h-full",viewBox:"0 0 100 100",preserveAspectRatio:"none",children:[o.jsx("line",{x1:"0",y1:"0",x2:"100",y2:"100",stroke:"var(--bg-primary)",strokeWidth:"2"}),o.jsx("line",{x1:"100",y1:"0",x2:"0",y2:"100",stroke:"var(--bg-primary)",strokeWidth:"2"})]})})]}),o.jsxs("div",{className:Tr.content,children:[o.jsx("div",{className:Tr.title,children:t.name}),o.jsxs("div",{className:Tr.subtitle,children:[w?`#${t.cameraId}:${t.imageId}`:`#${t.imageId}`," Â· ",t.cameraWidth,"Ã—",t.cameraHeight]})]}),o.jsxs("div",{className:"flex-shrink-0 text-right list-stats-compact",children:[o.jsxs("div",{className:"text-ds-primary text-xs whitespace-nowrap",children:[t.numPoints3D,o.jsxs("span",{className:"text-ds-muted",children:["/",t.numPoints2D]})," Â· ",t.covisibleCount," Â· ",t.avgError.toFixed(2)]}),o.jsx("div",{className:"text-ds-muted text-xs whitespace-nowrap",children:"pts Â· covis Â· err"})]}),o.jsxs("div",{className:"flex-shrink-0 text-right list-stats-full",children:[o.jsxs("div",{className:"text-ds-primary text-sm",children:[t.numPoints3D,o.jsxs("span",{className:"text-ds-muted",children:["/",t.numPoints2D]})]}),o.jsx("div",{className:"text-ds-muted text-xs",children:"3D/2D pts"})]}),o.jsxs("div",{className:"flex-shrink-0 text-right w-16 list-stats-full",children:[o.jsx("div",{className:"text-ds-primary text-sm",children:t.covisibleCount}),o.jsx("div",{className:"text-ds-muted text-xs",children:"covisible"})]}),o.jsxs("div",{className:"flex-shrink-0 text-right w-16 list-stats-full",children:[o.jsx("div",{className:"text-ds-primary text-sm",children:t.avgError.toFixed(2)}),o.jsx("div",{className:"text-ds-muted text-xs",children:"avg err"})]}),!y&&v&&b&&Qs.createPortal(o.jsx("div",{style:{position:"fixed",left:b.x+rn.cursorOffset,top:b.y+rn.cursorOffset,pointerEvents:"none",zIndex:Rn.mouseTooltip},children:o.jsx("div",{className:ve.container,children:o.jsxs("div",{className:ve.hint,children:[o.jsxs("div",{className:ve.hintRow,children:[o.jsxs("svg",{className:_t.hoverCard,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[o.jsx("rect",{x:"6",y:"2",width:"12",height:"20",rx:"6"}),o.jsx("path",{d:"M12 2v8"}),o.jsx("rect",{x:"6",y:"2",width:"6",height:"8",rx:"3",fill:"currentColor",opacity:"0.5"})]}),n?"Left: details":"Left: select"]}),o.jsxs("div",{className:ve.hintRow,children:[o.jsxs("svg",{className:_t.hoverCard,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[o.jsx("rect",{x:"6",y:"2",width:"12",height:"20",rx:"6"}),o.jsx("path",{d:"M12 2v8"}),o.jsx("rect",{x:"12",y:"2",width:"6",height:"8",rx:"3",fill:"currentColor",opacity:"0.5"})]}),r?"Right: matches":p?"Right: back":"Right: fly to"]})]})})}),document.body)]})});function HI(e,t){const n=[];for(let r=0;r<e.length;r+=t)n.push(e.slice(r,r+t));return n}function df(e){const t=`${ue.base} ${ue.sizes.icon}`;return e?`${t} ${ue.variants.toggleActive}`:`${t} ${ue.variants.toggle}`}function yp({isResizing:e=!1}){const t=me(K=>K.reconstruction),n=me(K=>K.loadedFiles),r=me(K=>K.imageUrlBase),s=G(K=>K.openImageDetail),i=G(K=>K.setMatchedImageId),a=G(K=>K.setShowMatchesInModal),l=G(K=>K.showMatches),c=G(K=>K.matchesDisplayMode),d=G(K=>K.matchesColor),h=G(K=>K.touchMode),u=Qn(K=>K.pendingDeletions),m=ce(K=>K.selectedImageId),g=ce(K=>K.setSelectedImageId),p=ce(K=>K.flyToImage),y=ce(K=>K.currentViewState),w=ce(K=>K.pushNavigationHistory),x=ce(K=>K.popNavigationHistory),v=ce(K=>K.peekNavigationHistory),k=ce(K=>K.flyToState),b=ce(K=>K.navigationHistory),[S,C]=f.useState(h?"list":"gallery"),[M,I]=f.useState(dl.default),[L,P]=f.useState("all"),[_,N]=f.useState("name"),[D,B]=f.useState("asc"),E=f.useRef(null),[Z,F]=f.useState(0),[$,T]=f.useState(0),z=f.useMemo(()=>{if(!t||m===null||!l)return new Set;const K=t.connectedImagesIndex.get(m);return K?new Set(K.keys()):new Set},[t,m,l]),H=f.useCallback(K=>{g(K)},[g]),O=f.useCallback(K=>{s(K)},[s]),J=f.useCallback(K=>{if(m!==null&&z.has(K)){a(!0),i(K),s(m),setTimeout(()=>i(K),0);return}const Le=v();if(y&&Le&&Le.toImageId===K){const fe=x();fe&&(k(fe.fromState),g(fe.fromImageId));return}if(t){const fe=t.images.get(K);if(fe){let ae;r?ae=Jn(fe.name):bn()?ae=Vn(fe.name)??void 0:ae=Zr(n?.imageFiles,fe.name),ae&&Kl(ae,fe.name)}}y&&w({fromState:y,fromImageId:m,toImageId:K}),g(K),p(K)},[g,p,y,v,x,w,k,m,z,a,i,s,t,r,n]),re=f.useMemo(()=>b.length===0?null:b[b.length-1].toImageId,[b]);f.useEffect(()=>{P("all")},[t]);const[q,ie]=f.useState(!1),we=f.useRef(null);f.useEffect(()=>(ie(!0),ld(),we.current!==null&&clearTimeout(we.current),we.current=setTimeout(()=>{ie(!1),cd(),we.current=null},50),()=>{we.current!==null&&clearTimeout(we.current)}),[L,_,D,m]);const Ce=f.useMemo(()=>t?Array.from(t.cameras.values()).sort((K,Le)=>K.cameraId-Le.cameraId):[],[t]),Re=n?.imageFiles,ee=f.useMemo(()=>{if(!t)return[];const K=Array.from(t.images.values()).filter(fe=>L==="all"||fe.cameraId===L).map(fe=>{const ae=t.imageStats.get(fe.imageId),De=t.cameras.get(fe.cameraId);let Y;return r?Y=Jn(fe.name):bn()?Y=Vn(fe.name)??void 0:Y=Zr(Re,fe.name),{imageId:fe.imageId,name:fe.name,file:Y,numPoints2D:fe.numPoints2D??fe.points2D.length,numPoints3D:ae?.numPoints3D??0,cameraId:fe.cameraId,cameraWidth:De?.width??0,cameraHeight:De?.height??0,covisibleCount:ae?.covisibleCount??0,avgError:ae?.avgError??0}}),Le=D==="asc"?1:-1;return K.sort((fe,ae)=>_==="name"?Le*fe.name.localeCompare(ae.name):Le*(fe[_]-ae[_])),K},[t,Re,r,L,_,D,Z,$]),he=f.useRef(null),Se=f.useRef(null);f.useEffect(()=>{const K=E.current;if(!K||S!=="gallery")return;const Le=fe=>{if(!fe.shiftKey)return;fe.preventDefault();const ae=fe.deltaY>0?1:-1,De=he.current??M,Y=Math.max(dl.min,Math.min(dl.max,De+ae));he.current=Y,Se.current!==null&&clearTimeout(Se.current),Se.current=setTimeout(()=>{const W=he.current;he.current=null,Se.current=null,W!==null&&W!==M&&f.startTransition(()=>{I(W)})},rr.wheelDebounce)};return K.addEventListener("wheel",Le,{passive:!1,capture:!0}),()=>{K.removeEventListener("wheel",Le,{capture:!0}),Se.current!==null&&clearTimeout(Se.current)}},[S,M]);const xe=f.useMemo(()=>HI(ee,M),[ee,M]),Ae=f.useMemo(()=>ee.map(K=>[K]),[ee]),ye=Zu({count:xe.length,getScrollElement:()=>E.current,estimateSize:()=>lo.defaultCellHeight+Ds.gallery,overscan:rr.galleryOverscan}),Pe=Zu({count:Ae.length,getScrollElement:()=>E.current,estimateSize:()=>lo.listRowHeight+Ds.gallery,overscan:rr.listOverscan}),[Ye,$e]=f.useState(!1),qe=f.useRef(null),ct=S==="gallery"?ye.isScrolling:Pe.isScrolling;return f.useEffect(()=>(ct?(qe.current!==null&&(clearTimeout(qe.current),qe.current=null),$e(!0),ld()):qe.current===null&&(qe.current=setTimeout(()=>{$e(!1),cd(),qe.current=null},rr.transitionBase)),()=>{qe.current!==null&&clearTimeout(qe.current)}),[ct]),f.useEffect(()=>{if(!r||!t||Ye||q)return;const K=S==="gallery"?ye.getVirtualItems():Pe.getVirtualItems(),Le=[];for(const De of K){const Y=S==="gallery"?xe[De.index]||[]:[ee[De.index]].filter(Boolean);for(const W of Y)W&&!Jn(W.name)&&Le.push(W.name)}if(Le.length===0)return;let fe=!1;return(async()=>{for(let Y=0;Y<Le.length&&!fe;Y+=5){const W=Le.slice(Y,Y+5),le=await Promise.all(W.map(Q=>ks(r,Q)));!fe&&le.some(Q=>Q!==null)&&F(Q=>Q+1)}})(),()=>{fe=!0}},[r,t,S,xe,ee,Ye,q,ye,Pe]),f.useEffect(()=>{if(r||!bn()||!t||Ye||q)return;const K=S==="gallery"?ye.getVirtualItems():Pe.getVirtualItems(),Le=[];for(const De of K){const Y=S==="gallery"?xe[De.index]||[]:[ee[De.index]].filter(Boolean);for(const W of Y)W&&!Vn(W.name)&&Le.push(W.name)}if(Le.length===0)return;let fe=!1;return(async()=>{for(let Y=0;Y<Le.length&&!fe;Y+=5){const W=Le.slice(Y,Y+5),le=await Promise.all(W.map(Q=>gs(Q)));!fe&&le.some(Q=>Q!==null)&&T(Q=>Q+1)}})(),()=>{fe=!0}},[r,t,S,xe,ee,Ye,q,ye,Pe]),f.useEffect(()=>{if(m===null)return;const K=ee.findIndex(Le=>Le.imageId===m);if(K!==-1)if(S==="gallery"){const Le=Math.floor(K/M);ye.scrollToIndex(Le,{align:"center",behavior:"smooth"})}else Pe.scrollToIndex(K,{align:"center",behavior:"smooth"})},[m,ee,S,M,ye,Pe]),f.useEffect(()=>{const K=Le=>{if(Le.target instanceof HTMLInputElement||Le.target instanceof HTMLTextAreaElement||ee.length===0)return;const fe=Le.key;if(!["ArrowLeft","ArrowRight","ArrowUp","ArrowDown"].includes(fe))return;Le.preventDefault();const ae=m!==null?ee.findIndex(W=>W.imageId===m):-1;let De;if(S==="gallery")switch(fe){case"ArrowLeft":De=ae<=0?ee.length-1:ae-1;break;case"ArrowRight":De=ae>=ee.length-1?0:ae+1;break;case"ArrowUp":De=ae-M,De<0&&(De=ae);break;case"ArrowDown":De=ae+M,De>=ee.length&&(De=ae);break;default:return}else switch(fe){case"ArrowLeft":case"ArrowUp":De=ae<=0?ee.length-1:ae-1;break;case"ArrowRight":case"ArrowDown":De=ae>=ee.length-1?0:ae+1;break;default:return}ae===-1&&(De=fe==="ArrowLeft"||fe==="ArrowUp"?ee.length-1:0);const Y=ee[De].imageId;Le.shiftKey?J(Y):H(Y)};return window.addEventListener("keydown",K),()=>window.removeEventListener("keydown",K)},[ee,m,S,M,H,J]),t?ee.length===0?o.jsx("div",{className:Un.container,children:"No images found"}):o.jsxs("div",{className:"h-full flex flex-col bg-ds-secondary",children:[o.jsxs("div",{className:"flex flex-nowrap items-center justify-between gap-1 py-1 pl-0.5 pr-1 bg-ds-tertiary",children:[o.jsx("div",{className:`${gl.group} min-w-0`,children:o.jsxs("select",{value:L,onChange:K=>P(K.target.value==="all"?"all":parseInt(K.target.value)),className:`${nn.select} ${nn.sizes.sm}`,children:[o.jsxs("option",{value:"all",children:["All Cams (",Ce.length,")"]}),Ce.map(K=>o.jsxs("option",{value:K.cameraId,children:["Cam ",K.cameraId," (",K.width,"Ã—",K.height,")"]},K.cameraId))]})}),o.jsxs("div",{className:`${gl.group} flex-nowrap`,children:[o.jsxs("select",{value:_,onChange:K=>N(K.target.value),className:`${nn.select} ${nn.sizes.sm}`,children:[o.jsx("option",{value:"name",children:"Sort: Name"}),o.jsx("option",{value:"imageId",children:"Sort: Image ID"}),o.jsx("option",{value:"avgError",children:"Sort: Avg Error"}),o.jsx("option",{value:"covisibleCount",children:"Sort: Covisible"}),o.jsx("option",{value:"numPoints3D",children:"Sort: 3D Points"}),o.jsx("option",{value:"numPoints2D",children:"Sort: 2D Points"})]}),o.jsx("button",{onClick:()=>B(K=>K==="asc"?"desc":"asc"),className:`${ue.base} ${ue.sizes.icon} ${ue.variants.toggle}`,...Mh(D==="asc"?"Ascending":"Descending","bottom"),children:D==="asc"?o.jsx(Ik,{className:"w-4 h-4"}):o.jsx(Mk,{className:"w-4 h-4"})})]}),!h&&o.jsx("div",{className:`${gl.group} ml-auto`,children:o.jsxs("div",{className:"flex items-center gap-1",children:[o.jsx("button",{onClick:()=>C("gallery"),className:df(S==="gallery"),"data-tooltip":"Grid view (Shift+{SCROLL} to resize)",children:o.jsx(Sk,{className:"w-4 h-4"})}),o.jsx("button",{onClick:()=>C("list"),className:df(S==="list"),"data-tooltip":"List view with stats",children:o.jsx(kk,{className:"w-4 h-4"})})]})})]}),o.jsx("div",{ref:E,className:"flex-1 overflow-auto min-h-0 relative p-2",children:S==="gallery"?o.jsx("div",{style:{height:ye.getTotalSize(),width:"100%",position:"relative"},children:ye.getVirtualItems().map(K=>{const Le=xe[K.index];return o.jsx("div",{ref:ye.measureElement,"data-index":K.index,style:{position:"absolute",top:0,left:0,width:"100%",transform:`translateY(${K.start}px)`,display:"grid",gridTemplateColumns:`repeat(${M}, 1fr)`,gap:Ds.gallery,paddingBottom:Ds.gallery,willChange:"transform"},children:Le.map(fe=>o.jsx(BI,{img:fe,isSelected:m===fe.imageId,isMatched:z.has(fe.imageId),isMarkedForDeletion:u.has(fe.imageId),matchesColor:d,matchesBlink:l&&c==="blink",onClick:H,onDoubleClick:O,onRightClick:J,isScrolling:Ye,skipImages:!1,isSettling:q,isResizing:e,wouldGoBack:fe.imageId===re,touchMode:h},fe.imageId))},K.key)})}):o.jsx("div",{style:{height:Pe.getTotalSize(),width:"100%",position:"relative"},children:Pe.getVirtualItems().map(K=>{const Le=Ae[K.index][0];return o.jsx("div",{style:{position:"absolute",top:0,left:0,width:"100%",transform:`translateY(${K.start}px)`,willChange:"transform"},children:o.jsx(UI,{img:Le,isSelected:m===Le.imageId,isMatched:z.has(Le.imageId),isMarkedForDeletion:u.has(Le.imageId),matchesColor:d,matchesBlink:l&&c==="blink",onClick:H,onDoubleClick:O,onRightClick:J,isScrolling:Ye,skipImages:!1,isSettling:q,isResizing:e,wouldGoBack:Le.imageId===re,touchMode:h})},K.key)})})})]}):o.jsx("div",{className:Un.container,children:"Load COLMAP data to view images"})}function uu(e){const t=e.message.toLowerCase(),n=e.name.toLowerCase();return t.includes("context lost")||t.includes("webgl")||t.includes("gl_")?"webgl_context_lost":t.includes("shader")||t.includes("render")||t.includes("draw")||t.includes("buffer")||t.includes("three")?"webgl_render_error":t.includes("image")||t.includes("load")||t.includes("decode")||t.includes("blob")?"image_load_error":n.includes("networkerror")||t.includes("fetch")||t.includes("network")||t.includes("timeout")||t.includes("cors")?"network_error":"unknown"}function WI(e){switch(e){case"webgl_context_lost":return"retry";case"webgl_render_error":return"reload";case"image_load_error":return"retry";case"network_error":return"retry";default:return"dismiss"}}const ff={webgl_context_lost:{title:"3D View Error",message:"The graphics context was lost. This can happen when the system is under heavy load or the browser tab was inactive for a while.",retryLabel:"Retry",reloadLabel:"Reload Page"},webgl_render_error:{title:"3D Rendering Error",message:"Failed to render the 3D scene. This may be due to an unsupported graphics feature or driver issue.",retryLabel:"Retry",reloadLabel:"Reload Page"},image_load_error:{title:"Image Loading Error",message:"Failed to load one or more images. Please check that the image files are accessible.",retryLabel:"Retry Loading"},network_error:{title:"Network Error",message:"Failed to connect to the server. Please check your internet connection and try again.",retryLabel:"Retry"},unknown:{title:"Something went wrong",message:"An unexpected error occurred. Please try again or reload the page.",retryLabel:"Retry",reloadLabel:"Reload Page"}};function ys(e){return ff[e]??ff.unknown}const VI={modalError:"Modal closed due to an error. Click to reopen."};class vp extends f.Component{constructor(t){super(t),this.state={hasError:!1,error:null,errorType:null}}static getDerivedStateFromError(t){const n=uu(t);return{hasError:!0,error:t,errorType:n}}componentDidCatch(t,n){console.error("GalleryErrorBoundary caught an error:",t,n)}handleRetry=()=>{this.setState({hasError:!1,error:null,errorType:null})};render(){const{children:t}=this.props,{hasError:n,error:r,errorType:s}=this.state;if(n){const i=ys(s||"image_load_error");return o.jsxs("div",{className:"h-full flex flex-col items-center justify-center p-4 text-center bg-ds-secondary",children:[o.jsx("div",{className:"text-ds-error text-3xl mb-3",children:"!"}),o.jsx("h3",{className:"text-sm font-medium text-ds-primary mb-2",children:"Gallery Error"}),o.jsx("p",{className:"text-xs text-ds-secondary mb-4 max-w-xs",children:r?.message??i.message}),o.jsx("button",{onClick:this.handleRetry,className:`${ue.base} ${ue.sizes.sm} ${ue.variants.secondary}`,children:"Retry Loading Gallery"})]})}return t}}function ZI({onClose:e}){const t=f.useRef(null),n=f.useRef(null),r=f.useRef(0),s=f.useRef(0),i=f.useCallback(c=>{n.current=c.touches[0].clientX,r.current=0},[]),a=f.useCallback(c=>{if(n.current===null)return;const d=c.touches[0].clientX-n.current;if(d>0){r.current=d,t.current&&(t.current.style.transform=`translateX(${d}px)`);const h=Math.min(100,It.drawerWidth*.3),u=Math.min(1,d/h);s.current=u}},[]),l=f.useCallback(()=>{if(n.current===null)return;const c=Math.min(100,It.drawerWidth*.3);r.current>c?e():t.current&&(t.current.style.transform=""),n.current=null,r.current=0,s.current=0},[e]);return f.useEffect(()=>{const c=t.current;if(c)return c.addEventListener("touchstart",i,{passive:!0}),c.addEventListener("touchmove",a,{passive:!0}),c.addEventListener("touchend",l,{passive:!0}),()=>{c.removeEventListener("touchstart",i),c.removeEventListener("touchmove",a),c.removeEventListener("touchend",l)}},[i,a,l]),f.useEffect(()=>(document.body.style.overflow="hidden",()=>{document.body.style.overflow=""}),[]),o.jsxs(o.Fragment,{children:[o.jsx("div",{className:"fixed inset-0 z-[997] bg-ds-void/50 backdrop-blur-sm",onClick:e,"aria-hidden":"true"}),o.jsx("div",{ref:t,className:"fixed inset-y-0 right-0 z-[998] bg-ds-secondary border-l border-ds shadow-ds-lg flex flex-col",style:{width:`min(${It.drawerWidth}px, 85vw)`},role:"dialog","aria-modal":"true","aria-label":"Image gallery",children:o.jsx("div",{className:"flex-1 overflow-hidden",children:o.jsx(vp,{children:o.jsx(yp,{isResizing:!1})})})})]})}function du(){const e=Vt(c=>c.showPointCloud),t=Vt(c=>c.pointOpacity),n=Vt(c=>c.pointSize),r=Vt(c=>c.colorMode),s=Vt(c=>c.minTrackLength),i=Vt(c=>c.maxReprojectionError),a=Vt(c=>c.thinning),l=Vt(c=>c.selectedPointId);return f.useMemo(()=>({nodeType:"points",visible:e,opacity:t,size:n,colorMode:r,minTrackLength:s,maxReprojectionError:i===1/0?null:i,thinning:a,selectedPointId:l}),[e,t,n,r,s,i,a,l])}function yi(){const e=ce(d=>d.showCameras),t=ce(d=>d.cameraDisplayMode),n=ce(d=>d.cameraScale),r=ce(d=>d.cameraScaleFactor),s=ce(d=>d.frustumColorMode),i=ce(d=>d.frustumSingleColor),a=ce(d=>d.frustumStandbyOpacity),l=ce(d=>d.undistortionEnabled),c=ce(d=>d.undistortionMode);return f.useMemo(()=>({nodeType:"cameras",visible:e,displayMode:t,scale:n,scaleFactor:r,colorMode:s,singleColor:i,standbyOpacity:a,undistortionEnabled:l,undistortionMode:c}),[e,t,n,r,s,i,a,l,c])}function js(){const e=ce(l=>l.showSelectionHighlight),t=ce(l=>l.selectionColorMode),n=ce(l=>l.selectionColor),r=ce(l=>l.selectionAnimationSpeed),s=ce(l=>l.selectionPlaneOpacity),i=ce(l=>l.unselectedCameraOpacity),a=ce(l=>l.selectedImageId);return f.useMemo(()=>({nodeType:"selection",visible:e,colorMode:t,color:n,animationSpeed:r,planeOpacity:s,unselectedOpacity:i,selectedImageId:a}),[e,t,n,r,s,i,a])}function Ga(){const e=ce(p=>p.cameraMode),t=ce(p=>p.cameraProjection),n=ce(p=>p.cameraFov),r=ce(p=>p.horizonLock),s=ce(p=>p.autoRotateMode),i=ce(p=>p.autoRotateSpeed),a=ce(p=>p.flySpeed),l=ce(p=>p.flyTransitionDuration),c=ce(p=>p.pointerLock),d=ce(p=>p.autoFovEnabled),h=ce(p=>p.flyToImageId),u=ce(p=>p.flyToViewState),m=ce(p=>p.currentViewState),g=ce(p=>p.navigationHistory);return f.useMemo(()=>({nodeType:"navigation",mode:e,projection:t,fov:n,horizonLock:r,autoRotateMode:s,autoRotateSpeed:i,flySpeed:a,flyTransitionDuration:l,pointerLock:c,autoFovEnabled:d,flyToImageId:h,flyToViewState:u,currentViewState:m,navigationHistory:g}),[e,t,n,r,s,i,a,l,c,d,h,u,m,g])}function qa(){const e=G(s=>s.showMatches),t=G(s=>s.matchesDisplayMode),n=G(s=>s.matchesOpacity),r=G(s=>s.matchesColor);return f.useMemo(()=>({nodeType:"matches",visible:e,displayMode:t,opacity:n,color:r}),[e,t,n,r])}function wp(){const e=Bn(i=>i.showRig),t=Bn(i=>i.rigDisplayMode),n=Bn(i=>i.rigColorMode),r=Bn(i=>i.rigLineColor),s=Bn(i=>i.rigLineOpacity);return f.useMemo(()=>({nodeType:"rig",visible:e,displayMode:t,colorMode:n,color:r,opacity:s}),[e,t,n,r,s])}function Xa(){const e=G(s=>s.showAxes),t=G(s=>s.axesCoordinateSystem),n=G(s=>s.axesScale),r=G(s=>s.axisLabelMode);return f.useMemo(()=>({nodeType:"axes",visible:e,coordinateSystem:t,scale:n,labelMode:r}),[e,t,n,r])}function bp(){const e=G(n=>n.showGrid),t=G(n=>n.gridScale);return f.useMemo(()=>({nodeType:"grid",visible:e,scale:t}),[e,t])}function YI(){const e=G(t=>t.showGizmo);return f.useMemo(()=>({nodeType:"gizmo",visible:e}),[e])}function fu(){return f.useMemo(()=>({setVisible:e=>Vt.getState().setShowPointCloud(e),setOpacity:e=>Vt.getState().setPointOpacity(e),setSize:e=>Vt.getState().setPointSize(e),setColorMode:e=>Vt.getState().setColorMode(e),setMinTrackLength:e=>Vt.getState().setMinTrackLength(e),setMaxReprojectionError:e=>Vt.getState().setMaxReprojectionError(e??1/0),setThinning:e=>Vt.getState().setThinning(e),setSelectedPointId:e=>Vt.getState().setSelectedPointId(e),toggleVisible:()=>Vt.getState().togglePointCloud()}),[])}function hu(){return f.useMemo(()=>({setVisible:e=>ce.getState().setShowCameras(e),setDisplayMode:e=>ce.getState().setCameraDisplayMode(e),setScale:e=>ce.getState().setCameraScale(e),setScaleFactor:e=>ce.getState().setCameraScaleFactor(e),setColorMode:e=>ce.getState().setFrustumColorMode(e),setSingleColor:e=>ce.getState().setFrustumSingleColor(e),setStandbyOpacity:e=>ce.getState().setFrustumStandbyOpacity(e),setUndistortionEnabled:e=>ce.getState().setUndistortionEnabled(e),setUndistortionMode:e=>ce.getState().setUndistortionMode(e),toggleVisible:()=>ce.getState().toggleCameras()}),[])}function mu(){return f.useMemo(()=>({setVisible:e=>ce.getState().setShowSelectionHighlight(e),setColorMode:e=>ce.getState().setSelectionColorMode(e),setColor:e=>ce.getState().setSelectionColor(e),setAnimationSpeed:e=>ce.getState().setSelectionAnimationSpeed(e),setPlaneOpacity:e=>ce.getState().setSelectionPlaneOpacity(e),setUnselectedOpacity:e=>ce.getState().setUnselectedCameraOpacity(e),setSelectedImageId:e=>ce.getState().setSelectedImageId(e),toggleSelectedImageId:e=>ce.getState().toggleSelectedImageId(e),toggleVisible:()=>ce.getState().toggleSelectionHighlight()}),[])}function Ka(){return f.useMemo(()=>({setMode:e=>ce.getState().setCameraMode(e),setProjection:e=>ce.getState().setCameraProjection(e),setFov:e=>ce.getState().setCameraFov(e),setHorizonLock:e=>ce.getState().setHorizonLock(e),setAutoRotateMode:e=>ce.getState().setAutoRotateMode(e),setAutoRotateSpeed:e=>ce.getState().setAutoRotateSpeed(e),setFlySpeed:e=>ce.getState().setFlySpeed(e),setFlyTransitionDuration:e=>ce.getState().setFlyTransitionDuration(e),setPointerLock:e=>ce.getState().setPointerLock(e),setAutoFovEnabled:e=>ce.getState().setAutoFovEnabled(e),flyToImage:e=>ce.getState().flyToImage(e),flyToState:e=>ce.getState().flyToState(e),clearFlyTo:()=>ce.getState().clearFlyTo(),clearFlyToViewState:()=>ce.getState().clearFlyToViewState(),setCurrentViewState:e=>ce.getState().setCurrentViewState(e),pushNavigationHistory:e=>ce.getState().pushNavigationHistory(e),popNavigationHistory:()=>ce.getState().popNavigationHistory(),peekNavigationHistory:()=>ce.getState().peekNavigationHistory(),clearNavigationHistory:()=>ce.getState().clearNavigationHistory()}),[])}function Cp(){return f.useMemo(()=>({setVisible:e=>G.getState().setShowMatches(e),setDisplayMode:e=>G.getState().setMatchesDisplayMode(e),setOpacity:e=>G.getState().setMatchesOpacity(e),setColor:e=>G.getState().setMatchesColor(e),toggleVisible:()=>G.getState().toggleMatches()}),[])}function GI(){return f.useMemo(()=>({setVisible:e=>Bn.getState().setShowRig(e),setDisplayMode:e=>Bn.getState().setRigDisplayMode(e),setColorMode:e=>Bn.getState().setRigColorMode(e),setColor:e=>Bn.getState().setRigLineColor(e),setOpacity:e=>Bn.getState().setRigLineOpacity(e),toggleVisible:()=>Bn.getState().toggleRig()}),[])}function Qa(){return f.useMemo(()=>({setVisible:e=>G.getState().setShowAxes(e),setCoordinateSystem:e=>G.getState().setAxesCoordinateSystem(e),setScale:e=>G.getState().setAxesScale(e),setLabelMode:e=>G.getState().setAxisLabelMode(e),toggleVisible:()=>G.getState().toggleAxes()}),[])}function qI(){return f.useMemo(()=>({setVisible:e=>G.getState().setShowGrid(e),setScale:e=>G.getState().setGridScale(e),toggleVisible:()=>G.getState().toggleGrid()}),[])}function XI(){return f.useMemo(()=>({setVisible:e=>G.getState().setShowGizmo(e),toggleVisible:()=>G.getState().toggleGizmo()}),[])}const KI=new Er;function Ao(e){return e<=Ns.threshold?e/Ns.linearScale:Math.pow((e+Ns.gammaOffset)/Ns.gammaScale,Ns.gamma)}function gc(e){const t=e%1;return KI.setHSL(t,Wr.saturation,Wr.lightness)}function ai(e){const{threshold1:t,threshold2:n,threshold3:r,multiplier:s}=$a.jet;return e=Math.max(0,Math.min(1,e)),e<t?[0,e*s,1]:e<n?[0,1,1-(e-t)*s]:e<r?[(e-n)*s,1,0]:[1,1-(e-r)*s,0]}function es(e,t,n){t/=100,n/=100;const r=t*Math.min(n,1-n),s=i=>{const a=(i+e/30)%12,l=n-r*Math.max(Math.min(a-3,9-a,1),-1);return Math.round(255*l).toString(16).padStart(2,"0")};return`#${s(0)}${s(8)}${s(4)}`}function wo(e){const t=parseInt(e.slice(1,3),16)/255,n=parseInt(e.slice(3,5),16)/255,r=parseInt(e.slice(5,7),16)/255,s=Math.max(t,n,r),i=Math.min(t,n,r);let a=0,l=0;const c=(s+i)/2;if(s!==i){const d=s-i;switch(l=c>.5?d/(2-s-i):d/(s+i),s){case t:a=((n-r)/d+(n<r?6:0))/6;break;case n:a=((r-t)/d+2)/6;break;case r:a=((t-n)/d+4)/6;break}}return{h:Math.round(a*360),s:Math.round(l*100),l:Math.round(c*100)}}function QI(e,t,n){const{wasmColors:r,wasmErrors:s,wasmTrackLengths:i,minError:a,maxError:l,minTrack:c,maxTrack:d,floorColorMode:h,pointDistances:u,distanceThreshold:m,maxFloorDist:g}=n;if(h!=="off"&&u){if(h==="binary")return Math.abs(u[e])<=m?[.2,.9,.2]:[.9,.2,.2];const p=Math.abs(u[e])/g;return ai(p)}if(t==="error"){const p=s[e]>=0?(s[e]-a)/(l-a):0;return ai(p)}if(t==="trackLength"){const{baseR:p,rangeR:y,baseG:w,rangeG:x,baseB:v,rangeB:k}=$a.trackLength,b=(i[e]-c)/(d-c);return[p+b*y,w+b*x,v-b*k]}return r?[Ao(r[e*3]),Ao(r[e*3+1]),Ao(r[e*3+2])]:[1,1,1]}function JI(e,t,n){const{minError:r,maxError:s,minTrack:i,maxTrack:a}=n;if(t==="error"){const l=e.error>=0?(e.error-r)/(s-r):0;return ai(l)}if(t==="trackLength"){const{baseR:l,rangeR:c,baseG:d,rangeG:h,baseB:u,rangeB:m}=$a.trackLength,g=(e.track.length-i)/(a-i);return[l+g*c,d+g*h,u-g*m]}return[Ao(e.rgb[0]/ml.max),Ao(e.rgb[1]/ml.max),Ao(e.rgb[2]/ml.max)]}function eM(e,t,n,r,s){const i=new Float32Array(e*3);if(t==="rgb")if(n)for(let a=0;a<n.length;a++)i[a]=Ao(n[a]);else i.fill(1);else if(t==="error")if(r){let a=1/0,l=-1/0;for(let c=0;c<e;c++)r[c]>=0&&(a=Math.min(a,r[c]),l=Math.max(l,r[c]));a===l&&(l=a+1);for(let c=0;c<e;c++){const d=r[c]>=0?(r[c]-a)/(l-a):0,[h,u,m]=ai(d);i[c*3]=h,i[c*3+1]=u,i[c*3+2]=m}}else i.fill(1);else if(s){let a=1/0,l=-1/0;for(let p=0;p<e;p++)a=Math.min(a,s[p]),l=Math.max(l,s[p]);a===l&&(l=a+1);const{baseR:c,rangeR:d,baseG:h,rangeG:u,baseB:m,rangeB:g}=$a.trackLength;for(let p=0;p<e;p++){const y=(s[p]-a)/(l-a);i[p*3]=c+y*d,i[p*3+1]=h+y*u,i[p*3+2]=m-y*g}}else i.fill(1);return i}function tM(e,t,n,r,s){if(n==="binary")for(let i=0;i<t;i++){const a=Math.abs(r[i])<=s;e[i*3]=a?.2:.9,e[i*3+1]=a?.9:.2,e[i*3+2]=.2}else{let i=0;for(let a=0;a<t;a++)i=Math.max(i,Math.abs(r[a]));i===0&&(i=1);for(let a=0;a<t;a++){const l=Math.abs(r[a])/i,[c,d,h]=ai(l);e[a*3]=c,e[a*3+1]=d,e[a*3+2]=h}}}function nM(e){const{reconstruction:t,wasmReconstruction:n,colorMode:r,minTrackLength:s,maxReprojectionError:i,thinning:a,selectedImageId:l,showSelectionHighlight:c,selectionColor:d,floorColorMode:h,pointDistances:u,distanceThreshold:m}=e,g=f.useRef(new Map),p=f.useMemo(()=>{const k=new Er(d);return[k.r,k.g,k.b]},[d]),{positions:y,colors:w,selectedPositions:x,selectedColors:v}=f.useMemo(()=>{if(!t)return g.current=new Map,{positions:null,colors:null,selectedPositions:null,selectedColors:null};const k=s<=1&&i>=1e3&&a===0;if(n?.hasPoints()&&k){const S=rM(n,t,r,l,c,p,h,u,m,g);if(S)return S}return sM(t,n,r,s,i,a,l,c,p,h,u,m,g)},[t,n,r,s,i,a,l,c,p,u,m,h]);return{positions:y,colors:w,selectedPositions:x,selectedColors:v,indexToPoint3DId:g.current,indexToPoint3DIdRef:g}}function rM(e,t,n,r,s,i,a,l,c,d){const h=e.pointCount,u=new Map;for(let b=0;b<h;b++)u.set(b,BigInt(b+1));d.current&&(d.current=u);const m=e.getPositions();if(!m||m.length===0)return console.warn("[PointCloud] WASM positions not available or empty, falling back to slow path"),null;if(!Number.isFinite(m[0]))return console.warn("[PointCloud] WASM positions array is invalid (NaN), falling back to slow path"),null;const g=e.getColors(),p=e.getErrors(),y=e.getTrackLengths(),w=eM(h,n,g,p,y);a!=="off"&&l&&l.length===h&&tM(w,h,a,l,c);let x=null,v=null;if(s&&r!==null){const b=oM(e,t,r,m,i);x=b.selectedPositions,v=b.selectedColors}return{positions:new Float32Array(m),colors:w,selectedPositions:x,selectedColors:v}}function oM(e,t,n,r,s){const i=t.imageToPoint3DIds.get(n)??new Set;if(i.size===0)return{selectedPositions:null,selectedColors:null};const a=e.pointCount,l=e.getPoint3DIds();let c=0;for(let m=0;m<a;m++){const g=l?l[m]:BigInt(m+1);i.has(g)&&c++}if(c===0)return{selectedPositions:null,selectedColors:null};const d=new Float32Array(c*3),h=new Float32Array(c*3);let u=0;for(let m=0;m<a;m++){const g=l?l[m]:BigInt(m+1);if(i.has(g)){const p=u*3;d[p]=r[m*3],d[p+1]=r[m*3+1],d[p+2]=r[m*3+2],h[p]=s[0],h[p+1]=s[1],h[p+2]=s[2],u++}}return{selectedPositions:d,selectedColors:h}}function sM(e,t,n,r,s,i,a,l,c,d,h,u,m){const g=a!==null?e.imageToPoint3DIds.get(a)??new Set:new Set;if(t?.hasPoints()){const p=iM(t,n,r,s,i,g,l,c,d,h,u,m);if(p)return p}return aM(e,n,r,s,i,g,l,c,m)}function iM(e,t,n,r,s,i,a,l,c,d,h,u){const m=e.pointCount,g=e.getPositions(),p=e.getColors(),y=e.getErrors(),w=e.getTrackLengths(),x=e.getPoint3DIds();if(!g||!y||!w)return null;if(g.length===0||!Number.isFinite(g[0]))return console.warn("[PointCloud] WASM slow path: positions array is invalid"),null;let v=1/0,k=-1/0,b=1/0,S=-1/0,C=0,M=0;const I=new Uint8Array(m);for(let $=0;$<m;$++){if(s>0&&$%(s+1)!==0||w[$]<n||y[$]>r)continue;y[$]>=0&&(v=Math.min(v,y[$]),k=Math.max(k,y[$])),b=Math.min(b,w[$]),S=Math.max(S,w[$]);const T=x?x[$]:BigInt($+1),z=a&&i.has(T);I[$]=z?2:1,C++,z&&M++}if(C===0)return u.current&&(u.current=new Map),{positions:null,colors:null,selectedPositions:null,selectedColors:null};v===k&&(k=v+1),b===S&&(S=b+1);let L=0;if(c==="distance"&&d){for(let $=0;$<m;$++)I[$]>0&&(L=Math.max(L,Math.abs(d[$])));L===0&&(L=1)}const P={wasmColors:p,wasmErrors:y,wasmTrackLengths:w,minError:v,maxError:k,minTrack:b,maxTrack:S,floorColorMode:c,pointDistances:d,distanceThreshold:h,maxFloorDist:L},_=new Float32Array(C*3),N=new Float32Array(C*3),D=M>0?new Float32Array(M*3):null,B=M>0?new Float32Array(M*3):null,E=new Map;let Z=0,F=0;for(let $=0;$<m;$++){const T=I[$];if(T===0)continue;const z=Z*3;_[z]=g[$*3],_[z+1]=g[$*3+1],_[z+2]=g[$*3+2];const H=QI($,t,P);N[z]=H[0],N[z+1]=H[1],N[z+2]=H[2];const O=x?x[$]:BigInt($+1);if(E.set(Z,O),Z++,T===2&&D&&B){const J=F*3;D[J]=g[$*3],D[J+1]=g[$*3+1],D[J+2]=g[$*3+2],B[J]=l[0],B[J+1]=l[1],B[J+2]=l[2],F++}}return u.current&&(u.current=E),{positions:_,colors:N,selectedPositions:D,selectedColors:B}}function aM(e,t,n,r,s,i,a,l,c){if(!e.points3D||e.points3D.size===0)return console.warn("[PointCloud] No points3D Map and WASM not available"),c.current&&(c.current=new Map),{positions:null,colors:null,selectedPositions:null,selectedColors:null};let d=1/0,h=-1/0,u=1/0,m=-1/0;const g=[],p=[];let y=0;for(const C of e.points3D.values()){if(s>0&&y%(s+1)!==0){y++;continue}if(y++,C.track.length<n||C.error>r)continue;C.error>=0&&(d=Math.min(d,C.error),h=Math.max(h,C.error)),u=Math.min(u,C.track.length),m=Math.max(m,C.track.length),g.push(C);const M=i.has(C.point3DId);a&&M&&p.push(C)}if(g.length===0)return c.current&&(c.current=new Map),{positions:null,colors:null,selectedPositions:null,selectedColors:null};d===h&&(h=d+1),u===m&&(m=u+1);const w={minError:d,maxError:h,minTrack:u,maxTrack:m},x=new Map,v=new Float32Array(g.length*3),k=new Float32Array(g.length*3);for(let C=0;C<g.length;C++){const M=g[C],I=C*3;v[I]=M.xyz[0],v[I+1]=M.xyz[1],v[I+2]=M.xyz[2];const L=JI(M,t,w);k[I]=L[0],k[I+1]=L[1],k[I+2]=L[2],x.set(C,M.point3DId)}c.current&&(c.current=x);let b=null,S=null;if(p.length>0){b=new Float32Array(p.length*3),S=new Float32Array(p.length*3);for(let C=0;C<p.length;C++){const M=p[C],I=C*3;b[I]=M.xyz[0],b[I+1]=M.xyz[1],b[I+2]=M.xyz[2],S[I]=l[0],S[I+1]=l[1],S[I+2]=l[2]}}return{positions:v,colors:k,selectedPositions:b,selectedColors:S}}function lM(e){const{pickingMode:t,selectedPointsLength:n,pointSize:r,indexToPoint3DIdRef:s,addSelectedPoint:i,setHoveredPoint:a}=e,{camera:l,gl:c,raycaster:d}=mr(),h=f.useRef(null),u=f.useRef(new Ec),m=f.useRef(0),g=f.useRef(!1),p=f.useRef(new X),y=f.useRef(null),w=cM(t),x=t!=="off"&&n<w,v=f.useCallback(b=>{const S=h.current;if(!S||b.length===0)return null;let C=-1,M=1/0,I=null;for(let L=0;L<b.length;L++){const P=b[L];if(P.object!==S||P.index===void 0)continue;const _=P.distanceToRay??1/0;_<M&&(M=_,C=P.index,I=P.point)}return C===-1||!I?null:(p.current.copy(I),{index:C,worldPos:p.current})},[]);f.useEffect(()=>{if(t==="off")return;const b=c.domElement,S=b.getBoundingClientRect();function C(I){u.current.x=(I.clientX-S.left)/S.width*2-1,u.current.y=-((I.clientY-S.top)/S.height)*2+1,g.current=!0}function M(){g.current=!1,y.current!==null&&(y.current=null,a(null))}return b.addEventListener("mousemove",C,{passive:!0}),b.addEventListener("mouseleave",M),()=>{b.removeEventListener("mousemove",C),b.removeEventListener("mouseleave",M)}},[t,c,a]),pr(()=>{if(t==="off"||!g.current||!h.current||n>=w)return;const b=performance.now();if(b-m.current<80)return;m.current=b,g.current=!1,d.setFromCamera(u.current,l);const S=d.intersectObject(h.current),C=v(S);if(C){const M=y.current;if(M&&M.distanceToSquared(C.worldPos)<1e-8)return;y.current=C.worldPos.clone(),a(y.current)}else y.current!==null&&(y.current=null,a(null))});const k=f.useCallback(b=>{if(t==="off"||!h.current||n>=w)return;b.stopPropagation();const S=v(b.intersections);if(!S)return;const C=s.current?.get(S.index);if(C===void 0)return;const M=b.nativeEvent;i({position:S.worldPos.clone(),point3DId:C},{x:M.clientX,y:M.clientY})},[t,n,w,i,v,s]);return f.useEffect(()=>{t!=="off"&&(d.params.Points.threshold=r*.3)},[t,r,d]),f.useEffect(()=>{t==="off"&&a(null)},[t,a]),{pointsRef:h,handlePointClick:k,needsMorePoints:x}}function cM(e){switch(e){case"origin-1pt":return 1;case"distance-2pt":return 2;case"normal-3pt":return 3;default:return 0}}function uM(e){const{selectedImageId:t,selectionColorMode:n,selectionAnimationSpeed:r,selectionColor:s}=e,i=f.useRef(null),a=f.useRef(0),l=f.useRef(new Er);return pr((c,d)=>{if(t!==null&&i.current)if(n==="rainbow")a.current=(a.current+d*r*Wr.speedMultiplier)%1,i.current.color.copy(gc(a.current)),i.current.opacity=1;else if(n==="blink"){const u=.1+.9*((Math.sin(c.clock.elapsedTime*r*2)+1)/2);l.current.set(s),i.current.color.setRGB(l.current.r*u,l.current.g*u,l.current.b*u)}else n==="static"&&(l.current.set(s),i.current.color.copy(l.current),i.current.opacity=1)}),f.useEffect(()=>{i.current&&(n==="rainbow"?(i.current.vertexColors=!1,i.current.color.copy(gc(a.current)),i.current.opacity=1,i.current.needsUpdate=!0):n==="blink"?(i.current.vertexColors=!1,i.current.color.set(s),i.current.transparent=!0,i.current.needsUpdate=!0):(i.current.vertexColors=!1,i.current.color.set(s),i.current.opacity=1,i.current.needsUpdate=!0))},[n,s]),{selectedMaterialRef:i}}function dM(e){const{selectedPositions:t,selectedColors:n,pointSize:r,selectedImageId:s,selectionColorMode:i,selectionAnimationSpeed:a,selectionColor:l}=e,{selectedMaterialRef:c}=uM({selectedImageId:s,selectionColorMode:i,selectionAnimationSpeed:a,selectionColor:l}),d=f.useMemo(()=>{if(!t||!n||t.length===0)return null;let h=!1;for(let m=0;m<t.length;m++)if(!Number.isFinite(t[m])){h=!0;break}if(h)return console.warn("[SelectionOverlay] Positions contain NaN/Infinity values, skipping geometry creation"),null;const u=new us;return u.setAttribute("position",new ha(t,3)),u.setAttribute("color",new ha(n,3)),u.computeBoundingSphere(),u},[t,n]);return f.useEffect(()=>()=>{d?.dispose()},[d]),d?o.jsx("points",{matrixAutoUpdate:!1,geometry:d,renderOrder:2,raycast:()=>{},children:o.jsx("pointsMaterial",{ref:c,size:r+1,vertexColors:!1,color:l,transparent:!0,sizeAttenuation:!1,depthTest:!1})}):o.jsx(o.Fragment,{})}function hf(){const e=me(H=>H.reconstruction),t=me(H=>H.wasmReconstruction),n=du(),r=js(),{visible:s,colorMode:i,size:a,opacity:l,minTrackLength:c,maxReprojectionError:d,thinning:h}=n,u=d??1/0,{selectedImageId:m,visible:g,colorMode:p,animationSpeed:y,color:w}=r,x=lt(H=>H.pickingMode),v=lt(H=>H.selectedPoints.length),k=lt(H=>H.addSelectedPoint),b=lt(H=>H.setHoveredPoint),S=Ct(H=>H.pointDistances),C=Ct(H=>H.distanceThreshold),M=Ct(H=>H.floorColorMode),I=Qn(H=>H.pendingDeletions),L=m!==null&&I.has(m)?null:m,{positions:P,colors:_,selectedPositions:N,selectedColors:D,indexToPoint3DIdRef:B}=nM({reconstruction:e,wasmReconstruction:t,colorMode:i,minTrackLength:c,maxReprojectionError:u,thinning:h,selectedImageId:L,showSelectionHighlight:g,selectionColor:w,floorColorMode:M,pointDistances:S,distanceThreshold:C}),{pointsRef:E,handlePointClick:Z,needsMorePoints:F}=lM({pickingMode:x,selectedPointsLength:v,pointSize:a,indexToPoint3DIdRef:B,addSelectedPoint:k,setHoveredPoint:b}),$=f.useMemo(()=>{if(!P||!_||P.length===0)return null;const H=new us;return H.setAttribute("position",new ha(P,3)),H.setAttribute("color",new ha(_,3)),H.computeBoundingSphere(),H},[P,_]);f.useEffect(()=>()=>{$?.dispose()},[$]);const T=$!==null,z=N!==null&&D!==null&&N.length>0;return!T&&!z?null:o.jsxs(o.Fragment,{children:[s&&$&&o.jsx("points",{ref:E,matrixAutoUpdate:!1,geometry:$,renderOrder:1,onClick:F?Z:void 0,children:o.jsx("pointsMaterial",{size:a,vertexColors:!0,sizeAttenuation:!1,transparent:!0,opacity:l})}),z&&N&&D&&o.jsx(dM,{selectedPositions:N,selectedColors:D,pointSize:a,selectedImageId:m,selectionColorMode:p,selectionAnimationSpeed:y,selectionColor:w})]})}const mf=new Pc,zi=new X;class Sp extends gg{constructor(){super(),this.isLineSegmentsGeometry=!0,this.type="LineSegmentsGeometry";const t=[-1,2,0,1,2,0,-1,1,0,1,1,0,-1,0,0,1,0,0,-1,-1,0,1,-1,0],n=[-1,2,1,2,-1,1,1,1,-1,-1,1,-1,-1,-2,1,-2],r=[0,2,1,2,3,1,2,4,3,4,5,3,4,6,5,6,7,5];this.setIndex(r),this.setAttribute("position",new Ks(t,3)),this.setAttribute("uv",new Ks(n,2))}applyMatrix4(t){const n=this.attributes.instanceStart,r=this.attributes.instanceEnd;return n!==void 0&&(n.applyMatrix4(t),r.applyMatrix4(t),n.needsUpdate=!0),this.boundingBox!==null&&this.computeBoundingBox(),this.boundingSphere!==null&&this.computeBoundingSphere(),this}setPositions(t){let n;t instanceof Float32Array?n=t:Array.isArray(t)&&(n=new Float32Array(t));const r=new Ul(n,6,1);return this.setAttribute("instanceStart",new Xo(r,3,0)),this.setAttribute("instanceEnd",new Xo(r,3,3)),this.instanceCount=this.attributes.instanceStart.count,this.computeBoundingBox(),this.computeBoundingSphere(),this}setColors(t){let n;t instanceof Float32Array?n=t:Array.isArray(t)&&(n=new Float32Array(t));const r=new Ul(n,6,1);return this.setAttribute("instanceColorStart",new Xo(r,3,0)),this.setAttribute("instanceColorEnd",new Xo(r,3,3)),this}fromWireframeGeometry(t){return this.setPositions(t.attributes.position.array),this}fromEdgesGeometry(t){return this.setPositions(t.attributes.position.array),this}fromMesh(t){return this.fromWireframeGeometry(new xg(t.geometry)),this}fromLineSegments(t){const n=t.geometry;return this.setPositions(n.attributes.position.array),this}computeBoundingBox(){this.boundingBox===null&&(this.boundingBox=new Pc);const t=this.attributes.instanceStart,n=this.attributes.instanceEnd;t!==void 0&&n!==void 0&&(this.boundingBox.setFromBufferAttribute(t),mf.setFromBufferAttribute(n),this.boundingBox.union(mf))}computeBoundingSphere(){this.boundingSphere===null&&(this.boundingSphere=new rh),this.boundingBox===null&&this.computeBoundingBox();const t=this.attributes.instanceStart,n=this.attributes.instanceEnd;if(t!==void 0&&n!==void 0){const r=this.boundingSphere.center;this.boundingBox.getCenter(r);let s=0;for(let i=0,a=t.count;i<a;i++)zi.fromBufferAttribute(t,i),s=Math.max(s,r.distanceToSquared(zi)),zi.fromBufferAttribute(n,i),s=Math.max(s,r.distanceToSquared(zi));this.boundingSphere.radius=Math.sqrt(s),isNaN(this.boundingSphere.radius)&&console.error("THREE.LineSegmentsGeometry.computeBoundingSphere(): Computed radius is NaN. The instanced position data is likely to have NaN values.",this)}}toJSON(){}}Yi.line={worldUnits:{value:1},linewidth:{value:1},resolution:{value:new Ec(1,1)},dashOffset:{value:0},dashScale:{value:1},dashSize:{value:1},gapSize:{value:1}};Gi.line={uniforms:oh.merge([Yi.common,Yi.fog,Yi.line]),vertexShader:`
		#include <common>
		#include <color_pars_vertex>
		#include <fog_pars_vertex>
		#include <logdepthbuf_pars_vertex>
		#include <clipping_planes_pars_vertex>

		uniform float linewidth;
		uniform vec2 resolution;

		attribute vec3 instanceStart;
		attribute vec3 instanceEnd;

		attribute vec3 instanceColorStart;
		attribute vec3 instanceColorEnd;

		#ifdef WORLD_UNITS

			varying vec4 worldPos;
			varying vec3 worldStart;
			varying vec3 worldEnd;

			#ifdef USE_DASH

				varying vec2 vUv;

			#endif

		#else

			varying vec2 vUv;

		#endif

		#ifdef USE_DASH

			uniform float dashScale;
			attribute float instanceDistanceStart;
			attribute float instanceDistanceEnd;
			varying float vLineDistance;

		#endif

		void trimSegment( const in vec4 start, inout vec4 end ) {

			// trim end segment so it terminates between the camera plane and the near plane

			// conservative estimate of the near plane
			float a = projectionMatrix[ 2 ][ 2 ]; // 3nd entry in 3th column
			float b = projectionMatrix[ 3 ][ 2 ]; // 3nd entry in 4th column
			float nearEstimate = - 0.5 * b / a;

			float alpha = ( nearEstimate - start.z ) / ( end.z - start.z );

			end.xyz = mix( start.xyz, end.xyz, alpha );

		}

		void main() {

			#ifdef USE_COLOR

				vColor.xyz = ( position.y < 0.5 ) ? instanceColorStart : instanceColorEnd;

			#endif

			#ifdef USE_DASH

				vLineDistance = ( position.y < 0.5 ) ? dashScale * instanceDistanceStart : dashScale * instanceDistanceEnd;
				vUv = uv;

			#endif

			float aspect = resolution.x / resolution.y;

			// camera space
			vec4 start = modelViewMatrix * vec4( instanceStart, 1.0 );
			vec4 end = modelViewMatrix * vec4( instanceEnd, 1.0 );

			#ifdef WORLD_UNITS

				worldStart = start.xyz;
				worldEnd = end.xyz;

			#else

				vUv = uv;

			#endif

			// special case for perspective projection, and segments that terminate either in, or behind, the camera plane
			// clearly the gpu firmware has a way of addressing this issue when projecting into ndc space
			// but we need to perform ndc-space calculations in the shader, so we must address this issue directly
			// perhaps there is a more elegant solution -- WestLangley

			bool perspective = ( projectionMatrix[ 2 ][ 3 ] == - 1.0 ); // 4th entry in the 3rd column

			if ( perspective ) {

				if ( start.z < 0.0 && end.z >= 0.0 ) {

					trimSegment( start, end );

				} else if ( end.z < 0.0 && start.z >= 0.0 ) {

					trimSegment( end, start );

				}

			}

			// clip space
			vec4 clipStart = projectionMatrix * start;
			vec4 clipEnd = projectionMatrix * end;

			// ndc space
			vec3 ndcStart = clipStart.xyz / clipStart.w;
			vec3 ndcEnd = clipEnd.xyz / clipEnd.w;

			// direction
			vec2 dir = ndcEnd.xy - ndcStart.xy;

			// account for clip-space aspect ratio
			dir.x *= aspect;
			dir = normalize( dir );

			#ifdef WORLD_UNITS

				vec3 worldDir = normalize( end.xyz - start.xyz );
				vec3 tmpFwd = normalize( mix( start.xyz, end.xyz, 0.5 ) );
				vec3 worldUp = normalize( cross( worldDir, tmpFwd ) );
				vec3 worldFwd = cross( worldDir, worldUp );
				worldPos = position.y < 0.5 ? start: end;

				// height offset
				float hw = linewidth * 0.5;
				worldPos.xyz += position.x < 0.0 ? hw * worldUp : - hw * worldUp;

				// don't extend the line if we're rendering dashes because we
				// won't be rendering the endcaps
				#ifndef USE_DASH

					// cap extension
					worldPos.xyz += position.y < 0.5 ? - hw * worldDir : hw * worldDir;

					// add width to the box
					worldPos.xyz += worldFwd * hw;

					// endcaps
					if ( position.y > 1.0 || position.y < 0.0 ) {

						worldPos.xyz -= worldFwd * 2.0 * hw;

					}

				#endif

				// project the worldpos
				vec4 clip = projectionMatrix * worldPos;

				// shift the depth of the projected points so the line
				// segments overlap neatly
				vec3 clipPose = ( position.y < 0.5 ) ? ndcStart : ndcEnd;
				clip.z = clipPose.z * clip.w;

			#else

				vec2 offset = vec2( dir.y, - dir.x );
				// undo aspect ratio adjustment
				dir.x /= aspect;
				offset.x /= aspect;

				// sign flip
				if ( position.x < 0.0 ) offset *= - 1.0;

				// endcaps
				if ( position.y < 0.0 ) {

					offset += - dir;

				} else if ( position.y > 1.0 ) {

					offset += dir;

				}

				// adjust for linewidth
				offset *= linewidth;

				// adjust for clip-space to screen-space conversion // maybe resolution should be based on viewport ...
				offset /= resolution.y;

				// select end
				vec4 clip = ( position.y < 0.5 ) ? clipStart : clipEnd;

				// back to clip space
				offset *= clip.w;

				clip.xy += offset;

			#endif

			gl_Position = clip;

			vec4 mvPosition = ( position.y < 0.5 ) ? start : end; // this is an approximation

			#include <logdepthbuf_vertex>
			#include <clipping_planes_vertex>
			#include <fog_vertex>

		}
		`,fragmentShader:`
		uniform vec3 diffuse;
		uniform float opacity;
		uniform float linewidth;

		#ifdef USE_DASH

			uniform float dashOffset;
			uniform float dashSize;
			uniform float gapSize;

		#endif

		varying float vLineDistance;

		#ifdef WORLD_UNITS

			varying vec4 worldPos;
			varying vec3 worldStart;
			varying vec3 worldEnd;

			#ifdef USE_DASH

				varying vec2 vUv;

			#endif

		#else

			varying vec2 vUv;

		#endif

		#include <common>
		#include <color_pars_fragment>
		#include <fog_pars_fragment>
		#include <logdepthbuf_pars_fragment>
		#include <clipping_planes_pars_fragment>

		vec2 closestLineToLine(vec3 p1, vec3 p2, vec3 p3, vec3 p4) {

			float mua;
			float mub;

			vec3 p13 = p1 - p3;
			vec3 p43 = p4 - p3;

			vec3 p21 = p2 - p1;

			float d1343 = dot( p13, p43 );
			float d4321 = dot( p43, p21 );
			float d1321 = dot( p13, p21 );
			float d4343 = dot( p43, p43 );
			float d2121 = dot( p21, p21 );

			float denom = d2121 * d4343 - d4321 * d4321;

			float numer = d1343 * d4321 - d1321 * d4343;

			mua = numer / denom;
			mua = clamp( mua, 0.0, 1.0 );
			mub = ( d1343 + d4321 * ( mua ) ) / d4343;
			mub = clamp( mub, 0.0, 1.0 );

			return vec2( mua, mub );

		}

		void main() {

			float alpha = opacity;
			vec4 diffuseColor = vec4( diffuse, alpha );

			#include <clipping_planes_fragment>

			#ifdef USE_DASH

				if ( vUv.y < - 1.0 || vUv.y > 1.0 ) discard; // discard endcaps

				if ( mod( vLineDistance + dashOffset, dashSize + gapSize ) > dashSize ) discard; // todo - FIX

			#endif

			#ifdef WORLD_UNITS

				// Find the closest points on the view ray and the line segment
				vec3 rayEnd = normalize( worldPos.xyz ) * 1e5;
				vec3 lineDir = worldEnd - worldStart;
				vec2 params = closestLineToLine( worldStart, worldEnd, vec3( 0.0, 0.0, 0.0 ), rayEnd );

				vec3 p1 = worldStart + lineDir * params.x;
				vec3 p2 = rayEnd * params.y;
				vec3 delta = p1 - p2;
				float len = length( delta );
				float norm = len / linewidth;

				#ifndef USE_DASH

					#ifdef USE_ALPHA_TO_COVERAGE

						float dnorm = fwidth( norm );
						alpha = 1.0 - smoothstep( 0.5 - dnorm, 0.5 + dnorm, norm );

					#else

						if ( norm > 0.5 ) {

							discard;

						}

					#endif

				#endif

			#else

				#ifdef USE_ALPHA_TO_COVERAGE

					// artifacts appear on some hardware if a derivative is taken within a conditional
					float a = vUv.x;
					float b = ( vUv.y > 0.0 ) ? vUv.y - 1.0 : vUv.y + 1.0;
					float len2 = a * a + b * b;
					float dlen = fwidth( len2 );

					if ( abs( vUv.y ) > 1.0 ) {

						alpha = 1.0 - smoothstep( 1.0 - dlen, 1.0 + dlen, len2 );

					}

				#else

					if ( abs( vUv.y ) > 1.0 ) {

						float a = vUv.x;
						float b = ( vUv.y > 0.0 ) ? vUv.y - 1.0 : vUv.y + 1.0;
						float len2 = a * a + b * b;

						if ( len2 > 1.0 ) discard;

					}

				#endif

			#endif

			#include <logdepthbuf_fragment>
			#include <color_fragment>

			gl_FragColor = vec4( diffuseColor.rgb, alpha );

			#include <tonemapping_fragment>
			#include <colorspace_fragment>
			#include <fog_fragment>
			#include <premultiplied_alpha_fragment>

		}
		`};class kp extends ui{constructor(t){super({type:"LineMaterial",uniforms:oh.clone(Gi.line.uniforms),vertexShader:Gi.line.vertexShader,fragmentShader:Gi.line.fragmentShader,clipping:!0}),this.isLineMaterial=!0,this.setValues(t)}get color(){return this.uniforms.diffuse.value}set color(t){this.uniforms.diffuse.value=t}get worldUnits(){return"WORLD_UNITS"in this.defines}set worldUnits(t){t===!0?this.defines.WORLD_UNITS="":delete this.defines.WORLD_UNITS}get linewidth(){return this.uniforms.linewidth.value}set linewidth(t){this.uniforms.linewidth&&(this.uniforms.linewidth.value=t)}get dashed(){return"USE_DASH"in this.defines}set dashed(t){t===!0!==this.dashed&&(this.needsUpdate=!0),t===!0?this.defines.USE_DASH="":delete this.defines.USE_DASH}get dashScale(){return this.uniforms.dashScale.value}set dashScale(t){this.uniforms.dashScale.value=t}get dashSize(){return this.uniforms.dashSize.value}set dashSize(t){this.uniforms.dashSize.value=t}get dashOffset(){return this.uniforms.dashOffset.value}set dashOffset(t){this.uniforms.dashOffset.value=t}get gapSize(){return this.uniforms.gapSize.value}set gapSize(t){this.uniforms.gapSize.value=t}get opacity(){return this.uniforms.opacity.value}set opacity(t){this.uniforms&&(this.uniforms.opacity.value=t)}get resolution(){return this.uniforms.resolution.value}set resolution(t){this.uniforms.resolution.value.copy(t)}get alphaToCoverage(){return"USE_ALPHA_TO_COVERAGE"in this.defines}set alphaToCoverage(t){this.defines&&(t===!0!==this.alphaToCoverage&&(this.needsUpdate=!0),t===!0?this.defines.USE_ALPHA_TO_COVERAGE="":delete this.defines.USE_ALPHA_TO_COVERAGE)}}const jl=new di,pf=new X,gf=new X,xn=new di,yn=new di,xr=new di,El=new X,Pl=new jo,vn=new yg,xf=new X,Oi=new Pc,$i=new rh,yr=new di;let kr,Lo;function yf(e,t,n){return yr.set(0,0,-t,1).applyMatrix4(e.projectionMatrix),yr.multiplyScalar(1/yr.w),yr.x=Lo/n.width,yr.y=Lo/n.height,yr.applyMatrix4(e.projectionMatrixInverse),yr.multiplyScalar(1/yr.w),Math.abs(Math.max(yr.x,yr.y))}function fM(e,t){const n=e.matrixWorld,r=e.geometry,s=r.attributes.instanceStart,i=r.attributes.instanceEnd,a=Math.min(r.instanceCount,s.count);for(let l=0,c=a;l<c;l++){vn.start.fromBufferAttribute(s,l),vn.end.fromBufferAttribute(i,l),vn.applyMatrix4(n);const d=new X,h=new X;kr.distanceSqToSegment(vn.start,vn.end,h,d),h.distanceTo(d)<Lo*.5&&t.push({point:h,pointOnLine:d,distance:kr.origin.distanceTo(h),object:e,face:null,faceIndex:l,uv:null,uv1:null})}}function hM(e,t,n){const r=t.projectionMatrix,i=e.material.resolution,a=e.matrixWorld,l=e.geometry,c=l.attributes.instanceStart,d=l.attributes.instanceEnd,h=Math.min(l.instanceCount,c.count),u=-t.near;kr.at(1,xr),xr.w=1,xr.applyMatrix4(t.matrixWorldInverse),xr.applyMatrix4(r),xr.multiplyScalar(1/xr.w),xr.x*=i.x/2,xr.y*=i.y/2,xr.z=0,El.copy(xr),Pl.multiplyMatrices(t.matrixWorldInverse,a);for(let m=0,g=h;m<g;m++){if(xn.fromBufferAttribute(c,m),yn.fromBufferAttribute(d,m),xn.w=1,yn.w=1,xn.applyMatrix4(Pl),yn.applyMatrix4(Pl),xn.z>u&&yn.z>u)continue;if(xn.z>u){const k=xn.z-yn.z,b=(xn.z-u)/k;xn.lerp(yn,b)}else if(yn.z>u){const k=yn.z-xn.z,b=(yn.z-u)/k;yn.lerp(xn,b)}xn.applyMatrix4(r),yn.applyMatrix4(r),xn.multiplyScalar(1/xn.w),yn.multiplyScalar(1/yn.w),xn.x*=i.x/2,xn.y*=i.y/2,yn.x*=i.x/2,yn.y*=i.y/2,vn.start.copy(xn),vn.start.z=0,vn.end.copy(yn),vn.end.z=0;const y=vn.closestPointToPointParameter(El,!0);vn.at(y,xf);const w=wg.lerp(xn.z,yn.z,y),x=w>=-1&&w<=1,v=El.distanceTo(xf)<Lo*.5;if(x&&v){vn.start.fromBufferAttribute(c,m),vn.end.fromBufferAttribute(d,m),vn.start.applyMatrix4(a),vn.end.applyMatrix4(a);const k=new X,b=new X;kr.distanceSqToSegment(vn.start,vn.end,b,k),n.push({point:b,pointOnLine:k,distance:kr.origin.distanceTo(b),object:e,face:null,faceIndex:m,uv:null,uv1:null})}}}class mM extends vg{constructor(t=new Sp,n=new kp({color:Math.random()*16777215})){super(t,n),this.isLineSegments2=!0,this.type="LineSegments2"}computeLineDistances(){const t=this.geometry,n=t.attributes.instanceStart,r=t.attributes.instanceEnd,s=new Float32Array(2*n.count);for(let a=0,l=0,c=n.count;a<c;a++,l+=2)pf.fromBufferAttribute(n,a),gf.fromBufferAttribute(r,a),s[l]=l===0?0:s[l-1],s[l+1]=s[l]+pf.distanceTo(gf);const i=new Ul(s,2,1);return t.setAttribute("instanceDistanceStart",new Xo(i,1,0)),t.setAttribute("instanceDistanceEnd",new Xo(i,1,1)),this}raycast(t,n){const r=this.material.worldUnits,s=t.camera;s===null&&!r&&console.error('LineSegments2: "Raycaster.camera" needs to be set in order to raycast against LineSegments2 while worldUnits is set to false.');const i=t.params.Line2!==void 0&&t.params.Line2.threshold||0;kr=t.ray;const a=this.matrixWorld,l=this.geometry,c=this.material;Lo=c.linewidth+i,l.boundingSphere===null&&l.computeBoundingSphere(),$i.copy(l.boundingSphere).applyMatrix4(a);let d;if(r)d=Lo*.5;else{const u=Math.max(s.near,$i.distanceToPoint(kr.origin));d=yf(s,u,c.resolution)}if($i.radius+=d,kr.intersectsSphere($i)===!1)return;l.boundingBox===null&&l.computeBoundingBox(),Oi.copy(l.boundingBox).applyMatrix4(a);let h;if(r)h=Lo*.5;else{const u=Math.max(s.near,Oi.distanceToPoint(kr.origin));h=yf(s,u,c.resolution)}Oi.expandByScalar(h),kr.intersectsBox(Oi)!==!1&&(r?fM(this,n):hM(this,s,n))}onBeforeRender(t){const n=this.material.uniforms;n&&n.resolution&&(t.getViewport(jl),this.material.uniforms.resolution.value.set(jl.z,jl.w))}}const pM=`
varying vec2 vUv;

void main() {
  vUv = uv;
  gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
}
`,gM=`
uniform float fx;
uniform float fy;
uniform float cx;
uniform float cy;
uniform float imageWidth;
uniform float imageHeight;
uniform float planeWidth;
uniform float planeHeight;
uniform int modelId;
uniform float k1;
uniform float k2;
uniform float k3;
uniform float k4;
uniform float k5;
uniform float k6;
uniform float p1;
uniform float p2;
uniform float omega;
uniform float sx1;
uniform float sy1;

varying vec2 vUv;

// Camera model constants
const int SIMPLE_PINHOLE = 0;
const int PINHOLE = 1;
const int SIMPLE_RADIAL = 2;
const int RADIAL = 3;
const int OPENCV = 4;
const int OPENCV_FISHEYE = 5;
const int FULL_OPENCV = 6;
const int FOV = 7;
const int SIMPLE_RADIAL_FISHEYE = 8;
const int RADIAL_FISHEYE = 9;
const int THIN_PRISM_FISHEYE = 10;

// Convert UV to normalized camera coordinates (distorted space)
vec2 uvToDistortedNormalized(vec2 uv) {
  float px = uv.x * imageWidth;
  float py = (1.0 - uv.y) * imageHeight;
  return vec2((px - cx) / fx, (py - cy) / fy);
}

// Compute inverse distortion: distorted -> undistorted
// Uses iterative approach for accurate inversion
//
// For fisheye models, follows COLMAP's two-step approach:
// 1. Remove polynomial distortion in fisheye Î¸-space (iteratively)
// 2. Convert from fisheye to pinhole via tan(Î¸)/Î¸ scaling
vec2 inverseDistort(vec2 distorted) {
  if (modelId == SIMPLE_PINHOLE || modelId == PINHOLE) {
    return distorted;
  }

  // Handle fisheye models separately - they need special two-step inversion
  if (modelId == OPENCV_FISHEYE || modelId == SIMPLE_RADIAL_FISHEYE || modelId == RADIAL_FISHEYE) {
    // Input is already in fisheye normalized space: (x-cx)/fx, (y-cy)/fy
    // Step 1: Iteratively remove polynomial distortion in fisheye space
    // The distortion is: distorted = undistorted * (1 + k1*Î¸Â² + k2*Î¸â´ + ...)
    // where Î¸Â² = undistorted.xÂ² + undistorted.yÂ²
    vec2 fisheyeUndist = distorted;

    for (int i = 0; i < 10; i++) {
      float theta2 = fisheyeUndist.x * fisheyeUndist.x + fisheyeUndist.y * fisheyeUndist.y;
      float theta4 = theta2 * theta2;
      float theta6 = theta4 * theta2;
      float theta8 = theta4 * theta4;

      float radial = 0.0;
      if (modelId == OPENCV_FISHEYE) {
        radial = k1 * theta2 + k2 * theta4 + k3 * theta6 + k4 * theta8;
      } else if (modelId == SIMPLE_RADIAL_FISHEYE) {
        radial = k1 * theta2;
      } else if (modelId == RADIAL_FISHEYE) {
        radial = k1 * theta2 + k2 * theta4;
      }

      // Solve: distorted = fisheyeUndist * (1 + radial)
      // So: fisheyeUndist = distorted / (1 + radial)
      fisheyeUndist = distorted / (1.0 + radial);
    }

    // Step 2: Convert from fisheye to pinhole (NormalFromFisheye in COLMAP)
    // In fisheye space, Î¸ = length(fisheyeUndist) represents the angle from optical axis
    // To convert to pinhole: scale by tan(Î¸)/Î¸
    float theta = sqrt(fisheyeUndist.x * fisheyeUndist.x + fisheyeUndist.y * fisheyeUndist.y);
    if (theta < 0.00001) {
      return fisheyeUndist;
    }
    // scale = sin(Î¸)/(Î¸*cos(Î¸)) = tan(Î¸)/Î¸
    float scale = tan(theta) / theta;
    return fisheyeUndist * scale;
  }

  // THIN_PRISM_FISHEYE: fisheye + tangential + thin prism
  // Distortion order: 1) fisheye radial, 2) tangential + thin prism on scaled coords
  // Inverse order: 1) remove tangential + thin prism, 2) remove fisheye radial, 3) fisheye to pinhole
  if (modelId == THIN_PRISM_FISHEYE) {
    vec2 fisheyeUndist = distorted;

    for (int i = 0; i < 10; i++) {
      // First estimate what the fisheye-only point would be (before tangential/thin prism)
      float theta2 = fisheyeUndist.x * fisheyeUndist.x + fisheyeUndist.y * fisheyeUndist.y;
      float theta4 = theta2 * theta2;
      float theta6 = theta4 * theta2;
      float theta8 = theta4 * theta4;
      float radial = k1 * theta2 + k2 * theta4 + k3 * theta6 + k4 * theta8;

      // Compute tangential + thin prism delta at current estimate
      float x = fisheyeUndist.x;
      float y = fisheyeUndist.y;
      float r2d = x * x + y * y;
      float dx = 2.0 * p1 * x * y + p2 * (r2d + 2.0 * x * x) + sx1 * r2d;
      float dy = p1 * (r2d + 2.0 * y * y) + 2.0 * p2 * x * y + sy1 * r2d;

      // Remove tangential/thin prism, then remove radial
      vec2 withoutTangential = distorted - vec2(dx, dy);
      fisheyeUndist = withoutTangential / (1.0 + radial);
    }

    // Convert from fisheye to pinhole
    float theta = sqrt(fisheyeUndist.x * fisheyeUndist.x + fisheyeUndist.y * fisheyeUndist.y);
    if (theta < 0.00001) {
      return fisheyeUndist;
    }
    float scale = tan(theta) / theta;
    return fisheyeUndist * scale;
  }

  // For non-fisheye models: standard iterative undistortion
  // Initial guess: the distorted point itself
  vec2 undistorted = distorted;

  // Newton-Raphson iteration to find undistorted point
  // We're solving: distorted = undistorted + delta(undistorted)
  // So: undistorted = distorted - delta(undistorted)
  for (int i = 0; i < 10; i++) {
    float x = undistorted.x;
    float y = undistorted.y;
    float r2 = x * x + y * y;
    float r = sqrt(r2);

    vec2 delta = vec2(0.0);

    if (modelId == SIMPLE_RADIAL) {
      float radial = k1 * r2;
      delta = undistorted * radial;
    } else if (modelId == RADIAL) {
      float r4 = r2 * r2;
      float radial = k1 * r2 + k2 * r4;
      delta = undistorted * radial;
    } else if (modelId == OPENCV) {
      float r4 = r2 * r2;
      float radial = k1 * r2 + k2 * r4;
      float dx = 2.0 * p1 * x * y + p2 * (r2 + 2.0 * x * x);
      float dy = p1 * (r2 + 2.0 * y * y) + 2.0 * p2 * x * y;
      delta = vec2(x * radial + dx, y * radial + dy);
    } else if (modelId == FULL_OPENCV) {
      float r4 = r2 * r2;
      float r6 = r4 * r2;
      float num = 1.0 + k1 * r2 + k2 * r4 + k3 * r6;
      float denom = 1.0 + k4 * r2 + k5 * r4 + k6 * r6;
      float radial = num / denom - 1.0;
      float dx = 2.0 * p1 * x * y + p2 * (r2 + 2.0 * x * x);
      float dy = p1 * (r2 + 2.0 * y * y) + 2.0 * p2 * x * y;
      delta = vec2(x * radial + dx, y * radial + dy);
    } else if (modelId == FOV) {
      if (r > 0.00001) {
        float rd = atan(r * 2.0 * tan(omega / 2.0)) / omega;
        float factor = rd / r - 1.0;
        delta = undistorted * factor;
      }
    }

    // Update: undistorted = distorted - delta
    undistorted = distorted - delta;
  }

  return undistorted;
}

void main() {
  vUv = uv;

  // Get this vertex's position in distorted normalized coordinates
  vec2 distortedNorm = uvToDistortedNormalized(uv);

  // Compute undistorted position
  vec2 undistortedNorm = inverseDistort(distortedNorm);

  // Convert back to UV space
  float undistortedPx = undistortedNorm.x * fx + cx;
  float undistortedPy = undistortedNorm.y * fy + cy;
  float undistortedU = undistortedPx / imageWidth;
  float undistortedV = 1.0 - (undistortedPy / imageHeight);

  // Compute new position using plane dimensions passed as uniforms
  // PlaneGeometry maps UV (0-1) to position (-width/2 to width/2)
  vec3 newPosition = position;
  newPosition.x = (undistortedU - 0.5) * planeWidth;
  newPosition.y = (undistortedV - 0.5) * planeHeight;

  gl_Position = projectionMatrix * modelViewMatrix * vec4(newPosition, 1.0);
}
`,xM=`
precision highp float;

uniform sampler2D map;
uniform float opacity;
uniform vec3 color;
uniform bool undistortionEnabled;

// Camera model ID (matches COLMAP)
uniform int modelId;

// Image dimensions
uniform float imageWidth;
uniform float imageHeight;

// Camera intrinsics - up to 12 parameters
uniform float fx;
uniform float fy;
uniform float cx;
uniform float cy;
uniform float k1;
uniform float k2;
uniform float k3;
uniform float k4;
uniform float k5;
uniform float k6;
uniform float p1;
uniform float p2;
uniform float omega;  // FOV model parameter
uniform float sx1;    // Thin prism parameters
uniform float sy1;

varying vec2 vUv;

// Camera model constants (must match CameraModelId in colmap.ts)
const int SIMPLE_PINHOLE = 0;
const int PINHOLE = 1;
const int SIMPLE_RADIAL = 2;
const int RADIAL = 3;
const int OPENCV = 4;
const int OPENCV_FISHEYE = 5;
const int FULL_OPENCV = 6;
const int FOV = 7;
const int SIMPLE_RADIAL_FISHEYE = 8;
const int RADIAL_FISHEYE = 9;
const int THIN_PRISM_FISHEYE = 10;

// Convert UV (0-1) to normalized camera coordinates
vec2 uvToNormalized(vec2 uv) {
  // UV goes from 0-1, convert to pixel coordinates
  float px = uv.x * imageWidth;
  float py = (1.0 - uv.y) * imageHeight; // Flip Y for image coordinate system

  // Convert to normalized camera coordinates (centered at principal point)
  float x = (px - cx) / fx;
  float y = (py - cy) / fy;

  return vec2(x, y);
}

// Convert normalized camera coordinates back to UV
vec2 normalizedToUv(vec2 normalized) {
  // Convert back to pixel coordinates
  float px = normalized.x * fx + cx;
  float py = normalized.y * fy + cy;

  // Convert to UV (0-1), flip Y back
  float u = px / imageWidth;
  float v = 1.0 - (py / imageHeight);

  return vec2(u, v);
}

// ============ DISTORTION FUNCTIONS ============
// These compute the distortion delta for each model

// SIMPLE_RADIAL: du = u * k * r^2
vec2 distortSimpleRadial(vec2 p) {
  float r2 = dot(p, p);
  float radial = k1 * r2;
  return p * radial;
}

// RADIAL: du = u * (k1*r^2 + k2*r^4)
vec2 distortRadial(vec2 p) {
  float r2 = dot(p, p);
  float r4 = r2 * r2;
  float radial = k1 * r2 + k2 * r4;
  return p * radial;
}

// OPENCV: radial + tangential distortion
vec2 distortOpenCV(vec2 p) {
  float x = p.x;
  float y = p.y;
  float r2 = x * x + y * y;
  float r4 = r2 * r2;

  // Radial distortion
  float radial = k1 * r2 + k2 * r4;

  // Tangential distortion
  float dx = 2.0 * p1 * x * y + p2 * (r2 + 2.0 * x * x);
  float dy = p1 * (r2 + 2.0 * y * y) + 2.0 * p2 * x * y;

  return vec2(x * radial + dx, y * radial + dy);
}

// FULL_OPENCV: rational polynomial model
vec2 distortFullOpenCV(vec2 p) {
  float x = p.x;
  float y = p.y;
  float r2 = x * x + y * y;
  float r4 = r2 * r2;
  float r6 = r4 * r2;

  // Rational polynomial
  float num = 1.0 + k1 * r2 + k2 * r4 + k3 * r6;
  float denom = 1.0 + k4 * r2 + k5 * r4 + k6 * r6;
  float radial = num / denom - 1.0;

  // Tangential distortion
  float dx = 2.0 * p1 * x * y + p2 * (r2 + 2.0 * x * x);
  float dy = p1 * (r2 + 2.0 * y * y) + 2.0 * p2 * x * y;

  return vec2(x * radial + dx, y * radial + dy);
}

// FOV model distortion
vec2 distortFOV(vec2 p) {
  float r = length(p);
  if (r < 0.00001) return vec2(0.0);

  float rd = atan(r * 2.0 * tan(omega / 2.0)) / omega;
  float factor = rd / r - 1.0;

  return p * factor;
}

// OPENCV_FISHEYE: equidistant fisheye projection with k1-k4
// This computes the delta to go from perspective to fisheye projection
vec2 distortOpenCVFisheye(vec2 p) {
  float r = length(p);
  if (r < 0.00001) return vec2(0.0);

  float theta = atan(r);
  float theta2 = theta * theta;
  float theta4 = theta2 * theta2;
  float theta6 = theta4 * theta2;
  float theta8 = theta4 * theta4;

  float thetad = theta * (1.0 + k1 * theta2 + k2 * theta4 + k3 * theta6 + k4 * theta8);

  // The distorted point is p * (thetad / r)
  // So delta = p * (thetad/r - 1)
  return p * (thetad / r - 1.0);
}

// SIMPLE_RADIAL_FISHEYE: fisheye with single k parameter
vec2 distortSimpleRadialFisheye(vec2 p) {
  float r = length(p);
  if (r < 0.00001) return vec2(0.0);

  float theta = atan(r);
  float theta2 = theta * theta;

  float thetad = theta * (1.0 + k1 * theta2);
  float factor = thetad / r - 1.0;

  return p * factor;
}

// RADIAL_FISHEYE: fisheye with k1, k2
vec2 distortRadialFisheye(vec2 p) {
  float r = length(p);
  if (r < 0.00001) return vec2(0.0);

  float theta = atan(r);
  float theta2 = theta * theta;
  float theta4 = theta2 * theta2;

  float thetad = theta * (1.0 + k1 * theta2 + k2 * theta4);
  float factor = thetad / r - 1.0;

  return p * factor;
}

// THIN_PRISM_FISHEYE: fisheye + radial + tangential + thin prism
vec2 distortThinPrismFisheye(vec2 p) {
  float r = length(p);
  if (r < 0.00001) return vec2(0.0);

  float theta = atan(r);
  float theta2 = theta * theta;
  float theta4 = theta2 * theta2;
  float theta6 = theta4 * theta2;
  float theta8 = theta4 * theta4;

  float thetad = theta * (1.0 + k1 * theta2 + k2 * theta4 + k3 * theta6 + k4 * theta8);

  // Scale to distorted radius
  vec2 pd = p * (thetad / r);

  // Add tangential and thin prism distortion
  float x = pd.x;
  float y = pd.y;
  float r2d = x * x + y * y;

  float dx = 2.0 * p1 * x * y + p2 * (r2d + 2.0 * x * x) + sx1 * r2d;
  float dy = p1 * (r2d + 2.0 * y * y) + 2.0 * p2 * x * y + sy1 * r2d;

  // Return delta from original point
  return vec2(pd.x + dx - p.x, pd.y + dy - p.y);
}

// Apply distortion based on model ID
vec2 applyDistortion(vec2 p) {
  if (modelId == SIMPLE_PINHOLE || modelId == PINHOLE) {
    return vec2(0.0); // No distortion
  } else if (modelId == SIMPLE_RADIAL) {
    return distortSimpleRadial(p);
  } else if (modelId == RADIAL) {
    return distortRadial(p);
  } else if (modelId == OPENCV) {
    return distortOpenCV(p);
  } else if (modelId == OPENCV_FISHEYE) {
    return distortOpenCVFisheye(p);
  } else if (modelId == FULL_OPENCV) {
    return distortFullOpenCV(p);
  } else if (modelId == FOV) {
    return distortFOV(p);
  } else if (modelId == SIMPLE_RADIAL_FISHEYE) {
    return distortSimpleRadialFisheye(p);
  } else if (modelId == RADIAL_FISHEYE) {
    return distortRadialFisheye(p);
  } else if (modelId == THIN_PRISM_FISHEYE) {
    return distortThinPrismFisheye(p);
  }
  return vec2(0.0);
}

// Given an undistorted (ideal perspective) coordinate, find the corresponding
// coordinate in the distorted (actual captured) image to sample from.
//
// For radial/tangential models: removes lens distortion aberrations
// For fisheye models: converts fisheye projection to perspective projection
//
// IMPORTANT: For fisheye cameras with wide FOV (>90 degrees), the edges of
// the perspective view will sample from the center of the fisheye image,
// and much of the fisheye image won't be visible. This is a fundamental
// limitation of projecting fisheye onto a flat perspective plane.
vec2 perspectiveToDistorted(vec2 undistorted) {
  // For no-distortion models, return as-is
  if (modelId == SIMPLE_PINHOLE || modelId == PINHOLE) {
    return undistorted;
  }

  // COLMAP's distortion model: distorted = undistorted + delta(undistorted)
  // This is a direct computation, no iteration needed.
  return undistorted + applyDistortion(undistorted);
}

void main() {
  vec2 sampleUv;

  if (undistortionEnabled && modelId != SIMPLE_PINHOLE && modelId != PINHOLE) {
    // Convert UV to normalized camera coordinates (perspective projection)
    vec2 normalized = uvToNormalized(vUv);

    // Find where to sample in the distorted image
    vec2 distortedNormalized = perspectiveToDistorted(normalized);

    // Convert back to UV
    sampleUv = normalizedToUv(distortedNormalized);

    // Check bounds - if outside image, render as transparent
    // This is common for fisheye undistortion where perspective FOV exceeds fisheye coverage
    if (sampleUv.x < 0.0 || sampleUv.x > 1.0 || sampleUv.y < 0.0 || sampleUv.y > 1.0) {
      gl_FragColor = vec4(color, 0.0);
      return;
    }
  } else {
    sampleUv = vUv;
  }

  vec4 texColor = texture2D(map, sampleUv);

  // The texture has colorSpace=SRGBColorSpace, so Three.js auto-converts sRGB->linear when sampling.
  // Use Three.js colorspace_fragment to convert back to sRGB for output (same as meshBasicMaterial).
  gl_FragColor = vec4(texColor.rgb, opacity);

  #include <colorspace_fragment>
}
`,yM=`
precision highp float;

uniform sampler2D map;
uniform float opacity;
uniform vec3 color;

varying vec2 vUv;

void main() {
  vec4 texColor = texture2D(map, vUv);
  gl_FragColor = vec4(texColor.rgb, opacity);
  #include <colorspace_fragment>
}
`;function vM({map:e,camera:t,undistortionEnabled:n,undistortionMode:r,planeWidth:s=1,planeHeight:i=1,opacity:a,color:l,side:c,visible:d=!0,depthTest:h=!0,forceTransparent:u=!1,forceDepthWrite:m}){const g=f.useRef(null),p=f.useMemo(()=>mh(t),[t]),y=r==="fullFrame",w=f.useMemo(()=>{const x=new Er(l),v={map:{value:e},opacity:{value:a},color:{value:new X(x.r,x.g,x.b)},modelId:{value:t.modelId},imageWidth:{value:t.width},imageHeight:{value:t.height},fx:{value:p.fx},fy:{value:p.fy},cx:{value:p.cx},cy:{value:p.cy},k1:{value:p.k1},k2:{value:p.k2},k3:{value:p.k3},k4:{value:p.k4},k5:{value:p.k5},k6:{value:p.k6},p1:{value:p.p1},p2:{value:p.p2},omega:{value:p.omega},sx1:{value:p.sx1},sy1:{value:p.sy1}};y?(v.planeWidth={value:s},v.planeHeight={value:i}):v.undistortionEnabled={value:n};const{transparent:k,depthWrite:b}=Gl(a);return new ui({vertexShader:y?gM:pM,fragmentShader:y?yM:xM,uniforms:v,side:c,transparent:u||k,depthWrite:m!==void 0?m:b,depthTest:h,blending:bg,toneMapped:!1,visible:id(a,d)})},[t,p,c,d,a,y,n,s,i,h,u,m,l,e]);return f.useEffect(()=>{const x=g.current;if(!x)return;x.uniforms.map.value=e,x.uniforms.opacity.value=a;const v=new Er(l);x.uniforms.color.value.set(v.r,v.g,v.b),y?(x.uniforms.planeWidth&&(x.uniforms.planeWidth.value=s),x.uniforms.planeHeight&&(x.uniforms.planeHeight.value=i)):x.uniforms.undistortionEnabled&&(x.uniforms.undistortionEnabled.value=n),x.uniforms.modelId.value=t.modelId,x.uniforms.imageWidth.value=t.width,x.uniforms.imageHeight.value=t.height,x.uniforms.fx.value=p.fx,x.uniforms.fy.value=p.fy,x.uniforms.cx.value=p.cx,x.uniforms.cy.value=p.cy,x.uniforms.k1.value=p.k1,x.uniforms.k2.value=p.k2,x.uniforms.k3.value=p.k3,x.uniforms.k4.value=p.k4,x.uniforms.k5.value=p.k5,x.uniforms.k6.value=p.k6,x.uniforms.p1.value=p.p1,x.uniforms.p2.value=p.p2,x.uniforms.omega.value=p.omega,x.uniforms.sx1.value=p.sx1,x.uniforms.sy1.value=p.sy1;const{transparent:k,depthWrite:b}=Gl(a);x.visible=id(a,d),x.transparent=u||k,x.depthWrite=m!==void 0?m:b,x.depthTest=h,x.needsUpdate=!0},[e,a,l,n,d,t,p,y,s,i,h,u,m]),o.jsx("primitive",{ref:g,object:w,attach:"material"})}function Ip(){const e=lt(n=>n.pickingMode),t=Ct(n=>n.detectedPlane);return e!=="off"||t!==null}const Mp=`
  attribute float alpha;
  varying float vAlpha;
  varying vec3 vColor;

  void main() {
    vColor = color;
    vAlpha = alpha;
    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
  }
`,jp=`
  varying float vAlpha;
  varying vec3 vColor;

  void main() {
    gl_FragColor = vec4(vColor, vAlpha);
  }
`;let Ep=0,Pp=0;const wM=200,bM=50;function pu(){Ep=Date.now()}function CM(){return Date.now()-Ep<wM}function gu(){Pp=Date.now()}function SM(){return Date.now()-Pp<bM}Cg({LineSegments2:mM,LineSegmentsGeometry:Sp,LineMaterial:kp});function xu(e,t,n){return n?`#${t}:${e}`:`#${e}`}const zt=new Er;function Np(e,t){const n=Wr.chroma,r=n*(1-Math.abs(t*6%2-1)),s=Wr.lightness-n/2;let i=0,a=0,l=0;const{hueSegments:c}=Wr;t<c.redToYellow?(i=n,a=r):t<c.yellowToGreen?(i=r,a=n):t<c.greenToCyan?(a=n,l=r):t<c.cyanToBlue?(a=r,l=n):t<c.blueToMagenta?(i=r,l=n):(i=n,l=r),e.setRGB(i+s,a+s,l+s)}function yu(e){return e<.3?e/.3:e<.6?1:e<1?1-(e-.6)/.4:0}function vu(e,t,n,r,s){if(e==="byCamera")return Yl(t);if(e==="byRigFrame"){const i=r.get(n);return i!==void 0?Yl(i):s}return s}const Ws=new X,vf=new X,Nl=new X,wf=new Tt,kM=Math.cos(Math.PI/4),IM=Math.cos(Math.PI/2),wr=new jo,an=new X,Jr=new Tt,fr=new X(1,1,1),Bi=new or;function MM({frustums:e,cameraScale:t,selectedImageId:n,hoveredImageId:r,matchedImageIds:s,matchesOpacity:i,matchesDisplayMode:a,matchesColor:l,frustumColorMode:c,frustumSingleColor:d,frustumStandbyOpacity:h,selectionColorMode:u,selectionColor:m,selectionAnimationSpeed:g,unselectedCameraOpacity:p,imageFrameIndexMap:y,onHover:w,onClick:x,onContextMenu:v,onLongPress:k,lastNavigationToImageId:b,touchMode:S=!1,pendingDeletions:C}){const M=me(Cs)>1,I=f.useRef(null),L=f.useRef(null),P=f.useRef(0),_=f.useRef(0),N=f.useRef(null),D=f.useRef(null),B=f.useRef(!0),[E,Z]=f.useState(null),{controls:F}=mr(),$=f.useCallback(()=>F?.dragging?.current??!1,[F]),T=f.useRef(null);f.useEffect(()=>()=>{document.body.style.cursor="",T.current?.timer&&clearTimeout(T.current.timer)},[]);const z=t*.8,H=t*.04,O=t*.2,J=t*.08,re=f.useMemo(()=>{const ee=new kg(H,H,z,8);return ee.computeBoundingSphere(),ee},[H,z]),q=f.useMemo(()=>{const ee=new Ig(J,O,12);return ee.computeBoundingSphere(),ee},[J,O]),ie=f.useMemo(()=>new Wl({transparent:!0,depthWrite:!1}),[]),we=f.useMemo(()=>new Wl({transparent:!0,depthWrite:!1}),[]);if(f.useEffect(()=>()=>{re.dispose(),q.dispose()},[re,q]),f.useEffect(()=>()=>{ie.dispose(),we.dispose()},[ie,we]),pr((ee,he)=>{if(!I.current||!L.current)return;const Se=I.current,xe=L.current,Ae=(u==="blink"||u==="rainbow")&&n!==null,ye=a==="blink"&&s.size>0;Ae&&u==="rainbow"&&(P.current=(P.current+he*g*Wr.speedMultiplier)%1),ye&&(_.current=(_.current+he)%2);const Pe=ee.clock.elapsedTime*g*2,Ye=n!==N.current||r!==D.current;!Ae&&!ye&&!Ye&&!B.current||(N.current=n,D.current=r,B.current=!1,e.forEach(($e,qe)=>{const ct=$e.image.imageId===n,K=$e.image.imageId===r,Le=s.has($e.image.imageId),fe=C?.has($e.image.imageId)??!1;if(ct?fr.set(0,0,0):fr.set(1,1,1),fe)zt.set(st.frustum.deleted);else if(K)zt.set(st.frustum.hover);else if(ct)if(u==="rainbow")Np(zt,P.current);else if(u==="blink"){const De=.5+.5*((Math.sin(Pe)+1)/2);zt.set(m),zt.multiplyScalar(De)}else zt.set(m);else if(Le)if(zt.set(l),a==="blink"){const ae=i*(.1+.9*yu(_.current));zt.multiplyScalar(ae)}else zt.multiplyScalar(i);else zt.set(vu(c,$e.cameraIndex,$e.image.imageId,y,d));Bi.set(Math.PI/2,0,0),Jr.setFromEuler(Bi),Jr.premultiply($e.quaternion),an.set(0,0,z/2),an.applyQuaternion($e.quaternion),an.add($e.position),wr.compose(an,Jr,fr),Se.setMatrixAt(qe,wr),Se.setColorAt(qe,zt),an.set(0,0,z+O/2),an.applyQuaternion($e.quaternion),an.add($e.position),wr.compose(an,Jr,fr),xe.setMatrixAt(qe,wr),xe.setColorAt(qe,zt)}),Se.instanceMatrix.needsUpdate=!0,xe.instanceMatrix.needsUpdate=!0,Se.instanceColor&&(Se.instanceColor.needsUpdate=!0),xe.instanceColor&&(xe.instanceColor.needsUpdate=!0))}),f.useEffect(()=>{B.current=!0},[e,t]),f.useLayoutEffect(()=>{if(!I.current||!L.current)return;const ee=I.current,he=L.current;e.forEach((Se,xe)=>{Se.image.imageId===n?fr.set(0,0,0):fr.set(1,1,1),Bi.set(Math.PI/2,0,0),Jr.setFromEuler(Bi),Jr.premultiply(Se.quaternion),an.set(0,0,z/2),an.applyQuaternion(Se.quaternion),an.add(Se.position),wr.compose(an,Jr,fr),ee.setMatrixAt(xe,wr),an.set(0,0,z+O/2),an.applyQuaternion(Se.quaternion),an.add(Se.position),wr.compose(an,Jr,fr),he.setMatrixAt(xe,wr)}),ee.instanceMatrix.needsUpdate=!0,he.instanceMatrix.needsUpdate=!0,ee.computeBoundingSphere(),he.computeBoundingSphere()},[e,n,z,O]),f.useEffect(()=>{const ee=n===null?h:p;ie.opacity=ee,we.opacity=ee},[ie,we,n,h,p]),e.length===0)return null;const Ce=E!==null?e[E.instanceId]:null,Re=`arrows-${e.length}-${e[0]?.image.imageId??0}-${t.toFixed(4)}`;return o.jsxs(o.Fragment,{children:[o.jsx("instancedMesh",{ref:I,dispose:null,args:[re,ie,e.length],onPointerOver:ee=>{if(ee.instanceId===void 0||$())return;const he=e[ee.instanceId];!he||he.image.imageId===n||(ee.stopPropagation(),Z({instanceId:ee.instanceId,x:ee.nativeEvent.clientX,y:ee.nativeEvent.clientY}),w(he.image.imageId),document.body.style.cursor="pointer")},onPointerMove:ee=>{if($()){E!==null&&(Z(null),w(null),document.body.style.cursor="");return}if(E!==null)Z({instanceId:E.instanceId,x:ee.nativeEvent.clientX,y:ee.nativeEvent.clientY});else if(ee.instanceId!==void 0){const he=e[ee.instanceId];he&&he.image.imageId!==n&&(Z({instanceId:ee.instanceId,x:ee.nativeEvent.clientX,y:ee.nativeEvent.clientY}),w(he.image.imageId),document.body.style.cursor="pointer")}},onPointerOut:()=>{Z(null),w(null),document.body.style.cursor=""},onPointerDown:S?ee=>{if(ee.instanceId===void 0)return;gu();const he=ee.instanceId,Se=ee.nativeEvent.clientX,xe=ee.nativeEvent.clientY,Ae=setTimeout(()=>{if(!T.current||T.current.instanceId!==he)return;T.current.fired=!0;const ye=e[he];ye&&k(ye.image.imageId)},It.longPressDelay);T.current={instanceId:he,x:Se,y:xe,timer:Ae,fired:!1}}:void 0,onPointerUp:S?ee=>{const he=T.current;if(T.current=null,!he||(he.timer&&clearTimeout(he.timer),he.fired))return;const Se=ee.nativeEvent.clientX-he.x,xe=ee.nativeEvent.clientY-he.y;if(Se*Se+xe*xe>225)return;const Ae=e[he.instanceId];!Ae||Ae.image.imageId===n||(ee.stopPropagation(),pu(),v(Ae.image.imageId))}:void 0,onClick:S?ee=>{ee.stopPropagation()}:ee=>{if(ee.instanceId===void 0)return;const he=e[ee.instanceId];!he||he.image.imageId===n||(ee.stopPropagation(),x(he.image.imageId))},onContextMenu:ee=>{if(ee.instanceId===void 0)return;const he=e[ee.instanceId];!he||he.image.imageId===n||(ee.stopPropagation(),ee.nativeEvent.preventDefault(),ee.nativeEvent.stopPropagation(),v(he.image.imageId))}},Re),o.jsx("instancedMesh",{ref:L,dispose:null,args:[q,we,e.length]},`${Re}-cone`),!S&&E!==null&&Ce&&o.jsx(Gr,{style:{position:"fixed",left:E.x+rn.cursorOffset,top:E.y+rn.cursorOffset,pointerEvents:"none",transform:"none"},calculatePosition:()=>[0,0],children:o.jsxs("div",{className:ve.container,children:[o.jsx("div",{className:ve.title,children:Ce.image.name}),o.jsx("div",{className:ve.subtitle,children:xu(Ce.image.imageId,Ce.image.cameraId,M)}),o.jsxs("div",{className:ve.subtitle,children:[Ce.numPoints3D," points"]}),o.jsxs("div",{className:ve.hint,children:[o.jsxs("div",{className:ve.hintRow,children:[o.jsxs("svg",{className:_t.hoverCard,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[o.jsx("rect",{x:"6",y:"2",width:"12",height:"20",rx:"6"}),o.jsx("path",{d:"M12 2v8"}),o.jsx("rect",{x:"6",y:"2",width:"6",height:"8",rx:"3",fill:"currentColor",opacity:"0.5"})]}),"Left: select"]}),o.jsxs("div",{className:ve.hintRow,children:[o.jsxs("svg",{className:_t.hoverCard,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[o.jsx("rect",{x:"6",y:"2",width:"12",height:"20",rx:"6"}),o.jsx("path",{d:"M12 2v8"}),o.jsx("rect",{x:"12",y:"2",width:"6",height:"8",rx:"3",fill:"currentColor",opacity:"0.5"})]}),s.has(Ce.image.imageId)?"Right: matches":Ce.image.imageId===b?"Right: back":"Right: fly to"]})]})]})})]})}function jM({frustums:e,cameraScale:t,selectedImageId:n,hoveredImageId:r,matchedImageIds:s,matchesOpacity:i,matchesDisplayMode:a,matchesColor:l,frustumColorMode:c,frustumSingleColor:d,frustumStandbyOpacity:h,selectionColorMode:u,selectionColor:m,selectionAnimationSpeed:g,unselectedCameraOpacity:p,showImagePlanes:y,imageFrameIndexMap:w,pendingDeletions:x}){const v=f.useRef(null),k=f.useRef(0),b=f.useRef(0),S=f.useRef(null),{positions:C,baseColors:M,baseAlphas:I}=f.useMemo(()=>{const N=new Float32Array(e.length*48),D=new Float32Array(e.length*48),B=new Float32Array(e.length*16);return e.forEach((E,Z)=>{const F=Z*48,$=Z*16,T=E.camera.width/E.camera.height,z=E.camera.params[0]||1,H=t*E.camera.width/(2*z),O=H/T,J=t,re=new X(0,0,0),q=new X(-H,-O,J),ie=new X(H,-O,J),we=new X(H,O,J),Ce=new X(-H,O,J);re.applyQuaternion(E.quaternion).add(E.position),q.applyQuaternion(E.quaternion).add(E.position),ie.applyQuaternion(E.quaternion).add(E.position),we.applyQuaternion(E.quaternion).add(E.position),Ce.applyQuaternion(E.quaternion).add(E.position),N[F+0]=re.x,N[F+1]=re.y,N[F+2]=re.z,N[F+3]=q.x,N[F+4]=q.y,N[F+5]=q.z,N[F+6]=re.x,N[F+7]=re.y,N[F+8]=re.z,N[F+9]=ie.x,N[F+10]=ie.y,N[F+11]=ie.z,N[F+12]=re.x,N[F+13]=re.y,N[F+14]=re.z,N[F+15]=we.x,N[F+16]=we.y,N[F+17]=we.z,N[F+18]=re.x,N[F+19]=re.y,N[F+20]=re.z,N[F+21]=Ce.x,N[F+22]=Ce.y,N[F+23]=Ce.z,N[F+24]=q.x,N[F+25]=q.y,N[F+26]=q.z,N[F+27]=ie.x,N[F+28]=ie.y,N[F+29]=ie.z,N[F+30]=ie.x,N[F+31]=ie.y,N[F+32]=ie.z,N[F+33]=we.x,N[F+34]=we.y,N[F+35]=we.z,N[F+36]=we.x,N[F+37]=we.y,N[F+38]=we.z,N[F+39]=Ce.x,N[F+40]=Ce.y,N[F+41]=Ce.z,N[F+42]=Ce.x,N[F+43]=Ce.y,N[F+44]=Ce.z,N[F+45]=q.x,N[F+46]=q.y,N[F+47]=q.z,zt.set(vu(c,E.cameraIndex,E.image.imageId,w,d));for(let Re=0;Re<16;Re++)D[F+Re*3+0]=zt.r,D[F+Re*3+1]=zt.g,D[F+Re*3+2]=zt.b,B[$+Re]=1}),{positions:N,baseColors:D,baseAlphas:B}},[e,t,c,d,w]);pr((N,D)=>{if(!v.current)return;const B=v.current.getAttribute("color"),E=v.current.getAttribute("alpha");if(!B||!E)return;const Z=(u==="blink"||u==="rainbow")&&n!==null,F=a==="blink"&&s.size>0,$=Z||F,T=S.current,z=!T||T.selectedImageId!==n||T.hoveredImageId!==r||T.matchedImageIds!==s||T.unselectedCameraOpacity!==p||T.matchesOpacity!==i||T.showImagePlanes!==y;if(!$&&!z)return;S.current={selectedImageId:n,hoveredImageId:r,matchedImageIds:s,unselectedCameraOpacity:p,matchesOpacity:i,showImagePlanes:y};const H=B.array,O=E.array;Z&&u==="rainbow"&&(k.current=(k.current+D*g*Wr.speedMultiplier)%1),F&&(b.current=(b.current+D)%2);const J=N.clock.elapsedTime*g*2;e.forEach((re,q)=>{const ie=q*48,we=q*16,Ce=re.image.imageId===n,Re=re.image.imageId===r,ee=s.has(re.image.imageId),he=x?.has(re.image.imageId)??!1;he?zt.set(st.frustum.deleted):Re?zt.set(st.frustum.hover):Ce?u==="rainbow"?Np(zt,k.current):zt.set(m):ee?zt.set(l):zt.setRGB(M[ie],M[ie+1],M[ie+2]);let Se;if(he?Se=.3:n===null?Se=h:Ce||Re?Se=1:ee?Se=i:Se=p,Ce&&u==="blink"){const Ae=(Math.sin(J)+1)/2;Se*=.1+.9*Ae}ee&&a==="blink"&&(Se*=.1+.9*yu(b.current)),(Ce||y&&n===null)&&(Se=0);for(let Ae=0;Ae<16;Ae++)H[ie+Ae*3+0]=zt.r,H[ie+Ae*3+1]=zt.g,H[ie+Ae*3+2]=zt.b,O[we+Ae]=Se}),B.needsUpdate=!0,E.needsUpdate=!0});const L=f.useMemo(()=>new Float32Array(M),[M]),P=f.useMemo(()=>{const N=new Float32Array(I.length),D=n===null?h:p;for(let B=0;B<I.length;B++)N[B]=D;return N},[I.length,h,p,n]),_=f.useMemo(()=>new ui({vertexShader:Mp,fragmentShader:jp,vertexColors:!0,transparent:!0,depthWrite:!1,depthTest:!0,polygonOffset:!0,polygonOffsetFactor:1,polygonOffsetUnits:1}),[]);return e.length===0?null:o.jsx("lineSegments",{material:_,renderOrder:2,children:o.jsxs("bufferGeometry",{ref:v,children:[o.jsx("bufferAttribute",{attach:"attributes-position",args:[C,3]}),o.jsx("bufferAttribute",{attach:"attributes-color",args:[L,3]}),o.jsx("bufferAttribute",{attach:"attributes-alpha",args:[P,1]})]})})}function bf({frustums:e,cameraScale:t,selectedImageId:n,matchedImageIds:r,onHover:s,onClick:i,onContextMenu:a,onLongPress:l,lastNavigationToImageId:c,touchMode:d=!1}){const h=me(Cs)>1,u=f.useRef(null),[m,g]=f.useState(null),{controls:p}=mr(),y=f.useCallback(()=>p?.dragging?.current??!1,[p]),w=f.useRef(null);f.useEffect(()=>()=>{document.body.style.cursor="",w.current?.timer&&clearTimeout(w.current.timer)},[]);const x=f.useMemo(()=>new Mg(1,1),[]),v=f.useMemo(()=>new Wl({transparent:!0,opacity:0,side:ao,depthWrite:!1}),[]);f.useEffect(()=>()=>{x.dispose(),v.dispose()},[x,v]);const k=f.useMemo(()=>e.map(C=>{const M=C.camera.width/C.camera.height,I=C.camera.params[0]||1,L=t*C.camera.width/(2*I),P=L/M;return{width:L*2,height:P*2,depth:t}}),[e,t]);if(f.useLayoutEffect(()=>{if(!u.current)return;const C=u.current;e.forEach((M,I)=>{const L=k[I],P=M.image.imageId===n;if(an.copy(M.position),Ws.set(0,0,L.depth),Ws.applyQuaternion(M.quaternion),an.add(Ws),P)fr.set(0,0,0);else{const _=d?It.hitTargetScale:1;fr.set(L.width*_,L.height*_,1)}wr.compose(an,M.quaternion,fr),C.setMatrixAt(I,wr)}),C.instanceMatrix.needsUpdate=!0,C.computeBoundingSphere()},[e,k,n,d]),e.length===0)return null;const b=m!==null?e[m.instanceId]:null,S=`${e.length}-${e[0]?.image.imageId??0}`;return o.jsxs(o.Fragment,{children:[o.jsx("instancedMesh",{ref:u,dispose:null,args:[x,v,e.length],onPointerOver:C=>{if(C.instanceId===void 0||y())return;const M=e[C.instanceId];!M||M.image.imageId===n||(C.stopPropagation(),g({instanceId:C.instanceId,x:C.nativeEvent.clientX,y:C.nativeEvent.clientY}),s(M.image.imageId),document.body.style.cursor="pointer")},onPointerMove:C=>{if(y()){m!==null&&(g(null),s(null),document.body.style.cursor="");return}if(m!==null)g({instanceId:m.instanceId,x:C.nativeEvent.clientX,y:C.nativeEvent.clientY});else if(C.instanceId!==void 0){const M=e[C.instanceId];M&&M.image.imageId!==n&&(g({instanceId:C.instanceId,x:C.nativeEvent.clientX,y:C.nativeEvent.clientY}),s(M.image.imageId),document.body.style.cursor="pointer")}},onPointerOut:()=>{g(null),s(null),document.body.style.cursor=""},onPointerDown:d?C=>{if(C.instanceId===void 0)return;gu();const M=C.instanceId,I=C.nativeEvent.clientX,L=C.nativeEvent.clientY,P=setTimeout(()=>{if(!w.current||w.current.instanceId!==M)return;w.current.fired=!0;const _=e[M];_&&l(_.image.imageId)},It.longPressDelay);w.current={instanceId:M,x:I,y:L,timer:P,fired:!1}}:void 0,onPointerUp:d?C=>{const M=w.current;if(w.current=null,!M||(M.timer&&clearTimeout(M.timer),M.fired))return;const I=C.nativeEvent.clientX-M.x,L=C.nativeEvent.clientY-M.y;if(I*I+L*L>225)return;const P=e[M.instanceId];!P||P.image.imageId===n||(C.stopPropagation(),pu(),a(P.image.imageId))}:void 0,onClick:d?C=>{C.stopPropagation()}:C=>{if(C.instanceId===void 0)return;const M=e[C.instanceId];!M||M.image.imageId===n||(C.stopPropagation(),i(M.image.imageId))},onContextMenu:C=>{if(C.instanceId===void 0)return;const M=e[C.instanceId];!M||M.image.imageId===n||(C.stopPropagation(),C.nativeEvent.preventDefault(),C.nativeEvent.stopPropagation(),a(M.image.imageId))}},S),!d&&m!==null&&b&&o.jsx(Gr,{style:{position:"fixed",left:m.x+rn.cursorOffset,top:m.y+rn.cursorOffset,pointerEvents:"none",transform:"none"},calculatePosition:()=>[0,0],children:o.jsxs("div",{className:ve.container,children:[o.jsx("div",{className:ve.title,children:b.image.name}),o.jsx("div",{className:ve.subtitle,children:xu(b.image.imageId,b.image.cameraId,h)}),o.jsxs("div",{className:ve.subtitle,children:[b.numPoints3D," points"]}),o.jsxs("div",{className:ve.hint,children:[o.jsxs("div",{className:ve.hintRow,children:[o.jsxs("svg",{className:_t.hoverCard,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[o.jsx("rect",{x:"6",y:"2",width:"12",height:"20",rx:"6"}),o.jsx("path",{d:"M12 2v8"}),o.jsx("rect",{x:"6",y:"2",width:"6",height:"8",rx:"3",fill:"currentColor",opacity:"0.5"})]}),"Left: select"]}),o.jsxs("div",{className:ve.hintRow,children:[o.jsxs("svg",{className:_t.hoverCard,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[o.jsx("rect",{x:"6",y:"2",width:"12",height:"20",rx:"6"}),o.jsx("path",{d:"M12 2v8"}),o.jsx("rect",{x:"12",y:"2",width:"6",height:"8",rx:"3",fill:"currentColor",opacity:"0.5"})]}),r.has(b.image.imageId)?"Right: matches":b.image.imageId===c?"Right: back":"Right: fly to"]})]})]})})]})}const EM=10,PM=179,Cf=2,Sf=32,kf=f.memo(function({position:t,quaternion:n,camera:r,image:s,scale:i,imageFile:a,showImagePlane:l,isSelected:c,isMatched:d=!1,wouldGoBack:h=!1,selectionPlaneOpacity:u,color:m,cullAngleThreshold:g=kM,undistortionEnabled:p=!1,undistortionMode:y="fullFrame",numPoints3D:w,hoveredImageId:x,onHover:v,onClick:k,onContextMenu:b,onLongPress:S,disableInteraction:C=!1,touchMode:M=!1}){const I=me(Cs)>1,[L,P]=f.useState(!1),[_,N]=f.useState(!0),[D,B]=f.useState(null),[E,Z]=f.useState(!1),F=f.useRef(null);f.useEffect(()=>()=>{F.current?.timer&&clearTimeout(F.current.timer)},[]);const $=me(W=>W.imageUrlBase),[T,z]=f.useState(null);f.useEffect(()=>{if(!c||!l||a){z(null);return}let W=!1;return(async()=>{let Q=null;$?Q=Jn(s.name)??await ks($,s.name):bn()&&(Q=Vn(s.name)??await gs(s.name)),!W&&Q&&z(Q)})(),()=>{W=!0}},[c,l,a,s.name,$]);const H=a??T??void 0;f.useEffect(()=>{L&&x!==s.imageId&&(P(!1),B(null),document.body.style.cursor="")},[L,x,s.imageId]);const{camera:O,controls:J}=mr(),re=f.useRef(null),q=f.useRef(null),ie=ce(W=>W.cameraProjection),we=ce(W=>W.cameraFov),Ce=ce(W=>W.setCameraFov),Re=ce(W=>W.selectionColorMode),ee=ce(W=>W.selectionAnimationSpeed),he=f.useRef(0),Se=f.useRef(0),xe=5;f.useEffect(()=>{if(!c||!L||ie!=="perspective")return;const W=le=>{le.preventDefault(),le.stopPropagation(),J?.wheelHandled&&(J.wheelHandled.current=!0);const Q=le.deltaY>0?Cf:-Cf,pe=Math.max(EM,Math.min(PM,we+Q));Ce(pe)};return window.addEventListener("wheel",W,{passive:!1,capture:!0}),()=>window.removeEventListener("wheel",W,{capture:!0})},[c,L,ie,we,Ce,J]);const Ae=()=>J?.dragging?.current??!1,ye=f.useRef(!1);ye.current=L,f.useEffect(()=>()=>{ye.current&&(v(null),document.body.style.cursor="")},[v]);const Pe=R0(H,s.name,l),Ye=D0(H,s.name,c&&l),$e=c?Ye??Pe:Pe,qe=f.useRef(null);$e&&(qe.current=$e);const ct=$e??qe.current,K=l&&ct&&_,Le=f.useRef(null);re.current&&Le.current!==(K?ct:null)&&(re.current.map=K?ct:null,re.current.needsUpdate=!0,Le.current=K?ct:null);const fe=f.useMemo(()=>{const W=r.width/r.height,le=r.params[0]||1,Q=i*r.width/(2*le),pe=Q/W;return{width:Q*2,height:pe*2,depth:i}},[r,i]),ae=f.useMemo(()=>{const W=fe.width/2,le=fe.height/2,Q=[new X(-W,-le,0),new X(W,-le,0),new X(W,le,0),new X(-W,le,0)],pe=new us().setFromPoints(Q),Ne=new Hl({color:st.frustum.selected,transparent:!0}),Je=new Sg(pe,Ne);return Je.position.z=fe.depth,Je},[fe.width,fe.height,fe.depth]);f.useEffect(()=>()=>{ae&&(ae.geometry.dispose(),ae.material.dispose())},[ae]),pr((W,le)=>{if(c&&ae){const Q=ae.material;if(Re==="rainbow")he.current=(he.current+le*ee*Wr.speedMultiplier)%1,Q.color.copy(gc(he.current));else if(Re==="blink"){const pe=W.clock.elapsedTime*ee*2,Ne=(Math.sin(pe)+1)/2;Q.opacity=.3+.7*Ne,Q.color.set(m)}else Q.opacity=1,Q.color.set(m)}if(l&&q.current){if(c){_||N(!0);return}if(Se.current=(Se.current+1)%xe,Se.current!==0)return;if(q.current.getWorldPosition(Nl),q.current.getWorldQuaternion(wf),Nl.distanceTo(O.position)<i*3){_||N(!0);return}Ws.set(0,0,1).applyQuaternion(wf),vf.copy(O.position).sub(Nl).normalize();const Je=-Ws.dot(vf)>=g;_!==Je&&N(Je)}});const De=L?st.frustum.hover:m,Y=L||E;return o.jsxs("group",{ref:q,position:t,quaternion:n,children:[o.jsxs("mesh",{position:[0,0,fe.depth],renderOrder:c?100:0,userData:{isSelectedPlane:c},raycast:C?()=>{}:void 0,onPointerDown:M&&!C?W=>{gu();const le=W.nativeEvent.clientX,Q=W.nativeEvent.clientY,pe=setTimeout(()=>{F.current&&(F.current.fired=!0,S?.(s.imageId))},It.longPressDelay);F.current={x:le,y:Q,timer:pe,fired:!1}}:void 0,onPointerUp:M&&!C?W=>{const le=F.current;if(F.current=null,!le||(le.timer&&clearTimeout(le.timer),le.fired))return;const Q=W.nativeEvent.clientX-le.x,pe=W.nativeEvent.clientY-le.y;Q*Q+pe*pe>225||(W.stopPropagation(),c?Z(Ne=>!Ne):(pu(),b(s.imageId)))}:void 0,onClick:C?void 0:M?W=>{W.stopPropagation()}:W=>{W.stopPropagation(),k(s.imageId)},onContextMenu:C||M?void 0:W=>{W.stopPropagation(),W.nativeEvent.preventDefault(),W.nativeEvent.stopPropagation(),b(s.imageId)},onPointerOver:C?void 0:W=>{Ae()||!c&&(W.intersections.some(Q=>Q.object.userData?.isSelectedPlane===!0)||W.intersections[0]?.object!==W.object)||(W.stopPropagation(),P(!0),B({x:W.clientX,y:W.clientY}),v(s.imageId),document.body.style.cursor="pointer")},onPointerMove:C?void 0:W=>{if(Ae()){L&&(P(!1),B(null),v(null),document.body.style.cursor="");return}L&&B({x:W.clientX,y:W.clientY})},onPointerOut:C?void 0:()=>{P(!1),B(null),v(null),document.body.style.cursor=""},children:[p&&y==="fullFrame"?o.jsx("planeGeometry",{args:[fe.width,fe.height,Sf,Sf]}):o.jsx("planeGeometry",{args:[fe.width,fe.height]}),p&&K&&ct?o.jsx(vM,{map:ct,camera:r,undistortionEnabled:p,undistortionMode:y,planeWidth:fe.width,planeHeight:fe.height,opacity:Y?u*.5:u,color:st.material.white,side:ao,depthTest:!c,forceTransparent:c,forceDepthWrite:c?!1:void 0}):(()=>{const W=Y?K?u*.5:Wn.frustum.hoveredNoTexture:K?u:u*.2,{transparent:le,depthWrite:Q}=Gl(W);return o.jsx("meshBasicMaterial",{ref:re,map:K?ct:null,color:K?st.material.white:De,side:ao,transparent:c?!0:le,depthWrite:c?!1:Q,depthTest:!c,toneMapped:!1,opacity:W})})()]}),c&&o.jsx("primitive",{object:ae}),!M&&L&&D&&o.jsx(Gr,{style:{position:"fixed",left:D.x+rn.cursorOffset,top:D.y+rn.cursorOffset,pointerEvents:"none",transform:"none"},calculatePosition:()=>[0,0],children:o.jsxs("div",{className:ve.container,children:[o.jsx("div",{className:ve.title,children:s.name}),o.jsx("div",{className:ve.subtitle,children:xu(s.imageId,s.cameraId,I)}),o.jsxs("div",{className:ve.subtitle,children:[w," points"]}),o.jsxs("div",{className:ve.hint,children:[c&&ie==="perspective"&&o.jsxs("div",{className:ve.hintRow,children:[o.jsxs("svg",{className:_t.hoverCard,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[o.jsx("rect",{x:"6",y:"2",width:"12",height:"20",rx:"6"}),o.jsx("path",{d:"M12 6v4M12 14v4M9 8l3-3 3 3M9 16l3 3 3-3"})]}),"Scroll: FOV"]}),o.jsxs("div",{className:ve.hintRow,children:[o.jsxs("svg",{className:_t.hoverCard,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[o.jsx("rect",{x:"6",y:"2",width:"12",height:"20",rx:"6"}),o.jsx("path",{d:"M12 2v8"}),o.jsx("rect",{x:"6",y:"2",width:"6",height:"8",rx:"3",fill:"currentColor",opacity:"0.5"})]}),c?"Left: details":"Left: select"]}),o.jsxs("div",{className:ve.hintRow,children:[o.jsxs("svg",{className:_t.hoverCard,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[o.jsx("rect",{x:"6",y:"2",width:"12",height:"20",rx:"6"}),o.jsx("path",{d:"M12 2v8"}),o.jsx("rect",{x:"12",y:"2",width:"6",height:"8",rx:"3",fill:"currentColor",opacity:"0.5"})]}),d?"Right: matches":h?"Right: back":"Right: fly to"]}),c&&o.jsx("div",{className:ve.hintRow,children:"(U) undistort"})]})]})})]})}),Al=f.memo(function({position:t,quaternion:n,planeDepth:r,planeWidth:s,planeHeight:i,onSelect:a,onGoto:l,onInfo:c,onClose:d}){return o.jsx("group",{position:t,quaternion:n,children:o.jsx(Gr,{position:[s/2,i/2,r],style:{pointerEvents:"auto"},children:o.jsxs("div",{className:Lt.container,onMouseLeave:d,children:[o.jsxs("button",{className:Lt.button,onClick:a,children:[o.jsxs("svg",{className:Lt.icon,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[o.jsx("circle",{cx:"12",cy:"12",r:"10"}),o.jsx("circle",{cx:"12",cy:"12",r:"3",fill:"currentColor"})]}),"Select"]}),o.jsxs("button",{className:Lt.button,onClick:l,children:[o.jsx("svg",{className:Lt.icon,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:o.jsx("path",{d:"M5 12h14M12 5l7 7-7 7"})}),"Go to"]}),o.jsxs("button",{className:Lt.button,onClick:c,children:[o.jsxs("svg",{className:Lt.icon,viewBox:"0 0 24 24",fill:"currentColor",children:[o.jsx("circle",{cx:"12",cy:"5",r:"2.5"}),o.jsx("rect",{x:"9.5",y:"10",width:"5",height:"12",rx:"1"})]}),"Info"]})]})})})});function If(){const e=me(oe=>oe.reconstruction),t=me(oe=>oe.loadedFiles),n=me(oe=>oe.imageUrlBase),r=yi(),s=js(),i=qa(),a=Ga(),l=mu(),c=Ka(),{displayMode:d,scale:h,scaleFactor:u,colorMode:m,singleColor:g,standbyOpacity:p,undistortionEnabled:y,undistortionMode:w}=r,x=h*parseFloat(u),{selectedImageId:v,planeOpacity:k,colorMode:b,color:S,animationSpeed:C,unselectedOpacity:M}=s,{visible:I,displayMode:L,opacity:P,color:_}=i,N=Ip(),D=d==="imageplane",B=G(oe=>oe.openImageDetail),E=G(oe=>oe.setMatchedImageId),Z=G(oe=>oe.setShowMatchesInModal),F=G(oe=>oe.touchMode),$=Qn(oe=>oe.pendingDeletions),[T,z]=f.useState(null),[H,O]=f.useState(null),{camera:J,controls:re,gl:q,size:ie}=mr(),{fov:we,autoFovEnabled:Ce}=a,Re=f.useRef(new X),ee=f.useRef(new Tt),he=f.useRef(0),Se=f.useRef(!1),xe=f.useRef(!1),Ae=f.useRef(null);f.useEffect(()=>{const oe=ge=>{Ae.current={x:ge.clientX,y:ge.clientY}};return document.addEventListener("mousemove",oe),()=>document.removeEventListener("mousemove",oe)},[]),pr(()=>{const oe=Re.current.distanceToSquared(J.position)>1e-4,ge=ee.current.angleTo(J.quaternion)>.001,Xe=performance.now();if(oe||ge)Re.current.copy(J.position),ee.current.copy(J.quaternion),he.current=Xe,Se.current||(Se.current=!0,_0());else if(Se.current&&Xe-he.current>rr.transitionBase&&(Se.current=!1,T0(),xe.current&&Ae.current&&q?.domElement)){xe.current=!1;const dt=q.domElement,mt=new PointerEvent("pointermove",{clientX:Ae.current.x,clientY:Ae.current.y,bubbles:!0,cancelable:!0,pointerType:"mouse",pointerId:1});dt.dispatchEvent(mt)}});const ye=t?.imageFiles,Pe=f.useMemo(()=>{if(!e)return new Map;const oe=new Map;let ge=0;for(const Xe of e.cameras.keys())oe.set(Xe,ge++);return oe},[e]),Ye=f.useMemo(()=>{const oe=new Map;if(!e)return oe;const ge=new Map;for(const dt of e.images.values()){const mt=dt.name.split(/[/\\]/),Rt=mt.length>=2?mt[mt.length-1]:dt.name,xt=ge.get(Rt)??[];xt.push(dt.imageId),ge.set(Rt,xt)}let Xe=0;for(const dt of ge.values())if(dt.length>=2){for(const mt of dt)oe.set(mt,Xe);Xe++}return oe},[e]),$e=f.useMemo(()=>{if(!e||v===null||!I)return new Set;const oe=e.connectedImagesIndex.get(v);return oe?new Set(oe.keys()):new Set},[e,v,I]),qe=ce(oe=>oe.navigationHistory),ct=f.useMemo(()=>qe.length===0?null:qe[qe.length-1].toImageId,[qe]),[K,Le]=f.useState(0),[fe,ae]=f.useState(0),De=f.useMemo(()=>{if(!e)return[];const oe=[];for(const ge of e.images.values()){if($.has(ge.imageId))continue;const Xe=e.cameras.get(ge.cameraId);if(!Xe)continue;const dt=ds(ge),mt=Tc(ge);if(!Number.isFinite(dt.x)||!Number.isFinite(dt.y)||!Number.isFinite(dt.z))continue;let Rt;n?Rt=Jn(ge.name):bn()?Rt=Vn(ge.name)??void 0:Rt=Zr(ye,ge.name),oe.push({image:ge,camera:Xe,position:dt,quaternion:mt,imageFile:Rt,cameraIndex:Pe.get(ge.cameraId)??0,numPoints3D:e.imageStats.get(ge.imageId)?.numPoints3D??0})}return oe},[e,d,ye,n,Pe,K,fe,$]),Y=f.useCallback(oe=>{O(null),oe===v?B(oe):l.setSelectedImageId(oe)},[v,l,B]),W=f.useCallback(oe=>{const ge=De.find(xt=>xt.image.imageId===oe);if(!ge)return;if(oe===v){const xt=c.peekNavigationHistory();if(xt&&xt.toImageId===oe){const Xt=c.popNavigationHistory();Xt&&(z(null),document.body.style.cursor="",xe.current=!0,c.flyToState(Xt.fromState),l.setSelectedImageId(Xt.fromImageId));return}l.setSelectedImageId(null);return}if(v!==null&&$e.has(oe)){Z(!0),E(oe),B(v),setTimeout(()=>E(oe),0);return}ge.imageFile&&Kl(ge.imageFile,ge.image.name);const Xe=re?.getCurrentViewState,dt=c.peekNavigationHistory();if(Xe&&dt&&dt.toImageId===oe){const xt=c.popNavigationHistory();xt&&(z(null),document.body.style.cursor="",xe.current=!0,c.flyToState(xt.fromState),l.setSelectedImageId(xt.fromImageId));return}if(Xe){const xt=Xe();c.pushNavigationHistory({fromState:xt,fromImageId:v,toImageId:oe})}if(z(null),document.body.style.cursor="",xe.current=!0,Ce){const xt=ge.camera.params[0]||1,Xt=x*ge.camera.width/xt,Dn=x*ge.camera.height/xt,de=x,Me=ie.width/ie.height,Fe=we*Math.PI/180,_e=2*de*Math.tan(Fe/2),et=_e*Me,Ve=Dn/_e,nt=Xt/et,He=Math.max(Ve,nt);if(He>1||He<.5){const Ht=Xt/Dn;let it;if(Ht<Me){const St=Dn/.8;it=2*Math.atan(St/(2*de))*180/Math.PI}else{const sn=Xt/.8/Me;it=2*Math.atan(sn/(2*de))*180/Math.PI}const pn=Math.max(5,Math.min(120,it));c.setFov(pn)}}l.setSelectedImageId(oe),c.flyToImage(oe);const mt=mh(ge.camera);(mt.k1!==0||mt.k2!==0||mt.k3!==0||mt.k4!==0||mt.p1!==0||mt.p2!==0)&&pa.getState().showTip("undistortion","Press U to toggle lens undistortion")},[De,c,l,v,$e,B,E,Z,re,ie,we,x,Ce]),le=f.useCallback(oe=>{const ge=De.find(Xe=>Xe.image.imageId===oe);ge?.imageFile&&Kl(ge.imageFile,ge.image.name)},[De]);f.useEffect(()=>{if(!n||!e||v===null)return;const oe=e.images.get(v);if(!oe)return;Jn(oe.name)||ks(n,oe.name).then(Xe=>{Xe&&Le(dt=>dt+1)})},[n,e,v]),f.useEffect(()=>{if(n||!bn()||!e||v===null)return;const oe=e.images.get(v);if(!oe)return;Vn(oe.name)||gs(oe.name).then(Xe=>{Xe&&ae(dt=>dt+1)})},[n,e,v]);const Q=f.useCallback(()=>{H&&(le(H.imageId),l.setSelectedImageId(H.imageId),O(null))},[H,l,le]),pe=f.useCallback(()=>{if(!H)return;const oe=H.imageId;le(oe);const ge=re?.getCurrentViewState;if(z(null),document.body.style.cursor="",xe.current=!0,!ge){c.flyToImage(oe),O(null);return}const Xe=ge(),dt=c.peekNavigationHistory();if(dt&&dt.toImageId===oe){const mt=c.popNavigationHistory();mt&&(c.flyToState(mt.fromState),l.setSelectedImageId(mt.fromImageId))}else c.pushNavigationHistory({fromState:Xe,fromImageId:v,toImageId:oe}),c.flyToImage(oe);O(null)},[H,c,l,le,re,v]),Ne=f.useCallback(()=>{H&&(B(H.imageId),O(null))},[H,B]),Je=f.useCallback(()=>{O(null)},[]);if(De.length===0||N)return null;const ke=v!==null?De.find(oe=>oe.image.imageId===v)??null:null,je=b==="rainbow"?st.frustum.selected:S,jt=ke&&o.jsx(kf,{position:ke.position,quaternion:ke.quaternion,camera:ke.camera,image:ke.image,scale:x,imageFile:ke.imageFile,showImagePlane:!0,isSelected:!0,isMatched:!1,wouldGoBack:ke.image.imageId===ct,selectionPlaneOpacity:k,color:je,undistortionEnabled:y,undistortionMode:w,numPoints3D:ke.numPoints3D,hoveredImageId:T,onHover:z,onClick:Y,onContextMenu:W,onLongPress:B,touchMode:F},`selected-${ke.image.imageId}`);return d==="arrow"?o.jsxs("group",{children:[o.jsx(MM,{frustums:De,cameraScale:x,selectedImageId:v,hoveredImageId:T,matchedImageIds:$e,matchesOpacity:P,matchesDisplayMode:L,matchesColor:_,frustumColorMode:m,frustumSingleColor:g,frustumStandbyOpacity:p,selectionColorMode:b,selectionColor:S,selectionAnimationSpeed:C,unselectedCameraOpacity:M,imageFrameIndexMap:Ye,onHover:z,onClick:Y,onContextMenu:W,onLongPress:B,lastNavigationToImageId:ct,touchMode:F,pendingDeletions:$}),jt,H&&o.jsx(Al,{position:H.position,quaternion:H.quaternion,planeDepth:H.planeDepth,planeWidth:H.planeWidth,planeHeight:H.planeHeight,onSelect:Q,onGoto:pe,onInfo:Ne,onClose:Je})]}):d==="imageplane"?o.jsxs("group",{children:[o.jsx(bf,{frustums:De,cameraScale:x,selectedImageId:v,matchedImageIds:$e,onHover:z,onClick:Y,onContextMenu:W,onLongPress:B,lastNavigationToImageId:ct,touchMode:F}),De.map(oe=>{if(oe.image.imageId===v)return null;const Xe=$e.has(oe.image.imageId),dt=$.has(oe.image.imageId),mt=dt?st.frustum.deleted:Xe?_:vu(m,oe.cameraIndex,oe.image.imageId,Ye,g);let Rt;return dt?Rt=.3:v===null?Rt=k:Xe?Rt=k*P:Rt=k*M,o.jsx(kf,{position:oe.position,quaternion:oe.quaternion,camera:oe.camera,image:oe.image,scale:x,imageFile:oe.imageFile,showImagePlane:v===null,isSelected:!1,isMatched:Xe,wouldGoBack:oe.image.imageId===ct,selectionPlaneOpacity:Rt,color:mt,cullAngleThreshold:IM,undistortionEnabled:y,undistortionMode:w,numPoints3D:oe.numPoints3D,hoveredImageId:T,onHover:z,onClick:Y,onContextMenu:W,disableInteraction:!0,touchMode:F},oe.image.imageId)}),jt,H&&o.jsx(Al,{position:H.position,quaternion:H.quaternion,planeDepth:H.planeDepth,planeWidth:H.planeWidth,planeHeight:H.planeHeight,onSelect:Q,onGoto:pe,onInfo:Ne,onClose:Je})]}):o.jsxs("group",{children:[o.jsx(jM,{frustums:De,cameraScale:x,selectedImageId:v,hoveredImageId:T,matchedImageIds:$e,matchesOpacity:P,matchesDisplayMode:L,matchesColor:_,frustumColorMode:m,frustumSingleColor:g,frustumStandbyOpacity:p,selectionColorMode:b,selectionColor:S,selectionAnimationSpeed:C,unselectedCameraOpacity:M,showImagePlanes:D,imageFrameIndexMap:Ye,pendingDeletions:$}),o.jsx(bf,{frustums:De,cameraScale:x,selectedImageId:v,matchedImageIds:$e,onHover:z,onClick:Y,onContextMenu:W,onLongPress:B,lastNavigationToImageId:ct,touchMode:F}),jt,H&&o.jsx(Al,{position:H.position,quaternion:H.quaternion,planeDepth:H.planeDepth,planeWidth:H.planeWidth,planeHeight:H.planeHeight,onSelect:Q,onGoto:pe,onInfo:Ne,onClose:Je})]})}function Mf(){const e=me(g=>g.reconstruction),t=yi(),n=js(),r=qa(),{selectedImageId:s}=n,{displayMode:i}=t,{visible:a,displayMode:l,opacity:c,color:d}=r,h=f.useRef(null),u=f.useRef(0);pr((g,p)=>{a&&l==="blink"&&h.current&&(u.current=(u.current+p)%2,h.current.opacity=c*(.1+.9*yu(u.current)))});const m=f.useMemo(()=>{if(!e||s===null||!a||i==="imageplane")return null;const g=e.images.get(s);if(!g)return null;const p=ds(g),y=e.connectedImagesIndex.get(s);if(!y||y.size===0)return null;const w=new Set(y.keys()),x=[];for(const k of w){const b=e.images.get(k);if(!b)continue;const S=ds(b);x.push(p.x,p.y,p.z),x.push(S.x,S.y,S.z)}const v=new us;return v.setAttribute("position",new Ks(x,3)),v},[e,s,a,i]);return f.useEffect(()=>()=>{m?.dispose()},[m]),!a||i==="imageplane"||!m?null:o.jsx("lineSegments",{geometry:m,renderOrder:999,children:o.jsx("lineBasicMaterial",{ref:h,color:d,transparent:!0,opacity:c,depthTest:!1})})}const ur=new Er;function NM(e){return e<.3?e/.3:e<.6?1:e<1?1-(e-.6)/.4:0}function AM(e){const t=e.split(/[/\\]/);return t.length>=2?t[t.length-1]:e}function jf(){const e=me(c=>c.reconstruction),t=wp(),n=js(),r=f.useRef(null),s=f.useRef(0),i=f.useRef(null),a=f.useMemo(()=>{if(!t.visible||!e)return null;const c=new Map;for(const p of e.images.values()){const y=AM(p.name),w=c.get(y);w?w.push(p):c.set(y,[p])}const d=[],h=[],u=[],m=[];let g=0;for(const p of c.values()){if(p.length<2)continue;const y=p.map(v=>ds(v)),w=new Set(p.map(v=>v.imageId));ur.set(Yl(g)),g++;const x=y[0];for(let v=1;v<y.length;v++){const k=y[v];d.push(x.x,x.y,x.z),h.push(ur.r,ur.g,ur.b),u.push(1),d.push(k.x,k.y,k.z),h.push(ur.r,ur.g,ur.b),u.push(1),m.push(w),m.push(w)}}return d.length===0?null:{positions:new Float32Array(d),colors:new Float32Array(h),alphas:new Float32Array(u),lineFrameImageIds:m}},[e,t.visible,t.colorMode]),l=f.useMemo(()=>new ui({vertexShader:Mp,fragmentShader:jp,vertexColors:!0,transparent:!0,depthWrite:!1,depthTest:!0,polygonOffset:!0,polygonOffsetFactor:1,polygonOffsetUnits:1}),[]);return pr((c,d)=>{if(!r.current||!a)return;const h=r.current.getAttribute("color"),u=r.current.getAttribute("alpha");if(!h||!u)return;const m=t.displayMode==="blink";m&&(s.current=(s.current+d)%2);const g=i.current,p=!g||g.selectedImageId!==n.selectedImageId||g.rigOpacity!==t.opacity||g.unselectedOpacity!==n.unselectedOpacity;if(!m&&!p)return;const y=m?.1+.9*NM(s.current):1,{lineFrameImageIds:w}=a;for(let x=0;x<u.count;x++){const v=w[x],k=n.selectedImageId!==null&&v.has(n.selectedImageId);let b;n.selectedImageId===null||k?b=t.opacity*y:b=t.opacity*n.unselectedOpacity*y,u.setX(x,b)}if(t.colorMode==="single"){ur.set(t.color);for(let x=0;x<h.count;x++)h.setXYZ(x,ur.r,ur.g,ur.b);h.needsUpdate=!0}u.needsUpdate=!0,i.current={selectedImageId:n.selectedImageId,rigOpacity:t.opacity,unselectedOpacity:n.unselectedOpacity}}),!t.visible||!a?null:o.jsx("lineSegments",{material:l,renderOrder:2,children:o.jsxs("bufferGeometry",{ref:r,children:[o.jsx("bufferAttribute",{attach:"attributes-position",args:[a.positions,3]}),o.jsx("bufferAttribute",{attach:"attributes-color",args:[a.colors,3]}),o.jsx("bufferAttribute",{attach:"attributes-alpha",args:[a.alphas,1]})]})})}const ls=f.memo(function({checked:t,onChange:n,size:r="sm",disabled:s=!1,label:i,labelPosition:a="left",className:l=""}){const c=v0(t,r,s),d=()=>{s||n(!t)},h=m=>{(m.key===" "||m.key==="Enter")&&(m.preventDefault(),s||n(!t))},u=o.jsx("div",{role:"switch","aria-checked":t,"aria-disabled":s,tabIndex:s?-1:0,className:c.track,onClick:d,onKeyDown:h,children:o.jsx("span",{className:c.thumb,style:c.thumbStyle})});return i?o.jsxs("label",{className:`${$n.container} ${l}`,children:[a==="left"&&o.jsx("span",{className:$n.label,children:i}),u,a==="right"&&o.jsx("span",{className:$n.label,children:i})]}):u}),Yt=cn,Ef=({className:e="w-3 h-3"})=>o.jsxs("svg",{className:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[o.jsx("rect",{x:"6",y:"2",width:"12",height:"20",rx:"6"}),o.jsx("line",{x1:"12",y1:"6",x2:"12",y2:"10"})]});function Ap(e){if(e>=1)return 0;const t=e.toString(),n=t.indexOf(".");return n===-1?0:t.length-n-1}function LM(e,t){const n=Ap(t),r=Math.pow(10,n);return Math.round(e*r)/r}const pt=f.memo(function({label:t,value:n,min:r,max:s,step:i,onChange:a,formatValue:l,inputMax:c}){const[d,h]=f.useState(!1),[u,m]=f.useState(""),g=f.useRef(null),p=n??r,y=Ap(i),w=l?l(p):p.toFixed(y),x=(p-r)/(s-r)*100,v=()=>{m(String(p)),h(!0)};f.useEffect(()=>{d&&g.current&&(g.current.focus(),g.current.select())},[d]);const k=()=>{const C=parseFloat(u);if(!isNaN(C)){const I=Math.min(c??s,Math.max(r,C));a(I)}h(!1)},b=C=>{C.key==="Enter"?k():C.key==="Escape"&&h(!1)},S=C=>{C.preventDefault();const M=C.deltaY>0?-i:i,I=LM(Math.min(s,Math.max(r,p+M)),i);a(I)};return o.jsxs("div",{className:Yt.row,onWheel:S,children:[o.jsx("label",{className:Yt.label,children:t}),o.jsx("input",{type:"range",min:r,max:s,step:i,value:p,onChange:C=>a(parseFloat(C.target.value)),className:Yt.slider,style:{"--range-progress":`${x}%`}}),d?o.jsx("input",{ref:g,type:"text",value:u,onChange:C=>m(C.target.value),onBlur:k,onKeyDown:b,className:Yt.valueInput}):o.jsx("span",{className:Yt.value,onDoubleClick:v,title:"Double-click to edit",children:w})]})}),Pf=f.memo(function({label:t,value:n,onChange:r}){const[s,i]=f.useState(!1),[a,l]=f.useState(""),c=f.useRef(null),d=()=>{l(n),i(!0)};f.useEffect(()=>{s&&c.current&&(c.current.focus(),c.current.select())},[s]);const h=()=>{const m=a.startsWith("#")?a:`#${a}`;/^#[0-9A-Fa-f]{6}$/.test(m)&&r(m.toLowerCase()),i(!1)},u=m=>{m.key==="Enter"?h():m.key==="Escape"&&i(!1)};return o.jsxs("div",{className:Yt.row,children:[o.jsx("label",{className:Yt.label,children:t}),o.jsxs("div",{className:"flex items-center gap-2 flex-1",children:[o.jsx("label",{className:"relative w-8 h-6 rounded overflow-hidden border border-ds-border hover:border-ds-border-hover transition-colors cursor-pointer block shrink-0",style:{backgroundColor:n},children:o.jsx("input",{type:"color",value:n,onChange:m=>r(m.target.value),className:"sr-only"})}),s?o.jsx("input",{ref:c,type:"text",value:a,onChange:m=>l(m.target.value),onBlur:h,onKeyDown:u,className:"bg-ds-bg-secondary text-ds-primary text-sm font-mono px-1 py-0.5 rounded border border-ds-border w-16",maxLength:7}):o.jsx("span",{className:"text-ds-secondary text-sm font-mono cursor-pointer hover:text-ds-primary transition-colors",onDoubleClick:d,title:"Double-click to edit",children:n.toUpperCase()})]})]})}),Ll=f.memo(function({label:t,value:n,onChange:r}){const[s,i]=f.useState(!1),[a,l]=f.useState(""),c=f.useRef(null),h=wo(n).h,u=w=>{r(es(w,100,50))},m=w=>{w.preventDefault();const x=w.deltaY>0?-5:5,v=(h+x+360)%360;u(v)},g=()=>{l(String(h)),i(!0)};f.useEffect(()=>{s&&c.current&&(c.current.focus(),c.current.select())},[s]);const p=()=>{const w=parseInt(a);if(!isNaN(w)){const x=(w%360+360)%360;u(x)}i(!1)},y=w=>{w.key==="Enter"?p():w.key==="Escape"&&i(!1)};return o.jsxs("div",{className:Yt.row,onWheel:m,children:[o.jsx("label",{className:Yt.label,children:t}),o.jsxs("div",{className:"relative flex-1 min-w-0 h-4 flex items-center",children:[o.jsx("div",{className:"absolute left-0 right-0 h-1.5 rounded-full z-0",style:{background:xa.hueGradient}}),o.jsx("input",{type:"range",min:0,max:360,step:1,value:h,onChange:w=>u(parseInt(w.target.value)),className:xa.hueSlider})]}),s?o.jsx("input",{ref:c,type:"text",value:a,onChange:w=>l(w.target.value),onBlur:p,onKeyDown:y,className:Yt.valueInput,style:{color:n}}):o.jsxs("span",{className:Yt.value,style:{color:n},onDoubleClick:g,title:"Double-click to edit",children:[h,"Â°"]})]})}),Nf=f.memo(function({label:t,value:n,onChange:r}){const[s,i]=f.useState(!1),[a,l]=f.useState(""),c=f.useRef(null),d=p=>{p.preventDefault();const y=p.deltaY>0?-5:5,w=(n+y+360)%360;r(w)},h=()=>{l(String(n)),i(!0)};f.useEffect(()=>{s&&c.current&&(c.current.focus(),c.current.select())},[s]);const u=()=>{const p=parseInt(a);if(!isNaN(p)){const y=(p%360+360)%360;r(y)}i(!1)},m=p=>{p.key==="Enter"?u():p.key==="Escape"&&i(!1)},g=es(n,100,50);return o.jsxs("div",{className:Yt.row,onWheel:d,children:[o.jsx("label",{className:Yt.label,children:t}),o.jsxs("div",{className:"relative flex-1 min-w-0 h-4 flex items-center",children:[o.jsx("div",{className:"absolute left-0 right-0 h-1.5 rounded-full z-0",style:{background:xa.hueGradient}}),o.jsx("input",{type:"range",min:0,max:360,step:1,value:n,onChange:p=>r(parseInt(p.target.value)),className:xa.hueSlider})]}),s?o.jsx("input",{ref:c,type:"text",value:a,onChange:p=>l(p.target.value),onBlur:u,onKeyDown:m,className:Yt.valueInput,style:{color:g}}):o.jsxs("span",{className:Yt.value,style:{color:g},onDoubleClick:h,title:"Double-click to edit",children:[n,"Â°"]})]})}),br=f.memo(function({label:t,checked:n,onChange:r}){return o.jsxs("div",{className:Yt.row,children:[o.jsx("label",{className:Yt.label,children:t}),o.jsx("div",{className:"flex-1"}),o.jsx(ls,{checked:n,onChange:()=>r(!n),size:"sm"})]})}),Kt=f.memo(function({label:t,value:n,onChange:r,options:s}){const i=a=>{a.preventDefault();const l=s.findIndex(c=>c.value===n);if(a.deltaY>0){const c=Math.min(l+1,s.length-1);r(s[c].value)}else{const c=Math.max(l-1,0);r(s[c].value)}};return o.jsxs("div",{className:Yt.row,onWheel:i,children:[o.jsx("label",{className:Yt.label,children:t}),o.jsx("select",{value:n,onChange:a=>r(a.target.value),className:Yt.selectRight,children:s.map(a=>o.jsx("option",{value:a.value,children:a.label},a.value))})]})}),_M=48,TM=f.memo(function({title:t,children:n}){const r=f.useRef(null),[s,i]=f.useState(null),a=f.useRef(0);return f.useLayoutEffect(()=>{if(!r.current)return;const l=r.current.getBoundingClientRect(),c=Math.abs(l.height-a.current);if(a.current>0&&c<5)return;a.current=l.height;const h=window.innerHeight-_M;if(l.bottom>h){const u=l.bottom-h;i(-u)}else i(null)},[n]),o.jsx("div",{ref:r,className:Yt.panelWrapper,style:s!==null?{top:s}:void 0,children:o.jsxs("div",{className:Yt.panel,children:[o.jsx("div",{className:Yt.panelTitle,children:t}),n]})})}),Tn=f.memo(function({panelId:t,activePanel:n,setActivePanel:r,icon:s,tooltip:i,isActive:a=!1,onClick:l,onDoubleClick:c,panelTitle:d,children:h,disabled:u=!1}){const m=n===t,g=d&&h,p=G(x=>x.touchMode),y=f.useRef(null),w=f.useCallback(()=>{if(!u){if(!g){l?.();return}m?l?.():r(t)}},[u,g,m,l,r,t]);return f.useEffect(()=>{if(!p||!m||!g)return;const x=v=>{y.current&&!y.current.contains(v.target)&&r(null)};return document.addEventListener("touchstart",x,{passive:!0}),()=>document.removeEventListener("touchstart",x)},[p,m,g,r]),o.jsxs("div",{ref:y,className:"relative w-10 control-button-responsive",onMouseEnter:p?void 0:()=>!u&&r(t),onMouseLeave:p?void 0:()=>r(null),children:[o.jsx("button",{onClick:u?void 0:p?w:l,onDoubleClick:u?void 0:c,disabled:u,className:`group ${x0(a,m)} ${u?"opacity-40 cursor-not-allowed":""}`,...!g&&Mh(u?`${i} (no data loaded)`:i,"left"),children:s}),g&&m&&!u&&o.jsx(TM,{title:d,children:h})]})}),eo=cn,RM=f.memo(function({activePanel:t,setActivePanel:n}){const[r,s]=f.useState(null),i=rt(E=>E.screenshotSize),a=rt(E=>E.setScreenshotSize),l=rt(E=>E.screenshotFormat),c=rt(E=>E.setScreenshotFormat),d=rt(E=>E.screenshotHideLogo),h=rt(E=>E.setScreenshotHideLogo),u=rt(E=>E.takeScreenshot),m=rt(E=>E.getScreenshotBlob),g=rt(E=>E.recordGif),p=rt(E=>E.isRecordingGif),y=rt(E=>E.gifRenderProgress),w=rt(E=>E.gifBlobUrl),x=rt(E=>E.gifDuration),v=rt(E=>E.setGifDuration),k=rt(E=>E.gifDownsample),b=rt(E=>E.setGifDownsample),S=rt(E=>E.downloadGif),C=rt(E=>E.stopRecording),M=rt(E=>E.recordingFormat),I=rt(E=>E.setRecordingFormat),L=rt(E=>E.recordingQuality),P=rt(E=>E.setRecordingQuality),_=rt(E=>E.gifSpeed),N=rt(E=>E.setGifSpeed),D=f.useCallback(async()=>{if(!m)return!1;try{const E=await m();if(E)return await navigator.clipboard.write([new ClipboardItem({"image/png":E})]),Ft.getState().addNotification("info","Screenshot copied! Press Ctrl+V to paste",4e3),!0}catch(E){console.error("Failed to copy screenshot to clipboard:",E)}return!1},[m]),B=f.useCallback(()=>{if(!g||p||r!==null)return;s(3),Ft.getState().addNotification("info","Countdown (3)",900);const E=Z=>{Z>0?(s(Z),Z<3&&Ft.getState().addNotification("info",`Countdown (${Z})`,900),setTimeout(()=>E(Z-1),1e3)):(s(null),Ft.getState().addNotification("info","Recording started!",2e3),g().then(()=>{Ft.getState().addNotification("info","Recording complete! Downloading...",3e3),setTimeout(()=>{S()},100)}))};E(3)},[g,p,r,S]);return o.jsx(Tn,{panelId:"screenshot",activePanel:t,setActivePanel:n,icon:o.jsx(ip,{className:"w-6 h-6"}),tooltip:"Save screenshot",onClick:u,panelTitle:"Screenshot",children:o.jsxs("div",{className:eo.panelContent,children:[o.jsx("div",{className:"text-ds-primary text-sm mb-1",children:"Static:"}),o.jsx(Kt,{label:"Size",value:i,onChange:E=>a(E),options:[{value:"current",label:"Current"},{value:"1280x720",label:"1280Ã—720"},{value:"1920x1080",label:"1920Ã—1080"},{value:"3840x2160",label:"3840Ã—2160"},{value:"512x512",label:"512Ã—512"},{value:"1024x1024",label:"1024Ã—1024"},{value:"2048x2048",label:"2048Ã—2048"}]}),o.jsx(Kt,{label:"Format",value:l,onChange:E=>c(E),options:[{value:"jpeg",label:"JPEG"},{value:"png",label:"PNG"},{value:"webp",label:"WebP"}]}),o.jsxs("div",{className:"flex gap-2 mt-2",children:[o.jsx("button",{onClick:u,className:`${eo.actionButton} flex-1`,children:"Save"}),o.jsx("button",{onClick:D,className:`${eo.actionButton} flex-1`,children:"Copy"})]}),o.jsx("div",{className:"text-ds-primary text-sm mt-3 mb-1",children:"Dynamic:"}),o.jsx(Kt,{label:"Format",value:M,onChange:E=>I(E),options:[{value:"gif",label:"GIF"},{value:"webm",label:"WebM"},{value:"mp4",label:"MP4"}]}),o.jsx(Kt,{label:"Quality",value:L,onChange:E=>P(E),options:[{value:"low",label:"Low"},{value:"medium",label:"Medium"},{value:"high",label:"High"},{value:"ultra",label:"Ultra"}]}),o.jsx(pt,{label:"Duration",value:x,min:5,max:120,step:5,onChange:v,formatValue:E=>`${E}s`,inputMax:3600}),o.jsx(Kt,{label:"Scale",value:String(k),onChange:E=>b(Number(E)),options:[{value:"1",label:"1Ã— (Full)"},{value:"2",label:"Â½"},{value:"4",label:"Â¼"},{value:"8",label:"â…›"}]}),o.jsx(Kt,{label:"Speed",value:String(_),onChange:E=>N(Number(E)),options:[{value:"1",label:"1Ã—"},{value:"2",label:"2Ã—"},{value:"3",label:"3Ã—"},{value:"4",label:"4Ã—"}]}),o.jsxs("div",{className:"flex gap-2 mt-2",children:[o.jsx("button",{onClick:B,disabled:p||y!==null||!g||r!==null,className:p||y!==null||r!==null?eo.actionButtonPrimary:eo.actionButton,style:{flex:1,minWidth:0},children:r!==null?`(${r})`:y!==null?`Render ${y}%`:p?"Recording...":"Record"}),o.jsx("button",{onClick:p?C??void 0:S,disabled:r!==null||y!==null||!p&&!w,className:r!==null||y!==null||!p&&!w?eo.actionButtonDisabled:p?eo.actionButtonPrimary:eo.actionButton,style:{flex:1,minWidth:0},children:p?"Stop":"Save"})]}),o.jsxs("div",{onClick:()=>h(!d),className:`group text-sm mt-3 cursor-pointer ${d?"text-blue-400":""}`,children:[o.jsx("div",{className:"mb-1 font-medium",children:d?"âœ“ Watermark Removed!":o.jsx("span",{className:"underline",children:"Remove watermark:"})}),o.jsx("div",{className:d?"":"text-ds-secondary group-hover:text-gray-300 transition-colors",children:"By removing watermark, I agree"}),o.jsx("div",{className:d?"":"text-ds-secondary group-hover:text-gray-300 transition-colors",children:"to provide proper attribution to"}),o.jsx("div",{className:d?"":"text-ds-secondary group-hover:text-gray-300 transition-colors",children:'"ColmapView by OpsiClear"'}),o.jsx("div",{className:d?"":"text-ds-secondary group-hover:text-gray-300 transition-colors",children:"when sharing the image."})]})]})})});let xc=null,sa=null,Af=!1;async function DM(){if(Af)return;const e=await ci(()=>import("./browser-CXh1ITwj.js"),[]);xc=e.deflateSync,sa=e.inflateSync,Af=!0}function Lp(e){return btoa(String.fromCharCode(...e)).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}function _p(e){try{let t=e.replace(/-/g,"+").replace(/_/g,"/");for(;t.length%4!==0;)t+="=";const n=atob(t),r=new Uint8Array(n.length);for(let s=0;s<n.length;s++)r[s]=n.charCodeAt(s);return r}catch{return null}}const Ui=zy();function Hi(e,t){const n={};for(const[r,s]of Object.entries(e))t.has(r)&&typeof s!="function"&&s!==1/0&&(n[r]=s);return n}function FM(){const e={},t=Hi(Vt.getState(),Ui.pointCloud);Object.keys(t).length>0&&(e.pointCloud=t);const n=Hi(G.getState(),Ui.ui);Object.keys(n).length>0&&(e.ui=n);const r=Hi(ce.getState(),Ui.camera),{selectedImageId:s}=ce.getState();s!==null&&(r.selectedImageId=s),Object.keys(r).length>0&&(e.camera=r);const i=Hi(Bn.getState(),Ui.rig);Object.keys(i).length>0&&(e.rig=i);const a=mn.getState();return mi(a.transform)||(e.transform=a.transform),e}function zM(e){e.pointCloud&&Vt.setState(e.pointCloud),e.ui&&G.setState(e.ui),e.camera&&ce.setState(e.camera),e.rig&&Bn.setState(e.rig),e.transform&&mn.getState().setTransform(e.transform)}function Tp(e){const t=new ArrayBuffer(72),n=new DataView(t),[r,s,i]=e.position,[a,l,c]=e.target,[d,h,u,m]=e.quaternion,g=m<0?-d:d,p=m<0?-h:h,y=m<0?-u:u;return n.setFloat64(0,r,!0),n.setFloat64(8,s,!0),n.setFloat64(16,i,!0),n.setFloat64(24,a,!0),n.setFloat64(32,l,!0),n.setFloat64(40,c,!0),n.setFloat64(48,g,!0),n.setFloat64(56,p,!0),n.setFloat64(64,y,!0),new Uint8Array(t)}function OM(e){return`c=${Lp(Tp(e))}`}function $M(e,t,n){const r=typeof e!="string",s=r?JSON.stringify(e):e,i=new TextEncoder().encode(s),a=i.length,l=t!==null,c=n!=null,d=c?new TextEncoder().encode(JSON.stringify(n)):null,h=d?.length??0,u=2+a+(l?72:0)+(c?2+h:0),m=new ArrayBuffer(u),g=new DataView(m),p=new Uint8Array(m);let y=0;if(g.setUint16(y,a,!0),y+=2,p.set(i,y),y+=a,l&&t){const b=Tp(t);p.set(b,y),y+=72}c&&d&&(g.setUint16(y,h,!0),y+=2,p.set(d,y));let w,x=!1;if(xc)try{const b=xc(p,{level:9});b.length<p.length?(w=b,x=!0):w=p}catch{w=p}else w=p;const v=new Uint8Array(1+w.length),k=(l?1:0)|(c?2:0)|(r?4:0)|(x?8:0);return v[0]=k,v.set(w,1),`d=${Lp(v)}`}async function Rp(e){const t=e.startsWith("#")?e.slice(1):e,r=new URLSearchParams(t).get("d");if(!r)return null;const s=_p(r);if(!s||s.length<3)return null;const i=s[0],a=(i&1)!==0,l=(i&2)!==0,c=(i&4)!==0,d=(i&8)!==0;let h=s.slice(1);if(d){if(sa||await DM(),!sa)return null;try{h=new Uint8Array(sa(h))}catch{return null}}if(h.length<2)return null;const u=new DataView(h.buffer,h.byteOffset,h.byteLength);let m=0;const g=u.getUint16(m,!0);if(m+=2,h.length<m+g)return null;const p=h.slice(m,m+g),y=new TextDecoder().decode(p);m+=g;let w=null,x=null;if(c)try{x=JSON.parse(y)}catch{return null}else w=y;let v=null;if(a){if(h.length<m+72)return null;const b=h.slice(m,m+72);v=Dp(b),m+=72}let k=null;if(l){if(h.length<m+2)return null;const b=u.getUint16(m,!0);if(m+=2,h.length<m+b)return null;const S=h.slice(m,m+b);try{k=JSON.parse(new TextDecoder().decode(S))}catch{}}return{manifestUrl:w,manifest:x,viewState:v,config:k}}function Dp(e){if(e.length!==72)return null;const t=new DataView(e.buffer,e.byteOffset,e.byteLength),n=t.getFloat64(0,!0),r=t.getFloat64(8,!0),s=t.getFloat64(16,!0),i=t.getFloat64(24,!0),a=t.getFloat64(32,!0),l=t.getFloat64(40,!0),c=t.getFloat64(48,!0),d=t.getFloat64(56,!0),h=t.getFloat64(64,!0),u=1-c*c-d*d-h*h;if(u<0)return null;const m=Math.sqrt(u);return{position:[n,r,s],target:[i,a,l],quaternion:[c,d,h,m],distance:Math.sqrt((n-i)*(n-i)+(r-a)*(r-a)+(s-l)*(s-l))}}function BM(e){const t=_p(e);return!t||t.length!==72?null:Dp(t)}function UM(e){const t=e.split(",").map(g=>parseFloat(g));if(t.length!==10||t.some(isNaN))return null;const[n,r,s,i,a,l,c,d,h,u]=t,m=Math.sqrt(c*c+d*d+h*h+u*u);return m<.9||m>1.1?null:{position:[n,r,s],target:[i,a,l],quaternion:[c,d,h,u],distance:Math.sqrt((n-i)*(n-i)+(r-a)*(r-a)+(s-l)*(s-l))}}async function HM(e){const t=e.startsWith("#")?e.slice(1):e,n=new URLSearchParams(t);if(n.get("d"))return(await Rp(e))?.viewState??null;const s=n.get("c");if(s)return BM(s);const i=n.get("camera");return i?UM(i):null}function ia(e,t,n){const s=window.location.hostname==="colmapview.github.io"?"https://colmapview.github.io/v0.5.6/":window.location.origin+window.location.pathname,i=new URL(s);if(e){const a=FM();return i.hash=$M(e,t,a),i.toString()}return t&&(i.hash=OM(t)),i.toString()}function Lf(e,t,n){const r=ia(e,t),s=new URL(r);return s.searchParams.set("embed","1"),s.toString()}function WM(e){return`<iframe src="${e}" width="100%" height="600" frameborder="0" allowfullscreen></iframe>`}async function VM(e){try{return await navigator.clipboard.writeText(e),!0}catch{const t=document.createElement("textarea");t.value=e,t.style.position="fixed",t.style.opacity="0",document.body.appendChild(t),t.select();try{return document.execCommand("copy"),!0}catch{return!1}finally{document.body.removeChild(t)}}}const ZM=2e3;async function _l(e,t){await VM(e)&&(t(!0),setTimeout(()=>t(!1),ZM))}const Rr=cn,YM=f.memo(function({activePanel:t,setActivePanel:n}){const[r,s]=f.useState(!1),[i,a]=f.useState(!1),[l,c]=f.useState(!1),[d,h]=f.useState(!0),[u,m]=f.useState(!0),g=me(N=>N.reconstruction),p=me(N=>N.sourceType),y=me(N=>N.sourceUrl),w=me(N=>N.sourceManifest),x=ce(N=>N.currentViewState),v=rt(N=>N.getScreenshotBlob),k=(p==="url"||p==="manifest")&&g,b=y??w,S=f.useCallback(async()=>{if(!b)return;const N=ia(b,x);await _l(N,s)},[b,x]),C=f.useCallback(async()=>{if(!b)return;const N=Lf(b,x);await _l(N,a)},[b,x]),M=f.useCallback(async()=>{if(!b)return;const N=Lf(b,x),D=WM(N);await _l(D,c)},[b,x]),I=f.useCallback(N=>{const D=[];if(g){const F=g.globalStats?.totalPoints??0,$=g.images.size,T=g.cameras.size,z=H=>H>=1e6?`${(H/1e6).toFixed(1)}M`:H>=1e3?`${(H/1e3).toFixed(1)}K`:H.toString();F>0&&D.push(`ðŸ“ ${z(F)} points`),$>0&&D.push(`ðŸ–¼ï¸ ${$} images`),T>1&&D.push(`ðŸ“· ${T} cameras`)}const B="#3DReconstruction #Photogrammetry #COLMAP",E=N?"Made with ColmapView by @opsiclear":"Made with https://colmapview.github.io/ by @opsiclear",Z="[type something here ...]";return D.length>0?`${Z}

${D.join(" | ")}

${B}
${E}`:`${Z}

${B}
${E}`},[g]),L=f.useCallback(async()=>{if(!v)return!1;try{const N=await v();if(N)return await navigator.clipboard.write([new ClipboardItem({"image/png":N})]),Ft.getState().addNotification("info","Screenshot copied! Press Ctrl+V to paste",4e3),!0}catch(N){console.error("Failed to copy screenshot to clipboard:",N)}return!1},[v]),P=f.useCallback(async()=>{const N=b?ia(b,x):null,D=d&&!!N,B=I(D);u&&await L();const E=D?`https://twitter.com/intent/tweet?text=${encodeURIComponent(B)}&url=${encodeURIComponent(N)}`:`https://twitter.com/intent/tweet?text=${encodeURIComponent(B)}`;window.open(E,"_blank","width=700,height=600")},[b,x,I,L,d,u]),_=f.useCallback(async()=>{const N=b?ia(b,x):null,D=d&&!!N,B=I(D),E=D?`${B}
${N}`:B;try{const Z={"text/plain":new Blob([E],{type:"text/plain"})};if(u&&v){const $=await v();$&&(Z["image/png"]=$)}await navigator.clipboard.write([new ClipboardItem(Z)]);const F=Z["image/png"]?"Text + screenshot copied! Paste in LinkedIn post":"Message copied! Paste in LinkedIn post";Ft.getState().addNotification("info",F,4e3)}catch{try{await navigator.clipboard.writeText(E)}catch{}}window.open("https://www.linkedin.com/feed/","_blank","width=700,height=600")},[b,x,I,v,d,u]);return o.jsx(Tn,{panelId:"share",activePanel:t,setActivePanel:n,icon:o.jsx(vk,{className:"w-6 h-6"}),tooltip:"Share",panelTitle:"Share",children:o.jsxs("div",{className:Rr.panelContent,children:[k&&o.jsxs(o.Fragment,{children:[o.jsx("div",{className:"text-ds-primary text-sm mb-1",children:"Links:"}),o.jsxs("div",{className:"flex flex-col gap-2",children:[o.jsx("button",{onClick:S,className:r?Rr.actionButtonPrimary:Rr.actionButton,children:r?o.jsxs(o.Fragment,{children:[o.jsx(No,{className:"w-4 h-4 inline mr-1"}),"Copied!"]}):"Copy Link"}),o.jsx("button",{onClick:C,className:i?Rr.actionButtonPrimary:Rr.actionButton,children:i?o.jsxs(o.Fragment,{children:[o.jsx(No,{className:"w-4 h-4 inline mr-1"}),"Copied!"]}):"Embed URL"}),o.jsx("button",{onClick:M,className:l?Rr.actionButtonPrimary:Rr.actionButton,children:l?o.jsxs(o.Fragment,{children:[o.jsx(No,{className:"w-4 h-4 inline mr-1"}),"Copied!"]}):"Embed HTML"})]})]}),o.jsx("div",{className:`text-ds-primary text-sm mb-1 ${k?"mt-3":""}`,children:"Social Media:"}),k&&o.jsx(br,{label:"Include Link",checked:d,onChange:h}),o.jsx(br,{label:"Screen to Clipboard",checked:u,onChange:m}),o.jsxs("div",{className:"flex gap-2 mt-2",children:[o.jsx("button",{onClick:P,className:Rr.actionButton,style:{flex:1,padding:"8px"},"data-tooltip":"Share to X","data-tooltip-pos":"bottom",children:o.jsx("svg",{viewBox:"0 0 24 24",className:"w-5 h-5 mx-auto",fill:"currentColor",children:o.jsx("path",{d:"M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"})})}),o.jsx("button",{onClick:_,className:Rr.actionButton,style:{flex:1,padding:"8px"},"data-tooltip":"Share to LinkedIn","data-tooltip-pos":"bottom",children:o.jsx("svg",{viewBox:"0 0 24 24",className:"w-5 h-5 mx-auto",fill:"currentColor",children:o.jsx("path",{d:"M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"})})})]})]})})}),Dr=cn,GM=f.memo(function({activePanel:t,setActivePanel:n,onOpenDeletionModal:r,onOpenConversionModal:s}){const i=me(O=>O.reconstruction),a=me(O=>O.wasmReconstruction),l=me(O=>O.loadedFiles),c=me(O=>O.droppedFiles),d=Ft(O=>O.addNotification),h=mn(O=>O.resetTransform),u=Qn(O=>O.pendingDeletions),m=gp(),{processFiles:g}=Ms(),p=u.size>0,[y,w]=f.useState(85),[x,v]=f.useState(null),[k,b]=f.useState(null),[S,C]=f.useState("binary"),M=f.useMemo(()=>i?Array.from(i.cameras.entries()):[],[i]),I=f.useMemo(()=>{if(M.length===0)return null;const O=new Map;for(const[,J]of M)O.set(J.modelId,(O.get(J.modelId)??0)+1);if(O.size===1){const J=Array.from(O.entries()),[re,q]=J[0],ie=_c[re]??"Unknown";return q>1?`${q}x ${ie}`:ie}return`${M.length} cameras (mixed)`},[M]),L=f.useMemo(()=>[{value:"binary",label:"Binary (.bin)"},{value:"text",label:"Text (.txt)"},{value:"ply",label:"Points (.ply)"},{value:"zip",label:"ZIP (.zip)"}],[]),P={binary:"COLMAP binary format. Compact and fast to load.",text:"COLMAP text format. Human-readable, useful for debugging.",ply:"Point cloud only. Compatible with MeshLab, CloudCompare.",zip:"Binary files (.bin) in a single archive."},_=f.useCallback(async()=>{if(i)try{switch(S){case"binary":Gu(i,a);break;case"text":Tx(i,a);break;case"ply":Rx(i,a);break;case"zip":await Fx(i,{format:"binary"},l?.imageFiles,a);break}}catch(O){console.error("Export failed:",O),d("warning","Export failed")}},[i,a,l,S,d]),N=f.useMemo(()=>i?Array.from(i.images.values()).map(O=>O.name):[],[i]),D=f.useCallback(async()=>{if(N.length!==0){v(0);try{await Ux(N,async J=>m.getImage(J),{jpegQuality:y/100},J=>v(J)),d("info","Images exported successfully")}catch(O){console.error("Image export failed:",O),d("warning","Image export failed")}finally{v(null)}}},[N,m,y,d]),B=f.useCallback(async()=>{if(N.length!==0){b(0);try{await Vx(N,async J=>m.getMask(J),J=>b(J)),d("info","Masks exported successfully")}catch(O){console.error("Mask export failed:",O),d("warning","Mask export failed")}finally{b(null)}}},[N,m,d]),E=()=>{i&&Gu(i,a)},Z=f.useCallback(()=>{c&&(h(),g(c))},[c,h,g]),F=M.length>0,$=x!==null,T=k!==null,z=N.length>0&&m.hasImages(),H=m.hasMasks();return o.jsx(o.Fragment,{children:o.jsx(Tn,{panelId:"export",activePanel:t,setActivePanel:n,icon:o.jsx(jk,{className:"w-6 h-6"}),tooltip:"Export",onClick:E,panelTitle:"Export",disabled:!i,children:o.jsxs("div",{className:Dr.panelContent,children:[o.jsx("div",{className:"text-ds-primary text-sm mb-1",children:"Reconstruction:"}),o.jsx(Kt,{label:"Format",value:S,onChange:O=>C(O),options:L}),o.jsx("div",{className:"text-ds-tertiary text-xs mb-2",children:P[S]}),o.jsxs("div",{className:"flex flex-col gap-2",children:[F&&o.jsx("button",{onClick:s,className:Dr.actionButton,title:I??void 0,children:"Convert Camera Model"}),o.jsxs("button",{onClick:r,className:Dr.actionButton,children:["Delete Images",p?` (${u.size})`:""]}),o.jsx("button",{onClick:_,disabled:!i,className:i?Dr.actionButton:Dr.actionButtonDisabled,children:"Download"})]}),o.jsx("div",{className:"text-ds-primary text-sm mb-1 mt-3",children:"Images:"}),z?o.jsxs(o.Fragment,{children:[o.jsx(pt,{label:"JPEG Quality",value:y,min:10,max:100,step:5,onChange:w,formatValue:O=>`${O}%`}),o.jsxs("div",{className:"flex flex-col gap-2",children:[$?o.jsxs("div",{children:[o.jsx("div",{className:"h-2 bg-ds-tertiary rounded overflow-hidden",children:o.jsx("div",{className:"h-full bg-ds-accent transition-all",style:{width:`${x}%`}})}),o.jsxs("div",{className:"text-ds-secondary text-xs mt-1 text-center",children:["Exporting images... ",x,"%"]})]}):o.jsx("button",{onClick:D,className:Dr.actionButton,children:"Download Images"}),H&&(T?o.jsxs("div",{children:[o.jsx("div",{className:"h-2 bg-ds-tertiary rounded overflow-hidden",children:o.jsx("div",{className:"h-full bg-ds-accent transition-all",style:{width:`${k}%`}})}),o.jsxs("div",{className:"text-ds-secondary text-xs mt-1 text-center",children:["Exporting masks... ",k,"%"]})]}):o.jsx("button",{onClick:B,className:Dr.actionButton,children:"Download Masks"}))]})]}):o.jsx("div",{className:"text-ds-tertiary text-xs",children:"No images available"}),o.jsx("div",{className:"flex flex-col gap-2 mt-3",children:o.jsx("button",{onClick:Z,disabled:!c,className:c?Dr.actionButton:Dr.actionButtonDisabled,children:"Reload"})})]})})})}),Rs=cn;function qM(){const{profileNames:e,activeProfile:t,isActiveProfileReadOnly:n,saveProfile:r,loadProfile:s,deleteProfile:i,suggestName:a}=fp(),l=Ft(I=>I.addNotification),[c,d]=f.useState(!1),[h,u]=f.useState(!1),[m,g]=f.useState(""),p=f.useRef(null),y=f.useRef(null),w=f.useCallback(()=>{d(!1),u(!1)},[]);Ya(p,w,c),f.useEffect(()=>{h&&y.current&&(y.current.focus(),y.current.select())},[h]);const x=f.useCallback(()=>{n?(g(a()),u(!0),d(!0)):t&&(r(t),l("info",`Profile "${t}" saved`))},[t,n,r,a,l]),v=f.useCallback(I=>{s(I),d(!1)},[s]),k=f.useCallback((I,L)=>{L.stopPropagation(),!(e.length<=1)&&confirm(`Delete profile "${I}"?`)&&i(I)},[e.length,i]),b=f.useCallback(()=>{g(a()),u(!0)},[a]),S=f.useCallback(()=>{const I=m.trim();I&&(r(I),l("info",`Profile "${I}" saved`),u(!1),g(""),d(!1))},[m,r,l]),C=f.useCallback(()=>{u(!1),g("")},[]),M=f.useCallback(I=>{I.key==="Enter"?S():I.key==="Escape"&&C()},[S,C]);return o.jsxs(o.Fragment,{children:[o.jsxs("div",{className:Rs.row,children:[o.jsx("label",{className:Rs.label,children:"Profile"}),o.jsxs("div",{className:"relative flex-1",ref:p,children:[o.jsxs("button",{type:"button",onClick:()=>d(!c),className:`${Rs.selectRight} text-left flex items-center justify-between`,children:[o.jsx("span",{className:"truncate",children:t||"Select..."}),o.jsx("span",{className:"ml-1 text-ds-muted",children:"â–¾"})]}),c&&o.jsxs("div",{className:`absolute top-full left-0 right-0 mt-1 bg-ds-tertiary border border-ds rounded shadow-lg z-[${Rn.dropdown}] py-1`,children:[e.map(I=>{const L=I==="Default";return o.jsxs("div",{onClick:()=>v(I),className:`flex items-center justify-between px-2 py-1 cursor-pointer hover-ds-hover text-sm ${I===t?"bg-ds-hover text-ds-accent":"text-ds-primary"}`,children:[o.jsx("span",{className:"truncate",children:I}),!L&&o.jsx("button",{type:"button",onClick:P=>k(I,P),className:"p-0.5 text-ds-muted hover-ds-text-primary ml-2 flex-shrink-0",children:o.jsx(Ck,{className:"w-3.5 h-3.5"})})]},I)}),h?o.jsx("div",{className:"px-2 py-1 border-t border-ds mt-1",children:o.jsx("input",{ref:y,type:"text",value:m,onChange:I=>g(I.target.value),onKeyDown:M,onBlur:C,placeholder:"Profile name",className:"w-full bg-ds-input text-ds-primary text-sm px-1.5 py-0.5 rounded border border-ds focus-ds"})}):o.jsx("div",{onClick:b,className:"px-2 py-1 cursor-pointer hover-ds-hover text-sm text-ds-muted border-t border-ds mt-1",children:"+ New Profile"})]})]})]}),o.jsx("div",{className:Rs.actionGroup,children:o.jsx("button",{onClick:x,className:Rs.actionButton,children:"Save Profile"})})]})}let _f=1e3;function vi(e){const[t,n]=f.useState(1e3);f.useEffect(()=>{e&&n(++_f)},[e]);const r=f.useCallback(()=>{n(++_f)},[]);return{zIndex:t,bringToFront:r}}function XM(e,t,n,r){const s=typeof window<"u"?window.innerWidth:ga.width,i=typeof window<"u"?window.innerHeight:ga.height,a=rn.viewportPadding;return{x:Math.max(a,Math.min(e,s-n-a)),y:Math.max(a,Math.min(t,i-r-a))}}function wi({estimatedWidth:e,estimatedHeight:t,isOpen:n,initialPosition:r}){const[s,i]=f.useState({x:0,y:0}),a=f.useRef(null),l=f.useRef(s);f.useEffect(()=>{l.current=s},[s]);const c=f.useCallback(()=>{if(a.current){const h=a.current.getBoundingClientRect(),u=window.innerWidth,m=window.innerHeight;i({x:(u-h.width)/2,y:Math.max(rn.minTop,(m-h.height)/2)})}},[]);f.useEffect(()=>{if(n)if(r){const h=rn.cursorOffset,u=XM(r.x+h,r.y-h,e,t);i(u)}else{const h=window.innerWidth,u=window.innerHeight;i({x:(h-e)/2,y:Math.max(rn.minTop,(u-t)/2)}),requestAnimationFrame(c)}},[n,c,e,t,r]);const d=f.useCallback(h=>{h.preventDefault();const u=h.currentTarget;u.setPointerCapture(h.pointerId);const m=h.clientX,g=h.clientY,p=l.current.x,y=l.current.y,w=v=>{i({x:p+v.clientX-m,y:y+v.clientY-g})},x=()=>{u.removeEventListener("pointermove",w),u.removeEventListener("pointerup",x)};u.addEventListener("pointermove",w),u.addEventListener("pointerup",x)},[]);return{position:s,panelRef:a,handleDragStart:d,centerModal:c}}const KM={distanceThreshold:.05,maxIterations:1e3,sampleCount:5e4},QM=.8;function JM(e,t,n,r,s,i){return[t*i-n*s,n*r-e*i,e*s-t*r]}function ej(e,t,n,r,s,i){return e*r+t*s+n*i}function tj(e,t,n){const r=Math.sqrt(e*e+t*t+n*n);return r<1e-10?[0,0,1]:[e/r,t/r,n/r]}function nj(e,t,n,r,s,i,a,l,c){const d=r-e,h=s-t,u=i-n,m=a-e,g=l-t,p=c-n,[y,w,x]=JM(d,h,u,m,g,p);if(y*y+w*w+x*x<1e-10)return null;const k=tj(y,w,x),b=-ej(k[0],k[1],k[2],e,t,n);return{normal:k,d:b}}function aa(e,t,n,r,s,i,a){return r*e+s*t+i*n+a}function rj(e){const t=Math.floor(Math.random()*e);let n=Math.floor(Math.random()*(e-1));n>=t&&n++;let r=Math.floor(Math.random()*(e-2));return r>=Math.min(t,n)&&r++,r>=Math.max(t,n)&&r++,[t,n,r]}function oj(e,t){if(e<=t){const s=new Uint32Array(e);for(let i=0;i<e;i++)s[i]=i;return s}const n=new Uint32Array(t),r=e/t;for(let s=0;s<t;s++){const i=Math.floor(s*r),a=Math.floor(Math.random()*r);n[s]=Math.min(i+a,e-1)}return n}function sj(e,t={}){const{distanceThreshold:n,maxIterations:r,sampleCount:s}={...KM,...t},i=e.length/3;if(i<3)return null;const a=oj(i,s),l=a.length;let c=null,d=0;for(let x=0;x<r;x++){const[v,k,b]=rj(l),S=a[v],C=a[k],M=a[b],I=nj(e[S*3],e[S*3+1],e[S*3+2],e[C*3],e[C*3+1],e[C*3+2],e[M*3],e[M*3+1],e[M*3+2]);if(!I)continue;let L=0;for(let P=0;P<l;P++){const _=a[P];Math.abs(aa(e[_*3],e[_*3+1],e[_*3+2],I.normal[0],I.normal[1],I.normal[2],I.d))<=n&&L++}if(L>d&&(d=L,c=I,L/l>=QM))break}if(!c||d<3)return null;const{normal:h,d:u}=c;let m=0,g=0,p=0,y=0;for(let x=0;x<i;x++){const v=e[x*3],k=e[x*3+1],b=e[x*3+2];Math.abs(aa(v,k,b,h[0],h[1],h[2],u))<=n&&(m++,g+=v,p+=k,y+=b)}if(m===0)return null;g/=m,p/=m,y/=m;let w=0;for(let x=0;x<i;x++){const v=e[x*3],k=e[x*3+1],b=e[x*3+2];if(Math.abs(aa(v,k,b,h[0],h[1],h[2],u))<=n){const C=v-g,M=k-p,I=b-y,L=C*C+M*M+I*I;L>w&&(w=L)}}return{normal:h,d:u,centroid:[g,p,y],inlierCount:m,radius:Math.sqrt(w)}}function ij(e,t){const n=e.length/3,r=new Float32Array(n),{normal:s,d:i}=t;for(let a=0;a<n;a++)r[a]=aa(e[a*3],e[a*3+1],e[a*3+2],s[0],s[1],s[2],i);return r}function Fp(e){return{...e,normal:[-e.normal[0],-e.normal[1],-e.normal[2]],d:-e.d}}function aj(e,t){const n=e.length/3,r=new Float32Array(e.length),s=new X;for(let i=0;i<n;i++){const a=i*3;s.set(e[a],e[a+1],e[a+2]),s.applyQuaternion(t.rotation),s.multiplyScalar(t.scale),s.add(t.translation),r[a]=s.x,r[a+1]=s.y,r[a+2]=s.z}return r}const Ja={colmap:{x:[1,0,0],y:[0,1,0],z:[0,0,1]},opencv:{x:[1,0,0],y:[0,1,0],z:[0,0,1]},threejs:{x:[1,0,0],y:[0,1,0],z:[0,0,1]},opengl:{x:[1,0,0],y:[0,1,0],z:[0,0,1]},vulkan:{x:[1,0,0],y:[0,1,0],z:[0,0,1]},blender:{x:[1,0,0],y:[0,0,-1],z:[0,1,0]},houdini:{x:[1,0,0],y:[0,1,0],z:[0,0,1]},unity:{x:[1,0,0],y:[0,1,0],z:[0,0,-1]},unreal:{x:[0,0,-1],y:[1,0,0],z:[0,1,0]}};function Tf(e){const t=Ja[e];return e==="blender"||e==="unreal"?t.z:t.y}const zp={colmap:{X:"Right",Y:"Down",Z:"Fwd"},opencv:{X:"Right",Y:"Down",Z:"Fwd"},threejs:{X:"Right",Y:"Up",Z:"Back"},opengl:{X:"Right",Y:"Up",Z:"Back"},vulkan:{X:"Right",Y:"Up",Z:"Fwd"},blender:{X:"Right",Y:"Fwd",Z:"Up"},houdini:{X:"Right",Y:"Up",Z:"Fwd"},unity:{X:"Right",Y:"Up",Z:"Fwd"},unreal:{X:"Fwd",Y:"Right",Z:"Up"}},zn=cn;function lj(e,t,n){const r=new X(e[0],e[1],e[2]).normalize(),s=new X(t[0],t[1],t[2]),i=new Tt;i.setFromUnitVectors(r,n);const l=s.clone().applyQuaternion(i).dot(n),c=n.clone().multiplyScalar(-l);return{rotation:i,translation:c,scale:1}}const cj=f.memo(function({isOpen:t,onClose:n}){const r=me(z=>z.reconstruction),s=me(z=>z.wasmReconstruction),i=mn(z=>z.transform),a=mn(z=>z.setTransform),l=G(z=>z.axesCoordinateSystem),c=Ct(z=>z.detectedPlane),d=Ct(z=>z.setDetectedPlane),h=Ct(z=>z.distanceThreshold),u=Ct(z=>z.setDistanceThreshold),m=Ct(z=>z.sampleCount),g=Ct(z=>z.setSampleCount),p=Ct(z=>z.floorColorMode),y=Ct(z=>z.setFloorColorMode),w=Ct(z=>z.setPointDistances),x=Ct(z=>z.isDetecting),v=Ct(z=>z.setIsDetecting),k=Ct(z=>z.normalFlipped),b=Ct(z=>z.toggleNormalFlipped),S=Ct(z=>z.targetAxis),C=Ct(z=>z.cycleTargetAxis),M=Ct(z=>z.reset),I=s?.pointCount??r?.points3D?.size??0,L=f.useMemo(()=>{const z=Ja[l],H=S.toLowerCase(),O=z[H];return new X(O[0],O[1],O[2])},[l,S]),{position:P,panelRef:_,handleDragStart:N}=wi({estimatedWidth:280,estimatedHeight:300,isOpen:t}),{zIndex:D,bringToFront:B}=vi(t),E=f.useCallback(()=>{M(),n()},[M,n]);kt("escape",E,{enabled:t},[t,E]);const Z=f.useCallback(()=>{s?.hasPoints()&&(v(!0),setTimeout(()=>{let z=s.getPositions();if(!z){v(!1);return}if(!mi(i)){const O=Hr(i);z=aj(z,O)}const H=sj(z,{distanceThreshold:h,sampleCount:m});if(d(H),H){const O=ij(z,H);w(O),p==="off"&&y("binary")}else w(null);v(!1)},10))},[s,h,m,i,d,w,v,p,y]),F=f.useCallback(()=>{M()},[M]),$=f.useCallback(()=>{if(!c)return;const z=k?Fp(c):c,H=lj(z.normal,z.centroid,L),O=Hr(i),J=is(H,O),re=ss(J);a(re),M(),n()},[c,k,L,i,a,M,n]),T=c&&I>0?(c.inlierCount/I*100).toFixed(1):null;return t?o.jsx("div",{className:"fixed inset-0 pointer-events-none",style:{zIndex:D},children:o.jsxs("div",{ref:_,className:ft.toolPanel,style:{left:P.x,top:P.y,width:280},onPointerDown:B,children:[o.jsxs("div",{className:ft.toolHeader,onPointerDown:N,style:{touchAction:"none"},children:[o.jsx("span",{className:ft.toolHeaderTitle,children:"Floor Detection"}),o.jsx("button",{onClick:E,onPointerDown:z=>z.stopPropagation(),className:ft.toolHeaderClose,title:"Close",children:o.jsx(Oo,{className:"w-3.5 h-3.5"})})]}),o.jsxs("div",{className:`px-4 py-3 ${zn.panelContent}`,children:[o.jsx(pt,{label:"Threshold",value:h,min:.001,max:.5,step:.001,onChange:u,formatValue:z=>z.toFixed(3)}),o.jsx(pt,{label:"Samples",value:m,min:1e3,max:1e5,step:1e3,onChange:g,formatValue:z=>`${(z/1e3).toFixed(0)}k`}),o.jsx(Kt,{label:"Color",value:p,onChange:z=>y(z),options:[{value:"off",label:"Off"},{value:"binary",label:"Binary (In/Out)"},{value:"distance",label:"Distance"}]}),o.jsxs("div",{className:zn.actionGroup,children:[o.jsx("button",{onClick:b,disabled:!c,className:c?zn.actionButton:zn.actionButtonDisabled,title:"Flip the detected plane normal direction",children:"Flip"}),o.jsxs("button",{onClick:C,disabled:!c,className:c?zn.actionButton:zn.actionButtonDisabled,title:"Change target alignment axis",children:["Axis: ",S]})]}),c?o.jsxs("div",{className:"text-ds-secondary text-sm",children:[o.jsx("div",{className:"mb-1 font-medium",children:"Detection Result:"}),o.jsxs("div",{children:[T,"% inliers (",c.inlierCount.toLocaleString()," pts)"]})]}):o.jsxs("div",{className:"text-ds-secondary text-sm",children:[o.jsx("div",{className:"mb-1 font-medium",children:"RANSAC Floor Detection:"}),o.jsx("div",{children:"Detect dominant plane in the"}),o.jsx("div",{children:"point cloud for alignment."})]}),o.jsx("div",{className:zn.actionGroup,children:o.jsx("button",{onClick:Z,disabled:x||!s?.hasPoints(),className:x||!s?.hasPoints()?zn.actionButtonDisabled:zn.actionButtonPrimary,style:{flex:1},children:x?"Detecting...":c?"Re-detect":"Detect"})}),o.jsxs("div",{className:zn.actionGroup,children:[o.jsx("button",{onClick:$,disabled:!c,className:c?zn.actionButtonPrimary:zn.actionButtonPrimaryDisabled,children:"Apply"}),o.jsx("button",{onClick:F,disabled:!c,className:c?zn.actionButton:zn.actionButtonDisabled,children:"Clear"})]})]})]})}):null}),Op=1e-6,tn=.01,Rf={[A.SIMPLE_PINHOLE]:["f","cx","cy"],[A.PINHOLE]:["fx","fy","cx","cy"],[A.SIMPLE_RADIAL]:["f","cx","cy","k"],[A.RADIAL]:["f","cx","cy","k1","k2"],[A.OPENCV]:["fx","fy","cx","cy","k1","k2","p1","p2"],[A.OPENCV_FISHEYE]:["fx","fy","cx","cy","k1","k2","k3","k4"],[A.FULL_OPENCV]:["fx","fy","cx","cy","k1","k2","p1","p2","k3","k4","k5","k6"],[A.FOV]:["fx","fy","cx","cy","Ï‰"],[A.SIMPLE_RADIAL_FISHEYE]:["f","cx","cy","k"],[A.RADIAL_FISHEYE]:["f","cx","cy","k1","k2"],[A.THIN_PRISM_FISHEYE]:["fx","fy","cx","cy","k1","k2","p1","p2","k3","k4","sx1","sy1"],[A.RAD_TAN_THIN_PRISM_FISHEYE]:["fx","fy","cx","cy","k1","k2","k3","k4","k5","k6","p1","p2","sx1","sy1","sx2","sy2"]};function ts(e){return e===A.SIMPLE_PINHOLE||e===A.PINHOLE||e===A.SIMPLE_RADIAL||e===A.RADIAL||e===A.OPENCV||e===A.FULL_OPENCV||e===A.FOV}function ns(e){return e===A.SIMPLE_RADIAL_FISHEYE||e===A.RADIAL_FISHEYE||e===A.OPENCV_FISHEYE||e===A.THIN_PRISM_FISHEYE}function $p(e,t){return e===t?"exact":ts(e)&&ns(t)||ns(e)&&ts(t)||e===A.FULL_OPENCV?"incompatible":t===A.FULL_OPENCV?e===A.SIMPLE_PINHOLE||e===A.PINHOLE||e===A.SIMPLE_RADIAL||e===A.RADIAL||e===A.OPENCV?"approximate":"incompatible":ts(e)&&ts(t)?uj(e,t):ns(e)&&ns(t)?dj(e,t):"incompatible"}function uj(e,t){if(e===A.FOV||t===A.FOV)return t===A.SIMPLE_RADIAL||t===A.RADIAL||e===A.SIMPLE_RADIAL||e===A.RADIAL?"approximate":"incompatible";const n=[[A.SIMPLE_PINHOLE,A.PINHOLE],[A.SIMPLE_PINHOLE,A.SIMPLE_RADIAL],[A.SIMPLE_PINHOLE,A.RADIAL],[A.SIMPLE_PINHOLE,A.OPENCV],[A.PINHOLE,A.SIMPLE_RADIAL],[A.PINHOLE,A.RADIAL],[A.PINHOLE,A.OPENCV],[A.SIMPLE_RADIAL,A.RADIAL],[A.SIMPLE_RADIAL,A.OPENCV],[A.RADIAL,A.OPENCV]];for(const[s,i]of n)if(e===s&&t===i)return"exact";const r=[[A.PINHOLE,A.SIMPLE_PINHOLE],[A.RADIAL,A.SIMPLE_RADIAL],[A.OPENCV,A.RADIAL],[A.OPENCV,A.SIMPLE_RADIAL]];for(const[s,i]of r)if(e===s&&t===i)return"approximate";return"incompatible"}function dj(e,t){const n=[[A.SIMPLE_RADIAL_FISHEYE,A.RADIAL_FISHEYE],[A.SIMPLE_RADIAL_FISHEYE,A.OPENCV_FISHEYE],[A.SIMPLE_RADIAL_FISHEYE,A.THIN_PRISM_FISHEYE],[A.RADIAL_FISHEYE,A.OPENCV_FISHEYE],[A.RADIAL_FISHEYE,A.THIN_PRISM_FISHEYE],[A.OPENCV_FISHEYE,A.THIN_PRISM_FISHEYE]];for(const[s,i]of n)if(e===s&&t===i)return"exact";const r=[[A.RADIAL_FISHEYE,A.SIMPLE_RADIAL_FISHEYE],[A.OPENCV_FISHEYE,A.RADIAL_FISHEYE],[A.OPENCV_FISHEYE,A.SIMPLE_RADIAL_FISHEYE],[A.THIN_PRISM_FISHEYE,A.OPENCV_FISHEYE],[A.THIN_PRISM_FISHEYE,A.RADIAL_FISHEYE],[A.THIN_PRISM_FISHEYE,A.SIMPLE_RADIAL_FISHEYE]];for(const[s,i]of r)if(e===s&&t===i)return"approximate";return"incompatible"}function Bp(e,t,n=Op){const{modelId:r,params:s}=e;return r===t?{type:"exact",params:[...s]}:$p(r,t)==="incompatible"?{type:"incompatible",reason:fj(r,t)}:hj(r,t,s,n)}function fj(e,t){const n=Yn(e),r=Yn(t);return ts(e)&&ns(t)?`Cannot convert ${n} (perspective) to ${r} (fisheye): different projection models`:ns(e)&&ts(t)?`Cannot convert ${n} (fisheye) to ${r} (perspective): different projection models`:e===A.FULL_OPENCV?"Cannot convert from FULL_OPENCV: rational polynomial formula has no equivalent in other models":t===A.FULL_OPENCV?`Cannot convert ${n} to FULL_OPENCV: only perspective pinhole/radial models can be approximately converted`:`No valid conversion path from ${n} to ${r}`}function Yn(e){return{[A.SIMPLE_PINHOLE]:"SIMPLE_PINHOLE",[A.PINHOLE]:"PINHOLE",[A.SIMPLE_RADIAL]:"SIMPLE_RADIAL",[A.RADIAL]:"RADIAL",[A.OPENCV]:"OPENCV",[A.OPENCV_FISHEYE]:"OPENCV_FISHEYE",[A.FULL_OPENCV]:"FULL_OPENCV",[A.FOV]:"FOV",[A.SIMPLE_RADIAL_FISHEYE]:"SIMPLE_RADIAL_FISHEYE",[A.RADIAL_FISHEYE]:"RADIAL_FISHEYE",[A.THIN_PRISM_FISHEYE]:"THIN_PRISM_FISHEYE",[A.RAD_TAN_THIN_PRISM_FISHEYE]:"RAD_TAN_THIN_PRISM_FISHEYE"}[e]??`Unknown(${e})`}function hj(e,t,n,r){return e===A.SIMPLE_PINHOLE?mj(t,n):e===A.PINHOLE?pj(t,n):e===A.SIMPLE_RADIAL?gj(t,n):e===A.RADIAL?xj(t,n,r):e===A.OPENCV?yj(t,n,r):e===A.FOV?vj(t,n):e===A.SIMPLE_RADIAL_FISHEYE?wj(t,n):e===A.RADIAL_FISHEYE?bj(t,n,r):e===A.OPENCV_FISHEYE?Cj(t,n,r):e===A.THIN_PRISM_FISHEYE?Sj(t,n,r):{type:"incompatible",reason:`Conversion from ${Yn(e)} to ${Yn(t)} not implemented`}}function mj(e,t){const[n,r,s]=t;switch(e){case A.PINHOLE:return{type:"exact",params:[n,n,r,s]};case A.SIMPLE_RADIAL:return{type:"exact",params:[n,r,s,0]};case A.RADIAL:return{type:"exact",params:[n,r,s,0,0]};case A.OPENCV:return{type:"exact",params:[n,n,r,s,0,0,0,0]};case A.FULL_OPENCV:return{type:"approximate",params:[n,n,r,s,0,0,0,0,0,0,0,0],maxError:0,warning:"FULL_OPENCV uses rational polynomial formula; behavior differs from simpler models"};default:return{type:"incompatible",reason:`Cannot convert SIMPLE_PINHOLE to ${Yn(e)}`}}}function pj(e,t,n){const[r,s,i,a]=t;switch(e){case A.SIMPLE_PINHOLE:{const l=Math.abs(r-s)/r;if(l>tn){const c=(r+s)/2;return{type:"approximate",params:[c,i,a],maxError:Math.abs(r-c)/c*Math.max(i,a),warning:`Using mean f=${c.toFixed(2)} (fx=${r.toFixed(2)}, fy=${s.toFixed(2)}, diff ${(l*100).toFixed(2)}%)`}}return{type:"exact",params:[r,i,a]}}case A.SIMPLE_RADIAL:{const l=Math.abs(r-s)/r;if(l>tn){const c=(r+s)/2;return{type:"approximate",params:[c,i,a,0],maxError:Math.abs(r-c)/c*Math.max(i,a),warning:`Using mean f=${c.toFixed(2)} (fx=${r.toFixed(2)}, fy=${s.toFixed(2)}, diff ${(l*100).toFixed(2)}%)`}}return{type:"exact",params:[r,i,a,0]}}case A.RADIAL:{const l=Math.abs(r-s)/r;if(l>tn){const c=(r+s)/2;return{type:"approximate",params:[c,i,a,0,0],maxError:Math.abs(r-c)/c*Math.max(i,a),warning:`Using mean f=${c.toFixed(2)} (fx=${r.toFixed(2)}, fy=${s.toFixed(2)}, diff ${(l*100).toFixed(2)}%)`}}return{type:"exact",params:[r,i,a,0,0]}}case A.OPENCV:return{type:"exact",params:[r,s,i,a,0,0,0,0]};case A.FULL_OPENCV:return{type:"approximate",params:[r,s,i,a,0,0,0,0,0,0,0,0],maxError:0,warning:"FULL_OPENCV uses rational polynomial formula; behavior differs from simpler models"};default:return{type:"incompatible",reason:`Cannot convert PINHOLE to ${Yn(e)}`}}}function gj(e,t){const[n,r,s,i]=t;switch(e){case A.RADIAL:return{type:"exact",params:[n,r,s,i,0]};case A.OPENCV:return{type:"exact",params:[n,n,r,s,i,0,0,0]};case A.FULL_OPENCV:return{type:"approximate",params:[n,n,r,s,i,0,0,0,0,0,0,0],maxError:0,warning:"FULL_OPENCV uses rational polynomial formula; behavior differs from OPENCV"};case A.FOV:{if(i<=0)return{type:"incompatible",reason:"FOV model requires positive distortion (k > 0)"};const a=Math.sqrt(3*i);return{type:"approximate",params:[n,n,r,s,a],maxError:a>.1?.1:.01,warning:`Taylor approximation; omega=${a.toFixed(4)} radians`}}default:return{type:"incompatible",reason:`Cannot convert SIMPLE_RADIAL to ${Yn(e)}`}}}function xj(e,t,n){const[r,s,i,a,l]=t;switch(e){case A.SIMPLE_RADIAL:return Math.abs(l)>n?{type:"approximate",params:[r,s,i,a],maxError:Math.abs(l),warning:`Dropping k2=${l.toExponential(3)} exceeds threshold`}:{type:"exact",params:[r,s,i,a]};case A.OPENCV:return{type:"exact",params:[r,r,s,i,a,l,0,0]};case A.FULL_OPENCV:return{type:"approximate",params:[r,r,s,i,a,l,0,0,0,0,0,0],maxError:0,warning:"FULL_OPENCV uses rational polynomial formula; behavior differs from OPENCV"};case A.FOV:{if(Math.abs(l)>n)return{type:"incompatible",reason:"FOV model cannot represent k2 distortion"};if(a<=0)return{type:"incompatible",reason:"FOV model requires positive distortion (k1 > 0)"};const c=Math.sqrt(3*a);return{type:"approximate",params:[r,r,s,i,c],maxError:c>.1?.1:.01,warning:`Taylor approximation; omega=${c.toFixed(4)} radians`}}default:return{type:"incompatible",reason:`Cannot convert RADIAL to ${Yn(e)}`}}}function yj(e,t,n){const[r,s,i,a,l,c,d,h]=t;switch(e){case A.RADIAL:{const u=[];let m=0;if(Math.abs(d)>n||Math.abs(h)>n){const y=Math.max(Math.abs(d),Math.abs(h));u.push(`Dropping tangential: p1=${d.toExponential(3)}, p2=${h.toExponential(3)}`),m=Math.max(m,y)}const g=Math.abs(r-s)/r,p=g>tn?(r+s)/2:r;return g>tn&&(u.push(`Using mean f=${p.toFixed(2)} (fx=${r.toFixed(2)}, fy=${s.toFixed(2)})`),m=Math.max(m,Math.abs(r-p)/p*Math.max(i,a))),u.length>0?{type:"approximate",params:[p,i,a,l,c],maxError:m,warning:u.join("; ")}:{type:"exact",params:[r,i,a,l,c]}}case A.SIMPLE_RADIAL:{const u=[];let m=0;Math.abs(c)>n&&(u.push(`Dropping k2=${c.toExponential(3)}`),m=Math.max(m,Math.abs(c))),(Math.abs(d)>n||Math.abs(h)>n)&&(u.push(`Dropping tangential: p1=${d.toExponential(3)}, p2=${h.toExponential(3)}`),m=Math.max(m,Math.max(Math.abs(d),Math.abs(h))));const g=Math.abs(r-s)/r,p=g>tn?(r+s)/2:r;return g>tn&&(u.push(`Using mean f=${p.toFixed(2)} (fx=${r.toFixed(2)}, fy=${s.toFixed(2)})`),m=Math.max(m,Math.abs(r-p)/p*Math.max(i,a))),u.length>0?{type:"approximate",params:[p,i,a,l],maxError:m,warning:u.join("; ")}:{type:"exact",params:[r,i,a,l]}}case A.FULL_OPENCV:return{type:"approximate",params:[r,s,i,a,l,c,d,h,0,0,0,0],maxError:0,warning:"FULL_OPENCV uses rational polynomial formula; not mathematically equivalent to OPENCV"};default:return{type:"incompatible",reason:`Cannot convert OPENCV to ${Yn(e)}`}}}function vj(e,t){const[n,r,s,i,a]=t;switch(e){case A.SIMPLE_RADIAL:{const l=a*a/3,c=a<.1?"good":a<.5?"rough":"poor";return{type:"approximate",params:[n,s,i,l],maxError:c==="good"?.01:c==="rough"?.1:.5,warning:`Taylor approximation (${c}); omega=${a.toFixed(4)} radians (${(a*180/Math.PI).toFixed(1)}Â°)`}}case A.RADIAL:{const l=a*a/3,c=a<.1?"good":a<.5?"rough":"poor";return{type:"approximate",params:[n,s,i,l,0],maxError:c==="good"?.01:c==="rough"?.1:.5,warning:`Taylor approximation (${c}); omega=${a.toFixed(4)} radians (${(a*180/Math.PI).toFixed(1)}Â°)`}}default:return{type:"incompatible",reason:`Cannot convert FOV to ${Yn(e)}`}}}function wj(e,t){const[n,r,s,i]=t;switch(e){case A.RADIAL_FISHEYE:return{type:"exact",params:[n,r,s,i,0]};case A.OPENCV_FISHEYE:return{type:"exact",params:[n,n,r,s,i,0,0,0]};case A.THIN_PRISM_FISHEYE:return{type:"exact",params:[n,n,r,s,i,0,0,0,0,0,0,0]};default:return{type:"incompatible",reason:`Cannot convert SIMPLE_RADIAL_FISHEYE to ${Yn(e)}`}}}function bj(e,t,n){const[r,s,i,a,l]=t;switch(e){case A.SIMPLE_RADIAL_FISHEYE:return Math.abs(l)>n?{type:"approximate",params:[r,s,i,a],maxError:Math.abs(l),warning:`Dropping k2=${l.toExponential(3)} exceeds threshold`}:{type:"exact",params:[r,s,i,a]};case A.OPENCV_FISHEYE:return{type:"exact",params:[r,r,s,i,a,l,0,0]};case A.THIN_PRISM_FISHEYE:return{type:"exact",params:[r,r,s,i,a,l,0,0,0,0,0,0]};default:return{type:"incompatible",reason:`Cannot convert RADIAL_FISHEYE to ${Yn(e)}`}}}function Cj(e,t,n){const[r,s,i,a,l,c,d,h]=t;switch(e){case A.RADIAL_FISHEYE:{const u=[];let m=0;(Math.abs(d)>n||Math.abs(h)>n)&&(u.push(`Dropping k3=${d.toExponential(3)}, k4=${h.toExponential(3)}`),m=Math.max(m,Math.abs(d),Math.abs(h)));const g=Math.abs(r-s)/r,p=g>tn?(r+s)/2:r;return g>tn&&(u.push(`Using mean f=${p.toFixed(2)} (fx=${r.toFixed(2)}, fy=${s.toFixed(2)})`),m=Math.max(m,Math.abs(r-p)/p*Math.max(i,a))),u.length>0?{type:"approximate",params:[p,i,a,l,c],maxError:m,warning:u.join("; ")}:{type:"exact",params:[r,i,a,l,c]}}case A.SIMPLE_RADIAL_FISHEYE:{const u=[];let m=0;Math.abs(c)>n&&(u.push(`Dropping k2=${c.toExponential(3)}`),m=Math.max(m,Math.abs(c))),(Math.abs(d)>n||Math.abs(h)>n)&&(u.push(`Dropping k3=${d.toExponential(3)}, k4=${h.toExponential(3)}`),m=Math.max(m,Math.abs(d),Math.abs(h)));const g=Math.abs(r-s)/r,p=g>tn?(r+s)/2:r;return g>tn&&(u.push(`Using mean f=${p.toFixed(2)} (fx=${r.toFixed(2)}, fy=${s.toFixed(2)})`),m=Math.max(m,Math.abs(r-p)/p*Math.max(i,a))),u.length>0?{type:"approximate",params:[p,i,a,l],maxError:m,warning:u.join("; ")}:{type:"exact",params:[r,i,a,l]}}case A.THIN_PRISM_FISHEYE:return{type:"exact",params:[r,s,i,a,l,c,0,0,d,h,0,0]};default:return{type:"incompatible",reason:`Cannot convert OPENCV_FISHEYE to ${Yn(e)}`}}}function Sj(e,t,n){const[r,s,i,a,l,c,d,h,u,m,g,p]=t;switch(e){case A.OPENCV_FISHEYE:{const y=[];let w=0;return(Math.abs(d)>n||Math.abs(h)>n)&&(y.push(`Dropping tangential: p1=${d.toExponential(3)}, p2=${h.toExponential(3)}`),w=Math.max(w,Math.abs(d),Math.abs(h))),(Math.abs(g)>n||Math.abs(p)>n)&&(y.push(`Dropping thin prism: sx1=${g.toExponential(3)}, sy1=${p.toExponential(3)}`),w=Math.max(w,Math.abs(g),Math.abs(p))),y.length>0?{type:"approximate",params:[r,s,i,a,l,c,u,m],maxError:w,warning:y.join("; ")}:{type:"exact",params:[r,s,i,a,l,c,u,m]}}case A.RADIAL_FISHEYE:{const y=[];let w=0;(Math.abs(u)>n||Math.abs(m)>n)&&(y.push(`Dropping k3=${u.toExponential(3)}, k4=${m.toExponential(3)}`),w=Math.max(w,Math.abs(u),Math.abs(m))),(Math.abs(d)>n||Math.abs(h)>n)&&(y.push(`Dropping tangential: p1=${d.toExponential(3)}, p2=${h.toExponential(3)}`),w=Math.max(w,Math.abs(d),Math.abs(h))),(Math.abs(g)>n||Math.abs(p)>n)&&(y.push(`Dropping thin prism: sx1=${g.toExponential(3)}, sy1=${p.toExponential(3)}`),w=Math.max(w,Math.abs(g),Math.abs(p)));const x=Math.abs(r-s)/r,v=x>tn?(r+s)/2:r;return x>tn&&(y.push(`Using mean f=${v.toFixed(2)} (fx=${r.toFixed(2)}, fy=${s.toFixed(2)})`),w=Math.max(w,Math.abs(r-v)/v*Math.max(i,a))),y.length>0?{type:"approximate",params:[v,i,a,l,c],maxError:w,warning:y.join("; ")}:{type:"exact",params:[r,i,a,l,c]}}case A.SIMPLE_RADIAL_FISHEYE:{const y=[];let w=0;Math.abs(c)>n&&(y.push(`Dropping k2=${c.toExponential(3)}`),w=Math.max(w,Math.abs(c))),(Math.abs(u)>n||Math.abs(m)>n)&&(y.push(`Dropping k3=${u.toExponential(3)}, k4=${m.toExponential(3)}`),w=Math.max(w,Math.abs(u),Math.abs(m))),(Math.abs(d)>n||Math.abs(h)>n)&&(y.push(`Dropping tangential: p1=${d.toExponential(3)}, p2=${h.toExponential(3)}`),w=Math.max(w,Math.abs(d),Math.abs(h))),(Math.abs(g)>n||Math.abs(p)>n)&&(y.push(`Dropping thin prism: sx1=${g.toExponential(3)}, sy1=${p.toExponential(3)}`),w=Math.max(w,Math.abs(g),Math.abs(p)));const x=Math.abs(r-s)/r,v=x>tn?(r+s)/2:r;return x>tn&&(y.push(`Using mean f=${v.toFixed(2)} (fx=${r.toFixed(2)}, fy=${s.toFixed(2)})`),w=Math.max(w,Math.abs(r-v)/v*Math.max(i,a))),y.length>0?{type:"approximate",params:[v,i,a,l],maxError:w,warning:y.join("; ")}:{type:"exact",params:[r,i,a,l]}}default:return{type:"incompatible",reason:`Cannot convert THIN_PRISM_FISHEYE to ${Yn(e)}`}}}function kj(e){const t=Object.values(A).filter(r=>typeof r=="number"),n=[];for(const r of t){if(r===e)continue;const s=$p(e,r);s!=="incompatible"&&n.push({modelId:r,compatibility:s})}return n}function Ij(e,t,n=Op){const r=Bp(e,t,n);if(r.type==="incompatible")return null;const s=Rf[e.modelId]??[],i=Rf[t]??[],{characterization:a,isLossy:l,isExpansion:c,description:d}=Mj(e.modelId,t,e.params,r.params,r.type,n);return{sourceParamNames:s,sourceParams:[...e.params],targetParamNames:i,targetParams:r.params,characterization:a,isLossy:l,isExpansion:c,description:d,warning:r.type==="approximate"?r.warning:void 0}}function Mj(e,t,n,r,s,i){const a=n.length,l=r.length;if(e===A.FOV||t===A.FOV)return{characterization:"approximation",isLossy:!0,isExpansion:!1,description:"Taylor series approximation between FOV and polynomial models"};if(t===A.FULL_OPENCV)return{characterization:"approximation",isLossy:!1,isExpansion:!0,description:"Rational polynomial formula differs from simpler models"};if(l>a){const c=l-a,d=r.slice(-c).every(h=>Math.abs(h)<i);if(s==="exact"||d)return{characterization:"expansion",isLossy:!1,isExpansion:!0,description:`Adding ${c} parameter${c>1?"s":""} (set to zero)`}}if(l<a){const c=jj(e,t,n,i);return c.hasNonZero?{characterization:"lossy",isLossy:!0,isExpansion:!1,description:c.description}:{characterization:"exact",isLossy:!1,isExpansion:!1,description:c.description||"Dropped parameters were already zero"}}return s==="approximate"?{characterization:"lossy",isLossy:!0,isExpansion:!1,description:"Some parameter information is lost"}:{characterization:"exact",isLossy:!1,isExpansion:!1,description:"Equivalent representation"}}function jj(e,t,n,r){const s=[];let i=!1;if(e===A.PINHOLE&&t===A.SIMPLE_PINHOLE){const[l,c]=n,d=Math.abs(l-c)/l;d>tn?(i=!0,s.push(`fy (aspect ratio diff: ${(d*100).toFixed(2)}%)`)):s.push("fy (aspect ratio preserved)")}if(e===A.RADIAL&&t===A.SIMPLE_RADIAL){const l=n[4];Math.abs(l)>r?(i=!0,s.push(`k2=${l.toExponential(3)}`)):s.push("k2 (was zero)")}if(e===A.OPENCV&&t===A.RADIAL){const[l,c,,,,,d,h]=n,u=Math.abs(l-c)/l;(Math.abs(d)>r||Math.abs(h)>r)&&(i=!0,s.push(`tangential (p1=${d.toExponential(3)}, p2=${h.toExponential(3)})`)),u>tn&&(i=!0,s.push(`fy (aspect ratio diff: ${(u*100).toFixed(2)}%)`))}if(e===A.OPENCV&&t===A.SIMPLE_RADIAL){const[l,c,,,,d,h,u]=n,m=Math.abs(l-c)/l;Math.abs(d)>r&&(i=!0,s.push(`k2=${d.toExponential(3)}`)),(Math.abs(h)>r||Math.abs(u)>r)&&(i=!0,s.push(`tangential (p1=${h.toExponential(3)}, p2=${u.toExponential(3)})`)),m>tn&&(i=!0,s.push(`fy (aspect ratio diff: ${(m*100).toFixed(2)}%)`))}if(e===A.RADIAL_FISHEYE&&t===A.SIMPLE_RADIAL_FISHEYE){const l=n[4];Math.abs(l)>r?(i=!0,s.push(`k2=${l.toExponential(3)}`)):s.push("k2 (was zero)")}if(e===A.OPENCV_FISHEYE){const[l,c,,,,,d,h]=n,u=Math.abs(l-c)/l;(t===A.RADIAL_FISHEYE||t===A.SIMPLE_RADIAL_FISHEYE)&&((Math.abs(d)>r||Math.abs(h)>r)&&(i=!0,s.push(`k3=${d.toExponential(3)}, k4=${h.toExponential(3)}`)),u>tn&&(i=!0,s.push(`fy (aspect ratio diff: ${(u*100).toFixed(2)}%)`)))}if(e===A.THIN_PRISM_FISHEYE){const[l,c,,,,,d,h,u,m,g,p]=n,y=Math.abs(l-c)/l;t===A.OPENCV_FISHEYE?((Math.abs(d)>r||Math.abs(h)>r)&&(i=!0,s.push(`tangential (p1=${d.toExponential(3)}, p2=${h.toExponential(3)})`)),(Math.abs(g)>r||Math.abs(p)>r)&&(i=!0,s.push(`thin prism (sx1=${g.toExponential(3)}, sy1=${p.toExponential(3)})`))):(t===A.RADIAL_FISHEYE||t===A.SIMPLE_RADIAL_FISHEYE)&&((Math.abs(u)>r||Math.abs(m)>r)&&(i=!0,s.push("k3, k4")),(Math.abs(d)>r||Math.abs(h)>r)&&(i=!0,s.push("tangential")),(Math.abs(g)>r||Math.abs(p)>r)&&(i=!0,s.push("thin prism")),y>tn&&(i=!0,s.push("fy")))}const a=s.length>0?`Dropping: ${s.join(", ")}`:"Parameter reduction";return{hasNonZero:i,description:a}}function Df(e){return Math.abs(e)<1e-10?"0":Math.abs(e)>=100||Math.abs(e)<.01&&Math.abs(e)>0?e.toExponential(2):e.toPrecision(5).replace(/\.?0+$/,"")}const Ej={exact:{text:Ir.success,label:"Exact"},expansion:{text:Ir.info,label:"Expansion"},lossy:{text:Ir.warning,label:"Lossy"},approximation:{text:Ir.caution,label:"Approx"}},Pj=f.memo(function({isOpen:t,onClose:n}){const r=me(D=>D.reconstruction),s=me(D=>D.setReconstruction),i=Ft(D=>D.addNotification),[a,l]=f.useState("all"),[c,d]=f.useState(null),{position:h,panelRef:u,handleDragStart:m,centerModal:g}=wi({estimatedWidth:360,estimatedHeight:160,isOpen:t}),{zIndex:p,bringToFront:y}=vi(t);kt("escape",n,{enabled:t},[t,n]);const w=f.useMemo(()=>r?Array.from(r.cameras.entries()):[],[r]),x=f.useMemo(()=>{if(!r)return[];if(a==="all")return Array.from(r.cameras.values());const D=r.cameras.get(a);return D?[D]:[]},[r,a]),v=f.useMemo(()=>{const D=new Set;for(const B of x)D.add(B.modelId);return Array.from(D)},[x]),k=f.useMemo(()=>{if(v.length===0)return[];const D=v.map(Z=>new Map(kj(Z).map(F=>[F.modelId,F.compatibility])));if(D.length===1)return Array.from(D[0].entries()).map(([Z,F])=>({modelId:Z,compatibility:F}));const B=D[0],E=[];for(const[Z,F]of B){let $=!0,T=F;for(let z=1;z<D.length;z++){const H=D[z].get(Z);if(!H){$=!1;break}H==="approximate"&&(T="approximate")}$&&E.push({modelId:Z,compatibility:T})}return E},[v]),b=f.useMemo(()=>c===null?null:k.some(D=>D.modelId===c)?c:null,[c,k]),S=f.useMemo(()=>!b||x.length===0?null:Ij(x[0],b),[b,x]);f.useEffect(()=>{t&&S&&requestAnimationFrame(g)},[t,S,g]);const C=f.useCallback(()=>{if(!r||!b)return;const D=new Map(r.cameras);let B=0,E=0;for(const $ of x){const T=Bp($,b);T.type!=="incompatible"&&(D.set($.cameraId,{...$,modelId:b,params:T.params}),B++,T.type==="approximate"&&E++)}if(B===0){i("warning","No cameras were converted");return}s({...r,cameras:D});const Z=ul(b),F=E>0?`Converted ${B} camera(s) to ${Z} (~)`:`Converted ${B} camera(s) to ${Z}`;i("info",F),n()},[r,x,b,s,i,n]),M=f.useMemo(()=>{const D=[];w.length>1&&D.push({value:"all",label:`All (${w.length})`});for(const[B,E]of w)D.push({value:String(B),label:`#${B}: ${ul(E.modelId)}`});return D},[w]),I=f.useCallback(D=>{const B=D.target.value;l(B==="all"?"all":parseInt(B,10)),d(null)},[]),L=f.useCallback(D=>{const B=D.target.value;d(B===""?null:parseInt(B,10))},[]),P=f.useMemo(()=>{if(!S)return[];const D=[],B=new Set([...S.sourceParamNames,...S.targetParamNames]);for(const E of B){const Z=S.sourceParamNames.indexOf(E),F=S.targetParamNames.indexOf(E);if(Z!==-1&&F!==-1){const $=S.sourceParams[Z],T=S.targetParams[F];D.push({name:E,sourceValue:$,targetValue:T,status:Math.abs($-T)>1e-10?"changed":"unchanged"})}else Z!==-1?D.push({name:E,sourceValue:S.sourceParams[Z],targetValue:0,status:"removed"}):D.push({name:E,sourceValue:null,targetValue:S.targetParams[F],status:"new"})}return D},[S]),_=b!==null&&x.length>0,N=S?Ej[S.characterization]:null;return t?o.jsxs("div",{className:"fixed inset-0 pointer-events-none",style:{zIndex:p},children:[o.jsx("div",{className:ft.backdrop,onClick:n}),o.jsxs("div",{ref:u,className:ft.toolPanel,style:{left:h.x,top:h.y},onPointerDown:y,children:[o.jsxs("div",{className:ft.toolHeader,onPointerDown:m,style:{touchAction:"none"},children:[o.jsx("span",{className:ft.toolHeaderTitle,children:"Convert Camera Model"}),o.jsx("button",{onClick:n,onPointerDown:D=>D.stopPropagation(),className:ft.toolHeaderClose,title:"Close",children:o.jsx(Oo,{className:"w-3.5 h-3.5"})})]}),o.jsxs("div",{className:ft.toolContent,children:[o.jsxs("div",{className:"flex items-center gap-2",children:[o.jsx("select",{value:a==="all"?"all":String(a),onChange:I,className:`${nn.select} ${nn.selectSizes.xs} flex-1`,children:M.map(D=>o.jsx("option",{value:D.value,children:D.label},D.value))}),o.jsx("span",{className:"text-ds-muted text-xs",children:"â†’"}),k.length>0?o.jsxs("select",{value:b!==null?String(b):"",onChange:L,className:`${nn.select} ${nn.selectSizes.xs} flex-1`,children:[o.jsx("option",{value:"",children:"Select..."}),k.map(({modelId:D,compatibility:B})=>o.jsxs("option",{value:String(D),children:[ul(D),B==="approximate"?" ~":""]},D))]}):o.jsx("span",{className:"flex-1 text-ds-muted text-xs",children:"No targets"})]}),S&&o.jsxs("div",{className:"text-xs space-y-2",children:[o.jsxs("div",{className:"flex items-center gap-2",children:[o.jsx("span",{className:N?.text,children:N?.label}),o.jsx("span",{className:"text-ds-muted truncate",children:S.description})]}),o.jsx("div",{className:"font-mono",children:P.map((D,B)=>o.jsxs("div",{className:"flex items-center",children:[o.jsx("span",{className:`w-16 text-right ${D.status==="removed"?"text-red-400 line-through":"text-ds-primary"}`,children:D.sourceValue!==null?Df(D.sourceValue):"â€”"}),o.jsx("span",{className:`flex-1 text-center px-2 ${D.status==="new"?"text-blue-400":D.status==="removed"?"text-red-400":"text-ds-muted"}`,children:D.name}),o.jsx("span",{className:`w-16 text-left ${D.status==="new"?"text-blue-400":D.status==="changed"?"text-amber-400":D.status==="removed"?"text-ds-muted":"text-ds-primary"}`,children:D.status==="removed"?"â€”":Df(D.targetValue)})]},B))}),S.warning&&o.jsx("div",{className:"text-amber-400",children:S.warning})]}),o.jsxs("div",{className:cn.actionGroup,children:[o.jsxs("button",{onClick:C,disabled:!_,className:_?cn.actionButtonPrimary:cn.actionButtonPrimaryDisabled,children:["Convert",x.length>1?` (${x.length})`:""]}),o.jsx("button",{onClick:n,className:cn.actionButton,children:"Cancel"})]})]})]})]}):null}),Tl=cn,Nj=f.memo(function({id:t,label:n,name:r,file:s,onView:i,onRestore:a}){const l=zc(s,r,!0);return o.jsxs("div",{className:"flex items-center gap-2 px-2 py-1 bg-ds-secondary rounded text-xs",children:[o.jsxs("div",{className:"w-8 h-8 flex-shrink-0 rounded overflow-hidden relative bg-ds-tertiary",children:[l?o.jsx("img",{src:l,alt:r,className:"w-full h-full object-cover",style:{filter:Rc},draggable:!1}):o.jsx("div",{className:"w-full h-full flex items-center justify-center text-ds-muted text-[8px]",children:t}),o.jsx("div",{className:"absolute inset-0 pointer-events-none",children:o.jsxs("svg",{className:"w-full h-full",viewBox:"0 0 100 100",preserveAspectRatio:"none",children:[o.jsx("line",{x1:"0",y1:"0",x2:"100",y2:"100",stroke:"var(--bg-primary)",strokeWidth:"3"}),o.jsx("line",{x1:"100",y1:"0",x2:"0",y2:"100",stroke:"var(--bg-primary)",strokeWidth:"3"})]})})]}),o.jsxs("button",{onClick:()=>i(t),className:"flex-1 text-left text-ds-primary hover:text-ds-accent truncate",title:`View ${r}`,children:[n,": ",r]}),o.jsx("button",{onClick:()=>a(t),className:"text-ds-success hover:bg-ds-success/20 p-1 rounded",title:"Restore",children:o.jsx(ii,{className:"w-3 h-3"})})]})}),Aj=f.memo(function({isOpen:t,onClose:n}){const r=me(O=>O.reconstruction),s=me(O=>O.loadedFiles),i=me(O=>O.imageUrlBase),a=Qn(O=>O.pendingDeletions),l=Qn(O=>O.unmarkDeletion),c=Qn(O=>O.markBulkForDeletion),d=G(O=>O.openImageDetail),h=a.size>0,[u,m]=f.useState(""),[g,p]=f.useState(""),y=f.useMemo(()=>{if(!r)return[];const O=new Map;for(const[J,re]of r.images){let q=O.get(re.cameraId);if(!q){const ie=r.cameras.get(re.cameraId),we=ie?_c[ie.modelId]??"Unknown":"Unknown",Ce=ie?`${ie.width}x${ie.height}`:"";q={label:`Camera ${re.cameraId}: ${we} ${Ce}`,imageIds:[]},O.set(re.cameraId,q)}q.imageIds.push(J)}return Array.from(O.entries()).sort(([J],[re])=>J-re).map(([J,{label:re,imageIds:q}])=>({cameraId:J,label:`${re} (${q.length} img${q.length!==1?"s":""})`,imageIds:q}))},[r]),w=f.useMemo(()=>r?.rigData?Array.from(r.rigData.frames.entries()).sort(([O],[J])=>O-J).map(([O,J])=>{const re=J.dataIds.filter(q=>q.sensorId.type===hx.CAMERA&&r.images.has(q.dataId)).map(q=>q.dataId);return{frameId:O,label:`Frame ${O} (${re.length} img${re.length!==1?"s":""})`,imageIds:re}}).filter(O=>O.imageIds.length>0):null,[r]),x=f.useCallback(()=>{const O=Number(u),J=y.find(re=>re.cameraId===O);J&&c(J.imageIds),m("")},[u,y,c]),v=f.useCallback(()=>{const O=Number(g),J=w?.find(re=>re.frameId===O);J&&c(J.imageIds),p("")},[g,w,c]),k=5,[b,S]=f.useState(0);f.useEffect(()=>{S(0)},[a,t]);const[C,M]=f.useState(!1),I=f.useRef(void 0);f.useEffect(()=>{M(!1)},[a,t]),f.useEffect(()=>{if(C)return I.current=setTimeout(()=>M(!1),3e3),()=>clearTimeout(I.current)},[C]);const{position:L,panelRef:P,handleDragStart:_}=wi({estimatedWidth:300,estimatedHeight:400,isOpen:t}),{zIndex:N,bringToFront:D}=vi(t);kt("escape",n,{enabled:t},[t,n]);const B=f.useMemo(()=>{if(!r)return[];const O=s?.imageFiles;return Array.from(a).map(J=>{const re=r.images.get(J),q=re?.name??`Image ${J}`;let ie;return i?ie=Jn(q):bn()?ie=Vn(q)??void 0:ie=Zr(O,q),{id:J,name:q,file:ie,cameraId:re?.cameraId}}).sort((J,re)=>J.id-re.id)},[r,a,s,i]),E=r?r.cameras.size>1:!1,Z=Math.max(1,Math.ceil(B.length/k)),F=Math.min(b,Z-1),$=B.slice(F*k,(F+1)*k),T=f.useCallback(()=>{if(h){if(!C){M(!0);return}M(!1),jy(),n()}},[h,C,n]),z=f.useCallback(()=>{Ey()},[]),H=f.useCallback(O=>{d(O)},[d]);return t?o.jsx("div",{className:"fixed inset-0 pointer-events-none",style:{zIndex:N},children:o.jsxs("div",{ref:P,className:ft.toolPanel,style:{left:L.x,top:L.y,width:300},onPointerDown:D,children:[o.jsxs("div",{className:ft.toolHeader,onPointerDown:_,style:{touchAction:"none"},children:[o.jsx("span",{className:ft.toolHeaderTitle,children:"Delete Images"}),o.jsx("button",{onClick:n,onPointerDown:O=>O.stopPropagation(),className:ft.toolHeaderClose,title:"Close",children:o.jsx(Oo,{className:"w-3.5 h-3.5"})})]}),o.jsxs("div",{className:ft.toolContent,children:[y.length>0&&o.jsxs("div",{children:[o.jsx("div",{className:"text-ds-secondary text-xs mb-1",children:"Select by camera:"}),o.jsxs("div",{className:"flex gap-1 items-center",children:[o.jsxs("select",{value:u,onChange:O=>m(O.target.value),className:`${nn.select} ${nn.selectSizes.xs} flex-1`,children:[o.jsx("option",{value:"",children:"Choose camera..."}),y.map(O=>o.jsx("option",{value:O.cameraId,children:O.label},O.cameraId))]}),o.jsx("button",{onClick:x,disabled:!u,className:`p-1 rounded transition-colors ${u?"text-ds-accent hover:bg-ds-hover":"text-ds-muted cursor-default"}`,title:"Add all images from this camera",children:o.jsx("svg",{className:"w-4 h-4",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2.5",strokeLinecap:"round",children:o.jsx("path",{d:"M12 5v14M5 12h14"})})})]})]}),w&&w.length>0&&o.jsxs("div",{children:[o.jsx("div",{className:"text-ds-secondary text-xs mb-1",children:"Select by frame:"}),o.jsxs("div",{className:"flex gap-1 items-center",children:[o.jsxs("select",{value:g,onChange:O=>p(O.target.value),className:`${nn.select} ${nn.selectSizes.xs} flex-1`,children:[o.jsx("option",{value:"",children:"Choose frame..."}),w.map(O=>o.jsx("option",{value:O.frameId,children:O.label},O.frameId))]}),o.jsx("button",{onClick:v,disabled:!g,className:`p-1 rounded transition-colors ${g?"text-ds-accent hover:bg-ds-hover":"text-ds-muted cursor-default"}`,title:"Add all images from this frame",children:o.jsx("svg",{className:"w-4 h-4",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2.5",strokeLinecap:"round",children:o.jsx("path",{d:"M12 5v14M5 12h14"})})})]})]}),h?o.jsxs(o.Fragment,{children:[o.jsxs("div",{className:"text-ds-secondary text-sm",children:[a.size," image",a.size!==1?"s":""," marked for deletion:"]}),o.jsx("div",{className:"space-y-1",children:$.map(({id:O,name:J,file:re,cameraId:q})=>o.jsx(Nj,{id:O,label:E&&q!=null?`#${q}:${O}`:`#${O}`,name:J,file:re,onView:H,onRestore:l},O))}),Z>1&&o.jsxs("div",{className:"flex items-center justify-between text-xs text-ds-secondary",children:[o.jsx("button",{onClick:()=>S(O=>Math.max(0,O-1)),disabled:F===0,className:F===0?"text-ds-muted cursor-default":"text-ds-accent hover:underline",children:"Prev"}),o.jsxs("span",{children:[F+1," / ",Z]}),o.jsx("button",{onClick:()=>S(O=>Math.min(Z-1,O+1)),disabled:F>=Z-1,className:F>=Z-1?"text-ds-muted cursor-default":"text-ds-accent hover:underline",children:"Next"})]}),o.jsxs("div",{className:Tl.actionGroup,children:[o.jsx("button",{onClick:z,className:Tl.actionButton,children:"Restore All"}),o.jsx("button",{onClick:T,className:Tl.actionButtonPrimary,style:C?{background:"var(--bg-danger, #dc2626)",color:"white"}:void 0,children:C?`Confirm Delete (${a.size})`:`Apply (${a.size})`})]}),o.jsx("div",{className:"text-ds-warning text-xs",children:'Click "Apply" to permanently remove images from the reconstruction.'})]}):o.jsx("div",{className:"text-ds-secondary text-sm py-2",children:o.jsx("div",{className:"text-ds-muted text-xs",children:"Or open an image detail modal and click the trash icon to mark individual images."})})]})]})}):null}),Lj=[{key:"buttons",label:"Buttons",icon:o.jsx(iu,{className:"w-4 h-4"})},{key:"axes",label:"Axes",icon:o.jsx(cu,{className:"w-4 h-4"})},{key:"grid",label:"Grid",icon:o.jsx(lp,{className:"w-4 h-4"})},{key:"gizmo",label:"Gizmo",icon:o.jsx(au,{className:"w-4 h-4"})},{key:"points",label:"Points",icon:o.jsx(cp,{className:"w-4 h-4"})},{key:"cameras",label:"Cameras",icon:o.jsx(lu,{className:"w-4 h-4"})},{key:"matches",label:"Matches",icon:o.jsx(ap,{className:"w-4 h-4"})},{key:"rigs",label:"Rigs",icon:o.jsx(dp,{className:"w-4 h-4"})}],_j=f.memo(function({isOpen:t,onClose:n}){const r=G(u=>u.autoHideElements),s=G(u=>u.setAutoHideElement),{zIndex:i,bringToFront:a}=vi(t),{position:l,panelRef:c,handleDragStart:d}=wi({estimatedWidth:240,estimatedHeight:400,isOpen:t}),h=f.useCallback(u=>{s(u,!r[u])},[r,s]);return t?o.jsx("div",{className:"fixed inset-0 pointer-events-none",style:{zIndex:i},children:o.jsxs("div",{ref:c,className:ft.toolPanel,style:{left:l.x,top:l.y,width:240},onPointerDown:a,children:[o.jsxs("div",{className:ft.toolHeader,onPointerDown:d,style:{touchAction:"none"},children:[o.jsx("span",{className:ft.toolHeaderTitle,children:"Auto-hide Elements"}),o.jsx("button",{onClick:n,onPointerDown:u=>u.stopPropagation(),className:ft.toolHeaderClose,title:"Close",children:o.jsx(Oo,{className:"w-3.5 h-3.5"})})]}),o.jsxs("div",{className:"p-4 overflow-y-auto",style:{maxHeight:"calc(100vh - 120px)"},children:[o.jsx("div",{className:"text-ds-secondary text-xs mb-3",children:"Select which elements hide when idle."}),o.jsx("div",{className:"flex flex-col",children:Lj.map(({key:u,label:m,icon:g})=>o.jsxs("label",{className:"flex items-center gap-2 cursor-pointer hover-ds-hover rounded px-2 py-1.5",children:[o.jsx("span",{className:"w-4 h-4 flex-shrink-0 opacity-60",children:g}),o.jsx("span",{className:"text-sm text-ds-primary",children:m}),o.jsx("span",{className:"ml-auto",children:o.jsx(ls,{checked:r[u],onChange:()=>h(u)})})]},u))}),o.jsx("div",{className:"mt-4 pt-3",children:o.jsx("button",{onClick:n,className:ft.actionButtonPrimary,children:"Done"})})]})]})}):null}),tt=cn,Tj={0:"â°",1:"Â¹",2:"Â²",3:"Â³",4:"â´",5:"âµ",6:"â¶",7:"â·",8:"â¸",9:"â¹","-":"â»",".":"Â·"};function Ff(e){return e.toFixed(1).split("").map(n=>Tj[n]||n).join("")}const Wi=["Why did COLMAP break up with the blurry photo? No future together.","COLMAP's dating profile: Looking for matches.","My COLMAP crashed. Guess it couldn't handle my good looks.","COLMAP walked into a bar. The bartender said, 'You look like you've seen some points.'","Why is COLMAP bad at poker? It always shows its hand... and tracks it.","COLMAP's favorite dance? The bundle adjustment shuffle.","I told COLMAP a joke. It took 3 hours to get the point.","COLMAP at therapy: 'I have too many issues... with my features.'","Why did the point cloud go to school? To get more depth.","COLMAP's life motto: When in doubt, RANSAC it out."],Rj=f.memo(function({styles:t,activePanel:n,setActivePanel:r,onOpenFloorModal:s}){const i=me(S=>S.reconstruction),a=me(S=>S.wasmReconstruction),l=me(S=>S.droppedFiles),c=mn(S=>S.transform),d=mn(S=>S.setTransform),h=mn(S=>S.resetTransform),u=G(S=>S.showGizmo),m=G(S=>S.toggleGizmo),{processFiles:g}=Ms(),p=lt(S=>S.pickingMode),y=lt(S=>S.setPickingMode),w=!mi(c),x=a?.hasPoints()??!1,v=S=>S*(180/Math.PI),k=S=>S*(Math.PI/180);kt(ze.toggleGizmo.keys,m,{scopes:ze.toggleGizmo.scopes},[m]);const b=`Transform (T): ${u?"On":"Off"}${w?" (dbl-click to apply)":""}`;return o.jsx(Tn,{panelId:"transform",activePanel:n,setActivePanel:r,icon:o.jsx(au,{className:"w-6 h-6"}),tooltip:b,isActive:u,onClick:m,onDoubleClick:w?wa:void 0,panelTitle:"Transform",disabled:!i,children:o.jsxs("div",{className:t.panelContent,children:[o.jsx(br,{label:"Gizmo (T)",checked:u,onChange:m}),o.jsx(pt,{label:"Scale",value:c.scale,min:.01,max:10,step:.01,onChange:S=>d({scale:S}),formatValue:S=>S.toFixed(2)}),o.jsx(pt,{label:"Rotate-X",value:v(c.rotationX),min:-180,max:180,step:1,onChange:S=>d({rotationX:k(S)}),formatValue:S=>`${S.toFixed(0)}Â°`}),o.jsx(pt,{label:"Rotate-Y",value:v(c.rotationY),min:-180,max:180,step:1,onChange:S=>d({rotationY:k(S)}),formatValue:S=>`${S.toFixed(0)}Â°`}),o.jsx(pt,{label:"Rotate-Z",value:v(c.rotationZ),min:-180,max:180,step:1,onChange:S=>d({rotationZ:k(S)}),formatValue:S=>`${S.toFixed(0)}Â°`}),o.jsx(pt,{label:"Translate-X",value:c.translationX,min:-100,max:100,step:.1,onChange:S=>d({translationX:S}),formatValue:S=>S.toFixed(1)}),o.jsx(pt,{label:"Translate-Y",value:c.translationY,min:-100,max:100,step:.1,onChange:S=>d({translationY:S}),formatValue:S=>S.toFixed(1)}),o.jsx(pt,{label:"Translate-Z",value:c.translationZ,min:-100,max:100,step:.1,onChange:S=>d({translationZ:S}),formatValue:S=>S.toFixed(1)}),o.jsx("div",{className:t.presetGroup,children:o.jsx("button",{onClick:()=>Xh(),className:t.presetButton,"data-tooltip":"Move scene center to (0,0,0)","data-tooltip-pos":"bottom",children:"Center at Origin"})}),o.jsxs("div",{className:t.presetGroup,children:[o.jsx("button",{onClick:()=>y(p==="origin-1pt"?"off":"origin-1pt"),className:p==="origin-1pt"?t.actionButtonPrimary:t.presetButton,"data-tooltip":"{LMB} Click 1 point to set as origin (0,0,0)","data-tooltip-pos":"bottom",children:"1-Point Origin"}),o.jsx("button",{onClick:()=>y(p==="distance-2pt"?"off":"distance-2pt"),className:p==="distance-2pt"?t.actionButtonPrimary:t.presetButton,"data-tooltip":"{LMB} Click 2 points, set target distance","data-tooltip-pos":"bottom",children:"2-Point Scale"}),o.jsx("button",{onClick:()=>y(p==="normal-3pt"?"off":"normal-3pt"),className:p==="normal-3pt"?t.actionButtonPrimary:t.presetButton,"data-tooltip":"{LMB} Click 3 points clockwise to align plane with Y-up","data-tooltip-pos":"bottom",children:"3-Point Align"}),o.jsx("button",{onClick:s,disabled:!x,className:x?t.presetButton:t.actionButtonDisabled,"data-tooltip":"RANSAC floor plane detection","data-tooltip-pos":"bottom",children:"Floor Detection"})]}),o.jsxs("div",{className:t.actionGroup,children:[o.jsx("button",{onClick:h,disabled:!w,className:w?t.actionButton:t.actionButtonDisabled,children:"Reset"}),o.jsx("button",{onClick:()=>{l&&(h(),g(l))},disabled:!l,className:l?t.actionButton:t.actionButtonDisabled,children:"Reload"}),o.jsx("button",{onClick:wa,disabled:!w,className:w?t.actionButtonPrimary:t.actionButtonPrimaryDisabled,children:"Apply"})]}),w&&o.jsx("div",{className:t.hint,children:'Transform will be applied to reconstruction data when you click "Apply".'})]})})}),Dj=f.memo(function({activePanel:t,setActivePanel:n}){const r=G(u=>u.galleryCollapsed),s=G(u=>u.toggleGalleryCollapsed),i=G(u=>u.embedMode),a=G(u=>u.touchMode),l=G(u=>u.touchUI.galleryDrawer),c=G(u=>u.toggleTouchUI);if(i)return null;const d=a?l:!r,h=a?()=>c("galleryDrawer"):s;return o.jsx(Tn,{panelId:"gallery",activePanel:t,setActivePanel:n,icon:d?o.jsx(Zk,{className:"w-6 h-6"}):o.jsx(Vk,{className:"w-6 h-6"}),tooltip:d?"Hide gallery":"Show gallery",isActive:d,onClick:h})});function Fj(){const[e,t]=f.useState(null),n=G(U=>U.showFloorModal),r=G(U=>U.setShowFloorModal),s=G(U=>U.showDeletionModal),i=G(U=>U.setShowDeletionModal),a=G(U=>U.showConversionModal),l=G(U=>U.setShowConversionModal),c=G(U=>U.showAutoHideEditor),d=G(U=>U.setShowAutoHideEditor),h=G(U=>U.touchMode),u=du(),m=yi(),g=js(),p=Ga(),y=qa(),w=Xa(),x=bp(),v=wp(),k=fu(),b=hu(),S=mu(),C=Ka(),M=Cp(),I=Qa(),L=qI(),P=GI(),_=u.visible,N=k.setVisible,D=k.toggleVisible,B=u.size,E=k.setSize,Z=u.opacity,F=k.setOpacity,$=u.colorMode,T=k.setColorMode,z=u.minTrackLength,H=k.setMinTrackLength,O=u.maxReprojectionError,J=k.setMaxReprojectionError,re=u.thinning,q=k.setThinning,ie=m.visible,we=b.setVisible,Ce=m.displayMode,Re=b.setDisplayMode,ee=m.scaleFactor,he=b.setScaleFactor,Se=m.scale,xe=b.setScale,Ae=m.colorMode,ye=b.setColorMode,Pe=m.singleColor,Ye=b.setSingleColor,$e=m.standbyOpacity,qe=b.setStandbyOpacity,ct=m.undistortionEnabled,K=b.setUndistortionEnabled,Le=g.planeOpacity,fe=S.setPlaneOpacity,ae=g.visible,De=S.setVisible,Y=g.colorMode,W=S.setColorMode,le=g.color,Q=S.setColor,pe=g.animationSpeed,Ne=S.setAnimationSpeed,Je=g.unselectedOpacity,ke=S.setUnselectedOpacity,je=p.mode,jt=C.setMode,oe=p.flySpeed,ge=C.setFlySpeed,Xe=p.flyTransitionDuration,dt=C.setFlyTransitionDuration,mt=p.pointerLock,Rt=C.setPointerLock,xt=p.projection,Xt=C.setProjection,Dn=p.fov,de=C.setFov,Me=p.horizonLock,Fe=C.setHorizonLock,_e=p.autoRotateMode,et=C.setAutoRotateMode,Ve=p.autoRotateSpeed,nt=C.setAutoRotateSpeed,He=p.autoFovEnabled,Ht=C.setAutoFovEnabled,it=y.visible,pn=M.setVisible,St=y.displayMode,sn=M.setDisplayMode,qr=y.opacity,Ge=M.setOpacity,ot=y.color,Ee=M.setColor,Ze=w.visible,$t=I.setVisible,Dt=I.toggleVisible,qt=w.coordinateSystem,yt=I.setCoordinateSystem,Et=w.scale,ut=I.setScale,Pt=w.labelMode,se=I.setLabelMode,We=x.visible,Ke=L.setVisible,En=L.toggleVisible,Wt=x.scale,Pn=L.setScale,gn=G(U=>U.backgroundColor),j=G(U=>U.setBackgroundColor),V=G(U=>U.setView),ne=G(U=>U.openContextMenuEditor),be=G(U=>U.idleHideTimeout),bt=G(U=>U.setIdleHideTimeout),Bt=G(U=>U.autoHideElements.buttons),vt=me(U=>U.reconstruction),Nt=v.visible,dn=P.setVisible,qn=v.displayMode,ar=P.setDisplayMode,Xr=v.colorMode,Kr=P.setColorMode,ho=v.color,mo=P.setColor,Es=v.opacity,Ci=P.setOpacity,Si=f.useMemo(()=>{if(!vt)return{hasRigData:!1,cameraCount:0,frameCount:0};const U=new Map;for(const cr of vt.images.values()){const Nn=cr.name.split(/[/\\]/),Uu=Nn.length>=2?Nn[Nn.length-1]:cr.name;U.set(Uu,(U.get(Uu)??0)+1)}let po=0,go=0;for(const cr of U.values())cr>=2&&(po++,go=Math.max(go,cr));return{hasRigData:po>0,cameraCount:go,frameCount:po}},[vt]),{hasRigData:Fn,cameraCount:Lu,frameCount:_u}=Si,[lr,Tu]=f.useState(()=>wo(gn));f.useEffect(()=>{Tu(U=>es(U.h,U.s,U.l)!==gn?wo(gn):U)},[gn]);const gr=f.useCallback(U=>{Tu(U),j(es(U.h,U.s,U.l))},[j]),tl=f.useCallback(()=>{const U=lr.l<50?100:0;gr({h:0,s:0,l:U})},[lr.l,gr]),ig=f.useCallback(U=>{gr({...lr,h:U})},[lr,gr]),ag=f.useCallback(U=>{gr({...lr,s:U})},[lr,gr]),lg=f.useCallback(U=>{gr({...lr,l:U})},[lr,gr]),cg=f.useCallback(U=>{gr(wo(U))},[gr]),[Lr,Ru]=f.useState(()=>wo(Pe));f.useEffect(()=>{Ru(U=>es(U.h,U.s,U.l)!==Pe?wo(Pe):U)},[Pe]);const Qr=f.useCallback(U=>{Ru(U),Ye(es(U.h,U.s,U.l))},[Ye]),ug=f.useCallback(U=>{Qr({...Lr,h:U})},[Lr,Qr]),dg=f.useCallback(U=>{Qr({...Lr,s:U})},[Lr,Qr]),fg=f.useCallback(U=>{Qr({...Lr,l:U})},[Lr,Qr]),hg=f.useCallback(U=>{Qr(wo(U))},[Qr]),nl=f.useCallback(()=>{jt(je==="orbit"?"fly":"orbit")},[je,jt]),Du=f.useCallback(()=>{K(!ct)},[ct,K]),rl=f.useCallback(()=>{_?$==="rgb"?T("error"):$==="error"?T("trackLength"):N(!1):(N(!0),T("rgb"))},[_,$,N,T]),ol=f.useCallback(()=>{ie?Ce==="frustum"?Re("arrow"):Ce==="arrow"?Re("imageplane"):we(!1):(we(!0),Re("frustum"))},[ie,Ce,we,Re]),sl=f.useCallback(()=>{it?St==="static"?sn("blink"):pn(!1):(pn(!0),sn("static"))},[it,St,pn,sn]),mg=f.useCallback(()=>{ae?Y==="static"?W("blink"):Y==="blink"?W("rainbow"):De(!1):(De(!0),W("static"))},[ae,Y,De,W]),pg=f.useCallback(()=>{Nt?qn==="static"?ar("blink"):dn(!1):(dn(!0),ar("static"))},[Nt,qn,dn,ar]),ki=f.useCallback(()=>{V("reset"),Xt("perspective")},[V,Xt]);kt(ze.resetView.keys,ki,{scopes:ze.resetView.scopes},[ki]),kt(ze.viewX.keys,()=>V("x"),{scopes:ze.viewX.scopes},[V]),kt(ze.viewY.keys,()=>V("y"),{scopes:ze.viewY.scopes},[V]),kt(ze.viewZ.keys,()=>V("z"),{scopes:ze.viewZ.scopes},[V]),kt(ze.viewNegX.keys,()=>V("-x"),{scopes:ze.viewNegX.scopes},[V]),kt(ze.viewNegY.keys,()=>V("-y"),{scopes:ze.viewNegY.scopes},[V]),kt(ze.viewNegZ.keys,()=>V("-z"),{scopes:ze.viewNegZ.scopes},[V]);const il=f.useCallback(()=>{Ze&&We?Ke(!1):Ze&&!We?($t(!1),Ke(!0)):!Ze&&We?Ke(!1):($t(!0),Ke(!0))},[Ze,We,$t,Ke]);kt(ze.toggleGrid.keys,il,{scopes:ze.toggleGrid.scopes},[il]),kt(ze.toggleCameraMode.keys,nl,{scopes:ze.toggleCameraMode.scopes},[nl]),kt(ze.toggleBackground.keys,tl,{scopes:ze.toggleBackground.scopes},[tl]),kt(ze.cyclePointSize.keys,rl,{scopes:ze.cyclePointSize.scopes},[rl]),kt(ze.cycleCameraDisplay.keys,ol,{scopes:ze.cycleCameraDisplay.scopes},[ol]),kt(ze.cycleMatchesDisplay.keys,sl,{scopes:ze.cycleMatchesDisplay.scopes},[sl]),kt(ze.toggleUndistortion.keys,Du,{scopes:ze.toggleUndistortion.scopes},[Du]);const Fu=f.useCallback(()=>{const U=Wi[Math.floor(Math.random()*Wi.length)];Ft.getState().addNotification("info",U,4e3)},[]),zu=f.useCallback(()=>{const U=Wi[Math.floor(Math.random()*Wi.length)];Ft.getState().addNotification("warning",U)},[]);kt(ze.showJoke.keys,Fu,{scopes:ze.showJoke.scopes,preventDefault:!0},[Fu]),kt(ze.showJokePersistent.keys,zu,{scopes:ze.showJokePersistent.scopes,preventDefault:!0},[zu]);const Ou=f.useCallback(()=>{pa.getState().resetGuide(),Ft.getState().addNotification("info","Guide tips reset",3e3)},[]);kt(ze.resetGuide.keys,Ou,{scopes:ze.resetGuide.scopes,preventDefault:!0},[Ou]);const $u=lt(U=>U.reset),Bu=lt(U=>U.pickingMode)!=="off";return kt("escape",$u,{enabled:Bu},[$u,Bu]),o.jsxs(o.Fragment,{children:[o.jsxs("div",{className:`${tt.container}${Bt?" idle-hideable":""}${h?" touch-control-panel":""}`,"data-testid":"viewer-controls",children:[o.jsx(Tn,{panelId:"view",activePanel:e,setActivePanel:t,icon:o.jsx(Uk,{className:"w-6 h-6"}),tooltip:"View options (R)",onClick:ki,panelTitle:"View",children:o.jsxs("div",{className:tt.panelContent,children:[o.jsxs("div",{className:"flex gap-1 mb-3",children:[o.jsx("button",{onClick:()=>Xt("perspective"),className:`${xt==="perspective"?tt.actionButtonPrimary:tt.actionButton} flex-1`,children:"Persp"}),o.jsx("button",{onClick:()=>Xt("orthographic"),className:`${xt==="orthographic"?tt.actionButtonPrimary:tt.actionButton} flex-1`,children:"Ortho"})]}),xt==="perspective"&&o.jsx(pt,{label:"FOV",value:Dn,min:10,max:120,step:.1,onChange:de,formatValue:U=>`${U.toFixed(1)}Â°`}),o.jsxs("div",{className:"flex gap-1 mb-1",children:[o.jsxs("button",{onClick:()=>V("x"),className:`${tt.actionButton} flex-1`,children:["+X ",o.jsx("span",{className:"text-ds-muted text-xs",children:"(1)"})]}),o.jsxs("button",{onClick:()=>V("y"),className:`${tt.actionButton} flex-1`,children:["+Y ",o.jsx("span",{className:"text-ds-muted text-xs",children:"(2)"})]}),o.jsxs("button",{onClick:()=>V("z"),className:`${tt.actionButton} flex-1`,children:["+Z ",o.jsx("span",{className:"text-ds-muted text-xs",children:"(3)"})]})]}),o.jsxs("div",{className:"flex gap-1 mb-3",children:[o.jsxs("button",{onClick:()=>V("-x"),className:`${tt.actionButton} flex-1`,children:["-X ",o.jsx("span",{className:"text-ds-muted text-xs",children:"(4)"})]}),o.jsxs("button",{onClick:()=>V("-y"),className:`${tt.actionButton} flex-1`,children:["-Y ",o.jsx("span",{className:"text-ds-muted text-xs",children:"(5)"})]}),o.jsxs("button",{onClick:()=>V("-z"),className:`${tt.actionButton} flex-1`,children:["-Z ",o.jsx("span",{className:"text-ds-muted text-xs",children:"(6)"})]})]}),o.jsx("div",{className:tt.actionGroup,children:o.jsxs("button",{onClick:ki,className:`${tt.actionButtonPrimary} flex-1`,children:["Reset View",o.jsx("span",{className:"text-ds-void/70 ml-2 text-xs",children:"(R)"})]})})]})}),o.jsx(Tn,{panelId:"axes",activePanel:e,setActivePanel:t,icon:o.jsx(_s,{icon:Ze&&We?o.jsx(zk,{className:"w-6 h-6"}):Ze?o.jsx(cu,{className:"w-6 h-6"}):We?o.jsx(lp,{className:"w-6 h-6"}):o.jsx(Fk,{className:"w-6 h-6"}),label:Ze&&We?"A+G":Ze?"AXS":We?"GRD":"OFF"}),tooltip:"Axes & Grid (G)",isActive:Ze||We,onClick:il,panelTitle:"Axes & Grid (G)",children:o.jsxs("div",{className:tt.panelContent,children:[o.jsx(br,{label:"Show Axes",checked:Ze,onChange:Dt}),o.jsx(br,{label:"Show Grid",checked:We,onChange:En}),o.jsx(Kt,{label:"System",value:qt,onChange:U=>yt(U),options:[{value:"colmap",label:"COLMAP"},{value:"opencv",label:"OpenCV"},{value:"threejs",label:"Three.js"},{value:"opengl",label:"OpenGL"},{value:"vulkan",label:"Vulkan"},{value:"blender",label:"Blender"},{value:"houdini",label:"Houdini"},{value:"unity",label:"Unity"},{value:"unreal",label:"Unreal"}]}),o.jsx(Kt,{label:"Labels",value:Pt,onChange:U=>se(U),options:[{value:"off",label:"Off"},{value:"xyz",label:"XYZ"},{value:"extra",label:"Extra"}]}),o.jsx(pt,{label:"Axes Scale",value:Math.log10(Et),min:-3,max:3,step:.1,onChange:U=>ut(Math.pow(10,U)),formatValue:U=>`10${Ff(U)}`}),o.jsx(pt,{label:"Grid Scale",value:Math.log10(Wt),min:-3,max:3,step:.1,onChange:U=>Pn(Math.pow(10,U)),formatValue:U=>`10${Ff(U)}`})]})}),o.jsx(Tn,{panelId:"camera",activePanel:e,setActivePanel:t,icon:o.jsx(_s,{icon:je==="orbit"?o.jsx(Hk,{className:"w-6 h-6"}):o.jsx(Wk,{className:"w-6 h-6"}),label:je==="orbit"?"ORB":"FLY"}),tooltip:je==="orbit"?"Orbit mode (C)":"Fly mode (C)",onClick:nl,panelTitle:"Camera Mode (C)",children:o.jsxs("div",{className:tt.panelContent,children:[o.jsx(Kt,{label:"Mode",value:je,onChange:U=>jt(U),options:[{value:"orbit",label:"Orbit"},{value:"fly",label:"Fly"}]}),o.jsx(pt,{label:"Speed",value:oe,min:.1,max:5,step:.1,onChange:ge,formatValue:U=>U.toFixed(1)}),o.jsx(pt,{label:"Goto Anim",value:Xe,min:0,max:2e3,step:100,onChange:dt,formatValue:U=>U===0?"Off":`${(U/1e3).toFixed(1)}s`}),o.jsxs("div",{className:tt.row,children:[o.jsx("label",{className:tt.label,children:"Pointer Lock"}),o.jsx("span",{className:"flex-1"}),o.jsx(ls,{checked:mt,onChange:Rt})]}),o.jsx(Kt,{label:"Horizon Lock",value:Me,onChange:U=>Fe(U),options:[{value:"off",label:"Off"},{value:"on",label:"On"},{value:"flip",label:"Flip"}]}),je==="orbit"&&o.jsxs(o.Fragment,{children:[o.jsx(Kt,{label:"Auto Rotate",value:_e,onChange:U=>et(U),options:[{value:"off",label:"Off"},{value:"cw",label:"Clockwise"},{value:"ccw",label:"Counter-CW"}]}),o.jsx(pt,{label:"Rotate Speed",value:Ve,min:.1,max:2,step:.1,onChange:nt,formatValue:U=>U.toFixed(1)})]}),o.jsxs("div",{className:tt.hint,children:[o.jsx("div",{className:"mb-1 font-medium",children:"Mouse:"}),je==="orbit"?o.jsxs(o.Fragment,{children:[o.jsx("div",{children:"Left drag: Rotate"}),o.jsx("div",{children:"Right/Mid drag: Pan"}),o.jsx("div",{children:"Scroll: Zoom"})]}):o.jsxs(o.Fragment,{children:[o.jsx("div",{children:"Left drag: Look around"}),o.jsx("div",{children:"Right/Mid drag: Strafe"}),o.jsx("div",{children:"Scroll: Move fwd/back"}),o.jsx("div",{children:"Shift+drag: Faster"})]}),o.jsx("div",{className:"mt-2 font-medium",children:"Keyboard:"}),o.jsx("div",{children:"WASD: Move"}),o.jsx("div",{children:"Q: Down, E/Space: Up"}),o.jsx("div",{children:"Shift: Speed boost"}),o.jsx("div",{className:"mt-2 font-medium",children:"Modifiers:"}),o.jsx("div",{children:"Alt+Scroll: Camera size"}),o.jsx("div",{children:"Ctrl+Scroll: Point size"})]})]})}),o.jsx(Tn,{panelId:"bg",activePanel:e,setActivePanel:t,icon:o.jsx(up,{className:"w-6 h-6"}),tooltip:"Background color (B)",onClick:tl,panelTitle:"Background Color (B)",children:o.jsxs("div",{className:tt.panelContent,children:[o.jsx(Pf,{label:"Color",value:gn,onChange:cg}),o.jsx(Nf,{label:"Hue",value:lr.h,onChange:ig}),o.jsx(pt,{label:"Saturation",value:lr.s,min:0,max:100,step:1,onChange:ag,formatValue:U=>`${Math.round(U)}%`}),o.jsx(pt,{label:"Lightness",value:lr.l,min:0,max:100,step:1,onChange:lg,formatValue:U=>`${Math.round(U)}%`})]})}),o.jsx(Rj,{styles:tt,activePanel:e,setActivePanel:t,onOpenFloorModal:()=>r(!0)}),o.jsx(Tn,{panelId:"points",activePanel:e,setActivePanel:t,icon:o.jsx(_s,{icon:_?$==="rgb"?o.jsx(cp,{className:"w-6 h-6"}):$==="error"?o.jsx($k,{className:"w-6 h-6"}):o.jsx(Bk,{className:"w-6 h-6"}):o.jsx(Ok,{className:"w-6 h-6"}),label:_?$==="rgb"?"RGB":$==="error"?"ERR":"TRK":"OFF"}),tooltip:_?$==="rgb"?"Point Cloud: RGB (P)":$==="error"?"Point Cloud: Error (P)":"Point Cloud: Track (P)":"Point Cloud: Off (P)",isActive:_,onClick:rl,panelTitle:"Point Cloud (P)",children:o.jsxs("div",{className:tt.panelContent,children:[o.jsx(br,{label:"Show Points",checked:_,onChange:D}),o.jsx(Kt,{label:"Color",value:$,onChange:U=>T(U),options:[{value:"rgb",label:"RGB"},{value:"error",label:"Error"},{value:"trackLength",label:"Track Length"}]}),o.jsx(pt,{label:o.jsxs(o.Fragment,{children:["Size ",o.jsxs("span",{className:"text-ds-muted text-xs inline-flex items-center gap-0.5",children:["(Ctrl+",o.jsx(Ef,{className:"w-3 h-3 inline"}),")"]})]}),value:B,min:1,max:10,step:.5,onChange:E}),o.jsx(pt,{label:"Opacity",value:Z,min:0,max:1,step:.05,onChange:F,formatValue:U=>`${Math.round(U*100)}%`}),o.jsx(pt,{label:"Min Track",value:z,min:0,max:20,step:1,onChange:U=>H(Math.round(U))}),o.jsx(pt,{label:"Thinning",value:re,min:0,max:99,step:1,onChange:U=>q(Math.round(U))}),o.jsx(pt,{label:"Max Error",value:O===null?vt?.globalStats.maxError??10:O,min:0,max:vt?.globalStats.maxError??10,step:.1,onChange:U=>J(U>=(vt?.globalStats.maxError??10)?null:U),formatValue:U=>O===null?"âˆž":U.toFixed(1)}),o.jsx("div",{className:tt.hint,children:$==="rgb"?o.jsxs(o.Fragment,{children:[o.jsx("div",{className:"mb-1 font-medium",children:"RGB Colors:"}),o.jsx("div",{children:"Original point colors from"}),o.jsx("div",{children:"the reconstruction."})]}):$==="error"?o.jsxs(o.Fragment,{children:[o.jsx("div",{className:"mb-1 font-medium",children:"Reprojection Error:"}),o.jsx("div",{children:"Blue = low error (accurate)"}),o.jsx("div",{children:"Red = high error (outliers)"})]}):o.jsxs(o.Fragment,{children:[o.jsx("div",{className:"mb-1 font-medium",children:"Track Length:"}),o.jsx("div",{children:"Dark = few observations"}),o.jsx("div",{children:"Bright = many observations"})]})})]})}),o.jsx(Tn,{panelId:"scale",activePanel:e,setActivePanel:t,icon:o.jsx(_s,{icon:ie?Ce==="frustum"?o.jsx(lu,{className:"w-6 h-6"}):Ce==="arrow"?o.jsx(Ek,{className:"w-6 h-6"}):o.jsx(Nk,{className:"w-6 h-6"}):o.jsx(Pk,{className:"w-6 h-6"}),label:ie?Ce==="frustum"?"FRM":Ce==="arrow"?"ARW":"IMG":"OFF"}),tooltip:ie?Ce==="frustum"?"Frustum mode (F)":Ce==="arrow"?"Arrow mode (F)":"Image plane mode (F)":"Cameras hidden (F)",isActive:ie,onClick:ol,panelTitle:"Camera Display (F)",children:o.jsxs("div",{className:tt.panelContent,children:[o.jsx(br,{label:"Show Cameras",checked:ie,onChange:we}),o.jsx(Kt,{label:"Mode",value:Ce,onChange:U=>Re(U),options:[{value:"frustum",label:"Frustum"},{value:"arrow",label:"Arrow"},{value:"imageplane",label:"Image Plane"}]}),ie&&o.jsxs(o.Fragment,{children:[o.jsx(Kt,{label:"Color",value:Ae,onChange:U=>ye(U),options:[{value:"single",label:"Single"},{value:"byCamera",label:"By Cam"},...Fn?[{value:"byRigFrame",label:"By Frame"}]:[]]}),Ae==="single"&&o.jsxs(o.Fragment,{children:[o.jsx(Pf,{label:"Frustum",value:Pe,onChange:hg}),o.jsx(Nf,{label:"Hue",value:Lr.h,onChange:ug}),o.jsx(pt,{label:"Saturation",value:Lr.s,min:0,max:100,step:1,onChange:dg,formatValue:U=>`${Math.round(U)}%`}),o.jsx(pt,{label:"Lightness",value:Lr.l,min:0,max:100,step:1,onChange:fg,formatValue:U=>`${Math.round(U)}%`})]}),o.jsx(Kt,{label:"Scale Ã—",value:ee,onChange:U=>he(U),options:[{value:"0.1",label:"0.1Ã—"},{value:"1",label:"1Ã—"},{value:"10",label:"10Ã—"}]}),o.jsx(pt,{label:o.jsxs(o.Fragment,{children:["Scale ",o.jsxs("span",{className:"text-ds-muted text-xs inline-flex items-center gap-0.5",children:["(Alt+",o.jsx(Ef,{className:"w-3 h-3 inline"}),")"]})]}),value:Se,min:.05,max:1,step:.05,onChange:xe,formatValue:U=>U.toFixed(2)}),o.jsx(pt,{label:"Standby Î±",value:$e,min:0,max:1,step:.05,onChange:qe,formatValue:U=>U.toFixed(2)}),o.jsx(pt,{label:"Selection Î±",value:Le,min:0,max:1,step:.05,onChange:fe,formatValue:U=>U.toFixed(2)}),o.jsx(pt,{label:"Unselected Î±",value:Je,min:0,max:1,step:.05,onChange:ke,formatValue:U=>U.toFixed(2)}),o.jsxs("div",{className:tt.row,children:[o.jsx("label",{className:tt.label,children:"Undistort (U)"}),o.jsx("span",{className:"flex-1"}),o.jsx(ls,{checked:ct,onChange:K})]}),o.jsxs("div",{className:tt.row,children:[o.jsx("label",{className:tt.label,children:"Auto FOV"}),o.jsx("span",{className:"flex-1"}),o.jsx(ls,{checked:He,onChange:Ht})]})]}),o.jsx("div",{className:tt.hint,children:Ce==="frustum"?o.jsxs(o.Fragment,{children:[o.jsx("div",{className:"mb-1 font-medium",children:"Frustum:"}),o.jsx("div",{children:"Full camera frustum"}),o.jsx("div",{children:"pyramid wireframes."})]}):Ce==="arrow"?o.jsxs(o.Fragment,{children:[o.jsx("div",{className:"mb-1 font-medium",children:"Arrow:"}),o.jsx("div",{children:"Simple arrow showing"}),o.jsx("div",{children:"camera look direction."})]}):o.jsxs(o.Fragment,{children:[o.jsx("div",{className:"mb-1 font-medium",children:"Image Plane:"}),o.jsx("div",{children:"Shows image textures"}),o.jsx("div",{children:"on camera planes."})]})})]})}),ie&&o.jsxs(o.Fragment,{children:[Ce!=="imageplane"&&o.jsx(Tn,{panelId:"matches",activePanel:e,setActivePanel:t,icon:it?St==="static"?o.jsx(ap,{className:"w-6 h-6"}):o.jsx(Lk,{className:"w-6 h-6"}):o.jsx(Ak,{className:"w-6 h-6"}),tooltip:it?St==="static"?"Matches static (M)":"Matches blink (M)":"Matches off (M)",isActive:it,onClick:sl,panelTitle:"Show Matches (M)",children:o.jsxs("div",{className:tt.panelContent,children:[o.jsx(br,{label:"Show Matches",checked:it,onChange:pn}),it&&o.jsx(Kt,{label:"Mode",value:St,onChange:U=>sn(U),options:[{value:"static",label:"Static"},{value:"blink",label:"Blink"}]}),it&&o.jsxs(o.Fragment,{children:[o.jsx(pt,{label:"Opacity",value:qr,min:.5,max:1,step:.05,onChange:Ge,formatValue:U=>U.toFixed(2)}),o.jsx(Ll,{label:"Color",value:ot,onChange:Ee})]}),o.jsx("div",{className:tt.hint,children:it?St==="static"?o.jsxs(o.Fragment,{children:[o.jsx("div",{className:"mb-1 font-medium",children:"Static:"}),o.jsx("div",{children:"Show match lines between"}),o.jsx("div",{children:"selected camera and points."})]}):o.jsxs(o.Fragment,{children:[o.jsx("div",{className:"mb-1 font-medium",children:"Blink:"}),o.jsx("div",{children:"Match lines animate with"}),o.jsx("div",{children:"blinking effect."})]}):o.jsxs(o.Fragment,{children:[o.jsx("div",{className:"mb-1 font-medium",children:"Off:"}),o.jsx("div",{children:"Match lines hidden."})]})})]})}),o.jsx(Tn,{panelId:"selectionColor",activePanel:e,setActivePanel:t,icon:ae?Y==="static"?o.jsx(Rk,{className:"w-6 h-6"}):Y==="blink"?o.jsx(Dk,{className:"w-6 h-6"}):o.jsx(_k,{className:"w-6 h-6"}):o.jsx(Tk,{className:"w-6 h-6"}),tooltip:ae?Y==="static"?"Static color":Y==="blink"?"Blink":"Rainbow":"Selection off",isActive:ae,onClick:mg,panelTitle:"Selection Highlight",children:o.jsxs("div",{className:tt.panelContent,children:[o.jsx(br,{label:"Show Highlight",checked:ae,onChange:De}),ae&&o.jsxs(o.Fragment,{children:[o.jsx(Kt,{label:"Mode",value:Y,onChange:U=>W(U),options:[{value:"static",label:"Static"},{value:"blink",label:"Blink"},{value:"rainbow",label:"Rainbow"}]}),(Y==="static"||Y==="blink")&&o.jsx(Ll,{label:"Color",value:le,onChange:Q}),(Y==="blink"||Y==="rainbow")&&o.jsx(pt,{label:"Speed",value:pe,min:.1,max:5,step:.1,onChange:Ne,formatValue:U=>U.toFixed(1)})]}),o.jsx("div",{className:tt.hint,children:Y==="static"?o.jsxs(o.Fragment,{children:[o.jsx("div",{className:"mb-1 font-medium",children:"Static:"}),o.jsx("div",{children:"Solid color highlight"}),o.jsx("div",{children:"for selected camera."})]}):Y==="blink"?o.jsxs(o.Fragment,{children:[o.jsx("div",{className:"mb-1 font-medium",children:"Blink:"}),o.jsx("div",{children:"Selected camera pulses"}),o.jsx("div",{children:"to draw attention."})]}):o.jsxs(o.Fragment,{children:[o.jsx("div",{className:"mb-1 font-medium",children:"Rainbow:"}),o.jsx("div",{children:"Selected camera cycles"}),o.jsx("div",{children:"through all colors."})]})})]})})]}),o.jsx(Tn,{panelId:"rig",activePanel:e,setActivePanel:t,icon:o.jsx(_s,{icon:!Nt||!Fn?o.jsx(Yk,{className:"w-6 h-6"}):qn==="blink"?o.jsx(Gk,{className:"w-6 h-6"}):o.jsx(dp,{className:"w-6 h-6"}),label:Fn?Nt?qn==="blink"?"BLK":"RIG":"OFF":"N/A"}),tooltip:Fn?Nt?qn==="blink"?"Rig blink":"Rig static":"Rig connections off":"Rig not available",isActive:Fn&&Nt,onClick:Fn?pg:void 0,panelTitle:"Rig Connections",disabled:!Fn,children:o.jsx("div",{className:tt.panelContent,children:Fn?o.jsxs(o.Fragment,{children:[o.jsx(br,{label:"Show Rig",checked:Nt,onChange:dn}),Nt&&o.jsx(Kt,{label:"Mode",value:qn,onChange:U=>ar(U),options:[{value:"static",label:"Static"},{value:"blink",label:"Blink"}]}),Nt&&o.jsxs(o.Fragment,{children:[o.jsx(Kt,{label:"Color",value:Xr,onChange:U=>Kr(U),options:[{value:"single",label:"Single"},{value:"perFrame",label:"Per Frame"}]}),Xr==="single"&&o.jsx(Ll,{label:"Hue",value:ho,onChange:mo}),o.jsx(pt,{label:"Opacity",value:Es,min:.1,max:1,step:.05,onChange:Ci,formatValue:U=>U.toFixed(2)})]}),o.jsxs("div",{className:tt.hint,children:[o.jsx("div",{className:"mb-1 font-medium",children:"Detected Rig:"}),o.jsxs("div",{children:[Lu," camera",Lu!==1?"s":"",", ",_u," frame",_u!==1?"s":""]}),o.jsx("div",{className:"mt-2",children:Nt?o.jsx("div",{children:"Lines connect cameras with"}):o.jsx("div",{children:"Connection lines hidden."})}),o.jsx("div",{children:"matching frame names"}),o.jsx("div",{children:"(e.g. cam_1/00.png, cam_2/00.png)"})]})]}):o.jsxs("div",{className:"text-ds-secondary text-sm",children:[o.jsx("div",{className:"mb-2 font-medium",children:"No Multi-Camera Data"}),o.jsx("div",{children:"To use this feature, images"}),o.jsx("div",{children:"need directory/filename format:"}),o.jsxs("div",{className:"mt-2 font-mono text-xs",children:[o.jsx("div",{children:"â€¢ cam_1/frame_00.png"}),o.jsx("div",{children:"â€¢ cam_2/frame_00.png"})]}),o.jsx("div",{className:"mt-2",children:"Images with same filename"}),o.jsx("div",{children:"are connected as a rig."})]})})}),o.jsx(RM,{activePanel:e,setActivePanel:t}),o.jsx(YM,{activePanel:e,setActivePanel:t}),o.jsx(GM,{activePanel:e,setActivePanel:t,onOpenDeletionModal:()=>i(!0),onOpenConversionModal:()=>l(!0)}),o.jsx(Tn,{panelId:"settings",activePanel:e,setActivePanel:t,icon:o.jsx(iu,{className:"w-6 h-6"}),tooltip:"Settings",panelTitle:"Settings",children:o.jsxs("div",{className:tt.panelContent,children:[o.jsx("div",{className:"text-ds-muted text-xs uppercase tracking-wide mb-2",children:"Profiles"}),o.jsx(qM,{}),o.jsx("div",{className:"text-ds-muted text-xs uppercase tracking-wide mt-4 mb-2",children:"Configuration"}),o.jsx("div",{className:tt.actionGroup,children:o.jsx("button",{onClick:()=>{const U=tp(),po=KS(U),go=new Blob([po],{type:"text/yaml"}),cr=URL.createObjectURL(go),Nn=document.createElement("a");Nn.href=cr,Nn.download="colmapview-config.yml",document.body.appendChild(Nn),Nn.click(),document.body.removeChild(Nn),URL.revokeObjectURL(cr)},className:tt.actionButton,children:"Export Config"})}),o.jsx("div",{className:tt.actionGroup,children:o.jsx("button",{onClick:()=>{confirm("Clear all settings and reload? This cannot be undone.")&&(localStorage.clear(),window.location.reload())},className:tt.actionButton,children:"Clear Settings"})}),o.jsx("div",{className:"text-ds-muted text-xs uppercase tracking-wide mt-4 mb-2",children:"Customization"}),o.jsx(pt,{label:"Auto-hide UI",value:be,min:0,max:10,step:1,onChange:bt,formatValue:U=>U===0?"Off":`${U}s`}),be>0&&o.jsx("div",{className:tt.actionGroup,children:o.jsx("button",{onClick:()=>{d(!0),t(null)},className:tt.actionButton,children:"Auto-hide 3D Elements"})}),o.jsx("div",{className:tt.actionGroup,children:o.jsx("button",{onClick:()=>{ne(),t(null)},className:tt.actionButton,children:"Edit Context Menu"})}),o.jsx("div",{className:"text-ds-muted text-xs uppercase tracking-wide mt-4 mb-2",children:"Developer"}),o.jsx("div",{className:tt.actionGroup,children:o.jsx("button",{onClick:()=>{const po=JSON.stringify({version:1,name:"NGS Lady Bug Toy",baseUrl:"https://huggingface.co/datasets/OpsiClear/NGS/resolve/main/objects/scan_20250714_170841_lady_bug_toy",files:{cameras:"sparse/0/cameras.bin",images:"sparse/0/images.bin",points3D:"sparse/0/points3D.bin",rigs:"sparse/0/rigs.bin",frames:"sparse/0/frames.bin"},imagesPath:"images/",masksPath:"masks/"},null,2),go=new Blob([po],{type:"application/json"}),cr=URL.createObjectURL(go),Nn=document.createElement("a");Nn.href=cr,Nn.download="manifest.json",document.body.appendChild(Nn),Nn.click(),document.body.removeChild(Nn),URL.revokeObjectURL(cr)},className:tt.actionButton,children:"Example manifest.json"})}),o.jsx("div",{className:"text-ds-secondary text-sm mt-1",children:"JSON file for loading COLMAP reconstructions from URLs."})]})}),o.jsx(Dj,{activePanel:e,setActivePanel:t})]}),o.jsx(cj,{isOpen:n,onClose:()=>r(!1)}),o.jsx(Aj,{isOpen:s,onClose:()=>i(!1)}),o.jsx(Pj,{isOpen:a,onClose:()=>l(!1)}),o.jsx(_j,{isOpen:c,onClose:()=>d(!1)})]})}function zf(e,t){const n=t.x-e.x,r=t.y-e.y;return Math.sqrt(n*n+r*r)}function Of(e,t){return{x:(e.x+t.x)/2,y:(e.y+t.y)/2}}function zj(e){return 1-Math.pow(1-e,3)}const $f={x:{offset:new X(1,0,0),up:new X(0,1,0)},y:{offset:new X(0,1,0),up:new X(0,0,-1)},z:{offset:new X(0,0,1),up:new X(0,1,0)},"-x":{offset:new X(-1,0,0),up:new X(0,1,0)},"-y":{offset:new X(0,-1,0),up:new X(0,0,1)},"-z":{offset:new X(0,0,-1),up:new X(0,1,0)}};function Oj({target:e,radius:t,resetTrigger:n,viewDirection:r,viewTrigger:s=0}){const{camera:i,gl:a,set:l,size:c}=mr(),d=me(de=>de.reconstruction),h=lt(de=>de.pickingMode),u=mn(de=>de.transform),m=Ga(),g=Xa(),p=Ka(),y=hu(),w=fu(),{mode:x,projection:v,fov:k,horizonLock:b,flySpeed:S,flyTransitionDuration:C,pointerLock:M,autoRotateMode:I,autoRotateSpeed:L,flyToImageId:P,flyToViewState:_}=m,N=g.coordinateSystem,D=f.useMemo(()=>{const de=Tf(N),Me=new X(...de);return b==="flip"&&Me.negate(),Me},[N,b]),B=f.useRef(!1),E=f.useRef(!1),Z=f.useRef(!1),F=f.useRef(new X(...e)),$=f.useRef(new Tt),T=f.useRef(5),z=f.useRef(5),H=f.useRef(n),O=f.useRef(s),J=f.useRef(v),re=f.useRef(1),q=f.useRef({x:0,y:0}),ie=f.useRef({x:0,y:0}),we=f.useRef({x:0,y:0}),Ce=f.useRef(0),Re=f.useRef(0),ee=f.useRef(new Tt),he=f.useRef(new Tt),Se=f.useRef(new Set),xe=f.useRef(new X),Ae=f.useRef(!1),ye=f.useRef(null),Pe=G(de=>de.touchMode),Ye=f.useRef(new Map),$e=f.useRef("none"),qe=f.useRef(0),ct=f.useRef(1),K=f.useRef({x:0,y:0}),Le=f.useRef(0),fe=f.useRef({x:0,y:0}),ae=f.useRef({x:0,y:0}),De=f.useRef(!1),Y=f.useRef(b);Y.current=b;const W=f.useRef(D);W.current=D;const le=f.useRef(!0),Q=f.useRef(!1),pe=kn.rotateSpeed,Ne=kn.panSpeed,Je=kn.zoomSpeed,ke=kn.damping,je=kn.minVelocity,jt=kn.flyDamping,oe=(de,Me)=>{if(!(Math.abs(de)<1e-10&&Math.abs(Me)<1e-10))if(Y.current!=="off"){const Fe=W.current.clone(),_e=new X(1,0,0).applyQuaternion($.current),Ve=new X(0,0,-1).applyQuaternion($.current).dot(Fe),nt=Math.asin(Math.max(-1,Math.min(1,-Ve))),He=Math.PI/2-.02,Ht=nt+Me,it=Ht>He?He-nt:Ht<-He?-He-nt:Me;he.current.setFromAxisAngle(Fe,-de),ee.current.setFromAxisAngle(_e,-it),$.current.premultiply(ee.current),$.current.premultiply(he.current),$.current.normalize()}else{const Fe=new X(1,0,0).applyQuaternion($.current),_e=new X(0,1,0).applyQuaternion($.current);he.current.setFromAxisAngle(_e,-de),ee.current.setFromAxisAngle(Fe,-Me),$.current.premultiply(ee.current),$.current.premultiply(he.current),$.current.normalize()}},ge=()=>{if(x==="orbit"){const de=new X(0,0,T.current);de.applyQuaternion($.current),i.position.copy(F.current).add(de),i.quaternion.copy($.current)}else i.quaternion.copy($.current)},Xe=f.useMemo(()=>{const de=Tf(N);return new X(...de)},[N]),dt=de=>{const Me=Se.current.has("shift")?kn.shiftSpeedBoost:1,Fe=t*kn.moveSpeedMultiplier*S*Me,_e=new X,et=new X(0,0,-1).applyQuaternion($.current),Ve=new X(1,0,0).applyQuaternion($.current),nt=Xe.clone();return Se.current.has("w")&&_e.add(et.clone().multiplyScalar(Fe)),Se.current.has("s")&&_e.add(et.clone().multiplyScalar(-Fe)),Se.current.has("a")&&_e.add(Ve.clone().multiplyScalar(-Fe)),Se.current.has("d")&&_e.add(Ve.clone().multiplyScalar(Fe)),(Se.current.has("e")||Se.current.has(" "))&&_e.add(nt.clone().multiplyScalar(Fe)),Se.current.has("q")&&_e.add(nt.clone().multiplyScalar(-Fe)),xe.current.add(_e),xe.current.multiplyScalar(de??jt),xe.current.length()>1e-4?(x==="fly"?i.position.add(xe.current):F.current.add(xe.current),!0):!1};pr(()=>{if(!le.current){q.current.x=0,q.current.y=0,xe.current.set(0,0,0),ye.current=null;return}if(ye.current){const Ve=ye.current,He=performance.now()-Ve.startTime,Ht=Math.min(He/Ve.duration,1),it=zj(Ht);i.position.lerpVectors(Ve.startPosition,Ve.endPosition,it),i.quaternion.slerpQuaternions(Ve.startQuaternion,Ve.endQuaternion,it),F.current.lerpVectors(Ve.startTarget,Ve.endTarget,it),T.current=Ve.startDistance+(Ve.endDistance-Ve.startDistance)*it,z.current=T.current,$.current.copy(i.quaternion),Ht>=1&&(ye.current=null);return}let de=!1;const Me=performance.now(),Fe=Math.min(Me-Re.current,100);Re.current=Me;const _e=Math.pow(ke,Fe/On.frameTimeMs),et=Math.pow(jt,Fe/On.frameTimeMs);if(x==="orbit"){if(Math.abs(z.current-T.current)>1e-4&&(T.current+=(z.current-T.current)*On.zoomTransitionFactor,de=!0),!B.current){const nt=q.current.x,He=q.current.y;if(Math.abs(nt)>je||Math.abs(He)>je)oe(nt,He),de=!0,q.current.x*=_e,q.current.y*=_e;else if(I!=="off"){const it=(I==="cw"?1:-1)*L*(Fe/1e3);he.current.setFromAxisAngle(W.current,it),$.current.premultiply(he.current),$.current.normalize(),de=!0}}dt(et)&&(de=!0),de&&ge()}else{let Ve=!1;if(!B.current){const nt=q.current.x,He=q.current.y;(Math.abs(nt)>je||Math.abs(He)>je)&&(oe(nt,He),Ve=!0,q.current.x*=_e,q.current.y*=_e)}dt(et),Ve&&i.quaternion.copy($.current)}}),f.useEffect(()=>{F.current.set(...e);const de=n!==H.current;if(H.current=n,de||T.current===5){T.current=Math.max(kn.minDistance,t*On.initialDistanceMultiplier),z.current=T.current;const Me=Math.SQRT1_2;let Fe,_e;if(Y.current!=="off"){const nt=W.current.clone();Fe=new X(-.5,-Me*nt.y,-.5).normalize().multiplyScalar(T.current),_e=nt}else Fe=new X(-.5,-Me,-.5).normalize().multiplyScalar(T.current),_e=new X(.5,-Me,.5).normalize();const et=F.current.clone().add(Fe),Ve=new jo;Ve.lookAt(et,F.current,_e),$.current.setFromRotationMatrix(Ve),i.position.copy(et),i.quaternion.copy($.current),q.current.x=0,q.current.y=0,xe.current.set(0,0,0)}},[e[0],e[1],e[2],t,n,i]),f.useEffect(()=>{const de=s!==O.current;if(O.current=s,!de||!r)return;F.current.set(...e),T.current=Math.max(kn.minDistance,t*On.initialDistanceMultiplier),z.current=T.current;let Me,Fe;if(r!=="reset"&&$f[r]){const Ve=$f[r];if(Y.current!=="off"){const nt=W.current.clone();r==="y"?(Me=nt.clone().multiplyScalar(T.current),Fe=new X(0,0,-1)):(Me=Ve.offset.clone().multiplyScalar(T.current),Fe=nt.clone())}else Me=Ve.offset.clone().multiplyScalar(T.current),Fe=Ve.up.clone()}else{const Ve=Math.SQRT1_2;if(Y.current!=="off"){const nt=W.current.clone();Me=new X(-.5,-Ve*nt.y,-.5).normalize().multiplyScalar(T.current),Fe=nt.clone()}else Me=new X(-.5,-Ve,-.5).normalize().multiplyScalar(T.current),Fe=new X(.5,-Ve,.5).normalize()}const _e=F.current.clone().add(Me),et=new jo;et.lookAt(_e,F.current,Fe),$.current.setFromRotationMatrix(et),i.position.copy(_e),i.quaternion.copy($.current),q.current.x=0,q.current.y=0,xe.current.set(0,0,0)},[e[0],e[1],e[2],t,s,r,i]),f.useEffect(()=>{if(v===J.current)return;J.current=v;const de=c.width/c.height,Me=i.position.clone(),Fe=i.quaternion.clone();if(v==="orthographic"){const _e=T.current;re.current=1;const et=On.farPlane*10,Ve=new Ii(-_e*de,_e*de,_e,-_e,-et,et);Ve.position.copy(Me),Ve.quaternion.copy(Fe),l({camera:Ve})}else{const _e=new Hu(k,de,On.nearPlane,On.farPlane);_e.position.copy(Me),_e.quaternion.copy(Fe),l({camera:_e})}$.current.copy(Fe)},[v,i,l,c.width,c.height]),f.useEffect(()=>{i instanceof Hu&&(i.fov=k,i.updateProjectionMatrix())},[k,i]);const mt=f.useRef(b);f.useEffect(()=>{const de=mt.current!==b;if(mt.current=b,!de)return;T.current=Math.max(kn.minDistance,t*On.initialDistanceMultiplier),z.current=T.current;const Me=Math.SQRT1_2;let Fe,_e;if(b!=="off"){const nt=D.clone();Fe=new X(-.5,-Me*nt.y,-.5).normalize().multiplyScalar(T.current),_e=nt}else Fe=new X(-.5,-Me,-.5).normalize().multiplyScalar(T.current),_e=new X(.5,-Me,.5).normalize();const et=F.current.clone().add(Fe),Ve=new jo;Ve.lookAt(et,F.current,_e),$.current.setFromRotationMatrix(Ve),i.position.copy(et),i.quaternion.copy($.current),q.current.x=0,q.current.y=0,xe.current.set(0,0,0)},[b,i,D,t]),f.useEffect(()=>{if(P===null||!d)return;const de=d.images.get(P);if(!de){p.clearFlyTo();return}const{position:Me,quaternion:Fe}=t0(de),_e=Hr(u),et=Me.clone().applyQuaternion(_e.rotation).multiplyScalar(_e.scale).add(_e.translation),Ve=_e.rotation.clone().multiply(Fe),nt=new Tt().setFromAxisAngle(new X(1,0,0),Math.PI);let He=Ve.clone().multiply(nt);if(b!=="off"){const pn=new X(0,0,-1).applyQuaternion(He),St=et.clone().add(pn),sn=new jo;sn.lookAt(et,St,D),He=new Tt().setFromRotationMatrix(sn)}const Ht=new X(0,0,-1).applyQuaternion(He),it=et.clone().add(Ht.multiplyScalar(T.current));q.current.x=0,q.current.y=0,xe.current.set(0,0,0),C>0?ye.current={startPosition:i.position.clone(),startQuaternion:i.quaternion.clone(),startTarget:F.current.clone(),startDistance:T.current,endPosition:et.clone(),endQuaternion:He.clone(),endTarget:it.clone(),endDistance:T.current,startTime:performance.now(),duration:C}:(F.current.copy(it),$.current.copy(He),z.current=T.current,i.position.copy(et),i.quaternion.copy(He)),p.clearFlyTo()},[P,d,p,i,u,b,D,C]),f.useEffect(()=>{if(_){if(q.current.x=0,q.current.y=0,xe.current.set(0,0,0),C>0){const de=new X(..._.target),Me=new X(..._.position),Fe=new Tt(..._.quaternion);ye.current={startPosition:i.position.clone(),startQuaternion:i.quaternion.clone(),startTarget:F.current.clone(),startDistance:T.current,endPosition:Me,endQuaternion:Fe,endTarget:de,endDistance:_.distance,startTime:performance.now(),duration:C}}else F.current.set(..._.target),$.current.set(..._.quaternion),T.current=_.distance,z.current=_.distance,i.position.set(..._.position),i.quaternion.set(..._.quaternion);p.clearFlyToViewState()}},[_,p,i,C]),f.useEffect(()=>{if(x==="fly")$.current.copy(i.quaternion),xe.current.set(0,0,0),Se.current.clear();else{const de=new X(0,0,-1).applyQuaternion(i.quaternion);T.current=Math.max(kn.minDistance,T.current),z.current=T.current,F.current.copy(i.position).add(de.multiplyScalar(T.current)),$.current.copy(i.quaternion)}q.current.x=0,q.current.y=0},[x,i]);const Rt=()=>({position:[i.position.x,i.position.y,i.position.z],quaternion:[$.current.x,$.current.y,$.current.z,$.current.w],target:[F.current.x,F.current.y,F.current.z],distance:T.current});f.useEffect(()=>(l({controls:{enabled:le,dragging:Q,wheelHandled:Ae,getCurrentViewState:Rt}}),()=>l({controls:void 0})),[l,i]);const xt=f.useRef(!1);f.useEffect(()=>{if(xt.current||!d)return;const de=window.location.hash;de&&HM(de).then(Me=>{!Me||xt.current||(xt.current=!0,F.current.set(...Me.target),$.current.set(...Me.quaternion),T.current=Me.distance,z.current=Me.distance,i.position.set(...Me.position),i.quaternion.set(...Me.quaternion),console.log("[URL State] Restored camera state from URL hash"))})},[d,i]);const Xt=f.useRef(null),Dn=f.useRef("");return f.useEffect(()=>{const de=()=>{const Fe=Rt(),_e=`${Fe.position.join(",")},${Fe.target.join(",")},${Fe.quaternion.join(",")}`;_e!==Dn.current&&(Dn.current=_e,p.setCurrentViewState(Fe))};de();const Me=setInterval(de,500);return()=>{clearInterval(Me),Xt.current&&clearTimeout(Xt.current)}},[i,p]),f.useEffect(()=>{const de=a.domElement,Me=Ge=>{if(Pe&&Ge.pointerType==="touch")return;const ot=Ge.button;we.current={x:Ge.clientX,y:Ge.clientY},Ce.current=performance.now(),Promise.resolve().then(()=>{le.current&&(ye.current=null,ot===0?(B.current=!0,Q.current=!0,q.current.x=0,q.current.y=0,ie.current.x=0,ie.current.y=0,Z.current=!1):(ot===2||ot===1)&&(E.current=!0,Q.current=!0,I!=="off"&&p.setAutoRotateMode("off")))})},Fe=()=>{if(!B.current&&!E.current)return;if(Q.current=!1,!le.current){q.current.x=0,q.current.y=0,B.current=!1,E.current=!1,Z.current=!1;return}performance.now()-Ce.current>50?(q.current.x=0,q.current.y=0):(oe(q.current.x,q.current.y),ge()),B.current=!1,E.current=!1,Z.current=!1,document.pointerLockElement===de&&document.exitPointerLock()},_e=()=>{document.pointerLockElement!==de&&B.current&&(q.current.x=0,q.current.y=0,ie.current.x=0,ie.current.y=0,B.current=!1,E.current=!1,Q.current=!1,Z.current=!1)},et=Ge=>{if(!le.current){(B.current||E.current)&&(q.current.x=0,q.current.y=0,B.current=!1,E.current=!1,Q.current=!1);return}const ot=performance.now(),Ee=document.pointerLockElement===de,Ze=Ee?Ge.movementX:Ge.clientX-we.current.x,$t=Ee?Ge.movementY:Ge.clientY-we.current.y;if(we.current={x:Ge.clientX,y:Ge.clientY},Ce.current=ot,B.current){(Ze!==0||$t!==0)&&p.clearNavigationHistory(),M&&h==="off"&&!Z.current&&!Ee&&(Z.current=!0,de.requestPointerLock());const Dt=50,qt=Math.max(-Dt,Math.min(Dt,Ze)),yt=Math.max(-Dt,Math.min(Dt,$t)),Et=qt*pe,ut=yt*pe;oe(Et,ut),ge();const Pt=On.velocitySmoothingFactor;ie.current.x=ie.current.x*Pt+Et*(1-Pt),ie.current.y=ie.current.y*Pt+ut*(1-Pt),q.current.x=ie.current.x,q.current.y=ie.current.y}if(E.current){(Ze!==0||$t!==0)&&p.clearNavigationHistory();const Dt=new X(1,0,0).applyQuaternion($.current),qt=new X(0,1,0).applyQuaternion($.current);if(x==="orbit"){const yt=T.current*Ne,Et=new X().addScaledVector(Dt,-Ze*yt).addScaledVector(qt,$t*yt);F.current.add(Et),ge()}else{const yt=Ge.shiftKey?kn.shiftSpeedBoost:1,Et=t*Ne*S*yt,ut=new X().addScaledVector(Dt,-Ze*Et).addScaledVector(qt,$t*Et);i.position.add(ut)}}},Ve=Ge=>{if(Ge.defaultPrevented||Ae.current){Ae.current=!1;return}if(Ge.preventDefault(),!!le.current){if(Ge.altKey){const ot=ce.getState().cameraScale,Ee=Ge.deltaY>0?.9:1.1,Ze=Math.max(.01,Math.min(10,ot*Ee));y.setScale(Ze);return}if(Ge.ctrlKey){const ot=Vt.getState().pointSize,Ee=Ge.deltaY>0?.9:1.1,Ze=Math.max(.1,Math.min(50,ot*Ee));w.setSize(Ze);return}if(p.clearNavigationHistory(),ye.current=null,x==="fly"){const ot=new X(0,0,-1).applyQuaternion($.current),Ee=-Ge.deltaY*t*kn.wheelMoveMultiplier*S;i.position.add(ot.multiplyScalar(Ee))}else if(i instanceof Ii){const ot=1+Ge.deltaY*Je;re.current=Math.max(.1,Math.min(10,re.current/ot)),i.zoom=re.current,i.updateProjectionMatrix()}else{const ot=1+Ge.deltaY*Je;z.current=Math.max(kn.minDistance,z.current*ot)}}},nt=Ge=>{Ge.preventDefault()},He=Ge=>{if(!le.current||Ge.ctrlKey||Ge.metaKey)return;const ot=Ge.key.toLowerCase();["w","a","s","d","q","e"," ","shift","arrowup","arrowdown","arrowleft","arrowright"].includes(ot)&&Ge.target?.tagName!=="INPUT"&&Ge.target?.tagName!=="TEXTAREA"&&(Ge.preventDefault(),Se.current.add(ot),ot!=="shift"&&(p.clearNavigationHistory(),ye.current=null))},Ht=Ge=>{const ot=Ge.key.toLowerCase();Se.current.delete(ot)},it=()=>{Se.current.clear()},pn=Ge=>{if(!Pe||!le.current)return;for(const Ee of Array.from(Ge.changedTouches))Ye.current.set(Ee.identifier,{id:Ee.identifier,x:Ee.clientX,y:Ee.clientY,startX:Ee.clientX,startY:Ee.clientY});const ot=Ye.current.size;if(ot===1){const Ee=Array.from(Ye.current.values())[0],Ze=performance.now(),$t=Ee.x-fe.current.x,Dt=Ee.y-fe.current.y,yt=Math.sqrt($t*$t+Dt*Dt)<30;if(Ze-Le.current<It.doubleTapDelay&&yt){G.getState().resetView(),Le.current=0,fe.current={x:0,y:0},Ye.current.clear(),$e.current="none";return}Le.current=Ze,fe.current={x:Ee.x,y:Ee.y},$e.current="drag",B.current=!0,Q.current=!0,De.current=!1,q.current.x=0,q.current.y=0,ie.current.x=0,ie.current.y=0,ae.current={x:Ee.x,y:Ee.y},we.current={x:Ee.x,y:Ee.y},Ce.current=performance.now(),ye.current=null}else if(ot===2){const Ee=Array.from(Ye.current.values());qe.current=zf(Ee[0],Ee[1]),ct.current=i instanceof Ii?re.current:z.current,K.current=Of(Ee[0],Ee[1]),$e.current="pinch",B.current=!1,E.current=!0,Q.current=!0}},St=Ge=>{if(!Pe||!le.current)return;for(const Ee of Array.from(Ge.changedTouches)){const Ze=Ye.current.get(Ee.identifier);Ze&&(Ze.x=Ee.clientX,Ze.y=Ee.clientY)}const ot=Ye.current.size;if(ot===1&&$e.current==="drag"){const Ee=Array.from(Ye.current.values())[0];if(!De.current){const Et=Ee.x-ae.current.x,ut=Ee.y-ae.current.y;if(Math.sqrt(Et*Et+ut*ut)<It.dragThreshold)return;De.current=!0,we.current={x:Ee.x,y:Ee.y}}const Ze=Ee.x-we.current.x,$t=Ee.y-we.current.y;(Ze!==0||$t!==0)&&p.clearNavigationHistory();const Dt=Ze*pe*It.orbitSensitivity,qt=$t*pe*It.orbitSensitivity;oe(Dt,qt),ge();const yt=On.velocitySmoothingFactor;ie.current.x=ie.current.x*yt+Dt*(1-yt),ie.current.y=ie.current.y*yt+qt*(1-yt),q.current.x=ie.current.x,q.current.y=ie.current.y,we.current={x:Ee.x,y:Ee.y},Ce.current=performance.now()}else if(ot===2&&($e.current==="pinch"||$e.current==="pan")){const Ee=Array.from(Ye.current.values()),Ze=zf(Ee[0],Ee[1]),$t=Of(Ee[0],Ee[1]);if(qe.current>0){const yt=qe.current/Ze;if(Math.abs(1-yt)>It.pinchThreshold)if(i instanceof Ii)re.current=Math.max(.1,Math.min(10,ct.current*yt)),i.zoom=re.current,i.updateProjectionMatrix();else if(x==="fly"){const ut=new X(0,0,-1).applyQuaternion($.current),Pt=(1-yt)*t*S*It.zoomSensitivity;i.position.add(ut.multiplyScalar(Pt))}else z.current=Math.max(kn.minDistance,ct.current*yt)}const Dt=$t.x-K.current.x,qt=$t.y-K.current.y;if(Dt!==0||qt!==0){p.clearNavigationHistory();const yt=new X(1,0,0).applyQuaternion($.current),Et=new X(0,1,0).applyQuaternion($.current);if(x==="orbit"){const ut=T.current*Ne*It.panSensitivity,Pt=new X().addScaledVector(yt,-Dt*ut).addScaledVector(Et,qt*ut);F.current.add(Pt),ge()}else{const ut=t*Ne*S*It.panSensitivity,Pt=new X().addScaledVector(yt,-Dt*ut).addScaledVector(Et,qt*ut);i.position.add(Pt)}}K.current=$t}},sn=Ge=>{if(!Pe)return;for(const Ee of Array.from(Ge.changedTouches))Ye.current.delete(Ee.identifier);const ot=Ye.current.size;if(ot===0)Q.current=!1,$e.current==="drag"&&performance.now()-Ce.current>50&&(q.current.x=0,q.current.y=0),B.current=!1,E.current=!1,$e.current="none",qe.current=0;else if(ot===1){$e.current="drag",B.current=!0,E.current=!1;const Ee=Array.from(Ye.current.values())[0];we.current={x:Ee.x,y:Ee.y},q.current.x=0,q.current.y=0,ie.current.x=0,ie.current.y=0}},qr=Ge=>{sn(Ge)};return de.addEventListener("pointerdown",Me),document.addEventListener("pointerup",Fe),document.addEventListener("pointermove",et),de.addEventListener("wheel",Ve,{passive:!1}),de.addEventListener("contextmenu",nt),document.addEventListener("pointerlockchange",_e),window.addEventListener("keydown",He),window.addEventListener("keyup",Ht),window.addEventListener("blur",it),Pe&&(de.addEventListener("touchstart",pn,{passive:!0}),de.addEventListener("touchmove",St,{passive:!0}),de.addEventListener("touchend",sn,{passive:!0}),de.addEventListener("touchcancel",qr,{passive:!0})),()=>{de.removeEventListener("pointerdown",Me),document.removeEventListener("pointerup",Fe),document.removeEventListener("pointermove",et),de.removeEventListener("wheel",Ve),de.removeEventListener("contextmenu",nt),document.removeEventListener("pointerlockchange",_e),window.removeEventListener("keydown",He),window.removeEventListener("keyup",Ht),window.removeEventListener("blur",it),de.removeEventListener("touchstart",pn),de.removeEventListener("touchmove",St),de.removeEventListener("touchend",sn),de.removeEventListener("touchcancel",qr)}},[i,a,x,S,M,h,t,I,p,y,w,Pe]),null}function Aa({mousePos:e,title:t,titleStyle:n,subtitle:r,children:s}){return o.jsx(Gr,{style:{position:"fixed",left:e.x+rn.cursorOffset,top:e.y+rn.cursorOffset,pointerEvents:"none",transform:"none"},calculatePosition:()=>[0,0],children:o.jsxs("div",{className:ve.container,children:[o.jsx("div",{className:ve.title,style:n,children:t}),r&&o.jsx("div",{className:ve.subtitle,children:r}),s]})})}function Bf(e){const t=new X(...e).normalize(),n=new X(0,1,0);if(Math.abs(t.y)>.999)return new or(0,0,t.y>0?0:Math.PI);const r=new Tt;return r.setFromUnitVectors(n,t),new or().setFromQuaternion(r)}function Uf(e,t){return[e[0]*t/2,e[1]*t/2,e[2]*t/2]}const $j=Zl.negativeAxis,yc={colmap:"COLMAP",opencv:"OpenCV",threejs:"Three.js",opengl:"OpenGL",vulkan:"Vulkan",blender:"Blender",houdini:"Houdini",unity:"Unity",unreal:"Unreal"},Bj=["colmap","opencv","threejs","opengl","vulkan","blender","houdini","unity","unreal"],Uj=[{value:"off",label:"Off"},{value:"xyz",label:"XYZ"},{value:"extra",label:"Extra"}],Up="w-4 h-4 text-ds-accent",Hj=f.memo(function({position:t,currentLabelMode:n,onClose:r}){const s=f.useRef(null),i=Qa(),a=i.setLabelMode,l=i.setVisible;Ya(s,r);const c=f.useCallback(h=>{a(h),r()},[a,r]),d=f.useCallback(()=>{l(!1),r()},[l,r]);return o.jsx(Gr,{style:{position:"fixed",left:t.x,top:t.y,pointerEvents:"auto"},calculatePosition:()=>[0,0],children:o.jsxs("div",{ref:s,className:Lt.container,children:[Uj.map(h=>o.jsxs("button",{className:Lt.button,onClick:()=>c(h.value),children:[n===h.value?o.jsx(No,{className:Up}):o.jsx("span",{className:"w-4"}),h.label]},h.value)),o.jsx("div",{className:"border-t border-ds my-1"}),o.jsxs("button",{className:Lt.button,onClick:d,children:[o.jsx(ck,{className:Lt.icon}),"Hide"]})]})})}),Wj=f.memo(function({position:t,currentSystem:n,onClose:r}){const s=f.useRef(null),a=Qa().setCoordinateSystem;Ya(s,r);const l=f.useCallback(c=>{a(c),r()},[a,r]);return o.jsx(Gr,{style:{position:"fixed",left:t.x,top:t.y,pointerEvents:"auto"},calculatePosition:()=>[0,0],children:o.jsx("div",{ref:s,className:Lt.container,children:Bj.map(c=>o.jsxs("button",{className:Lt.button,onClick:()=>l(c),children:[n===c?o.jsx(No,{className:Up}):o.jsx("span",{className:"w-4"}),yc[c]]},c))})})}),Hf=f.memo(function({position:t,rotation:n,radius:r,length:s,color:i,isHovered:a,onPointerOver:l,onPointerMove:c,onPointerOut:d,onClick:h,onContextMenu:u}){const m=a?1.5:1;return o.jsxs("mesh",{position:t,rotation:n,scale:[m,1,m],onPointerOver:l,onPointerMove:c,onPointerOut:d,onClick:h,onContextMenu:u,children:[o.jsx("cylinderGeometry",{args:[r,r,s,8]}),o.jsx("meshBasicMaterial",{color:a?oo:i})]})}),Vj=f.memo(function({position:t,label:n,suffix:r,scaleStr:s,showExtra:i,isXAxis:a,color:l,fontSize:c,isHovered:d,onPointerOver:h,onPointerMove:u,onPointerOut:m,onClick:g,onContextMenu:p}){const y=i&&r,w=d?oo:l,x=d?1.2:1;return o.jsx(sh,{position:t,follow:!0,children:o.jsxs("group",{scale:[x,x,x],onPointerOver:h,onPointerMove:u,onPointerOut:m,onClick:g,onContextMenu:p,children:[o.jsx(Us,{fontSize:c,color:w,anchorX:a&&i||y?"right":"center",anchorY:"middle",outlineWidth:c*.08,outlineColor:so.outline,outlineOpacity:.5,children:n}),a&&i&&o.jsxs(Us,{fontSize:c*.6,color:w,anchorX:"left",anchorY:"middle",position:[c*.15,0,0],outlineWidth:c*.05,outlineColor:so.outline,outlineOpacity:.5,children:["(",s,")"]}),y&&o.jsxs(Us,{fontSize:c*.6,color:w,anchorX:"left",anchorY:"middle",position:[c*.15,0,0],outlineWidth:c*.05,outlineColor:so.outline,outlineOpacity:.5,children:["(",r,")"]})]})})});function Zj({size:e,scale:t=1,coordinateSystem:n="colmap",labelMode:r="extra"}){const s=e*.5,i=e*.005,a=s*.4,l=Ja[n],{controls:c}=mr(),d=()=>c?.dragging?.current??!1,[h,u]=f.useState(null),[m,g]=f.useState(null),[p,y]=f.useState(null),[w,x]=f.useState(null),v=f.useCallback(Z=>F=>{d()||(u(Z),g({x:F.nativeEvent.clientX,y:F.nativeEvent.clientY}),document.body.style.cursor="pointer")},[]),k=f.useCallback(Z=>{if(d()){u(F=>(F&&(g(null),document.body.style.cursor=""),null));return}u(F=>(F&&g({x:Z.nativeEvent.clientX,y:Z.nativeEvent.clientY}),F))},[]),b=f.useCallback(()=>{u(null),g(null),document.body.style.cursor=""},[]),S=f.useCallback(Z=>{Z.stopPropagation(),x(null),y({x:Z.nativeEvent.clientX,y:Z.nativeEvent.clientY})},[]),C=f.useCallback(Z=>{Z.stopPropagation(),Z.nativeEvent.stopPropagation(),Z.nativeEvent.preventDefault(),y(null),x({x:Z.nativeEvent.clientX,y:Z.nativeEvent.clientY})},[]),M=f.useCallback(()=>{y(null)},[]),I=f.useCallback(()=>{x(null)},[]),L=r!=="off",P=r==="extra",_=t.toPrecision(3),N=f.useMemo(()=>[{direction:l.y,color:st.axis.y,label:"Y",suffix:zp[n].Y},{direction:l.x,color:st.axis.x,label:"X"},{direction:l.z,color:st.axis.z,label:"Z",suffix:yc[n]}],[l,n]),D=f.useMemo(()=>N.map(Z=>({direction:[-Z.direction[0],-Z.direction[1],-Z.direction[2]]})),[N]),B=s*1.15,E=e*.08;return o.jsxs("group",{children:[N.map((Z,F)=>{const $=`pos-${F}`,T=Bf(Z.direction),z=Uf(Z.direction,s);return o.jsx(Hf,{position:z,rotation:T,radius:i,length:s,color:Z.color,isHovered:h===$,onPointerOver:v($),onPointerMove:k,onPointerOut:b,onClick:S,onContextMenu:C},$)}),D.map((Z,F)=>{const $=`neg-${F}`,T=D[F],z=Bf(T.direction),H=Uf(T.direction,a);return o.jsx(Hf,{position:H,rotation:z,radius:i*.7,length:a,color:$j,isHovered:h===$,onPointerOver:v($),onPointerMove:k,onPointerOut:b,onClick:S,onContextMenu:C},$)}),L&&N.map((Z,F)=>{const $=`label-${F}`,T=[Z.direction[0]*B,Z.direction[1]*B,Z.direction[2]*B];return o.jsx(Vj,{position:T,label:Z.label,suffix:"suffix"in Z?Z.suffix:void 0,scaleStr:_,showExtra:P,isXAxis:F===1,color:Z.color,fontSize:E,isHovered:h===$,onPointerOver:v($),onPointerMove:k,onPointerOut:b,onClick:S,onContextMenu:C},$)}),h&&m&&!p&&!w&&o.jsx(Aa,{mousePos:m,title:"Origin Axes",subtitle:yc[n],children:o.jsxs("div",{className:ve.hint,children:[o.jsxs("div",{className:ve.hintRow,children:[o.jsxs("svg",{className:_t.hoverCard,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[o.jsx("rect",{x:"6",y:"2",width:"12",height:"20",rx:"6"}),o.jsx("path",{d:"M12 2v8"}),o.jsx("rect",{x:"6",y:"2",width:"6",height:"8",rx:"3",fill:"currentColor",opacity:"0.5"})]}),"Left: labels"]}),o.jsxs("div",{className:ve.hintRow,children:[o.jsxs("svg",{className:_t.hoverCard,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[o.jsx("rect",{x:"6",y:"2",width:"12",height:"20",rx:"6"}),o.jsx("path",{d:"M12 2v8"}),o.jsx("rect",{x:"12",y:"2",width:"6",height:"8",rx:"3",fill:"currentColor",opacity:"0.5"})]}),"Right: coord system"]})]})}),p&&o.jsx(Hj,{position:p,currentLabelMode:r,onClose:M}),w&&o.jsx(Wj,{position:w,currentSystem:n,onClose:I})]})}function Yj({size:e,scale:t=1}){const n=f.useRef(null),r=e*.1*t,s=f.useMemo(()=>new ui({transparent:!0,side:ao,depthWrite:!1,uniforms:{uGridScale:{value:r},uColor1:{value:new Er(Zl.majorLines)},uColor2:{value:new Er(Zl.minorLines)}},vertexShader:`
        varying vec3 vWorldPos;
        void main() {
          vec4 worldPos = modelMatrix * vec4(position, 1.0);
          vWorldPos = worldPos.xyz;
          gl_Position = projectionMatrix * viewMatrix * worldPos;
        }
      `,fragmentShader:`
        uniform float uGridScale;
        uniform vec3 uColor1;
        uniform vec3 uColor2;
        varying vec3 vWorldPos;

        // Robust grid line calculation - compute derivative on raw position for stability
        float getGrid(vec2 pos, float scale, float lineWidth) {
          vec2 coord = pos / scale;
          vec2 grid = abs(fract(coord - 0.5) - 0.5);
          // Compute derivative on raw world position, then scale
          // This avoids precision issues from fwidth on large scaled coordinates
          vec2 deriv = fwidth(pos) / scale;
          // Clamp derivatives to avoid precision issues at grazing angles and orthographic view
          deriv = clamp(deriv, vec2(0.001), vec2(0.5));
          vec2 lines = smoothstep(deriv * lineWidth, vec2(0.0), grid);
          return max(lines.x, lines.y);
        }

        void main() {
          // Major grid lines (every 10 units)
          float majorGrid = getGrid(vWorldPos.xz, uGridScale * 10.0, 1.5);
          // Minor grid lines (every 1 unit)
          float minorGrid = getGrid(vWorldPos.xz, uGridScale, 1.0);

          // Fade based on distance from origin
          float dist = length(vWorldPos.xz);
          float fade = 1.0 - smoothstep(uGridScale * 50.0, uGridScale * 100.0, dist);

          // Combine grids - only show actual grid lines, no fill
          vec3 color = mix(uColor2, uColor1, majorGrid);
          float alpha = max(majorGrid * 0.8, minorGrid * 0.3) * fade;

          // Discard pixels that aren't on grid lines
          if (alpha < 0.05) discard;
          gl_FragColor = vec4(color, alpha);
        }
      `}),[r]);return f.useEffect(()=>{s.uniforms.uGridScale.value=r},[s,r]),o.jsx("mesh",{ref:n,rotation:[-Math.PI/2,0,0],material:s,children:o.jsx("planeGeometry",{args:[1e4,1e4]})})}const to={x:st.axis.x,y:st.axis.y,z:st.axis.z,hover:oo},La={arc:.6,arcHover:.9,axis:.8,axisHover:1};function Rl({axis:e,color:t,radius:n,isHovered:r,onPointerDown:s,onPointerOver:i,onPointerMove:a,onPointerOut:l,onContextMenu:c}){const d=f.useMemo(()=>{switch(e){case"x":return new or(0,Math.PI/2,0);case"y":return new or(Math.PI/2,0,0);case"z":return new or(0,0,0)}},[e]),h=n*.02,u=r?to.hover:t,m=r?La.arcHover:La.arc;return o.jsxs("mesh",{rotation:d,onPointerDown:s,onPointerOver:i,onPointerMove:a,onPointerOut:l,onContextMenu:c,children:[o.jsx("torusGeometry",{args:[n,h,8,64]}),o.jsx("meshBasicMaterial",{color:u,transparent:!0,opacity:m,depthTest:!1,side:ao})]})}function Dl({axis:e,color:t,length:n,isHovered:r,onPointerDown:s,onPointerOver:i,onPointerMove:a,onPointerOut:l,onContextMenu:c}){const d=f.useMemo(()=>{switch(e){case"x":return new X(1,0,0);case"y":return new X(0,1,0);case"z":return new X(0,0,1)}},[e]),h=f.useMemo(()=>{const k=new X(0,1,0);if(Math.abs(d.dot(k))>.999)return new or(d.y>0?0:Math.PI,0,0);const b=new Tt;return b.setFromUnitVectors(k,d),new or().setFromQuaternion(b)},[d]),u=n*.8,m=n*.015,g=n*.2,p=n*.035,y=[d.x*u/2,d.y*u/2,d.z*u/2],w=[d.x*(u+g/2),d.y*(u+g/2),d.z*(u+g/2)],x=r?to.hover:t,v=r?La.axisHover:La.axis;return o.jsxs("group",{children:[o.jsxs("mesh",{position:y,rotation:h,onPointerDown:s,onPointerOver:i,onPointerMove:a,onPointerOut:l,onContextMenu:c,children:[o.jsx("cylinderGeometry",{args:[m,m,u,8]}),o.jsx("meshBasicMaterial",{color:x,transparent:!0,opacity:v,depthTest:!1})]}),o.jsxs("mesh",{position:w,rotation:h,onPointerDown:s,onPointerOver:i,onPointerMove:a,onPointerOut:l,onContextMenu:c,children:[o.jsx("coneGeometry",{args:[p,g,12]}),o.jsx("meshBasicMaterial",{color:x,transparent:!0,opacity:v,depthTest:!1})]})]})}function Gj({center:e,size:t}){const{camera:n,gl:r}=mr(),s=mr(T=>T.controls),i=mn(T=>T.transform),a=mn(T=>T.setTransform),l=mn(T=>T.resetTransform),c=me(T=>T.droppedFiles),d=G(T=>T.setShowGizmo),{processFiles:h}=Ms(),[u,m]=f.useState(null),[g,p]=f.useState(null),[y,w]=f.useState(!1),[x,v]=f.useState(null),[k,b]=f.useState(null),S=f.useRef(null),C=f.useRef(null),M=f.useMemo(()=>{const T=new or(i.rotationX,i.rotationY,i.rotationZ,"XYZ");return new Tt().setFromEuler(T)},[i.rotationX,i.rotationY,i.rotationZ]),I=f.useCallback((T,z)=>{const H=new X(...e);if(z==="translate"){const O=new X;n.getWorldDirection(O);let J;const re=T==="x"?new X(1,0,0):T==="y"?new X(0,1,0):new X(0,0,1);if(J=re.clone().cross(O).cross(re).normalize(),J.lengthSq()<.001){const q=new X(0,1,0).applyQuaternion(n.quaternion);J=re.clone().cross(q).cross(re).normalize()}return new Wu().setFromNormalAndCoplanarPoint(J,H)}else{let O;switch(T){case"x":O=new X(1,0,0);break;case"y":O=new X(0,1,0);break;default:O=new X(0,0,1);break}return new Wu().setFromNormalAndCoplanarPoint(O,H)}},[n,e]),L=f.useCallback((T,z,H)=>{const O=r.domElement.getBoundingClientRect(),J=(T-O.left)/O.width*2-1,re=-((z-O.top)/O.height)*2+1,q=new jg;q.setFromCamera(new Ec(J,re),n);const ie=new X;return q.ray.intersectPlane(H,ie)?ie:null},[n,r]),P=f.useCallback((T,z)=>H=>{H.stopPropagation(),s?.enabled&&(s.enabled.current=!1);const O=I(T,z),J=L(H.nativeEvent.clientX,H.nativeEvent.clientY,O);if(!J){s?.enabled&&(s.enabled.current=!0);return}const re={translationX:i.translationX,translationY:i.translationY,translationZ:i.translationZ,rotationX:i.rotationX,rotationY:i.rotationY,rotationZ:i.rotationZ},q=M.clone(),ie=new X(...e);S.current={axis:T,mode:z,startPoint:J,startCenter:ie,startTransform:re,startRotation:q,plane:O},w(!0),r.domElement.setPointerCapture(H.pointerId)},[I,L,i,r,s,M]),_=f.useCallback(T=>{if(!y||!S.current)return;const{axis:z,mode:H,startPoint:O,startTransform:J,startRotation:re,plane:q}=S.current,ie=L(T.clientX,T.clientY,q);if(!(!ie||!z)){if(H==="translate"){const we=z==="x"?new X(1,0,0):z==="y"?new X(0,1,0):new X(0,0,1),Re=ie.clone().sub(O).dot(we),ee=we.clone().multiplyScalar(Re);a({translationX:J.translationX+ee.x,translationY:J.translationY+ee.y,translationZ:J.translationZ+ee.z})}else if(H==="rotate"){const we=S.current.startCenter,Ce=O.clone().sub(we).normalize(),Re=ie.clone().sub(we).normalize(),ee=z==="x"?new X(1,0,0):z==="y"?new X(0,1,0):new X(0,0,1),he=Ce.clone().cross(Re),Se=Ce.dot(Re);let xe=Math.atan2(he.length(),Se);he.dot(ee)<0&&(xe=-xe);const Ae=new Tt().setFromAxisAngle(ee,xe),ye=Ae.clone().multiply(re),Pe=new X(J.translationX,J.translationY,J.translationZ),$e=we.clone().sub(Pe).clone().applyQuaternion(Ae),qe=we.clone().sub($e),ct=new or().setFromQuaternion(ye,"XYZ");a({translationX:qe.x,translationY:qe.y,translationZ:qe.z,rotationX:ct.x,rotationY:ct.y,rotationZ:ct.z})}}},[y,L,a]),N=f.useCallback(T=>{y&&(w(!1),m(null),p(null),s?.enabled&&(s.enabled.current=!0),S.current=null,r.domElement.releasePointerCapture(T.pointerId))},[y,r,s]);f.useEffect(()=>{if(!y)return;const T=r.domElement;return T.addEventListener("pointermove",_),T.addEventListener("pointerup",N),()=>{T.removeEventListener("pointermove",_),T.removeEventListener("pointerup",N)}},[y,r,_,N]);const D=t*.35,B=D,E=f.useCallback(T=>{T.stopPropagation(),T.nativeEvent.stopPropagation(),T.nativeEvent.preventDefault(),b({x:T.nativeEvent.clientX,y:T.nativeEvent.clientY})},[]),Z=f.useCallback((T,z)=>H=>{y||(m(T),p(z),v({x:H.nativeEvent.clientX,y:H.nativeEvent.clientY}))},[y]),F=f.useCallback(T=>{m(z=>(z&&v({x:T.nativeEvent.clientX,y:T.nativeEvent.clientY}),z))},[]),$=f.useCallback(()=>{y||(m(null),p(null),v(null))},[y]);return o.jsxs("group",{ref:C,position:e,children:[o.jsx(Dl,{axis:"x",color:to.x,length:B,isHovered:u==="x"&&g==="translate"||y&&S.current?.axis==="x"&&S.current?.mode==="translate",onPointerDown:P("x","translate"),onPointerOver:Z("x","translate"),onPointerMove:F,onPointerOut:$,onContextMenu:E}),o.jsx(Dl,{axis:"y",color:to.y,length:B,isHovered:u==="y"&&g==="translate"||y&&S.current?.axis==="y"&&S.current?.mode==="translate",onPointerDown:P("y","translate"),onPointerOver:Z("y","translate"),onPointerMove:F,onPointerOut:$,onContextMenu:E}),o.jsx(Dl,{axis:"z",color:to.z,length:B,isHovered:u==="z"&&g==="translate"||y&&S.current?.axis==="z"&&S.current?.mode==="translate",onPointerDown:P("z","translate"),onPointerOver:Z("z","translate"),onPointerMove:F,onPointerOut:$,onContextMenu:E}),o.jsx(Rl,{axis:"x",color:to.x,radius:D,isHovered:u==="x"&&g==="rotate"||y&&S.current?.axis==="x"&&S.current?.mode==="rotate",onPointerDown:P("x","rotate"),onPointerOver:Z("x","rotate"),onPointerMove:F,onPointerOut:$,onContextMenu:E}),o.jsx(Rl,{axis:"y",color:to.y,radius:D,isHovered:u==="y"&&g==="rotate"||y&&S.current?.axis==="y"&&S.current?.mode==="rotate",onPointerDown:P("y","rotate"),onPointerOver:Z("y","rotate"),onPointerMove:F,onPointerOut:$,onContextMenu:E}),o.jsx(Rl,{axis:"z",color:to.z,radius:D,isHovered:u==="z"&&g==="rotate"||y&&S.current?.axis==="z"&&S.current?.mode==="rotate",onPointerDown:P("z","rotate"),onPointerOver:Z("z","rotate"),onPointerMove:F,onPointerOut:$,onContextMenu:E}),o.jsxs("mesh",{onContextMenu:E,renderOrder:999,children:[o.jsx("sphereGeometry",{args:[t*.02,16,16]}),o.jsx("meshBasicMaterial",{color:st.material.white,depthTest:!1,transparent:!0,opacity:1})]}),u&&x&&!k&&o.jsx(Gr,{style:{position:"fixed",left:x.x+rn.cursorOffset,top:x.y+rn.cursorOffset,pointerEvents:"none",transform:"none"},calculatePosition:()=>[0,0],children:o.jsxs("div",{className:ve.container,children:[o.jsx("div",{className:ve.title,children:"Transform Gizmo"}),o.jsxs("div",{className:ve.subtitle,children:[u.toUpperCase(),"-axis â€¢ ",g]}),o.jsxs("div",{className:ve.hint,children:[o.jsxs("div",{className:ve.hintRow,children:[o.jsxs("svg",{className:_t.hoverCard,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[o.jsx("rect",{x:"6",y:"2",width:"12",height:"20",rx:"6"}),o.jsx("path",{d:"M12 2v8"}),o.jsx("rect",{x:"6",y:"2",width:"6",height:"8",rx:"3",fill:"currentColor",opacity:"0.5"})]}),"Drag: ",g]}),o.jsxs("div",{className:ve.hintRow,children:[o.jsxs("svg",{className:_t.hoverCard,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[o.jsx("rect",{x:"6",y:"2",width:"12",height:"20",rx:"6"}),o.jsx("path",{d:"M12 2v8"}),o.jsx("rect",{x:"12",y:"2",width:"6",height:"8",rx:"3",fill:"currentColor",opacity:"0.5"})]}),"Right: options"]})]})]})}),k&&o.jsx(qj,{position:k,onClose:()=>b(null),onReset:()=>{l(),b(null)},onReload:()=>{c&&(l(),h(c)),b(null)},onApply:()=>{wa(),b(null)},onOff:()=>{d(!1),b(null)}})]})}function qj({position:e,onClose:t,onReset:n,onReload:r,onApply:s,onOff:i}){const a=f.useRef(null);return f.useEffect(()=>{const l=h=>{a.current&&!a.current.contains(h.target)&&t()},c=h=>{h.key==="Escape"&&t()},d=setTimeout(()=>{document.addEventListener("mousedown",l),document.addEventListener("keydown",c)},0);return()=>{clearTimeout(d),document.removeEventListener("mousedown",l),document.removeEventListener("keydown",c)}},[t]),o.jsx(Gr,{style:{position:"fixed",left:e.x,top:e.y,pointerEvents:"auto"},calculatePosition:()=>[0,0],children:o.jsxs("div",{ref:a,className:Lt.container,children:[o.jsxs("button",{className:Lt.button,onClick:n,children:[o.jsx(ii,{className:Lt.icon}),"Reset"]}),o.jsxs("button",{className:Lt.button,onClick:r,children:[o.jsx(op,{className:Lt.icon}),"Reload"]}),o.jsxs("button",{className:Lt.button,onClick:s,children:[o.jsx(No,{className:Lt.icon}),"Apply"]}),o.jsxs("button",{className:Lt.button,onClick:i,children:[o.jsx(lk,{className:Lt.icon}),"Off"]})]})})}const Xj=.012;function Kj({position:e,baseSize:t}){const n=f.useMemo(()=>new Float32Array([e.x,e.y,e.z]),[e.x,e.y,e.z]);return o.jsxs("points",{children:[o.jsx("bufferGeometry",{children:o.jsx("bufferAttribute",{attach:"attributes-position",args:[n,3]})}),o.jsx("pointsMaterial",{color:st.interaction.hover,size:t+3,sizeAttenuation:!1,depthTest:!1,transparent:!0,opacity:Wn.interaction.markerHighlight})]})}function Qj(){const e=lt(P=>P.selectedPoints),t=lt(P=>P.pickingMode),n=lt(P=>P.removePointAt),r=lt(P=>P.normalFlipped),s=lt(P=>P.toggleNormalFlipped),i=lt(P=>P.targetAxis),a=lt(P=>P.cycleTargetAxis),l=lt(P=>P.setTargetAxis),c=Vt(P=>P.pointSize),d=G(P=>P.axesCoordinateSystem),h=f.useRef(t);f.useEffect(()=>{if(t==="normal-3pt"&&h.current!=="normal-3pt"){const P=l0(d);l(P)}h.current=t},[t,d,l]);const u=Ih[i],m=t==="origin-1pt"?1:t==="distance-2pt"?2:t==="normal-3pt"?3:0,g=e.length<m,p=lt(P=>g?P.hoveredPoint:null),[y,w]=f.useState(null),[x,v]=f.useState(!1),[k,b]=f.useState(null),S=f.useMemo(()=>{if(e.length<2)return .015;const P=e[0].position.distanceTo(e[1].position);return Math.max(Xj,P*.015)},[e]),C=f.useMemo(()=>{if(t!=="normal-3pt"||e.length!==3)return null;const P=e[0].position,_=e[1].position,N=e[2].position,D=new X().subVectors(_,P),B=new X().subVectors(N,P),E=new X().crossVectors(D,B);if(E.lengthSq()<1e-10)return null;E.normalize(),r&&E.negate();const Z=new X().add(P).add(_).add(N).divideScalar(3),F=Math.max(D.length(),B.length())*.5,$=Z.clone().add(E.clone().multiplyScalar(F)),T=new Tt;T.setFromUnitVectors(new X(0,1,0),E);const z=F*.2,H=F*.04,O=new Float32Array([P.x,P.y,P.z,_.x,_.y,_.z,N.x,N.y,N.z]);return{start:Z,end:$,quaternion:T,coneHeight:z,coneRadius:H,normal:E,trianglePositions:O}},[e,t,r]),M=f.useMemo(()=>{if(e.length<2)return null;const P=[];for(const D of e)P.push(D.position.x,D.position.y,D.position.z);t==="normal-3pt"&&e.length===3&&P.push(e[0].position.x,e[0].position.y,e[0].position.z);const _=new us;_.setAttribute("position",new Ks(P,3));const N=new Hl({color:oo,transparent:!0,opacity:Wn.interaction.markerHighlight,depthTest:!1});return new Vu(_,N)},[e,t]),I=f.useMemo(()=>{if(!C)return null;const P=new us,_=new Float32Array([C.start.x,C.start.y,C.start.z,C.end.x,C.end.y,C.end.z]);P.setAttribute("position",new Ks(_,3));const N=new Hl({color:u.hex,depthTest:!1});return new Vu(P,N)},[C,u.hex]),L=f.useMemo(()=>new Eg(1,8,8),[]);return f.useEffect(()=>()=>{L.dispose()},[L]),e.length===0&&!p?null:o.jsxs("group",{children:[e.map((P,_)=>o.jsx("mesh",{position:P.position,scale:S,geometry:L,onContextMenu:N=>{N.stopPropagation(),N.nativeEvent.stopPropagation(),N.nativeEvent.preventDefault(),n(_)},onPointerOver:N=>{w(_),b({x:N.nativeEvent.clientX,y:N.nativeEvent.clientY})},onPointerOut:()=>{w(null),b(null)},children:o.jsx("meshBasicMaterial",{color:y===_?oo:p0[_],transparent:!0,opacity:Wn.interaction.marker,depthTest:!1})},_)),M&&o.jsx("primitive",{object:M}),C&&I&&o.jsxs(o.Fragment,{children:[o.jsxs("mesh",{onClick:P=>{P.stopPropagation(),s()},onContextMenu:P=>{P.stopPropagation(),P.nativeEvent.preventDefault(),a(d)},onPointerOver:P=>{v(!0),b({x:P.nativeEvent.clientX,y:P.nativeEvent.clientY})},onPointerOut:()=>{v(!1),b(null)},children:[o.jsx("bufferGeometry",{children:o.jsx("bufferAttribute",{attach:"attributes-position",args:[C.trianglePositions,3]})}),o.jsx("meshBasicMaterial",{color:x?oo:u.hex,transparent:!0,opacity:x?Wn.interaction.triangleHovered:Wn.interaction.triangleDefault,side:ao,depthTest:!1})]}),o.jsx("primitive",{object:I}),o.jsxs("mesh",{position:C.end,quaternion:C.quaternion,onClick:P=>{P.stopPropagation(),s()},onContextMenu:P=>{P.stopPropagation(),P.nativeEvent.preventDefault(),a(d)},children:[o.jsx("coneGeometry",{args:[C.coneRadius,C.coneHeight,8]}),o.jsx("meshBasicMaterial",{color:u.hex,depthTest:!1})]})]}),p&&g&&o.jsx(Kj,{position:p,baseSize:c}),y!==null&&k&&o.jsx(Aa,{mousePos:k,title:`P${y+1}`,subtitle:"Right-click to remove"}),x&&k&&o.jsx(Aa,{mousePos:k,title:`${i}-axis`,titleStyle:{color:u.css},subtitle:"Left: flip Â· Right: X/Y/Z"})]})}function Jj({label:e,suffix:t,fontSize:n,color:r,position:s,anchorX:i="right"}){const a=!!t;return o.jsx(sh,{position:s,follow:!0,children:o.jsxs("group",{children:[o.jsx(Us,{fontSize:n,color:r,anchorX:a?"right":i,anchorY:"middle",outlineWidth:n*.08,outlineColor:so.outline,outlineOpacity:.5,children:e}),a&&o.jsxs(Us,{fontSize:n*.6,color:r,anchorX:"left",anchorY:"middle",position:[n*.15,0,0],outlineWidth:n*.05,outlineColor:so.outline,outlineOpacity:.5,children:["(",t,")"]})]})})}function eE({boundsRadius:e}){const t=Ct(C=>C.detectedPlane),n=Ct(C=>C.normalFlipped),r=Ct(C=>C.toggleNormalFlipped),s=Ct(C=>C.targetAxis),i=Ct(C=>C.cycleTargetAxis),a=Ct(C=>C.setShowFloorModal),l=Ct(C=>C.setModalPosition),c=Ct(C=>C.showFloorModal),d=G(C=>C.axesScale),h=G(C=>C.axesCoordinateSystem),[u,m]=f.useState(!1),[g,p]=f.useState(null),y=Ih[s],w=f.useMemo(()=>{if(!t)return null;const C=n?Fp(t):t,{normal:M,centroid:I,radius:L}=C,P=new X(I[0],I[1],I[2]),_=new X(M[0],M[1],M[2]),N=new Tt;N.setFromUnitVectors(new X(0,0,1),_);const D=e*d,B=D*.5,E=D*.005,Z=E*8,F=E*3,$=B-Z,T=P.clone().add(_.clone().multiplyScalar($/2)),z=P.clone().add(_.clone().multiplyScalar($+Z/2)),H=new Tt;H.setFromUnitVectors(new X(0,1,0),_);const O=new Tt;O.setFromUnitVectors(new X(0,1,0),_);const J=B*1.15,re=P.clone().add(_.clone().multiplyScalar(J)),q=D*.08;return{position:P,normalVec:_,quaternion:N,radius:L,arrowRadius:E,shaftLength:$,shaftCenter:T,shaftQuaternion:O,conePosition:z,coneHeight:Z,coneRadius:F,coneQuaternion:H,labelPosition:re,fontSize:q}},[t,n,e,d]);if(!t||!w)return null;const x=C=>{C.stopPropagation(),r()},v=C=>{C.stopPropagation(),C.nativeEvent.stopPropagation(),C.nativeEvent.preventDefault(),i()},k=C=>{m(!0),p({x:C.nativeEvent.clientX,y:C.nativeEvent.clientY}),c||(a(!0),l({x:C.nativeEvent.clientX,y:C.nativeEvent.clientY}))},b=C=>{p({x:C.nativeEvent.clientX,y:C.nativeEvent.clientY})},S=()=>{m(!1),p(null)};return o.jsxs("group",{children:[o.jsxs("mesh",{position:w.position,quaternion:w.quaternion,onClick:x,onContextMenu:v,onPointerOver:k,onPointerMove:b,onPointerOut:S,children:[o.jsx("ringGeometry",{args:[w.radius*.95,w.radius,64]}),o.jsx("meshBasicMaterial",{color:u?oo:y.hex,transparent:!0,opacity:u?Wn.interaction.ringHovered:Wn.interaction.ringDefault,side:ao,depthTest:!1})]}),o.jsxs("mesh",{position:w.position,quaternion:w.quaternion,onClick:x,onContextMenu:v,onPointerOver:k,onPointerMove:b,onPointerOut:S,children:[o.jsx("circleGeometry",{args:[w.radius*.3,32]}),o.jsx("meshBasicMaterial",{color:u?oo:y.hex,transparent:!0,opacity:u?Wn.interaction.circleHovered:Wn.interaction.circleDefault,side:ao,depthTest:!1})]}),o.jsxs("mesh",{position:w.shaftCenter,quaternion:w.shaftQuaternion,onClick:x,onContextMenu:v,children:[o.jsx("cylinderGeometry",{args:[w.arrowRadius,w.arrowRadius,w.shaftLength,8]}),o.jsx("meshBasicMaterial",{color:y.hex,depthTest:!1})]}),o.jsxs("mesh",{position:w.conePosition,quaternion:w.coneQuaternion,onClick:x,onContextMenu:v,children:[o.jsx("coneGeometry",{args:[w.coneRadius,w.coneHeight,8]}),o.jsx("meshBasicMaterial",{color:y.hex,depthTest:!1})]}),o.jsx(Jj,{label:s,suffix:zp[h][s],fontSize:w.fontSize,color:y.hex,position:w.labelPosition.toArray()}),u&&g&&o.jsx(Aa,{mousePos:g,title:`${s}-axis`,titleStyle:{color:y.css},children:o.jsxs("div",{className:ve.hint,children:[o.jsxs("div",{className:ve.hintRow,children:[o.jsxs("svg",{className:_t.hoverCard,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[o.jsx("rect",{x:"6",y:"2",width:"12",height:"20",rx:"6"}),o.jsx("path",{d:"M12 2v8"}),o.jsx("rect",{x:"6",y:"2",width:"6",height:"8",rx:"3",fill:"currentColor",opacity:"0.5"})]}),"Flip normal"]}),o.jsxs("div",{className:ve.hintRow,children:[o.jsxs("svg",{className:_t.hoverCard,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[o.jsx("rect",{x:"6",y:"2",width:"12",height:"20",rx:"6"}),o.jsx("path",{d:"M12 2v8"}),o.jsx("rect",{x:"12",y:"2",width:"6",height:"8",rx:"3",fill:"currentColor",opacity:"0.5"})]}),"Cycle X/Y/Z"]})]})})]})}const tE=["P1","P2","P3"];function nE(){const e=lt(h=>h.pickingMode),t=lt(h=>h.selectedPoints.length),[n,r]=f.useState({x:0,y:0}),s=e==="origin-1pt"?1:e==="distance-2pt"?2:e==="normal-3pt"?3:0,i=e!=="off",a=t,l=a>=s;if(f.useEffect(()=>{if(!i)return;const h=u=>{r({x:u.clientX,y:u.clientY})};return window.addEventListener("mousemove",h),()=>window.removeEventListener("mousemove",h)},[i]),!i||l)return null;const c=nd[a]||nd[0],d=tE[a]||"P1";return o.jsx("div",{className:`fixed pointer-events-none z-[${Rn.modal}]`,style:{left:n.x+16,top:n.y+16},children:o.jsxs("div",{className:"bg-black/90 text-white text-xs px-2 py-1.5 rounded whitespace-nowrap flex items-center gap-2",children:[o.jsx("span",{className:"w-3 h-3 rounded-full inline-block",style:{backgroundColor:c}}),o.jsxs("span",{children:["Select ",o.jsx("strong",{children:d})]})]})})}function Vi(e){throw new Error('Could not dynamically require "'+e+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var Fl={exports:{}},Wf;function rE(){return Wf||(Wf=1,(function(e,t){(function(n){e.exports=n()})(function(){return(function n(r,s,i){function a(d,h){if(!s[d]){if(!r[d]){var u=typeof Vi=="function"&&Vi;if(!h&&u)return u(d,!0);if(l)return l(d,!0);var m=new Error("Cannot find module '"+d+"'");throw m.code="MODULE_NOT_FOUND",m}var g=s[d]={exports:{}};r[d][0].call(g.exports,function(p){var y=r[d][1][p];return a(y||p)},g,g.exports,n,r,s,i)}return s[d].exports}for(var l=typeof Vi=="function"&&Vi,c=0;c<i.length;c++)a(i[c]);return a})({1:[function(n,r,s){function i(){this._events=this._events||{},this._maxListeners=this._maxListeners||void 0}r.exports=i,i.EventEmitter=i,i.prototype._events=void 0,i.prototype._maxListeners=void 0,i.defaultMaxListeners=10,i.prototype.setMaxListeners=function(h){if(!l(h)||h<0||isNaN(h))throw TypeError("n must be a positive number");return this._maxListeners=h,this},i.prototype.emit=function(h){var u,m,g,p,y,w;if(this._events||(this._events={}),h==="error"&&(!this._events.error||c(this._events.error)&&!this._events.error.length)){if(u=arguments[1],u instanceof Error)throw u;var x=new Error('Uncaught, unspecified "error" event. ('+u+")");throw x.context=u,x}if(m=this._events[h],d(m))return!1;if(a(m))switch(arguments.length){case 1:m.call(this);break;case 2:m.call(this,arguments[1]);break;case 3:m.call(this,arguments[1],arguments[2]);break;default:p=Array.prototype.slice.call(arguments,1),m.apply(this,p)}else if(c(m))for(p=Array.prototype.slice.call(arguments,1),w=m.slice(),g=w.length,y=0;y<g;y++)w[y].apply(this,p);return!0},i.prototype.addListener=function(h,u){var m;if(!a(u))throw TypeError("listener must be a function");return this._events||(this._events={}),this._events.newListener&&this.emit("newListener",h,a(u.listener)?u.listener:u),this._events[h]?c(this._events[h])?this._events[h].push(u):this._events[h]=[this._events[h],u]:this._events[h]=u,c(this._events[h])&&!this._events[h].warned&&(d(this._maxListeners)?m=i.defaultMaxListeners:m=this._maxListeners,m&&m>0&&this._events[h].length>m&&(this._events[h].warned=!0,console.error("(node) warning: possible EventEmitter memory leak detected. %d listeners added. Use emitter.setMaxListeners() to increase limit.",this._events[h].length),typeof console.trace=="function"&&console.trace())),this},i.prototype.on=i.prototype.addListener,i.prototype.once=function(h,u){if(!a(u))throw TypeError("listener must be a function");var m=!1;function g(){this.removeListener(h,g),m||(m=!0,u.apply(this,arguments))}return g.listener=u,this.on(h,g),this},i.prototype.removeListener=function(h,u){var m,g,p,y;if(!a(u))throw TypeError("listener must be a function");if(!this._events||!this._events[h])return this;if(m=this._events[h],p=m.length,g=-1,m===u||a(m.listener)&&m.listener===u)delete this._events[h],this._events.removeListener&&this.emit("removeListener",h,u);else if(c(m)){for(y=p;y-- >0;)if(m[y]===u||m[y].listener&&m[y].listener===u){g=y;break}if(g<0)return this;m.length===1?(m.length=0,delete this._events[h]):m.splice(g,1),this._events.removeListener&&this.emit("removeListener",h,u)}return this},i.prototype.removeAllListeners=function(h){var u,m;if(!this._events)return this;if(!this._events.removeListener)return arguments.length===0?this._events={}:this._events[h]&&delete this._events[h],this;if(arguments.length===0){for(u in this._events)u!=="removeListener"&&this.removeAllListeners(u);return this.removeAllListeners("removeListener"),this._events={},this}if(m=this._events[h],a(m))this.removeListener(h,m);else if(m)for(;m.length;)this.removeListener(h,m[m.length-1]);return delete this._events[h],this},i.prototype.listeners=function(h){var u;return!this._events||!this._events[h]?u=[]:a(this._events[h])?u=[this._events[h]]:u=this._events[h].slice(),u},i.prototype.listenerCount=function(h){if(this._events){var u=this._events[h];if(a(u))return 1;if(u)return u.length}return 0},i.listenerCount=function(h,u){return h.listenerCount(u)};function a(h){return typeof h=="function"}function l(h){return typeof h=="number"}function c(h){return typeof h=="object"&&h!==null}function d(h){return h===void 0}},{}],2:[function(n,r,s){var i,a,l,c,d;d=navigator.userAgent.toLowerCase(),c=navigator.platform.toLowerCase(),i=d.match(/(opera|ie|firefox|chrome|version)[\s\/:]([\w\d\.]+)?.*?(safari|version[\s\/:]([\w\d\.]+)|$)/)||[null,"unknown",0],l=i[1]==="ie"&&document.documentMode,a={name:i[1]==="version"?i[3]:i[1],version:l||parseFloat(i[1]==="opera"&&i[4]?i[4]:i[2]),platform:{name:d.match(/ip(?:ad|od|hone)/)?"ios":(d.match(/(?:webos|android)/)||c.match(/mac|win|linux/)||["other"])[0]}},a[a.name]=!0,a[a.name+parseInt(a.version,10)]=!0,a.platform[a.platform.name]=!0,r.exports=a},{}],3:[function(n,r,s){var i,a,l,c=function(m,g){for(var p in g)d.call(g,p)&&(m[p]=g[p]);function y(){this.constructor=m}return y.prototype=g.prototype,m.prototype=new y,m.__super__=g.prototype,m},d={}.hasOwnProperty,h=[].indexOf||function(m){for(var g=0,p=this.length;g<p;g++)if(g in this&&this[g]===m)return g;return-1},u=[].slice;i=n("events").EventEmitter,l=n("./browser.coffee"),a=(function(m){var g,p;c(y,m),g={workerScript:"gif.worker.js",workers:2,repeat:0,background:"#fff",quality:10,width:null,height:null,transparent:null,debug:!1,dither:!1},p={delay:500,copy:!1};function y(w){var x,v,k;this.running=!1,this.options={},this.frames=[],this.freeWorkers=[],this.activeWorkers=[],this.setOptions(w);for(v in g)k=g[v],(x=this.options)[v]==null&&(x[v]=k)}return y.prototype.setOption=function(w,x){if(this.options[w]=x,this._canvas!=null&&(w==="width"||w==="height"))return this._canvas[w]=x},y.prototype.setOptions=function(w){var x,v,k;v=[];for(x in w)d.call(w,x)&&(k=w[x],v.push(this.setOption(x,k)));return v},y.prototype.addFrame=function(w,x){var v,k;x==null&&(x={}),v={},v.transparent=this.options.transparent;for(k in p)v[k]=x[k]||p[k];if(this.options.width==null&&this.setOption("width",w.width),this.options.height==null&&this.setOption("height",w.height),typeof ImageData<"u"&&ImageData!==null&&w instanceof ImageData)v.data=w.data;else if(typeof CanvasRenderingContext2D<"u"&&CanvasRenderingContext2D!==null&&w instanceof CanvasRenderingContext2D||typeof WebGLRenderingContext<"u"&&WebGLRenderingContext!==null&&w instanceof WebGLRenderingContext)x.copy?v.data=this.getContextData(w):v.context=w;else if(w.childNodes!=null)x.copy?v.data=this.getImageData(w):v.image=w;else throw new Error("Invalid image");return this.frames.push(v)},y.prototype.render=function(){var w,x,v;if(this.running)throw new Error("Already running");if(this.options.width==null||this.options.height==null)throw new Error("Width and height must be set prior to rendering");if(this.running=!0,this.nextFrame=0,this.finishedFrames=0,this.imageParts=function(){var k,b,S;for(S=[],k=0,b=this.frames.length;0<=b?k<b:k>b;0<=b?++k:--k)S.push(null);return S}.call(this),x=this.spawnWorkers(),this.options.globalPalette===!0)this.renderNextFrame();else for(w=0,v=x;0<=v?w<v:w>v;0<=v?++w:--w)this.renderNextFrame();return this.emit("start"),this.emit("progress",0)},y.prototype.abort=function(){for(var w;w=this.activeWorkers.shift(),w!=null;)this.log("killing active worker"),w.terminate();return this.running=!1,this.emit("abort")},y.prototype.spawnWorkers=function(){var w,x,v;return w=Math.min(this.options.workers,this.frames.length),(function(){v=[];for(var k=x=this.freeWorkers.length;x<=w?k<w:k>w;x<=w?k++:k--)v.push(k);return v}).apply(this).forEach((function(k){return function(b){var S;return k.log("spawning worker "+b),S=new Worker(k.options.workerScript),S.onmessage=function(C){return k.activeWorkers.splice(k.activeWorkers.indexOf(S),1),k.freeWorkers.push(S),k.frameFinished(C.data)},k.freeWorkers.push(S)}})(this)),w},y.prototype.frameFinished=function(w){var x,v;if(this.log("frame "+w.index+" finished - "+this.activeWorkers.length+" active"),this.finishedFrames++,this.emit("progress",this.finishedFrames/this.frames.length),this.imageParts[w.index]=w,this.options.globalPalette===!0&&(this.options.globalPalette=w.globalPalette,this.log("global palette analyzed"),this.frames.length>2))for(x=1,v=this.freeWorkers.length;1<=v?x<v:x>v;1<=v?++x:--x)this.renderNextFrame();return h.call(this.imageParts,null)>=0?this.renderNextFrame():this.finishRendering()},y.prototype.finishRendering=function(){var w,x,v,k,b,S,C,M,I,L,P,_,N,D,B,E;for(M=0,D=this.imageParts,b=0,I=D.length;b<I;b++)x=D[b],M+=(x.data.length-1)*x.pageSize+x.cursor;for(M+=x.pageSize-x.cursor,this.log("rendering finished - filesize "+Math.round(M/1e3)+"kb"),w=new Uint8Array(M),_=0,B=this.imageParts,S=0,L=B.length;S<L;S++)for(x=B[S],E=x.data,v=C=0,P=E.length;C<P;v=++C)N=E[v],w.set(N,_),v===x.data.length-1?_+=x.cursor:_+=x.pageSize;return k=new Blob([w],{type:"image/gif"}),this.emit("finished",k,w)},y.prototype.renderNextFrame=function(){var w,x,v;if(this.freeWorkers.length===0)throw new Error("No free workers");if(!(this.nextFrame>=this.frames.length))return w=this.frames[this.nextFrame++],v=this.freeWorkers.shift(),x=this.getTask(w),this.log("starting frame "+(x.index+1)+" of "+this.frames.length),this.activeWorkers.push(v),v.postMessage(x)},y.prototype.getContextData=function(w){return w.getImageData(0,0,this.options.width,this.options.height).data},y.prototype.getImageData=function(w){var x;return this._canvas==null&&(this._canvas=document.createElement("canvas"),this._canvas.width=this.options.width,this._canvas.height=this.options.height),x=this._canvas.getContext("2d"),x.setFill=this.options.background,x.fillRect(0,0,this.options.width,this.options.height),x.drawImage(w,0,0),this.getContextData(x)},y.prototype.getTask=function(w){var x,v;if(x=this.frames.indexOf(w),v={index:x,last:x===this.frames.length-1,delay:w.delay,transparent:w.transparent,width:this.options.width,height:this.options.height,quality:this.options.quality,dither:this.options.dither,globalPalette:this.options.globalPalette,repeat:this.options.repeat,canTransfer:l.name==="chrome"},w.data!=null)v.data=w.data;else if(w.context!=null)v.data=this.getContextData(w.context);else if(w.image!=null)v.data=this.getImageData(w.image);else throw new Error("Invalid frame");return v},y.prototype.log=function(){var w;if(w=1<=arguments.length?u.call(arguments,0):[],!!this.options.debug)return console.log.apply(console,w)},y})(i),r.exports=a},{"./browser.coffee":2,events:1}]},{},[3])(3)})})(Fl)),Fl.exports}var oE=rE();const sE=Tg(oE);var wu=(e,t,n)=>{if(!t.has(e))throw TypeError("Cannot "+n)},R=(e,t,n)=>(wu(e,t,"read from private field"),n?n.call(e):t.get(e)),at=(e,t,n)=>{if(t.has(e))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(e):t.set(e,n)},hn=(e,t,n,r)=>(wu(e,t,"write to private field"),t.set(e,n),n),iE=(e,t,n,r)=>({set _(s){hn(e,t,s)},get _(){return R(e,t,r)}}),ht=(e,t,n)=>(wu(e,t,"access private method"),n),gt=new Uint8Array(8),Nr=new DataView(gt.buffer),ln=e=>[(e%256+256)%256],wt=e=>(Nr.setUint16(0,e,!1),[gt[0],gt[1]]),aE=e=>(Nr.setInt16(0,e,!1),[gt[0],gt[1]]),Hp=e=>(Nr.setUint32(0,e,!1),[gt[1],gt[2],gt[3]]),Ie=e=>(Nr.setUint32(0,e,!1),[gt[0],gt[1],gt[2],gt[3]]),lE=e=>(Nr.setInt32(0,e,!1),[gt[0],gt[1],gt[2],gt[3]]),Fo=e=>(Nr.setUint32(0,Math.floor(e/2**32),!1),Nr.setUint32(4,e,!1),[gt[0],gt[1],gt[2],gt[3],gt[4],gt[5],gt[6],gt[7]]),bu=e=>(Nr.setInt16(0,2**8*e,!1),[gt[0],gt[1]]),Sr=e=>(Nr.setInt32(0,2**16*e,!1),[gt[0],gt[1],gt[2],gt[3]]),zl=e=>(Nr.setInt32(0,2**30*e,!1),[gt[0],gt[1],gt[2],gt[3]]),nr=(e,t=!1)=>{let n=Array(e.length).fill(null).map((r,s)=>e.charCodeAt(s));return t&&n.push(0),n},_a=e=>e&&e[e.length-1],Cu=e=>{let t;for(let n of e)(!t||n.presentationTimestamp>t.presentationTimestamp)&&(t=n);return t},jr=(e,t,n=!0)=>{let r=e*t;return n?Math.round(r):r},Wp=e=>{let t=e*(Math.PI/180),n=Math.cos(t),r=Math.sin(t);return[n,r,0,-r,n,0,0,0,1]},Vp=Wp(0),Zp=e=>[Sr(e[0]),Sr(e[1]),zl(e[2]),Sr(e[3]),Sr(e[4]),zl(e[5]),Sr(e[6]),Sr(e[7]),zl(e[8])],Vs=e=>!e||typeof e!="object"?e:Array.isArray(e)?e.map(Vs):Object.fromEntries(Object.entries(e).map(([t,n])=>[t,Vs(n)])),vs=e=>e>=0&&e<2**32,on=(e,t,n)=>({type:e,contents:t&&new Uint8Array(t.flat(10)),children:n}),Ot=(e,t,n,r,s)=>on(e,[ln(t),Hp(n),r??[]],s),cE=e=>{let t=512;return e.fragmented?on("ftyp",[nr("iso5"),Ie(t),nr("iso5"),nr("iso6"),nr("mp41")]):on("ftyp",[nr("isom"),Ie(t),nr("isom"),e.holdsAvc?nr("avc1"):[],nr("mp41")])},vc=e=>({type:"mdat",largeSize:e}),uE=e=>({type:"free",size:e}),la=(e,t,n=!1)=>on("moov",null,[dE(t,e),...e.map(r=>fE(r,t)),n?HE(e):null]),dE=(e,t)=>{let n=jr(Math.max(0,...t.filter(a=>a.samples.length>0).map(a=>{const l=Cu(a.samples);return l.presentationTimestamp+l.duration})),Cc),r=Math.max(...t.map(a=>a.id))+1,s=!vs(e)||!vs(n),i=s?Fo:Ie;return Ot("mvhd",+s,0,[i(e),i(e),Ie(Cc),i(n),Sr(1),bu(1),Array(10).fill(0),Zp(Vp),Array(24).fill(0),Ie(r)])},fE=(e,t)=>on("trak",null,[hE(e,t),mE(e,t)]),hE=(e,t)=>{let n=Cu(e.samples),r=jr(n?n.presentationTimestamp+n.duration:0,Cc),s=!vs(t)||!vs(r),i=s?Fo:Ie,a;return e.info.type==="video"?a=typeof e.info.rotation=="number"?Wp(e.info.rotation):e.info.rotation:a=Vp,Ot("tkhd",+s,3,[i(t),i(t),Ie(e.id),Ie(0),i(r),Array(8).fill(0),wt(0),wt(0),bu(e.info.type==="audio"?1:0),wt(0),Zp(a),Sr(e.info.type==="video"?e.info.width:0),Sr(e.info.type==="video"?e.info.height:0)])},mE=(e,t)=>on("mdia",null,[pE(e,t),gE(e.info.type==="video"?"vide":"soun"),xE(e)]),pE=(e,t)=>{let n=Cu(e.samples),r=jr(n?n.presentationTimestamp+n.duration:0,e.timescale),s=!vs(t)||!vs(r),i=s?Fo:Ie;return Ot("mdhd",+s,0,[i(t),i(t),Ie(e.timescale),i(r),wt(21956),wt(0)])},gE=e=>Ot("hdlr",0,0,[nr("mhlr"),nr(e),Ie(0),Ie(0),Ie(0),nr("mp4-muxer-hdlr",!0)]),xE=e=>on("minf",null,[e.info.type==="video"?yE():vE(),wE(),SE(e)]),yE=()=>Ot("vmhd",0,1,[wt(0),wt(0),wt(0),wt(0)]),vE=()=>Ot("smhd",0,0,[wt(0),wt(0)]),wE=()=>on("dinf",null,[bE()]),bE=()=>Ot("dref",0,0,[Ie(1)],[CE()]),CE=()=>Ot("url ",0,1),SE=e=>{const t=e.compositionTimeOffsetTable.length>1||e.compositionTimeOffsetTable.some(n=>n.sampleCompositionTimeOffset!==0);return on("stbl",null,[kE(e),FE(e),zE(e),OE(e),$E(e),BE(e),t?UE(e):null])},kE=e=>Ot("stsd",0,0,[Ie(1)],[e.info.type==="video"?IE(JE[e.info.codec],e):TE(tP[e.info.codec],e)]),IE=(e,t)=>on(e,[Array(6).fill(0),wt(1),wt(0),wt(0),Array(12).fill(0),wt(t.info.width),wt(t.info.height),Ie(4718592),Ie(4718592),Ie(0),wt(1),Array(32).fill(0),wt(24),aE(65535)],[eP[t.info.codec](t),t.info.decoderConfig.colorSpace?PE(t):null]),ME={bt709:1,bt470bg:5,smpte170m:6},jE={bt709:1,smpte170m:6,"iec61966-2-1":13},EE={rgb:0,bt709:1,bt470bg:5,smpte170m:6},PE=e=>on("colr",[nr("nclx"),wt(ME[e.info.decoderConfig.colorSpace.primaries]),wt(jE[e.info.decoderConfig.colorSpace.transfer]),wt(EE[e.info.decoderConfig.colorSpace.matrix]),ln((e.info.decoderConfig.colorSpace.fullRange?1:0)<<7)]),NE=e=>e.info.decoderConfig&&on("avcC",[...new Uint8Array(e.info.decoderConfig.description)]),AE=e=>e.info.decoderConfig&&on("hvcC",[...new Uint8Array(e.info.decoderConfig.description)]),LE=e=>{if(!e.info.decoderConfig)return null;let t=e.info.decoderConfig;if(!t.colorSpace)throw new Error("'colorSpace' is required in the decoder config for VP9.");let n=t.codec.split("."),r=Number(n[1]),s=Number(n[2]),l=(Number(n[3])<<4)+(0<<1)+Number(t.colorSpace.fullRange);return Ot("vpcC",1,0,[ln(r),ln(s),ln(l),ln(2),ln(2),ln(2),wt(0)])},_E=()=>{let n=(1<<7)+1;return on("av1C",[n,0,0,0])},TE=(e,t)=>on(e,[Array(6).fill(0),wt(1),wt(0),wt(0),Ie(0),wt(t.info.numberOfChannels),wt(16),wt(0),wt(0),Sr(t.info.sampleRate)],[nP[t.info.codec](t)]),RE=e=>{let t=new Uint8Array(e.info.decoderConfig.description);return Ot("esds",0,0,[Ie(58753152),ln(32+t.byteLength),wt(1),ln(0),Ie(75530368),ln(18+t.byteLength),ln(64),ln(21),Hp(0),Ie(130071),Ie(130071),Ie(92307584),ln(t.byteLength),...t,Ie(109084800),ln(1),ln(2)])},DE=e=>{let t=3840,n=0;const r=e.info.decoderConfig?.description;if(r){if(r.byteLength<18)throw new TypeError("Invalid decoder description provided for Opus; must be at least 18 bytes long.");const s=ArrayBuffer.isView(r)?new DataView(r.buffer,r.byteOffset,r.byteLength):new DataView(r);t=s.getUint16(10,!0),n=s.getInt16(14,!0)}return on("dOps",[ln(0),ln(e.info.numberOfChannels),wt(t),Ie(e.info.sampleRate),bu(n),ln(0)])},FE=e=>Ot("stts",0,0,[Ie(e.timeToSampleTable.length),e.timeToSampleTable.map(t=>[Ie(t.sampleCount),Ie(t.sampleDelta)])]),zE=e=>{if(e.samples.every(n=>n.type==="key"))return null;let t=[...e.samples.entries()].filter(([,n])=>n.type==="key");return Ot("stss",0,0,[Ie(t.length),t.map(([n])=>Ie(n+1))])},OE=e=>Ot("stsc",0,0,[Ie(e.compactlyCodedChunkTable.length),e.compactlyCodedChunkTable.map(t=>[Ie(t.firstChunk),Ie(t.samplesPerChunk),Ie(1)])]),$E=e=>Ot("stsz",0,0,[Ie(0),Ie(e.samples.length),e.samples.map(t=>Ie(t.size))]),BE=e=>e.finalizedChunks.length>0&&_a(e.finalizedChunks).offset>=2**32?Ot("co64",0,0,[Ie(e.finalizedChunks.length),e.finalizedChunks.map(t=>Fo(t.offset))]):Ot("stco",0,0,[Ie(e.finalizedChunks.length),e.finalizedChunks.map(t=>Ie(t.offset))]),UE=e=>Ot("ctts",0,0,[Ie(e.compositionTimeOffsetTable.length),e.compositionTimeOffsetTable.map(t=>[Ie(t.sampleCount),Ie(t.sampleCompositionTimeOffset)])]),HE=e=>on("mvex",null,e.map(WE)),WE=e=>Ot("trex",0,0,[Ie(e.id),Ie(1),Ie(0),Ie(0),Ie(0)]),Vf=(e,t)=>on("moof",null,[VE(e),...t.map(ZE)]),VE=e=>Ot("mfhd",0,0,[Ie(e)]),Yp=e=>{let t=0,n=0,r=0,s=0,i=e.type==="delta";return n|=+i,i?t|=1:t|=2,t<<24|n<<16|r<<8|s},ZE=e=>on("traf",null,[YE(e),GE(e),qE(e)]),YE=e=>{let t=0;t|=8,t|=16,t|=32,t|=131072;let n=e.currentChunk.samples[1]??e.currentChunk.samples[0],r={duration:n.timescaleUnitsToNextSample,size:n.size,flags:Yp(n)};return Ot("tfhd",0,t,[Ie(e.id),Ie(r.duration),Ie(r.size),Ie(r.flags)])},GE=e=>Ot("tfdt",1,0,[Fo(jr(e.currentChunk.startTimestamp,e.timescale))]),qE=e=>{let t=e.currentChunk.samples.map(y=>y.timescaleUnitsToNextSample),n=e.currentChunk.samples.map(y=>y.size),r=e.currentChunk.samples.map(Yp),s=e.currentChunk.samples.map(y=>jr(y.presentationTimestamp-y.decodeTimestamp,e.timescale)),i=new Set(t),a=new Set(n),l=new Set(r),c=new Set(s),d=l.size===2&&r[0]!==r[1],h=i.size>1,u=a.size>1,m=!d&&l.size>1,g=c.size>1||[...c].some(y=>y!==0),p=0;return p|=1,p|=4*+d,p|=256*+h,p|=512*+u,p|=1024*+m,p|=2048*+g,Ot("trun",1,p,[Ie(e.currentChunk.samples.length),Ie(e.currentChunk.offset-e.currentChunk.moofOffset||0),d?Ie(r[0]):[],e.currentChunk.samples.map((y,w)=>[h?Ie(t[w]):[],u?Ie(n[w]):[],m?Ie(r[w]):[],g?lE(s[w]):[]])])},XE=e=>on("mfra",null,[...e.map(KE),QE()]),KE=(e,t)=>Ot("tfra",1,0,[Ie(e.id),Ie(63),Ie(e.finalizedChunks.length),e.finalizedChunks.map(r=>[Fo(jr(r.startTimestamp,e.timescale)),Fo(r.moofOffset),Ie(t+1),Ie(1),Ie(1)])]),QE=()=>Ot("mfro",0,0,[Ie(0)]),JE={avc:"avc1",hevc:"hvc1",vp9:"vp09",av1:"av01"},eP={avc:NE,hevc:AE,vp9:LE,av1:_E},tP={aac:"mp4a",opus:"Opus"},nP={aac:RE,opus:DE},el=class{},Gp=class extends el{constructor(){super(...arguments),this.buffer=null}},qp=class extends el{constructor(e){if(super(),this.options=e,typeof e!="object")throw new TypeError("StreamTarget requires an options object to be passed to its constructor.");if(e.onData){if(typeof e.onData!="function")throw new TypeError("options.onData, when provided, must be a function.");if(e.onData.length<2)throw new TypeError("options.onData, when provided, must be a function that takes in at least two arguments (data and position). Ignoring the position argument, which specifies the byte offset at which the data is to be written, can lead to broken outputs.")}if(e.chunked!==void 0&&typeof e.chunked!="boolean")throw new TypeError("options.chunked, when provided, must be a boolean.");if(e.chunkSize!==void 0&&(!Number.isInteger(e.chunkSize)||e.chunkSize<1024))throw new TypeError("options.chunkSize, when provided, must be an integer and not smaller than 1024.")}},rP=class extends el{constructor(e,t){if(super(),this.stream=e,this.options=t,!(e instanceof FileSystemWritableFileStream))throw new TypeError("FileSystemWritableFileStreamTarget requires a FileSystemWritableFileStream instance.");if(t!==void 0&&typeof t!="object")throw new TypeError("FileSystemWritableFileStreamTarget's options, when provided, must be an object.");if(t&&t.chunkSize!==void 0&&(!Number.isInteger(t.chunkSize)||t.chunkSize<=0))throw new TypeError("options.chunkSize, when provided, must be a positive integer")}},bo,qo,Xp=class{constructor(){this.pos=0,at(this,bo,new Uint8Array(8)),at(this,qo,new DataView(R(this,bo).buffer)),this.offsets=new WeakMap}seek(e){this.pos=e}writeU32(e){R(this,qo).setUint32(0,e,!1),this.write(R(this,bo).subarray(0,4))}writeU64(e){R(this,qo).setUint32(0,Math.floor(e/2**32),!1),R(this,qo).setUint32(4,e,!1),this.write(R(this,bo).subarray(0,8))}writeAscii(e){for(let t=0;t<e.length;t++)R(this,qo).setUint8(t%8,e.charCodeAt(t)),t%8===7&&this.write(R(this,bo));e.length%8!==0&&this.write(R(this,bo).subarray(0,e.length%8))}writeBox(e){if(this.offsets.set(e,this.pos),e.contents&&!e.children)this.writeBoxHeader(e,e.size??e.contents.byteLength+8),this.write(e.contents);else{let t=this.pos;if(this.writeBoxHeader(e,0),e.contents&&this.write(e.contents),e.children)for(let s of e.children)s&&this.writeBox(s);let n=this.pos,r=e.size??n-t;this.seek(t),this.writeBoxHeader(e,r),this.seek(n)}}writeBoxHeader(e,t){this.writeU32(e.largeSize?1:t),this.writeAscii(e.type),e.largeSize&&this.writeU64(t)}measureBoxHeader(e){return 8+(e.largeSize?8:0)}patchBox(e){let t=this.pos;this.seek(this.offsets.get(e)),this.writeBox(e),this.seek(t)}measureBox(e){if(e.contents&&!e.children)return this.measureBoxHeader(e)+e.contents.byteLength;{let t=this.measureBoxHeader(e);if(e.contents&&(t+=e.contents.byteLength),e.children)for(let n of e.children)n&&(t+=this.measureBox(n));return t}}};bo=new WeakMap;qo=new WeakMap;var ca,_o,li,$s,ua,wc,oP=class extends Xp{constructor(e){super(),at(this,ua),at(this,ca,void 0),at(this,_o,new ArrayBuffer(2**16)),at(this,li,new Uint8Array(R(this,_o))),at(this,$s,0),hn(this,ca,e)}write(e){ht(this,ua,wc).call(this,this.pos+e.byteLength),R(this,li).set(e,this.pos),this.pos+=e.byteLength,hn(this,$s,Math.max(R(this,$s),this.pos))}finalize(){ht(this,ua,wc).call(this,this.pos),R(this,ca).buffer=R(this,_o).slice(0,Math.max(R(this,$s),this.pos))}};ca=new WeakMap;_o=new WeakMap;li=new WeakMap;$s=new WeakMap;ua=new WeakSet;wc=function(e){let t=R(this,_o).byteLength;for(;t<e;)t*=2;if(t===R(this,_o).byteLength)return;let n=new ArrayBuffer(t),r=new Uint8Array(n);r.set(R(this,li),0),hn(this,_o,n),hn(this,li,r)};var sP=2**24,iP=2,Zs,Co,Bs,Vr,Kn,Ta,bc,Su,Kp,ku,Qp,Ys,Ra,Iu=class extends Xp{constructor(e){super(),at(this,Ta),at(this,Su),at(this,ku),at(this,Ys),at(this,Zs,void 0),at(this,Co,[]),at(this,Bs,void 0),at(this,Vr,void 0),at(this,Kn,[]),hn(this,Zs,e),hn(this,Bs,e.options?.chunked??!1),hn(this,Vr,e.options?.chunkSize??sP)}write(e){R(this,Co).push({data:e.slice(),start:this.pos}),this.pos+=e.byteLength}flush(){if(R(this,Co).length===0)return;let e=[],t=[...R(this,Co)].sort((n,r)=>n.start-r.start);e.push({start:t[0].start,size:t[0].data.byteLength});for(let n=1;n<t.length;n++){let r=e[e.length-1],s=t[n];s.start<=r.start+r.size?r.size=Math.max(r.size,s.start+s.data.byteLength-r.start):e.push({start:s.start,size:s.data.byteLength})}for(let n of e){n.data=new Uint8Array(n.size);for(let r of R(this,Co))n.start<=r.start&&r.start<n.start+n.size&&n.data.set(r.data,r.start-n.start);R(this,Bs)?(ht(this,Ta,bc).call(this,n.data,n.start),ht(this,Ys,Ra).call(this)):R(this,Zs).options.onData?.(n.data,n.start)}R(this,Co).length=0}finalize(){R(this,Bs)&&ht(this,Ys,Ra).call(this,!0)}};Zs=new WeakMap;Co=new WeakMap;Bs=new WeakMap;Vr=new WeakMap;Kn=new WeakMap;Ta=new WeakSet;bc=function(e,t){let n=R(this,Kn).findIndex(l=>l.start<=t&&t<l.start+R(this,Vr));n===-1&&(n=ht(this,ku,Qp).call(this,t));let r=R(this,Kn)[n],s=t-r.start,i=e.subarray(0,Math.min(R(this,Vr)-s,e.byteLength));r.data.set(i,s);let a={start:s,end:s+i.byteLength};if(ht(this,Su,Kp).call(this,r,a),r.written[0].start===0&&r.written[0].end===R(this,Vr)&&(r.shouldFlush=!0),R(this,Kn).length>iP){for(let l=0;l<R(this,Kn).length-1;l++)R(this,Kn)[l].shouldFlush=!0;ht(this,Ys,Ra).call(this)}i.byteLength<e.byteLength&&ht(this,Ta,bc).call(this,e.subarray(i.byteLength),t+i.byteLength)};Su=new WeakSet;Kp=function(e,t){let n=0,r=e.written.length-1,s=-1;for(;n<=r;){let i=Math.floor(n+(r-n+1)/2);e.written[i].start<=t.start?(n=i+1,s=i):r=i-1}for(e.written.splice(s+1,0,t),(s===-1||e.written[s].end<t.start)&&s++;s<e.written.length-1&&e.written[s].end>=e.written[s+1].start;)e.written[s].end=Math.max(e.written[s].end,e.written[s+1].end),e.written.splice(s+1,1)};ku=new WeakSet;Qp=function(e){let n={start:Math.floor(e/R(this,Vr))*R(this,Vr),data:new Uint8Array(R(this,Vr)),written:[],shouldFlush:!1};return R(this,Kn).push(n),R(this,Kn).sort((r,s)=>r.start-s.start),R(this,Kn).indexOf(n)};Ys=new WeakSet;Ra=function(e=!1){for(let t=0;t<R(this,Kn).length;t++){let n=R(this,Kn)[t];if(!(!n.shouldFlush&&!e)){for(let r of n.written)R(this,Zs).options.onData?.(n.data.subarray(r.start,r.end),n.start+r.start);R(this,Kn).splice(t--,1)}}};var aP=class extends Iu{constructor(e){super(new qp({onData:(t,n)=>e.stream.write({type:"write",data:t,position:n}),chunked:!0,chunkSize:e.options?.chunkSize}))}},Cc=1e3,lP=["avc","hevc","vp9","av1"],cP=["aac","opus"],uP=2082844800,dP=["strict","offset","cross-track-offset"],Be,Qe,Da,Xn,wn,fn,rs,cs,Mu,So,ko,Gs,Sc,Jp,kc,eg,ju,tg,Ic,ng,Eu,rg,da,Mc,vr,Or,Pu,og,qs,Fa,za,Nu,ws,bi,fa,jc,fP=class{constructor(e){if(at(this,Sc),at(this,kc),at(this,ju),at(this,Ic),at(this,Eu),at(this,da),at(this,vr),at(this,Pu),at(this,qs),at(this,za),at(this,ws),at(this,fa),at(this,Be,void 0),at(this,Qe,void 0),at(this,Da,void 0),at(this,Xn,void 0),at(this,wn,null),at(this,fn,null),at(this,rs,Math.floor(Date.now()/1e3)+uP),at(this,cs,[]),at(this,Mu,1),at(this,So,[]),at(this,ko,[]),at(this,Gs,!1),ht(this,Sc,Jp).call(this,e),e.video=Vs(e.video),e.audio=Vs(e.audio),e.fastStart=Vs(e.fastStart),this.target=e.target,hn(this,Be,{firstTimestampBehavior:"strict",...e}),e.target instanceof Gp)hn(this,Qe,new oP(e.target));else if(e.target instanceof qp)hn(this,Qe,new Iu(e.target));else if(e.target instanceof rP)hn(this,Qe,new aP(e.target));else throw new Error(`Invalid target: ${e.target}`);ht(this,Ic,ng).call(this),ht(this,kc,eg).call(this)}addVideoChunk(e,t,n,r){if(!(e instanceof EncodedVideoChunk))throw new TypeError("addVideoChunk's first argument (sample) must be of type EncodedVideoChunk.");if(t&&typeof t!="object")throw new TypeError("addVideoChunk's second argument (meta), when provided, must be an object.");if(n!==void 0&&(!Number.isFinite(n)||n<0))throw new TypeError("addVideoChunk's third argument (timestamp), when provided, must be a non-negative real number.");if(r!==void 0&&!Number.isFinite(r))throw new TypeError("addVideoChunk's fourth argument (compositionTimeOffset), when provided, must be a real number.");let s=new Uint8Array(e.byteLength);e.copyTo(s),this.addVideoChunkRaw(s,e.type,n??e.timestamp,e.duration,t,r)}addVideoChunkRaw(e,t,n,r,s,i){if(!(e instanceof Uint8Array))throw new TypeError("addVideoChunkRaw's first argument (data) must be an instance of Uint8Array.");if(t!=="key"&&t!=="delta")throw new TypeError("addVideoChunkRaw's second argument (type) must be either 'key' or 'delta'.");if(!Number.isFinite(n)||n<0)throw new TypeError("addVideoChunkRaw's third argument (timestamp) must be a non-negative real number.");if(!Number.isFinite(r)||r<0)throw new TypeError("addVideoChunkRaw's fourth argument (duration) must be a non-negative real number.");if(s&&typeof s!="object")throw new TypeError("addVideoChunkRaw's fifth argument (meta), when provided, must be an object.");if(i!==void 0&&!Number.isFinite(i))throw new TypeError("addVideoChunkRaw's sixth argument (compositionTimeOffset), when provided, must be a real number.");if(ht(this,fa,jc).call(this),!R(this,Be).video)throw new Error("No video track declared.");if(typeof R(this,Be).fastStart=="object"&&R(this,wn).samples.length===R(this,Be).fastStart.expectedVideoChunks)throw new Error(`Cannot add more video chunks than specified in 'fastStart' (${R(this,Be).fastStart.expectedVideoChunks}).`);let a=ht(this,da,Mc).call(this,R(this,wn),e,t,n,r,s,i);if(R(this,Be).fastStart==="fragmented"&&R(this,fn)){for(;R(this,ko).length>0&&R(this,ko)[0].decodeTimestamp<=a.decodeTimestamp;){let l=R(this,ko).shift();ht(this,vr,Or).call(this,R(this,fn),l)}a.decodeTimestamp<=R(this,fn).lastDecodeTimestamp?ht(this,vr,Or).call(this,R(this,wn),a):R(this,So).push(a)}else ht(this,vr,Or).call(this,R(this,wn),a)}addAudioChunk(e,t,n){if(!(e instanceof EncodedAudioChunk))throw new TypeError("addAudioChunk's first argument (sample) must be of type EncodedAudioChunk.");if(t&&typeof t!="object")throw new TypeError("addAudioChunk's second argument (meta), when provided, must be an object.");if(n!==void 0&&(!Number.isFinite(n)||n<0))throw new TypeError("addAudioChunk's third argument (timestamp), when provided, must be a non-negative real number.");let r=new Uint8Array(e.byteLength);e.copyTo(r),this.addAudioChunkRaw(r,e.type,n??e.timestamp,e.duration,t)}addAudioChunkRaw(e,t,n,r,s){if(!(e instanceof Uint8Array))throw new TypeError("addAudioChunkRaw's first argument (data) must be an instance of Uint8Array.");if(t!=="key"&&t!=="delta")throw new TypeError("addAudioChunkRaw's second argument (type) must be either 'key' or 'delta'.");if(!Number.isFinite(n)||n<0)throw new TypeError("addAudioChunkRaw's third argument (timestamp) must be a non-negative real number.");if(!Number.isFinite(r)||r<0)throw new TypeError("addAudioChunkRaw's fourth argument (duration) must be a non-negative real number.");if(s&&typeof s!="object")throw new TypeError("addAudioChunkRaw's fifth argument (meta), when provided, must be an object.");if(ht(this,fa,jc).call(this),!R(this,Be).audio)throw new Error("No audio track declared.");if(typeof R(this,Be).fastStart=="object"&&R(this,fn).samples.length===R(this,Be).fastStart.expectedAudioChunks)throw new Error(`Cannot add more audio chunks than specified in 'fastStart' (${R(this,Be).fastStart.expectedAudioChunks}).`);let i=ht(this,da,Mc).call(this,R(this,fn),e,t,n,r,s);if(R(this,Be).fastStart==="fragmented"&&R(this,wn)){for(;R(this,So).length>0&&R(this,So)[0].decodeTimestamp<=i.decodeTimestamp;){let a=R(this,So).shift();ht(this,vr,Or).call(this,R(this,wn),a)}i.decodeTimestamp<=R(this,wn).lastDecodeTimestamp?ht(this,vr,Or).call(this,R(this,fn),i):R(this,ko).push(i)}else ht(this,vr,Or).call(this,R(this,fn),i)}finalize(){if(R(this,Gs))throw new Error("Cannot finalize a muxer more than once.");if(R(this,Be).fastStart==="fragmented"){for(let t of R(this,So))ht(this,vr,Or).call(this,R(this,wn),t);for(let t of R(this,ko))ht(this,vr,Or).call(this,R(this,fn),t);ht(this,za,Nu).call(this,!1)}else R(this,wn)&&ht(this,qs,Fa).call(this,R(this,wn)),R(this,fn)&&ht(this,qs,Fa).call(this,R(this,fn));let e=[R(this,wn),R(this,fn)].filter(Boolean);if(R(this,Be).fastStart==="in-memory"){let t;for(let r=0;r<2;r++){let s=la(e,R(this,rs)),i=R(this,Qe).measureBox(s);t=R(this,Qe).measureBox(R(this,Xn));let a=R(this,Qe).pos+i+t;for(let l of R(this,cs)){l.offset=a;for(let{data:c}of l.samples)a+=c.byteLength,t+=c.byteLength}if(a<2**32)break;t>=2**32&&(R(this,Xn).largeSize=!0)}let n=la(e,R(this,rs));R(this,Qe).writeBox(n),R(this,Xn).size=t,R(this,Qe).writeBox(R(this,Xn));for(let r of R(this,cs))for(let s of r.samples)R(this,Qe).write(s.data),s.data=null}else if(R(this,Be).fastStart==="fragmented"){let t=R(this,Qe).pos,n=XE(e);R(this,Qe).writeBox(n);let r=R(this,Qe).pos-t;R(this,Qe).seek(R(this,Qe).pos-4),R(this,Qe).writeU32(r)}else{let t=R(this,Qe).offsets.get(R(this,Xn)),n=R(this,Qe).pos-t;R(this,Xn).size=n,R(this,Xn).largeSize=n>=2**32,R(this,Qe).patchBox(R(this,Xn));let r=la(e,R(this,rs));if(typeof R(this,Be).fastStart=="object"){R(this,Qe).seek(R(this,Da)),R(this,Qe).writeBox(r);let s=t-R(this,Qe).pos;R(this,Qe).writeBox(uE(s))}else R(this,Qe).writeBox(r)}ht(this,ws,bi).call(this),R(this,Qe).finalize(),hn(this,Gs,!0)}};Be=new WeakMap;Qe=new WeakMap;Da=new WeakMap;Xn=new WeakMap;wn=new WeakMap;fn=new WeakMap;rs=new WeakMap;cs=new WeakMap;Mu=new WeakMap;So=new WeakMap;ko=new WeakMap;Gs=new WeakMap;Sc=new WeakSet;Jp=function(e){if(typeof e!="object")throw new TypeError("The muxer requires an options object to be passed to its constructor.");if(!(e.target instanceof el))throw new TypeError("The target must be provided and an instance of Target.");if(e.video){if(!lP.includes(e.video.codec))throw new TypeError(`Unsupported video codec: ${e.video.codec}`);if(!Number.isInteger(e.video.width)||e.video.width<=0)throw new TypeError(`Invalid video width: ${e.video.width}. Must be a positive integer.`);if(!Number.isInteger(e.video.height)||e.video.height<=0)throw new TypeError(`Invalid video height: ${e.video.height}. Must be a positive integer.`);const t=e.video.rotation;if(typeof t=="number"&&![0,90,180,270].includes(t))throw new TypeError(`Invalid video rotation: ${t}. Has to be 0, 90, 180 or 270.`);if(Array.isArray(t)&&(t.length!==9||t.some(n=>typeof n!="number")))throw new TypeError(`Invalid video transformation matrix: ${t.join()}`);if(e.video.frameRate!==void 0&&(!Number.isInteger(e.video.frameRate)||e.video.frameRate<=0))throw new TypeError(`Invalid video frame rate: ${e.video.frameRate}. Must be a positive integer.`)}if(e.audio){if(!cP.includes(e.audio.codec))throw new TypeError(`Unsupported audio codec: ${e.audio.codec}`);if(!Number.isInteger(e.audio.numberOfChannels)||e.audio.numberOfChannels<=0)throw new TypeError(`Invalid number of audio channels: ${e.audio.numberOfChannels}. Must be a positive integer.`);if(!Number.isInteger(e.audio.sampleRate)||e.audio.sampleRate<=0)throw new TypeError(`Invalid audio sample rate: ${e.audio.sampleRate}. Must be a positive integer.`)}if(e.firstTimestampBehavior&&!dP.includes(e.firstTimestampBehavior))throw new TypeError(`Invalid first timestamp behavior: ${e.firstTimestampBehavior}`);if(typeof e.fastStart=="object"){if(e.video){if(e.fastStart.expectedVideoChunks===void 0)throw new TypeError("'fastStart' is an object but is missing property 'expectedVideoChunks'.");if(!Number.isInteger(e.fastStart.expectedVideoChunks)||e.fastStart.expectedVideoChunks<0)throw new TypeError("'expectedVideoChunks' must be a non-negative integer.")}if(e.audio){if(e.fastStart.expectedAudioChunks===void 0)throw new TypeError("'fastStart' is an object but is missing property 'expectedAudioChunks'.");if(!Number.isInteger(e.fastStart.expectedAudioChunks)||e.fastStart.expectedAudioChunks<0)throw new TypeError("'expectedAudioChunks' must be a non-negative integer.")}}else if(![!1,"in-memory","fragmented"].includes(e.fastStart))throw new TypeError("'fastStart' option must be false, 'in-memory', 'fragmented' or an object.");if(e.minFragmentDuration!==void 0&&(!Number.isFinite(e.minFragmentDuration)||e.minFragmentDuration<0))throw new TypeError("'minFragmentDuration' must be a non-negative number.")};kc=new WeakSet;eg=function(){if(R(this,Qe).writeBox(cE({holdsAvc:R(this,Be).video?.codec==="avc",fragmented:R(this,Be).fastStart==="fragmented"})),hn(this,Da,R(this,Qe).pos),R(this,Be).fastStart==="in-memory")hn(this,Xn,vc(!1));else if(R(this,Be).fastStart!=="fragmented"){if(typeof R(this,Be).fastStart=="object"){let e=ht(this,ju,tg).call(this);R(this,Qe).seek(R(this,Qe).pos+e)}hn(this,Xn,vc(!0)),R(this,Qe).writeBox(R(this,Xn))}ht(this,ws,bi).call(this)};ju=new WeakSet;tg=function(){if(typeof R(this,Be).fastStart!="object")return;let e=0,t=[R(this,Be).fastStart.expectedVideoChunks,R(this,Be).fastStart.expectedAudioChunks];for(let n of t)n&&(e+=8*Math.ceil(2/3*n),e+=4*n,e+=12*Math.ceil(2/3*n),e+=4*n,e+=8*n);return e+=4096,e};Ic=new WeakSet;ng=function(){if(R(this,Be).video&&hn(this,wn,{id:1,info:{type:"video",codec:R(this,Be).video.codec,width:R(this,Be).video.width,height:R(this,Be).video.height,rotation:R(this,Be).video.rotation??0,decoderConfig:null},timescale:R(this,Be).video.frameRate??57600,samples:[],finalizedChunks:[],currentChunk:null,firstDecodeTimestamp:void 0,lastDecodeTimestamp:-1,timeToSampleTable:[],compositionTimeOffsetTable:[],lastTimescaleUnits:null,lastSample:null,compactlyCodedChunkTable:[]}),R(this,Be).audio&&(hn(this,fn,{id:R(this,Be).video?2:1,info:{type:"audio",codec:R(this,Be).audio.codec,numberOfChannels:R(this,Be).audio.numberOfChannels,sampleRate:R(this,Be).audio.sampleRate,decoderConfig:null},timescale:R(this,Be).audio.sampleRate,samples:[],finalizedChunks:[],currentChunk:null,firstDecodeTimestamp:void 0,lastDecodeTimestamp:-1,timeToSampleTable:[],compositionTimeOffsetTable:[],lastTimescaleUnits:null,lastSample:null,compactlyCodedChunkTable:[]}),R(this,Be).audio.codec==="aac")){let e=ht(this,Eu,rg).call(this,2,R(this,Be).audio.sampleRate,R(this,Be).audio.numberOfChannels);R(this,fn).info.decoderConfig={codec:R(this,Be).audio.codec,description:e,numberOfChannels:R(this,Be).audio.numberOfChannels,sampleRate:R(this,Be).audio.sampleRate}}};Eu=new WeakSet;rg=function(e,t,n){let s=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350].indexOf(t),i=n,a="";a+=e.toString(2).padStart(5,"0"),a+=s.toString(2).padStart(4,"0"),s===15&&(a+=t.toString(2).padStart(24,"0")),a+=i.toString(2).padStart(4,"0");let l=Math.ceil(a.length/8)*8;a=a.padEnd(l,"0");let c=new Uint8Array(a.length/8);for(let d=0;d<a.length;d+=8)c[d/8]=parseInt(a.slice(d,d+8),2);return c};da=new WeakSet;Mc=function(e,t,n,r,s,i,a){let l=r/1e6,c=(r-(a??0))/1e6,d=s/1e6,h=ht(this,Pu,og).call(this,l,c,e);return l=h.presentationTimestamp,c=h.decodeTimestamp,i?.decoderConfig&&(e.info.decoderConfig===null?e.info.decoderConfig=i.decoderConfig:Object.assign(e.info.decoderConfig,i.decoderConfig)),{presentationTimestamp:l,decodeTimestamp:c,duration:d,data:t,size:t.byteLength,type:n,timescaleUnitsToNextSample:jr(d,e.timescale)}};vr=new WeakSet;Or=function(e,t){R(this,Be).fastStart!=="fragmented"&&e.samples.push(t);const n=jr(t.presentationTimestamp-t.decodeTimestamp,e.timescale);if(e.lastTimescaleUnits!==null){let s=jr(t.decodeTimestamp,e.timescale,!1),i=Math.round(s-e.lastTimescaleUnits);if(e.lastTimescaleUnits+=i,e.lastSample.timescaleUnitsToNextSample=i,R(this,Be).fastStart!=="fragmented"){let a=_a(e.timeToSampleTable);a.sampleCount===1?(a.sampleDelta=i,a.sampleCount++):a.sampleDelta===i?a.sampleCount++:(a.sampleCount--,e.timeToSampleTable.push({sampleCount:2,sampleDelta:i}));const l=_a(e.compositionTimeOffsetTable);l.sampleCompositionTimeOffset===n?l.sampleCount++:e.compositionTimeOffsetTable.push({sampleCount:1,sampleCompositionTimeOffset:n})}}else e.lastTimescaleUnits=0,R(this,Be).fastStart!=="fragmented"&&(e.timeToSampleTable.push({sampleCount:1,sampleDelta:jr(t.duration,e.timescale)}),e.compositionTimeOffsetTable.push({sampleCount:1,sampleCompositionTimeOffset:n}));e.lastSample=t;let r=!1;if(!e.currentChunk)r=!0;else{let s=t.presentationTimestamp-e.currentChunk.startTimestamp;if(R(this,Be).fastStart==="fragmented"){let i=R(this,wn)??R(this,fn);const a=R(this,Be).minFragmentDuration??1;e===i&&t.type==="key"&&s>=a&&(r=!0,ht(this,za,Nu).call(this))}else r=s>=.5}r&&(e.currentChunk&&ht(this,qs,Fa).call(this,e),e.currentChunk={startTimestamp:t.presentationTimestamp,samples:[]}),e.currentChunk.samples.push(t)};Pu=new WeakSet;og=function(e,t,n){const r=R(this,Be).firstTimestampBehavior==="strict",s=n.lastDecodeTimestamp===-1;if(r&&s&&t!==0)throw new Error(`The first chunk for your media track must have a timestamp of 0 (received DTS=${t}).Non-zero first timestamps are often caused by directly piping frames or audio data from a MediaStreamTrack into the encoder. Their timestamps are typically relative to the age of thedocument, which is probably what you want.

If you want to offset all timestamps of a track such that the first one is zero, set firstTimestampBehavior: 'offset' in the options.
`);if(R(this,Be).firstTimestampBehavior==="offset"||R(this,Be).firstTimestampBehavior==="cross-track-offset"){n.firstDecodeTimestamp===void 0&&(n.firstDecodeTimestamp=t);let a;R(this,Be).firstTimestampBehavior==="offset"?a=n.firstDecodeTimestamp:a=Math.min(R(this,wn)?.firstDecodeTimestamp??1/0,R(this,fn)?.firstDecodeTimestamp??1/0),t-=a,e-=a}if(t<n.lastDecodeTimestamp)throw new Error(`Timestamps must be monotonically increasing (DTS went from ${n.lastDecodeTimestamp*1e6} to ${t*1e6}).`);return n.lastDecodeTimestamp=t,{presentationTimestamp:e,decodeTimestamp:t}};qs=new WeakSet;Fa=function(e){if(R(this,Be).fastStart==="fragmented")throw new Error("Can't finalize individual chunks if 'fastStart' is set to 'fragmented'.");if(e.currentChunk){if(e.finalizedChunks.push(e.currentChunk),R(this,cs).push(e.currentChunk),(e.compactlyCodedChunkTable.length===0||_a(e.compactlyCodedChunkTable).samplesPerChunk!==e.currentChunk.samples.length)&&e.compactlyCodedChunkTable.push({firstChunk:e.finalizedChunks.length,samplesPerChunk:e.currentChunk.samples.length}),R(this,Be).fastStart==="in-memory"){e.currentChunk.offset=0;return}e.currentChunk.offset=R(this,Qe).pos;for(let t of e.currentChunk.samples)R(this,Qe).write(t.data),t.data=null;ht(this,ws,bi).call(this)}};za=new WeakSet;Nu=function(e=!0){if(R(this,Be).fastStart!=="fragmented")throw new Error("Can't finalize a fragment unless 'fastStart' is set to 'fragmented'.");let t=[R(this,wn),R(this,fn)].filter(l=>l&&l.currentChunk);if(t.length===0)return;let n=iE(this,Mu)._++;if(n===1){let l=la(t,R(this,rs),!0);R(this,Qe).writeBox(l)}let r=R(this,Qe).pos,s=Vf(n,t);R(this,Qe).writeBox(s);{let l=vc(!1),c=0;for(let h of t)for(let u of h.currentChunk.samples)c+=u.size;let d=R(this,Qe).measureBox(l)+c;d>=2**32&&(l.largeSize=!0,d=R(this,Qe).measureBox(l)+c),l.size=d,R(this,Qe).writeBox(l)}for(let l of t){l.currentChunk.offset=R(this,Qe).pos,l.currentChunk.moofOffset=r;for(let c of l.currentChunk.samples)R(this,Qe).write(c.data),c.data=null}let i=R(this,Qe).pos;R(this,Qe).seek(R(this,Qe).offsets.get(s));let a=Vf(n,t);R(this,Qe).writeBox(a),R(this,Qe).seek(i);for(let l of t)l.finalizedChunks.push(l.currentChunk),R(this,cs).push(l.currentChunk),l.currentChunk=null;e&&ht(this,ws,bi).call(this)};ws=new WeakSet;bi=function(){R(this,Qe)instanceof Iu&&R(this,Qe).flush()};fa=new WeakSet;jc=function(){if(R(this,Gs))throw new Error("Cannot add new video or audio chunks after the file has been finalized.")};const Xs=30,Zi=1e3/Xs,hP={low:20,medium:10,high:5,ultra:1};function Zf(e,t,n){const i=e*t*{low:.05,medium:.1,high:.2,ultra:.4}[n]*Xs,a={low:2e6,medium:5e6,high:15e6,ultra:3e7},l={low:1e7,medium:3e7,high:8e7,ultra:15e7};return Math.max(a[n],Math.min(l[n],i))}function mP(){const{gl:e,scene:t,camera:n,size:r}=mr(),s=rt(Y=>Y.screenshotTrigger),i=rt(Y=>Y.screenshotSize),a=rt(Y=>Y.screenshotFormat),l=rt(Y=>Y.screenshotHideLogo),c=rt(Y=>Y.setGetScreenshotBlob),d=rt(Y=>Y.setRecordGif),h=rt(Y=>Y.setStopRecording),u=rt(Y=>Y.setIsRecordingGif),m=rt(Y=>Y.setGifRenderProgress),g=rt(Y=>Y.setGifBlobUrl),p=rt(Y=>Y.gifDuration),y=rt(Y=>Y.gifDownsample),w=rt(Y=>Y.gifSpeed),x=rt(Y=>Y.recordingQuality),v=rt(Y=>Y.recordingFormat),k=f.useRef(0),b=f.useRef(null),S=f.useRef(null),C=f.useRef(0),M=f.useRef(0),I=f.useRef(null),L=f.useRef(2e3),P=f.useRef(2),_=f.useRef(1),N=f.useRef(0),D=f.useRef(null),B=f.useRef(null),E=f.useRef(0),Z=f.useRef(2e3),F=f.useRef([]),$=f.useRef(null),T=f.useRef(!1),z=f.useRef(1),H=f.useRef(0),O=f.useRef(0),J=f.useRef(null),re=f.useRef(null),q=f.useRef(null),ie=f.useRef(0),we=f.useRef(2e3),Ce=f.useRef(1),Re=f.useRef(0),ee=f.useRef(0),he=f.useRef(!1),Se=f.useRef(null),xe=f.useRef(0);f.useEffect(()=>{const Y=new Image;Y.src=no("LOGO.png"),Y.onload=()=>{b.current=Y}},[]);const Ae=f.useCallback((Y,W)=>{const le=Y.getContext("2d"),Q=b.current;if(Q&&!W){const pe=Y.height*fl.logoHeightPercent,Ne=Q.width/Q.height*pe,Je=Y.height*fl.paddingPercent;le.globalAlpha=fl.logoAlpha,le.drawImage(Q,Je,Y.height-pe-Je,Ne,pe),le.globalAlpha=1}},[]),ye=f.useCallback(async()=>{e.render(t,n);const Y=document.createElement("canvas");return Y.width=e.domElement.width,Y.height=e.domElement.height,Y.getContext("2d").drawImage(e.domElement,0,0),Ae(Y,l),new Promise(le=>{Y.toBlob(Q=>{le(Q)},"image/png")})},[e,t,n,l,Ae]);f.useEffect(()=>(c(ye),()=>c(null)),[ye,c]);const Pe=f.useCallback(()=>new Promise(Y=>{const W=Math.floor(e.domElement.width/y),le=Math.floor(e.domElement.height/y),Q=Math.min(navigator.hardwareConcurrency||4,8),pe=new sE({workers:Q,quality:hP[x],width:W,height:le,workerScript:no("gif.worker.js")});pe.on("finished",Ne=>{const Je=URL.createObjectURL(Ne);g(Je),m(null),u(!1),Y(Ne)}),pe.on("progress",Ne=>{const Je=Math.round(Ne*100);m(Je)}),pe.on("abort",()=>{m(null),u(!1),Y(null)}),S.current=pe,C.current=performance.now(),M.current=0,I.current=Y,L.current=p*1e3,P.current=y,_.current=w,N.current=0,xe.current=0,m(null),u(!0)}),[e,u,g,p,y,w,x]),Ye=f.useCallback(()=>typeof VideoEncoder<"u"&&typeof VideoFrame<"u",[]),$e=f.useCallback(()=>new Promise((Y,W)=>{const le=y,Q=Math.floor(e.domElement.width/le)&-2,pe=Math.floor(e.domElement.height/le)&-2,Ne=Zf(Q,pe,x);console.log(`WebCodecs recording: ${Q}x${pe}, bitrate=${(Ne/1e6).toFixed(1)}Mbps`);const Je=new fP({target:new Gp,video:{codec:"avc",width:Q,height:pe},fastStart:"in-memory"}),ke=new VideoEncoder({output:(ge,Xe)=>{Je.addVideoChunk(ge,Xe??void 0)},error:ge=>{console.error("VideoEncoder error:",ge),u(!1),he.current=!1,W(ge)}}),je=Q*pe;let jt="avc1.64001f";je>921600&&(jt="avc1.640028"),je>2073600&&(jt="avc1.640033");try{ke.configure({codec:jt,width:Q,height:pe,bitrate:Ne,framerate:Xs}),console.log(`VideoEncoder configured: ${jt}, ${Q}x${pe}, ${(Ne/1e6).toFixed(1)}Mbps`)}catch(ge){console.error("VideoEncoder configure failed:",ge),W(ge);return}const oe=document.createElement("canvas");oe.width=Q,oe.height=pe,J.current=ke,re.current=Je,q.current=oe,ie.current=performance.now(),we.current=p*1e3,Ce.current=w,Re.current=0,ee.current=0,he.current=!0,Se.current=Y,xe.current=0,u(!0)}),[e,p,y,w,x,u]),qe=f.useCallback(async()=>{if(!J.current||!re.current){console.log("finishWebCodecsRecording: refs already null");return}console.log(`WebCodecs recording complete: ${Re.current} frames`);const Y=J.current,W=re.current,le=Se.current;J.current=null,re.current=null,q.current=null,he.current=!1;try{console.log("Flushing encoder..."),await Y.flush(),console.log("Finalizing muxer..."),W.finalize();const{buffer:Q}=W.target;console.log("MP4 blob size:",Q.byteLength);const pe=new Blob([Q],{type:"video/mp4"}),Ne=URL.createObjectURL(pe);g(Ne),u(!1),le?.(pe)}catch(Q){console.error("Error finalizing WebCodecs recording:",Q),u(!1),le?.(null)}},[g,u]),ct=f.useCallback(Y=>new Promise(W=>{const le=y,Q=Math.floor(e.domElement.width/le),pe=Math.floor(e.domElement.height/le),Ne=document.createElement("canvas");Ne.width=Q,Ne.height=pe,B.current=Ne;const Je=Ne.captureStream(Xs);let ke,je;Y==="mp4"?MediaRecorder.isTypeSupported("video/mp4;codecs=avc1")?(ke="video/mp4;codecs=avc1",je="video/mp4"):MediaRecorder.isTypeSupported("video/mp4")?(ke="video/mp4",je="video/mp4"):(console.warn("MP4 not supported, falling back to WebM"),ke=MediaRecorder.isTypeSupported("video/webm;codecs=vp9")?"video/webm;codecs=vp9":"video/webm",je="video/webm"):(ke=MediaRecorder.isTypeSupported("video/webm;codecs=vp9")?"video/webm;codecs=vp9":"video/webm",je="video/webm");const jt=Zf(Q,pe,x);console.log(`MediaRecorder: ${Q}x${pe}, bitrate=${(jt/1e6).toFixed(1)}Mbps, format=${ke}`);const oe=new MediaRecorder(Je,{mimeType:ke,videoBitsPerSecond:jt});F.current=[],oe.ondataavailable=ge=>{ge.data.size>0&&F.current.push(ge.data)},oe.onstop=()=>{const ge=new Blob(F.current,{type:je}),Xe=URL.createObjectURL(ge);g(Xe),u(!1),T.current=!1,D.current=null,B.current=null,W(ge)},D.current=oe,E.current=performance.now(),O.current=0,Z.current=p*1e3,$.current=W,z.current=w,H.current=0,T.current=!0,xe.current=0,oe.start(),u(!0)}),[e,u,g,p,y,w,x]),K=f.useCallback(Y=>Y==="mp4"&&Ye()?(console.log("Using WebCodecs for MP4 recording"),$e()):(console.log(`Using MediaRecorder for ${Y} recording (WebCodecs supported: ${Ye()})`),ct(Y)),[Ye,$e,ct]),Le=f.useCallback(()=>v==="webm"||v==="mp4"?K(v):Pe(),[v,Pe,K]),fe=f.useCallback(()=>{if(console.log("Stop recording requested"),S.current){console.log(`Stopping GIF recording early: ${N.current} frames captured`),xe.current=0;const Y=S.current;S.current=null;try{N.current>0?(m(0),Ft.getState().addNotification("info",`Rendering ${N.current} frames...`,3e3),Y.render()):(u(!1),Ft.getState().addNotification("warning","No frames captured",2e3))}catch(W){console.error("gif.render() error:",W),m(null),u(!1)}return}if(he.current){console.log(`Stopping WebCodecs recording early: ${Re.current} frames captured`),xe.current=0,qe();return}if(T.current&&D.current){console.log("Stopping MediaRecorder recording early"),xe.current=0,D.current.stop();return}},[qe,m,u]),ae=f.useCallback((Y,W)=>{const le=Math.floor(Y/1e3),Q=Math.floor(W/1e3);Ft.getState().addNotification("info",`Recording: ${le}s / ${Q}s`,4500)},[]);pr(()=>{if(S.current){const W=performance.now()-C.current,le=L.current,Q=Math.floor(W/1e3);if(Q!==xe.current&&(Q>0&&Q%5===0&&ae(W,le),xe.current=Q),W>=le){xe.current=0;const pe=S.current;S.current=null;try{m(0),Ft.getState().addNotification("info",`Rendering ${N.current} frames...`,3e3),pe.render()}catch(Ne){console.error("gif.render() error:",Ne),m(null),u(!1)}return}if(W-M.current>=Zi){M.current=W;try{e.render(t,n);const pe=P.current,Ne=document.createElement("canvas");Ne.width=Math.floor(e.domElement.width/pe),Ne.height=Math.floor(e.domElement.height/pe);const Je=Ne.getContext("2d");Je.imageSmoothingEnabled=!0,Je.imageSmoothingQuality="high",Je.drawImage(e.domElement,0,0,Ne.width,Ne.height),Ae(Ne,l);const ke=Math.round(Zi/_.current);S.current?.addFrame(Ne,{delay:ke,copy:!0}),N.current++}catch(pe){console.warn("GIF frame capture failed:",pe)}}}if(he.current&&J.current&&q.current){const W=performance.now()-ie.current,le=Math.floor(W/1e3);if(le!==xe.current&&(console.log(`MP4: ${le}s, ${Re.current} frames`),le>0&&le%5===0&&ae(W,we.current),xe.current=le),W>=we.current){xe.current=0,qe();return}if(W-ee.current>=Zi){ee.current=W;try{e.render(t,n);const Q=q.current,pe=Q.getContext("2d");pe.imageSmoothingEnabled=!0,pe.imageSmoothingQuality="high",pe.drawImage(e.domElement,0,0,Q.width,Q.height),Ae(Q,l);const Ne=Math.round(Re.current*1e6/Xs/Ce.current),Je=new VideoFrame(Q,{timestamp:Ne});J.current?.encode(Je,{keyFrame:Re.current%30===0}),Je.close(),Re.current++}catch(Q){console.warn("WebCodecs frame capture failed:",Q)}}}if(T.current&&B.current&&D.current){const W=performance.now()-E.current,le=Z.current/z.current,Q=Math.floor(W/1e3);if(Q>0&&Q%5===0&&Q!==xe.current&&(xe.current=Q,ae(W,le)),W>=le){xe.current=0,D.current.stop();return}if(W-O.current>=Zi){O.current=W;try{e.render(t,n);const pe=B.current.getContext("2d");pe.imageSmoothingEnabled=!0,pe.imageSmoothingQuality="high",pe.drawImage(e.domElement,0,0,B.current.width,B.current.height),Ae(B.current,l)}catch(pe){console.warn("MediaRecorder frame capture failed:",pe)}}}}),f.useEffect(()=>(d(Le),()=>d(null)),[Le,d]),f.useEffect(()=>(h(fe),()=>h(null)),[fe,h]);const De=f.useCallback((Y,W,le)=>{Ae(Y,le);const Q=`image/${W}`,pe=W==="jpeg"?"jpg":W,Ne=W==="jpeg"?.92:void 0,Je=document.createElement("a");Je.download=`colmap-view-${new Date().toISOString().slice(0,19).replace(/[:-]/g,"")}.${pe}`,Je.href=Y.toDataURL(Q,Ne),Je.click()},[Ae]);return f.useEffect(()=>{if(s>0&&s!==k.current){k.current=s;let Y=r.width,W=r.height;if(i!=="current"){const[le,Q]=i.split("x").map(Number);Y=le,W=Q}if(i!=="current"){const le=new Pg(Y,W,{format:Ag,type:Ng}),Q=n.clone();Q.aspect=Y/W,Q.updateProjectionMatrix(),e.setRenderTarget(le),e.render(t,Q),e.setRenderTarget(null);const pe=new Uint8Array(Y*W*4);e.readRenderTargetPixels(le,0,0,Y,W,pe);const Ne=document.createElement("canvas");Ne.width=Y,Ne.height=W;const Je=Ne.getContext("2d"),ke=Je.createImageData(Y,W),je=Y*4;for(let jt=0;jt<W;jt++){const oe=(W-1-jt)*je,ge=jt*je;ke.data.set(pe.subarray(oe,oe+je),ge)}Je.putImageData(ke,0,0),De(Ne,a,l),le.dispose()}else{e.render(t,n);const le=document.createElement("canvas");le.width=e.domElement.width,le.height=e.domElement.height,le.getContext("2d").drawImage(e.domElement,0,0),De(le,a,l)}}},[s,i,a,l,e,t,n,r,De]),null}function pP(){const e=G(r=>r.setFps),t=f.useRef(0),n=f.useRef(performance.now());return pr(()=>{t.current++;const r=performance.now(),s=r-n.current;if(s>=500){const i=Math.round(t.current/s*1e3);e(i),t.current=0,n.current=r}}),null}function gP(){const t=G(n=>n.autoHideElements.buttons)?" idle-hideable":"";return o.jsxs(o.Fragment,{children:[o.jsx("a",{href:"https://opsiclear.com",target:"_blank",rel:"noopener noreferrer",className:Uo.logo+t,draggable:!1,children:o.jsx("img",{src:no("LOGO.png"),alt:"Opsiclear",className:Uo.logoImage,style:{height:lo.logoHeight},draggable:!1})}),o.jsxs("div",{className:Uo.socialContainer+t,children:[o.jsx("a",{href:"https://x.com/OpsiClear",target:"_blank",rel:"noopener noreferrer",className:Uo.socialLink,children:o.jsx("svg",{className:_t.socialSm,viewBox:"0 0 24 24",fill:"currentColor",children:o.jsx("path",{d:"M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"})})}),o.jsx("a",{href:"https://www.linkedin.com/company/opsiclear",target:"_blank",rel:"noopener noreferrer",className:Uo.socialLink,children:o.jsx("svg",{className:_t.social,viewBox:"0 0 24 24",fill:"currentColor",children:o.jsx("path",{d:"M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433a2.062 2.062 0 01-2.063-2.065 2.064 2.064 0 112.063 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"})})}),o.jsx("a",{href:"https://github.com/ColmapView/colmapview.github.io",target:"_blank",rel:"noopener noreferrer",className:Uo.socialLink,children:o.jsx("svg",{className:_t.social,viewBox:"0 0 24 24",fill:"currentColor",children:o.jsx("path",{d:"M12 0C5.37 0 0 5.37 0 12c0 5.31 3.435 9.795 8.205 11.385.6.105.825-.255.825-.57 0-.285-.015-1.23-.015-2.235-3.015.555-3.795-.735-4.035-1.41-.135-.345-.72-1.41-1.23-1.695-.42-.225-1.02-.78-.015-.795.945-.015 1.62.87 1.845 1.23 1.08 1.815 2.805 1.305 3.495.99.105-.78.42-1.305.765-1.605-2.67-.3-5.46-1.335-5.46-5.925 0-1.305.465-2.385 1.23-3.225-.12-.3-.54-1.53.12-3.18 0 0 1.005-.315 3.3 1.23.96-.27 1.98-.405 3-.405s2.04.135 3 .405c2.295-1.56 3.3-1.23 3.3-1.23.66 1.65.24 2.88.12 3.18.765.84 1.23 1.905 1.23 3.225 0 4.605-2.805 5.625-5.475 5.925.435.375.81 1.095.81 2.22 0 1.605-.015 2.895-.015 3.3 0 .315.225.69.825.57A12.02 12.02 0 0024 12c0-6.63-5.37-12-12-12z"})})})]})]})}const xP={view:"View & Navigation",display:"Display & Points",cameras:"Cameras",transform:"Transform",export:"Export",menu:"Menu"},Au=[{id:"resetView",label:"Reset View",section:"view",hotkey:ze.resetView.keys,icon:o.jsx(ii,{})},{id:"viewPosX",label:"View +X",section:"view",hotkey:ze.viewX.keys,icon:qk},{id:"viewPosY",label:"View +Y",section:"view",hotkey:ze.viewY.keys,icon:Xk},{id:"viewPosZ",label:"View +Z",section:"view",hotkey:ze.viewZ.keys,icon:Kk},{id:"toggleFullscreen",label:"Fullscreen",section:"view",hotkey:"F11",icon:o.jsx(uk,{})},{id:"toggleProjection",label:"Persp/Ortho",section:"view",icon:Qk},{id:"toggleCameraMode",label:"Camera Mode",section:"view",hotkey:ze.toggleCameraMode.keys,icon:Jk},{id:"toggleHorizonLock",label:"Horizon Lock",section:"view",icon:eI},{id:"cycleAutoRotate",label:"Auto Rotate",section:"view",icon:tI},{id:"toggleBackground",label:"Background",section:"display",hotkey:ze.toggleBackground.keys,icon:o.jsx(up,{})},{id:"toggleAxes",label:"Toggle Axes",section:"display",icon:o.jsx(cu,{})},{id:"toggleGallery",label:"Gallery Panel",section:"display",icon:nI},{id:"cycleCoordinateSystem",label:"Coord System",section:"display",icon:rI},{id:"cycleFrustumColor",label:"Frustum Color",section:"display",icon:oI},{id:"cyclePointColor",label:"Point Color",section:"display",hotkey:ze.cyclePointSize.keys,icon:sI},{id:"pointSizeUp",label:"Point Size +",section:"display",icon:o.jsx(mk,{})},{id:"pointSizeDown",label:"Point Size -",section:"display",icon:o.jsx(pk,{})},{id:"togglePointFiltering",label:"Min Track",section:"display",icon:o.jsx(dk,{})},{id:"cycleCameraDisplay",label:"Camera Display",section:"cameras",hotkey:ze.cycleCameraDisplay.keys,icon:o.jsx(lu,{})},{id:"cycleMatchesDisplay",label:"Matches",section:"cameras",hotkey:ze.cycleMatchesDisplay.keys,icon:iI},{id:"cycleSelectionColor",label:"Selection Color",section:"cameras",icon:aI},{id:"deselectAll",label:"Deselect All",section:"cameras",icon:lI},{id:"toggleImagePlanes",label:"Image Planes",section:"cameras",icon:cI},{id:"toggleUndistort",label:"Undistort (U)",section:"cameras",icon:uI},{id:"toggleGizmo",label:"Transform Gizmo",section:"transform",hotkey:ze.toggleGizmo.keys,icon:o.jsx(au,{})},{id:"centerAtOrigin",label:"Center at Origin",section:"transform",icon:dI},{id:"onePointOrigin",label:"1-Point Origin",section:"transform",icon:fI},{id:"twoPointScale",label:"2-Point Scale",section:"transform",icon:hI},{id:"threePointAlign",label:"3-Point Align",section:"transform",icon:mI},{id:"resetTransform",label:"Reset Transform",section:"transform",icon:o.jsx(ii,{})},{id:"applyTransform",label:"Apply Transform",section:"transform",icon:o.jsx(No,{})},{id:"reloadData",label:"Reload Data",section:"transform",icon:o.jsx(op,{})},{id:"openFloorDetection",label:"Floor Detection",section:"transform",icon:yI},{id:"takeScreenshot",label:"Screenshot",section:"export",icon:o.jsx(ip,{})},{id:"exportPLY",label:"Export PLY",section:"export",icon:pI},{id:"exportConfig",label:"Export Config",section:"export",icon:gI},{id:"openDeletion",label:"Delete Images",section:"export",icon:xI},{id:"openCameraConversion",label:"Camera Convert",section:"export",icon:vI},{id:"togglePointerLock",label:"Pointer Lock",section:"view",icon:o.jsx(gk,{})},{id:"flySpeedUp",label:"Fly Speed +",section:"view",icon:o.jsx(fk,{})},{id:"flySpeedDown",label:"Fly Speed -",section:"view",icon:o.jsx(hk,{})},{id:"editMenu",label:"Edit Menu...",section:"menu",icon:o.jsx(iu,{})}];function Yf(e){return Au.find(t=>t.id===e)}const yP=Au.filter(e=>e.id!=="editMenu");function vP(){const e=f.useRef(null),t=f.useRef(null),[n,r]=f.useState(null),[s,i]=f.useState({x:0,y:0}),[a,l]=f.useState(!1),c=f.useRef({x:0,y:0,posX:0,posY:0}),d=G(se=>se.contextMenuPosition),h=G(se=>se.contextMenuActions),u=G(se=>se.closeContextMenu),m=G(se=>se.addContextMenuAction),g=G(se=>se.removeContextMenuAction),p=G(se=>se.showContextMenuEditor),y=G(se=>se.openContextMenuEditor),w=G(se=>se.closeContextMenuEditor),{zIndex:x,bringToFront:v}=vi(p),k=du(),b=yi(),S=js(),C=Ga(),M=qa(),I=Xa(),L=fu(),P=hu(),_=mu(),N=Ka(),D=Cp(),B=Qa(),E=XI(),Z=G(se=>se.setView),F=G(se=>se.resetView),$=G(se=>se.backgroundColor),T=G(se=>se.setBackgroundColor),z=G(se=>se.toggleGalleryCollapsed),H=G(se=>se.galleryCollapsed),O=B.toggleVisible,J=I.coordinateSystem,re=B.setCoordinateSystem,q=I.labelMode,ie=B.setLabelMode,we=E.toggleVisible,Ce=M.visible,Re=D.setVisible,ee=M.displayMode,he=D.setDisplayMode,Se=C.projection,xe=N.setProjection,Ae=C.mode,ye=N.setMode,Pe=C.horizonLock,Ye=N.setHorizonLock,$e=C.autoRotateMode,qe=N.setAutoRotateMode,ct=C.pointerLock,K=N.setPointerLock,Le=C.flySpeed,fe=N.setFlySpeed,ae=N.flyToImage,De=b.visible,Y=P.setVisible,W=b.displayMode,le=P.setDisplayMode,Q=b.colorMode,pe=P.setColorMode,Ne=b.undistortionEnabled,Je=P.setUndistortionEnabled,ke=S.visible,je=_.setVisible,jt=S.colorMode,oe=_.setColorMode,ge=S.selectedImageId,Xe=_.setSelectedImageId,dt=k.visible,mt=L.setVisible,Rt=k.colorMode,xt=L.setColorMode,Xt=k.size,Dn=L.setSize,de=k.minTrackLength,Me=L.setMinTrackLength,Fe=mn(se=>se.resetTransform),_e=me(se=>se.droppedFiles),{processFiles:et}=Ms(),Ve=rt(se=>se.takeScreenshot),nt=rt(se=>se.setExportFormat),He=rt(se=>se.triggerExport),Ht=lt(se=>se.pickingMode),it=lt(se=>se.setPickingMode),pn=["colmap","opencv","threejs","opengl","blender","unity","unreal"],St=["off","xyz","extra"],sn=["single","byCamera"],qr=["toggleProjection","toggleCameraMode","toggleHorizonLock","cycleAutoRotate","toggleBackground","toggleAxes","toggleGallery","cycleCoordinateSystem","cycleFrustumColor","cyclePointColor","pointSizeUp","pointSizeDown","togglePointFiltering","cycleCameraDisplay","cycleMatchesDisplay","cycleSelectionColor","toggleImagePlanes","toggleUndistort","toggleGizmo","togglePointerLock","flySpeedUp","flySpeedDown"],Ge=f.useCallback(se=>{switch(se){case"resetView":F(),xe("perspective");break;case"viewPosX":Z("x");break;case"viewPosY":Z("y");break;case"viewPosZ":Z("z");break;case"toggleFullscreen":document.fullscreenElement?document.exitFullscreen():document.documentElement.requestFullscreen();break;case"toggleProjection":{const Ke=(Xi.indexOf(Se)+1)%Xi.length;xe(Xi[Ke]);break}case"toggleCameraMode":{const Ke=(qi.indexOf(Ae)+1)%qi.length;ye(qi[Ke]);break}case"toggleHorizonLock":{const Ke=(Qi.indexOf(Pe)+1)%Qi.length;Ye(Qi[Ke]);break}case"cycleAutoRotate":{const Ke=(Ki.indexOf($e)+1)%Ki.length;qe(Ki[Ke]);break}case"toggleBackground":{T($==="#ffffff"||$==="#fff"?so.outline:so.white);break}case"toggleAxes":O();break;case"toggleGallery":z();break;case"cycleAxisLabels":{const Ke=(St.indexOf(q)+1)%St.length;ie(St[Ke]);break}case"cycleCoordinateSystem":{const Ke=(pn.indexOf(J)+1)%pn.length;re(pn[Ke]);break}case"cycleFrustumColor":{const Ke=(sn.indexOf(Q)+1)%sn.length;pe(sn[Ke]);break}case"cyclePointColor":{dt?Rt==="rgb"?xt("error"):Rt==="error"?xt("trackLength"):mt(!1):(mt(!0),xt("rgb"));break}case"pointSizeUp":Dn(Math.min(Xt+1,20));break;case"pointSizeDown":Dn(Math.max(Xt-1,1));break;case"togglePointFiltering":Me(de===2?3:2);break;case"cycleCameraDisplay":{const Ke=(Ji.indexOf(W)+1)%Ji.length;le(Ji[Ke]);break}case"cycleMatchesDisplay":{Ce?ee==="static"?he("blink"):Re(!1):(Re(!0),he("static"));break}case"cycleSelectionColor":{if(!ke)je(!0),oe("static");else{const We=ea.indexOf(jt);We===ea.length-1?je(!1):oe(ea[We+1])}break}case"deselectAll":Xe(null);break;case"toggleImagePlanes":{De?W==="frustum"?le("imageplane"):Y(!1):(Y(!0),le("frustum"));break}case"toggleUndistort":Je(!Ne);break;case"toggleGizmo":we();break;case"centerAtOrigin":Xh();break;case"onePointOrigin":it(Ht==="origin-1pt"?"off":"origin-1pt");break;case"twoPointScale":it(Ht==="distance-2pt"?"off":"distance-2pt");break;case"threePointAlign":it(Ht==="normal-3pt"?"off":"normal-3pt");break;case"resetTransform":Fe();break;case"applyTransform":wa();break;case"reloadData":_e&&(Fe(),et(_e));break;case"takeScreenshot":Ve();break;case"exportPLY":nt("ply"),He();break;case"exportConfig":nt("config"),He();break;case"togglePointerLock":K(!ct);break;case"flySpeedUp":fe(Math.min(Le*1.5,20));break;case"flySpeedDown":fe(Math.max(Le/1.5,.5));break;case"openDeletion":G.getState().setShowDeletionModal(!0);break;case"openFloorDetection":G.getState().setShowFloorModal(!0);break;case"openCameraConversion":G.getState().setShowConversionModal(!0);break;case"editMenu":y();break}!qr.includes(se)&&se!=="editMenu"&&u()},[F,Z,Se,xe,Ae,ye,Pe,Ye,$e,qe,$,T,O,J,re,q,ie,Q,pe,z,dt,mt,Rt,xt,Xt,Dn,de,Me,W,le,Ce,Re,ee,he,ke,je,jt,oe,ge,Xe,ae,Ne,Je,we,Ht,it,Fe,_e,et,Ve,nt,He,ct,K,Le,fe,u]),ot=f.useCallback(se=>{h.includes(se)?g(se):m(se)},[h,m,g]),Ee=f.useCallback(()=>{w(),u()},[u,w]);f.useEffect(()=>{if(p){const se=window.innerWidth,We=window.innerHeight;i({x:Math.max(20,(se-600)/2),y:Math.max(20,(We-500)/2)}),requestAnimationFrame(()=>{if(t.current){const Ke=t.current.getBoundingClientRect();i({x:Math.max(20,(se-Ke.width)/2),y:Math.max(20,(We-Ke.height)/2)})}})}},[p]);const Ze=f.useCallback(se=>{se.preventDefault(),l(!0),c.current={x:se.clientX,y:se.clientY,posX:s.x,posY:s.y}},[s]);if(f.useEffect(()=>{if(!a)return;const se=Ke=>{i({x:c.current.posX+Ke.clientX-c.current.x,y:c.current.posY+Ke.clientY-c.current.y})},We=()=>l(!1);return window.addEventListener("mousemove",se),window.addEventListener("mouseup",We),()=>{window.removeEventListener("mousemove",se),window.removeEventListener("mouseup",We)}},[a]),f.useEffect(()=>{if(!d&&!p)return;const se=En=>{const Wt=En.target,Pn=e.current&&!e.current.contains(Wt),gn=t.current&&!t.current.contains(Wt);p?gn&&Ee():Pn&&u()},We=En=>{En.key==="Escape"&&(p?Ee():u())},Ke=setTimeout(()=>{document.addEventListener("mousedown",se),document.addEventListener("keydown",We)},0);return()=>{clearTimeout(Ke),document.removeEventListener("mousedown",se),document.removeEventListener("keydown",We)}},[d,p,u,Ee]),f.useLayoutEffect(()=>{if(!d||!e.current){r(null);return}const We=e.current.getBoundingClientRect(),Ke=window.innerHeight,En=window.innerWidth,Wt=8,Pn=We.width>0?We.width:200,gn=We.height>0?We.height:400,j=H?0:Math.max(En*.3,300),V=En-j;let ne=d.x,be=d.y;be+gn>Ke-Wt&&(be=d.y-gn,be<Wt&&(be=Wt)),ne+Pn>V-Wt&&(ne=d.x-Pn,ne<Wt&&(ne=Wt)),r({x:ne,y:be})},[d,h,H]),!d&&!p)return null;const $t=new Map(Au.map((se,We)=>[se.id,We])),Dt=h.map(se=>Yf(se)).filter(se=>se!==void 0),qt=["view","display","cameras","transform","export"],yt=qt.map(se=>{const We=Dt.filter(Ke=>Ke.section===se);return We.sort((Ke,En)=>($t.get(Ke.id)??999)-($t.get(En.id)??999)),{section:se,actions:We}}).filter(se=>se.actions.length>0),Et=Yf("editMenu"),ut=qt.map(se=>({section:se,label:xP[se],actions:yP.filter(We=>We.section===se)})).filter(se=>se.actions.length>0);if(p){const se=j=>o.jsxs("label",{className:"flex items-center gap-2 cursor-pointer hover-ds-hover rounded px-2 py-1",style:{breakInside:"avoid"},children:[o.jsx("span",{className:"w-4 h-4 flex-shrink-0 opacity-60",children:j.icon}),o.jsx("span",{className:"text-sm text-ds-primary whitespace-nowrap",children:j.label}),j.hotkey&&o.jsxs("span",{className:"text-xs font-mono text-gray-500 uppercase tracking-wide",children:["(",ql(j.hotkey),")"]}),o.jsx("span",{className:"ml-auto",children:o.jsx(ls,{checked:h.includes(j.id),onChange:()=>ot(j.id)})})]},j.id),We=(j,V=1)=>{const ne=Math.ceil(j.actions.length/V),be=[];for(let bt=0;bt<V;bt++)be.push(j.actions.slice(bt*ne,(bt+1)*ne));return o.jsxs("div",{className:"col-span-3",children:[o.jsx("div",{className:"text-xs font-medium text-ds-muted uppercase tracking-wide mb-1 px-1",children:j.label}),o.jsx("div",{className:"grid gap-x-4",style:{gridTemplateColumns:`repeat(${V}, minmax(180px, 1fr))`},children:be.map((bt,Bt)=>o.jsx("div",{children:bt.map(se)},Bt))})]},j.section)},Ke=ut.find(j=>j.section==="view"),En=ut.find(j=>j.section==="display"),Wt=ut.find(j=>j.section==="cameras"),Pn=ut.find(j=>j.section==="transform"),gn=ut.find(j=>j.section==="export");return Qs.createPortal(o.jsx("div",{className:"fixed inset-0 pointer-events-none",style:{zIndex:x},children:o.jsxs("div",{ref:t,className:ft.toolPanel+" context-menu-edit-responsive",style:{left:s.x,top:s.y},onMouseDown:v,children:[o.jsxs("div",{className:ft.toolHeader,onMouseDown:Ze,children:[o.jsx("span",{className:ft.toolHeaderTitle,children:"Edit Context Menu"}),o.jsx("button",{onClick:Ee,onMouseDown:j=>j.stopPropagation(),className:ft.toolHeaderClose,title:"Close",children:o.jsx("svg",{className:"w-3.5 h-3.5",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2.5",strokeLinecap:"round",children:o.jsx("path",{d:"M18 6L6 18M6 6l12 12"})})})]}),o.jsxs("div",{className:"p-4 overflow-y-auto",style:{maxHeight:"calc(100vh - 120px)"},children:[o.jsx("div",{className:"text-ds-secondary text-xs mb-3",children:"Select which actions appear in the right-click menu."}),o.jsxs("div",{className:"grid grid-cols-3 gap-x-5 gap-y-3",children:[Ke&&We(Ke,3),En&&We(En,3),Wt&&We(Wt,3),Pn&&We(Pn,3),gn&&We(gn,3)]}),o.jsx("div",{className:"mt-4 pt-3",children:o.jsx("button",{onClick:Ee,className:ft.actionButtonPrimary,children:"Done"})})]})]})}),document.body)}const Pt=n??d;return o.jsxs("div",{ref:e,className:Lt.container,"data-testid":"context-menu",style:{position:"fixed",left:Pt?.x??0,top:Pt?.y??0,zIndex:Rn.contextMenu,minWidth:"160px",visibility:n?"visible":"hidden"},children:[yt.map((se,We)=>o.jsxs("div",{children:[We>0&&o.jsx("div",{className:"border-t border-ds my-1"}),se.actions.map(Ke=>o.jsxs("button",{className:Lt.button,onClick:()=>Ge(Ke.id),children:[o.jsx("span",{className:Lt.icon,children:Ke.icon}),o.jsx("span",{className:"flex-1",children:Ke.label}),Ke.hotkey&&o.jsxs("span",{className:Lt.hotkey,children:["(",ql(Ke.hotkey),")"]})]},Ke.id))]},se.section)),o.jsx("div",{className:"border-t border-ds my-1"}),o.jsxs("button",{className:Lt.button,onClick:()=>Ge("editMenu"),children:[o.jsx("span",{className:Lt.icon,children:Et.icon}),Et.label]})]})}class wP extends f.Component{canvasRef=f.createRef();contextLostHandler=null;contextRestoredHandler=null;constructor(t){super(t),this.state={hasError:!1,error:null,errorType:null,retryCount:0}}static getDerivedStateFromError(t){const n=uu(t);return{hasError:!0,error:t,errorType:n}}componentDidMount(){this.setupWebGLContextListeners()}componentDidUpdate(t){t.children!==this.props.children&&this.setupWebGLContextListeners()}componentWillUnmount(){this.cleanupWebGLContextListeners()}componentDidCatch(t,n){console.error("Scene3DErrorBoundary caught an error:",t,n)}setupWebGLContextListeners(){this.cleanupWebGLContextListeners();const t=this.canvasRef.current;if(!t)return;const n=t.querySelectorAll("canvas");n.length!==0&&(this.contextLostHandler=r=>{r.preventDefault(),console.warn("WebGL context lost"),this.setState({hasError:!0,error:new Error("WebGL context lost"),errorType:"webgl_context_lost"})},this.contextRestoredHandler=()=>{console.info("WebGL context restored"),this.handleRetry()},n.forEach(r=>{r.addEventListener("webglcontextlost",this.contextLostHandler),r.addEventListener("webglcontextrestored",this.contextRestoredHandler)}))}cleanupWebGLContextListeners(){const t=this.canvasRef.current;if(!t)return;t.querySelectorAll("canvas").forEach(r=>{this.contextLostHandler&&r.removeEventListener("webglcontextlost",this.contextLostHandler),this.contextRestoredHandler&&r.removeEventListener("webglcontextrestored",this.contextRestoredHandler)})}handleRetry=()=>{this.setState(t=>({hasError:!1,error:null,errorType:null,retryCount:t.retryCount+1}))};handleReload=()=>{window.location.reload()};render(){const{children:t,backgroundColor:n}=this.props,{hasError:r,error:s,errorType:i,retryCount:a}=this.state;if(r){const l=ys(i||"webgl_render_error"),c=a>=2;return o.jsx("div",{className:"w-full h-full flex flex-col items-center justify-center",style:{backgroundColor:n??"var(--ds-secondary)"},children:o.jsxs("div",{className:"text-center max-w-md px-4",children:[o.jsx("div",{className:Un.icon,children:"!"}),o.jsx("h2",{className:Un.title,children:l.title}),o.jsx("p",{className:Un.message,children:s?.message??l.message}),c&&o.jsx("p",{className:"text-ds-warning text-sm mb-4",children:"Multiple retry attempts failed. Consider reloading the page."}),o.jsxs("div",{className:"flex gap-3 justify-center mt-4",children:[o.jsx("button",{onClick:this.handleRetry,className:Un.button,children:l.retryLabel??"Retry"}),o.jsx("button",{onClick:this.handleReload,className:`${ue.base} ${ue.sizes.md} ${ue.variants.ghost}`,children:l.reloadLabel??"Reload Page"})]})]})})}return o.jsx("div",{ref:this.canvasRef,className:"w-full h-full",children:t})}}function bP(){const e=lt(_=>_.showDistanceModal),t=lt(_=>_.modalPosition),n=lt(_=>_.setShowDistanceModal),r=lt(_=>_.selectedPoints),s=lt(_=>_.setTargetDistance),i=lt(_=>_.pickingMode),a=lt(_=>_.clearSelectedPoints),l=lt(_=>_.normalFlipped),c=lt(_=>_.targetAxis),d=lt(_=>_.reset),h=mn(_=>_.transform),u=mn(_=>_.setTransform),m=G(_=>_.axesCoordinateSystem),g=i==="origin-1pt",p=i==="normal-3pt",y=f.useMemo(()=>{const _=Ja[m],N=c.toLowerCase(),D=_[N];return new X(D[0],D[1],D[2])},[m,c]),[w,x]=f.useState(""),v=f.useRef(null),{position:k,panelRef:b,handleDragStart:S}=wi({estimatedWidth:200,estimatedHeight:80,isOpen:e,initialPosition:t}),C=r.length===2?r[0].position.distanceTo(r[1].position):null;f.useEffect(()=>{e&&v.current&&setTimeout(()=>{v.current?.focus(),v.current?.select()},50)},[e]),f.useEffect(()=>{e&&C!==null&&x(C.toFixed(4))},[e]);const M=f.useCallback(()=>{n(!1),d()},[n,d]);kt("escape",()=>M(),{enabled:e},[e,M]);const I=f.useCallback(()=>{n(!1),a()},[n,a]),L=f.useCallback(()=>{if(g){if(r.length!==1)return;const _=i0(r[0].position),N=Hr(h),D=is(_,N),B=ss(D);u(B),n(!1),d()}else if(p){if(r.length!==3)return;const _=a0(r[0].position,r[1].position,r[2].position,l,y),N=Hr(h),D=is(_,N),B=ss(D);u(B),n(!1),d()}else{const _=parseFloat(w);if(isNaN(_)||_<=0||r.length!==2)return;const N=s0(r[0].position,r[1].position,_),D=Hr(h),B=is(N,D),E=ss(B);u(E),s(_),n(!1),d()}},[g,p,w,r,l,h,u,s,n,d,y]),P=f.useCallback(_=>{_.key==="Enter"&&L()},[L]);return e?o.jsx("div",{ref:b,className:"fixed bg-ds-tertiary border border-ds rounded shadow-ds-lg p-1",style:{left:k.x,top:k.y,zIndex:Rn.modalOverlay},onPointerDown:S,children:o.jsxs("div",{className:"flex items-center gap-0.5",children:[!g&&!p&&o.jsx("input",{ref:v,type:"text",value:w,onChange:_=>x(_.target.value),onKeyDown:P,onPointerDown:_=>_.stopPropagation(),className:`${cn.valueInput} w-14 font-mono`,title:"Target distance"}),o.jsx("button",{onClick:L,className:ft.iconButtonConfirm,title:"Confirm",children:o.jsx("svg",{className:"w-3.5 h-3.5",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2.5",children:o.jsx("path",{d:"M20 6L9 17l-5-5"})})}),o.jsx("button",{onClick:I,className:ft.iconButtonRetry,title:"Retry",children:o.jsxs("svg",{className:"w-3.5 h-3.5",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2.5",children:[o.jsx("path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"}),o.jsx("path",{d:"M3 3v5h5"})]})}),o.jsx("button",{onClick:M,className:ft.iconButtonCancel,title:"Cancel",children:o.jsx(Oo,{className:"w-3.5 h-3.5"})})]})}):null}const Gf=20;function CP(){const e=f.useRef(null),t=f.useRef(void 0),n=f.useRef(null),r=f.useRef(!1),s=f.useRef(G.getState().idleHideTimeout);f.useEffect(()=>G.subscribe(l=>{s.current=l.idleHideTimeout,l.idleHideTimeout===0&&e.current&&(clearTimeout(t.current),e.current.dataset.idle="false",G.getState().setIsIdle(!1))}),[]);const i=f.useCallback(()=>{if(!e.current)return;const c=s.current;clearTimeout(t.current),!(c<=0)&&(t.current=setTimeout(()=>{e.current&&!r.current&&(e.current.dataset.idle="true",G.getState().setIsIdle(!0))},c*1e3))},[]),a=f.useCallback(()=>{const l=e.current;l&&(l.dataset.idle="false",G.getState().setIsIdle(!1),i())},[i]);return f.useEffect(()=>{const l=e.current;if(!l)return;a();const c=()=>{n.current=null,a()},d=g=>{if(!n.current){n.current={x:g.clientX,y:g.clientY};return}const p=g.clientX-n.current.x,y=g.clientY-n.current.y;p*p+y*y>Gf*Gf&&(n.current={x:g.clientX,y:g.clientY},a())},h=()=>{document.pointerLockElement?(clearTimeout(t.current),e.current&&(e.current.dataset.idle="true",e.current.dataset.pointerLocked="true",G.getState().setIsIdle(!0))):(e.current&&(e.current.dataset.pointerLocked="false"),a())},u=g=>{g.target.closest?.(".idle-hideable")&&(r.current=!0,clearTimeout(t.current),e.current&&(e.current.dataset.idle="false",G.getState().setIsIdle(!1)))},m=g=>{g.relatedTarget?.closest?.(".idle-hideable")||(r.current=!1,i())};return l.addEventListener("pointerdown",c,{passive:!0}),l.addEventListener("pointerup",c,{passive:!0}),l.addEventListener("pointermove",d,{passive:!0}),l.addEventListener("keydown",c,{passive:!0}),l.addEventListener("wheel",c,{passive:!0}),l.addEventListener("mouseover",u,{passive:!0}),l.addEventListener("mouseout",m,{passive:!0}),document.addEventListener("pointerlockchange",h),()=>{clearTimeout(t.current),l.removeEventListener("pointerdown",c),l.removeEventListener("pointerup",c),l.removeEventListener("pointermove",d),l.removeEventListener("keydown",c),l.removeEventListener("wheel",c),l.removeEventListener("mouseover",u),l.removeEventListener("mouseout",m),document.removeEventListener("pointerlockchange",h)}},[a,i]),e}function SP(){const e=me(v=>v.reconstruction),t=me(v=>v.wasmReconstruction),n=Ip(),r=f.useMemo(()=>{if(!e)return{center:[0,0,0],radius:5};const v=Array.from(e.images.values());if(v.length>0){const k=[],b=[],S=[];for(const B of v){const E=ds(B);k.push(E.x),b.push(E.y),S.push(E.z)}const C=[os(k),os(b),os(S)],M=[...k].sort((B,E)=>B-E),I=[...b].sort((B,E)=>B-E),L=[...S].sort((B,E)=>B-E),P=xo(M,95)-xo(M,5),_=xo(I,95)-xo(I,5),N=xo(L,95)-xo(L,5),D=Math.max(P,_,N,.001)/2;return{center:C,radius:D}}if(t?.hasPoints()){const k=t.getBoundingBox();if(k){const b=[(k.minX+k.maxX)/2,(k.minY+k.maxY)/2,(k.minZ+k.maxZ)/2],S=Math.max(k.maxX-k.minX,k.maxY-k.minY,k.maxZ-k.minZ)/2;return{center:b,radius:Math.max(S,.001)}}}if(e.points3D&&e.points3D.size>0){let k=1/0,b=-1/0,S=1/0,C=-1/0,M=1/0,I=-1/0;for(const _ of e.points3D.values())k=Math.min(k,_.xyz[0]),b=Math.max(b,_.xyz[0]),S=Math.min(S,_.xyz[1]),C=Math.max(C,_.xyz[1]),M=Math.min(M,_.xyz[2]),I=Math.max(I,_.xyz[2]);const L=[(k+b)/2,(S+C)/2,(M+I)/2],P=Math.max(b-k,C-S,I-M)/2;return{center:L,radius:P}}return{center:[0,0,0],radius:5}},[e,t]),s=yi(),i=Xa(),a=bp(),l=YI(),c=G(v=>v.isIdle),d=G(v=>v.autoHideElements),h=G(v=>v.showAutoHideEditor),u=f.useCallback(v=>(c||h)&&d[v],[c,h,d]),m=G(v=>v.viewResetTrigger),g=G(v=>v.viewDirection),p=G(v=>v.viewTrigger),y=mn(v=>v.transform),{transformMatrix:w,transformedCenter:x}=f.useMemo(()=>{if(mi(y))return{transformMatrix:null,transformedCenter:r.center};const v=Hr(y),k=o0(v),b=Ch(v,r.center);return{transformMatrix:k,transformedCenter:b}},[y,r.center]);return o.jsxs(o.Fragment,{children:[o.jsx("ambientLight",{intensity:Wn.light.ambient}),o.jsx("directionalLight",{position:[10,10,5],intensity:Wn.light.directional}),w?o.jsxs("group",{matrixAutoUpdate:!1,matrix:w,children:[!u("points")&&o.jsx(hf,{}),!n&&s.visible&&!u("cameras")&&o.jsx(If,{}),!n&&s.visible&&!u("matches")&&o.jsx(Mf,{}),!n&&s.visible&&!u("rigs")&&o.jsx(jf,{})]}):o.jsxs(o.Fragment,{children:[!u("points")&&o.jsx(hf,{}),!n&&s.visible&&!u("cameras")&&o.jsx(If,{}),!n&&s.visible&&!u("matches")&&o.jsx(Mf,{}),!n&&s.visible&&!u("rigs")&&o.jsx(jf,{})]}),o.jsxs(f.Suspense,{fallback:null,children:[(i.visible||n)&&!u("axes")&&o.jsx(Zj,{size:r.radius*i.scale,scale:i.scale,coordinateSystem:i.coordinateSystem,labelMode:i.labelMode}),a.visible&&!u("grid")&&o.jsx(Yj,{size:r.radius,scale:a.scale})]}),!n&&e&&l.visible&&!u("gizmo")&&o.jsx(Gj,{center:x,size:r.radius*y.scale*i.scale}),o.jsx(Qj,{}),o.jsx(eE,{boundsRadius:r.radius}),o.jsx(Oj,{target:r.center,radius:r.radius,resetTrigger:m,viewDirection:g,viewTrigger:p})]})}function kP(){return o.jsxs("mesh",{children:[o.jsx("boxGeometry",{args:[1,1,1]}),o.jsx("meshBasicMaterial",{color:st.wireframe,wireframe:!0})]})}function IP({color:e}){const{scene:t,invalidate:n}=mr();return f.useEffect(()=>{t.background=new Er(e),n()},[t,e,n]),null}function qf(){const e=me(I=>I.reconstruction),t=G(I=>I.backgroundColor),n=ce(I=>I.setSelectedImageId),r=G(I=>I.openContextMenu),s=G(I=>I.closeContextMenu),i=G(I=>I.showAutoHideEditor),a=lt(I=>I.pickingMode),l=lt(I=>I.selectedPoints.length),c=lt(I=>I.removeLastPoint),d=lt(I=>I.reset),h=lt(I=>I.markerRightClickHandled),u=G(I=>I.touchMode),m=CP(),g=f.useRef(null),p=5,y=f.useRef(null),w=me(I=>I.wasmReconstruction),x=f.useMemo(()=>{if(w?.hasPoints()){const L=w.getBoundingBox();if(L)return[0,0,Math.max(Math.abs(L.minX),Math.abs(L.maxX),Math.abs(L.minY),Math.abs(L.maxY),Math.abs(L.minZ),Math.abs(L.maxZ))*2]}if(!e||!e.points3D||e.points3D.size===0)return[0,0,5];let I=0;for(const L of e.points3D.values()){const P=Math.sqrt(L.xyz[0]**2+L.xyz[1]**2+L.xyz[2]**2);I=Math.max(I,P)}return[0,0,I*2]},[e,w]),v=f.useCallback(I=>{if(g.current){const L=Math.abs(I.clientX-g.current.x),P=Math.abs(I.clientY-g.current.y);if(L>p||P>p)return}if(I.preventDefault(),a!=="off"){if(h){lt.setState({markerRightClickHandled:!1});return}l>0?c():d();return}r(I.clientX,I.clientY)},[r,a,l,c,d,h]),k=f.useCallback(I=>{I.button===2&&(g.current={x:I.clientX,y:I.clientY},s())},[s]),b=f.useCallback(()=>{setTimeout(()=>{g.current=null},0)},[]),S=f.useCallback(I=>{if(I.pointerType!=="touch"||SM())return;s();const L=I.clientX,P=I.clientY,_=setTimeout(()=>{if(y.current=null,a!=="off"){l>0?c():d();return}r(L,P)},It.longPressDelay);y.current={x:L,y:P,timer:_}},[s,a,l,c,d,r]),C=f.useCallback(I=>{if(y.current&&I.pointerType==="touch"){const L=I.clientX-y.current.x,P=I.clientY-y.current.y;L*L+P*P>It.dragThreshold*It.dragThreshold&&(clearTimeout(y.current.timer),y.current=null)}},[]),M=f.useCallback(I=>{y.current&&I.pointerType==="touch"&&(clearTimeout(y.current.timer),y.current=null)},[]);return o.jsxs("div",{ref:m,className:"w-full h-full relative isolate scene-3d-container","data-testid":"scene-3d","data-autohide-preview":i?"true":void 0,style:{backgroundColor:t},onContextMenu:v,onPointerDown:u?S:void 0,onPointerMove:u?C:void 0,onPointerUp:u?M:void 0,onMouseDown:u?void 0:k,onMouseUp:u?void 0:b,children:[o.jsx(wP,{backgroundColor:t,children:o.jsxs(Lg,{camera:{position:x,fov:On.fov,near:On.nearPlane,far:On.farPlane},gl:{antialias:!0},onPointerMissed:I=>{if(I.button===0||I.button===2){if(CM())return;n(null)}},children:[o.jsx(IP,{color:t}),o.jsx(pP,{}),o.jsx(mP,{}),o.jsx(f.Suspense,{fallback:o.jsx(kP,{}),children:o.jsx(SP,{})})]})}),o.jsx(Fj,{}),o.jsx(gP,{}),o.jsx(nE,{}),o.jsx(vP,{}),o.jsx(bP,{})]})}function Ol(e){const[t,n]=f.useState(null),r=f.useRef(new Set);return f.useEffect(()=>{if(!e){n(null);return}const s=URL.createObjectURL(e);return n(s),()=>{const i=r.current;i.add(s);const a=()=>{i.has(s)&&(i.delete(s),URL.revokeObjectURL(s))};typeof requestIdleCallback<"u"?requestIdleCallback(a,{timeout:1e3}):setTimeout(a,100)}},[e]),f.useEffect(()=>{const s=r.current;return()=>{s.forEach(i=>{URL.revokeObjectURL(i)}),s.clear()}},[]),t}class MP extends f.Component{constructor(t){super(t),this.state={hasError:!1}}static getDerivedStateFromError(){return{hasError:!0}}componentDidCatch(t,n){console.error("ModalErrorBoundary caught an error:",t,n),Ft.getState().addNotification("warning",VI.modalError),this.props.onClose()}componentDidUpdate(t){this.state.hasError&&t.children!==this.props.children&&this.setState({hasError:!1})}render(){return this.state.hasError?null:this.props.children}}const jP={0:"f, cx, cy",1:"fx, fy, cx, cy",2:"f, cx, cy, k",3:"f, cx, cy, k1, k2",4:"fx, fy, cx, cy, k1, k2, p1, p2",5:"fx, fy, cx, cy, k1, k2, k3, k4",6:"fx, fy, cx, cy, k1, k2, p1, p2, k3, k4, k5, k6",7:"fx, fy, cx, cy, omega",8:"f, cx, cy, k",9:"f, cx, cy, k1, k2",10:"fx, fy, cx, cy, k1, k2, p1, p2, k3, k4, sx1, sy1"};function EP(e){const t=Math.abs(e);return t>=1?e.toFixed(1):t===0?"0":e.toPrecision(4)}function Xf({camera:e,qvec:t,tvec:n}){const r=gh[e.modelId]||`MODEL_${e.modelId}`,s=(jP[e.modelId]||"").split(", "),i=[t[1],t[2],t[3],t[0]];return o.jsxs("div",{className:"flex items-center gap-2 text-xs flex-wrap",children:[o.jsx("span",{className:"text-ds-accent font-mono",children:r}),o.jsx("span",{className:"text-ds-muted",children:"|"}),o.jsxs("span",{className:"font-mono text-ds-primary",children:[e.width,o.jsx("span",{className:"text-ds-muted",children:"Ã—"}),e.height]}),o.jsx("span",{className:"text-ds-muted",children:"|"}),o.jsx("span",{className:"font-mono",children:e.params.map((a,l)=>o.jsxs("span",{children:[l>0&&o.jsx("span",{className:"text-ds-muted",children:", "}),o.jsxs("span",{className:"text-ds-muted",children:[s[l]||`p${l}`,"="]}),o.jsx("span",{className:"text-ds-primary",children:EP(a)})]},l))}),o.jsx("span",{className:"text-ds-muted",children:"|"}),o.jsxs("span",{className:"font-mono",children:[o.jsx("span",{className:"text-ds-muted",children:"R="}),i.map((a,l)=>o.jsxs("span",{children:[l>0&&o.jsx("span",{className:"text-ds-muted",children:","}),o.jsx("span",{className:a<0?"text-ds-error":"text-ds-primary",children:a.toFixed(3)})]},l))]}),o.jsx("span",{className:"text-ds-muted",children:"|"}),o.jsxs("span",{className:"font-mono",children:[o.jsx("span",{className:"text-ds-muted",children:"T="}),n.map((a,l)=>o.jsxs("span",{children:[l>0&&o.jsx("span",{className:"text-ds-muted",children:","}),o.jsx("span",{className:a<0?"text-ds-error":"text-ds-primary",children:a.toFixed(2)})]},l))]})]})}const Kf=f.memo(function({points2D:t,camera:n,imageWidth:r,imageHeight:s,containerWidth:i,containerHeight:a,showPoints2D:l,showPoints3D:c}){const d=f.useRef(null);f.useEffect(()=>{const m=d.current;if(!m)return;const g=m.getContext("2d");if(!g)return;g.clearRect(0,0,m.width,m.height);const p=r/n.width,y=s/n.height,w=[],x=[];for(const v of t){const k=v.point3DId!==BigInt(-1),b=v.xy[0]*p,S=v.xy[1]*y;k?w.push({x:b,y:S}):x.push({x:b,y:S})}if(l&&x.length>0){g.fillStyle=st.point.triangulated,g.beginPath();for(const{x:v,y:k}of x)g.moveTo(v+2,k),g.arc(v,k,2,0,Math.PI*2);g.fill()}if(w.length>0&&(l||c)){g.fillStyle=c?st.point.untriangulated:st.point.triangulated,g.beginPath();for(const{x:v,y:k}of w)g.moveTo(v+2,k),g.arc(v,k,2,0,Math.PI*2);g.fill()}},[t,n,r,s,l,c]);const h=(i-r)/2,u=(a-s)/2;return o.jsx("canvas",{ref:d,width:r,height:s,className:"absolute pointer-events-none",style:{left:h,top:u}})}),PP=f.memo(function({lines:t,image1Camera:n,image2Camera:r,image1Width:s,image1Height:i,image2Width:a,image2Height:l,containerWidth:c,containerHeight:d,gap:h,lineOpacity:u}){const m=f.useRef(null);return f.useEffect(()=>{const g=m.current;if(!g)return;const p=g.getContext("2d");if(!p)return;if(s<=0||i<=0||a<=0||l<=0||n.width<=0||n.height<=0||r.width<=0||r.height<=0||c<=0||d<=0){p.clearRect(0,0,g.width,g.height);return}p.clearRect(0,0,g.width,g.height);const y=(c-h)/2,w=(y-s)/2,x=(d-i)/2,v=y+h+(y-a)/2,k=(d-l)/2,b=s/n.width,S=i/n.height,C=a/r.width,M=l/r.height;p.strokeStyle=st.point.triangulated,p.lineWidth=1,p.globalAlpha=u;for(const{point1:I,point2:L}of t){const P=w+I[0]*b,_=x+I[1]*S,N=v+L[0]*C,D=k+L[1]*M;p.beginPath(),p.moveTo(P,_),p.lineTo(N,D),p.stroke()}p.globalAlpha=1,p.fillStyle=st.point.triangulated;for(const{point1:I,point2:L}of t){const P=w+I[0]*b,_=x+I[1]*S,N=v+L[0]*C,D=k+L[1]*M;p.beginPath(),p.arc(P,_,2,0,Math.PI*2),p.fill(),p.beginPath(),p.arc(N,D,2,0,Math.PI*2),p.fill()}},[t,n,r,s,i,a,l,c,d,h,u]),o.jsx("canvas",{ref:m,width:c,height:d,className:"absolute inset-0 pointer-events-none"})}),NP=f.memo(function({lines:t,image1Camera:n,image2Camera:r,image1Width:s,image1Height:i,image2Width:a,image2Height:l,containerWidth:c,containerHeight:d,gap:h,lineOpacity:u}){const m=f.useRef(null);return f.useEffect(()=>{const g=m.current;if(!g)return;const p=g.getContext("2d");if(!p)return;if(s<=0||i<=0||a<=0||l<=0||n.width<=0||n.height<=0||r.width<=0||r.height<=0||c<=0||d<=0){p.clearRect(0,0,g.width,g.height);return}p.clearRect(0,0,g.width,g.height);const y=(d-h)/2,w=(c-s)/2,x=(y-i)/2,v=(c-a)/2,k=y+h+(y-l)/2,b=s/n.width,S=i/n.height,C=a/r.width,M=l/r.height;p.strokeStyle=st.point.triangulated,p.lineWidth=1,p.globalAlpha=u;for(const{point1:I,point2:L}of t){const P=w+I[0]*b,_=x+I[1]*S,N=v+L[0]*C,D=k+L[1]*M;p.beginPath(),p.moveTo(P,_),p.lineTo(N,D),p.stroke()}p.globalAlpha=1,p.fillStyle=st.point.triangulated;for(const{point1:I,point2:L}of t){const P=w+I[0]*b,_=x+I[1]*S,N=v+L[0]*C,D=k+L[1]*M;p.beginPath(),p.arc(P,_,2,0,Math.PI*2),p.fill(),p.beginPath(),p.arc(N,D,2,0,Math.PI*2),p.fill()}},[t,n,r,s,i,a,l,c,d,h,u]),o.jsx("canvas",{ref:m,width:c,height:d,className:"absolute inset-0 pointer-events-none"})}),$l=lo.modalMinWidth,Bl=lo.modalMinHeight,AP=rr.resizeDebounce,Io=so;function Zo({width:e,height:t,cameraWidth:n,cameraHeight:r,label:s,style:i}){const a=f.useRef(null);return f.useEffect(()=>{const l=a.current;if(!l||e<=0||t<=0)return;const c=l.getContext("2d");if(!c)return;const d=Math.max(10,Math.min(30,e/15)),h=Io.bgSecondary,u=Io.bgTertiary;for(let C=0;C<t;C+=d)for(let M=0;M<e;M+=d){const I=(Math.floor(M/d)+Math.floor(C/d))%2===0;c.fillStyle=I?u:h,c.fillRect(M,C,d,d)}c.strokeStyle=Io.textMuted,c.lineWidth=1,c.setLineDash([4,4]),c.strokeRect(.5,.5,e-1,t-1),c.setLineDash([]);const m=Math.max(10,Math.min(16,e/25));c.font=`${m}px "JetBrains Mono", "Fira Code", Consolas, monospace`,c.textAlign="center",c.textBaseline="middle";const g=`${n} Ã— ${r}`,p=s||"No image loaded",y=c.measureText(g),w=c.measureText(p),x=Math.max(y.width,w.width),v=m*1.5,k=12,b=x+k*2,S=v*2+k;c.fillStyle=Io.bgSecondaryOverlay,c.beginPath(),c.roundRect(e/2-b/2,t/2-S/2,b,S,4),c.fill(),c.fillStyle=Io.textPrimary,c.fillText(g,e/2,t/2-v*.35),c.fillStyle=Io.textMuted,c.fillText(p,e/2,t/2+v*.5)},[e,t,n,r,s]),e<=0||t<=0?null:o.jsx("canvas",{ref:a,width:e,height:t,style:{...i,width:e,height:t}})}function Qf({width:e,height:t,style:n}){const r=f.useRef(null);return f.useEffect(()=>{const s=r.current;if(!s||e<=0||t<=0)return;const i=s.getContext("2d");if(!i)return;i.clearRect(0,0,e,t);const a=Math.max(3,Math.min(e,t)*.025);i.strokeStyle=Io.bgVoid,i.lineWidth=a,i.lineCap="square",i.beginPath(),i.moveTo(0,0),i.lineTo(e,t),i.stroke(),i.beginPath(),i.moveTo(e,0),i.lineTo(0,t),i.stroke()},[e,t]),e<=0||t<=0?null:o.jsx("canvas",{ref:r,width:e,height:t,className:"pointer-events-none",style:{...n,width:e,height:t}})}const LP=20;function Jf(){const e=me(j=>j.reconstruction),t=me(j=>j.loadedFiles),n=me(j=>j.imageUrlBase),r=me(j=>j.maskUrlBase),s=me(j=>j.wasmReconstruction),[i,a]=f.useState(0),[l,c]=f.useState(0),[d,h]=f.useState(null),[u,m]=f.useState(null),g=G(j=>j.imageDetailId),p=G(j=>j.closeImageDetail),y=G(j=>j.openImageDetail),w=G(j=>j.showPoints2D),x=G(j=>j.showPoints3D),v=G(j=>j.setShowPoints2D),k=G(j=>j.setShowPoints3D),b=G(j=>j.showMatchesInModal),S=G(j=>j.setShowMatchesInModal),C=G(j=>j.matchedImageId),M=G(j=>j.setMatchedImageId),I=G(j=>j.touchMode),L=G(j=>j.touchUI.modalControls),P=Qn(j=>j.pendingDeletions),_=Qn(j=>j.toggleDeletion),N=Qn(j=>j.markBulkForDeletion),D=Qn(j=>j.unmarkBulkDeletion),B=me(Cs)>1,E=g!==null&&P.has(g),Z=f.useCallback(()=>{g!==null&&(E||window.confirm("Mark this image for deletion? You can restore it or apply the deletion later."))&&_(g)},[g,E,_]),F=f.useMemo(()=>{if(!e||g===null)return[];const j=e.images.get(g);if(!j)return[];const V=[];for(const[ne,be]of e.images)be.cameraId===j.cameraId&&V.push(ne);return V},[e,g]),$=f.useMemo(()=>{if(!e?.rigData||g===null)return[];for(const[,j]of e.rigData.frames)if(j.dataIds.some(V=>V.dataId===g))return j.dataIds.filter(V=>e.images.has(V.dataId)).map(V=>V.dataId);return[]},[e,g]),T=F.length>0&&F.every(j=>P.has(j)),z=$.length>0&&$.every(j=>P.has(j)),H=f.useCallback(()=>{F.length!==0&&(T?D(F):window.confirm(`Mark all ${F.length} images from this camera for deletion?`)&&N(F))},[F,T,N,D]),O=f.useCallback(()=>{$.length!==0&&(z?D($):window.confirm(`Mark all ${$.length} images in this frame for deletion?`)&&N($))},[$,z,N,D]),[J,re]=f.useState(Wn.matchLines),[q,ie]=f.useState(!1),[we,Ce]=f.useState(""),Re=f.useRef(null),[ee,he]=f.useState(new Map),Se=f.useRef([]),xe=f.useRef(null);f.useEffect(()=>{s!==xe.current&&(xe.current=s,he(new Map),Se.current=[])},[s]),f.useEffect(()=>{if(!g||!w&&!x&&!b||!s||s!==xe.current)return;const j=[];if((w||x||b)&&!ee.has(g)){const be=e?.images.get(g);be&&be.points2D.length===0&&(be.numPoints2D??0)>0&&j.push(g)}if(b&&C!==null&&!ee.has(C)){const be=e?.images.get(C);be&&be.points2D.length===0&&(be.numPoints2D??0)>0&&j.push(C)}if(j.length===0)return;const V=new Map(ee),ne=[...Se.current];for(const be of j){const bt=s.getImagePoints2DArray(be);if(bt.length>0){V.set(be,bt);const Bt=ne.indexOf(be);Bt!==-1&&ne.splice(Bt,1),ne.push(be)}}for(;ne.length>LP;){const be=ne.shift();V.delete(be)}Se.current=ne,he(V)},[g,C,w,x,b,s,e,ee]),f.useEffect(()=>{if(!n||!e)return;const j=[];if(g!==null){const ne=e.images.get(g);ne&&!Jn(ne.name)&&j.push(ne.name)}if(C!==null){const ne=e.images.get(C);ne&&!Jn(ne.name)&&j.push(ne.name)}if(j.length===0)return;let V=!1;return Promise.all(j.map(ne=>ks(n,ne))).then(ne=>{!V&&ne.some(be=>be!==null)&&a(be=>be+1)}),()=>{V=!0}},[n,e,g,C]),f.useEffect(()=>{if(n||!bn()||!e)return;const j=[];if(g!==null){const ne=e.images.get(g);ne&&!Vn(ne.name)&&j.push(ne.name)}if(C!==null){const ne=e.images.get(C);ne&&!Vn(ne.name)&&j.push(ne.name)}if(j.length===0)return;let V=!1;return Promise.all(j.map(ne=>gs(ne))).then(ne=>{!V&&ne.some(be=>be!==null)&&c(be=>be+1)}),()=>{V=!0}},[n,e,g,C]),f.useEffect(()=>{if(h(null),!r||!e||g===null)return;const j=e.images.get(g);if(!j)return;let V=!1;return Vh(r,j.name).then(ne=>{V||h(ne)}),()=>{V=!0}},[r,e,g]),f.useEffect(()=>{if(m(null),r||!bn()||!e||g===null)return;const j=e.images.get(g);if(!j)return;let V=!1;return Zh(j.name).then(ne=>{V||m(ne)}),()=>{V=!0}},[r,e,g]);const Ae=f.useMemo(()=>e?Array.from(e.images.keys()).sort((j,V)=>j-V):[],[e]),ye=g!==null?Ae.indexOf(g):-1,Pe=ye>0,Ye=ye>=0&&ye<Ae.length-1,$e=f.useCallback(()=>{Pe&&y(Ae[ye-1])},[Pe,Ae,ye,y]),qe=f.useCallback(()=>{Ye&&y(Ae[ye+1])},[Ye,Ae,ye,y]);f.useEffect(()=>{q&&Re.current&&(Re.current.focus(),Re.current.select())},[q]);const ct=f.useCallback(()=>{Ce(String(Math.round(J*100))),ie(!0)},[J]),K=f.useCallback(()=>{const j=parseFloat(we);if(!isNaN(j)){const V=Math.min(100,Math.max(0,j))/100;re(V)}ie(!1)},[we]),Le=f.useCallback(j=>{j.key==="Enter"?K():j.key==="Escape"&&ie(!1)},[K]),fe=f.useCallback(j=>{j.preventDefault(),j.stopPropagation();const V=.05,ne=j.deltaY>0?-V:V,be=Math.min(1,Math.max(0,J+ne));re(be)},[J]),[ae,De]=f.useState({width:0,height:0}),Y=f.useRef(null),[W,le]=f.useState({x:0,y:0}),[Q,pe]=f.useState({width:800,height:600}),Ne=f.useRef(W),Je=f.useRef(Q);f.useEffect(()=>{Ne.current=W},[W]),f.useEffect(()=>{Je.current=Q},[Q]);const ke=g!==null?e?.images.get(g):null,je=ke?e?.cameras.get(ke.cameraId):null,jt=f.useMemo(()=>ke?n?Jn(ke.name)??null:bn()?Vn(ke.name)??null:Zr(t?.imageFiles,ke.name)??null:null,[ke,n,t?.imageFiles,i,l]),oe=f.useMemo(()=>ke?r?d:bn()?u:t?.hasMasks?tc(t?.imageFiles,ke.name)??null:null:null,[ke,r,d,u,t?.hasMasks,t?.imageFiles]),ge=!!oe,[Xe,dt]=f.useState("hover"),[mt,Rt]=f.useState(.5),xt=f.useCallback(()=>{dt(j=>{const V=["hover","mask","split","image"],ne=V.indexOf(j);return V[(ne+1)%V.length]})},[]),Xt=f.useCallback(j=>{const V=j.currentTarget.getBoundingClientRect(),ne=(j.clientX-V.left)/V.width;Rt(Math.max(0,Math.min(1,ne)))},[]),Dn=f.useCallback(()=>{dt("hover")},[]);f.useEffect(()=>{dt("hover"),Rt(.5)},[g]);const de=Ol(jt),Me=Ol(oe),{numPoints2D:Fe,numPoints3D:_e}=f.useMemo(()=>{if(!ke||!e)return{numPoints2D:0,numPoints3D:0};const j=ke.numPoints2D??ke.points2D.length,ne=(g!==null?e.imageStats.get(g):null)?.numPoints3D??0;return{numPoints2D:j,numPoints3D:ne}},[ke,e,g]),et=f.useMemo(()=>{if(!e||g===null)return[];const j=e.connectedImagesIndex.get(g);return j?Array.from(j.entries()).filter(([V])=>!P.has(V)).sort((V,ne)=>ne[1]-V[1]).map(([V,ne])=>({imageId:V,matchCount:ne,name:e.images.get(V)?.name||`Image ${V}`})):[]},[e,g,P]),Ve=f.useMemo(()=>C===null?0:et.find(V=>V.imageId===C)?.matchCount??0,[et,C]),nt=f.useMemo(()=>ke?ke.points2D.length>0?ke.points2D:ee.get(ke.imageId)??[]:[],[ke,ee]),He=C!==null?e?.images.get(C):null,Ht=f.useMemo(()=>He?He.points2D.length>0?He.points2D:ee.get(He.imageId)??[]:[],[He,ee]),it=f.useCallback(j=>{if(et.length===0)return;const V=C!==null?et.findIndex(be=>be.imageId===C):-1,ne=j>0?Math.min(V+1,et.length-1):Math.max(V-1,0);M(et[ne].imageId)},[et,C,M]),pn=f.useCallback(j=>{j.stopPropagation(),it(j.deltaY>0?1:-1)},[it]),St=f.useRef(null),sn=f.useCallback(j=>{if(j.touches.length!==1)return;const V=j.touches[0];St.current={x:V.clientX,y:V.clientY,time:Date.now()}},[]),qr=f.useCallback(j=>{if(St.current&&j.touches.length===1){const V=Math.abs(j.touches[0].clientX-St.current.x),ne=Math.abs(j.touches[0].clientY-St.current.y);(V>10||ne>10)&&j.preventDefault()}},[]),Ge=f.useCallback(j=>{if(!St.current||j.changedTouches.length!==1){St.current=null;return}const V=j.changedTouches[0],ne=V.clientX-St.current.x,be=V.clientY-St.current.y,bt=Date.now()-St.current.time,Bt=Math.sqrt(ne*ne+be*be);if(St.current=null,Bt<15&&bt<300){ge&&Me&&!E&&!b&&xt();return}const vt=Math.abs(ne),Nt=Math.abs(be);if(vt>50&&vt>Nt*1.5){ne<0?qe():$e();return}b&&Nt>50&&Nt>vt*1.5&&it(be<0?1:-1)},[ge,Me,E,b,xt,qe,$e,it]),ot=f.useRef(0),Ee=100;f.useEffect(()=>{const j=Y.current;if(!j)return;const V=ne=>{ne.preventDefault();const be=Date.now();be-ot.current<Ee||(ot.current=be,b&&et.length>0?it(ne.deltaY>0?1:-1):ne.deltaY>0?qe():ne.deltaY<0&&$e())};return j.addEventListener("wheel",V,{passive:!1}),()=>j.removeEventListener("wheel",V)},[qe,$e,b,et,it]);const Ze=He?e?.cameras.get(He.cameraId):null,$t=f.useMemo(()=>He?n?Jn(He.name)??null:bn()?Vn(He.name)??null:Zr(t?.imageFiles,He.name)??null:null,[He,n,t?.imageFiles,i,l]),Dt=Ol($t),qt=f.useMemo(()=>{if(!b||C===null||!e||!ke||!He)return[];const j=[],V=new Map;for(const ne of Ht)ne.point3DId!==BigInt(-1)&&V.set(ne.point3DId,ne);for(const ne of nt){if(ne.point3DId===BigInt(-1))continue;const be=V.get(ne.point3DId);be&&j.push({point1:ne.xy,point2:be.xy})}return j},[b,C,e,ke,He,nt,Ht]),yt=b&&C!==null&&He&&Ze,Et=Ds.matchView,{renderedImageWidth:ut,renderedImageHeight:Pt}=f.useMemo(()=>{if(!je||ae.width<=0||ae.height<=0)return{renderedImageWidth:0,renderedImageHeight:0};const j=je.width/je.height,V=ae.width/ae.height;return j>V?{renderedImageWidth:ae.width,renderedImageHeight:ae.width/j}:{renderedImageHeight:ae.height,renderedImageWidth:ae.height*j}},[je,ae.width,ae.height]),se=f.useMemo(()=>{if(!je||!Ze||ae.width<=0||ae.height<=0)return{image1Width:0,image1Height:0,image2Width:0,image2Height:0};const j=(ae.width-Et)/2,V=ae.height,ne=j/V,be=je.width/je.height,bt=be>ne?j:V*be,Bt=be>ne?j/be:V,vt=Ze.width/Ze.height,Nt=vt>ne?j:V*vt,dn=vt>ne?j/vt:V;return{image1Width:bt,image1Height:Bt,image2Width:Nt,image2Height:dn}},[je,Ze,ae.width,ae.height]),We=f.useMemo(()=>{if(!je||!Ze||ae.width<=0||ae.height<=0)return{image1Width:0,image1Height:0,image2Width:0,image2Height:0};const j=(ae.height-Et)/2,V=ae.width,ne=V/j,be=je.width/je.height,bt=be>ne?V:j*be,Bt=be>ne?V/be:j,vt=Ze.width/Ze.height,Nt=vt>ne?V:j*vt,dn=vt>ne?V/vt:j;return{image1Width:bt,image1Height:Bt,image2Width:Nt,image2Height:dn}},[je,Ze,ae.width,ae.height]),Ke=f.useRef(!1);f.useEffect(()=>{if(g!==null&&!Ke.current&&je){const j=window.innerWidth,V=window.innerHeight,ne=Math.round(j*$o.maxWidthPercent),be=Math.round(V*$o.maxHeightPercent),bt=$o.headerHeight+$o.footerHeight+$o.padding,Bt=$o.padding,vt=ne-Bt,Nt=be-bt,dn=je.width/je.height;let qn,ar;dn>vt/Nt?(qn=vt,ar=vt/dn):(ar=Nt,qn=Nt*dn);const Xr=Math.max($l,Math.round(qn+Bt)),Kr=Math.max(Bl,Math.round(ar+bt));pe({width:Xr,height:Kr});const ho=(j-Xr)/2,mo=(V-Kr)/2;le({x:ho,y:mo})}Ke.current=g!==null},[g,je]),kt(ze.closeModal.keys,p,{scopes:ze.closeModal.scopes,enabled:g!==null},[p]),kt(ze.prevImage.keys,$e,{scopes:ze.prevImage.scopes,enabled:g!==null&&Pe},[Pe,$e]),kt(ze.nextImage.keys,qe,{scopes:ze.nextImage.scopes,enabled:g!==null&&Ye},[Ye,qe]);const En=f.useCallback(j=>{j.preventDefault();const V=j.currentTarget;V.setPointerCapture(j.pointerId);const ne=j.clientX,be=j.clientY,bt=Ne.current.x,Bt=Ne.current.y,vt=dn=>{le({x:bt+dn.clientX-ne,y:Bt+dn.clientY-be})},Nt=()=>{V.removeEventListener("pointermove",vt),V.removeEventListener("pointerup",Nt)};V.addEventListener("pointermove",vt),V.addEventListener("pointerup",Nt)},[]),Wt=f.useCallback((j,V)=>{j.preventDefault(),j.stopPropagation();const ne=j.currentTarget;ne.setPointerCapture(j.pointerId);const be=j.clientX,bt=j.clientY,Bt=Je.current.width,vt=Je.current.height,Nt=Ne.current.x,dn=Ne.current.y,qn=Xr=>{const Kr=Xr.clientX-be,ho=Xr.clientY-bt;let mo=Bt,Es=vt,Ci=Nt,Si=dn;if(V.includes("e")&&(mo=Math.max($l,Bt+Kr)),V.includes("w")){const Fn=Bt-Kr;Fn>=$l&&(mo=Fn,Ci=Nt+Kr)}if(V.includes("s")&&(Es=Math.max(Bl,vt+ho)),V.includes("n")){const Fn=vt-ho;Fn>=Bl&&(Es=Fn,Si=dn+ho)}pe({width:mo,height:Es}),le({x:Ci,y:Si})},ar=()=>{ne.removeEventListener("pointermove",qn),ne.removeEventListener("pointerup",ar)};ne.addEventListener("pointermove",qn),ne.addEventListener("pointerup",ar)},[]);f.useEffect(()=>{if(g===null)return;const j=()=>{le(V=>({x:Math.max(0,Math.min(V.x,window.innerWidth-Q.width)),y:Math.max(0,Math.min(V.y,window.innerHeight-Q.height))}))};return window.addEventListener("resize",j),()=>window.removeEventListener("resize",j)},[g,Q.width,Q.height]);const Pn=f.useRef(void 0),gn=f.useCallback(()=>{Y.current&&De({width:Y.current.clientWidth,height:Y.current.clientHeight})},[]);return f.useEffect(()=>{if(!Y.current)return;gn();const j=new ResizeObserver(()=>{Pn.current&&clearTimeout(Pn.current),Pn.current=setTimeout(gn,AP)});return j.observe(Y.current),()=>{j.disconnect(),Pn.current&&clearTimeout(Pn.current)}},[gn,g]),g===null||!ke||!je?null:I?Qs.createPortal(o.jsxs("div",{className:"fixed inset-0 z-[1000] bg-ds-primary flex flex-col",children:[o.jsxs("div",{className:"flex flex-col bg-ds-secondary flex-shrink-0",children:[o.jsxs("div",{className:"flex items-center justify-between px-3 h-11",children:[o.jsx("span",{className:`text-ds-primary text-sm truncate flex-1 mr-2 ${E?"line-through text-ds-error":""}`,children:yt?`${ke?.name} â†” ${He?.name}`:ke?.name}),o.jsx("button",{onClick:p,className:"w-10 h-10 flex items-center justify-center text-ds-muted hover:text-ds-primary text-2xl",style:{minWidth:It.minTapTarget,minHeight:It.minTapTarget},children:"Ã—"})]}),!yt&&o.jsx("div",{className:"px-3 pb-1.5 overflow-x-auto",children:o.jsx(Xf,{camera:je,qvec:ke.qvec,tvec:ke.tvec})})]}),o.jsx("div",{ref:Y,className:"flex-1 min-h-0 bg-ds-secondary relative overflow-hidden",onTouchStart:sn,onTouchMove:qr,onTouchEnd:Ge,children:yt?(()=>{const j=We,V=(ae.height-Et)/2,ne=(ae.width-j.image1Width)/2,be=(V-j.image1Height)/2,bt=(ae.width-j.image2Width)/2,Bt=V+Et+(V-j.image2Height)/2;return o.jsxs(o.Fragment,{children:[j.image1Width>0&&(de?o.jsx("img",{src:de,alt:ke.name,className:"absolute object-contain",style:{width:j.image1Width,height:j.image1Height,left:ne,top:be},draggable:!1}):o.jsx(Zo,{width:j.image1Width,height:j.image1Height,cameraWidth:je.width,cameraHeight:je.height,label:ke.name,style:{position:"absolute",left:ne,top:be}})),j.image2Width>0&&Ze&&(Dt?o.jsx("img",{src:Dt,alt:He?.name||"",className:"absolute object-contain",style:{width:j.image2Width,height:j.image2Height,left:bt,top:Bt},draggable:!1}):o.jsx(Zo,{width:j.image2Width,height:j.image2Height,cameraWidth:Ze.width,cameraHeight:Ze.height,label:He?.name,style:{position:"absolute",left:bt,top:Bt}})),qt.length>0&&j.image1Width>0&&j.image2Width>0&&o.jsx(NP,{lines:qt,image1Camera:je,image2Camera:Ze,image1Width:j.image1Width,image1Height:j.image1Height,image2Width:j.image2Width,image2Height:j.image2Height,containerWidth:ae.width,containerHeight:ae.height,gap:Et,lineOpacity:J})]})})():(()=>{const j=(ae.width-ut)/2,V=(ae.height-Pt)/2;return o.jsxs(o.Fragment,{children:[ut>0&&(de?o.jsxs(o.Fragment,{children:[o.jsx("img",{src:de,alt:ke.name,className:"absolute object-contain",style:{width:ut,height:Pt,left:j,top:V,filter:E?"grayscale(100%)":void 0},draggable:!1}),E&&o.jsx(Qf,{width:ut,height:Pt,style:{position:"absolute",left:j,top:V}})]}):o.jsx(Zo,{width:ut,height:Pt,cameraWidth:je.width,cameraHeight:je.height,label:"No image loaded",style:{position:"absolute",left:j,top:V}})),!E&&(w||x)&&ut>0&&nt.length>0&&o.jsx(Kf,{points2D:nt,camera:je,imageWidth:ut,imageHeight:Pt,containerWidth:ae.width,containerHeight:ae.height,showPoints2D:w,showPoints3D:x})]})})()}),L&&o.jsxs("div",{className:"flex-shrink-0 bg-ds-tertiary",children:[o.jsxs("div",{className:"flex gap-1.5 px-2 py-1.5 overflow-x-auto",children:[!b&&o.jsxs(o.Fragment,{children:[o.jsxs("button",{onClick:()=>!E&&v(!w),disabled:E,className:`flex-1 px-2 flex items-center justify-center rounded-md text-xs ${E?"bg-ds-secondary text-ds-muted opacity-50":w?"bg-ds-accent text-ds-void":"bg-ds-hover text-ds-primary"}`,style:{minHeight:It.compactButtonHeight},children:["2D ",o.jsxs("span",{className:E||w?"":"text-ds-success",children:["(",Fe,")"]})]}),o.jsxs("button",{onClick:()=>!E&&k(!x),disabled:E,className:`flex-1 px-2 flex items-center justify-center rounded-md text-xs ${E?"bg-ds-secondary text-ds-muted opacity-50":x?"bg-ds-accent text-ds-void":"bg-ds-hover text-ds-primary"}`,style:{minHeight:It.compactButtonHeight},children:["3D ",o.jsxs("span",{className:E||x?"":"text-ds-error",children:["(",_e,")"]})]})]}),o.jsx("button",{onClick:()=>!E&&S(!b),disabled:E,className:`${b?"":"flex-1"} px-3 flex items-center justify-center rounded-md text-xs whitespace-nowrap ${E?"bg-ds-secondary text-ds-muted opacity-50":b?"bg-ds-accent text-ds-void":"bg-ds-hover text-ds-primary"}`,style:{minHeight:It.compactButtonHeight},children:"Matches"}),b&&!E&&o.jsxs("select",{value:C??"",onChange:j=>M(j.target.value?parseInt(j.target.value):null),className:`${nn.select} flex-1 min-w-0 py-1.5 text-xs`,style:{minHeight:It.compactButtonHeight},children:[o.jsx("option",{value:"",children:"Select image..."}),et.map(({imageId:j,matchCount:V,name:ne})=>o.jsxs("option",{value:j,children:[ne," (",V,")"]},j))]})]}),b&&!E&&C!==null&&o.jsxs("div",{className:"flex items-center gap-2 px-2 pb-1.5",children:[o.jsx("span",{className:"text-ds-secondary text-xs",children:"Opacity"}),o.jsx("input",{type:"range",min:"0",max:"1",step:"0.1",value:J,onChange:j=>re(parseFloat(j.target.value)),className:"flex-1 accent-ds-success h-6"}),o.jsxs("span",{className:"text-ds-primary text-xs w-8 text-right",children:[Math.round(J*100),"%"]})]}),!b&&o.jsxs("div",{className:"flex items-center gap-1.5 px-2 py-1.5 border-t border-ds",children:[o.jsx("button",{onClick:$e,disabled:!Pe,className:`flex-1 px-2 flex items-center justify-center rounded-md text-xs ${Pe?"bg-ds-hover text-ds-primary":"bg-ds-secondary text-ds-muted"}`,style:{minHeight:It.compactButtonHeight},children:"â† Prev"}),o.jsxs("span",{className:"text-ds-primary text-xs px-1",children:[ye+1," / ",Ae.length]}),o.jsx("button",{onClick:qe,disabled:!Ye,className:`flex-1 px-2 flex items-center justify-center rounded-md text-xs ${Ye?"bg-ds-hover text-ds-primary":"bg-ds-secondary text-ds-muted"}`,style:{minHeight:It.compactButtonHeight},children:"Next â†’"})]})]})]}),document.body):Qs.createPortal(o.jsxs("div",{className:"fixed inset-0 z-[1000] pointer-events-none",children:[o.jsx("div",{className:ft.backdrop,onClick:p,onContextMenu:j=>{j.preventDefault(),p()}}),o.jsxs("div",{className:ft.panel,style:{left:W.x,top:W.y,width:Q.width,height:Q.height},onClick:j=>j.stopPropagation(),children:[o.jsxs(MP,{onClose:p,children:[o.jsxs("div",{className:"flex items-center justify-between px-4 py-2 rounded-t-lg bg-ds-secondary text-xs cursor-move select-none",onPointerDown:En,style:{touchAction:"none"},children:[o.jsx("span",{className:`text-ds-primary ${E?"line-through text-ds-error":""}`,children:yt?`Image Matches: ${ke?.name} â†” ${He?.name} (${Ve} matches)`:`Image #${g}: ${ke?.name}`}),o.jsxs("div",{className:"flex items-center gap-1",children:[o.jsx("button",{onClick:Z,onPointerDown:j=>j.stopPropagation(),className:`${ft.headerIconButton} ${E?"text-ds-success hover:bg-ds-success/20":"text-ds-muted hover:text-ds-error hover:bg-ds-error/20"}`,title:E?"Restore image":"Delete image",children:o.jsxs("svg",{className:"w-4 h-4",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[o.jsx("path",{d:"M3 6h18"}),o.jsx("path",{d:"M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6"}),o.jsx("path",{d:"M8 6V4a2 2 0 012-2h4a2 2 0 012 2v2"}),o.jsx("text",{x:"12",y:"18",textAnchor:"middle",fontSize:"11",fill:"currentColor",stroke:"none",fontWeight:"bold",children:"I"})]})}),B&&o.jsx("button",{onClick:H,onPointerDown:j=>j.stopPropagation(),className:`${ft.headerIconButton} ${T?"text-ds-success hover:bg-ds-success/20":"text-ds-muted hover:text-ds-error hover:bg-ds-error/20"}`,title:T?`Restore camera ${ke?.cameraId}`:`Delete camera ${ke?.cameraId}`,children:o.jsxs("svg",{className:"w-4 h-4",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[o.jsx("path",{d:"M3 6h18"}),o.jsx("path",{d:"M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6"}),o.jsx("path",{d:"M8 6V4a2 2 0 012-2h4a2 2 0 012 2v2"}),o.jsx("text",{x:"12",y:"18",textAnchor:"middle",fontSize:"11",fill:"currentColor",stroke:"none",fontWeight:"bold",children:"C"})]})}),$.length>0&&o.jsx("button",{onClick:O,onPointerDown:j=>j.stopPropagation(),className:`${ft.headerIconButton} ${z?"text-ds-success hover:bg-ds-success/20":"text-ds-muted hover:text-ds-error hover:bg-ds-error/20"}`,title:z?"Restore frame":"Delete frame",children:o.jsxs("svg",{className:"w-4 h-4",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[o.jsx("path",{d:"M3 6h18"}),o.jsx("path",{d:"M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6"}),o.jsx("path",{d:"M8 6V4a2 2 0 012-2h4a2 2 0 012 2v2"}),o.jsx("text",{x:"12",y:"18",textAnchor:"middle",fontSize:"11",fill:"currentColor",stroke:"none",fontWeight:"bold",children:"F"})]})}),o.jsx("button",{onClick:p,onPointerDown:j=>j.stopPropagation(),className:ft.toolHeaderClose,title:"Close",children:o.jsx("svg",{className:"w-3.5 h-3.5",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2.5",strokeLinecap:"round",children:o.jsx("path",{d:"M18 6L6 18M6 6l12 12"})})})]})]}),o.jsxs("div",{className:"flex flex-col flex-1 overflow-hidden px-4 pt-1 pb-3 gap-2",children:[o.jsx("div",{className:"flex-shrink-0 overflow-x-auto py-1",children:o.jsx(Xf,{camera:je,qvec:ke.qvec,tvec:ke.tvec})}),o.jsxs("div",{className:"flex-1 min-h-0 flex flex-col",children:[o.jsxs("div",{ref:Y,className:"group/scroll relative flex-1 min-h-0 bg-ds-secondary rounded overflow-hidden",children:[o.jsxs("div",{className:"absolute bottom-2 left-1/2 -translate-x-1/2 z-10 px-2 py-1 bg-ds-void/70 text-ds-secondary text-xs rounded opacity-0 group-hover/scroll:opacity-100 transition-opacity pointer-events-none whitespace-nowrap flex gap-3",children:[o.jsxs("span",{children:["Scroll: iterate through ",b&&et.length>0?"matched images":"images"]}),ge&&Me&&!b&&o.jsxs("span",{children:["Click: ",o.jsx("span",{className:"text-ds-primary",children:Xe})," â†’ ",Xe==="hover"?"mask":Xe==="mask"?"split":Xe==="split"?"image":"hover"]})]}),yt?(()=>{const j=(ae.width-Et)/2,V=(j-se.image1Width)/2,ne=(ae.height-se.image1Height)/2,be=j+Et+(j-se.image2Width)/2,bt=(ae.height-se.image2Height)/2;return o.jsxs(o.Fragment,{children:[se.image1Width>0&&(de?o.jsx("img",{src:de,alt:ke.name,className:"absolute object-contain",style:{width:se.image1Width,height:se.image1Height,left:V,top:ne},draggable:!1}):o.jsx(Zo,{width:se.image1Width,height:se.image1Height,cameraWidth:je.width,cameraHeight:je.height,label:ke.name,style:{position:"absolute",left:V,top:ne}})),se.image2Width>0&&Ze&&(Dt?o.jsx("img",{src:Dt,alt:He?.name||"",className:"absolute object-contain",style:{width:se.image2Width,height:se.image2Height,left:be,top:bt},draggable:!1}):o.jsx(Zo,{width:se.image2Width,height:se.image2Height,cameraWidth:Ze.width,cameraHeight:Ze.height,label:He?.name,style:{position:"absolute",left:be,top:bt}})),qt.length>0&&se.image1Width>0&&se.image2Width>0&&o.jsx(PP,{lines:qt,image1Camera:je,image2Camera:Ze,image1Width:se.image1Width,image1Height:se.image1Height,image2Width:se.image2Width,image2Height:se.image2Height,containerWidth:ae.width,containerHeight:ae.height,gap:Et,lineOpacity:J})]})})():(()=>{const j=(ae.width-ut)/2,V=(ae.height-Pt)/2;return o.jsxs("div",{className:"group absolute inset-0",onClick:ge&&Me&&!E?xt:void 0,onMouseMove:ge&&Me&&!E?Xt:void 0,onMouseLeave:ge&&Me&&!E?Dn:void 0,style:{cursor:ge&&Me&&!E?"pointer":void 0},children:[ut>0&&(de?o.jsxs(o.Fragment,{children:[o.jsx("img",{src:de,alt:ke.name,className:"absolute object-contain pointer-events-none",style:{width:ut,height:Pt,left:j,top:V,opacity:Xe==="mask"?0:1,clipPath:Xe==="split"?`inset(0 ${(1-mt)*100}% 0 0)`:void 0,filter:E?"grayscale(100%)":void 0},draggable:!1}),E&&o.jsx(Qf,{width:ut,height:Pt,style:{position:"absolute",left:j,top:V}}),ge&&Me&&!E&&o.jsx("img",{src:Me,alt:"mask",className:`absolute object-contain pointer-events-none ${Xe==="hover"?"opacity-0 group-hover:opacity-50":""}`,style:{width:ut,height:Pt,left:j,top:V,...Xe!=="hover"&&{opacity:Xe==="image"?0:1},clipPath:Xe==="split"?`inset(0 0 0 ${mt*100}%)`:void 0},draggable:!1})]}):o.jsx(Zo,{width:ut,height:Pt,cameraWidth:je.width,cameraHeight:je.height,label:"No image loaded",style:{position:"absolute",left:j,top:V}})),!E&&(w||x)&&ut>0&&nt.length>0&&o.jsx(Kf,{points2D:nt,camera:je,imageWidth:ut,imageHeight:Pt,containerWidth:ae.width,containerHeight:ae.height,showPoints2D:w,showPoints3D:x})]})})()]}),o.jsxs("div",{className:"mt-2 flex items-center justify-between text-xs",children:[o.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[!b&&o.jsxs(o.Fragment,{children:[o.jsxs("button",{onClick:()=>!E&&v(!w),disabled:E,className:`${ue.base} ${ue.sizes.toggleResponsive} ${E?ue.disabled+" bg-ds-secondary text-ds-muted":w?ue.variants.toggleActive:ue.variants.toggle}`,children:["Points2D ",o.jsxs("span",{className:E||w?"":"text-ds-success",children:["(",Fe,")"]})]}),o.jsxs("button",{onClick:()=>!E&&k(!x),disabled:E,className:`${ue.base} ${ue.sizes.toggleResponsive} ${E?ue.disabled+" bg-ds-secondary text-ds-muted":x?ue.variants.toggleActive:ue.variants.toggle}`,children:["Points3D ",o.jsxs("span",{className:E||x?"":"text-ds-error",children:["(",_e,")"]})]})]}),o.jsx("button",{onClick:()=>!E&&S(!b),disabled:E,className:`${ue.base} ${ue.sizes.toggleResponsive} ${E?ue.disabled+" bg-ds-secondary text-ds-muted":b?ue.variants.toggleActive:ue.variants.toggle}`,children:"Show Matches"}),b&&!E&&o.jsxs(o.Fragment,{children:[o.jsxs("select",{value:C??"",onChange:j=>M(j.target.value?parseInt(j.target.value):null),onWheel:pn,className:`${nn.select} py-1 pl-2 pr-1 text-xs`,children:[o.jsx("option",{value:"",children:"Select connected image..."}),et.map(({imageId:j,matchCount:V,name:ne})=>o.jsxs("option",{value:j,children:[ne," (",V," matches)"]},j))]}),o.jsxs("div",{className:"flex items-center gap-2",onWheel:fe,children:[o.jsx("label",{className:"text-ds-secondary whitespace-nowrap text-xs pl-1",children:"Opacity"}),o.jsx("input",{type:"range",min:"0",max:"1",step:"0.05",value:J,onChange:j=>re(parseFloat(j.target.value)),className:"w-14 accent-ds-success"}),q?o.jsx("input",{ref:Re,type:"text",value:we,onChange:j=>Ce(j.target.value),onBlur:K,onKeyDown:Le,className:"bg-transparent text-ds-primary text-xs w-8 text-right flex-shrink-0 border-none p-0 m-0 focus-outline-none"}):o.jsxs("span",{className:"text-ds-primary text-xs w-8 text-right flex-shrink-0 cursor-pointer hover-bg-ds-accent",onDoubleClick:ct,title:"Double-click to edit",children:[Math.round(J*100),"%"]})]})]})]}),o.jsxs("div",{className:"flex items-center gap-2",children:[o.jsx("button",{onClick:$e,disabled:!Pe,className:`${ue.base} ${ue.sizes.toggleResponsive} ${Pe?ue.variants.toggle:ue.disabled+" bg-ds-secondary text-ds-muted"}`,children:"â† Prev"}),o.jsxs("div",{className:"flex items-center text-xs",children:[o.jsx("input",{type:"text",defaultValue:g??"",className:`${nn.base} py-1 w-14 rounded-l rounded-r-none text-center text-xs`,onKeyDown:j=>{if(j.stopPropagation(),j.key==="Enter"){const V=parseInt(j.target.value);!isNaN(V)&&e?.images.has(V)&&y(V),j.target.blur()}else j.key==="Escape"&&(j.target.value=String(g??""),j.target.blur())},onBlur:j=>{j.target.value=String(g??"")}},g),o.jsx("span",{className:"w-14 px-2 py-1 text-center bg-ds-secondary text-ds-muted border-y border-r border-ds rounded-r",children:Ae.length})]}),o.jsx("button",{onClick:qe,disabled:!Ye,className:`${ue.base} ${ue.sizes.toggleResponsive} ${Ye?ue.variants.toggle:ue.disabled+" bg-ds-secondary text-ds-muted"}`,children:"Next â†’"})]})]})]})]})]}),o.jsx("div",{className:`${In.corner} ${In.nw}`,onPointerDown:j=>Wt(j,"nw")}),o.jsx("div",{className:`${In.corner} ${In.ne}`,onPointerDown:j=>Wt(j,"ne")}),o.jsx("div",{className:`${In.corner} ${In.sw}`,onPointerDown:j=>Wt(j,"sw")}),o.jsx("div",{className:`${In.corner} ${In.se}`,onPointerDown:j=>Wt(j,"se")}),o.jsx("div",{className:`${In.edge} ${In.n}`,onPointerDown:j=>Wt(j,"n")}),o.jsx("div",{className:`${In.edge} ${In.s}`,onPointerDown:j=>Wt(j,"s")}),o.jsx("div",{className:`${In.edge} ${In.w}`,onPointerDown:j=>Wt(j,"w")}),o.jsx("div",{className:`${In.edge} ${In.e}`,onPointerDown:j=>Wt(j,"e")})]})]}),document.body)}function _P(){const{enableScope:e,disableScope:t}=hh(),r=G(s=>s.imageDetailId)!==null;return f.useEffect(()=>{r?(t("viewer"),e("modal")):(t("modal"),e("viewer"))},[r,e,t]),{isModalOpen:r}}const sg=300,eh=.6;function TP(e){const[t,n]=f.useState(()=>Math.round(window.innerWidth*(e/100))),[r,s]=f.useState(!1),i=f.useCallback(a=>{a.preventDefault(),s(!0),document.body.style.cursor="col-resize",document.body.style.userSelect="none"},[]);return f.useEffect(()=>{const a=c=>{if(!r)return;const d=window.innerWidth-c.clientX,h=window.innerWidth*eh,u=Math.max(sg,Math.min(h,d));n(u)},l=()=>{r&&(s(!1),document.body.style.cursor="",document.body.style.userSelect="")};return r&&(window.addEventListener("mousemove",a),window.addEventListener("mouseup",l)),()=>{window.removeEventListener("mousemove",a),window.removeEventListener("mouseup",l)}},[r]),f.useEffect(()=>{const a=()=>{const l=window.innerWidth*eh;n(c=>Math.min(c,l))};return window.addEventListener("resize",a),()=>window.removeEventListener("resize",a)},[]),{panelWidth:t,handleMouseDown:i,isResizing:r}}function RP(){_P();const e=G(m=>m.galleryCollapsed),t=G(m=>m.embedMode),n=G(m=>m.touchMode),r=G(m=>m.touchUI),s=G(m=>m.setTouchUIVisible),{panelWidth:i,handleMouseDown:a,isResizing:l}=TP(m0.gallery.defaultSize),c=t||n||e;f.useEffect(()=>{if(!n)return;const m=p=>{p.touches.length>1&&p.preventDefault()},g=p=>{p.preventDefault()};return document.addEventListener("touchmove",m,{passive:!1}),document.addEventListener("gesturestart",g),document.addEventListener("gesturechange",g),()=>{document.removeEventListener("touchmove",m),document.removeEventListener("gesturestart",g),document.removeEventListener("gesturechange",g)}},[n]);const d=me(m=>m.reconstruction),h=me(m=>m.urlLoading),u=f.useRef(!1);return f.useEffect(()=>{d&&!h&&!u.current&&!n&&(u.current=!0,pa.getState().showTip("contextMenu","Right-click anywhere for quick actions"))},[d,h,n]),f.useEffect(()=>{d&&!h&&n&&!u.current&&(u.current=!0,pa.getState().showTip("touchMode","Tap to select, long-press for options"))},[d,h,n]),n&&!t?o.jsxs("div",{className:"h-screen flex flex-col bg-ds-primary touch-none","data-touch-mode":"true",children:[o.jsx("div",{className:"flex-1 overflow-hidden",children:o.jsx(qf,{})}),o.jsx($I,{}),r.galleryDrawer&&o.jsx(ZI,{onClose:()=>s("galleryDrawer",!1)}),o.jsx(Jf,{})]}):o.jsxs("div",{className:"h-screen flex flex-col bg-ds-primary",children:[o.jsxs("div",{className:"flex-1 flex overflow-hidden",children:[o.jsx("div",{className:"flex-1 min-w-0",children:o.jsx(qf,{})}),!c&&o.jsx("div",{className:"resize-handle",onMouseDown:a}),!t&&o.jsx("div",{className:`overflow-hidden flex-shrink-0 ${l?"":"transition-all duration-300 ease-in-out"}`,style:{width:c?0:i},children:o.jsx("div",{className:"h-full border-l border-ds",style:{minWidth:`${sg}px`},children:o.jsx(vp,{children:o.jsx(yp,{isResizing:l})})})})]}),!t&&o.jsx(OI,{}),o.jsx(Jf,{})]})}class DP extends f.Component{constructor(t){super(t),this.state={hasError:!1,error:null,errorType:null}}static getDerivedStateFromError(t){const n=uu(t);return{hasError:!0,error:t,errorType:n}}componentDidCatch(t,n){console.error("ErrorBoundary caught an error:",t,n),this.props.onError?.(t,n)}handleRetry=()=>{this.setState({hasError:!1,error:null,errorType:null}),this.props.onRetry?.()};handleReload=()=>{window.location.reload()};renderFallback(){const{variant:t="full",title:n,showReload:r,showRetry:s,fallback:i}=this.props,{error:a,errorType:l}=this.state;if(i)return typeof i=="function"?i(a,this.handleRetry):i;if(t==="silent")return null;const c=ys(l||"unknown"),d=n??c.title,h=l?WI(l):"reload",u=s??(h==="retry"||h==="dismiss"),m=r??h==="reload";return t==="inline"?o.jsxs("div",{className:"flex flex-col items-center justify-center h-full p-4 text-center bg-ds-secondary",children:[o.jsx("div",{className:"text-ds-error text-2xl mb-2",children:"!"}),o.jsx("h3",{className:"text-sm font-medium text-ds-primary mb-1",children:d}),o.jsx("p",{className:"text-xs text-ds-secondary mb-3 max-w-xs",children:a?.message??c.message}),o.jsxs("div",{className:"flex gap-2",children:[u&&o.jsx("button",{onClick:this.handleRetry,className:`${ue.base} ${ue.sizes.sm} ${ue.variants.secondary}`,children:c.retryLabel??"Retry"}),m&&o.jsx("button",{onClick:this.handleReload,className:`${ue.base} ${ue.sizes.sm} ${ue.variants.ghost}`,children:c.reloadLabel??"Reload"})]})]}):o.jsxs("div",{className:Un.containerFull,children:[o.jsx("div",{className:Un.icon,children:"!"}),o.jsx("h2",{className:Un.title,children:d}),o.jsx("p",{className:Un.message,children:a?.message??c.message}),o.jsxs("div",{className:"flex gap-3 mt-4",children:[u&&o.jsx("button",{onClick:this.handleRetry,className:Un.button,children:c.retryLabel??"Retry"}),m&&o.jsx("button",{onClick:this.handleReload,className:`${ue.base} ${ue.sizes.md} ${ue.variants.ghost}`,children:c.reloadLabel??"Reload Page"})]})]})}render(){return this.state.hasError?this.renderFallback():this.props.children}}function FP(){const[e,t]=f.useState(!1);if(kt(ze.showHelp.keys,()=>t(r=>!r),{scopes:ze.showHelp.scopes,preventDefault:ze.showHelp.preventDefault},[]),kt("escape",()=>t(!1),{enabled:e},[e]),!e)return null;const n=Object.keys(ad);return o.jsxs("div",{className:"fixed inset-0 pointer-events-none",style:{zIndex:Rn.modalOverlay},children:[o.jsx("div",{className:ft.backdrop,onClick:()=>t(!1)}),o.jsxs("div",{className:`${ft.panel} top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 p-6 max-w-lg w-full max-h-[80vh] overflow-auto`,children:[o.jsxs("div",{className:"flex items-center justify-between mb-4",children:[o.jsx("h2",{className:"text-ds-primary text-lg font-semibold",children:"Keyboard Shortcuts"}),o.jsx("button",{onClick:()=>t(!1),className:ft.toolHeaderClose,title:"Close",children:o.jsx(Oo,{className:"w-3.5 h-3.5"})})]}),n.map(r=>{const s=C0(r);return s.length===0?null:o.jsxs("div",{className:"mb-4",children:[o.jsx("h3",{className:"text-ds-secondary text-sm font-medium mb-2",children:ad[r]}),o.jsx("table",{className:"w-full text-sm",children:o.jsx("tbody",{children:s.map((i,a)=>o.jsxs("tr",{className:g0.row,children:[o.jsx("td",{className:"py-1.5 text-ds-primary",children:i.description}),o.jsx("td",{className:"py-1.5 text-right",children:o.jsx("kbd",{className:"px-2 py-0.5 bg-ds-secondary rounded text-ds-primary text-xs font-mono",children:ql(i.keys)})})]},a))})})]},r)}),o.jsxs("div",{className:"mt-4 pt-4 border-t border-ds text-ds-muted text-xs text-center",children:["Press"," ",o.jsx("kbd",{className:"px-1.5 py-0.5 bg-ds-secondary rounded",children:"?"})," ","to toggle this panel"]})]})]})}function zP(e){const t=[],n=/\{(LMB|RMB|SCROLL)\}/g;let r=0,s;for(;(s=n.exec(e))!==null;){s.index>r&&t.push(e.slice(r,s.index));const i=s[1];i==="LMB"?t.push(o.jsx(oa,{className:`${_t.hoverCard} inline-block align-text-bottom`},`icon-${s.index}`)):i==="RMB"?t.push(o.jsx(mc,{className:`${_t.hoverCard} inline-block align-text-bottom`},`icon-${s.index}`)):i==="SCROLL"&&t.push(o.jsx(wI,{className:`${_t.hoverCard} inline-block align-text-bottom`},`icon-${s.index}`)),r=n.lastIndex}return r<e.length&&t.push(e.slice(r)),t.length>0?t:[e]}function OP(){const e=G(d=>d.touchMode),[t,n]=f.useState(null),[r,s]=f.useState({x:0,y:0}),i=f.useRef(null),a=f.useCallback(d=>{s({x:d.clientX,y:d.clientY});const u=d.target.closest("[data-tooltip]");u?(u!==i.current||u.dataset.tooltip!==t)&&(i.current=u,n(u.dataset.tooltip||null)):i.current&&(i.current=null,n(null))},[t]),l=f.useCallback(d=>{const u=d.target.closest("[data-tooltip]");u&&(i.current=u,n(u.dataset.tooltip||null))},[]),c=f.useCallback(d=>{const h=d.relatedTarget;if(!h){i.current=null,n(null);return}h.closest("[data-tooltip]")||(i.current=null,n(null))},[]);return f.useEffect(()=>{if(!e)return document.addEventListener("mousemove",a),document.addEventListener("mouseover",l),document.addEventListener("mouseout",c),()=>{document.removeEventListener("mousemove",a),document.removeEventListener("mouseover",l),document.removeEventListener("mouseout",c)}},[e,a,l,c]),e||!t?null:o.jsx("div",{className:"fixed pointer-events-none",style:{zIndex:Rn.mouseTooltip,right:`calc(100vw - ${r.x}px + ${rn.cursorOffset}px)`,top:r.y+rn.cursorOffset},children:o.jsx("div",{className:`${ve.container} border border-ds rounded text-xs px-2 py-1 whitespace-pre-line max-w-xs`,children:zP(t)})})}function $P({notification:e,onClose:t}){const[n,r]=f.useState(!1),s=f.useCallback(()=>{r(!0),setTimeout(()=>{t(e.id)},200)},[e.id,t]);f.useEffect(()=>{if(e.type==="info"&&e.duration){const d=setTimeout(()=>{s()},e.duration);return()=>clearTimeout(d)}},[e.type,e.duration,s]);const i=e.type==="info",a=i?xk:yk,l=i?dr.iconContainerInfo:dr.iconContainerWarning,c=n?dr.exiting:dr.entering;return o.jsxs("div",{className:`${dr.toast} ${c}`,children:[o.jsx("div",{className:`${dr.iconContainer} ${l}`,children:o.jsx(a,{className:dr.icon})}),o.jsx("div",{className:dr.content,children:o.jsx("span",{className:dr.message,children:e.message})}),o.jsx("button",{className:dr.closeButton,onClick:s,"aria-label":"Close notification",children:o.jsx(Oo,{className:"w-4 h-4"})})]})}function BP(){const e=Ft(n=>n.notifications),t=Ft(n=>n.removeNotification);return e.length===0?null:o.jsx("div",{className:dr.container,children:e.map(n=>o.jsx($P,{notification:n,onClose:t},n.id))})}function UP(){if(typeof window>"u")return!1;const e=window.matchMedia("(pointer: coarse)").matches,t=window.matchMedia("(hover: none)").matches;return e&&t}e0();function HP(){const{loadFromUrl:e,loadFromManifest:t}=rp(),n=f.useRef(!1);return f.useEffect(()=>{if(n.current)return;n.current=!0;const r=new URLSearchParams(window.location.search),s=r.get("embed");(s==="1"||s==="true")&&(console.log("[App] Embed mode enabled"),G.getState().setEmbedMode(!0));const i=r.get("touch");if(i!==null){const l=i==="1"||i==="true";console.log(`[App] Touch mode ${l?"enabled":"disabled"} (URL override)`),G.getState().setTouchMode(l,"url")}else UP()&&(console.log("[App] Touch mode enabled (auto-detected)"),G.getState().setTouchMode(!0,"auto"));(async()=>{const l=await Rp(window.location.hash);if(l){if(l.config&&(console.log("[App] Applying shared config"),zM(l.config)),l.manifest){console.log(`[App] Loading from inline manifest in URL hash: ${l.manifest.name||"unnamed"}`),await t(l.manifest)&&l.config?.camera?.selectedImageId!=null&&ce.getState().setSelectedImageId(l.config.camera.selectedImageId);return}if(l.manifestUrl){console.log(`[App] Loading from combined URL hash: ${l.manifestUrl}`),await e(l.manifestUrl)&&l.config?.camera?.selectedImageId!=null&&ce.getState().setSelectedImageId(l.config.camera.selectedImageId);return}}const c=r.get("url");c&&(console.log(`[App] Loading from URL parameter: ${c}`),e(c))})()},[e,t]),o.jsx(DP,{children:o.jsxs(Zg,{initiallyActiveScopes:["global","viewer"],children:[o.jsx(MI,{children:o.jsx(RP,{})}),o.jsx(FP,{}),o.jsx(OP,{}),o.jsx(BP,{})]})})}ky();_g.createRoot(document.getElementById("root")).render(o.jsx(f.StrictMode,{children:o.jsx(HP,{})}));
